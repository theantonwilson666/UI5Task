/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/Variant","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Cache","sap/ui/fl/registry/Settings","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/write/_internal/Storage","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery","sap/base/util/includes","sap/base/util/merge","sap/base/util/UriParameters","sap/base/Log","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantState","sap/ui/fl/write/_internal/condenser/Condenser"],function(D,S,C,L,V,U,a,b,c,A,d,J,e,f,M,q,i,m,g,h,j,F,k,l){"use strict";var n=function(x){this._mComponent=x;this._mChanges=D.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=m({},this._mChanges);if(!this._mComponent||!this._mComponent.name){h.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.");}this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist";};function r(x,y){return x.controlChanges.some(function(z,B){if(z.fileName===y.getDefinition().fileName){x.controlChanges.splice(B,1,y);return true;}});}function o(x,y){var z;if(y instanceof C){z=y;this._mChangesEntries[z.getFileName()]=z;}else{if(!this._mChangesEntries[y.fileName]){this._mChangesEntries[y.fileName]=new C(y);}z=this._mChangesEntries[y.fileName];z.setState(C.states.PERSISTED);var B=z.getVariantReference();if(B){var E=j.getVariantManagementReferences(this._mComponent.name);E.some(function(G){var H=j.getVariant({vReference:B,vmReference:G,reference:this._mComponent.name});if(H){r(H,z);return true;}return false;}.bind(this));}}return z;}n.prototype.getComponentName=function(){return this._mComponent.name;};n.prototype.getCacheKey=function(x){return b.getCacheKey(this._mComponent,x);};n.prototype._preconditionsFulfilled=function(x){var y=x instanceof C?x.getDefinition():x;function _(){if((y.fileType==="ctrl_variant")||(y.fileType==="ctrl_variant_change")||(y.fileType==="ctrl_variant_management_change")){return y.variantManagementReference||y.variantReference||(y.selector&&y.selector.id);}}return y.fileType==="change"||_();};n.prototype.getChangesForComponent=function(P,I){return b.getChangesFillingCache(this._mComponent,P,I).then(function(P,W){var x=m({},W);var y=P&&P.component&&U.getAppComponentForControl(P.component);var H=S.isStorageResponseFilled(x.changes);if(!H){return[];}var z=x.changes.changes;if(!this._oMessagebundle&&x.messagebundle&&y){if(!y.getModel("i18nFlexVendor")){if(z.some(function(Q){return Q.layer===L.VENDOR;})){this._oMessagebundle=x.messagebundle;var B=new f(this._oMessagebundle);y.setModel(B,"i18nFlexVendor");}}}var E=P&&P.currentLayer;var G=!(P&&P.ignoreMaxLayerParameter);var K=function(){return true;};if(E){z=a.filterChangeOrChangeDefinitionsByCurrentLayer(z,E);}else if(a.isLayerFilteringRequired()&&G){K=this._filterChangeForMaxLayer.bind(this);z=z.filter(K);}else if(this._bHasChangesOverMaxLayer&&!G){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST;}var N=x.changes&&P&&P.includeCtrlVariants;var O=this._getAllCtrlVariantChanges(x,N,K);z=z.concat(O);return this._checkAndGetChangeInstances(z,x);}.bind(this,P));};n.prototype._checkAndGetChangeInstances=function(x,y){return x.filter(this._preconditionsFulfilled).map(o.bind(this,y));};n.prototype._filterChangeForMaxLayer=function(x){if(a.isOverMaxLayer(this._getLayerFromChangeOrChangeContent(x))){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true;}return false;}return true;};n.prototype._getLayerFromChangeOrChangeContent=function(x){var y;if(x instanceof V||x instanceof C){y=x.getLayer();}else{y=x.layer;}return y;};n.prototype._getAllCtrlVariantChanges=function(x,I,y){if(!I){return j.getInitialChanges({reference:this._mComponent.name});}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(R,z){if(x.changes[z]){return R.concat(x.changes[z]);}return R;},[]).filter(y);};n.prototype.loadChangesMapForComponent=function(x){return this.getChangesForComponent({component:x}).then(y.bind(this));function y(z){M.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=D.createEmptyDependencyMap();z.forEach(this.addChangeAndUpdateDependencies.bind(this,x));this._mChangesInitial=m({},this._mChanges);M.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this);}};n.prototype.checkForOpenDependenciesForControl=function(x,y){return D.checkForOpenDependenciesForControl(this._mChanges,J.getControlIdBySelector(x,y),y);};n.prototype.copyDependenciesFromInitialChangesMap=function(x,y,z){var I=m({},this._mChangesInitial.mDependencies);var B=I[x.getId()];if(B){var N=[];B.dependencies.forEach(function(H){if(y(H)){this._mChanges.mDependentChangesOnMe[H]=this._mChanges.mDependentChangesOnMe[H]||[];this._mChanges.mDependentChangesOnMe[H].push(x.getId());N.push(H);}}.bind(this));var E;var G=[];B.controlsDependencies.forEach(function(H){if(!J.bySelector(H,z)){E=J.getControlIdBySelector(H,z);G.push(H);this._mChanges.mControlsWithDependencies[E]=this._mChanges.mControlsWithDependencies[E]||[];if(!i(this._mChanges.mControlsWithDependencies[E],x.getId())){this._mChanges.mControlsWithDependencies[E].push(x.getId());}}}.bind(this));B.dependencies=N;B.controlsDependencies=G;if(N.length||G.length){this._mChanges.mDependencies[x.getId()]=B;}}return this._mChanges;};n.prototype.addChangeAndUpdateDependencies=function(x,y,R){y.setInitialApplyState();if(R){D.insertChange(y,this._mChanges,R);}D.addChangeAndUpdateDependencies(y,x,this._mChanges);};n.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(x,y){D.addRuntimeChangeAndUpdateDependencies(y,x,this._mChanges,this._mChangesInitial);};n.prototype.getChangesMapForComponent=function(){return this._mChanges;};n.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated;};n.prototype.changesHavingCorrectViewPrefix=function(P,x){var y=P.modifier;var z=P.appComponent;var B=x.getSelector();if(!B||!P){return false;}if(B.viewSelector){var E=y.getControlIdBySelector(B.viewSelector,z);return E===P.viewId;}var G=B.id;if(G){var H;if(x.getSelector().idIsLocal){if(z){H=z.getLocalId(P.viewId);}}else{H=P.viewId;}var I=0;var K;do{I=G.indexOf("--",I);K=G.slice(0,I);I++;}while(K!==H&&I>0);return K===H;}return false;};n.prototype.getChangesForView=function(P){return this.getChangesForComponent(P).then(function(x){return x.filter(this.changesHavingCorrectViewPrefix.bind(this,P));}.bind(this));};n.prototype.addChange=function(x,y){var z=this.addDirtyChange(x);this._addRunTimeCreatedChangeAndUpdateDependencies(y,z);this._mChangesEntries[z.getFileName()]=z;this._addPropagationListener(y);return z;};n.prototype.addDirtyChange=function(x){var N;if(x instanceof C||x instanceof V){N=x;}else{N=new C(x);}if(this._aDirtyChanges.indexOf(N)===-1){this._aDirtyChanges.push(N);}return N;};n.prototype._addPropagationListener=function(x){var y=U.getAppComponentForControl(x);if(y instanceof e){var z=function(P){return!P._bIsSapUiFlFlexControllerApplyChangesOnControl;};var N=y.getPropagationListeners().every(z);if(N){var B=sap.ui.require("sap/ui/fl/FlexControllerFactory");var E=B.create(this.getComponentName());var P=A.applyAllChangesForControl.bind(A,this.getChangesMapForComponent.bind(this),y,E);P._bIsSapUiFlFlexControllerApplyChangesOnControl=true;y.addPropagationListener(P);}}};n.prototype._deleteNotSavedChanges=function(x,y,z){x.filter(function(B){return!y.some(function(E){return B.getId()===E.getId();});}).forEach(function(B){if(z){this.removeChange(B);}else{this.deleteChange(B);}}.bind(this));};function p(x,y){var P=x.map(function(B){return B[y]();});var z=P.filter(function(B,I,P){return P.indexOf(B)===I;});return z.length===1;}function s(x,y){var z=false;if(!x||y.length<2){return false;}if(!p(y,"getLayer")){return false;}var B=y[0].getLayer();if(B==="CUSTOMER"||B==="USER"){z=true;}var E=g.fromURL(window.location.href);if(E.has("sap-ui-xx-condense-changes")){z=E.get("sap-ui-xx-condense-changes")==="true";}return z;}function t(x){var E=c.getInstanceOrUndef()&&c.getInstanceOrUndef().isCondensingEnabled();if(E&&!p(x,"getNamespace")){E=false;}return E;}function u(x,y,z,B){this._massUpdateCacheAndDirtyState(y,z);this._deleteNotSavedChanges(x,y,B);}function v(x){if(!x.length){return[];}var y=x[0].getLayer();var P=this._mChanges.aChanges.filter(function(z){return z.getState()===C.states.PERSISTED&&a.compareAgainstCurrentLayer(z.getLayer(),y)===0;});return P.concat(x);}n.prototype.saveDirtyChanges=function(x,y,z,B){var E=z||this._aDirtyChanges;var R=v.call(this,E);var I=(t(R)&&s(x,R));var G=I?R:E;var H=G.slice(0);var K=E.slice(0);var N=this._getRequests(E);var P=this._getPendingActions(E);if(P.length===1&&N.length===1&&P[0]===C.states.NEW){var O=Promise.resolve(H);if(s(x,H)){O=l.condense(x,H);}return O.then(function(Q){var T=N[0];var W=E[0].getDefinition().layer;if(I){return d.condense({allChanges:G,condensedChanges:Q,layer:W,transport:T,isLegacyVariant:false,parentVersion:B}).then(function(X){u.call(this,G,Q,y,true);return X;}.bind(this));}if(Q.length){return d.write({layer:W,flexObjects:this._prepareDirtyChanges(Q),transport:T,isLegacyVariant:false,parentVersion:B}).then(function(X){u.call(this,G,Q,y);return X;}.bind(this));}this._deleteNotSavedChanges(G,Q);}.bind(this));}return this.saveSequenceOfDirtyChanges(K,y,B);};n.prototype.saveSequenceOfDirtyChanges=function(x,y,z){var B;if(z){var N=x.filter(function(E){return E.getPendingAction()==="NEW";});B=[].concat(N).shift();}return x.reduce(function(P,E){return P.then(this._performSingleSaveAction(E,B,z)).then(this._updateCacheAndDirtyState.bind(this,E,y));}.bind(this),Promise.resolve());};n.prototype._performSingleSaveAction=function(x,y,z){return function(){if(x.getPendingAction()==="NEW"){if(z!==undefined){z=x===y?z:sap.ui.fl.Versions.Draft;}return d.write({layer:x.getLayer(),flexObjects:[x.getDefinition()],transport:x.getRequest(),parentVersion:z});}if(x.getPendingAction()==="DELETE"){return d.remove({flexObject:x.getDefinition(),layer:x.getLayer(),transport:x.getRequest()});}};};n.prototype._updateCacheAndDirtyState=function(x,y){if(!y){if(U.isChangeRelatedToVariants(x)){j.updateVariantsState({reference:this._mComponent.name,changeToBeAddedOrDeleted:x});}else if(U.isChangeRelatedToCompVariant(x)){k.updateState({reference:this._mComponent.name,changeToBeAddedOrDeleted:x});}else if(x.getPendingAction()===C.states.NEW){b.addChange(this._mComponent,x.getDefinition());}else if(x.getPendingAction()===C.states.DELETED){b.deleteChange(this._mComponent,x.getDefinition());}else if(x.getPendingAction()===C.states.DIRTY){b.updateChange(this._mComponent,x.getDefinition());}}this._aDirtyChanges=this._aDirtyChanges.filter(function(E){return x.getId()!==E.getId();});};n.prototype._massUpdateCacheAndDirtyState=function(x,y){x.forEach(function(z){this._updateCacheAndDirtyState(z,y);},this);};n.prototype._getRequests=function(x){var R=[];x.forEach(function(y){var z=y.getRequest();if(R.indexOf(z)===-1){R.push(z);}});return R;};n.prototype._getPendingActions=function(x){var P=[];x.forEach(function(y){var z=y.getPendingAction();if(P.indexOf(z)===-1){P.push(z);}});return P;};n.prototype._prepareDirtyChanges=function(x){var y=[];x.forEach(function(z){y.push(z.getDefinition());});return y;};n.prototype.getDirtyChanges=function(){return this._aDirtyChanges;};n.prototype.deleteChange=function(x,R){var y=this._aDirtyChanges.indexOf(x);if(y>-1){if(x.getPendingAction()==="DELETE"){return;}this._aDirtyChanges.splice(y,1);this._deleteChangeInMap(x,R);return;}x.markForDeletion();this.addDirtyChange(x);this._deleteChangeInMap(x,R);};n.prototype.removeChange=function(x){var y=this._aDirtyChanges.indexOf(x);if(y>-1){this._aDirtyChanges.splice(y,1);}this._deleteChangeInMap(x);};n.prototype._deleteChangeInMap=function(x,R){var y=x.getId();D.removeChangeFromMap(this._mChanges,y);D.removeChangeFromDependencies(R?this._mChangesInitial:this._mChanges,y);};function w(x,O){return(O.getRequest()==="$TMP"||O.getRequest()==="")&&O.getLayer()===x;}n.prototype.transportAllUIChanges=function(R,x,y,z){return Promise.all([this.getChangesForComponent({currentLayer:y,includeCtrlVariants:true}),F.getCompEntitiesByIdMap(this.getComponentName())]).then(function(B){var E=B[0];var G=B[1];var H=[];for(var I in G){H.push(G[I]);}E=E.concat(H.filter(w.bind(this,y)));return d.publish({transportDialogSettings:{rootControl:R,styleClass:x},layer:y,reference:this.getComponentName(),localChanges:E,appVariantDescriptors:z});}.bind(this));};n.prototype._getChangesFromMapByNames=function(N){return this._mChanges.aChanges.filter(function(x){return N.indexOf(x.getFileName())!==-1;});};n.prototype.removeDirtyChanges=function(x,y,z,G,B){if(!z){h.error("The selectorId must be provided");return Promise.reject("The selectorId must be provided");}var E=this._aDirtyChanges;var H=E.filter(function(I){var K=true;if(I.getLayer()!==x){return false;}if(G&&I.getDefinition().support.generator!==G){return false;}var N=I.getSelector();K=z.getId()===J.getControlIdBySelector(N,y);if(B){K=K&&B.indexOf(I.getChangeType())!==-1;}return K;});H.forEach(function(I){var K=E.indexOf(I);E.splice(K,1);});return Promise.resolve(H);};n.prototype.resetChanges=function(x,G,y,z){var B=y&&y.length>0;var E=z&&z.length>0;return this.getChangesForComponent({currentLayer:x,includeCtrlVariants:true}).then(function(H){var P={reference:this.getComponentName(),layer:x,changes:H};if(G){P.generator=G;}if(B){P.selectorIds=y;}if(E){P.changeTypes=z;}return d.reset(P);}.bind(this)).then(function(R){var H=[];if(y||z){var N=[];if(R&&R.response&&R.response.length>0){R.response.forEach(function(I){N.push(I.fileName);});}b.removeChanges(this._mComponent,N);H=this._getChangesFromMapByNames(N);}return H;}.bind(this));};n.prototype.getResetAndPublishInfo=function(P){return d.getFlexInfo(P);};return n;},true);
