/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantState","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(_,F,M,C,a,b,L,U){"use strict";var c={};function i(p){p.reference=M.getFlexReferenceForControl(p.selector);return F.initialize({componentId:p.componentId||U.getAppComponentForControl(p.selector).getId(),reference:p.reference,componentData:{},manifest:{}});}function g(p){var m=F.getCompEntitiesByIdMap(p.reference);var E=Object.keys(m).map(function(k){return m[k];});return L.filterChangeOrChangeDefinitionsByCurrentLayer(E,p.currentLayer);}function s(p){var r=M.getFlexReferenceForControl(p.selector);return a.persistAll(r);}function d(p){if(!p.reference){var A=C.getAppComponentForSelector(p.selector);p.reference=M.getFlexReferenceForControl(A);}return b.getChangePersistenceForComponent(p.reference);}function e(p){var o=d(p);return o.getChangesForComponent(_(p,["invalidateCache","selector"]),p.invalidateCache).then(function(P){var D=[];if(p.includeDirtyChanges){D=o.getDirtyChanges();}return P.concat(D);});}function f(p,A){var o=C.getFlexControllerInstance(p.selector);var D=C.getDescriptorFlexControllerInstance(p.selector);return o.saveAll(A,p.skipUpdateCache,p.draft).then(D.saveAll.bind(D,A,p.skipUpdateCache,p.draft));}c.getFlexObjects=function(p){return i(p).then(function(){var h=g(p);var j=e(p);return Promise.all([h,j]).then(function(E){return E[0].concat(E[1]);});});};c.saveFlexObjects=function(p){var A=C.getAppComponentForSelector(p.selector);return Promise.all([s(p),f(p,A)]).then(function(){if(p.layer){p.currentLayer=p.layer;}p.componentId=A.getId();p.invalidateCache=true;return c.getFlexObjects(_(p,"skipUpdateCache"));});};return c;});
