/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/UriParameters","sap/ui/fl/Layer","sap/ui/fl/Change","sap/ui/fl/apply/_internal/flexObjects/CompVariant","sap/ui/fl/apply/_internal/flexObjects/CompVariantRevertData","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/Storage"],function(_,a,U,L,C,b,c,d,F,S,e){"use strict";function g(i){switch(i.fileType){case"change":case"variant":return"changes";case"comp_variant_change":return"compVariantChanges";default:}}function f(P,i){var y=P.changeToBeAddedOrDeleted.getDefinition();var z=g(y);i[z].push(y);var I=y.fileName;var A=F.getCompEntitiesByIdMap(P.reference);A[I]=y;}function h(P,i){var y=P.changeToBeAddedOrDeleted.getDefinition();var z=g(y);var A=-1;i[z].some(function(E,I){if(E.fileName===y.fileName){A=I;return true;}});if(A>-1){i[z].splice(A,1);}var B=F.getCompEntitiesByIdMap(P.reference);delete B[y.fileName];}function j(P,i,y){var z=F.getCompVariantsMap(P.reference)._getOrCreate(P.persistencyKey);if(!z[y]){var A={fileName:d.createDefaultFileName(y),fileType:"change",changeType:y,layer:P.layer||L.USER,namespace:d.createNamespace(P,"changes"),reference:P.reference,selector:{persistencyKey:P.persistencyKey},support:P.support||{}};A.support.generator=A.support.generator||"CompVariantState."+y;A.support.sapui5Version=sap.ui.version;var B=new C(A);z[y]=B;F.getCompEntitiesByIdMap(P.reference)[B.getId()]=B;}z[y].setContent(i);return z[y];}function r(O,y){for(var i=O.length-1;i>=0;i--){if((O[i].fileName||O[i].getFileName())===y.fileName){O.splice(i,1);break;}}}function k(M,i){if(i.isVariant()){return M.variants;}switch(i.getChangeType()){case"defaultVariant":return M.defaultVariants;case"standardVariant":return M.standardVariants;default:return M.changes;}}function w(i,y){return e.write({flexObjects:[i.getDefinition()],layer:i.getLayer(),transport:i.getRequest(),isLegacyVariant:i.isVariant()}).then(function(z){if(z&&z.response&&z.response[0]){i.setResponse(z.response[0]);}else{i.setState(C.states.PERSISTED);}return y;}).then(function(y){k(y.changes.comp,i).push(i.getDefinition());return i.getDefinition();});}function u(O,y){for(var i=0;i<O.length;i++){if(O[i].fileName===y.fileName){O.splice(i,1,y);break;}}}function l(i,y){return e.update({flexObject:i.getDefinition(),layer:i.getLayer(),transport:i.getRequest()}).then(function(z){if(z&&z.response){i.setResponse(z.response);}else{i.setState(C.states.PERSISTED);}return y;}).then(function(y){var O=k(y.changes.comp,i);u(O,i.getDefinition());return i.getDefinition();});}function m(i,y,z,A){return e.remove({flexObject:i.getDefinition(),layer:i.getLayer(),transport:i.getRequest()}).then(function(){delete y[i.getId()];if(i.getChangeType()==="standardVariant"){z.standardVariant=undefined;}else if(i.getChangeType()==="defaultVariant"){z.defaultVariant=undefined;}else{r(k(z,i),i.getDefinition());}return A;}).then(function(A){r(k(A.changes.comp,i),i.getDefinition());return i.getDefinition();});}function n(i){return i&&(i.getPendingAction()==="NEW"||i.getPendingAction()==="UPDATE"||i.getPendingAction()==="DELETE");}function o(i){return i.variants.concat(i.changes).concat(i.defaultVariant).concat(i.standardVariant);}function p(P){var i={};if(typeof(P.texts)==="object"){Object.keys(P.texts).forEach(function(y){i[y]={value:P.texts[y],type:"XFLD"};});}return i;}function q(P){if(P.layer){return P.layer;}if(P.isUserDependent){return L.USER;}var i=U.fromQuery(window.location.search).get("sap-ui-layer")||"";i=i.toUpperCase();if(i){return i;}if(!P.isVariant){return L.CUSTOMER;}var y=S.getInstanceOrUndef().isPublicLayerAvailable();return y?L.PUBLIC:L.CUSTOMER;}function s(P){var i=F.getCompEntitiesByIdMap(P.reference);return i[P.id];}function t(i){if(i instanceof b){i.removeAllRevertInfo();}}var v={};v.setDefault=function(P){var i={defaultVariantName:P.defaultVariantId};return j(P,i,"defaultVariant");};v.setExecuteOnSelection=function(P){var i={executeOnSelect:P.executeOnSelection};return j(P,i,"standardVariant");};v.add=function(P){if(!P){return undefined;}var i=P.changeSpecificData;var I={changeType:i.type,service:i.ODataService,content:i.content||{},reference:P.reference,fileType:i.isVariant?"variant":"change",packageName:i.packageName,layer:q(i),selector:{persistencyKey:P.persistencyKey},texts:p(i),command:P.command,generator:P.generator};if(i.isVariant){I.content.favorite=!!i.favorite;I.content.executeOnSelection=i.content.executeOnSelection||!!i.executeOnSelection;I.contexts=i.contexts||{};}var y=i.isVariant?b:C;var z=y.createInitialFileContent(I);var A=new y(z);var B=F.getCompVariantsMap(P.reference);var M=B._getOrCreate(P.persistencyKey);k(M,A).push(A);var D=A.getId();var E=F.getCompEntitiesByIdMap(P.reference);E[D]=A;return A;};function x(P,V){var i=[];if(P.favorite===undefined){i.push("favorite");}if(P.executeOnSelection===undefined){i.push("executeOnSelection");}var R={type:v.operationType.ContentUpdate,content:{previousState:V.getState(),previousContent:V.getContent(),previousFavorite:V.getFavorite(),previousExecuteOnSelection:V.getExecuteOnSelection(),previousContexts:V.getContexts()}};if(P.name){R.content.previousName=V.getText("variantName");}V.addRevertInfo(new c(R));}v.updateVariant=function(P){var V=s(P);if(!V){throw new Error("Variant to be modified is not persisted via sap.ui.fl.");}if(!P.revert){x(P,V);}if(P.name){V.setText("variantName",P.name);}var i=V.getContent();var y=P.content||i;["favorite","executeOnSelection"].forEach(function(z){if(P[z]!==undefined){y[z]=P[z];}else if(!(P.revert&&y[z]!==undefined)&&i[z]!==undefined){y[z]=i[z];}});V.setContent(y);V.setFavorite(!!y.favorite);V.setExecuteOnSelection(!!y.executeOnSelection);if(P.contexts){V.setContexts(P.contexts);}return V;};v.operationType={StateUpdate:"StateUpdate",ContentUpdate:"ContentUpdate"};v.removeVariant=function(P){var V=s(P);if(!P.revert){var R=new c({type:v.operationType.StateUpdate,content:{previousState:V.getState()}});V.addRevertInfo(R);}V.markForDeletion();return V;};v.revert=function(P){var V=s(P);var R=V.getRevertInfo().pop();var i=R.getContent();switch(R.getType()){case v.operationType.ContentUpdate:v.updateVariant(Object.assign({revert:true,name:i.previousName,content:i.previousContent,favorite:i.previousFavorite,executeOnSelection:i.previousExecuteOnSelection,contexts:i.previousContexts},a(P,["reference","persistencyKey","id"])));break;case v.operationType.StateUpdate:default:break;}V.setState(i.previousState);V.removeRevertInfo(R);return V;};v.updateState=function(P){var i=F.getFlexObjectsFromStorageResponse(P.reference);if(P.changeToBeAddedOrDeleted){switch(P.changeToBeAddedOrDeleted.getPendingAction()){case C.states.NEW:f(P,i);break;case C.states.DELETED:h(P,i);break;default:break;}}};v.persist=function(P){var R=P.reference;var i=P.persistencyKey;var y=F.getCompVariantsMap(R);var z=y._getOrCreate(i);var A=F.getCompEntitiesByIdMap(R);var B=F.getStorageResponse(R);var D=o(z).filter(n).map(function(E){switch(E.getPendingAction()){case C.states.NEW:t(E);return w(E,B);case C.states.DIRTY:t(E);return l(E,B);case C.states.DELETED:t(E);return m(E,A,z,B);default:break;}});return Promise.all(D);};v.persistAll=function(R){var i=_(F.getCompVariantsMap(R),"_getOrCreate");var P=Object.keys(i).map(function(y){return v.persist({reference:R,persistencyKey:y});});return Promise.all(P);};return v;});
