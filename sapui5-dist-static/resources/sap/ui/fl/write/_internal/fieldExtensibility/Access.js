/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/security/encodeURLParameters","sap/base/Log","sap/ui/core/Core","sap/ui/fl/registry/Settings","sap/ui/fl/Utils","sap/ui/util/Storage","sap/ui/thirdparty/jquery"],function(a,L,C,S,U,b,q){"use strict";var A={};A._mServiceType={v2:"v2",v4:"v4"};A._sODataV4ResourcePathPrefix="sap/opu/odata4/";A._sStorageKey="sap.ui.fl.fieldExt.Access";A._iValidityPeriod=1*7*24*60*60*1000;function g(e,m){m=m||e.getModel();var B=e.getBindingContext();if(B&&m.oMetadata){return m.oMetadata._getEntityTypeByPath(B.getPath());}return{};}function c(B,e){B.BusinessContexts=B.BusinessContexts.map(function(o){return{description:o.BusinessContextDescription,businessContext:o.BusinessContext};});return{extensionData:B.BusinessContexts,entityType:e,serviceVersion:B.ServiceVersion,serviceName:B.ServiceName};}A.getTexts=function(){var r=C.getLibraryResourceBundle("sap.ui.fl");return{tooltip:r.getText("BTN_FREP_CCF"),headerText:r.getText("BUSINESS_CONTEXT_TITLE")};};A.isExtensibilityEnabled=function(o){var s=U.getComponentClassName(o);if(!s){return Promise.resolve(false);}return S.getInstance(s).then(function(d){return d.isModelS();});};A.getExtensionData=function(o){var s=o.getModel().sServiceUrl;var e=g(o).name;var d=false;try{d=A.getBusinessContexts(s,e);}catch(E){L.error("exception occured in sap.ui.fl.fieldExt.Access.getBusinessContexts",E);}return Promise.resolve(d).then(function(r){if(r&&Array.isArray(r.BusinessContexts)&&r.BusinessContexts.length>0){return c(r,e);}return false;}).catch(function(E){if(E){if(Array.isArray(E.errorMessages)){E.errorMessages.forEach(function(f){L.error(f.text);});}}return false;});};A.onTriggerCreateExtensionData=function(e){U.ifUShellContainerThen(function(s){var o=s[0];var h=(o&&o.hrefForExternal({target:{semanticObject:"CustomField",action:"develop"},params:{businessContexts:e.extensionData.map(function(B){return B.businessContext;}),serviceName:e.serviceName,serviceVersion:e.serviceVersion,entityType:e.entityType}}));A.openNewWindow(h);},["CrossApplicationNavigation"]);};A.getBusinessContexts=function(s,e,E){var m=this._getEntityInfo(e,E);var d=this._parseServiceUri(s);var B=this._buildBusinessContextRetrievalUri(d,m);var p=this._executeAjaxCall(B,d,m);return p;};A.isServiceOutdated=function(s){if(!this._isSystemInfoAvailable()){return false;}var m=this._getServiceItem(this._createServiceItem(s));if(m){if(this._isServiceExpired(m)){this.setServiceValid(s);return false;}return true;}return false;};A.openNewWindow=function(u){window.open(u,"_blank","noopener noreferrer");};A.setServiceValid=function(s){if(this._isSystemInfoAvailable()){var d=this._getDataFromLocalStorage();delete d[this._createServiceItem(s).serviceKey];this._setDataToLocalStorage(d);}};A.setServiceInvalid=function(s){if(this._isSystemInfoAvailable()){var d=this._getDataFromLocalStorage();var i=this._createServiceItem(s);d[i.serviceKey]=i;this._setDataToLocalStorage(d);}};A._getEntityInfo=function(e,E){var o={entityTypeName:e||"",entitySetName:E||""};if(((o.entitySetName.length===0)&&(o.entityTypeName.length===0))||(!(o.entitySetName.length===0)&&!(o.entityTypeName.length===0))){throw new Error("sap.ui.fl.fieldExt.Access._getEntityInfo()"+"Inconsistent input parameters EntityType: "+o.entityTypeName+" EntitySet: "+o.entitySetName);}return o;};A._parseServiceUri=function(s){if(s.toLowerCase().indexOf(this._sODataV4ResourcePathPrefix)!==-1){return this._parseV4ServiceUri(s);}return this._parseV2ServiceUri(s);};A._parseV2ServiceUri=function(s){var r=/.*sap\/opu\/odata\/([^\/]+)\/([^\/]+)/i;var R=/([^;]+);v=(\d{1,4})/i;var o="sap/opu/odata";var d;if(s.toLowerCase().indexOf(o)!==-1){var e=s.match(r);if(!e||e.length!==3){throw new Error("sap.ui.fl.fieldExt.Access._parseV2ServiceUri: Malformed service URI (Invalid service name)");}if(e[1].toLowerCase()!=="sap"){d="/"+e[1]+"/"+e[2];}else{d=e[2];}}else{if(s.length>0&&s.lastIndexOf("/")+1===s.length){s=s.substring(0,s.length-1);}d=s.substring(s.lastIndexOf("/")+1);}if(d.indexOf(";v=")!==-1){var v=d.match(R);if(!v||v.length!==3){throw new Error("sap.ui.fl.fieldExt.Access._parseV2ServiceUri: Malformed service URI (Invalid version)");}return{serviceName:v[1],serviceVersion:v[2],serviceType:this._mServiceType.v2};}return{serviceName:d,serviceVersion:"0001",serviceType:this._mServiceType.v2};};A._parseV4ServiceUri=function(s){var r=/^\/?sap\/opu\/odata4((?:\/[^/]+){5})(\/[^/]+){1}(\/.*)?/i;var d=s.match(r);if(!d||d.length!==4){throw new Error("sap.ui.fl.fieldExt.Access._parseV4ServiceUri: Malformed service URI");}var n=d[1].split("/");n.splice(0,3);var R=/(\d{1,4})/i;var v=d[2].match(R);return{serviceName:n.join("/"),serviceVersion:v[1],serviceType:this._mServiceType.v4};};A._buildBusinessContextRetrievalUri=function(s,e){var B="/sap/opu/odata/SAP/APS_CUSTOM_FIELD_MAINTENANCE_SRV/";if(s.serviceType===this._mServiceType.v4){var r=this._sODataV4ResourcePathPrefix+s.serviceName+"/"+s.serviceVersion;B+="GetBusinessContextsByResourcePath?"+a({ResourcePath:"'"+r+"'"});}else{B+="GetBusinessContextsByEntityType?"+"ServiceName=\'"+s.serviceName+"\'"+"&ServiceVersion=\'"+s.serviceVersion+"\'";}B+="&EntitySetName=\'"+e.entitySetName+"\'"+"&EntityTypeName=\'"+e.entityTypeName+"\'"+"&$format=json";return B;};A._executeAjaxCall=function(B,s,e){var t=this;var m=this._getAjaxSettings();var d=q.Deferred();var r={BusinessContexts:[],ServiceName:s.serviceName,ServiceVersion:s.serviceVersion};q.ajax(B,m).done(function(f){r.BusinessContexts=t._extractBusinessContexts(f);d.resolve(r);}).fail(function(j){if(j.status===404&&s.serviceType===t._mServiceType.v4){d.resolve(r);}else{var E=t._getMessagesFromXHR(j);var o={errorOccured:true,errorMessages:E,serviceName:s.serviceName,serviceVersion:s.serviceVersion,entityType:e.entityTypeName,entitySet:e.entitySetName};d.reject(o);}});return d.promise();};A._getAjaxSettings=function(){var s={type:"GET",async:true,dataType:"json"};return s;};A._extractBusinessContexts=function(d){var r=null;var B=[];if(d&&d.d){r=d.d.results;}if(r!==null&&r.length>0){for(var i=0;i<r.length;i++){if(r[i].BusinessContext!==null){B.push({BusinessContext:r[i].BusinessContext,BusinessContextDescription:r[i].BusinessContextDescription});}}}return B;};A._getMessagesFromXHR=function(x){var m=[];try{var E=JSON.parse(x.responseText);if(E&&E.error&&E.error.message&&E.error.message.value&&E.error.message.value!==''){m.push({severity:"error",text:E.error.message.value});}else{m.push({severity:"error",text:x.responseText});}}catch(e){}return m;};A._getCurrentTime=function(){return Date.now();};A._isServiceExpired=function(s){return s.expirationDate<=this._getCurrentTime();};A._getLocalStorage=function(){return new b(b.Type.local);};A.isLocalStorageAvailable=function(){return this._getLocalStorage()&&this._getLocalStorage().isSupported();};A._getServiceItem=function(s){return this._getDataFromLocalStorage()[s.serviceKey]||null;};A._createServiceItem=function(s){var e=this._getCurrentTime()+this._iValidityPeriod;var m=this._getSystemInfo();var p=this._extractServiceInfo(s);return{serviceKey:m.getName()+m.getClient()+p.serviceName+p.serviceVersion,expirationDate:e};};A._extractServiceInfo=function(s){if(typeof s==="string"){return this._parseServiceUri(s);}return s;};A._isSystemInfoAvailable=function(){var u=U.getUshellContainer();return u&&u.getLogonSystem;};A._getSystemInfo=function(){var u=U.getUshellContainer();return u&&u.getLogonSystem();};A._setDataToLocalStorage=function(d){if(this.isLocalStorageAvailable()){this._getLocalStorage().put(A._sStorageKey,JSON.stringify(d));}};A._getDataFromLocalStorage=function(){if(!this.isLocalStorageAvailable()){return{};}var s=this._getLocalStorage().get(A._sStorageKey);if(!s){return{};}return JSON.parse(s);};return A;},true);
