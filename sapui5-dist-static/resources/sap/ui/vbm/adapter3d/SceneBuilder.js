/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/base/Object","./Utilities","./PolygonHandler","./ModelHandler","./thirdparty/three","./thirdparty/DecalGeometry","./thirdparty/html2canvas","sap/base/Log"],function(B,U,P,M,T,D,h,L){"use strict";var t="sap.ui.vbm.adapter3d.SceneBuilder";var F=T.Face3;var a=T.Matrix4;var V=T.Vector2;var b=T.Vector3;var d=T.Math.degToRad;var c=U.toArray;var e=U.toBoolean;var f=U.toVector3;var g=U.createMaterial;var p=U.propertyChanged;var j=U.propertyRemoved;var k=U.propertyAdded;var u=U.updateProperty;var r=U.refCountableDispose;var l;var m;var S=B.extend("sap.ui.vbm.adapter3d.SceneBuilder",{constructor:function(i,v){B.call(this);this._context=i;this._viewport=v;this._root=v.getRoot();this._scene=v.getScene();this._hotInstance=null;this._decalHelper=null;this._targets=new Map();this._textures=new Map();this._box4=null;this._box6=null;this._cylinder=null;this._cylinderCaps=null;this._polygonHandler=new P(this._root);this._modelHandler=new M(this._context.resources,this._textures,this._scene,this._root);this._textureLoader=null;}});S.prototype.destroy=function(){this._root=null;this._scene=null;this._viewport=null;this._context=null;if(this._box4){this._box.dispose();}if(this._box6){this._box6.dispose();}if(this._cylinder){this._cylinder.dispose();}if(this._cylinderCaps){this._cylinderCaps.dispose();}if(this._decalHelper){this._decalHelper.material.dispose();this._decalHelper.geometry.dispose();this._scene.remove(this._decalHelper);}this._polygonHandler.destroy();this._modelHandler.destroy();this._textures.forEach(function(i){i.dispose();});B.prototype.destroy.call(this);};S.prototype.synchronize=function(){var i=this;function n(o){var q=i._textures.get(o);if(!q){i._textures.set(o,null);}}return new Promise(function(o,q){var w=sap.ui.vbm.findInArray(i._context.windows,function(w){return w.type==="default";});var s=w&&sap.ui.vbm.findInArray(i._context.scenes,function(s){return s.id===w.refScene;});if(!s){o();return;}i._context.scene=s;if(i._context.setupView){var v=i._context.setupView;i._setupView(v.position,v.zoom,v.pitch,v.yaw,v.home,v.flyTo);i._context.setupView=undefined;}var x=[];var y=[],z=[];var A=i._context.voQueues.toAdd.get(s)||[];var C=i._context.voQueues.toUpdate.get(s)||[];var E=i._context.voQueues.toRemove.get(s)||[];[].concat(A,C).forEach(function(G){if(G.isModel){i._modelHandler.addModel(G);}if(G.texture&&p(G,"texture")){n(G.texture);}if(G.textureCap&&p(G,"textureCap")){n(G.textureCap);}if(G.isDecal&&G.text&&p(G,["text","size"])){x.push(G);}});i._loadTextures().then(function(){return i._modelHandler.loadModels();}).then(function(){return i._renderTexts(x);}).then(function(){E.forEach(i._removeInstance.bind(i));C.forEach(i._updateInstance.bind(i,z));A.forEach(i._addInstance.bind(i,y));i._polygonHandler.update();i._modelHandler.update();i._scene.updateMatrixWorld(true);z.forEach(i._updateInstance.bind(i,null));y.forEach(i._addInstance.bind(i,null));i._cleanupCache();o();}).catch(function(G){q(G);});});};S.prototype._findMesh=function(n){var i=null;n.traverse(function(o){if(!i&&o.isMesh){i=o;}});return i;};S.prototype._getGeometrySize=function(){return 2.0;};S.prototype._getZoomFactor=function(i,n){var o=new b();o.subVectors(n,i);return(this._getGeometrySize()*2)/o.length();};S.prototype._setupView=function(i,z,n,y,o,q){i=f(i||"0;0;0");z=parseFloat(z||"1");if(z===0){z=1;}else if(z<0){z=0.1;}var s=this._getGeometrySize()*2/z;n=parseFloat(n||"0");y=parseFloat(y||"0");n=(n%180===0?n+1:n);var v=new a();v.makeRotationX(d(n+180));var w=new a();w.makeRotationZ(d(-(y+180)));var x=new a();x.multiplyMatrices(w,v);var A=new b(0,0,-5);var C=new b(0,0,0);var E=new b();E.subVectors(C,A).normalize();E.multiplyScalar(s);E.applyMatrix4(x);E.add(i);C.add(i);var G={zoom:1.0,target:new b(-C.x,-C.z,C.y),position:new b(-E.x,-E.z,E.y)};if(o){this._viewport._setCameraHome(G);this._viewport._applyCamera(G,q);}else{this._viewport._applyCamera(G,q);}};S.prototype._getDecalTextKey=function(i){return i.size+";"+i.text;};S.prototype._renderTexts=function(i){var n=[];i.forEach(function(o){if(!this._textures.has(this._getDecalTextKey(o))){n.push(this._renderText(o));}},this);return Promise.all(n);};S.prototype._renderText=function(i){var n=this;return new Promise(function(o,q){var s=f(i.size);if(s.length()<1E-6){L.error("Unable render text to html: decal size is invalid","",t);o();}else{var v=512;var w=s.x/s.y;var x=Math.ceil(w>=1?v:v*w);var y=Math.ceil(w<=1?v:v/w);var z=document.createElement("iframe");z.style.visibility="hidden";z.width=x;z.height=y;document.body.appendChild(z);var A=z.contentDocument||z.contentWindow.document;A.open();A.close();A.body.innerHTML=i.text;var C=document.createElement("canvas");C.width=z.width*window.devicePixelRatio;C.height=z.height*window.devicePixelRatio;C.style.width=z.width+"px";C.style.height=z.height+"px";var E=C.getContext("2d");E.scale(window.devicePixelRatio,window.devicePixelRatio);h(A.body,{canvas:C,width:x,height:y,backgroundColor:null}).then(function(G){if(G.width>0&&G.height>0){var H=new T.Texture(G);H.needsUpdate=true;U.addRef(H);n._textures.set(n._getDecalTextKey(i),H);}else{L.error("Failed render text to html","",t);}document.body.removeChild(z);o();});}});};S.prototype._loadTextures=function(){var i=[];this._textures.forEach(function(n,o){if(!n){i.push(this._loadTexture(o));}},this);return Promise.all(i);};S.prototype._loadTexture=function(i){var n=this;var o=this._context.resources.get(i);if(!o){this._textures.delete(i);L.error("Failed to get texture from context",i,t);return Promise.resolve();}return new Promise(function(q,s){n._getTextureLoader().load(U.makeDataUri(o),function(v){v.flipY=false;n._textures.set(i,v);q();},null,function(x){n._textures.delete(i);L.error("Failed to load texture from Data URI: "+i,"status: "+x.status+", status text: "+x.statusText,t);q();});});};S.prototype._cleanupCache=function(){this._textures.forEach(function(i){if(r(i)){i.dispose();this._textures.delete(i);}},this);if(this._box4&&r(this._box4)){this._box4.dispose();this._box4=null;}if(this._box6&&r(this._box6)){this._box6.dispose();this._box6=null;}if(this._cylinder&&r(this._cylinder)){this._cylinder.dispose();this._cylinder=null;}if(this._cylinderCaps&&r(this._cylinderCaps)){this._cylinderCaps.dispose();this._cylinderCaps=null;}};S.prototype._addInstance=function(i,n){if(!n.isDecal){this._updateInstanceKeys(n);}if(n.isPolygon){this._polygonHandler.addInstance(n);}else if(n.isModel){this._modelHandler.addInstance(n);}else if(n.isBox||n.isCylinder){n.object3D=new T.Group();n.object3D.matrixAutoUpdate=false;this._root.add(n.object3D);if(n.isBox){this._assignBoxProperties(n);}else{this._assignCylinderProperties(n);}}else if(n.isDecal){if(i){i.push(n);}else{this._assignDecalProperties(n);}}else{L.error("Unable to add instance: instance type is unknown","",t);}};S.prototype._updateInstance=function(i,n){if(!n.isDecal){this._updateInstanceKeys(n);}if(n.isPolygon){this._polygonHandler.updateInstance(n);}else if(n.isModel){this._modelHandler.updateInstance(n);}else if(n.isBox){this._assignBoxProperties(n,n===this._hotInstance);}else if(n.isCylinder){this._assignCylinderProperties(n,n===this._hotInstance);}else if(n.isDecal){if(i){i.push(n);}else{this._assignDecalProperties(n);}}else{L.error("Unable to update instance: instance type is unknown","",t);}};S.prototype._removeInstance=function(i){if(!i.isDecal){this._removeInstanceKeys(i);}if(i.isPolygon){this._polygonHandler.removeInstance(i);}else if(i.isModel){this._modelHandler.removeInstance(i);}else if(i.isBox||i.isCylinder||i.isDecal){if(i.object3D){this._deleteObject3D(i.object3D);i.object3D=null;i._last={};}else{L.error("Unable to remove instance: object3D is missing","",t);}}else{L.error("Unable to remove instance: instance type is unknown","",t);}if(this._hotInstance===i){this._hotInstance=null;}};S.prototype.updateSelection=function(s,i){s.concat(i).forEach(function(n){if(n.isPolygon){this._polygonHandler.updateInstance(n);}else if(n.isModel){this._modelHandler.updateInstance(n);}else if(n.isBox){this._assignBoxProperties(n,n===this._hotInstance);}else if(n.isCylinder){this._assignCylinderProperties(n,n===this._hotInstance);}},this);this._polygonHandler.update();this._modelHandler.update();};S.prototype._updateHotStatus=function(i,n){if(i.isBox){this._assignBoxProperties(i,n);}else if(i.isCylinder){this._assignCylinderProperties(i,n);}};S.prototype.updateHotInstance=function(i){this._polygonHandler.updateHotInstance(i);this._modelHandler.updateHotInstance(i);this._polygonHandler.update();this._modelHandler.update();if(this._hotInstance){this._updateHotStatus(this._hotInstance,false);}if(i){this._updateHotStatus(i,true);}this._hotInstance=i;};S.prototype._assignBoxProperties=function(i,n){var o=i.object3D.children.length===0?null:i.object3D.children[0];if(!o||p(i,"texture6")){var q=this._getBoxGeometry(e(i.texture6));U.addRef(q);if(o){U.subRef(o.geometry);o.geometry=q;}else{o=new T.Mesh(q,g(false));o.matrixAutoUpdate=false;o.layers.set(0);o._sapInstance=i;i.object3D.add(o);}}u(i,"texture6");this._assignProperties(i,n);};S.prototype._assignCylinderProperties=function(i,n){var o,q=false,s=e(i.isOpen),v=i.object3D.children.length===0?null:i.object3D.children[0];if(!v||p(i,"isOpen")){var w=this._getCylinderGeometry(s);U.addRef(w);if(v){U.subRef(v.geometry);v.geometry=w;if(s){o=v.material[1];if(o.map){U.subRef(o.map);o.dispose();}v.material=v.material[0];v.material.side=T.DoubleSide;v.material.needsUpdate=true;}else{o=v.material.clone();o.map=null;v.material=[v.material,o];v.material.forEach(function(x){x.needsUpdate=true;x.side=T.FrontSide;});q=true;}}else{v=new T.Mesh(w,s?g(true):[g(false),g(false)]);v.matrixAutoUpdate=false;v.layers.set(0);v._sapInstance=i;i.object3D.add(v);}}if(p(i,"textureCap")||q){o=Array.isArray(v.material)?v.material[1]:null;if(o){if(o.map){U.subRef(o.map);o.map=null;o.needsUpdate=true;}if(i.textureCap){o.map=this._textures.get(i.textureCap);if(o.map){o.needsUpdate=true;U.addRef(o.map);}else{L.error("Unable to apply cap texture on cylinder, texture not found",i.textureCap,t);}}}}u(i,["isOpen","testureCap"]);this._assignProperties(i,n);};S.prototype._assignProperties=function(i,n){var o,q,s=i.object3D.children[0];if(p(i,"texture")){q=Array.isArray(s.material)?s.material[0]:s.material;if(q.map){U.subRef(q.map);q.map=null;q.needsUpdate=true;}if(i.texture){q.map=this._textures.get(i.texture);if(q.map){q.needsUpdate=true;U.addRef(q.map);}else{L.error("Unable to apply texture, texture not found",i.texture,t);}}}if(p(i,["color","selectColor","VB:s"])||n!==undefined){o=U.getColor(i,i.color,n);U.toArray(s.material).forEach(function(x){x.color.copy(o.rgb);x.opacity=o.opacity;x.transparent=x.opacity<1;x.needsUpdate=true;});}var v=s.children.length===0?null:s.children[0];if(j(i,"colorBorder")){v.material.dispose();v.geometry.dispose();s.remove(v);}else if(i.colorBorder){if(k(i,"colorBorder")){var w=i.isBox?new T.EdgesGeometry(s.geometry):new T.EdgesGeometry(s.geometry,60);v=new T.LineSegments(w,U.createLineMaterial());v.matrixAutoUpdate=false;v.layers.set(1);s.add(v);}if(p(i,["colorBorder","selectColor,","VB:s"])||n!==undefined){q=v.material;o=U.getColor(i,i.colorBorder,n);q.color.copy(o.rgb);q.opacity=o.opacity;q.transparent=q.opacity<1;q.needsUpdate=true;}}if(p(i,"normalize")){if(e(i.normalize)){U.normalizeObject3D(s);s.updateMatrix();}else{s.position.set(0,0,0);s.rotation.set(0,0,0);s.scale.set(1,1,1);}}if(p(i,["pos","rot","scale"])){U.getInstanceTransform(i,i.object3D.position,i.object3D.rotation,i.object3D.scale);i.object3D.updateMatrix();}u(i,["texture","color","selectColor","VB:s","colorBorder","normalize","pos","rot","scale"]);};S.prototype._assignDecalProperties=function(i){var n=false,o;if(p(i,["position","direction","size","rotation","target"])){n=true;}if(!i.target&&p(i,["planeOrigin","planeNormal"])){n=true;}if(n){if(i.object3D){o=i.object3D.material.clone();this._deleteObject3D(i.object3D);i.object3D=null;}var q=this._getDecalTarget(i);if(!q){L.error("Unable to create decal","target is missing",t);return;}var s=this._createDecal(i,q,o);this._disposeDecalTarget(i,q);if(!s){return;}}if(p(i,["texture","text"])){o=i.object3D.material;if(o.map){U.subRef(o.map);o.map=null;}o.map=this._textures.get(i.text?this._getDecalTextKey(i):i.texture);if(o.map){o.map.flipY=true;o.needsUpdate=true;U.addRef(o.map);}else{L.error("Unable to apply texture, texture not found",i.texture,t);}}u(i,["position","direction","size","rotation","target","texture","text","planeOrigin","planeNormal"]);};S.prototype._createDecal=function(i,n,o){this._root.updateMatrixWorld(true);var q=f(i.position);var s=f(i.direction).normalize();if(s.length()<1E-6){L.error("Unable create decal: direction is invalid","",t);return false;}var v=d(U.toFloat(i.rotation));var w=f(i.size);if(w.length()<1E-6){L.error("Unable create decal: size is invalid","",t);return false;}q.applyMatrix4(n.matrixWorld);s.transformDirection(n.matrixWorld);var x=new T.Raycaster(q,s);var y=x.intersectObject(n);if(!y.length){L.error("Unable create decal: cannot project decal to plane","",t);return false;}if(!this._decalHelper){this._decalHelper=new T.Mesh(new T.BoxBufferGeometry(1,1,5));this._decalHelper.visible=false;this._decalHelper.layers.set(1);this._decalHelper.up.set(0,1,0);this._scene.add(this._decalHelper);}var z=y[0];var A=z.point;var C=s.clone().negate();var E=new T.Box3().setFromObject(n);var G=E.max.clone().sub(E.min).length();C.multiplyScalar(G);C.add(A);this._decalHelper.position.copy(A);this._decalHelper.lookAt(C);this._decalHelper.rotation.z+=v;o=o||new T.MeshPhongMaterial({specular:0x444444,shininess:0,transparent:true,depthTest:true,depthWrite:false,polygonOffset:true,polygonOffsetUnits:0.1,polygonOffsetFactor:-1});i.object3D=new T.Mesh(new T.DecalGeometry(n,A,this._decalHelper.rotation,w),o);i.object3D.matrixAutoUpdate=false;i.object3D.layers.set(1);this._scene.add(i.object3D);return true;};S.prototype._createPlane=function(i,n){var o=f(i.planeOrigin);var q=f(i.planeNormal).normalize();if(q.length()<1E-6){L.error("Unable to create plane for decal: normal is invalid","",t);return null;}var s=new b(q.x===0?10:-q.x,q.y===0?-10:q.y,q.z===0?10:-q.z);var v=o.clone(o).add(s);v.sub(q.clone().multiplyScalar(q.dot(v.clone().sub(o))));var w=10000;s=v.clone().sub(o).normalize();var x=q.clone().cross(s).normalize();s.multiplyScalar(w);x.multiplyScalar(w);var y=o.clone().add(s);var z=o.clone().sub(s);var A=o.clone().add(x);var C=o.clone().sub(x);var E=new T.Geometry();E.vertices.push(y,A,z,C);E.faces.push(new F(0,1,2,q),new F(2,3,0,q));var G=new T.Mesh(E);n.add(G);return G;};S.prototype._getDecalTarget=function(i){if(i.target){var n=this._targets.get(i.target);if(n){if(n.isBox||n.isCylinder){return n.object3D.children[0];}else if(n.isPolygon){return this._polygonHandler.getTarget(n);}else if(n.isModel){return this._modelHandler.getTarget(n);}else{L.error("Unable to get decal's target","target instance type is unknown",t);return null;}}}else if(i.planeOrigin&&i.planeNormal){return this._createPlane(i,this._root);}else{L.error("Unable to get/create decal's target","missing parameters",t);return null;}};S.prototype._disposeDecalTarget=function(i,n){if(i.target){var o=this._targets.get(i.target);if(o){if(o.isPolygon||o.isModel){this._deleteObject3D(n);}}else{L.error("Unable to dispose decal's target","target not found",t);}}else{this._deleteObject3D(n);}};S.prototype._updateInstanceKeys=function(i){var v=this._getInstanceKeys(i);if(v){this._targets.set(v.key,i);this._targets.set(v.group,i);}};S.prototype._removeInstanceKeys=function(i){var v=this._getInstanceKeys(i);if(v){this._targets.delete(v.key);this._targets.delete(v.group);}};S.prototype._getInstanceKeys=function(i){if(i.dataInstance){var n=i.voGroup.keyAttributeName;if(n){var v=i.dataInstance[n];if(v){return{key:v,group:i.voGroup.id+"."+v};}}}return null;};S.prototype._deleteObject3D=function(o){o.traverse(function(n){if(n.geometry){if(U.refCountable(n.geometry)){U.subRef(n.geometry);}else{n.geometry.dispose();}}c(n.material).forEach(function(i){if(i.map){U.subRef(i.map);}i.dispose();});});o.parent.remove(o);};S.prototype._getBoxGeometry=function(s){if(s){return this._box6||(this._box6=l(s));}else{return this._box4||(this._box4=l(s));}};S.prototype._getCylinderGeometry=function(o){if(o){return this._cylinder||(this._cylinder=m(o));}else{return this._cylinderCaps||(this._cylinderCaps=m(o));}};S.prototype._getTextureLoader=function(){return this._textureLoader||(this._textureLoader=new T.TextureLoader());};l=function(s){var i=new T.Geometry();var n=0.1;i.vertices.push(new b(n,n,-n),new b(n,-n,-n),new b(-n,-n,-n),new b(-n,n,-n),new b(n,n,n),new b(-n,n,n),new b(-n,-n,n),new b(n,-n,n),new b(n,n,-n),new b(n,n,n),new b(n,-n,n),new b(n,-n,-n),new b(n,-n,-n),new b(n,-n,n),new b(-n,-n,n),new b(-n,-n,-n),new b(-n,-n,-n),new b(-n,-n,n),new b(-n,n,n),new b(-n,n,-n),new b(n,n,n),new b(n,n,-n),new b(-n,n,-n),new b(-n,n,n));var o=new T.Color(0.5,0.5,0.5);i.faces.push(new F(0,2,3,new b(0,0,-1),o),new F(0,1,2,new b(0,0,-1),o),new F(4,5,6,new b(0,0,1),o),new F(4,6,7,new b(0,0,1),o),new F(8,10,11,new b(1,0,0),o),new F(8,9,10,new b(1,0,0),o),new F(12,14,15,new b(0,-1,0),o),new F(12,13,14,new b(0,-1,0),o),new F(16,18,19,new b(-1,0,0),o),new F(16,17,18,new b(-1,0,0),o),new F(20,22,23,new b(0,1,0),o),new F(20,21,22,new b(0,1,0),o));var q;if(s){q=[new V(2/3,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(2/3,1.0),new V(2/3,0.5),new V(2/3,0.0),new V(1.0,0.0),new V(1.0,0.5),new V(2/3,0.5),new V(2/3,1.0),new V(1/3,1.0),new V(1/3,0.5),new V(2/3,0.0),new V(2/3,0.5),new V(1/3,0.5),new V(1/3,0.0),new V(1/3,0.5),new V(1/3,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.0,0.5),new V(0.0,0.0),new V(1/3,0.0),new V(1/3,0.5)];}else{q=[new V(0.5,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(0.5,1.0),new V(0.5,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(0.5,1.0),new V(0.5,0.5),new V(0.5,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.5,0.5),new V(0.5,0.0),new V(1.0,0.0),new V(1.0,0.5),new V(0.5,0.5),new V(0.5,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.0,0.5),new V(0.0,0.0),new V(0.5,0.0),new V(0.5,0.5)];}i.faceVertexUvs[0].push([q[0],q[2],q[3]],[q[0],q[1],q[2]],[q[5],q[6],q[7]],[q[5],q[7],q[4]],[q[8],q[10],q[11]],[q[8],q[9],q[10]],[q[12],q[14],q[15]],[q[12],q[13],q[14]],[q[16],q[18],q[19]],[q[16],q[17],q[18]],[q[20],q[22],q[23]],[q[20],q[21],q[22]]);return i;};m=function(o){var n=0.1;var q=new T.CylinderGeometry(n,n,2*n,32,1,o);if(!o){for(var i=0;i<q.faces.length;++i){var s=q.faces[i];if(s.normal.y!==0){q.faceVertexUvs[0][i][0].u=(q.vertices[s.a].x+n/2)/n;q.faceVertexUvs[0][i][0].v=(q.vertices[s.a].z+n/2)/n;q.faceVertexUvs[0][i][1].u=(q.vertices[s.b].x+n/2)/n;q.faceVertexUvs[0][i][1].v=(q.vertices[s.b].z+n/2)/n;q.faceVertexUvs[0][i][2].u=(q.vertices[s.c].x+n/2)/n;q.faceVertexUvs[0][i][2].v=(q.vertices[s.c].z+n/2)/n;s.materialIndex=1;}else{s.materialIndex=0;}}}return q;};return S;});
