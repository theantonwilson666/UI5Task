/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/base/Object","./Utilities","./thirdparty/three","sap/base/Log"],function(B,U,T,L){"use strict";var t="sap.ui.vbm.PolygonHandler";var V=T.Vector3;var M=T.Matrix4;var p=U.propertyAdded;var a=U.propertyRemoved;var b=U.propertyChanged;var u=U.updateProperty;var g=U.getColor;var r=U.rgbaToString;var e=U.equalsRGBA;var c=U.createMaterial;var d=U.createLineMaterial;var P=B.extend("sap.ui.vbm.adapter3d.PolygonHandler",{constructor:function(i){B.call(this);this._root=i;this._hotInstance=null;this._instances=new Map();this._meshes=new Map();this._borders=new Map();}});var f=2000;var h=2000;P.prototype.destroy=function(){this._root=null;this._instances.clear();this._meshes.forEach(function(k,i){i.forEach(function(m){this._deleteObject3D(m.object3D);},this);},this);this._borders.forEach(function(k,i){i.forEach(function(j){this._deleteObject3D(j.object3D);},this);},this);this._meshes.clear();this._borders.clear();B.prototype.destroy.call(this);};P.prototype.update=function(){var i=this._updateMeshes()||false;i=this._updateBorders()||i;if(this._hotInstance&&i){this._updateHot(this._hotInstance,true);}};P.prototype.addInstance=function(i){this._instances.set(i,{instance:i,indices:[],vertices:[],normal:null,lines:null,matrix:new M(),color:null,colorHot:null,colorBorder:null,colorBorderHot:null,mesh:null,border:null});this.updateInstance(i);};P.prototype.updateInstance=function(i){var j=this._instances.get(i),k=false,l=false;if(j){if(b(i,["pos","rot","scale"])){U.getInstanceMatrix(i,j.matrix);k=l=true;}if(b(i,"OuterNormal")){j.normal=U.toVector3(i.OuterNormal||"0;0;1").normalize();k=true;}if(b(i,"posarray")){this._getGeometry(i,j.indices,j.vertices);k=l=true;}if(b(i,["color","selectColor","VB:s"])){var m=g(i,i.color,false);if(!j.color||!e(m,j.color)){this._removeInstanceFromMesh(j);j.color=m;j.colorHot=g(i,i.color,true);k=true;}}if(a(i,"colorBorder")){this._removeInstanceFromBorder(j);j.lines=j.colorBorder=j.colorBorderHot=null;}else if(i.colorBorder){if(p(i,"colorBorder")||b(i,"posarray")){j.lines=this._getBorderGeometry(j.indices,j.vertices);l=true;}if(b(i,["colorBorder","selectColor,","VB:s"])){var n=g(i,i.colorBorder,false);if(!j.colorBorder||!e(n,j.colorBorder)){this._removeInstanceFromBorder(j);j.colorBorder=n;j.colorBorderHot=g(i,i.colorBorder,true);l=true;}}}if(b(i,"hotDeltaColor")){j.colorHot=g(i,i.color,true);if(j.colorBorder){j.colorBorderHot=g(i,i.colorBorder,true);}}u(i,["pos","rot","scale","OuterNormal","posarray","color","colorBorder","selectColor","hotDeltaColor","VB:s"]);if(k){this._requestMeshUpdate(j);}if(i.colorBorder){if(l){this._requestBorderUpdate(j);}}}else{L.error("Unable to find polygon instance data","",t);}};P.prototype.removeInstance=function(i){var j=this._instances.get(i);if(j){if(this._hotInstance===i){this._hotInstance=null;}this._instances.delete(i);this._removeInstanceFromMesh(j);this._removeInstanceFromBorder(j);i._last={};}else{L.error("Unable to find polygon instance data","",t);}};P.prototype.updateHotInstance=function(i){if(this._hotInstance){this._updateHot(this._hotInstance,false);}if(i&&i.isPolygon){this._updateHot(i,true);}this._hotInstance=(i&&i.isPolygon)?i:null;};P.prototype._updateHot=function(i,j){var k=this._instances.get(i),m,o,l,n;if(k){if(k.mesh){m=k.mesh.material;o=k.mesh.object3D;l=o.geometry;if(l.groups.length){l.groups=[];o.material=o.material[0];}if(j){n=k.mesh.instances.get(k);m.color.copy(k.colorHot.rgb);m.opacity=k.colorHot.opacity;m.transparent=m.opacity<1;m.needsUpdate=true;o.material=[o.material,m];l.addGroup(n.start,k.indices.length,1);if(n.start!==0){l.addGroup(0,n.start,0);}if(n.start+k.indices.length<l.index.count){l.addGroup(n.start+k.indices.length,l.index.count-n.start-k.indices.length,0);}}}if(k.border){m=k.border.material;o=k.border.object3D;l=o.geometry;var q=l.getAttribute("position");if(l.groups.length){l.groups=[];o.material=o.material[0];}if(j){n=k.border.instances.get(k);m.color.copy(k.colorBorderHot.rgb);m.opacity=k.colorBorderHot.opacity;m.transparent=m.opacity<1;m.needsUpdate=true;o.material=[o.material,m];var v=k.lines.length/3;l.addGroup(n.start,v,1);if(n.start!==0){l.addGroup(0,n.start,0);}if(n.start+v<q.count){l.addGroup(n.start+v,q.count-n.start-v,0);}}}}else{L.error("Unable to find polygon instance data","",t);}};P.prototype._getGeometry=function(j,k,v){var i,l=[],m=j.posarray.split(";");v.length=k.length=0;for(i=0;i<m.length/3;++i){var x=parseFloat(m[i*3+0]);var y=parseFloat(m[i*3+1]);var z=parseFloat(m[i*3+2]);l.push(new T.Vector2(x,y));v.push(x,y,z);}var n=T.ShapeUtils.triangulateShape(l,[]);for(i=0;i<n.length;++i){k.push(n[i][0],n[i][1],n[i][2]);}};P.prototype._getBorderGeometry=function(i,v){var j=new T.BufferGeometry();j.setIndex(i);j.setAttribute("position",new T.Float32BufferAttribute(v,3));var k=new T.EdgesGeometry(j);var l=k.getAttribute("position").array;k.dispose();j.dispose();return l;};P.prototype._updateMeshes=function(){var k=[],l=false,m=this._hotInstance?this._instances.get(this._hotInstance):null;this._meshes.forEach(function(n,o){for(var i=0;i<n.length;){if(n[i].dirty){var j,q,s,v=[],w=[],x=[],y=n[i];this._deleteObject3D(y.object3D);y.object3D=null;y.hitInfo.length=0;y.instances.forEach(function(C,D){q=D;C.start=v.length;for(j=0,s=w.length/3;j<q.indices.length;++j){v.push(s+q.indices[j]);}var E=q.indices.length/3;y.hitInfo.length+=E;y.hitInfo.fill(q.instance,y.hitInfo.length-E,y.hitInfo.length);if(q.matrix._identity){for(j=0;j<q.vertices.length/3;++j){w.push(q.vertices[j*3],q.vertices[j*3+1],q.vertices[j*3+2]);x.push(q.normal.x,q.normal.y,q.normal.z);}}else{var F=new V();for(j=0;j<q.vertices.length/3;++j){F.set(q.vertices[j*3],q.vertices[j*3+1],q.vertices[j*3+2]);F.applyMatrix4(q.matrix);w.push(F.x,F.y,F.z);x.push(q.normal.x,q.normal.y,q.normal.z);}}});if(v.length){var z=new T.BufferGeometry();z.setIndex(v);z.setAttribute("position",new T.Float32BufferAttribute(w,3));z.setAttribute("normal",new T.Float32BufferAttribute(x,3));z.computeBoundingBox();z.computeBoundingSphere();var A=c(true);A.color.copy(q.color.rgb);A.opacity=q.color.opacity;A.transparent=A.opacity<1;A.needsUpdate=true;y.object3D=new T.Mesh(z,A);y.object3D.matrixAutoUpdate=false;y.object3D.layers.set(0);this._root.add(y.object3D);y.object3D._instanceHitTest=this._instanceHitTest.bind(y);y.triangleCount=v.length/3;}if(m&&y.instances.has(m)){l=true;}y.dirty=false;}if(n[i].object3D){i++;}else{n.splice(i,1);}}if(!n.length){k.push(o);}},this);k.forEach(function(i){this._meshes.delete(i);},this);return l;};P.prototype._updateBorders=function(){var k=[],l=false,m=this._hotInstance?this._instances.get(this._hotInstance):null;this._borders.forEach(function(n,o){for(var i=0;i<n.length;){if(n[i].dirty){var j,q,v=[],s=n[i];this._deleteObject3D(s.object3D);s.object3D=null;s.instances.forEach(function(y,z){q=z;y.start=v.length/3;if(q.matrix._identity){for(j=0;j<q.lines.length;++j){v.push(q.lines[j]);}}else{var A=new V();for(j=0;j<q.lines.length/3;++j){A.set(q.lines[j*3],q.lines[j*3+1],q.lines[j*3+2]);A.applyMatrix4(q.matrix);v.push(A.x,A.y,A.z);}}});if(v.length){var w=new T.BufferGeometry();w.setAttribute("position",new T.Float32BufferAttribute(v,3));w.computeBoundingBox();var x=d();x.color.copy(q.colorBorder.rgb);x.opacity=q.colorBorder.opacity;x.transparent=x.opacity<1;x.needsUpdate=true;s.object3D=new T.LineSegments(w,x);s.object3D.matrixAutoUpdate=false;s.object3D.layers.set(1);this._root.add(s.object3D);s.lineCount=v.length/6;}if(m&&s.instances.has(m)){l=true;}s.dirty=false;}if(n[i].object3D){i++;}else{n.splice(i,1);}}if(!n.length){k.push(o);}},this);k.forEach(function(i){this._borders.delete(i);},this);return l;};P.prototype._requestMeshUpdate=function(j){if(j.mesh){j.mesh.dirty=true;}else{var k=r(j.color);var m=this._meshes.get(k);if(!m){m=[];this._meshes.set(k,m);}for(var i=0;i<m.length;++i){if(m[i].triangleCount+j.indices.length/3<=f){j.mesh=m[i];break;}}if(!j.mesh){j.mesh={dirty:true,object3D:null,material:c(true),triangleCount:0,hitInfo:[],instances:new Map()};m.push(j.mesh);}j.mesh.instances.set(j,{start:0});j.mesh.dirty=true;j.mesh.triangleCount+=j.indices.length/3;}};P.prototype._requestBorderUpdate=function(j){if(j.border){j.border.dirty=true;}else{var k=r(j.colorBorder);var l=this._borders.get(k);if(!l){l=[];this._borders.set(k,l);}for(var i=0;i<l.length;++i){if(l[i].lineCount+j.lines.length/6<=h){j.border=l[i];break;}}if(!j.border){j.border={dirty:true,object3D:null,material:d(),lineCount:0,instances:new Map()};l.push(j.border);}j.border.instances.set(j,{start:0});j.border.dirty=true;j.border.lineCount+=j.lines.length/6;}};P.prototype._removeInstanceFromMesh=function(i){if(i.mesh){if(i.mesh.instances.delete(i)){i.mesh.triangleCount-=i.indices.length/3;i.mesh.dirty=true;i.mesh=null;}else{L.error("Unable to find instance data in polygon mesh data","",t);}}};P.prototype._removeInstanceFromBorder=function(i){if(i.border){if(i.border.instances.delete(i)){i.border.lineCount-=i.lines.length/6;i.border.dirty=true;i.border=null;}else{L.error("Unable to find instance data in polygon border data","",t);}}};P.prototype._deleteObject3D=function(o){if(o){if(o.parent){o.parent.remove(o);}if(o.geometry){o.geometry.dispose();}U.toArray(o.material).forEach(function(m){m.dispose();});}};P.prototype._instanceHitTest=function(i){return i.faceIndex>=0?this.hitInfo[i.faceIndex]:null;};return P;});
