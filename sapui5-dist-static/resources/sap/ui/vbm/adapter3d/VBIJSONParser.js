/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/base/Object","./Utilities","./ObjectFactory","sap/base/Log","./../library"],function(B,U,O,L,l){"use strict";var t="sap.ui.vbm.VBIJSONParser";var a=U.toArray;var V=B.extend("sap.ui.vbm.adapter3d.VBIJSONParser",{constructor:function(d){B.call(this);this._context=d;this._factory=new O();}});V.prototype.loadVBIJSON=function(p){if(p&&p.SAPVB){if(p.SAPVB.Resources){this._processResources(p.SAPVB.Resources);}if(p.SAPVB.DataTypes){this._processDataTypes(p.SAPVB.DataTypes);}if(p.SAPVB.Data){this._processData(p.SAPVB.Data);}if(p.SAPVB.Scenes){this._processScenes(p.SAPVB.Scenes);}if(p.SAPVB.Windows){this._processWindows(p.SAPVB.Windows);}if(p.SAPVB.Actions){this._processActions(p.SAPVB.Actions);}if(p.SAPVB.Automation){this._processAutomation(p.SAPVB.Automation);}if(p.SAPVB.Data||p.SAPVB.Scenes){this._refreshVisualObjects();}}return this;};var c=function(d,s,e,f){f=a(f);for(var i=0,g=e.length;i<g;++i){var h=e[i];var j=f.length>i?f[i]:h;if(s.hasOwnProperty(h)){d[j]=s[h];}}return d;};V.prototype._processResources=function(r){a(r.Set.Resource).forEach(function(d){this._context.resources.set(d.name,d.value);},this);return this;};V.prototype._processDataTypes=function(d){if(d&&d.Set&&!Array.isArray(d.Set)&&!d.Set.name){this._context.dataTypes.splice(0);var e=function(f){var g=c(this._factory.createDataType(),f,["name","key","minSel","maxSel"]);a(f.A).forEach(function(h){g.attributes.push(c(this._factory.createDataTypeAttribute(),h,["name","alias","type"]));},this);a(f.N).forEach(function(h){g.dataTypes.push(e(h));});return g;}.bind(this);a(d.Set.N).forEach(function(f){this._context.dataTypes.push(e(f));},this);}else{L.error("DataTypes: only the Set verb with no type attribute is supported.","",t);}return this;};V.prototype._findDataTypeByPath=function(p){var f=function(d,e){if(e>p.length){return undefined;}var g=p[e-1];for(var i=0,h=d.length;i<h;++i){var j=d[i];if(j.name===g){if(e===p.length){return j;}else{return f(j.dataTypes,e+1);}}}return undefined;};return f(this._context.dataTypes,1);};V.prototype._findDataTypeByDataNodePath=function(d){var e=[];for(var i=0,f=(d.length+1)/2;i<f;++i){e.push(d[i*2]);}return this._findDataTypeByPath(e);};V.prototype._processData=function(d){a(d.Remove).forEach(function(r){if(r.type!=="E"){L.error("Data: the Remove verb is supported for the 'E' type only.",r.type,t);return;}if(!r.name){L.error("Data: the Remove verb must have the non-empty name attribute.","",t);return;}var f=this._findDataTypeByPath(r.name.split("."));if(!f){L.error("Data: the Remove verb is supported for data nodes with data types only.",r.name,t);return;}var k=f.getKeyAttribute();if(!k){L.error("Data: the Remove verb is supported for data types with keys only.",r.name,t);return;}var g=a(r.N.E).map(function(i){return i[k.alias];});var h=this._findDataNodeByPath(r.name.split("."));if(!h){if(g.length>0){L.warning("Data: unknown data node.",r.name,t);}return;}this._removeDataInstancesByKey(h,k.name,g);},this);var e=function(f,n,g){var h=this._findDataTypeByPath(g);var k=h&&h.getKeyAttribute();a(n.E).forEach(function(i,j){var m=k?sap.ui.vbm.findInArray(f,function(m){return m[k.name]===i[k.alias];}):f[j];if(!m){m=this._factory.createDataInstance();if(k){f.push(m);}else{f[j]=m;}}m.isDirty=true;for(var p in i){if(p==="N"){if(i.N.name){e(m[i.N.name]||(m[i.N.name]=this._factory.createDataNode()),i.N,g.concat(i.N.name));}else{L.error("Data: child data nodes must have names.","",t);}}else{var o=h.getAttributeByAlias(p);if(o){m[o.name]=i[p];}else{m[p]=i[p];}}}},this);}.bind(this);var s=a(d.Set);if(s.length===1&&!s[0].name){this._removeAllDataNodes();a(s.N).forEach(function(n){e((this._context.data[n.name]=this._factory.createDataInstance()),n,[n.name]);},this);}else if(s.length>0){if(s.some(function(f){return!f.name;})){L.error("Data: if there are multiple Set verbs then all Set verbs must have the non-empty name attribute.","",t);return this;}if(s.some(function(f){return!f.N||a(f.N).length>1;})){L.error("Data: all Set verbs with the name attribute must have the single N element.","",t);return this;}s.forEach(function(f){var n=f.name.split(".");if(n.length!==1){L.error("Compound data node paths are not supported yet.","",t);}e(this._findDataNodeByPath(n)||(this._context.data[f.name]=this._factory.createDataNode()),f.N,[n[0]]);},this);}return this;};V.prototype._findDataNodeByPath=function(p){if(p.length>1){L.error("Compound paths for data nodes are not supported yet.",p,t);return undefined;}return this._context.data[p[0]];};V.prototype._getDataValueByPath=function(p){if(p.length%2!==1){L.error("The absolute path to data value must contain an odd number of elements.",p.join("."),t);return undefined;}var d;var e;for(var i=0,f=p.length;i<f;++i){var g=p[i];if(i%2===0){if(i===f-1){return e&&e[g];}else{d=(i==0?this._context.data:e)[g];if(d===undefined){return undefined;}}}else{e=d[g];if(e===undefined){return undefined;}}}return undefined;};V.prototype._removeAllDataNodes=function(){for(var d in this._context.data){this._clearDataNode(this._context.data[d]);delete this._context.data[d];}return this;};V.prototype._clearDataNode=function(d){d.splice(0).forEach(this._clearDataInstance,this);return this;};V.prototype._clearDataInstance=function(d){if(d.visualObject){this._removeVisualObject(d.visualObject);}for(var p in d){if(Array.isArray(d[p])){this._clearDataNode(d[p]);delete d[p];}}return this;};V.prototype._removeDataInstancesByKey=function(d,e,f){for(var i=d.length-1;i>=0&&f.length>0;--i){var g=d[i];var h=g[e];for(var k=f.length-1;k>=0;--k){if(h===f[k]){this._clearDataInstance(g);d.splice(i,1);f.splice(k,1);break;}}}return this;};V.prototype._processScenes=function(d){var e=function(f,g){c(f,g,["id","type","initialStartPosition","initialPitch","initialYaw","initialZoom"],["id","type","position","pitch","yaw","zoom"]);if(f.position||f.zoom||f.pitch||f.yaw){this._context.setupView={position:f.position,zoom:f.zoom,pitch:f.pitch,yaw:f.yaw,home:true,flyTo:false};}a(g.VO).forEach(function(v){var h=f.getVisualObjectGroupById(v.id);if(!h){h=this._factory.createVisualObjectGroup(f);for(var p in v){switch(p){case"id":case"datasource":case"type":h[p]=v[p];break;case"DragSource":case"DropTarget":break;default:if(p.endsWith(".bind")){h.isDataBound=true;var i=p.split(".")[0];var j=v[p].split(".");if(v["datasource"]){j.shift();}h.template[i]={path:j};}else{h.template[p]={value:v[p]};}break;}}}else{L.warning("Scenes: cannot modify existing VO group.",v.id,t);}},this);return f;}.bind(this);if(d.Remove){this._removeScenes(a(d.Remove).map(function(r){return r.name;}));}if(d.Set){var s=a(d.Set);if(s.length===1&&!s[0].name){this._removeScenes(this._context.scenes.map(function(f){return f.id;}));}else if(s.length>0){if(s.some(function(f){return!f.name;})){L.error("Scenes: if there are multiple Set verbs then all Set verbs must have the non-empty name attribute.","",t);return this;}if(s.some(function(f){return!f.Scene||a(f.Scene).length>1;})){L.error("Scene: all Set verbs with the name attribute must have the single Scene element.","",t);return this;}if(s.some(function(f){return f.name!==f.Scene.id;})){L.error("Scene: the Set's attribute 'name' must equal the Set.Scene's attribute 'id'.","",t);return this;}this._removeScenes(s.map(function(f){return f.name;}));}s.forEach(function(f){a(f.Scene||f.SceneGeo).forEach(function(g){var h=this._factory.createScene(!!f.SceneGeo);e(h,g);this._context.scenes.push(h);this._context.sceneQueues.toAdd.push(h);},this);},this);}if(d.Merge){var m=a(d.Merge);if(m.length>0){if(m.some(function(f){return!f.name;})){L.error("Scenes: all Merge elements must have the name attribute.","",t);return this;}if(m.some(function(f){return!f.Scene||a(f.Scene).length>1;})){L.error("Scenes: all Merge verbs must have the single Scene element.","",t);return this;}if(m.some(function(f){return f.name!==f.Scene.id;})){L.error("Scenes: the Merge's attribute 'name' must equal the Merge.Scene's attribute 'id'.","",t);return this;}m.forEach(function(f){a(f.Scene||f.SceneGeo).forEach(function(g){var h=this._findSceneById(f.name);if(h){e(h,g);this._context.sceneQueues.toUpdate.push(h);}},this);},this);}}return this;};V.prototype._findSceneById=function(d){for(var i=0,e=this._context.scenes.length;i<e;++i){var s=this._context.scenes[i];if(s.id===d){return s;}}return undefined;};V.prototype._removeScenes=function(d){for(var i=this._context.scenes.length-1;i>=0&&d.length>0;--i){var s=this._context.scenes[i];var e=s.id;for(var k=d.length-1;k>=0;--k){if(d[k]===e){this._context.sceneQueues.toRemove.push(s);this._context.scenes.splice(i,1);d.splice(k,1);s.voGroups.forEach(function(v){for(var i=v.vos.length-1;i>=0;--i){this._removeVisualObject(v.vos[i]);}},this);break;}}}return this;};V.prototype._processVisualObjectGroup=function(v){if(v.isDataBound&&v.datasource){var d=v.datasource.split(".");var e=this._findDataNodeByPath(d);if(e){var f=this._findDataTypeByDataNodePath(d);if(f){v.maxSel=f.maxSel;v.minSel=f.minSel;var k=f.getKeyAttribute();if(k){v.keyAttributeName=k.name;}}e.forEach(function(g){if(g.visualObject){if(g.isDirty||v.isDirty){this._queueVisualObjectToUpdate(v.scene,this._populateVisualObject(g.visualObject,g));}}else{this._queueVisualObjectToAdd(v.scene,this._populateVisualObject(this._factory.createVisualObject(v),g));}},this);}}else if(v.vos.length===0){this._queueVisualObjectToAdd(v.scene,this._populateVisualObject(this._factory.createVisualObject(v)));}else if(v.vos.length===1){this._queueVisualObjectToUpdate(v.scene,this._populateVisualObject(v.vos[0]));}return this;};V.prototype._removeVisualObject=function(v){var g=v.voGroup.vos;var i=g.indexOf(v);if(i>=0){g.splice(i,1);}var d=v.voGroup.selected;var s=d.indexOf(v);if(s>=0){d.splice(s,1);}var e=v.voGroup.scene;v.voGroup=null;if(v.dataInstance){v.dataInstance.visualObject=null;v.dataInstance=null;}this._queueVisualObjectToRemove(e,v);return this;};V.prototype._populateVisualObject=function(v,d){var e=v.voGroup;var f=e.template;for(var g in f){var h=f[g],i;if("path"in h){if(d){i=d[h.path[0]];if(i!==undefined){v[g]=i;}}else{i=this._getDataValueByPath(h.path);if(i!=undefined){v[g]=i;}}}else{v[g]=h.value;}}if(d){if(e.keyAttributeName){v.id=d[e.keyAttributeName];}d.visualObject=v;v.dataInstance=d;var w=v["VB:s"]&&v["VB:s"]!=="false"?true:false;var j=d["VB:s"]&&d["VB:s"]!=="false"?true:false;if(w!==j){if(w){if(e.minSel==="0"||e.selected.length>1){e.selected.splice(e.selected.indexOf(v),1);v["VB:s"]="false";}}else if(e.maxSel!=="0"){if(e.maxSel==="1"){e.selected.splice(0).forEach(function(k){k["VB:s"]="false";this._queueVisualObjectToUpdate(e.scene,k);},this);}e.selected.push(v);v["VB:s"]="true";}}}return v;};var b=function(q,s,v){if(q.has(s)){q.get(s).push(v);}else{q.set(s,[v]);}return v;};V.prototype._queueVisualObjectToAdd=function(s,v){b(this._context.voQueues.toAdd,s,v);return this;};V.prototype._queueVisualObjectToUpdate=function(s,v){b(this._context.voQueues.toUpdate,s,v);return this;};V.prototype._queueVisualObjectToRemove=function(s,v){b(this._context.voQueues.toRemove,s,v);return this;};V.prototype._refreshVisualObjects=function(){this._context.scenes.forEach(function(s){s.voGroups.forEach(this._processVisualObjectGroup,this);},this);this._resetDirtyFlag();return this;};V.prototype._processWindows=function(d){var f=function(e){for(var i=0,g=this._context.windows.length;i<g;++i){var w=this._context.windows[i];if(w.id===e){return{window:w,index:i};}}return{};}.bind(this);if(d.Remove){a(d.Remove).forEach(function(r){var e=f(r.name);if(e.window){this._context.windows.splice(e.index,1);this._context.windowQueues.toRemove.push(e.window);}},this);}if(d.Set){var s=a(d.Set);if(s.length===1&&!s[0].name){this._context.windows.splice(0).forEach(function(w){this._context.windowQueues.toRemove.push(w);},this);}else if(s.length>0){if(s.some(function(e){return!e.name;})){L.error("Windows: if there are multiple Set verbs then all Set verbs must have the non-empty name attribute.","",t);return this;}if(s.some(function(e){return!e.Window||a(e.Window).length>1;})){L.error("Window: all Set verbs with the name attribute must have the single Window element.","",t);return this;}if(s.some(function(e){return e.name!==e.Window.id;})){L.error("Window: the Set's attribute 'name' must equal the Set.Window's attribute 'id'.","",t);return this;}}s.forEach(function(e){a(e.Window).forEach(function(w){var g=f(w.id).window;if(g){this._context.windowQueues.toUpdate.push(g);}else{g=this._factory.createWindow();this._context.windows.push(g);this._context.windowQueues.toAdd.push(g);}c(g,w,["id","type","caption","refScene","refParent","width","height","modal"]);if("pos.bind"in w){g.pos=this._getDataValueByPath(w["pos.bind"]);}else if("pos"in w){g.pos=w.pos;}},this);},this);}return this;};V.prototype._processActions=function(d){if(d&&d.Set&&d.Set.Action){Array.prototype.push.apply(this._context.actions,a(d.Set.Action));}return this;};V.prototype._processAutomation=function(d){if(d&&d.Call){a(d.Call).forEach(function(e){switch(e.handler){case"FLYTOHANDLER":var f=a(e.Param);var g=sap.ui.vbm.findInArray(this._context.scenes,function(s){return s.id===(sap.ui.vbm.findInArray(f,function(p){return p.name==="scene";})||{})["#"]||"";});if(g){var h=(sap.ui.vbm.findInArray(f,function(p){return p.name==="x";})||{})["#"]||"0";var o=(sap.ui.vbm.findInArray(f,function(p){return p.name==="y";})||{})["#"]||"0";var i=(sap.ui.vbm.findInArray(f,function(p){return p.name==="z";})||{})["#"]||"0";g.position=h+";"+o+";"+i;g.zoom=(sap.ui.vbm.findInArray(f,function(p){return p.name==="lod";})||{})["#"]||"0";g.pitch=(sap.ui.vbm.findInArray(f,function(p){return p.name==="pitch";})||{})["#"]||"0";g.yaw=(sap.ui.vbm.findInArray(f,function(p){return p.name==="yaw";})||{})["#"]||"0";this._context.setupView={position:g.position,zoom:g.zoom,pitch:g.pitch,yaw:g.yaw,flyTo:true};}break;default:break;}},this);}return this;};V.prototype._resetDirtyFlag=function(){for(var p in this._context.data){(function d(n){n.forEach(function(i){i.isDirty=false;for(var p in i){if(Array.isArray(i[p])){d(i[p]);}}});})(this._context.data[p]);}this._context.scenes.forEach(function(s){s.voGroups.forEach(function(v){v.isDirty=false;});});return this;};return V;});
