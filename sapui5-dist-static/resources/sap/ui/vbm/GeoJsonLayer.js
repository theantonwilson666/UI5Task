/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/core/theming/Parameters","jquery.sap.global","sap/base/Log","./library"],function(E,P,q,L,l){"use strict";var t="sap.ui.vbm.GeoJsonLayer";var G=E.extend("sap.ui.vbm.GeoJsonLayer",{metadata:{library:"sap.ui.vbm",properties:{srcURL:{type:"string",defaultValue:null},data:{type:"object",defaultValue:null},defaultLineWidth:{type:"int",group:"Appearance",defaultValue:5},defaultFillColor:{type:"sap.ui.core.CSSColor",group:"Appearance",defaultValue:"rgba(186, 193, 196, 0.5)"},defaultBorderColor:{type:"sap.ui.core.CSSColor",group:"Appearance",defaultValue:"rgba(255, 255, 255, 1.0)"}},defaultAggregation:"items",aggregations:{items:{type:"sap.ui.vbm.Feature",multiple:true,singularName:"item"}},events:{click:{parameters:{featureId:{type:"string"}}},contextMenu:{parameters:{featureId:{type:"string"}}}}}});G.prototype.init=function(){this.mbGeoJSONDirty=true;this.mbSrcLoadPending=false;this._aGeoJsonObjects=[];};G.prototype.setSrcURL=function(s){this.mbGeoJSONDirty=true;return this.setProperty("srcURL",s);};G.prototype.setData=function(d){this.mbGeoJSONDirty=true;this._aGeoJsonObjects=d;return this.setProperty("data",d);};G.prototype.addData=function(d){this.mbGeoJSONDirty=true;if(q.type(d)==="array"){this._aGeoJsonObjects=this._aGeoJsonObjects.concat(d);}else{this._aGeoJsonObjects.push(d);}this.setProperty("data",this._aGeoJsonObjects);this.getParent().invalidate(this);};G.prototype._createFeatures=function(d){var a=this.getDefaultFillColor();var b=this.getDefaultBorderColor();var g=this._aGeoJsonObjects;if(d){g.push(d);}this.mFeatureColl=[];this.mFeatureBBox={};this.mNames={};this.mFeatureProps={};for(var n=0;n<g.length;++n){var e=g[n];switch(e.type){case"FeatureCollection":for(var c=0,f;c<e.features.length;++c){f=e.features[c];this._processType(f.id,f.geometry.type,f.geometry.coordinates,f.properties,a,b);}break;case"Feature":this._processType(e.id,e.geometry.type,e.geometry.coordinates,e.properties,a,b);break;case"GeometryCollection":for(var h=0,o;h<e.geometries.length;++h){o=e.geometries[h];this._processType(null,o.type,o.coordinates,null,a,b);}break;case"Polygon":case"MultiPolygon":case"LineString":case"MultiLineString":case"Point":case"MultiPoint":this._processType(null,e.type,e.coordinates,null,a,b);break;default:L.error("Unsupported GeoJSON object type",g[n].type,t);continue;}}this.mbGeoJSONDirty=false;};G.prototype._processType=function(i,T,c,p,f,b){var x,y,m=Number.MAX_VALUE,a=-Number.MAX_VALUE,d=Number.MAX_VALUE,e=-Number.MAX_VALUE;var g='',h;var C;var j;var n,k;var o=[];var r=[];var B=[];g=(p&&p.name)?p.name:"";this.mFeatureProps[i]=p;switch(T){case"Polygon":for(n=0;n<c.length;++n){j=c[n];C=[];for(k=0;k<j.length;++k){h=j[k];if(!n){if((x=h[0])<m){m=x;}if(x>a){a=x;}if((y=h[1])<d){d=y;}if(y>e){e=y;}}C.push(h[0],h[1],"0");}r.push(C);}o.push(r);B.push([m,a,d,e]);break;case"MultiPolygon":for(var s=0,u,v=c.length;s<v;++s){r=[];u=c[s].length;for(n=0;n<u;++n){j=c[s][n];C=[];for(k=0;k<j.length;++k){h=j[k];if(!n){if((x=h[0])<m){m=x;}if(x>a){a=x;}if((y=h[1])<d){d=y;}if(y>e){e=y;}}C.push(h[0],h[1],"0");}r.push(C);}o.push(r);B.push([m,a,d,e]);}break;case"LineString":C=[];for(n=0;n<c.length;++n){h=c[n];if((x=h[0])<m){m=x;}if(x>a){a=x;}if((y=h[1])<d){d=y;}if(y>e){e=y;}C.push(h[0],h[1],0);}r.push(C);o.push(r);B.push([m,a,d,e]);break;case"Point":d=e=c[1];m=a=c[0];C=[c[0],c[1],0];r.push(C);o.push(r);B.push([m,a,d,e]);break;default:L.error("Unsupported geometry type",T,t);return;}this.mFeatureColl.push(this._createDataElement(i,o,T,f,b,g,i));this.mFeatureBBox[i]=window.VBI.MathLib.GetSurroundingBox(B);};G.prototype._createDataElement=function(i,a,b,c,d,e,f){var g={K:i,P:[],TT:e,C:c,CB:d,type:b};g["VB:s"]=false;var n,h,j;var s,k,m,o,p;switch(b){case"Polygon":case"MultiPolygon":var r,u;p=a.length;for(j=0;j<p;++j){r=a[j];u=[];o=r.length;for(h=0;h<o;++h){s="";m=r[h].length;for(n=0;n<m;++n){if(n){(s+=";");}s+=r[h][n];}u.push(s);}g.P.push(u);}break;case"LineString":s="";k=a[0][0];m=k.length;for(n=0;n<m;++n){if(n){(s+=";");}s+=k[n];}g.P=s;break;case"Point":s="";k=a[0][0];m=k.length;for(n=0;n<m;++n){if(n){(s+=";");}s+=k[n];}g.P=s;break;}return g;};G.prototype._triggerFeatureCreation=function(){var p=null;if((p=this.getSrcURL())){if(!this.mbSrcLoadPending){this.mbSrcLoadPending=true;q.getJSON(p,function(d){this._createFeatures(d);this.mbSrcLoadPending=false;var o;if((o=this.getParent())){o.invalidate();}}.bind(this)).fail(function(){L.error("The path or the GeoJSON file is invalid",p,t);});}}else{this._createFeatures(null);}};G.prototype.getTemplateObjects=function(){var T,r=[];T={id:this.getId()+"_Polys",type:"{00100000-2012-0004-B001-F311DE491C77}",hotDeltaColor:"RHLSA(0;1;1;1.5)",altBorderDeltaColor:(P)?P.get("_sap_ui_vbm_shared_ChartDataPointBorderHoverSelectedColor"):"#666"};T.datasource=T.id;T['posarraymulti.bind']=T.id+".P";T['color.bind']=T.id+".C";T['colorBorder.bind']=T.id+".CB";T['tooltip.bind']=T.id+".TT";r.push(T);T={id:this.getId()+"_Lines",type:"{00100000-2012-0004-B001-C46BD7336A1A}",hotDeltaColor:"RHLSA(0;1;1;1.5)",altBorderDeltaColor:(P)?P.get("_sap_ui_vbm_shared_ChartDataPointBorderHoverSelectedColor"):"#666"};T.datasource=T.id;T['posarray.bind']=T.id+".P";T['color.bind']=T.id+".C";T['colorBorder.bind']=T.id+".CB";T['tooltip.bind']=T.id+".TT";r.push(T);T={id:this.getId()+"_Points",type:"{00100000-2012-0004-B001-64592B8DB964}",hotDeltaColor:"RHLSA(0;1;2;1)"};T.datasource=T.id;T['pos.bind']=T.id+".P";T['tooltip.bind']=T.id+".TT";r.push(T);return r;};G.prototype.getTypeObjects=function(){var T={},r=[];var o={key:"K",minSel:"0",maxSel:"0",A:[{"name":"K","alias":"K","type":"string"},{"name":"C","alias":"C","type":"color"},{"name":"CB","alias":"CB","type":"string"},{"name":"TT","alias":"TT","type":"string"}]};q.extend(true,T,o);T.name=this.getId()+"_Polys";T.A.push({"name":"P","alias":"P","type":"vectorarraymulti"});r.push(T);T={};q.extend(true,T,o);T.name=this.getId()+"_Lines";T.A.push({"name":"P","alias":"P","type":"vectorarray"});r.push(T);T={};q.extend(true,T,o);T.name=this.getId()+"_Points";T.A.push({"name":"P","alias":"P","type":"vector"});r.push(T);return r;};G.prototype.getDataObjects=function(){if(this.mbGeoJSONDirty){this._triggerFeatureCreation();}var e=[],p=[],a=[],b=[];q.extend(true,e,this.mFeatureColl);var o={};if(e.length){var O=this.getItems();for(var n=0,c=O?O.length:0,i;n<c;++n){i=O[n];o[i.getFeatureId()]=i;}}for(var d=0,f,g,h;d<e.length;++d){f=e[d];if((g=o[f.K])){f.C=g.getColor();if((h=g.getTooltip())){f.TT=h;}}switch(f.type){case"Polygon":case"MultiPolygon":p.push(f);break;case"LineString":case"MultiLineString":a.push(f);break;case"Point":case"MultiPoint":b.push(f);break;default:L.error("Unknown object type",f.type,t);}}return[{"name":this.getId()+"_Polys","type":"N","E":p},{"name":this.getId()+"_Lines","type":"N","E":a},{"name":this.getId()+"_Points","type":"N","E":b}];};G.prototype.getDataRemoveObjects=function(){return[{"name":this.getId()+"_Polys","type":"N"},{"name":this.getId()+"_Lines","type":"N"},{"name":this.getId()+"_Points","type":"N"}];};G.prototype.getActionArray=function(){var a=[];var i=this.getId();if(this.mEventRegistry["click"]||this.isEventRegistered("click")){a.push({"id":i+"Polys1","name":"click","refScene":"MainScene","refVO":i+"_Polys","refEvent":"Click","AddActionProperty":[{"name":"pos"}]});a.push({"id":i+"Lines1","name":"click","refScene":"MainScene","refVO":i+"_Lines","refEvent":"Click","AddActionProperty":[{"name":"pos"}]});a.push({"id":i+"Points1","name":"click","refScene":"MainScene","refVO":i+"_Points","refEvent":"Click","AddActionProperty":[{"name":"pos"}]});}if(this.mEventRegistry["contextMenu"]||this.isEventRegistered("contextMenu")){a.push({"id":i+"_Polys2","name":"contextMenu","refScene":"MainScene","refVO":i+"_Polys","refEvent":"ContextMenu"});a.push({"id":i+"_Lines2","name":"contextMenu","refScene":"MainScene","refVO":i+"_Lines","refEvent":"ContextMenu"});a.push({"id":i+"_Points2","name":"contextMenu","refScene":"MainScene","refVO":i+"_Points","refEvent":"ContextMenu"});}return a;};G.prototype.getFeaturesInfo=function(f){var r=[];for(var n=0,a=f.length,b;n<a;++n){b=f[n];r[b]={};r[b].BBox=this.mFeatureBBox[b];r[b].Midpoint=[(this.mFeatureBBox[b][0]+this.mFeatureBBox[b][1])/2,(this.mFeatureBBox[b][2]+this.mFeatureBBox[b][3])/2];r[b].Name=this.mNames[b];r[b].Properties=this.mFeatureProps[b];}return r;};G.prototype.handleEvent=function(e){var s=e.Action.name;var f="fire"+s[0].toUpperCase()+s.slice(1);var o,i=e.Action.instance;if((o=this.findInstance(i))){if(o.mEventRegistry[s]){if(s==="click"){o.mClickGeoPos=e.Action.AddActionProperties.AddActionProperty[0]['#'];}if(s==="contextMenu"){o.mClickPos=[e.Action.Params.Param[0]['#'],e.Action.Params.Param[1]['#']];sap.ui.getCore().loadLibrary("sap.ui.unified");if(this.oParent.mVBIContext.m_Menus){this.oParent.mVBIContext.m_Menus.deleteMenu("DynContextMenu");}var m=new sap.ui.unified.Menu();m.vbi_data={};m.vbi_data.menuRef="CTM";m.vbi_data.VBIName="DynContextMenu";o.fireContextMenu({menu:m});}else if(s==="handleMoved"){o[f]({data:e});}else{o[f]({});}}}if(this.mEventRegistry[s]){this[f]({featureId:i.split(".")[1]});}};G.prototype.openDetailWindow=function(f,p){var o=this.getParent();o.mDTWindowCxt.bUseClickPos=true;o.mDTWindowCxt.open=true;o.mDTWindowCxt.src=f;o.mDTWindowCxt.key=f.getFeatureId();o.mDTWindowCxt.params=p;o.m_bWindowsDirty=true;o.invalidate(this);};G.prototype.openContextMenu=function(f,m){this.oParent.openContextMenu("Area",f,m);};G.prototype.handleChangedData=function(e){if(e&&e.length){for(var n=0,o,i;n<e.length;++n){o=e[n];i=(o.K)?this.findInstance(o.K):null;if(i){i.handleChangedData(o);}}}};G.prototype.isEventRegistered=function(n){var o=this.getItems();if(!o){return false;}for(var a=0,b=o.length;a<b;++a){if(o[a].mEventRegistry[n]){return true;}}return false;};G.prototype.findInstance=function(n){var o=this.getItems();if(!o){return null;}switch(q.type(n)){case"string":var k=(n.indexOf(".")!==-1)?n.split(".")[1]:n;for(var a=0,b=o.length;a<b;++a){if(o[a].getFeatureId()===k){return o[a];}}break;case"number":break;default:L.error("Unexpected instance name type",q.type(n),t);break;}return null;};return G;});
