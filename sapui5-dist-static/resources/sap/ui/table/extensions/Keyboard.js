/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ExtensionBase","./KeyboardDelegate","../utils/TableUtils","sap/ui/core/delegate/ItemNavigation","sap/ui/Device","sap/ui/dom/containsOrEquals","sap/ui/thirdparty/jquery"],function(E,K,T,I,D,c,q){"use strict";var b=false;function a(o){if(D.browser.msie){if(!b){q("head").append("<style type=\"text/css\">"+"/* Avoid focus outline problems in tables */\n"+".sapUiTableStatic[data-sap-ui-table-focus]{}"+"</style>");b=true;}var C=T.getCellInfo(o)||{};if(C.isOfType(T.CELLTYPE.ANY)){C.cell.attr("data-sap-ui-table-focus",Date.now());}}}var d={_forward:function(t,o){var i=t._getItemNavigation();if(i!=null&&!t._getKeyboardExtension()._isItemNavigationSuspended()&&!o.isMarked("sapUiTableSkipItemNavigation")){i["on"+o.type](o);}},onfocusin:function(o){d._forward(this,o);a(o.target);},onsapfocusleave:function(o){d._forward(this,o);},onmousedown:function(o){d._forward(this,o);},onsapnext:function(o){d._forward(this,o);},onsapnextmodifiers:function(o){d._forward(this,o);},onsapprevious:function(o){d._forward(this,o);},onsappreviousmodifiers:function(o){d._forward(this,o);},onsappageup:function(o){d._forward(this,o);},onsappagedown:function(o){d._forward(this,o);},onsaphome:function(o){d._forward(this,o);},onsaphomemodifiers:function(o){d._forward(this,o);},onsapend:function(o){d._forward(this,o);},onsapendmodifiers:function(o){d._forward(this,o);},onsapkeyup:function(o){d._forward(this,o);}};var e={onBeforeRendering:function(o){this._oStoredFocusInfo=this.getFocusInfo();},onAfterRendering:function(o){var R=o&&o.isMarked("renderRows");this._getKeyboardExtension().invalidateItemNavigation();if(this._oStoredFocusInfo&&this._oStoredFocusInfo.customId){if(R){this.applyFocusInfo(this._oStoredFocusInfo);}else{this._getKeyboardExtension().initItemNavigation();}}delete this._oStoredFocusInfo;},onfocusin:function(o){var h=this._getKeyboardExtension();if(!h._bIgnoreFocusIn){h.initItemNavigation();}else{o.setMarked("sapUiTableIgnoreFocusIn");}if(o.target&&o.target.id===this.getId()+"-rsz"){o.preventDefault();o.setMarked("sapUiTableSkipItemNavigation");}}};var f={_initItemNavigation:function(o){var t=o.getTable();if(!t){return;}var $=t.$();var R=t.getRows().length;var C=T.getVisibleColumnCount(t);var h=T.hasRowHeader(t);var H=T.hasRowActions(t);var j=T.hasFixedColumns(t);var i;var k=[],l,m,n,p,u;if(j){n=$.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)");p=$.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)");u=$.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)");}var v=$.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)");var w=$.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)");var x=$.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)");if(h){l=$.find(".sapUiTableRowSelectionCell").get();C++;}if(H){m=$.find(".sapUiTableRowActionCell").get();C++;}for(i=0;i<R;i++){if(h){k.push(l[i]);}if(j){k=k.concat(n.find("tr[data-sap-ui-rowindex=\""+i+"\"]").find("td[tabindex]").get());}k=k.concat(v.find("tr[data-sap-ui-rowindex=\""+i+"\"]").find("td[tabindex]").get());if(j){k=k.concat(p.find("tr[data-sap-ui-rowindex=\""+i+"\"]").find("td[tabindex]").get());}k=k.concat(w.find("tr[data-sap-ui-rowindex=\""+i+"\"]").find("td[tabindex]").get());if(j){k=k.concat(u.find("tr[data-sap-ui-rowindex=\""+i+"\"]").find("td[tabindex]").get());}k=k.concat(x.find("tr[data-sap-ui-rowindex=\""+i+"\"]").find("td[tabindex]").get());if(H){k.push(m[i]);}}if(t.getColumnHeaderVisible()){var y=[];var F=$.find(".sapUiTableCHT.sapUiTableCtrlFixed>tbody>tr");var S=$.find(".sapUiTableCHT.sapUiTableCtrlScroll>tbody>tr");var z=T.getHeaderRowCount(t);for(i=0;i<z;i++){if(h){y.push(t.getDomRef("selall"));}if(F.length){y=y.concat(q(F.get(i)).find(".sapUiTableHeaderCell").get());}if(S.length){y=y.concat(q(S.get(i)).find(".sapUiTableHeaderCell").get());}if(H){y.push($.find(".sapUiTableRowActionHeaderCell").children().get(0));}}k=y.concat(k);}if(!o._itemNavigation){o._itemNavigation=new I();o._itemNavigation.setTableMode(true);o._itemNavigation.attachEvent(I.Events.AfterFocus,function(A){var B=T.getFocusedItemInfo(t);B.header=T.getHeaderRowCount(t);B.domRef=null;if(B.row>=B.header){o._oLastFocusedCellInfo=B;}},t);}o._itemNavigation.setColumns(C);o._itemNavigation.setRootDomRef($.find(".sapUiTableCnt").get(0));o._itemNavigation.setItemDomRefs(k);o._itemNavigation.setFocusedIndex(f.getInitialItemNavigationIndex(o));o._itemNavigationInvalidated=false;},getInitialItemNavigationIndex:function(o){return T.hasRowHeader(o.getTable())?1:0;},isItemNavigationInvalid:function(o){return!o._itemNavigation||o._itemNavigationInvalidated;}};var g=E.extend("sap.ui.table.extensions.Keyboard",{_init:function(t,h,S){this._itemNavigation=null;this._itemNavigationInvalidated=false;this._itemNavigationSuspended=false;this._delegate=new K(h);this._actionMode=false;T.addDelegate(t,e,t);T.addDelegate(t,this._delegate,t);T.addDelegate(t,d,t);t._getItemNavigation=function(){return this._itemNavigation;}.bind(this);return"KeyboardExtension";},_debug:function(){this._ExtensionHelper=f;this._ItemNavigationDelegate=d;this._ExtensionDelegate=e;},destroy:function(){var t=this.getTable();if(t){t.removeEventDelegate(e);t.removeEventDelegate(this._delegate);t.removeEventDelegate(d);}if(this._itemNavigation){this._itemNavigation.destroy();this._itemNavigation=null;}if(this._delegate){this._delegate.destroy();this._delegate=null;}E.prototype.destroy.apply(this,arguments);}});g.prototype.initItemNavigation=function(){if(f.isItemNavigationInvalid(this)){f._initItemNavigation(this);}};g.prototype.invalidateItemNavigation=function(){this._itemNavigationInvalidated=true;};g.prototype.setActionMode=function(h){if(!this._delegate){return;}if(h===true&&!this._actionMode&&this._delegate.enterActionMode){this._actionMode=this._delegate.enterActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1))===true;}else if(h===false&&this._actionMode&&this._delegate.leaveActionMode){this._actionMode=false;this._delegate.leaveActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1));}};g.prototype.isInActionMode=function(){return this._actionMode;};g.prototype.updateNoDataAndOverlayFocus=function(){var t=this.getTable();var F=document.activeElement;if(!t||!t.getDomRef()){return;}if(t.getShowOverlay()){if(c(t.getDomRef(),F)&&t.$("overlay")[0]!==F){this._oLastFocus={Ref:F,Pos:"overlay"};t.$("overlay").focus();}}else if(T.isNoDataVisible(t)&&t.$("noDataCnt")[0]!==F){if(c(t.getDomRef("tableCCnt"),F)){this._oLastFocus={Ref:F,Pos:"table content"};t.$("noDataCnt").focus();}else if(t.$("overlay")[0]===F){s(t,this);}}else if(this._oLastFocus){if(this._oLastFocus.Pos==="table content"){if(c(t.getDomRef("tableCCnt"),this._oLastFocus.Ref)){r(t,this);}else if(t.getRows()[0]&&t.getRows()[0].getDomRef("col0")){t.getRows()[0].getDomRef("col0").focus();this._oLastFocus=null;}}else if(this._oLastFocus.Pos==="overlay"){if(c(t.getDomRef(),this._oLastFocus.Ref)){r(t,this);}else{s(t,this);}}}};function r(t,k){if(!q(k._oLastFocus.Ref).hasClass("sapUiTableCell")){var p=T.getParentCell(t,k._oLastFocus.Ref);if(p&&p[0]&&q(p[0]).hasClass("sapUiTableCell")){p[0].focus();}else{k._oLastFocus.Ref.focus();}}else{k._oLastFocus.Ref.focus();}k._oLastFocus=null;}function s(t,k){if(t.getColumnHeaderVisible()){T.focusItem(t,f.getInitialItemNavigationIndex(k));k._oLastFocus=null;}else if(T.isNoDataVisible(t)){t.$("noDataCnt").focus();k._oLastFocus=null;}else if(t.getRows()[0]&&t.getRows()[0].getDomRef("col0")){t.getRows()[0].getDomRef("col0").focus();k._oLastFocus=null;}}g.prototype._suspendItemNavigation=function(){this._itemNavigationSuspended=true;};g.prototype._resumeItemNavigation=function(){this._itemNavigationSuspended=false;};g.prototype._isItemNavigationSuspended=function(){return this._itemNavigationSuspended;};g.prototype._getLastFocusedCellInfo=function(){var h=T.getHeaderRowCount(this.getTable());if(!this._oLastFocusedCellInfo||this._oLastFocusedCellInfo.header!=h){var i=T.getFocusedItemInfo(this.getTable());var j=f.getInitialItemNavigationIndex(this);return{cellInRow:j,row:h,header:h,cellCount:i.cellCount,columnCount:i.columnCount,cell:i.columnCount*h+j};}return this._oLastFocusedCellInfo;};g.prototype._setSilentFocus=function(o){this._bIgnoreFocusIn=true;this._setFocus(o);this._bIgnoreFocusIn=false;};g.prototype._setFocus=function(o){if(!o){return;}var t=this.getTable();var C=T.getCellInfo(o);if(C.isOfType(T.CELLTYPE.ANY)&&t){var $=q(o);if($.attr("tabindex")!="0"){var h=t._getItemNavigation();if(h&&h.aItemDomRefs){for(var i=0;i<h.aItemDomRefs.length;i++){if(h.aItemDomRefs[i]){h.aItemDomRefs[i].setAttribute("tabindex","-1");}}}$.attr("tabindex","0");}}o.focus();};g.prototype._getTableType=function(){return this._type;};return g;});
