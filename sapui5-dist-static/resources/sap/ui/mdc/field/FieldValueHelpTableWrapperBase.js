/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/mdc/field/FieldValueHelpContentWrapperBase','sap/ui/model/ChangeReason','sap/ui/model/Filter','sap/ui/model/FormatException','sap/ui/model/ParseException','sap/ui/model/FilterType','sap/ui/model/FilterOperator','sap/ui/model/FilterProcessor','sap/ui/base/ManagedObjectObserver','sap/base/strings/capitalize','sap/m/library','sap/base/util/deepEqual','sap/base/Log','sap/ui/base/SyncPromise'],function(F,C,a,b,P,c,d,e,M,f,l,g,L,S){"use strict";var h=F.extend("sap.ui.mdc.field.FieldValueHelpTableWrapperBase",{metadata:{library:"sap.ui.mdc",aggregations:{table:{type:"sap.ui.core.Control",multiple:false}},defaultAggregation:"table"}});h.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oObserver=new M(this._observeChanges.bind(this));this._oObserver.observe(this,{properties:["selectedItems"],aggregations:["table"]});this._bTableResolved=false;this._oTablePromise=new Promise(function(r){this._oTablePromiseResolve=r;}.bind(this));this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oPromises={};this._oTableDelegate={onsapprevious:this._handleTableEvent,onsapnext:this._handleTableEvent,cellClick:this._handleTableEvent};};h.prototype.exit=function(){this._sTableWidth=null;this._oObserver.disconnect();this._oObserver=undefined;if(this._oTableModificationPromise){this._oTableModificationPromise=null;}delete this._oTablePromise;delete this._oTablePromiseResolve;delete this._bTableResolved;F.prototype.exit.apply(this,arguments);};h.prototype.invalidate=function(o){if(o){var t=this._getWrappedTable();if(t&&o===t){if(o.bOutput&&!this._bIsBeingDestroyed){var p=this.getParent();if(p){p.invalidate(this);}}return;}}F.prototype.invalidate.apply(this,arguments);};h.prototype.getDialogContent=function(){return this._getWrappedTable();};h.prototype.getSuggestionContent=function(){return this._getWrappedTable();};h.prototype.fieldHelpOpen=function(s){F.prototype.fieldHelpOpen.apply(this,arguments);var t=this._getWrappedTable();if(t){this._adjustTable(s);this._updateSelectedItems();}return this;};h.prototype.navigate=function(s,i){var t=this._getWrappedTable();if(!this._isTableReady(t)){if(t&&!this._bTableResolved&&!this._bNavigationDelayed){this._bNavigationDelayed=true;this._oTablePromise.then(function(){this.fireNavigate({disableFocus:true});this._bNavigationDelayed=false;}.bind(this));}this._bNavigate=true;this._iStep=s;return;}var j=this.getSelectedItems();var o=j&&j[0];var T=o&&this._getTableItemByKey(o.key);if(this._getMaxConditions()!==1){this._bShouldRebind=false;this.fireNavigate();t.focus();return;}var I=this._getTableItems();var p=I.length;var q=0;if(T){q=I.indexOf(T);q=q+s;}else if(s>=0){q=s-1;}else{q=p+s;}var r;if(q<0){q=0;r=true;}else if(q>=p-1){q=p-1;r=false;}else{r=s>=0;}while(I[q]&&I[q].isA("sap.m.GroupHeaderListItem")){if(r){q++;}else{q--;}}var u=I[q];if(u){var v=this._getDataFromItem(u);var w=u===T;if(!w){this._modifyTableSelection(I,u,true,undefined,true);}S.resolve(this._handleScrolling(u)).then(function(x){var R=u.getId&&u.getId();if(w&&!this.getParent().isOpen()){this.fireNavigate({key:v.key,description:v.description,inParameters:v.inParameters,outParameters:v.outParameters,itemId:R});return;}this._bNoTableUpdate=true;this.setSelectedItems([{key:v.key,description:v.description,inParameters:v.inParameters,outParameters:v.outParameters}]);this._bNoTableUpdate=false;if(!R&&u.isA("sap.ui.model.Context")){var y=this._getTableItems(false,true).find(function(z){return z.getBindingContext()===u;});R=y&&y.getId();}if(R){this.fireNavigate({key:v.key,description:v.description,inParameters:v.inParameters,outParameters:v.outParameters,itemId:R});}else{this.fireNavigate({disableFocus:true});}}.bind(this));}};h.prototype.getTextForKey=function(K,i,o,N){return _.call(this,K,"key",i,o,N);};h.prototype.getKeyForText=function(t,i,N){return _.call(this,t,"description",i,undefined,N);};function _(v,s,i,o,N){if(v===null||v===undefined||(s==="description"&&v==="")){return null;}var E=s==="description"?P:b;var j=s==="description"?this._getDescriptionPath:this._getKeyPath;var t=this._getWrappedTable();if(this._isTableReady(t)&&this._getKeyPath()){var I=this._getTableItems();var r=k.call(this,v,I,j.call(this),i,o,E);if(r){return r;}}if(N){throw new E(this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[v]));}else{return this.loadData(j,v,i,o,E);}}function k(v,i,p,I,o,E){if(!p){throw new Error("path for filter missing");}var j=new a({path:p,operator:d.EQ,value1:v});var q=function(t,p){var B=t.isA("sap.ui.model.Context")?t:t.getBindingContext();var D=B.getObject();if(D.hasOwnProperty(p)){return D[p];}else{return undefined;}};if(I||o){var r=[j];if(I){r.push(I);}if(o){r.push(o);}j=new a({filters:r,and:true});}var s=e.apply(i,j,q);if(s.length===1){var V=this._getDataFromItem(s[0]);return{key:V.key,description:V.description,inParameters:V.inParameters,outParameters:V.outParameters};}else if(s.length>1){throw m.call(this,E,true,v);}}h.prototype.loadData=function(o,v,I,O,E){var s=o.call(this);if(this._oPromises[s]&&this._oPromises[s][v]){return this._oPromises[s][v];}if(!this._oPromises[s]){this._oPromises[s]={};}this._oPromises[s][v]=new Promise(function(r,R){this._oTablePromise.then(function(t){var p=s;s=o.call(this);if(!s){R(new Error("missing FieldPath"));return;}if(s!==p){if(!this._oPromises[s]){this._oPromises[s]={};}this._oPromises[s][v]=this._oPromises[p][v];delete this._oPromises[p][v];}var q=this.getListBinding();var u=q.getModel();var w=q.getPath();var x=new a(s,"EQ",v);var B=q.getContext();var y=[];if(I){y.push(I);}if(O){if(I){var z=O.aFilters?O.aFilters:[O];var A=I.aFilters?I.aFilters:[I];for(var i=0;i<z.length;i++){var D=z[i];var G=false;for(var j=0;j<A.length;j++){var H=A[j];if(H.sPath===D.sPath&&H.oValue1===D.oValue1&&H.oValue2===D.oValue2){G=true;break;}}if(!G){y.push(D);}}}else{y.push(O);}}if(y.length>0){y.push(x);x=new a({filters:y,and:true});}try{var J=u.bindList(w,B);var K=function(){var T=J.getContexts();if(T.length===1){var V=this._getDataFromContext(T[0]);var U={key:V.key,description:V.description,inParameters:V.inParameters,outParameters:V.outParameters};r(U);}else if(v===""&&T.length===0){r(null);}else{var W=m.call(this,E,T.length>1,v);R(W);}setTimeout(function(){J.destroy();},0);delete this._oPromises[s][v];};var N=this._getDelegate();if(N.delegate){N.delegate.executeFilter(N.payload,J,x,K.bind(this),2);}}catch(Q){R(Q);}}.bind(this));}.bind(this));return this._oPromises[s][v];};function m(E,N,v){var s;if(N){s=this._oResourceBundle.getText("valuehelp.VALUE_NOT_UNIQUE",[v]);}else{s=this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[v]);}var o=new E(s);o._bNotUnique=N;return o;}h.prototype.getAsyncKeyText=function(){return true;};h.prototype.applyFilters=function(i,s,o){var j=this.getListBinding();var D=this._getDelegate();if(!j){this._oTablePromise.then(function(t){if(!this._bIsBeingDestroyed){this.applyFilters(i,s);}}.bind(this));this.restoreBinding();return;}var u=true;var p;try{p=j.getFilterInfo();}catch(q){L.info("ValueHelp-Filter: getFilterInfo threw error");}if(!i){i=[];}if(i.length===0&&!p){u=false;}if(D.delegate&&D.delegate.isSearchSupported(D.payload,j)){if(!j.isSuspended()&&u){j.suspend();}D.delegate.executeSearch(D.payload,j,s);L.info("ValueHelp-Search: "+s);}if(u){j.filter(i,c.Application);L.info("ValueHelp-Filter: "+n.call(this,i));}if(j.isSuspended()){j.resume();}this.fireDataUpdate({contentChange:false});};h.prototype.isSuspended=function(){var o=this.getListBinding();if(!o){return true;}return o.isSuspended();};function n(o){var r;if(!o){return"";}if(Array.isArray(o)){r="";o.forEach(function(o,i,j){r+=n.call(this,o);if(j.length-1!=i){r+=" or ";}},this);return"("+r+")";}else if(o._bMultiFilter){r="";var A=o.bAnd;o.aFilters.forEach(function(o,i,j){r+=n.call(this,o);if(j.length-1!=i){r+=A?" and ":" or ";}},this);return"("+r+")";}else{r=o.sPath+" "+o.sOperator+" '"+o.oValue1+"'";if(o.sOperator==="BT"){r+="...'"+o.oValue2+"'";}return r;}}h.prototype.clone=function(i,j){this._handleEvents();var o=F.prototype.clone.apply(this,arguments);this._handleEvents(true);return o;};h.prototype._observeChanges=function(o){if(o.name==="table"){this._handleTableChanged.call(this,o.mutation,o.child);}if(o.name==="selectedItems"){this._updateSelectedItems.call(this);}};h.prototype._handleTableChanged=function(s,t){if(s==="remove"){this._handleEvents();t.removeDelegate(this._oTableDelegate);t=undefined;this._oTablePromise=new Promise(function(r){this._oTablePromiseResolve=function(){r();this._bTableResolved=true;};}.bind(this));}else{this._handleEvents(true);t.addDelegate(this._oTableDelegate,true,this);this._updateSelectedItems();if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);}}this.fireDataUpdate({contentChange:true});};h.prototype._handleModelContextChange=function(E){var t=this._getWrappedTable();if(this.getListBinding()){this._oTablePromiseResolve(t);}};h.prototype._adjustTable=function(s){var t=this.getTable();if(t&&this.getParent()){if(s){if(this._sTableWidth){t.setWidth(this._sTableWidth);}}else if(t.getWidth()!=="100%"){this._sTableWidth=t.getWidth();t.setWidth("100%");}}};h.prototype._fireSelectionChange=function(I){var o=[];var t=this._getWrappedTable();if(t){var s=this.getSelectedItems();var T=this._getTableItems();var i=0;var p;var v;if(s.length>0){for(i=0;i<T.length;i++){p=T[i];v=this._getDataFromItem(p);if(!v){throw new Error("Key of item cannot be determined"+this);}for(var j=s.length-1;j>=0;j--){var q=s[j];if(q.key===v.key&&(!v.inParameters||!q.inParameters||g(q.inParameters,v.inParameters))&&(!v.outParameters||!q.outParameters||g(q.outParameters,v.outParameters))){s.splice(j,1);break;}}}}if(s.length>0){o=s;}s=this._getTableItems(true);for(i=0;i<s.length;i++){p=s[i];v=this._getDataFromItem(p);if(!v){throw new Error("Key of item cannot be determined"+this);}o.push({key:v.key,description:v.description,inParameters:v.inParameters,outParameters:v.outParameters});}}this._bNoTableUpdate=true;this.setSelectedItems(o);this._bNoTableUpdate=false;this.fireSelectionChange({selectedItems:o,itemPress:I});};h.prototype._handleUpdateFinished=function(E){if(!this.getParent()){return;}this._updateSelectedItems.call(this);if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);}if(E.getParameter("reason")!==f(C.Filter)){this.fireDataUpdate({contentChange:false});}};h.prototype._updateSelectedItems=function(){if(this._bNoTableUpdate){return;}var t=[];var T=this._getWrappedTable();if(this._isTableReady(T)&&this._getKeyPath()){var s=this.getSelectedItems();var o=this._getTableItems();var u=false;this._bIsModifyingTableSelection=true;for(var j=0;j<o.length;j++){var p=o[j];if(p){var q=false;if(s.length>0){var v=this._getDataFromItem(p);for(var i=0;i<s.length;i++){var r=s[i];if(v.key===r.key&&(!v.inParameters||!r.inParameters||g(r.inParameters,v.inParameters))&&(!v.outParameters||!r.outParameters||g(r.outParameters,v.outParameters))){q=true;if(v.description!==r.description){r.description=v.description;u=true;}break;}}}t.push(this._modifyTableSelection(o,p,q,j));}}if(u){this._bNoTableUpdate=true;this.setSelectedItems(s);this._bNoTableUpdate=false;}this._oTableModificationPromise=Promise.all(t).then(function(){this._bIsModifyingTableSelection=false;}.bind(this));}};h.prototype._getDataFromItem=function(i,I,o){var B=i.isA("sap.ui.model.Context")?i:i.getBindingContext();return B&&this._getDataFromContext.call(this,B,I,o);};h.prototype._getDataFromContext=function(B,I,o){var K=this._getKeyPath();var D=this._getDescriptionPath();var j=B.getObject();var v;var s;if(!K){throw new Error("KeyPath missing");}if(!I){I=this._getInParameters();}if(!o){o=this._getOutParameters();}var p=I.length>0?{}:null;var O=o.length>0?{}:null;var q;if(j){if(j.hasOwnProperty(K)){v=j[K];}if(D&&j.hasOwnProperty(D)){s=j[D];}var i=0;for(i=0;i<I.length;i++){q=I[i];if(j.hasOwnProperty(q)){p[q]=j[q];}}for(i=0;i<o.length;i++){q=o[i];if(j.hasOwnProperty(q)){O[q]=j[q];}else{}}}if(v===null||v===undefined){return false;}return{key:v,description:s,inParameters:p,outParameters:O};};h.prototype._isTableReady=function(){var t=this._getWrappedTable();var o=t&&this.getListBinding();if(!t||!o){return false;}if(o&&(o.isSuspended()||o.getLength()===0)){return false;}return true;};h.prototype._handleItemPress=function(E){};h.prototype._handleSelectionChange=function(E,i){};h.prototype._getTableItems=function(s,N){return[];};h.prototype._getTableItemByKey=function(K,N){var i=this._getTableItems(undefined,N);return i&&i.find(function(I){var D=this._getDataFromItem(I);return D.key===K;}.bind(this));};h.prototype._handleTableEvent=function(E){};h.prototype._modifyTableSelection=function(i,I,s,j,o){};h.prototype._getWrappedTable=function(){return this.getTable();};h.prototype._handleEvents=function(A){};h.prototype._handleScrolling=function(i){};h.prototype.getListBinding=function(){};h.prototype.restoreBinding=function(){};return h;});
