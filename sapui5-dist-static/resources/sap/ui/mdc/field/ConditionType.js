/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/model/SimpleType','sap/ui/model/FormatException','sap/ui/model/ParseException','sap/ui/model/ValidateException','sap/ui/model/type/String','sap/ui/mdc/enum/FieldDisplay','sap/ui/mdc/condition/FilterOperatorUtil','sap/ui/mdc/condition/Operator','sap/ui/mdc/condition/Condition','sap/ui/mdc/enum/BaseType','sap/ui/mdc/enum/ConditionValidated','sap/base/util/merge','sap/ui/base/SyncPromise'],function(S,F,P,V,a,b,c,O,C,B,d,m,e){"use strict";var f=S.extend("sap.ui.mdc.field.ConditionType",{constructor:function(i,E){S.apply(this,arguments);this.sName="Condition";this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");}});f.prototype.destroy=function(){S.prototype.destroy.apply(this,arguments);if(this._oDefaultType){this._oDefaultType.destroy();delete this._oDefaultType;}this._bDestroyed=true;};f.prototype.formatValue=function(i,I){if(i==undefined||i==null||this._bDestroyed){return null;}if(typeof i!=="object"||!i.operator||!i.values||!Array.isArray(i.values)){throw new F("No valid condition provided");}if(!I){I="string";}var T=n.call(this);var E=o.call(this);var G=this.oFormatOptions.isUnit;var H=this.oFormatOptions.preventGetDescription;s.call(this,i,E);if(G){i=m({},i);if(i.values[0]&&Array.isArray(i.values[0])){i.values[0]=i.values[0][1];}if(i.operator!=="EQ"){i.operator="EQ";if(i.values[1]){i.values.splice(1,1);}}}s.call(this,i,T);switch(this.getPrimitiveType(I)){case"string":case"any":var J=l.call(this);var K=p.call(this);var L=c.getEQOperator(K);if(!H&&i.operator===L.name&&J!==b.Value&&i.validated===d.Validated&&!i.values[1]){var M=this.oFormatOptions.bindingContext;var N=this.oFormatOptions.conditionModel;var Q=this.oFormatOptions.conditionModelName;return e.resolve().then(function(){return A.call(this,i.values[0],i.inParameters,i.outParameters,M,N,Q);}.bind(this)).then(function(R){if(R){i=m({},i);if(typeof R==="object"){i=u.call(this,i,R);}else if(i.values.length===1){i.values.push(R);}else{i.values[1]=R;}}return _.call(this,i);}.bind(this)).catch(function(R){if(R instanceof F&&y.call(this)){return _.call(this,i);}else{throw R;}}.bind(this)).unwrap();}return _.call(this,i);default:if(T&&i.values.length>=1){return T.formatValue(i.values[0],I);}throw new F("Don't know how to format Condition to "+I);}};function _(i){var E=l.call(this);var T=n.call(this);if(this.oFormatOptions.hideOperator&&i.values.length===1){return T.formatValue(i.values[0],"string");}var G=c.getOperator(i.operator);if(!G){throw new F("No valid condition provided, Operator wrong.");}return G.format(i,T,E);}f.prototype.parseValue=function(i,I){if(this._bDestroyed){return null;}if(!I){I="string";}else if(I==="any"&&typeof i==="string"){I="string";}var N=this.oFormatOptions.navigateCondition;if(N){var E=this.formatValue(N,I);if(E===i){return m({},N);}}var G=l.call(this);var H=x.call(this);var T=n.call(this);var J=o.call(this);var K=p.call(this);var L=this.oFormatOptions.isUnit;var M;if(i===null||i===undefined||(i===""&&!H)){if(!r.call(this,T)&&!L){return null;}}t.call(this,T);t.call(this,J);switch(this.getPrimitiveType(I)){case"string":var Q;var R=false;var U=false;if(K.length===1){Q=c.getOperator(K[0]);U=true;}else{var W=c.getMatchingOperators(K,i);if(W.length===0){Q=D.call(this,K,T);if(H&&!r.call(this,T)){var X=c.getEQOperator(K);if(K.indexOf(X.name)>=0){R=!!Q&&Q.name!==X.name;Q=X;}}U=true;}else{Q=W[0];}}if(Q){var Y;var Z=r.call(this,T);if(!Z&&Q.validateInput&&H){Y=h.call(this,Q,i,T,U,R,K,G,true);if(Y instanceof Promise){return v.call(this,Y);}else{return Y;}}else if(i===""&&!Z){return g.call(this,null,T);}else{try{if(i===""&&Z&&U){Y=C.createCondition(Q.name,[T.parseValue(i,"string",T._aCurrentValue)],undefined,undefined,d.NotValidated);}else{Y=Q.getCondition(i,T,G,U);}}catch($){if($ instanceof P&&J){J.parseValue(i,"string",J._aCurrentValue);}throw $;}}if(Y){return g.call(this,Y,T);}}throw new P("Cannot parse value "+i);default:if(T){if(K.length===1){M=K[0];}else{M=D.call(this,K,T).name;if(K.indexOf(M)<0){M=undefined;}}if(M){return C.createCondition(M,[T.parseValue(i,I)],undefined,undefined,d.NotValidated);}}throw new P("Don't know how to parse Condition from "+I);}};function g(i,T){var I=this.oFormatOptions.isUnit;var E=o.call(this);var U=null;if(I){var M;if(E._aCurrentValue){M=E._aCurrentValue[0];}if(i){if(i.operator!=="EQ"){throw new P("unsupported operator");}U=i.values[0];i.values=[[M,U]];}else{i=C.createCondition("EQ",[[M,null]],undefined,undefined,d.NotValidated);}s.call(this,i,E);}else if(i){var N=T.getMetadata().getName();var G=this.oFormatOptions.delegate;var H=this.oFormatOptions.payload;if(G&&G.getTypeUtil(H).getBaseType(N)===B.Unit&&!i.values[0][1]&&T._aCurrentValue){U=T._aCurrentValue[1]?T._aCurrentValue[1]:null;i.values[0][1]=U;if(i.operator==="BT"){i.values[1][1]=U;}}s.call(this,i,T);s.call(this,i,E);}return i;}function h(i,E,T,U,G,H,I,J){var K;var L;var M=true;var N=true;var Q=false;var R;var W;var X=this.oFormatOptions.bindingContext;var Y=this.oFormatOptions.conditionModel;var Z=this.oFormatOptions.conditionModelName;var $;if(E===""){$=[];K=E;R=E;}else{$=i.getValues(E,I,U);K=J?$[0]:$[1];L=J?$[1]:$[0];Q=I!==b.Value;N=I===b.Value||I===b.ValueDescription;R=N?K||L:L||K;}var a1=function(c1){if(c1&&!(c1 instanceof P)&&!(c1 instanceof F)){throw c1;}if(!c1._bNotUnique){if(E===""){return null;}if(J&&$[0]&&$[1]){return h.call(this,i,E,T,U,G,H,I,false);}if(G){return j.call(this,T,H,E,I);}}if(y.call(this)){return k.call(this,T,H,E,I);}throw new P(c1.message);};var b1=function(d1){if(d1){var $=[d1.key];if(i.valueTypes.length>1&&i.valueTypes[1]!==O.ValueType.Static){$.push(d1.description);}return C.createCondition(i.name,$,d1.inParameters,d1.outParameters,d.Validated);}else if(E===""){return null;}else{return a1.call(this,new P(this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[E])));}};try{W=T.parseValue(R,"string");T.validateValue(W);}catch(c1){if(c1&&!(c1 instanceof P)&&!(c1 instanceof V)){throw c1;}M=false;N=false;W=undefined;}return e.resolve().then(function(){return z.call(this,R,W,X,N,M,Q,Y,Z);}.bind(this)).then(function(d1){var e1=b1.call(this,d1);return g.call(this,e1,T);}.bind(this)).catch(function(c1){var d1=a1.call(this,c1);return g.call(this,d1,T);}.bind(this)).unwrap();}function j(T,i,E,G){var H=D.call(this,i,T);var I;if(H&&i.indexOf(H.name)>=0){I=H.getCondition(E,T,b.Value,true);I.validated=d.NotValidated;}return I;}function k(T,i,E,G){var H;if(i.length===1){H=c.getOperator(i[0]);}else{H=c.getEQOperator(i);if(i.indexOf(H.name)<0){H=undefined;}}if(!H){throw new P("Cannot parse value "+E);}var I=H.getCondition(E,T,b.Value,true);if(I){I.validated=d.NotValidated;}return I;}f.prototype.validateValue=function(i){var T=n.call(this);var E=o.call(this);var G=p.call(this);var I=this.oFormatOptions.isUnit;if(i===undefined||this._bDestroyed){return null;}else if(i===null){if(c.onlyEQ(G)){try{if(T.hasOwnProperty("_sParsedEmptyString")&&T._sParsedEmptyString!==null){T.validateValue(T._sParsedEmptyString);}else{T.validateValue(null);}}catch(H){if(H instanceof V){throw H;}else{return null;}}}return null;}if(typeof i!=="object"||!i.operator||!i.values||!Array.isArray(i.values)){throw new V(this._oResourceBundle.getText("field.VALUE_NOT_VALID"));}var J=c.getOperator(i.operator,G);if(I){i=m({},i);if(i.values[0]&&Array.isArray(i.values[0])){i.values[0]=i.values[0][1];}J=c.getEQOperator();}if(!J){throw new V("No valid condition provided, Operator wrong.");}try{J.validate(i.values,T);}catch(K){if(K instanceof V&&E){J.validate(i.values,E);}throw K;}};function l(){var i=this.oFormatOptions.display;if(!i){i=b.Value;}return i;}function n(){var T=this.oFormatOptions.valueType;if(!T){if(!this._oDefaultType){this._oDefaultType=new a();}T=this._oDefaultType;}return T;}function o(){return this.oFormatOptions.originalDateType;}function p(){var i=this.oFormatOptions.operators;if(!i||i.length===0){i=c.getOperatorsForType(B.String);}return i;}function q(){var i=this.oFormatOptions.fieldHelpID;if(i){var E=sap.ui.getCore().byId(i);if(E&&E.isUsableForValidation()){return E;}}return null;}function r(T){return T&&T.isA("sap.ui.model.CompositeType");}function s(i,T){if(r.call(this,T)&&i&&i.values[0]){T._aCurrentValue=i.values[0];}}function t(T){if(r.call(this,T)&&!T._aCurrentValue){T._aCurrentValue=[];}}function u(i,R){i.values=[R.key,R.description];if(R.inParameters){i.inParameters=R.inParameters;}if(R.outParameters){i.outParameters=R.outParameters;}return i;}function v(i){if(this.oFormatOptions.asyncParsing){this.oFormatOptions.asyncParsing(i);}return i;}function w(T){var i=T.getMetadata().getName();var E=T.getFormatOptions();var G=T.getConstraints();var H=this.oFormatOptions.delegate;var I=this.oFormatOptions.payload;var J=H?H.getTypeUtil(I).getBaseType(i,E,G):B.String;if(J===B.Unit){J=B.Numeric;}return J;}function x(){var i=q.call(this);var E=this.oFormatOptions.delegate;var G=this.oFormatOptions.payload;if(E){return E.isInputValidationEnabled(G,i);}else{return!!i;}}function y(){var i=q.call(this);var E=this.oFormatOptions.delegate;var G=this.oFormatOptions.payload;if(E){return E.isInvalidInputAllowed(G,i);}else if(i){return!i.getValidateInput();}else{return true;}}function z(i,E,G,H,I,J,K,L){var M=q.call(this);var N=this.oFormatOptions.delegate;var Q=this.oFormatOptions.payload;if(N){return N.getItemForValue(Q,M,i,E,G,H,I,J,K,L);}else if(M){return M.getItemForValue(i,E,undefined,undefined,G,H,I,J,K,L);}}function A(K,i,E,G,H,I){var J=q.call(this);var L=this.oFormatOptions.delegate;var M=this.oFormatOptions.payload;if(L){return L.getDescription(M,J,K,i,E,G,H,I);}else if(J){return J.getTextForKey(K,i,E,G,H,I);}}function D(E,T){var G=this.oFormatOptions.defaultOperatorName;var H;if(G){H=c.getOperator(G);}else{H=c.getDefaultOperator(w.call(this,T));}if(H&&E.indexOf(H.name)<0){for(var i=0;i<E.length;i++){H=c.getOperator(E[i]);if(H.exclude){H=undefined;}else{break;}}}return H;}return f;});
