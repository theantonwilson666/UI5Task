/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/mdc/Element','sap/ui/mdc/condition/FilterOperatorUtil','sap/ui/mdc/condition/Operator','sap/ui/mdc/condition/Condition','sap/ui/mdc/enum/ConditionValidated','sap/base/Log','sap/base/util/merge','sap/ui/base/SyncPromise','sap/ui/model/FormatException','sap/ui/model/ParseException'],function(E,F,O,C,a,L,m,S,b,P){"use strict";var c;var l;var d=E.extend("sap.ui.mdc.field.FieldHelpBase",{metadata:{interfaces:["sap.ui.core.PopupInterface"],library:"sap.ui.mdc",properties:{conditions:{type:"object[]",defaultValue:[],byValue:true},delegate:{type:"object",group:"Data",defaultValue:{name:"sap/ui/mdc/field/FieldHelpBaseDelegate"}},filterValue:{type:"string",defaultValue:""},validateInput:{type:"boolean",defaultValue:true}},aggregations:{_popover:{type:"sap.m.Popover",multiple:false,visibility:"hidden"}},events:{select:{parameters:{conditions:{type:"object[]"},add:{type:"boolean"},close:{type:"boolean"}}},navigate:{parameters:{value:{type:"any"},key:{type:"any"},condition:{type:"object"},itemId:{type:"string"}}},dataUpdate:{},disconnect:{},open:{suggestion:{type:"boolean"}},afterClose:{}},defaultProperty:"filterValue"}});d._init=function(){c=undefined;l=undefined;};d.prototype.init=function(){E.prototype.init.apply(this,arguments);this._oTextOrKeyPromises={};};d.prototype.invalidate=function(o){if(o){var p=this.getAggregation("_popover");if(p&&o===p){if(o.bOutput&&!this._bIsBeingDestroyed){var q=this.getParent();if(q){q.invalidate(this);}}return;}}};d.prototype.setFilterValue=function(s){this.setProperty("filterValue",s,true);return this;};d.prototype.connect=function(o){if(this._oField&&this._oField!==o){var p=this.getAggregation("_popover");if(p){p._oPreviousFocus=null;}this.close();this.setFilterValue("");this.setConditions([]);this.fireDisconnect();}this._oField=o;n.call(this,o);return this;};d.prototype._getField=function(){if(this._oField){return this._oField;}else{return this.getParent();}};d.prototype._getOperator=function(){if(!this._oOperator){this._oOperator=F.getEQOperator();}return this._oOperator;};d.prototype._createCondition=function(K,D,I,o){var p=this._getOperator();var v=[K];if(p.valueTypes.length>1&&p.valueTypes[1]!==O.ValueType.Static&&D!==null&&D!==undefined){v.push(D);}return C.createCondition(p.name,v,I,o,a.Validated);};d.prototype._getControlForSuggestion=function(){var o=this._getField();if(o.getControlForSuggestion){return o.getControlForSuggestion();}else{return o;}};d.prototype.getFieldPath=function(){var s="";if(this._oField&&this._oField.getFieldPath){s=this._oField.getFieldPath();}return s||"Help";};d.prototype.getDomRef=function(){var p=this.getAggregation("_popover");if(p){return p.getDomRef();}else{return E.prototype.getDomRef.apply(this,arguments);}};d.prototype.getContentId=function(){var p=this.getAggregation("_popover");if(p){var o=p._getAllContent();if(o.length===1){return o[0].getId();}}};d.prototype.getRoleDescription=function(M){return null;};d.prototype.getValueHelpEnabled=function(){return true;};d.prototype.open=function(s){var o=this._getField();if(o){var p=this._getPopover();if(p&&!this._bOpenAfterPromise){delete this._bOpen;delete this._bSuggestion;if(!p.isOpen()){if(!this.isFocusInHelp()){p.setInitialFocus(this._getControlForSuggestion());}p.setFieldGroupIds(o.getFieldGroupIds());var q=function(){if(this._bOpenAfterPromise){delete this._bOpenAfterPromise;this.open(s);}}.bind(this);var r=this._fireOpen(!!s,q);if(r){if(p._getAllContent().length>0){p.openBy(this._getControlForSuggestion());}else{this._bOpenIfContent=true;}}else{this._bOpenAfterPromise=true;}}}else{this._bOpen=true;this._bSuggestion=s;}}else{L.warning("FieldHelp not assigned to field -> can not be opened.",this);}};d.prototype.close=function(){var p=this.getAggregation("_popover");if(p&&p.isOpen()){var o=p.oPopup.getOpenState();if(o!=="CLOSED"&&o!=="CLOSING"){this._bClosing=true;p.close();}}else{delete this._bOpen;delete this._bSuggestion;delete this._bOpenIfContent;delete this._bOpenAfterPromise;}this._bReopen=false;};d.prototype.toggleOpen=function(s){var p=this.getAggregation("_popover");if(p){if(p.isOpen()){var o=p.oPopup.getOpenState();if(o!=="CLOSED"&&o!=="CLOSING"){this.close();}else{this._bReopen=true;}}else{this.open(s);}}else if(this._bOpen||this._bOpenIfContent||this._bOpenAfterPromise){delete this._bOpen;delete this._bSuggestion;delete this._bOpenIfContent;delete this._bOpenAfterPromise;}else{this.open(s);}};d.prototype.isOpen=function(o){if(o&&this._bClosing){return false;}var I=false;var p=this.getAggregation("_popover");if(p){I=p.isOpen();}return I;};d.prototype.skipOpening=function(){if(this._bOpenIfContent){delete this._bOpenIfContent;}if(this._bOpenAfterPromise){delete this._bOpenAfterPromise;}};d.prototype.initBeforeOpen=function(s){if(this._bOpenAfterPromise){return;}var B=function(){this._bBeforeOpenPending=false;if(this._bOpenAfterPromise){delete this._bOpenAfterPromise;this.open(s);}}.bind(this);var o=this._callContentRequest(s,B);if(!o){this._bBeforeOpenPending=true;}};d.prototype._createPopover=function(){var p;if((!c||!l)&&!this._bPopoverRequested){c=sap.ui.require("sap/m/Popover");l=sap.ui.require("sap/m/library");if(!c||!l){sap.ui.require(["sap/m/Popover","sap/m/library"],_.bind(this));this._bPopoverRequested=true;}}if(c&&l&&!this._bPopoverRequested){p=new c(this.getId()+"-pop",{contentHeight:"auto",placement:l.PlacementType.VerticalPreferredBottom,showHeader:false,showArrow:false,afterOpen:this._handleAfterOpen.bind(this),afterClose:this._handleAfterClose.bind(this)});p.isPopupAdaptationAllowed=function(){return false;};this.setAggregation("_popover",p,true);if(this._oContent){this._setContent(this._oContent);}}return p;};function _(p,o){c=p;l=o;this._bPopoverRequested=false;if(!this._bIsBeingDestroyed){this._createPopover();if(this._bOpen){this.open(this._bSuggestion);}}}d.prototype._getPopover=function(){var p=this.getAggregation("_popover");if(!p){p=this._createPopover();}return p;};d.prototype._handleAfterOpen=function(o){};d.prototype._handleAfterClose=function(o){this._bClosing=false;if(this._bReopen){this._bReopen=false;this.open();}this.fireAfterClose();};d.prototype.openByTyping=function(){return false;};d.prototype.openByClick=function(){return false;};d.prototype.isFocusInHelp=function(){return!this.openByTyping();};d.prototype.navigate=function(s){};d.prototype.getTextForKey=function(K,I,o,B,p,s){return e.call(this,K,B,I,o,false,p,s);};function e(K,B,I,o,N,p,s){return i.call(this,true,K,B,I,o,N,p,s);}d.prototype.getKeyForText=function(t,B,o,s){return f.call(this,t,B,false,o,s);};function f(t,B,N,o,s){return i.call(this,false,t,B,undefined,undefined,N,o,s);}d.prototype._getTextOrKey=function(v,K,B,I,o,N,p,s){if(K){return"";}else{return undefined;}};d.prototype._isTextOrKeyRequestSupported=function(){return false;};d.prototype.isValidationSupported=function(){return true;};d.prototype.getItemForValue=function(v,p,I,o,B,q,r,s,t,u){return S.resolve().then(function(){return g.call(this,v,p,I,o,B,q&&r,r,s,t,u,true,true);}.bind(this)).then(function(R){if(!R&&this._isTextOrKeyRequestSupported()){return g.call(this,v,p,I,o,B,q&&r,r,s,t,u,true,false);}else{return R;}}.bind(this)).catch(function(w){h.call(this,w,!this._isTextOrKeyRequestSupported());if(this._isTextOrKeyRequestSupported()){var R=g.call(this,v,p,I,o,B,q&&r,r,s,t,u,true,false);if(!R){throw w;}return R;}}.bind(this)).unwrap();};function g(v,p,I,o,B,q,r,s,t,u,w,N){return S.resolve().then(function(){if(q){if(r){return e.call(this,p,B,I,o,N,t,u);}}else if(s){return f.call(this,v,B,N,t,u);}}.bind(this)).then(function(R){if(R){if(typeof R==="object"){return R;}else if(q){return{key:p,description:R};}else{return{key:R,description:v};}}else if(w&&((q&&s)||(!q&&r))){return g.call(this,v,p,I,o,B,!q,r,s,t,u,false,N);}else{return undefined;}}.bind(this)).catch(function(x){h.call(this,x,x&&x._bSecondCheck);if(w&&((q&&s)||(!q&&r))){var R=g.call(this,v,p,I,o,B,!q,r,s,t,u,false,N);if(!R){throw x;}return R;}else{x._bSecondCheck=true;throw x;}}.bind(this)).unwrap();}function h(o,t){if(o){if(t){throw o;}if(!(o instanceof P)&&!(o instanceof b)){throw o;}if(o._bNotUnique){throw o;}}}d.prototype.isUsableForValidation=function(){return true;};d.prototype.onFieldChange=function(){};d.prototype._setContent=function(o){var p=this.getAggregation("_popover");if(p){p.removeAllContent();p.addContent(o);this._oContent=undefined;if(this._bOpenIfContent){var q=this._getField();if(q){p.openBy(this._getControlForSuggestion());}this._bOpenIfContent=false;}}else{this._oContent=o;}return this;};d.prototype.getIcon=function(){return"sap-icon://slim-arrow-down";};d.prototype.getUIArea=function(){var u=E.prototype.getUIArea.apply(this,arguments);if(!u){if(this._oField){u=this._oField.getUIArea();}}return u;};d.prototype.getScrollDelegate=function(){var p=this.getAggregation("_popover");if(p){return p.getScrollDelegate();}else{return undefined;}};d.prototype._fireOpen=function(s,o){if(this._bBeforeOpenPending){return false;}var p=this._callContentRequest(s,o);if(p){this.fireOpen({suggestion:s});}return p;};d.prototype._callContentRequest=function(s,o){if(!this._bNoContentRequest){if(this._oContentRequestPromise){this._oContentRequestPromise.then(function(){this._bNoContentRequest=true;o();this._bNoContentRequest=false;}.bind(this));return false;}if(!this.bDelegateInitialized&&!this.bDelegateLoading){this.initControlDelegate();}if(this.bDelegateInitialized){var p=this._getContenRequestProperties(s);var q=this.getControlDelegate().contentRequest(this.getPayload(),this,s,p);if(q instanceof Promise){this._oContentRequestPromise=q;q.then(function(){this._oContentRequestPromise=undefined;this._bNoContentRequest=true;o();this._bNoContentRequest=false;}.bind(this));return false;}}else{this.awaitControlDelegate().then(function(){if(this._callContentRequest(s,o)){o();}}.bind(this));return false;}}return true;};d.prototype._getContenRequestProperties=function(s){};function i(K,v,B,I,o,N,p,s){var q=JSON.stringify(I);var r=B&&B.getPath();if(this._oTextOrKeyPromises[K]&&this._oTextOrKeyPromises[K][v]&&this._oTextOrKeyPromises[K][v][q]&&this._oTextOrKeyPromises[K][v][q][r]){return this._oTextOrKeyPromises[K][v][q][r].promise;}var t=function(){j.call(this);}.bind(this);var u=this._callContentRequest(true,t);if(!u){if(!this._oTextOrKeyPromises[K]){this._oTextOrKeyPromises[K]={};}if(!this._oTextOrKeyPromises[K][v]){this._oTextOrKeyPromises[K][v]={};}if(!this._oTextOrKeyPromises[K][v][q]){this._oTextOrKeyPromises[K][v][q]={};}if(!this._oTextOrKeyPromises[K][v][q][r]){this._oTextOrKeyPromises[K][v][q][r]={};}this._oTextOrKeyPromises[K][v][q][r].promise=new Promise(function(R,w){this._oTextOrKeyPromises[K][v][q][r].resolve=R;this._oTextOrKeyPromises[K][v][q][r].reject=w;this._oTextOrKeyPromises[K][v][q][r].key=K;this._oTextOrKeyPromises[K][v][q][r].value=v;this._oTextOrKeyPromises[K][v][q][r].inParameters=I?m({},I):undefined;this._oTextOrKeyPromises[K][v][q][r].outParameters=o?m({},o):undefined;this._oTextOrKeyPromises[K][v][q][r].bindingContext=B;this._oTextOrKeyPromises[K][v][q][r].noRequest=N;this._oTextOrKeyPromises[K][v][q][r].conditionModel=p;this._oTextOrKeyPromises[K][v][q][r].conditionModelName=s;}.bind(this));return this._oTextOrKeyPromises[K][v][q][r].promise;}return this._getTextOrKey(v,K,B,I,o,N,p,s);}function j(){for(var K in this._oTextOrKeyPromises){for(var v in this._oTextOrKeyPromises[K]){for(var I in this._oTextOrKeyPromises[K][v]){for(var s in this._oTextOrKeyPromises[K][v][I]){k.call(this,this._oTextOrKeyPromises[K][v][I][s]);delete this._oTextOrKeyPromises[K][v][I][s];}}}}}function k(t){var M=t.value;var o=t.key;var I=t.inParameters;var p=t.outParameters;var B=t.bindingContext;var N=t.noRequest;var r=t.resolve;var R=t.reject;var q=t.conditionModel;var s=t.conditionModelName;S.resolve().then(function(){return this._getTextOrKey(M,o,B,I,p,N,q,s);}.bind(this)).then(function(v){r(v);}).catch(function(u){R(u);}).unwrap();}function n(o){this._oOperator=undefined;if(o&&o._getOperators){this._oOperator=F.getEQOperator(o._getOperators());}}return d;});
