/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../../TableDelegate","../../util/loadModules","../../library","sap/m/ColumnPopoverSelectListItem","sap/ui/core/Item","sap/ui/core/Core","sap/ui/core/library","sap/m/MessageBox"],function(T,l,a,C,I,b,c,M){"use strict";var d=a.TableType;var e=new window.WeakMap();var D=Object.assign({},T);D.fetchPropertyHelper=function(t,p,E){return l("sap/ui/mdc/table/V4AnalyticsPropertyHelper").then(function(r){return r[0];});};D.fetchPropertyExtensions=function(t,p){return Promise.resolve(null);};D.fetchPropertiesForBinding=function(t){return this.fetchProperties(t);};D.fetchPropertyExtensionsForBinding=function(t,p){return this.fetchPropertyExtensions(t,p);};D.preInit=function(t){var g=this;if(t._getStringType()===d.ResponsiveTable){throw new Error("This delegate does not support the table type '"+T.ResponsiveTable+"'.");}t.setEnableExport(false);t.setEnableExport=function(){return this;};return f(t,g);};D.addColumnMenuItems=function(t,m){var p=t.getPropertyHelper();var g=p.getGroupableProperties(m.getDataProperty());var A=p.getAggregatableProperties(m.getDataProperty());var r=b.getLibraryResourceBundle("sap.ui.mdc");var P=t._oPopover;P&&P.getItems().forEach(function(i,h,j){if(i.getLabel()===r.getText("table.SETTINGS_GROUP")||i.getLabel()===r.getText("table.SETTINGS_AGGREGATE")){j[h].destroy();}if(j.length==0){P.destroy();}});var o,G;if(t.isGroupingEnabled()&&g&&g.length>0){G=this._onGroup(g,m);}if(t.isAggregationEnabled()&&A&&A.length>0){o=this._onAggregate(A,m);}return[G,o];};D._onGroup=function(g,m){var G,h=[];var r=b.getLibraryResourceBundle("sap.ui.mdc");g.forEach(function(i){G=new I({text:i.getLabel(),key:i.getName()});h.push(G);});if(h.length>0){var o=new C({items:h,label:r.getText("table.SETTINGS_GROUP"),icon:"sap-icon://group-2",action:[{sName:"Group",oMDCColumn:m},this._checkForPreviousAnalytics,this]});return o;}};D._onAggregate=function(A,m){var o,g=[];var r=b.getLibraryResourceBundle("sap.ui.mdc");A.forEach(function(i){o=new I({text:i.getLabel(),key:i.getName()});g.push(o);});if(g.length>0){var h=new C({items:g,label:r.getText("table.SETTINGS_AGGREGATE"),icon:"sap-icon://sum",action:[{sName:"Aggregate",oMDCColumn:m},this._checkForPreviousAnalytics,this]});return h;}};D._checkForPreviousAnalytics=function(E,o){var n=o.sName,t,m=o.oMDCColumn,g=m.getParent(),G=g.getCurrentState().groupLevels||[],A=g.getCurrentState().aggregations||{},h=Object.keys(A),F=false,p=E.getParameter("property");var i=n=="Aggregate"?G:h;var j=i.filter(function(k){return n=="Aggregate"?k.name===p:k===p;}).length>0;if(j){var r=b.getLibraryResourceBundle("sap.ui.mdc");t=n=="Aggregate"?r.getText("table.SETTINGS_AGGREGATE"):r.getText("table.SETTINGS_GROUP");F=true;M.warning(r.getText("table.SETTINGS_MESSAGE"),{title:r.getText("table.SETTINGS_WARNING_TITLE")+" "+t,actions:[M.Action.YES,M.Action.NO],onClose:function(k){if(k===sap.m.MessageBox.Action.YES){this._forceAnalytics(n,g,p);return;}}.bind(this)});}if(n==="Aggregate"&&!F){this._onAction(n,g,p);}else if(n==="Group"&&!F){this._onAction(n,g,p);}};D._onAction=function(A,t,p){if(A==="Group"){t._onCustomGroup(p);}else{t._onCustomAggregate(p);}};D._forceAnalytics=function(n,t,p){var s=this;if(n==="Aggregate"){t.getCurrentState().groupLevels.forEach(function(i,g,o){if(i.name==p){var G=t.getCurrentState().groupLevels||[];var A=t.getCurrentState().aggregations||{};var h=Object.keys(A);G.splice(g,1);s._setAggregation(t,G,h);}});t._onCustomAggregate(p);}else if(n==="Group"){var A=t.getCurrentState().aggregations||{};Object.keys(A).forEach(function(i,g,o){if(i==p){delete A[p];var h=Object.keys(A);var G=t.getCurrentState().groupLevels||[];s._setAggregation(t,G,h);}});t._onCustomGroup(p);}};D.rebindTable=function(t,B){var g,G,A,h;g=t._getGroupedProperties();A=t._getAggregatedProperties();G=g.map(function(i){return i.name;});h=Object.keys(A);this._setAggregation(t,G,h);T.rebindTable(t,B);};D._setAggregation=function(t,g,A){var m=e.get(t);var p=m["plugin"];if(p){var o={visible:this._getVisibleProperties(t,p),groupLevels:g,grandTotal:A,subtotals:A};p.setAggregationInfo(o);}};D._getVisibleProperties=function(t,p){var v=[];var P=p.getPropertyInfos();t.getColumns().forEach(function(i){var s=i.getDataProperty(),o=P.find(function(g){return g.name===s;});if(o){if(o.propertyInfos){o.propertyInfos.forEach(function(r){if(v.indexOf(r)<0){v.push(r);}});}else if(v.indexOf(s)<0){v.push(s);}}});return v;};D._onColumnChange=function(t){if(!e.get(t)){return;}var g=t.getCurrentState().groupLevels||[];var A=t.getCurrentState().aggregations||{};var h=Object.keys(A);this._setAggregation(t,g,h);};D.validateState=function(o,s){var p,P=[];s.items.forEach(function(i){p=o.getPropertyHelper().getProperty(i.name);if(!p.isComplex()){P.push(p.name);}else{p.getReferencedProperties().forEach(function(R){P.push(R.name);});}});var S=s.sorters.every(function(g){return P.find(function(h){return g.name===h;});});if(!S){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");return{validation:c.MessageType.Warning,message:r.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION")};}return{validation:c.MessageType.None};};function f(t,g){var p,E,P;return Promise.all([t.awaitPropertyHelper(),l("sap/ui/table/plugins/V4Aggregation")]).then(function(r){var V=r[1][0],i=t._oTable;P=new V();i.addDependent(P);e.set(t,{plugin:P});return g.fetchPropertiesForBinding(t);}).then(function(h){p=h;return g.fetchPropertyExtensionsForBinding(t,p);}).then(function(m){E=m;return g.fetchPropertyHelper(t,p,E);}).then(function(H){var h=new H(p,E,t);P.setPropertyInfos(h.getProperties());g._setAggregation(t,[],[]);h.destroy();});}return D;});
