/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../ChartDelegateNew","../../../util/loadModules","../../../library","sap/ui/core/Core","sap/m/text","../ODataMetaModelUtil","sap/ui/mdc/library","sap/base/util/merge",'sap/ui/mdc/odata/v4/TypeUtil',"sap/ui/mdc/odata/v4/ODataMetaModelUtil","sap/base/Log",'sap/ui/mdc/util/FilterUtil','sap/ui/mdc/odata/v4/util/DelegateUtil',"sap/ui/mdc/ChartNew/ChartTypeButtonNew","sap/ui/mdc/ChartNew/ItemNew","sap/ui/model/Sorter","sap/m/VBox"],function(V,l,c,C,T,M,d,m,f,O,L,F,D,g,h,S,j){"use strict";var k=Object.assign({},V);var n;var o;var p;var q;k.getFilterDelegate=function(){return{addItem:function(P,a){return Promise.resolve(null);}};};k.zoomIn=function(v){this._oInnerChart.zoom({direction:"in"});};k.zoomOut=function(v){this._oInnerChart.zoom({direction:"out"});};k.getZoomState=function(){if(this._oInnerChart){return this._oInnerChart.getZoomInfo(this);}};k.getInnerChartSelectionHandler=function(){return{eventId:"_selectionDetails",listener:this._oInnerChart};};k.setLegendVisible=function(v){if(this._oInnerChart){this._oInnerChart.setVizProperties({'legend':{'visible':v},'sizeLegend':{'visible':v}});}else{L.error("Could not set legend visibility since inner chart is not yet initialized!");}};k.getLegendState=function(){};k.getSortInfo=function(){};k.getSorterForItem=function(a,s){if(a.getType()==="aggregatable"){return new S(a.getAggregationMethod()+s.name,s.descending);}else if(a.getType()==="groupable"){return new S(s.name,s.descending);}};k.insertItemToInnerChart=function(a,i){if(a.getType()==="groupable"){this.createInnerDimension(a);var v=this._oInnerChart.getVisibleDimensions();v.splice(i,0,a.getName());this._oInnerChart.setVisibleDimensions(v);}else if(a.getType()==="aggregatable"){this.createInnerMeasure(a);var b=this._oInnerChart.getVisibleMeasures();b.splice(i,0,a.getAggregationMethod()+a.getName());this._oInnerChart.setVisibleMeasures(b);}};k.removeItemFromInnerChart=function(a){if(a.getType()==="groupable"&&this._oInnerChart.getVisibleDimensions().includes(a.getName())){var N=this._oInnerChart.getVisibleDimensions().filter(function(e){return e!==a.getName();});this._oInnerChart.setVisibleDimensions(N);this._oInnerChart.removeDimension(this._oInnerChart.getDimensionByName(a.getName()));}else if(a.getType()==="aggregatable"&&this._oInnerChart.getVisibleMeasures().includes(a.getAggregationMethod()+a.getName())){var b=this._oInnerChart.getVisibleMeasures().filter(function(e){return e!==a.getAggregationMethod()+a.getName();});this._oInnerChart.setVisibleMeasures(b);this._oInnerChart.removeMeasure(this._oInnerChart.getMeasureByName(a.getAggregationMethod()+a.getName()));}};k.addItem=function(P,a,b){if(a.getModel){return Promise.resolve(this._createMDCChartItem(P,a));}return Promise.resolve(null);};k.removeItem=function(P,a){return Promise.resolve(true);};k._createMDCChartItem=function(P,a){return this.fetchProperties(a).then(function(b){var e=b.find(function(i){return i.name===P;});if(!e){return null;}if(e.groupable){return new h(a.getId()+"--GroupableItem--"+e.name,{name:e.name,label:e.label,type:"groupable"});}if(e.aggregatable){return new h(a.getId()+"--AggregatableItem--"+e.name,{name:e.name,label:e.label,type:"aggregatable",aggregationMethod:e.recAggrMethod});}});};k.initializeInnerChart=function(a){this._oMDCChart=a;return new Promise(function(b,e){this._loadChart().then(function(i){this._oInnerStructure=new j();b(this._oInnerStructure);}.bind(this));}.bind(this));};k._createInitialContentFromItems=function(a){var v=[];var b=[];a.forEach(function(i){switch(i.getType()){case"groupable":v.push(i.getName());var e=new o({name:i.getName(),label:i.getLabel(),role:"category"});this._oInnerChart.addDimension(e);break;case"aggregatable":b.push(i.getAggregationMethod()+i.getName());var s=new p({name:i.getAggregationMethod()+i.getName(),label:i.getLabel(),role:"axis1",analyticalInfo:{propertyPath:i.getName(),"with":i.getAggregationMethod()}});this._oInnerChart.addMeasure(s);break;}}.bind(this));this._oInnerChart.setVisibleDimensions(v);this._oInnerChart.setVisibleMeasures(b);};k.getInnerChart=function(){return this._oInnerChart;};k.getChartTypeInfo=function(){if(!this._oInnerChart){throw'inner chart is not bound';}var t=this._oMDCChart.getChartType(),a=C.getLibraryResourceBundle("sap.ui.mdc");var i={icon:g.mMatchingIcon[t],text:a.getText("chart.CHART_TYPE_TOOLTIP",[t])};return i;};k.getAvailableChartTypes=function(){var a=[];if(this._oInnerChart){var A=this._oInnerChart.getAvailableChartTypes().available;if(a){var b=C.getLibraryResourceBundle("sap.chart.messages");for(var i=0;i<A.length;i++){var t=A[i].chart;a.push({key:t,icon:g.mMatchingIcon[t],text:b.getText("info/"+t),selected:(t==this._oMDCChart.getChartType())});}}}return a;};k.getDrillStackInfo=function(){};k.getDrillStack=function(){return this._oInnerChart.getDrillStack();};k.getSortedDimensions=function(e){return new Promise(function(i,s){this.fetchProperties(e).then(function(P){var t=P.filter(function(I){return I.groupable;});if(t){t.sort(function(a,b){if(a.label&&b.label){return a.label.localeCompare(b.label);}});}i(t);});}.bind(this));};k.getDrillableItems=function(a){var b=a.getItems().filter(function(i){return i.getType()==="groupable";});return b;};k.setChartType=function(s){this._oInnerChart.setChartType(s);};k.createInnerChartContent=function(a,b){this._oInnerChart=new n({id:a.getId()+"--innerChart",chartType:"column",height:"330px",width:"100%",isAnalytical:true});this._createInitialContentFromItems(a.getItems());this._oInnerChart.attachRenderComplete(function(){a._updateToolbar();});this._oInnerStructure.removeAllItems();this._oInnerStructure.addItem(this._oInnerChart);this._fnDataLoadedCallback=b;var B=this._getBindingInfo(a);this.updateBindingInfo(a,B);this.rebindChart(a,B);};k.createInnerDimension=function(a){var b=new o({name:a.getName(),role:"category",label:a.getLabel()});this._oInnerChart.addDimension(b);};k.createInnerMeasure=function(a){var b=new p({name:a.getAggregationMethod()+a.getName(),role:"axis1",label:a.getLabel(),analyticalInfo:{propertyPath:a.getName(),"with":a.getAggregationMethod()}});this._oInnerChart.addMeasure(b);};k.rebindChart=function(a,b){if(a&&b&&this._oInnerChart){this._addBindingListener(b,"change",this._onDataLoadComplete.bind(this));if(b.binding){b.binding.bHasAnalyticalInfo=true;}this._oInnerChart.bindData(b);this._oBindingInfo=b;this._innerChartBound=true;}};k._getBindingInfo=function(a){if(this._oBindingInfo){return this._oBindingInfo;}var b=a.getDelegate().payload;var e="/"+b.collectionName;var B={path:e,parameters:{entitySet:b.collectionName,useBatchRequests:true,provideGrandTotals:true,provideTotalResultSize:true,noPaging:true}};return B;};k.getInnerChartBound=function(){return!!this._innerChartBound;};k.updateBindingInfo=function(a,b){var e=C.byId(a.getFilter());if(e){var i=e.getConditions();if(i){if(!b){b={};}var P=e.getPropertyInfoSet?e.getPropertyInfoSet():null;var s=D.getParameterNames(e);var t=F.getFilterInfo(e,i,P,s);if(t){b.filters=t.filters;}var u=D.getParametersInfo(e,i);if(u){b.path=u;}}var v=e.getSearch();if(v){if(!b){b={};}if(!b.parameters){b.parameters={};}b.parameters.$search=v;}}};k.addInnerItem=function(P,a,b){return Promise.resolve(null);};k.insertInnerItem=function(P,a,b){};k.removeInnerItem=function(P,a,b){return Promise.resolve(true);};k.setChartTooltipVisibility=function(b){if(this._oInnerChart){if(b){if(!this._vizTooltip){this._vizTooltip=new q();}this._vizTooltip.connect(this._oInnerChart.getVizUid());}else{if(this._vizTooltip){this._vizTooltip.destroy();}}}else{L.error("Trying to set chart tooltip while inner chart was not yet initialized");}};k._loadChart=function(){return new Promise(function(a){var N=['sap/chart/library','sap/chart/Chart','sap/chart/data/Dimension','sap/chart/data/HierarchyDimension','sap/chart/data/TimeDimension','sap/chart/data/Measure','sap/viz/ui5/controls/VizTooltip'];function b(e,i,s,H,t,u,v){n=i;o=s;p=u;q=v;a();}sap.ui.require(N,b);});};k.initPropertyHelper=function(a){return Promise.all([this.fetchProperties(a),l("sap/ui/mdc/odata/v4/ChartPropertyHelperNew")]).then(function(R){return Promise.all(R.concat(this.fetchPropertyExtensions(a,R[0])));}.bind(this)).then(function(R){var P=R[0];var b=R[1][0];var e=R[2];var s=0;var t=[];for(var i=0;i<P.length;i++){t.push(Object.assign({},P[i],{extension:e[P[i].name]||{}}));if(P[i].name in e){s++;}}if(s!==Object.keys(e).length){throw new Error("At least one property extension does not point to an existing property");}return new b(t,a);});};k.fetchProperties=function(a){var b=this._getModel(a);var e;if(!b){e=new Promise(function(i){a.attachModelContextChange({resolver:i},r,this);}.bind(this)).then(function(b){return this._createPropertyInfos(a,b);}.bind(this));}else{e=this._createPropertyInfos(a,b);}return e.then(function(P){if(a.data){a.data("$mdcChartPropertyInfo",P);}return P;});};function r(e,a){var b=e.getSource();var i=this._getModel(b);if(i){b.detachModelContextChange(r);a.resolver(i);}}k._createPropertyInfos=function(a,b){var e=a.getDelegate().payload;var P=[];var E="/"+e.collectionName;var i=b.getMetaModel();return Promise.all([i.requestObject(E+"/"),i.requestObject(E+"@")]).then(function(R){var s=R[0],t=R[1];var u=t["@Org.OData.Capabilities.V1.SortRestrictions"]||{};var v=O.getSortRestrictionsInfo(u);var w=t["@Org.OData.Capabilities.V1.FilterRestrictions"];var x=O.getFilterRestrictionsInfo(w);for(var K in s){var y=s[K];if(y&&y.$kind==="Property"){if(y.$isCollection){continue;}var z=i.getObject(E+"/"+K+"@");if(!z["@Org.OData.Aggregation.V1.Aggregatable"]&&!z["@Org.OData.Aggregation.V1.Groupable"]){continue;}P.push({name:K,label:z["@com.sap.vocabularies.Common.v1.Label"]||K,sortable:v[K]?v[K].sortable:true,filterable:x[K]?x[K].filterable:true,groupable:z["@Org.OData.Aggregation.V1.Groupable"]||false,aggregatable:z["@Org.OData.Aggregation.V1.Aggregatable"]||false,recAggrMethod:z["@Org.OData.Aggregation.V1.RecommendedAggregationMethod"],supAggrMethods:z["@Org.OData.Aggregation.V1.SupportedAggregationMethods"],maxConditions:O.isMultiValueFilterExpression(x.propertyInfo[K])?-1:1,sortKey:z["@Org.OData.Aggregation.V1.Aggregatable"]?z["@Org.OData.Aggregation.V1.RecommendedAggregationMethod"]+K:K,kind:z["@Org.OData.Aggregation.V1.Groupable"]?"Groupable":"Aggregatable"});}}return P;});};k._getModel=function(t){var a=t.getDelegate().payload;return t.getModel(a.model);};k._addBindingListener=function(b,e,H){if(!b.events){b.events={};}if(!b.events[e]){b.events[e]=H;}else{var a=b.events[e];b.events[e]=function(){H.apply(this,arguments);a.apply(this,arguments);};}};k._onDataLoadComplete=function(e){if(e.mParameters.reason==="change"&&!e.mParameters.detailedReason){this._fnDataLoadedCallback.call();}};return k;});
