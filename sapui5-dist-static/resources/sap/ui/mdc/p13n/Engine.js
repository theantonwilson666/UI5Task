/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/base/Log","sap/base/util/UriParameters","sap/ui/base/Object","sap/ui/mdc/util/PropertyHelper","sap/ui/mdc/util/loadModules","sap/ui/mdc/p13n/P13nBuilder","sap/ui/mdc/p13n/modification/FlexModificationHandler","sap/m/MessageStrip","sap/ui/core/library","sap/ui/mdc/p13n/StateUtil","sap/ui/core/Element"],function(m,L,S,B,P,l,b,F,M,c,d,E){"use strict";var e=c.MessageType;var u=new S(window.location.search);var _=new WeakMap();var o;var f=B.extend("sap.ui.mdc.p13n.Engine",{constructor:function(){B.call(this);this._aRegistry=[];}});f.prototype.registerAdaptation=function(C,a){if(!a.hasOwnProperty("controller")){throw new Error("Please provide atleast a configuration 'controller' containing a map of key-value pairs (key + Controller class) in order to register adaptation.");}if(this._getRegistryEntry(C)){this.deregisterAdaptation(C);}var g=Object.keys(a.controller);g.forEach(function(k){var h=a.controller[k];if(!this.getController(C,k)){if(this._aRegistry.indexOf(C.getId())<0){this._aRegistry.push(C.getId());}var i=new h(C);this.addController(i,k);}}.bind(this));};f.prototype.deregisterAdaptation=function(C){var r=this._getRegistryEntry(C);Object.keys(r.controller).forEach(function(k){var a=r.controller[k];a.destroy();delete r.controller[k];});};f.prototype.showUI=function(C,k,s){if(u.getAll("sap-ui-xx-p13nLiveMode")[0]==="true"){this.getController(C,k)._bLiveMode=true;L.warning("Please note that the p13n liveMode is experimental");}if(!this._hasActiveP13n(C)){this._setActiveP13n(C,k);return this.createUI(C,k).then(function(p){this._openP13nControl(C,k,p,s);return p;}.bind(this),function(a){this._setActiveP13n(C,null);L.error("P13n container creation failed: "+a);}.bind(this));}else{return Promise.resolve();}};f.prototype._setModificationHandler=function(C,a){if(!a.isA("sap.ui.mdc.p13n.modification.ModificationHandler")){throw new Error("Only sap.ui.mdc.p13n.modification.ModificationHandler derivations are allowed for modification");}var g=this._determineModification(C);g.handler=a;this._getRegistryEntry(C).modification=g;};f.prototype.createUI=function(C,k,a){return this.initAdaptation(C,k,a).then(function(){return this._retrieveP13nContainer(C,k).then(function(g){var p=g.getContent()[0];var h=this.getController(C,k);p.setP13nModel(h.getP13nModel());if(p.setLiveMode){p.setLiveMode(h.getLiveMode());}return h.initializeUI().then(function(){h.getAdaptationControl().addDependent(g);return g;});}.bind(this));}.bind(this));};f.prototype.createChanges=function(D){var C=D.control;var k=D.key;var n=D.state;var A=!!D.applyAbsolute;var s=!!D.suppressAppliance;if(!k||!C||!n){throw new Error("To create changes via Engine, atleast a 1)Control 2)Key and 3)State needs to be provided.");}return this.initAdaptation(C,k).then(function(){var g=this.getController(C,k);var h=g.getChangeOperations();var r=this._getRegistryEntry(C);var i=g.getCurrentState();var p=m(i instanceof Array?[]:{},i);var j={existingState:p,applyAbsolute:A,changedState:n,control:g.getAdaptationControl(),changeOperations:h,deltaAttributes:["name"],propertyInfo:r.helper.getProperties().map(function(a){return{name:a.getName()};})};var q=g.getDelta(j);if(!s){this._processChanges(C,q);}return q||[];}.bind(this));};f.prototype.reset=function(C,k){var a=this.getController(C,k);var g=this._determineModification(C);if(a.getResetEnabled()){return g.handler.reset({selector:C},g.payload).then(function(){return this.initAdaptation(C,k).then(function(){a.update();});}.bind(this));}else{return Promise.reject("The controller "+k+" has been configured to now allow reset.");}};f.prototype.waitForChanges=function(C){var a=this._determineModification(C);return a.handler.waitForChanges({element:C},a.payload);};f.prototype.isModificationSupported=function(C){var a=this._determineModification(C);return a.handler.isModificationSupported({element:C},a.payload);};f.prototype._processChanges=function(C,a){var g=this._determineModification(C);return g.handler.processChanges(a,g.payload);};f.prototype.getRTASettingsActionHandler=function(C,p,k){var r;var a=f.hasForReference(C,"sap.ui.mdc.p13n.PersistenceProvider");if(a.length>0){return Promise.reject("Please do not use a PeristenceProvider in RTA.");}var g=this.getModificationHandler(C);var i=g.processChanges;var h=this.getController(C,k);var R=h.getResetEnabled;h.getResetEnabled=function(){return false;};var j=new Promise(function(n,q){r=n;});g.processChanges=r;this._setModificationHandler(C,g);this.showUI(C,k).then(function(n){n.addStyleClass(p.styleClass);});j.then(function(){h.getResetEnabled=R;g.processChanges=i;});return j;};f.prototype.applyState=function(C,s,a){return this.retrieveState(C).then(function(g){var h=[],i=[];var I=C.validateState(d._externalizeKeys(s));if(I.validation===e.Error){L.error(I.message);}Object.keys(s).forEach(function(j){var k=this.getController(C,j);if(!k){L.warning("No controller registered for state"+j+" - state appliance ignored for this key.");return;}var n=this.createChanges({control:C,key:j,state:k.sanityCheck(s[j]),suppressAppliance:true,applyAbsolute:a});h.push(n);}.bind(this));return Promise.all(h).then(function(r){r.forEach(function(j){if(j&&j.length>0){i=i.concat(j);}});return this._processChanges(C,i);}.bind(this));}.bind(this));};f.prototype.retrieveState=function(C){var v=this.checkXStateInterface(C);if(!v){throw new Error("The control needs to implement the interface IxState.");}return C.initialized().then(function(){return f.getInstance().waitForChanges(C).then(function(){var r={};f.getInstance().getRegisteredControllers(C).forEach(function(k){r[k]=f.getInstance().getController(C,k).getCurrentState();});return r;});});};f.prototype.checkXStateInterface=function(C){if(!C){return false;}if(!this.isModificationSupported(C)){return false;}if(!C.isA("sap.ui.mdc.IxState")){return false;}return true;};f.prototype.initAdaptation=function(C,k,a){if(!this.getController(C,k)){var g=f.getControlInstance(C);throw new Error("No controller registered yet for "+g.getId()+" and key: "+k);}return this._retrievePropertyHelper(C,a).then(function(){this._prepareAdaptationData(C,k);return;}.bind(this));};f.prototype.addController=function(C,k){var r=this._createRegistryEntry(C.getAdaptationControl());r.controller[k]=C;};f.prototype.getController=function(C,k){var r=this._getRegistryEntry(C);if(r&&r.controller.hasOwnProperty(k)){return r.controller[k];}};f.prototype.getRegisteredControllers=function(C){var r=this._getRegistryEntry(C);return Object.keys(r.controller);};f.prototype._getRegistryEntry=function(C){var a=f.getControlInstance(C);return _.get(a);};f.prototype.getModificationHandler=function(C){var a=this._determineModification(C);return a.handler;};f.prototype._createRegistryEntry=function(C){var a=f.getControlInstance(C);if(!_.has(a)){_.set(a,{modification:null,controller:{},activeP13n:null,helper:null});}return _.get(a);};f.prototype._determineModification=function(C){var r=this._getRegistryEntry(C);if(r&&r.modification){return r.modification;}var p=f.hasForReference(C,"sap.ui.mdc.p13n.PersistenceProvider");var v=f.hasForReference(C,"sap.ui.fl.variants.VariantManagement");var a=p.length?p:undefined;var h=a?a[0].getMode():"Standard";var H={Global:F,Transient:F,Standard:F,Auto:F};var g=H[h];if(!g){throw new Error("Please provide a valid ModificationHandler! - valid Modification handlers are:"+Object.keys(H));}var i={handler:g.getInstance(),payload:{hasVM:v&&v.length>0,hasPP:p&&p.length>0,mode:h}};if(r&&!r.modification){r.modification=i;}return i;};f.hasForReference=function(C,s){var a=C&&C.getId?C.getId():C;var r=E.registry.filter(function(g){if(!g.isA(s)){return false;}var h=g.getFor();for(var n=0;n<h.length;n++){if(h[n]===a||f.hasControlAncestorWithId(a,h[n])){return true;}}return false;});return r;};f.hasControlAncestorWithId=function(C,a){var g;if(C===a){return true;}g=sap.ui.getCore().byId(C);while(g){if(g.getId()===a){return true;}if(typeof g.getParent==="function"){g=g.getParent();}else{return false;}}return false;};f.getControlInstance=function(C){return typeof C=="string"?sap.ui.getCore().byId(C):C;};f.prototype._hasActiveP13n=function(C){return!!this._getRegistryEntry(C).activeP13n;};f.prototype._setActiveP13n=function(C,k){this._getRegistryEntry(C).activeP13n=k;};f.prototype._openP13nControl=function(C,k,p,s){var a=this.getController(C,k);if(a.getLiveMode()){p.openBy(s);}else{p.open();}this._validateP13n(C,k,p.getContent()[0]);};f.prototype._retrieveP13nContainer=function(C,k){return new Promise(function(r,a){var g=this.getController(C,k);var h=g.getLiveMode();var A=g.getAdaptationUI();var p=function(i){if(h&&i.attachChange){i.attachChange(function(){this._handleChange(g.getAdaptationControl(),k,g.getP13nData());}.bind(this));}if(i.attachChange){i.attachChange(function(j){f.getInstance()._validateP13n(C,k,i);});}this._createUIContainer(C,k,i).then(function(D){r(D);});}.bind(this);if(typeof A==="string"){var s=A;l([s]).then(function(j){var n=j[0];var q=new n();p(q);});}else if(A instanceof Function){p(A);}else if(A instanceof Promise){A.then(function(i){p(i);});}else if(A.isA("sap.ui.core.Control")){var i=A;p(i);}else{a(new Error("Please provide either a BasePanel derivation or a custom Control as personalization UI in AdaptationConfig"));}}.bind(this));};f.prototype._validateP13n=function(C,k,p){var a=this.getController(C,k);var g=f.getControlInstance(C);var h=this._getRegistryEntry(C).controller;var t={};Object.keys(h).forEach(function(s){t[s]=h[s].getCurrentState();});if(a.model2State instanceof Function){t[k]=a.model2State();var i=g.validateState(d._externalizeKeys(t));var j;if(i.validation!==e.None){j=new M({type:i.validation,text:i.message});}p.setMessageStrip(j);}};f.prototype._handleChange=function(C,k,n,a){this.createChanges({control:C,key:k,state:n.items,suppressAppliance:true,applyAbsolute:true}).then(function(i){var g=a?a.concat(i):i;if(g.length>0){this._processChanges(C,g);}}.bind(this));};f.prototype._createUIContainer=function(C,k,p){var a=this.getController(C,k);var g;if(a.getLiveMode()){g=this._createPopover(C,k,p);}else{g=this._createModalDialog(C,k,p);}return g.then(function(h){h.addStyleClass("sapUiMdcPersonalizationDialog");h.isPopupAdaptationAllowed=function(){return false;};if(!a.getLiveMode()){h.setEscapeHandler(function(D){this._setActiveP13n(C,null);h.close();h.destroy();D.resolve();}.bind(this));}h.toggleStyleClass("sapUiSizeCompact",!!jQuery(a.getAdaptationControl()).closest(".sapUiSizeCompact").length);return h;}.bind(this));};f.prototype._createPopover=function(C,k,p){var a=this.getController(C,k);var A=function(g){var h=g.getSource();this._setActiveP13n(C,null);h.destroy();}.bind(this);var s=Object.assign({verticalScrolling:true,afterClose:A},a.getContainerSettings());if(a.getResetEnabled()){s.reset={onExecute:function(){this.reset(C,k);}.bind(this)};}return b.createP13nPopover(p,s);};f.prototype._createModalDialog=function(C,k,p){var a=this.getController(C,k);var D=function(h){var i=h.getSource().getParent();var j=this._confirmContainer(C,k,p);j.then(function(){this._setActiveP13n(C,null);i.close();}.bind(this));}.bind(this);var g=function(h){var i=h.getSource().getParent();this._setActiveP13n(C,null);i.close();}.bind(this);var s=Object.assign({verticalScrolling:true,afterClose:function(h){var i=h.getSource();if(i){i.destroy();}},cancel:g},a.getContainerSettings());if(a.getResetEnabled()){s.reset={onExecute:function(){this.reset(C,k);}.bind(this)};}s.confirm={handler:function(h){D(h);}};return b.createP13nDialog(p,s);};f.prototype._confirmContainer=function(C,k,p){var a=this.getController(C,k);return a.getBeforeApply(p).then(function(g){return this._handleChange(a.getAdaptationControl(),k,a.getP13nData(),g);}.bind(this));};f.prototype._retrievePropertyHelper=function(C,a){var r=this._getRegistryEntry(C);if(a){if(r.helper){r.helper.destroy();}r.helper=new P(a);return Promise.resolve(r.oPropertyHelper);}if(r.helper){return Promise.resolve(r.helper);}return C.initPropertyHelper().then(function(p){r.helper=p;},function(h){throw new Error(h);});};f.prototype._prepareAdaptationData=function(C,k){var r=this._getRegistryEntry(C);var a=this.getController(C,k);var p=r.helper;a.setP13nData(p);};f.getInstance=function(){if(!o){o=new f();}return o;};f.prototype._getRegistry=function(){var r={};this._aRegistry.forEach(function(k){var C=sap.ui.getCore().byId(k);r[k]=_.get(C);});return r;};f.prototype.destroy=function(){B.prototype.destroy.apply(this,arguments);o=null;this._aRegistry=null;_.delete(this);};return f;});
