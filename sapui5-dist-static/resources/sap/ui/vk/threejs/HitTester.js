sap.ui.define(["sap/base/Log","../thirdparty/three"],function(L,a){"use strict";var H=function(){this._maskMaterial=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,fog:false});this._depthMaterial=new THREE.ShaderMaterial({vertexShader:["#include <clipping_planes_pars_vertex>","void main() {","	#include <begin_vertex>","	#include <project_vertex>","	#include <clipping_planes_vertex>","}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","void main() {","	#include <clipping_planes_fragment>","	highp vec4 value = vec4(fract(vec4(1.0, 255.0, 65025.0, 16581375.0) * gl_FragCoord.z));","	value.xyz -= value.yzw * (1.0 / 255.0);","	gl_FragColor  = value;","}"].join("\n"),side:THREE.DoubleSide,clipping:true});this._renderTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter});this._renderTarget.texture.generateMipmaps=false;this._renderTarget.depthBuffer=true;};var b;var m=new THREE.Matrix4();var f=new THREE.Frustum();var c=new THREE.Matrix4();var s=new THREE.Vector2();var r=new THREE.Raycaster();var d=new THREE.Ray();var e=new THREE.Sphere();var o=[];var g=new Uint8Array(4);var p=new THREE.Vector3();function j(h){var i=h.parent;while(i){if(i.userData.closed){h=i;}i=i.parent;}while(h.parent&&h.userData.skipIt){h=h.parent;}return h;}H.prototype.hitTest=function(x,y,i,k,l,n,q,t){if(!b||b.constructor!==q.constructor){b=new q.constructor();}b.copy(q);var v=q.view;if(v){var w=v.width/i;var h=v.height/k;b.setViewOffset(v.fullWidth,v.fullHeight,v.offsetX+(x-0.5)*w,v.offsetY+(y-0.5)*h,w,h);}else{b.setViewOffset(i,k,x-0.5,y-0.5,1,1);}m.multiplyMatrices(b.projectionMatrix,b.matrixWorldInverse);f.setFromProjectionMatrix(m);r.setFromCamera(s.set(0,0),b);var u=l.getContext();var A=Math.min(u.getParameter(u.RED_BITS),8);var B=Math.min(u.getParameter(u.GREEN_BITS),8);var C=Math.min(u.getParameter(u.BLUE_BITS),8);var D=A+B;var E=(1<<A)-1;var F=(1<<B)-1;var M=(1<<C)-1;var G=1/E;var I=1/F;var J=1/M;var K=this._maskMaterial;var N=l.getClearColor().clone();var O=l.getClearAlpha();var P=l.autoClear;l.setRenderTarget(this._renderTarget);l.clippingPlanes=t||[];l.autoClear=false;l.setClearColor(0x000000,0);l.clear(true,true,false);var Q=K.color;var R=0;o.length=0;n.traverseVisible(function(U){var V=U.geometry;if(V&&U.material&&f.intersectsObject(U)){var W=U.matrixWorld;if(V.boundingSphere===null){V.computeBoundingSphere();}e.copy(V.boundingSphere);e.applyMatrix4(W);if(r.ray.intersectsSphere(e)===false){return;}c.getInverse(W);d.copy(r.ray).applyMatrix4(c);if(V.boundingBox!==null&&d.intersectsBox(V.boundingBox)===false){return;}R+=1;o.push(U);Q.setRGB((R&E)*G,((R>>A)&F)*I,((R>>D)&M)*J);var T=U.material;U.material=K;l.render(U,b);U.material=T;}});l.readRenderTargetPixels(this._renderTarget,0,0,1,1,g);R=(g[0]>>(8-A))+((g[1]>>(8-B))<<A)+((g[2]>>(8-C))<<D);var S=R>0?o[R-1]:null;var z;if(S){var T=S.material;S.material=this._depthMaterial;l.clear(true,true,false);l.render(S,b);S.material=T;l.readRenderTargetPixels(this._renderTarget,0,0,1,1,g);z=((g[0]+(g[1]+(g[2]+g[3]/255)/255)/255)/255)*2-1;p.set(0,0,z).applyMatrix4(b.projectionMatrixInverse).applyMatrix4(b.matrixWorld);}l.setRenderTarget(null);l.clippingPlanes=[];l.setClearColor(N,O);l.autoClear=P;return S?{distance:r.ray.origin.distanceTo(p),point:p,object:j(S)}:null;};H.prototype.hitTestPrecise=function(x,y,w,h,k,l,n){r.setFromCamera(s.set((x/w)*2-1,(y/h)*-2+1),l);if(n&&n.length>0){for(var q in n){var u=n[q];var v=u.distanceToPoint(r.ray.origin),t=-v/u.normal.dot(r.ray.direction);if(t>0){if(v<0){r.near=Math.max(r.near,t);}else{r.far=Math.min(r.far,t);}}else if(v<0){return null;}}}var z=r.intersectObjects(k.children,true);if(n&&n.length>0){r.near=0;r.far=Infinity;}if(z){for(var i in z){var A=z[i];var B=j(A.object);if(B.visible&&!B.isBillboard&&!B.isDetailView){A.object=B;return A;}}}return null;};H.prototype.hitTestPoint=function(x,y,w,h,i,k,l){r.setFromCamera(s.set((x/w)*2-1,(y/h)*-2+1),k);if(l&&l.length>0){for(var n in l){var q=l[n];var u=q.distanceToPoint(r.ray.origin),t=-u/q.normal.dot(r.ray.direction);if(t>0){if(u<0){r.near=Math.max(r.near,t);}else{r.far=Math.min(r.far,t);}}else if(u<0){return null;}}}var v=r.intersectObjects(i.children,true);if(l&&l.length>0){r.near=0;r.far=Infinity;}return v.length===1?v[0].point:null;};return H;});
