/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObject","../totara/TotaraLoader","../threejs/SceneBuilder","./Material","../thirdparty/three","../getResourceBundle","../ObjectType"],function(L,M,T,S,a,t,g,O){"use strict";var C=M.extend("sap.ui.vk.threejs.ContentDeliveryService",{metadata:{properties:{authorizationHandler:"any",maxActiveRequests:{type:"int",defaultValue:4},maxUrlLength:{type:"int",defaultValue:2048},meshesBatchSize:{type:"int",defaultValue:128},materialsBatchSize:{type:"int",defaultValue:128},geometriesBatchSize:{type:"int",defaultValue:128},geometriesMaxBatchDataSize:{type:"int",defaultValue:1048576},geomMeshesBatchSize:{type:"int",defaultValue:128},geomMeshesMaxBatchDataSize:{type:"int",defaultValue:1048576},annotationsBatchSize:{type:"int",defaultValue:128},tracksBatchSize:{type:"int",defaultValue:128},sequencesBatchSize:{type:"int",defaultValue:128},voxelThreshold:{type:"number",defaultValue:0.0},skipLowLODRendering:{type:"boolean",defaultValue:false}},events:{cameraChanged:{parameters:{sceneId:{type:"string"},camera:{type:"any"}},enableEventBubbling:true},sceneUpdated:{parameters:{},enableEventBubbling:true},viewGroupUpdated:{parameters:{currentViewGroupId:"string"},enableEventBubbling:true},sceneCompleted:{parameters:{sceneId:{type:"string"}},enableEventBubbling:true},loadingFinished:{parameters:{currentViewId:"string",currentViewGroupId:"string"},enableEventBubbling:true},contentChangesProgress:{parameters:{percent:"float"}},errorReported:{parameters:{error:{type:"any"}}},initialViewCompleted:{parameters:{sceneId:{type:"string"}},enableEventBubbling:true}}},constructor:function(i,s){this._loader=new T();this._loader.setSceneBuilder(new S());M.apply(this,arguments);this._transientSceneMap=new Map();this._currentNodeHierarchy=null;}});C.prototype.getMaxActiveRequests=function(){return this._loader.getMaxActiveRequests();};C.prototype.setMaxActiveRequests=function(m){this._loader.setMaxActiveRequests(m);return this;};C.prototype.getMaxUrlLength=function(){return this._loader.getMaxUrlLength();};C.prototype.setMaxUrlLength=function(m){this._loader.setMaxUrlLength(m);return this;};C.prototype.getMeshesBatchSize=function(){return this._loader.getMeshesBatchSize();};C.prototype.setMeshesBatchSize=function(m){this._loader.setMeshesBatchSize(m);return this;};C.prototype.getMaterialsBatchSize=function(){return this._loader.getMaterialsBatchSize();};C.prototype.setMaterialsBatchSize=function(m){this._loader.setMaterialsBatchSize(m);return this;};C.prototype.getGeometriesBatchSize=function(){return this._loader.getGeometriesBatchSize();};C.prototype.setGeometriesBatchSize=function(b){this._loader.setGeometriesBatchSize(b);return this;};C.prototype.getGeometriesMaxBatchDataSize=function(){return this._loader.getGeometriesMaxBatchDataSize();};C.prototype.setGeometriesMaxBatchDataSize=function(b){this._loader.setGeometriesMaxBatchDataSize(b);return this;};C.prototype.getGeomMeshesBatchSize=function(){return this._loader.getGeomMeshesBatchSize();};C.prototype.setGeomMeshesBatchSize=function(b){this._loader.setGeomMeshesBatchSize(b);return this;};C.prototype.getGeomMeshesMaxBatchDataSize=function(){return this._loader.getGeomMeshesMaxBatchDataSize();};C.prototype.setGeomMeshesMaxBatchDataSize=function(b){this._loader.setGeomMeshesMaxBatchDataSize(b);return this;};C.prototype.getAnnotationsBatchSize=function(){return this._loader.getAnnotationsBatchSize();};C.prototype.setAnnotationsBatchSize=function(b){this._loader.setAnnotationsBatchSize(b);return this;};C.prototype.getTracksBatchSize=function(){return this._loader.getTracksBatchSize();};C.prototype.setTracksBatchSize=function(b){this._loader.setTracksBatchSize(b);return this;};C.prototype.getSequencesBatchSize=function(){return this._loader.getSequencesBatchSize();};C.prototype.setSequencesBatchSize=function(s){this._loader.setSequencesBatchSize(s);return this;};C.prototype.getVoxelThreshold=function(){return this._loader.getVoxelThreshold();};C.prototype.setVoxelThreshold=function(v){this._loader.setVoxelThreshold(v);return this;};C.prototype.getSkipLowLODRendering=function(){return this._loader.getSkipLowLODRendering();};C.prototype.setSkipLowLODRendering=function(s){this._loader.setSkipLowLODRendering(s);return this;};C.prototype.initUrl=function(u,k,c){var b=this;function n(){b.fireSceneUpdated({});}function d(){var e;if(b._loader&&b._loader.currentSceneInfo){var f=b._loader.getContext(b._loader.currentSceneInfo.id);if(f){e=f.currentViewGroupId;}}b.fireViewGroupUpdated({currentViewGroupId:e});}if(!this._loader.running()||this._loader.getUrl()!==u){if(this._loader.running()){var s=this._loader.sceneBuilder;this._loader.dispose();this._loader=new T();this._loader.setSceneBuilder(s);}this._loader.onErrorCallbacks.attach(this._reportError.bind(b));this._loader.onMaterialFinishedCallbacks.attach(n);this._loader.onImageFinishedCallbacks.attach(n);this._loader.onSetGeometryCallbacks.attach(n);this._loader.onViewGroupUpdatedCallbacks.attach(d);this._loader.setUrl(u);this._loader.setCorrelationId(c?c:THREE.Math.generateUUID().toLowerCase());return this._loader.run();}else if(!k){this._loader.cleanup();}return Promise.resolve("Loader is ready");};C.prototype._reportError=function(e){this.fireErrorReported(e);};C.prototype._createLoadParam=function(r,b,p,c){var d=this;var i;var s=false;var e;if(this._currentNodeHierarchy){e=this._currentNodeHierarchy.getScene();}var f={root:p,includeHidden:c.getIncludeHidden(),includeAnimation:c.getIncludeAnimation(),pushPMI:c.getPushPMI(),includeBackground:c.getIncludeBackground(),includeParametric:c.getIncludeParametric(),metadataFilter:c.getMetadataFilter(),useSecureConnection:c.getUseSecureConnection(),activateView:c.getActivateView(),enableLogger:c.getEnableLogger()===true,pushViewGroups:c.getPushViewGroups(),vkScene:e,onActiveCamera:function(n){var j=false;var k=d._loader.getContext(c.getVeid());if(k&&k.phase<2){i=n;j=true;}if(!j){d.fireCameraChanged({sceneId:c.getVeid(),camera:n});}},onInitialSceneFinished:function(j){s=true;r({node:p,camera:i,contentResource:c,initialView:j,annotations:d.getSceneBuilder()._annotations,loader:d});},onSceneCompleted:function(){d.fireSceneCompleted({sceneId:c.getVeid()});},onLoadingFinished:function(){var j,k;if(d._loader&&d._loader.currentSceneInfo){var l=d._loader.getContext(d._loader.currentSceneInfo.id);if(l){j=l.currentViewId;k=l.currentViewGroupId;}}d.fireLoadingFinished({currentViewId:j,currentViewGroupId:k});},onContentChangesProgress:function(j){d.fireContentChangesProgress({source:j.source,phase:j.phase,percentage:j.percentage});},onInitialViewCompleted:function(){d.fireInitialViewCompleted({sceneId:c.getVeid()});}};var h=function(j){L.warning("Content loading error reported:",JSON.stringify(j.getParameters()));var k;if(j.getParameter("errorText")){k=j.getParameter("errorText");}else if(j.getParameter("error")){k=j.getParameter("error");}else if(j.getParameter("reason")){k=j.getParameter("reason");}else{k="failed to load: unknown reason";}if(s){var l=j.getParameter("error");if(l&&l===4){d.initUrl(this._loader.getUrl(),true);}}else{d.detachErrorReported(h);if(j.getParameter("events")){k=k+"\n"+JSON.stringify(j.getParameter("events"));}b(k);}};d.attachErrorReported(h);return f;};C.prototype.load=function(p,c,b){var d=this;var n=c.getNodeProxy();if(n){this._currentNodeHierarchy=n.getNodeHierarchy();}return new Promise(function(r,e){if(!c.getSource()||!c.getVeid()){e(g().getText("CONTENTDELIVERYSERVICE_MSG_NOURLORVEID"));return;}d.initUrl(c.getSource(),true);var f=d._createLoadParam(r,e,p,c);if(d._loader){d._loader.request(c.getVeid(),f,b);}});};C.prototype.getSceneBuilder=function(){if(this._loader){return this._loader.getSceneBuilder();}return null;};C.prototype.decrementResourceCountersForDeletedTreeNode=function(s){var c=this._loader.getContext(this._loader.currentSceneInfo.id);this._loader.decrementResourceCountersForDeletedTreeNode(c,s);};C.prototype.loadTransientScene=function(s,p,u){var b=this;return new Promise(function(r,c){if(!s||!p){c(g().getText("CONTENTDELIVERYSERVICE_MSG_INVALIDARGUMENTS"));return;}if(b._transientSceneMap.has(s)){var d=b._transientSceneMap.get(s).clone();p.add(d);r({nodeRef:d});return;}if(!b._loader){c(g().getText("CONTENTDELIVERYSERVICE_MSG_CONTENTDELIVERYSERVICENOTINITIALISED"));return;}var h=function(){b.detachLoadingFinished(h);if(b._transientSceneMap.get(s)){var d=b._transientSceneMap.get(s).clone();p.add(d);r({nodeRef:d});}};if(b._loader.contextMap.has(s)){b.attachLoadingFinished(h);return;}var e=new THREE.Object3D();e.name="transient";e.userData.currentSceneId=b.getSceneBuilder()._currentSceneId;var o=function(){var i=b._loader.getContext(s);i.onSceneCompletedCallbacks.detach(o);e.userData.entityId=i.defaultRootEntityId;b._transientSceneMap.set(s,e);var d=e.clone();p.add(d);r({nodeRef:d});};var f={root:e,onSceneCompleted:o,useSecureConnection:u};b._loader.request(s,f);});};C.prototype.update=function(s,b,v){var c=this;return new Promise(function(r,d){if(!c._loader){d(g().getText("CONTENTDELIVERYSERVICE_MSG_CONTENTDELIVERYSERVICENOTINITIALISED"));return;}c._loader.update(s,b,v).then(function(e){if(c._currentNodeHierarchy){for(var i=0;i<e.replacedNodeRefs.length;i++){c._currentNodeHierarchy.fireNodeReplaced({ReplacedNodeRef:e.replacedNodeRefs[i],ReplacementNodeRef:e.replacementNodeRefs[i],ReplacedNodeId:e.replacedNodeRefs[i],ReplacementNodeId:e.replacementNodeRefs[i]});}}r({sceneVeId:e.sceneVeId,sids:e.sidArray});}).catch(function(e){return d(e);});});};C.prototype.exit=function(){if(this._loader){this._loader.dispose();this._loader=null;}this._transientSceneMap=null;};C.prototype.loadView=function(s,v,b,c){if(typeof b==="undefined"){b="static";}var d=this;return this._loader.requestView(s,b,v,null,c).then(function(e){if(d._currentNodeHierarchy&&e.updatedNodes){for(var i=0;i<e.updatedNodes.length;i++){d._currentNodeHierarchy.fireNodeUpdated({nodeRef:e.updatedNodes[i]});}}d.fireSceneUpdated({});return e;}).catch(function(e){L.error(e);return null;});};C.prototype.updatePlaybacks=function(s,v,p){var b=this;return this._loader.requestView(s,"static",v,p,true).then(function(c){if(b._currentNodeHierarchy&&c.updatedNodes){for(var i=0;i<c.updatedNodes.length;i++){b._currentNodeHierarchy.fireNodeUpdated({nodeRef:c.updatedNodes[i]});}}b.fireSceneUpdated({});return c;}).catch(function(e){L.error(e);return null;});};C.prototype.loadViewGroup=function(s,v,i){var b=this;return this._loader.requestViewGroup(s,v,i).then(function(c){b.fireSceneUpdated({});return c;}).catch(function(e){L.error(e);return null;});};C.prototype.assignMaterialToNodes=function(s,m,n,b){var c=this;return this._loader.requestMaterial(s,m).then(function(d){function e(d,k,r){if(!k){return;}if(k.userData.markedForNotAssigningMaterial){delete k.userData.markedForNotAssigningMaterial;return;}if(c._currentNodeHierarchy){var l=c._currentNodeHierarchy.createNodeProxy(k);var o=new a();o.setMaterialRef(d);l.assignMaterial(o);c._currentNodeHierarchy.destroyNodeProxy(l);}if(r){k.children.forEach(function(p){if(!p||p.userData.objectType===O.PMI||p.userData.objectType===O.Hotspot){return;}e(d,p,r);});}}if(!b){for(var i=0;i<n.length;i++){e(d,n[i],true);}}else{for(var j=0;j<n.length;j++){n[j].userData.markedForNotAssigningMaterial=true;}var f=c._loader.getContext(s);var h=f.root;e(d,h,true);}c.fireSceneUpdated({});return true;}).catch(function(e){L.error(e);return false;});};C.prototype.printLogTokens=function(){if(this._loader){this._loader.printLogTokens();return true;}else{return false;}};return C;});
