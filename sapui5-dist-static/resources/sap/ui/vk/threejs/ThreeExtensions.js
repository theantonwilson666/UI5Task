/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../abgrToColor","../ObjectType","../thirdparty/three","../NodeContentType","./ThreeUtils"],function(a,O,t,N,T){"use strict";THREE.Object3D.prototype.defaultEmissive={r:0.0235,g:0.0235,b:0.0235};THREE.Object3D.prototype.defaultSpecular={r:0.0602,g:0.0602,b:0.0602};THREE.Box3.prototype._setFromObjectExcludingHotSpotAndPMI=function(o){this.makeEmpty();var v=new THREE.Vector3();var c=this;o.updateMatrixWorld(true);o.traverse(function(n){if(n.userData.objectType===O.Hotspot||n.userData.objectType===O.PMI){return;}var i,l;var g=n.geometry;if(g!==undefined){if(g.isGeometry){var d=g.vertices;for(i=0,l=d.length;i<l;i++){v.copy(d[i]);v.applyMatrix4(n.matrixWorld);c.expandByPoint(v);}}else if(g.isBufferGeometry){var e=g.attributes.position;if(e!==undefined){for(i=0,l=e.count;i<l;i++){v.fromBufferAttribute(e,i).applyMatrix4(n.matrixWorld);c.expandByPoint(v);}}}}});return this;};THREE.Object3D.prototype._vkCalculateObjectOrientedBoundingBox=function(){var p=this.parent,m=this.matrix.clone(),c=this.matrixAutoUpdate;this.parent=null;this.matrix.identity();this.matrixAutoUpdate=false;this.userData.boundingBox._setFromObjectExcludingHotSpotAndPMI(this);this.matrixAutoUpdate=c;this.matrix.copy(m);this.parent=p;this.updateMatrixWorld(true);};THREE.Object3D.prototype._vkTraverseNodeGeometry=function(c){c(this);for(var i=0,l=this.children.length;i<l;i++){var d=this.children[i];if(d.geometry!==undefined&&d.userData.skipIt){if(d.children){d._vkTraverseNodeGeometry(c);}else{c(d);}}else if(d.children){d._vkTraverseNodeGeometry(c);}}};THREE.Object3D.prototype._vkSetHighlightColor=function(c){this._vkTraverseNodeGeometry(function(n){n.userData.highlightingColor=c;n._vkUpdateMaterialColor();});};THREE.Object3D.prototype._vkSetTintColor=function(c){this._vkTraverseNodeGeometry(function(n){n.userData.tintColor=c;n._vkUpdateMaterialColor();});};THREE.Object3D.prototype._vkSetOpacity=function(o,j){this.userData.opacity=o;var n;var p;if(j){n=new Map();p=new Map();j.forEach(function(c){if(!c.node||!c.parent){return;}n.set(c.node,c);if(c.parent){var d=p.get(c.parent);if(!d){d=[];}d.push(c);p.set(c.parent,d);}});}this._vkTraverseNodes(function(c){c._vkUpdateMaterialOpacity(n);},n,p);};THREE.Object3D.prototype._vkUpdateMaterialColor=function(){if(!this.material||!this.material.color){return;}var u=this.userData;if(u.originalMaterial){if(u.originalMaterial.color.r===undefined){u.originalMaterial=null;}else{this.material.color.copy(u.originalMaterial.color);if(this.material.emissive!==undefined){this.material.emissive.copy(u.originalMaterial.emissive);}if(this.material.specular!==undefined){this.material.specular.copy(u.originalMaterial.specular);}}}if(u.highlightColor!==undefined||u.tintColor!==undefined||u.highlightingColor!==undefined){if(!u.originalMaterial){u.originalMaterial=this.material;this.material=this.material.clone();}if(u.highlightingColor!==undefined){var d=new THREE.Color();d.fromArray(u.highlightingColor).lerp(u.originalMaterial.color,1-u.highlightingColor[3]);this.material.color.copy(d);}var c;if(u.tintColor!==undefined){c=a(u.tintColor);this.material.color.lerp(new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0),c.alpha);if(this.material.emissive!==undefined){if(this.material.userData.defaultHighlightingEmissive){this.material.emissive.copy(this.material.userData.defaultHighlightingEmissive);}else{this.material.emissive.copy(THREE.Object3D.prototype.defaultEmissive);}}if(this.material.specular!==undefined){if(this.material.userData.defaultHighlightingSpecular){this.material.specular.copy(this.material.userData.defaultHighlightingSpecular);}else{this.material.specular.copy(THREE.Object3D.prototype.defaultSpecular);}}}if(u.highlightColor!==undefined){c=a(u.highlightColor);this.material.color.lerp(new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0),c.alpha);if(this.material.emissive!==undefined){if(this.material.userData.defaultHighlightingEmissive){this.material.emissive.copy(this.material.userData.defaultHighlightingEmissive);}else{this.material.emissive.copy(THREE.Object3D.prototype.defaultEmissive);}}if(this.material.specular!==undefined){if(this.material.userData.defaultHighlightingSpecular){this.material.specular.copy(this.material.userData.defaultHighlightingSpecular);}else{this.material.specular.copy(THREE.Object3D.prototype.defaultSpecular);}}}}this._vkUpdateMaterialOpacity();};THREE.Object3D.prototype._vkUpdateMaterialOpacity=function(n){if(!this.material){return;}var u=this.userData;if(u.originalMaterial){this.material.opacity=u.originalMaterial.opacity;this.material.transparent=u.originalMaterial.transparent;}var o=1.0;var h=false;var c=this;do{var d=null,j=null;if(n){j=n.get(c);}if(j&&j.opacity!=null){d=j.opacity;}else if(c.userData&&c.userData.opacity!==undefined){d=c.userData.opacity;}var e=1;if(j&&j.opacity!=null&&c.userData&&c.userData.offsetOpacity!=null){e=c.userData.offsetOpacity;}if(d!=null){o*=d;o*=e;h=true;}if(j&&j.parent){c=j.parent;continue;}c=c.parent;}while(c);if(h||this.renderOrder>0){if(!u.originalMaterial){u.originalMaterial=this.material;this.material=this.material.clone();}if(this.renderOrder>0){this.material.depthTest=false;this.material.transparent=true;}if(this.material.opacity){this.material.opacity*=o;this.material.transparent=u.originalMaterial.transparent||this.material.opacity<0.99;}}};THREE.Object3D.prototype._vkGetTotalOpacity=function(j){var n;if(j){n=new Map();j.forEach(function(e){if(!e.node||!e.parent){return;}n.set(e.node,e);});}var o=1.0;var c=this;do{var d=null,e=null;if(n){e=n.get(c);}if(e&&e.opacity!=null){d=e.opacity;}else if(c.userData&&c.userData.opacity!==undefined){d=c.userData.opacity;}var f=1;if(e&&e.opacity!=null&&c.userData&&c.userData.offsetOpacity!=null){f=c.userData.offsetOpacity;}if(d!=null){o*=d;o*=f;}if(e&&e.parent){c=e.parent;continue;}c=c.parent;}while(c);return o;};THREE.Object3D.prototype._vkTraverseMeshNodes=function(c){if(this._vkUpdate!==undefined||this.isDetailView){return;}c(this);var d=this.children;for(var i=0,l=d.length;i<l;i++){d[i]._vkTraverseMeshNodes(c);}};THREE.Object3D.prototype._vkTraverseNodes=function(c,n,p){c(this);var d;if(p){d=p.get(this);}var j;if(d){for(j=0;j<d.length;j++){d[j].node._vkTraverseNodes(c,n,p);}}var e=this.children;if(e){for(j=0;j<e.length;j++){var f=e[j];if(n){var g=n.get(f);if(g){continue;}}f._vkTraverseNodes(c,n,p);}}};function b(c,d){var e=c.min,f=c.max,m=d.elements,g=(e.x+f.x)*0.5,h=(e.y+f.y)*0.5,i=(e.z+f.z)*0.5,j=f.x-g,k=f.y-h,l=f.z-i;var n=m[0]*g+m[4]*h+m[8]*i+m[12];var o=m[1]*g+m[5]*h+m[9]*i+m[13];var p=m[2]*g+m[6]*h+m[10]*i+m[14];var q=Math.abs(m[0]*j)+Math.abs(m[4]*k)+Math.abs(m[8]*l);var r=Math.abs(m[1]*j)+Math.abs(m[5]*k)+Math.abs(m[9]*l);var s=Math.abs(m[2]*j)+Math.abs(m[6]*k)+Math.abs(m[10]*l);e.set(n-q,o-r,p-s);f.set(n+q,o+r,p+s);}THREE.Object3D.prototype._expandBoundingBox=function(c,v,d,e){var n=new THREE.Box3();function f(h){var i=h.geometry;if(i!==undefined){if(!i.boundingBox){i.computeBoundingBox();}if(!i.boundingBox.isEmpty()){n.copy(i.boundingBox);b(n,h.matrixWorld);if(isFinite(n.min.x)&&isFinite(n.min.y)&&isFinite(n.min.z)&&isFinite(n.max.x)&&isFinite(n.max.y)&&isFinite(n.max.z)){c.min.min(n.min);c.max.max(n.max);}}}var s=h.userData.boundingBox;if(s!==undefined&&s.min&&s.max&&!s.isEmpty()&&!v){n.copy(s);b(n,h.matrixWorld);c.min.min(n.min);c.max.max(n.max);}}function g(h){if(h._vkUpdate!==undefined&&(d||(e&&h.userData.is2D))){return;}if(!v||h.visible){f(h);}var j=h.children;for(var i=0,l=j.length;i<l;i++){g(j[i]);}}g(this);return c;};THREE.Object3D.prototype._vkPersistentId=function(){var o=this;do{if(o.userData.treeNode&&o.userData.treeNode.sid){return o.userData.treeNode.sid;}o=o.parent;}while(o);return null;};THREE.Object3D.prototype._vkSetNodeContentType=function(n){this.userData.nodeContentType=n;if(n===N.Reference){this.visible=false;this.userData.skipIt=true;}};THREE.Object3D.prototype._vkGetNodeContentType=function(){return this.userData.nodeContentType;};THREE.Camera.prototype._vkZoomTo=function(c,m){m=m||0;var s=new THREE.Vector3();c.getSize(s);if(s.lengthSq()===0){return this;}var d=new THREE.Vector3();c.getCenter(d);var e=new THREE.Vector3();this.getWorldDirection(e);e.multiplyScalar(s.length());var f=c.min,g=c.max;var h=[new THREE.Vector3(f.x,f.y,f.z),new THREE.Vector3(g.x,g.y,g.z),new THREE.Vector3(f.x,f.y,g.z),new THREE.Vector3(f.x,g.y,g.z),new THREE.Vector3(g.x,f.y,g.z),new THREE.Vector3(g.x,g.y,f.z),new THREE.Vector3(f.x,g.y,f.z),new THREE.Vector3(g.x,f.y,f.z)];var j=new THREE.Matrix4(),p=new THREE.Vector3();function k(r){j.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse);for(var i in h){p.copy(h[i]).applyMatrix4(j);if(p.x<-1.0||p.x>1.0||p.y<-1.0||p.y>1.0){return false;}}return true;}this.position.copy(d).sub(e);this.updateMatrixWorld(true);if(this.isPerspectiveCamera){while(!k(this)){this.position.sub(e);this.updateMatrixWorld(true);}var l=10;var P=this.position.clone();var v=d.clone();for(var n=0;n<l;n++){this.position.copy(P).add(v).multiplyScalar(0.5);this.updateMatrixWorld(true);if(k(this)){P.copy(this.position);}else{v.copy(this.position);}}this.position.copy(P).sub(d).multiplyScalar(m).add(P);this.updateMatrixWorld(true);}else if(this.isOrthographicCamera){var o=new THREE.Box2();h.forEach(function(i){p=i.project(this);o.expandByPoint(new THREE.Vector2(p.x,p.y));}.bind(this));var q=new THREE.Vector2();o.getSize(q);this.zoom/=Math.max(q.x,q.y)*0.5*(1+m);this.updateProjectionMatrix();}return this;};THREE.Mesh.prototype._vkClone=function(){var c=new THREE.Mesh();T.disposeMaterial(c.material);c.copy(this);return c;};});
