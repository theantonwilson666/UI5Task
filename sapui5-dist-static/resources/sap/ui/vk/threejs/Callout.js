/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/ui/base/ManagedObject","./Billboard","../thirdparty/html2canvas","./PolylineGeometry","./PolylineMaterial","./PolylineMesh","../BillboardStyle","../LeaderLineMarkStyle","./ThreeUtils"],function(a,B,b,c,P,d,e,f,L,T){"use strict";var C=b.extend("sap.ui.vk.threejs.Callout",{metadata:{properties:{anchorNode:{type:"any",defaultValue:null},depthTest:{type:"boolean",defaultValue:true}}}});C.prototype.init=function(){if(b.prototype.init){b.prototype.init.call(this);}this._lines=[];this._heads=[];};C.prototype.exit=function(){if(b.prototype.exit){b.prototype.exit.call(this);}this._lines.forEach(function(l){T.disposeObject(l);});this._lines=null;this._heads.forEach(function(h){T.disposeObject(h);});this._heads=null;};C.prototype._traverse=function(h){b.prototype._traverse.call(this,h);this._lines.forEach(h);this._heads.forEach(h);};C.prototype.setDepthTest=function(h){this.setProperty("depthTest",h,true);this._traverse(function(i){i.material.depthTest=h;});return this;};var g=new THREE.Vector4(),j=new THREE.Vector4(),k=new THREE.Vector4(),m=new THREE.Vector2(),n=new THREE.Vector2(),o=new THREE.Vector2(),q=new THREE.Quaternion(),r=new THREE.Matrix4(),u=new THREE.Vector2(),v=new THREE.Vector3(),w=new THREE.Vector3(),z=new THREE.Vector3(0,0,1),A=new THREE.Matrix4(),D=new THREE.Matrix4();C.prototype._update=function(h,i,l){var s=this.getNode();if(!s||!s.visible){return;}if(this._needUpdateTexture){this._needUpdateTexture=false;this._updateTexture();}s.matrix.getInverse(s.parent.matrixWorld);s.matrix.decompose(s.position,s.quaternion,s.scale);s.matrixWorld.identity();var x=this.getPosition(),y=this._billboard.position;if(x){y.copy(x);}else{y.setScalar(0);}var E=this.getAnchorNode();if(E){y.applyMatrix4(E.matrixWorld);}this._billboard.quaternion.copy(i.quaternion);A.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse);g.copy(y).applyMatrix4(A);m.copy(g).multiplyScalar(1/g.w).multiply(l);var F=g.w*2/(l.x*i.projectionMatrix.elements[0]);this._billboard.scale.set(F*this._width,F*this._height,1);v.setFromMatrixColumn(i.matrixWorld,0).multiplyScalar(F*(Math.round(m.x*0.5)-m.x*0.5));w.setFromMatrixColumn(i.matrixWorld,1).multiplyScalar(F*(Math.round(m.y*0.5)-m.y*0.5));y.add(v).add(w);this._billboard.updateMatrix();this._billboard.updateMatrixWorld();var G=this.getStyle()===f.CircularShape;var H=i.near;function I(p,t,J){if(p<t){return p-t;}else if(p>J){return p-J;}return 0;}this._lines.forEach(function(p){if(p.userData.targetNode){p.matrix.copy(p.userData.targetNode.matrixWorld);}else{p.matrix.identity();}p.matrixWorld.copy(p.matrix);if(p.isPolylineMesh){p.material.resolution.copy(l);}if(p.isHaloMesh){return;}var J=p.geometry.vertices;var K=J[0];var M=J[J.length-2];var N=J[J.length-1];var O=p.userData.startPointMesh;var Q=false;var R=[0,J.length-1];if(O!==undefined){K.copy(O.userData.targetVertex);}D.multiplyMatrices(A,p.matrixWorld);if(p.userData.extensionLength>0&&J.length>2){R.push(J.length-2);g.copy(J[J.length-3]).applyMatrix4(D);n.copy(g).multiplyScalar(1/g.w).multiply(l);M.set(Math.sign(n.x-m.x)*0.5*(1+p.userData.extensionLength/this._width),0,0);M.applyMatrix4(this._billboard.matrixWorld).applyMatrix4(r.getInverse(p.matrixWorld));}g.copy(M).applyMatrix4(D);n.copy(g).multiplyScalar(1/g.w).multiply(l);if(G){var S=u.copy(n).sub(m).length();Q=S<this._width;u.multiplyScalar(0.5/S);N.set(u.x,u.y,0);}else{var U=I(n.x,m.x-this._width,m.x+this._width),V=I(n.y,m.y-this._height,m.y+this._height);Q=(U===0&&V===0);if(Math.abs(U)>Math.abs(V)){N.set(Math.sign(U)*0.5,0,0);}else{N.set(0,Math.sign(V)*0.5,0);}}if(Q){N.copy(M);}else{N.applyMatrix4(this._billboard.matrixWorld).applyMatrix4(r.getInverse(p.matrixWorld));}p.geometry.verticesNeedUpdate=true;if(O!==undefined){O.position.copy(O.userData.targetVertex).applyMatrix4(p.matrixWorld);g.copy(O.position).applyMatrix4(A);var W=g.w/(l.x*i.projectionMatrix.elements[0]);O.scale.setScalar(W);O.visible=false;var X=false;if(g.w>=H){j.copy(g);k.copy(J[1]).applyMatrix4(D);if(k.w<H){var t=(j.w-H)/(j.w-k.w);k.sub(j).multiplyScalar(t).add(j);}o.copy(j).multiplyScalar(1/j.w);n.copy(k).multiplyScalar(1/k.w);u.copy(n).sub(o).multiply(l);X=u.length()<O.userData.lineOffset;q.setFromAxisAngle(z,Math.atan2(u.y,u.x));O.quaternion.copy(i.quaternion).multiply(q);O.updateMatrix();O.matrixWorld.copy(O.matrix);O.matrixWorldNeedsUpdate=false;o.multiply(l).sub(m);O.visible=G?o.length()>this._width:Math.abs(o.x)>this._width||Math.abs(o.y)>this._height;if(X||!O.visible){K.copy(J[1]);}else{K.set(O.userData.lineOffset,0,0).applyMatrix4(O.matrixWorld).applyMatrix4(r.getInverse(p.matrixWorld));}}}p.geometry._updateVertices(R);p.computeLineDistances(D,l,i instanceof THREE.PerspectiveCamera?H:undefined);if(p.userData.haloMesh){p.userData.haloMesh.material.lineLength=p.material.lineLength;}}.bind(this));};C.prototype._createMarkMesh=function(p,t,E,F){var G=E===L.Arrow;var H=window.devicePixelRatio;var I=t.width;var J=I*t.haloWidth;F=(Array.isArray(F)||F instanceof Float32Array)&&F.length===2?F:[1,1];var K,M;if(G){K=Math.max(35*F[0],I*5);M=Math.max(15*F[1],I*2);}else{K=M=Math.max(2*F[0],I*2);}K=Math.ceil(K+J*2);M=Math.ceil(M+J*2);var N=document.createElement("canvas");N.width=THREE.Math.ceilPowerOfTwo(K*H);N.height=THREE.Math.ceilPowerOfTwo(M*H);var O=N.getContext("2d");var x=K/2,y=M/2;O.fillStyle="#FFF";O.scale(H,H);if(G){O.beginPath();O.moveTo(0,y);O.lineTo(K,0);O.lineTo(K,M);O.closePath();O.fill();var h=K*y/Math.sqrt(K*K+y*y),s=(h-J)/h;var Q=K-K*s,R=y*(K*s-J)/K;O.fillStyle=p.getStyle();O.beginPath();O.moveTo(Q,y);O.lineTo(K-J,y-R);O.lineTo(K-J,y+R);O.closePath();O.fill();}else{var S=K*0.5,U=S-J;O.beginPath();O.ellipse(x,y,S,S,0,0,Math.PI*2);O.fill();O.fillStyle=p.getStyle();O.beginPath();O.ellipse(x,y,U,U,0,0,Math.PI*2);O.fill();}O.fillRect(K-J,y-I*0.5,J,I);var V=new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(N),flatShading:true,transparent:true,alphaTest:0.05,premultipliedAlpha:true,side:THREE.DoubleSide,depthTest:this.getDepthTest()});var W=new THREE.PlaneBufferGeometry(K*2,M*2);if(G){W.translate(K,0,0);}var X=new THREE.Mesh(W,V);X.userData.skipIt=true;X.userData.lineOffset=(G?K*2-1:K-J*2);var Y=new THREE.Vector2(K*H/N.width,M*H/N.height);var Z=X.geometry.attributes.uv.array;for(var i=0,l=Z.length;i<l;i+=2){Z[i]*=Y.x;Z[i+1]=1-(1-Z[i+1])*Y.y;}return X;};C.prototype.addLeaderLine=function(h,t,i,s,l,p,x){var y=this.getNode();if(x>0&&h.length<3){h.push(h[h.length-1].clone());}var E=i.userData.lineStyle||{};E.width=E.width||1;E.haloWidth=E.haloWidth||0;E.endCapStyle=E.endCapStyle||0;var F=E.endCapStyle||h.length>2?1:0;var G=(F&&(s!==L.None||E.endCapStyle===0)?1:0)|(F&&(l!==L.None||E.endCapStyle===0)?2:0);var H=new P();H.setVertices(h);var I;if(E.haloWidth>0){var J=new d({color:0xFFFFFF,lineColor:0xFFFFFF,linewidth:E.width*(E.haloWidth*2+1),dashCapStyle:E.endCapStyle,segmentCapStyle:F,trimStyle:G,transparent:true,depthTest:this.getDepthTest()});I=new e(H,J);I.userData.skipIt=true;I.userData.targetNode=t;I.matrixAutoUpdate=false;I.renderOrder=this.getRenderOrder();I.isHaloMesh=true;y.add(I);this._lines.push(I);}var K=new d({color:0xFFFFFF,lineColor:i.color,linewidth:E.width,dashCapStyle:E.endCapStyle,segmentCapStyle:F,trimStyle:G,dashPattern:E.dashPattern||[],dashScale:E.dashPatternScale||1,transparent:true,depthTest:this.getDepthTest()});var M=new e(H,K);M.userData.skipIt=true;M.userData.targetNode=t;M.userData.extensionLength=x;M.userData.haloMesh=I;M.matrixAutoUpdate=false;M.renderOrder=this.getRenderOrder();y.add(M);this._lines.push(M);if(s!==L.None){var N=this._createMarkMesh(i.color,E,s,p);N.userData.targetVertex=H.vertices[0].clone();N.matrixAutoUpdate=false;N.renderOrder=this.getRenderOrder();M.userData.startPointMesh=N;y.add(N);this._heads.push(N);}return M;};return C;});
