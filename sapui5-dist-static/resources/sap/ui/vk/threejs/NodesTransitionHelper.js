/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/ui/core/Element","../TransformationMatrix"],function(t,E,T){"use strict";var N=E.extend("sap.ui.vk.threejs.NodesTransitionHelper",{metadata:{properties:{},publicMethods:["setViewStateManager","setNodeForDisplay","setDisappearingNode","setAppearingNode","clear","startDisplay","displayNodesMoving"],events:{displaying:{},displayed:{}}}});N.prototype.init=function(){this._viewStateManager=null;this._nodeLocalmMatrixMap=new Map();this._nodeLocalMatrixMapForVisibility=new Map();this._timeIntervalForDisplay=500;this._startTimeForDisplay=0;};N.prototype.destroy=function(){this._viewStateManager=null;this._nodeLocalmMatrixMap=null;this._nodeLocalMatrixMapForVisibility=new Map();if(E.prototype.destroy){E.prototype.destroy.apply(this,arguments);}};N.prototype.setViewStateManager=function(v){this._viewStateManager=v;};N.prototype.setNodeForDisplay=function(n,a){this._nodeLocalmMatrixMap.set(n,{oldMatrix:n.getLocalMatrix(),newMatrix:a?T.convertTo4x3(a.elements):null});};N.prototype.setDisappearingNode=function(n){var o=n.getLocalMatrix();var a=[o[0]*0.0001,o[1],o[2],o[3],o[4]*0.0001,o[5],o[6],o[7],o[8]*0.0001,o[9],o[10],o[11]];this._nodeLocalMatrixMapForVisibility.set(n,{oldMatrix:o,newMatrix:a,visible:false});this._viewport.getViewStateManager().setVisibilityState(n.getNodeRef(),true,false);};N.prototype.setAppearingNode=function(n){var o=n.getLocalMatrix();var a=[o[0]*0.0001,o[1],o[2],o[3],o[4]*0.0001,o[5],o[6],o[7],o[8]*0.0001,o[9],o[10],o[11]];this._nodeLocalMatrixMapForVisibility.set(n,{oldMatrix:a,newMatrix:o,visible:true});};N.prototype._interpolateNodePositionForVisibility=function(n,d,i){var a=n.getNodeRef();return(i>=1)?d.visible:a.visible;};N.prototype._interpolateNodePosition=function(n,o,a,i){var b=new THREE.Matrix4().fromArray(T.convertTo4x4(o));var c=new THREE.Vector3();var d=new THREE.Quaternion();var e=new THREE.Vector3();b.decompose(c,d,e);var f=new THREE.Matrix4().fromArray(T.convertTo4x4(a));var g=new THREE.Vector3();var h=new THREE.Quaternion();var j=new THREE.Vector3();f.decompose(g,h,j);var p=new THREE.Vector3().lerpVectors(c,g,i);var q=new THREE.Quaternion().copy(d).slerp(h,i);var s=new THREE.Vector3().lerpVectors(e,j,i);return{translation:p.toArray(),quaternion:q.toArray(),scale:s.toArray()};};N.prototype.startDisplay=function(a){if(this._nodeLocalmMatrixMap.size===0){return;}this._timeIntervalForDisplay=a!==undefined?a:500;this._startTimeForDisplay=Date.now();this._nodeLocalmMatrixMap.forEach(function(m,n){if(!m.newMatrix){m.newMatrix=n.getLocalMatrix();}});this.fireDisplaying();};N.prototype.displayNodesMoving=function(){if(this._startTimeForDisplay===0||this._nodeLocalmMatrixMap===null||this._nodeLocalmMatrixMap.size===0){return;}var i=Math.min((Date.now()-this._startTimeForDisplay)/this._timeIntervalForDisplay,1);i=1-Math.pow(1-i,3);var a={nodeRefs:[],positions:[]};this._nodeLocalmMatrixMap.forEach(function(m,n){if(n&&m.oldMatrix&&m.newMatrix){var b=this._interpolateNodePosition(n,m.oldMatrix,m.newMatrix,i);a.nodeRefs.push(n.getNodeRef());a.positions.push(b);}}.bind(this));if(a.nodeRefs.length){this._viewStateManager.setTransformation(a.nodeRefs,a.positions);}var v={nodeRefs:[],values:[]};this._nodeLocalMatrixMapForVisibility.forEach(function(d,n){if(n&&d){var b=this._interpolateNodePositionForVisibility(n,d,i);v.nodeRefs.push(n.getNodeRef());v.values.push(b);}}.bind(this));this._viewStateManager.setVisibilityState(v.nodeRefs,v.values);if(i===1){this.clear();this.fireDisplayed();}};N.prototype.clear=function(){this._nodeLocalmMatrixMap.clear();this._nodeLocalMatrixMapForVisibility.clear();this._startTimeForDisplay=0;};return N;});
