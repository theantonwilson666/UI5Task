/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../Core","../ViewStateManagerBase","../thirdparty/three","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene","../ObjectType","../RotationType","./NodesTransitionHelper","./OutlineRenderer","./HighlightPlayer","../HighlightDisplayState","../Highlight","../AnimationTrackType","../AnimationTrackValueType","../AnimationMath","../NodeContentType","./ThreeUtils"],function(a,V,t,b,d,e,f,S,O,R,N,g,H,h,m,A,n,o,p,T){"use strict";var q;var r=V.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{}});var u=r.getMetadata().getParent().getClass().prototype;r.prototype.init=function(){if(u.init){u.init.call(this);}this._nodeHierarchy=null;this._nodeStates=new Map();this._selectedNodes=new Set();this._outlineRenderer=new g(1.0);this._outlinedNodes=new Set();this.setOutlineColor("rgba(255, 0, 255, 1.0)");this.setOutlineWidth(1.0);this._visibilityTracker=new q();this._showSelectionBoundingBox=true;this._boundingBoxesScene=new THREE.Scene();this._selectionColor=new THREE.Color(0xC0C000);this.setHighlightColor("rgba(255, 0, 0, 1.0)");this._joints=[];this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewStateManager(this);this._highlightPlayer=new H();this._highlightPlayer.setViewStateManager(this);this._transitionPlayer=new H();this._transitionPlayer.setViewStateManager(this);a.getEventBus().subscribe("sap.ui.vk","activateView",this._onActivateView,this);};r.prototype._clearBoundingBoxScene=function(){var c=[];var i=[];T.getAllTHREENodes([this._boundingBoxesScene],c,i);c.forEach(function(j){T.disposeObject(j);j.parent.remove(j);});i.forEach(function(j){j.parent.remove(j);});};r.prototype.exit=function(){a.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onActivateView,this);if(this._nodesTransitionHelper){this._nodesTransitionHelper.destroy();}if(this._outlineRenderer){this._outlineRenderer.dispose();this._outlineRenderer=null;}if(this._boundingBoxesScene){this._clearBoundingBoxScene();this._boundingBoxesScene.dispose();this._boundingBoxesScene=null;}};r.prototype._setContent=function(c){var s=null;if(c&&c instanceof S){s=c;}this._setScene(s);if(s){var i=s.getInitialView();if(i){this._currentView=i;this._resetNodesMaterialAndOpacityByCurrenView(this._currentView);}}return this;};r.prototype._setScene=function(s){if(this._boundingBoxesScene){this._clearBoundingBoxScene();}this._boundingBoxesScene=new THREE.Scene();this._setNodeHierarchy(s?s.getDefaultNodeHierarchy():null);if(s){s.setViewStateManager(this);}this._scene=s;if(this._scene){var i=this._scene.getInitialView();if(i){this.activateView(i);}}return this;};r.prototype._setNodeHierarchy=function(c){var i=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._nodeStates.clear();this._selectedNodes.clear();this._outlinedNodes.clear();this._visibilityTracker.clear();}if(c){this._nodeHierarchy=c;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._nodeHierarchy.attachNodeRemoving(this._handleNodeRemoving,this);this._initialState={visible:[],hidden:[]};var j=this;var k=c.findNodesByName();k.forEach(function(l){j._initialState[l.visible?"visible":"hidden"].push(l);});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden});}if(c!==i){this.fireNodeHierarchyReplaced({oldNodeHierarchy:i,newNodeHierarchy:c});}return this;};r.prototype._getJointByChildNode=function(c){var j;if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===c){j=this._jointCollection[i];break;}}}return j;};r.prototype._handleNodeReplaced=function(c){var i=c.getParameter("ReplacedNodeRef");var j=c.getParameter("ReplacementNodeRef");if(this.getSelectionState(i)){this.setSelectionState(j,true);this.setSelectionState(i,false);}};r.prototype._handleNodeUpdated=function(c){var i=c.getParameter("nodeRef");if(this.getSelectionState(i)){this.setSelectionState(i,false);this.setSelectionState(i,true);}};r.prototype._handleNodeRemoving=function(c){var j=c.getParameter("nodeRef");if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===j){this._jointCollection[i].node=null;break;}if(this._jointCollection[i].parent===j){this._jointCollection[i].parent=null;break;}}}if(this.getSelectionState(j)){this.setSelectionState(j,false,true,true);}};r.prototype._renderOutline=function(i,s,j){var c=e(this._outlineColorABGR);var k=new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0);this._outlineRenderer.render(i,s,j,Array.from(this._outlinedNodes),k,this._jointCollection);};r.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};r.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};r.prototype.getCurrentView=function(){var v=sap.ui.getCore().byId(this.getViewManager());if(!v){return null;}var c=v.getActiveView();return c;};r.prototype.resetNodeProperty=function(c,i){var j=this.getCurrentView();if(!j){return;}var k=j.getNodeInfos();if(k){var l=[];l.push(c);if(this._jointCollection&&this._jointCollection.length>0){for(var s=0;s<this._jointCollection.length;s++){var v=this._jointCollection[s];if(!v.node||!v.parent){continue;}var x=v.parent;if(x!==c){break;}l.push(v.node);}}k.forEach(function(y){if(!l.includes(y.target)){return;}if(!i||i!==A.Opacity){var z={nodeRefs:[],positions:[]};var C;var D;var E;if(y.transform){var F=new THREE.Vector3();var G=new THREE.Quaternion();var I=new THREE.Vector3();var J=B(y.transform);J.decompose(F,G,I);C=F.toArray();D=G.toArray();E=I.toArray();}else if(y[A.Scale]&&y[A.Rotate]&&y[A.Translate]){C=y[A.Translate].slice();D=y[A.Rotate].slice();E=y[A.Scale].slice();}if(C){z.nodeRefs.push(y.target);z.positions.push({translation:C,quaternion:D,scale:E});this.setTransformation(z.nodeRefs,z.positions);}}else{c._vkSetOpacity(y.opacity,this._jointCollection);var K={changed:c,opacity:k.opacity};this.fireOpacityChanged(K);}}.bind(this));}};r.prototype.getVisibilityComplete=function(){var c=this.getNodeHierarchy(),i=c.findNodesByName(),v=[],j=[];i.forEach(function(k){var l=c.createNodeProxy(k);var s=l.getVeId();c.destroyNodeProxy(l);if(s){if(this.getVisibilityState(k)){v.push(s);}else{j.push(s);}}},this);return{visible:v,hidden:j};};r.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();};r.prototype.getVisibilityState=function(c){if(Array.isArray(c)){return c.map(function(i){return i?i.visible:false;});}return c?c.visible:false;};r.prototype.setVisibilityState=function(c,v,i){if(!Array.isArray(c)){c=[c];}var j=Array.isArray(v);var k=[];var l=c;if(i){l=[];c.forEach(function(C,D){var E=this._collectNodesRecursively(C);l=l.concat(E);var F=k.length;k.length=F+E.length;k.fill(j?v[D]:v,F);},this);}else if(!j){k.length=l.length;k.fill(v);}else{k=v;}var s=[];var x=new Set();var y=l.filter(function(C,D){if(C==null||(C.userData.skipIt&&C.visible)||x.has(C)){return false;}x.add(C);var y=C?C.visible!=k[D]:false;if(y){s.push(k[D]);}return y;},this);if(y.length>0){var z={visible:[],hidden:[]};y.forEach(function(C,D){C.visible=s[D];z[C.visible?"visible":"hidden"].push(C);},this);if(this.getShouldTrackVisibilityChanges()){y.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker);}this.fireVisibilityChanged(z);}return this;};r.prototype._getEffectiveVisibility=function(c){var i=this.getVisibilityState(c);var j=c.parent;while(i&&j){i=i&&this.getVisibilityState(j);j=j.parent;}return i;};r.prototype.enumerateSelection=function(c){this._selectedNodes.forEach(c);return this;};r.prototype.enumerateOutlinedNodes=function(c){this._outlinedNodes.forEach(c);return this;};r.prototype.getSelectionState=function(c){var s=this._selectedNodes;function i(j){return s.has(j);}return Array.isArray(c)?c.map(i):i(c);};r.prototype._getSelectionComplete=function(){var c=this.getNodeHierarchy(),s=[],i=[];function j(k){var l=c.createNodeProxy(k);var v=l.getVeId();c.destroyNodeProxy(l);return v;}this._selectedNodes.forEach(function(k){var v=j(k);if(v){s.push(v);}});this._outlinedNodes.forEach(function(k){var v=j(k);if(v){i.push(v);}});return{selected:s,outlined:i};};r.prototype._isAChild=function(c,i){var j=c.parent;while(j){if(i.has(j)){return true;}j=j.parent;}return false;};r.prototype._AddBoundingBox=function(c){if(c.userData.boundingBox===undefined){c.userData.boundingBox=new THREE.Box3();c._vkCalculateObjectOrientedBoundingBox();}if(!c.userData.boundingBox.isEmpty()&&this._boundingBoxesScene&&c.userData.boxHelper===undefined){var i=new THREE.Box3Helper(c.userData.boundingBox,0xffff00);i.material.color=this._selectionColor;this._boundingBoxesScene.add(i);i.parent=c;c.userData.boxHelper=i;}};r.prototype._RemoveBoundingBox=function(c){if(c.userData.boundingBox!==undefined){delete c.userData.boundingBox;}if(c.userData.boxHelper!==undefined){this._boundingBoxesScene.remove(c.userData.boxHelper);T.disposeObject(c.userData.boxHelper);delete c.userData.boxHelper;}};r.prototype._updateBoundingBoxesIfNeeded=function(){var c=new Set();this._selectedNodes.forEach(function(i){var j=i.parent;while(j){if(this._selectedNodes.has(j)){c.add(j);}j=j.parent;}}.bind(this));c.forEach(function(i){i._vkCalculateObjectOrientedBoundingBox();});};r.prototype._updateBoundingBoxes=function(){this._selectedNodes.forEach(function(c){if(c.userData.boundingBox){c._vkCalculateObjectOrientedBoundingBox();}});};r.prototype.setShowSelectionBoundingBox=function(v){this._showSelectionBoundingBox=v;if(this._showSelectionBoundingBox){this._selectedNodes.forEach(function(c){this._AddBoundingBox(c);}.bind(this));}else{this._selectedNodes.forEach(function(c){this._RemoveBoundingBox(c);}.bind(this));}this.fireSelectionChanged({selected:this._selectedNodes,unselected:[]});};r.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox;};r.prototype._isAncestorSelected=function(c){c=c.parent;while(c){if(this._selectedNodes.has(c)){return true;}c=c.parent;}return false;};r.prototype._updateHighlightColor=function(c,j){var s=j||this._selectedNodes.has(c);var k=c._vkGetNodeContentType();if(k===p.Background||k===p.Symbol){return;}else{c.userData.highlightColor=s?this._highlightColorABGR:undefined;c._vkUpdateMaterialColor();var v=c.children;for(var i=0,l=v.length;i<l;i++){var x=v[i].userData;if(x&&x.objectType===O.Hotspot){continue;}this._updateHighlightColor(v[i],s);}}};r.prototype.setSelectionState=function(c,s,i,j){if(!Array.isArray(c)){c=[c];}c=(i||this.getRecursiveSelection()?this._collectNodesRecursively(c):c).filter(function(v,l,x){return x.indexOf(v)===l;});if(this.getRecursiveSelection()&&!s){c=this._nodeHierarchy._appendAncestors(c);}var k=c.filter(function(l){return this._selectedNodes.has(l)!==s;},this);if(k.length>0){k.forEach(function(l){if(l){this._selectedNodes[s?"add":"delete"](l);if(this._showSelectionBoundingBox){this[s?"_AddBoundingBox":"_RemoveBoundingBox"](l);}}},this);k.forEach(function(l){if(l){this._updateHighlightColor(l,s||this._isAncestorSelected(l));}},this);if(!j){this.fireSelectionChanged({selected:s?k:[],unselected:s?[]:k});}}return this;};r.prototype.setSelectionStates=function(s,c,i,j){if(!Array.isArray(s)){s=[s];}if(!Array.isArray(c)){c=[c];}s=(i||this.getRecursiveSelection()?this._collectNodesRecursively(s):s);c=(i||this.getRecursiveSelection()?this._collectNodesRecursively(c):c);if(this.getRecursiveSelection()){c=this._nodeHierarchy._appendAncestors(c,s);}var k=s.filter(function(v){return this._selectedNodes.has(v)===false;},this);var l=c.filter(function(v){return this._selectedNodes.has(v)===true;},this);if(k.length>0||l.length>0){k.forEach(function(v){this._selectedNodes.add(v);this._updateHighlightColor(v,true);if(this._showSelectionBoundingBox){this._AddBoundingBox(v);}},this);l.forEach(function(v){this._selectedNodes.delete(v);if(this._showSelectionBoundingBox){this._RemoveBoundingBox(v);}},this);l.forEach(function(v){this._updateHighlightColor(v,this._isAncestorSelected(v));},this);if(!j){this.fireSelectionChanged({selected:k,unselected:l});}}return this;};r.prototype.setOutlineColor=function(c){switch(typeof c){case"number":this._outlineColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._outlineColorABGR=f(b(c));}break;default:return this;}this.fireOutlineColorChanged({outlineColor:d(e(this._outlineColorABGR)),outlineColorABGR:this._outlineColorABGR});return this;};r.prototype.getOutlineColor=function(i){return i?this._outlineColorABGR:d(e(this._outlineColorABGR));};r.prototype.getOutliningState=function(c){var i=this._outlinedNodes;function j(k){return i.has(k);}return Array.isArray(c)?c.map(j):j(c);};r.prototype.setOutliningStates=function(c,i,j,k){if(!Array.isArray(c)){c=[c];}if(!Array.isArray(i)){i=[i];}c=(j||this.getRecursiveOutlining()?this._collectNodesRecursively(c):c);i=(j||this.getRecursiveOutlining()?this._collectNodesRecursively(i):i);if(this.getRecursiveOutlining()){i=this._nodeHierarchy._appendAncestors(i,c);}var l=c.filter(function(v){return this._outlinedNodes.has(v)===false;},this);var s=i.filter(function(v){return this._outlinedNodes.has(v)===true;},this);if(l.length>0||s.length>0){l.forEach(function(v){this._outlinedNodes.add(v);},this);s.forEach(function(v){this._outlinedNodes.delete(v);},this);if(!k){this.fireOutliningChanged({outlined:l,unoutlined:s});}}return this;};r.prototype.setOutlineWidth=function(c){this._outlineWidth=c;this._outlineRenderer.setOutlineWidth(c);this.fireOutlineWidthChanged({width:c});return this;};r.prototype.getOutlineWidth=function(){return this._outlineWidth;};r.prototype._collectNodesRecursively=function(c){var i=[],j=this;(Array.isArray(c)?c:[c]).forEach(function l(k){i.push(k);j._nodeHierarchy.enumerateChildren(k,l,false,true);});return i;};r.prototype._getOpacity=function(c){return c.userData.opacity!==undefined?c.userData.opacity:null;};r.prototype.getOpacity=function(c){if(Array.isArray(c)){return c.map(this._getOpacity,this);}else{return this._getOpacity(c);}};r.prototype.setOpacity=function(c,i,j){if(!Array.isArray(c)){c=[c];}var k=Array.isArray(i);if(i==null){i=undefined;}else if(k){i.forEach(function(C,D){if(C==null){i[D]=undefined;}});}var l=[];var s=c;if(!k){l.length=s.length;l.fill(i);}else{l=i;}var v=[];var x=new Set();var y=s.filter(function(C,D){if(x.has(C)){return false;}x.add(C);var y=C?C.userData.opacity!==l[D]:false;if(y){v.push(l[D]);}return y;},this);if(y.length>0){y.forEach(function(C,D){C._vkSetOpacity(v[D],this._jointCollection);},this);var z={changed:y,opacity:k?v:v[0]};this.fireOpacityChanged(z);}return this;};r.prototype._getTintColorABGR=function(c){return c.userData.tintColor!==undefined?c.userData.tintColor:null;};r.prototype._getTintColor=function(c){return c.userData.tintColor!==undefined?d(e(c.userData.tintColor)):null;};r.prototype.getTintColor=function(c,i){var j=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(c)){return c.map(this[j],this);}else{return this[j](c);}};r.prototype.setTintColor=function(c,i,j){if(!Array.isArray(c)){c=[c];}var k=function(E){var F=null;switch(typeof E){case"number":F=E;break;case"string":if(sap.ui.core.CSSColor.isValid(E)){F=f(b(E));}break;default:F=undefined;break;}return F;};var l=Array.isArray(i);var s=[];var v=c;if(j){v=[];c.forEach(function(E,F){var G=this._collectNodesRecursively(E);v=v.concat(G);var I=s.length;s.length=I+G.length;s.fill(l?i[F]:i,I);},this);}else if(!l){s.length=v.length;s.fill(i);}else{s=i;}var x=[];var y=new Set();var z=v.filter(function(E,F){if(y.has(E)){return false;}y.add(E);var z=E?E.userData.tintColor!==k(s[F]):false;if(z){x.push(s[F]);}return z;},this);if(z.length>0){var C=[];z.forEach(function(E,F){var G=k(x[F]);E._vkSetTintColor(G);C.push(G);},this);var D={changed:z,tintColor:l?x:x[0],tintColorABGR:l?C:C[0]};this.fireTintColorChanged(D);}return this;};r.prototype.setHighlightColor=function(c){switch(typeof c){case"number":this._highlightColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._highlightColorABGR=f(b(c));}break;default:return this;}if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(i){this._updateHighlightColor(i,true);},this);}this.fireHighlightColorChanged({highlightColor:d(e(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};r.prototype.getHighlightColor=function(i){return i?this._highlightColorABGR:d(e(this._highlightColorABGR));};r.prototype.getRestTransformationUsingJoint=function(c){var j=this._getJointByChildNode(c);if(j&&j.translation&&j.scale&&j.quaternion){return j;}else{return this.getRestTransformation(c);}};r.prototype.getRelativeTransformation=function(c){var i=function(k){var l=this.getRestTransformation(k);var s=[k.position.x-l.translation[0],k.position.y-l.translation[1],k.position.z-l.translation[2]];var v=new THREE.Quaternion().fromArray(l.quaternion).inverse().premultiply(k.quaternion).toArray();var x=[k.scale.x/l.scale[0],k.scale.y/l.scale[1],k.scale.z/l.scale[2]];return{translation:s,quaternion:v,scale:x};}.bind(this);if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(k){j.push(i(k));});return j;};r.prototype.getTransformationWorld=function(c){var i=function(k){var l=new THREE.Vector3();var s=new THREE.Vector3();var v=new THREE.Quaternion();k.updateMatrixWorld();k.matrixWorld.decompose(l,v,s);return{translation:l.toArray(),quaternion:v.toArray(),scale:s.toArray()};};if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(k){j.push(i(k));});return j;};r.prototype.getTransformation=function(c){var i=function(k){return{translation:this.getTranslation(k),quaternion:this.getRotation(k,R.Quaternion),scale:this.getScale(k)};}.bind(this);if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(k){j.push(i(k));});return j;};r.prototype.getTranslation=function(c){var i=function(k){return k.position.toArray();};if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(k){j.push(i(k));});return j;};r.prototype.getScale=function(c){var i=function(k){return k.scale.toArray();};if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(k){j.push(i(k));});return j;};r.prototype._convertQuaternionToAngleAxis=function(c){if(c.w>1){c.normalize();}if(c.w>0.9999&&c.x<0.0001&&c.y<0.0001&&c.z<0.0001){c.w=1;c.x=0;c.y=0;c.z=0;}var i=2*Math.acos(c.w);var x;var y;var z;var s=Math.sqrt(1-c.w*c.w);if(s<0.0001){x=1;y=0;z=0;}else{x=c.x/s;y=c.y/s;z=c.z/s;}return[x,y,z,i];};r.prototype.getRotation=function(c,i){var j=function(l){var s=l.quaternion;var k;switch(i){case R.AngleAxis:k=this._convertQuaternionToAngleAxis(s);break;case R.Euler:var v=new THREE.Euler();v.setFromQuaternion(s);k=v.toArray();break;default:k=s.toArray();}return k;};if(!Array.isArray(c)){return j(c);}var k=[];c.forEach(function(l){k.push(j(l));});return k;};r.prototype.setTransformation=function(c,i){var j=Array.isArray(c);if(!Array.isArray(c)){c=[c];}var k={changed:[],transformation:[]};var l=function(s){return{position:s.position.toArray(),quaternion:s.quaternion.toArray(),scale:s.scale.toArray()};};if(!i){c.forEach(function(s){if(s.userData.position&&s.userData.quaternion&&s.userData.scale){s.position=s.userData.position;s.quaternion=s.userData.quaternion;s.scale=s.userData.scale;s.updateMatrix();delete s.userData.position;delete s.userData.quaternion;delete s.userData.scale;}k.changed.push(s);k.transformation.push(l(s));},this);}else{if(!Array.isArray(i)){i=[i];}c.forEach(function(s,v){var x=s.userData;if(!x){return;}if(!x.position){x.position=s.position.clone();}if(!x.quaternion){x.quaternion=s.quaternion.clone();}if(!x.scale){x.scale=s.scale.clone();}var y=i[v];if(y.transform){var z=B(y.transform);z.decompose(s.position,s.quaternion,s.scale);}else{s.position.fromArray(y.translation);s.scale.fromArray(y.scale);if(y.quaternion){s.quaternion.fromArray(y.quaternion);}else if(y.angleAxis){var C=new THREE.Vector3(y.angleAxis[0],y.angleAxis[1],y.angleAxis[2]);s.quaternion.setFromAxisAngle(C,y.angleAxis[3]);}else if(y.euler){var D=new THREE.Euler();D.fromArray(y.euler[0],y.euler[1],y.euler[2],y.euler[3]);s.quaternion.setFromEuler(D);}}s.updateMatrix();k.changed.push(s);k.transformation.push(l(s));},this);}if(!j){k.changed=k.changed[0];k.transformation=k.transformation[0];}this.fireTransformationChanged(k);return this;};r.prototype.getJoints=function(){return this._jointCollection;};r.prototype.setJoints=function(j,c){this._jointCollection=[];this._playbackAssociatedWithJoints=null;if(!j){return this;}var i=new Set();var k=new Map();j.forEach(function(s){if(!s.node||!s.parent){return;}i.add(s.node);k.set(s.node,s);});while(i.size>0){var l=i.values().next().value;i.delete(l);var s=k.get(l);var v=[s];var x=[];var y=s.parent;while(y){s=k.get(y);if(s!==undefined){if(i.delete(y)){v.push(s);}if(x.length>0){s.nodesToUpdate=s.nodesToUpdate||[];while(x.length>0){var z=x.pop();if(s.nodesToUpdate.indexOf(z)>=0){break;}s.nodesToUpdate.push(z);}}x.length=0;y=s.parent;}else{x.push(y);y=y.parent;}}while(v.length>0){this._jointCollection.push(v.pop());}}if(this._jointCollection&&this._jointCollection.length>0){this._playbackAssociatedWithJoints=c;this._jointCollection.forEach(function(s){if(!s.node||!s.parent){return;}s.translation=null;s.scale=null;s.quaternion=null;s.opacity=null;if(s.node.userData){s.node.userData.offsetTranslation=null;s.node.userData.offsetQuaternion=null;s.node.userData.offsetScale=null;s.node.userData.originalRotationType=null;s.node.userData.offsetOpacity=null;}});this._jointCollection.forEach(function(s){this._updateJointNode(s,this._playbackAssociatedWithJoints);}.bind(this));}return this;};r.prototype._updateJointNode=function(j,c){if(!j.node||!j.parent){return;}if(j.translation&&j.quaternion&&j.scale&&j.opacity){return;}var i=new Map();if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(j){if(!j.node||!j.parent){return;}i.set(j.node,j);});}var k,s,l,v,x,y;var z=j.node;var C=new THREE.Matrix4();var D,E=1;while(z){y=this.getRestOpacity(z);x=this.getRestTransformation(z);if(!x){z=z.parent;continue;}k=new THREE.Vector3(x.translation[0],x.translation[1],x.translation[2]);s=new THREE.Vector3(x.scale[0],x.scale[1],x.scale[2]);l=new THREE.Quaternion(x.quaternion[0],x.quaternion[1],x.quaternion[2],x.quaternion[3]);D=y;if(c){var F=this._getEndPropertyInPreviousPlayback(z,A.Translate,c,true);if(F){k.x+=F[0];k.y+=F[1];k.z+=F[2];}var G=this._getEndPropertyInPreviousPlayback(z,A.Scale,c,true);if(G){s.x*=G[0];s.y*=G[1];s.z*=G[2];}var I=this._getEndPropertyInPreviousPlayback(z,A.Rotate,c,true);if(I){var J=new THREE.Quaternion(I[0],I[1],I[2],I[3]);l=J.multiply(l);}var K=this._getEndPropertyInPreviousPlayback(z,A.Opacity,c,true);if(K!=null){D*=K;}}v=new THREE.Matrix4().compose(k,l,s);C.premultiply(v);E*=D;z=z.parent;}var L=j.parent;var P=new THREE.Matrix4();var M=1;while(L){var Q=i.get(L);if(Q){if(!Q.translation){this._updateJointNode(Q);}k=new THREE.Vector3(Q.translation[0],Q.translation[1],Q.translation[2]);s=new THREE.Vector3(Q.scale[0],Q.scale[1],Q.scale[2]);l=new THREE.Quaternion(Q.quaternion[0],Q.quaternion[1],Q.quaternion[2],Q.quaternion[3]);D=Q.opacity;L=Q.parent;}else{y=this.getRestOpacity(L);x=this.getRestTransformation(L);if(!x){L=L.parent;continue;}k=new THREE.Vector3(x.translation[0],x.translation[1],x.translation[2]);s=new THREE.Vector3(x.scale[0],x.scale[1],x.scale[2]);l=new THREE.Quaternion(x.quaternion[0],x.quaternion[1],x.quaternion[2],x.quaternion[3]);D=y;if(c){var U=this._getEndPropertyInPreviousPlayback(L,A.Translate,c,true);if(U){k.x+=U[0];k.y+=U[1];k.z+=U[2];}var W=this._getEndPropertyInPreviousPlayback(L,A.Scale,c,true);if(W){s.x*=W[0];s.y*=W[1];s.z*=W[2];}var X=this._getEndPropertyInPreviousPlayback(L,A.Rotate,c,true);if(X){var Y=new THREE.Quaternion(X[0],X[1],X[2],X[3]);l=Y.multiply(l);}var Z=this._getEndPropertyInPreviousPlayback(L,A.Opacity,c,true);if(Z!=null){D*=Z;}}L=L.parent;}v=new THREE.Matrix4().compose(k,l,s);P.premultiply(v);M*=D;}var $=P.getInverse(P).multiply(C);$.decompose(k,l,s);j.translation=k.toArray();j.quaternion=l.toArray();j.scale=s.toArray();var _=function(a1,b1){if(a1===b1){return 1;}else if(Math.abs(b1)<0.0001){return 1;}return a1/b1;};j.opacity=_(E,M);};r.prototype._propagateOpacityToJointChildren=function(c,i){if(!c||!i||c.length!==i.length){return this;}if(!this._jointCollection||!this._jointCollection.length){return this;}var j=new Map();this._jointCollection.forEach(function(l){var s=j.get(l.parent);if(!s){s=[];j.set(l.parent,s);}s.push(l);});var k=function(l,s){if(l.opacity!=null&&l.node&&l.node.userData){l.node.userData.opacity=l.opacity*s;if(l.node.userData.offsetOpacity!=null){l.node.userData.opacity*=l.node.userData.offsetOpacity;}}};c.forEach(function(l,s){var v=j.get(l);if(v){v.forEach(function(x){k(x,i[s]);});}});return this;};r.prototype._updateMaterialInNode=function(c){var j=c.target;for(var i=0,l=j.children.length;i<l;i++){var k=j.children[i];if(k.userData.animatedColor){k._vkUpdateMaterialColor();}}var s=c.materialId;if(j.userData.materialId!==s){j.userData.materialId=s;this._scene._setNodeMaterial(j,s);}};r.prototype.getSymbolNodes=function(c){var v=this.getCurrentView()||this._scene.getViews()[0];var s=v?v.getNodeInfos().reduce(function(i,j){if(j.target._vkGetNodeContentType()===p.Symbol&&j.target.parent){if(!c||c===j.target.userData.treeNode.sid){i.push(j.target);}}return i;},[]):[];return s;};var w={"sphere":"360Image","plane":"2DImage"};r.prototype._getBackgroundNodeInfos=function(){var c=null,j=[];function k(s){if(s.visible){if(s._vkGetNodeContentType()===p.Background&&w[s.name]){c=s;return;}var v=s.children;for(var i=0,l=v.length;i<l&&c===null;i++){k(v[i]);}}}k(this._scene.getSceneRef());if(c){j=c.parent.children.filter(function(i){return i._vkGetNodeContentType()===p.Background;});}return{current:c,all:j};};r.prototype.getBackgroundImageType=function(){var c=this._getBackgroundNodeInfos().current;return c?w[c.name]:null;};r.prototype.setBackgroundImageType=function(i){var c={"sphere":"360Image","plane":"2DImage"};var j=this._getBackgroundNodeInfos();var k=j.all.find(function(l){return i===c[l.name];});if(k&&!this.getVisibilityState(k)){if(j.current){j.current.visible=false;}k.visible=true;this.setVisibilityState(j.all,false,false);this.setVisibilityState(k,true,false);}return k;};function B(c){return new THREE.Matrix4().set(c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7],c[8],c[9],c[10],c[11],0,0,0,1);}r.prototype._resetNodesStatusByCurrenView=function(v,s,c){var i=this.getNodeHierarchy();if(i){var j;if(v){j=v.getPlaybacks();}var k=v.getNodeInfos();if(k){this._nodesTransitionHelper.clear();var l={nodeRefs:[],positions:[]};var x=new THREE.Vector3();var y=new THREE.Quaternion();var z=new THREE.Vector3();k.forEach(function(E){if(E.target===null){return;}if(E.transform){var F=B(E.transform);if(!o.equalMatrices(F,E.target.matrix,1e-6)){if((!j||!j.length)&&c){var G=i.createNodeProxy(E.target);this._nodesTransitionHelper.setNodeForDisplay(G,F);}else{F.decompose(x,y,z);l.nodeRefs.push(E.target);l.positions.push({translation:x.toArray(),quaternion:y.toArray(),scale:z.toArray()});}}}else if(E[A.Scale]&&E[A.Rotate]&&E[A.Translate]){l.nodeRefs.push(E.target);l.positions.push({translation:E[A.Translate].slice(),quaternion:E[A.Rotate].slice(),scale:E[A.Scale].slice()});}}.bind(this));if(v.userData&&v.userData.nodeStartDataByAnimation){v.userData.nodeStartDataByAnimation.forEach(function(E,F){if(E[A.Translate]&&E[A.Rotate]&&E[A.Scale]){l.nodeRefs.push(F);l.positions.push({translation:E[A.Translate].slice(),quaternion:E[A.Rotate].slice(),scale:E[A.Scale].slice()});}},this);}if(l.nodeRefs.length){this.setTransformation(l.nodeRefs,l.positions);}if(s){var C=[];var D=[];k.forEach(function(E){if(!E.target.userData.skipIt){(E.visible?C:D).push(E.target);}});this.setVisibilityState(i.getChildren()[0].children,false,true);if(this.getSymbolNodes().length){this.getSymbolNodes().forEach(function(E){E.traverse(function(F){F.visible=true;});});}this.setVisibilityState(C,true,false);this.setVisibilityState(D,false,false);this._startViewChangeNodeTransition();}}}};r.prototype._startViewChangeNodeTransition=function(){this._nodesTransitionHelper.startDisplay(500);var c=true;this._nodesTransitionHelper.attachEventOnce("displayed",function(){c=false;});var i=function(){if(c){this._nodesTransitionHelper.displayNodesMoving();window.requestAnimationFrame(i);}}.bind(this);window.requestAnimationFrame(i);};r.prototype._resetNodesMaterialAndOpacityByCurrenView=function(v){if(!v){return;}var c=v.getNodeInfos();if(c){c.forEach(function(j){if(!j.target){return;}this._updateMaterialInNode(j);}.bind(this));c.forEach(function(j){if(!j.target||!j.target.userData){return;}j.target.userData.opacity=j.opacity;});var i=this._scene.getSceneRef();i._vkSetOpacity(undefined,this._jointCollection);}this._selectedNodes.forEach(function(j){this._updateHighlightColor(j);}.bind(this));};r.prototype._onActivateView=function(c,i,j){var v=this.getViewManager();if(!v||j.source.getId()!==v){return;}this.activateView(j.view,false,j.playViewGroup,j.notAnimateCameraChange);};r.prototype.activateView=function(v,i,c,j){this.fireViewStateApplying({view:v});this.setJoints(undefined);this._resetNodesMaterialAndOpacityByCurrenView(v);this._prepareTransition(v);this._resetNodesStatusByCurrenView(v,true,true);this._highlightPlayer.reset(v,this._scene);this.fireViewStateApplied({view:v,ignoreAnimationPosition:i,notAnimateCameraChange:j,playViewGroup:c});a.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:v,ignoreAnimationPosition:i,notAnimateCameraChange:j,playViewGroup:c});return this;};r.prototype.setHighlightDisplayState=function(s){if(s===h.playing){this._highlightPlayer.start(Date.now());}else if(s===h.stopped){this._highlightPlayer.stop();}else if(s===h.pausing){this._highlightPlayer.pause(Date.now());}this.fireHighlightColorChanged({highlightColor:d(e(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};r.prototype._startHighlight=function(){this._highlightPlayer.start(Date.now());return this;};r.prototype._playHighlight=function(){return this._highlightPlayer.play(Date.now());};r.prototype._prepareTransition=function(v){this._transitionPlayer.reset();this._transitionPlayer.fadeInNodes=[];this._transitionPlayer.fadeOutNodes=[];this._fadeInBackground=null;this._fadeOutBackground=null;var c=v.getNodeInfos();if(!c){return;}var i=new Set();var j=new Set();c.forEach(function(y){(y.visible?i:j).add(y.target);});var k=this._transitionPlayer.fadeInNodes;var l=this._transitionPlayer.fadeOutNodes;var s=this._nodeHierarchy;var x=function(y,z,C){if(!y.userData.skipIt){z=z&&i.has(y);C=C&&y.visible;}if(y.geometry&&z!==C){if(y.parent&&y.parent.userData.symbolContent){y.renderOrder=2;}(z?k:l).push(y);}if(y._vkGetNodeContentType()===p.Background){if(z){this._fadeInBackground=y;}else if(C){this._fadeOutBackground=y;}}y.children.forEach(function(D){x(D,z,C);});}.bind(this);s.getChildren()[0].children.forEach(function(y){x(y,true,true);});if(this._fadeInBackground){this._fadeInBackground.traverse(function(y){if(y.material){y.renderOrder=-2;}});}if(this._fadeOutBackground){this._fadeOutBackground.traverse(function(y){if(y.material){y.renderOrder=1;}});}};r.prototype._startTransition=function(c){var i=this._transitionPlayer.fadeInNodes;var j=this._transitionPlayer.fadeOutNodes;if(i&&i.length){var k=new m("FadeIn",{duration:c/500.0,opacities:[0.0,1.0],cycles:1});this._transitionPlayer.addHighlights(k,i);}if(j&&j.length){var l=new m("FadeOut",{duration:c/500.0,opacities:[1.0,0.0],cycles:1,fadeOut:true});this._transitionPlayer.addHighlights(l,j);}if((i&&i.length)||(j&&j.length)){this._transitionPlayer.start(Date.now());this._transitionPlayer.play(Date.now());return c;}return 0;};r.prototype._playTransition=function(){return this._transitionPlayer.play(Date.now());};r.prototype.updateRestTransformation=function(c){var i=this.getCurrentView();if(!i){return this;}var j=i.getNodeInfos();if(j){j.forEach(function(k){if(k.target!==c){return;}c.updateMatrix();var l=c.matrix.elements;var v=[l[0],l[4],l[8],l[12],l[1],l[5],l[9],l[13],l[2],l[6],l[10],l[14]];k.transform=v;});}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c||k.node===c){k.translation=null;k.scale=null;k.quaternion=null;if(k.node.userData){k.node.userData.offsetTranslation=null;k.node.userData.offsetQuaternion=null;k.node.userData.offsetScale=null;k.node.userData.originalRotationType=null;}}});this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c){this._updateJointNode(k,this._playbackAssociatedWithJoints);this.restoreRestTransformation(k.node);}}.bind(this));this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.node===c){this._updateJointNode(k,this._playbackAssociatedWithJoints);}},this);if(this._playbackAssociatedWithJoints){var s=this._playbackAssociatedWithJoints.getSequence();if(s){s._fireSequenceChanged();}}}return this;};r.prototype.restoreRestTransformation=function(c){var i=this.getCurrentView();if(!i){return this;}var j=i.getNodeInfos();if(j){j.forEach(function(l){if(l.target!==c){return;}if(l.transform){var s=B(l.transform);s.decompose(c.position,c.quaternion,c.scale);}else if(l[A.Scale]&&l[A.Rotate]&&l[A.Translate]){c.position.set(l[A.Translate][0],l[A.Translate][1],l[A.Translate][2]);c.quaternion.set(l[A.Rotate][0],l[A.Rotate][1],l[A.Rotate][2],l[A.Rotate][3]);c.scale.set(l[A.Scale][0],l[A.Scale][1],l[A.Scale][2]);}c.updateMatrix();});}var k={changed:[c],transformation:[{position:c.position.toArray(),quaternion:c.quaternion.toArray(),scale:c.scale.toArray()}]};this.fireTransformationChanged(k);return this;};r.prototype.setRestTransformation=function(c,i,j,s){var k=this.getCurrentView();if(!k){return this;}var l=k.getNodeInfos();if(l){l.forEach(function(x){if(x.target!==c){return;}if(!i||!j||!s){if(x.transform){var y=new THREE.Vector3();var z=new THREE.Quaternion();var C=new THREE.Vector3();var D=B(x.transform);D.decompose(y,z,C);if(!i){i=[y.x,y.y,y.z];}if(!s){s=[C.x,C.y,C.z];}if(!j){j=[z.x,z.y,z.z,z.w];}}else if(x[A.Scale]&&x[A.Rotate]&&x[A.Translate]){if(!i){i=x[A.Translate].slice();}if(!s){s=x[A.Scale].slice();}if(!j){j=x[A.Rotate].slice();}}}var E=new THREE.Vector3(i[0],i[1],i[2]);var F=new THREE.Quaternion(j[0],j[1],j[2],j[3]);var G=new THREE.Vector3(s[0],s[1],s[2]);var I=new THREE.Matrix4();I.compose(E,F,G);var J=I.elements;x.transform=[J[0],J[4],J[8],J[12],J[1],J[5],J[9],J[13],J[2],J[6],J[10],J[14]];});}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(x){if(!x.node||!x.parent){return;}if(x.parent===c||x.node===c){x.translation=null;x.scale=null;x.quaternion=null;if(x.node.userData){x.node.userData.offsetTranslation=null;x.node.userData.offsetQuaternion=null;x.node.userData.offsetScale=null;x.node.userData.originalRotationType=null;}}});this._jointCollection.forEach(function(x){if(!x.node||!x.parent){return;}if(x.parent===c){this._updateJointNode(x,this._playbackAssociatedWithJoints);this.restoreRestTransformation(x.node);}},this);this._jointCollection.forEach(function(x){if(!x.node||!x.parent){return;}if(x.node===c){this._updateJointNode(x,this._playbackAssociatedWithJoints);}},this);if(this._playbackAssociatedWithJoints){var v=this._playbackAssociatedWithJoints.getSequence();if(v){v._fireSequenceChanged();}}}return this;};r.prototype.getRestOpacity=function(c){var j;var k=this.getCurrentView();if(k){j=k.getNodeInfos();}var l=1;if(j&&j.length){for(var i=0;i<j.length;i++){var s=j[i];if(s.target!==c){continue;}if(s.opacity!==undefined&&s.opacity!==null){l=s.opacity;}break;}}return l;};r.prototype.setRestOpacity=function(c,i){var j;var k=this.getCurrentView();if(k){j=k.getNodeInfos();}if(j){j.forEach(function(l){if(l.target!==c){return;}l.opacity=i;});}return this;};r.prototype.restoreRestOpacity=function(c){var i;var j=this.getCurrentView();if(j){i=j.getNodeInfos();}if(i){i.forEach(function(k){if(k.target!==c){return;}var l=1;if(k.opacity!==undefined){l=k.opacity;}this.setOpacity(c,l);}.bind(this));}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c||k.node===c){k.opacity=null;if(k.node.userData){k.node.userData.offsetOpacity=null;}}});this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c){this._updateJointNode(k,this._playbackAssociatedWithJoints);this.restoreRestOpacity(k.node);}},this);this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.node===c){this._updateJointNode(k,this._playbackAssociatedWithJoints);}},this);if(this._playbackAssociatedWithJoints){var s=this._playbackAssociatedWithJoints.getSequence();if(s){s._fireSequenceChanged();}}}return this;};r.prototype.updateRestOpacity=function(c){var i;var j=this.getCurrentView();if(j){i=j.getNodeInfos();}if(i){i.forEach(function(k){if(k.target!==c){return;}if(c.userData&&c.userData.opacity!==undefined&&c.userData.opacity!==null){k.opacity=c.userData.opacity;}else{delete k.opacity;}});}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c||k.node===c){k.opacity=null;if(k.node.userData){k.node.userData.offsetOpacity=null;}}});this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.node===c){this._updateJointNode(k,this._playbackAssociatedWithJoints);}},this);if(this._playbackAssociatedWithJoints){var s=this._playbackAssociatedWithJoints.getSequence();if(s){s._fireSequenceChanged();}}}return this;};r.prototype.getRestTransformationWorld=function(c){var j;var k=this.getCurrentView();if(k){j=k.getNodeInfos();}var l;if(j){var s=new THREE.Matrix4();while(c){for(var i=0;i<j.length;i++){var v=j[i];if(v.target!==c){continue;}var x;if(v.transform){x=B(v.transform);}else if(v[A.Scale]&&v[A.Rotate]&&v[A.Translate]){var y=new THREE.Vector3(v[A.Translate][0],v[A.Translate][1],v[A.Translate][2]);var z=new THREE.Quaternion(v[A.Rotate][0],v[A.Rotate][1],v[A.Rotate][2],v[A.Rotate][3]);var C=new THREE.Vector3(v[A.Scale][0],v[A.Scale][1],v[A.Scale][2]);x=new THREE.Matrix4().compose(y,z,C);}if(x){s.premultiply(x);}break;}c=c.parent;}var D=new THREE.Vector3();var E=new THREE.Quaternion();var F=new THREE.Vector3();s.decompose(D,E,F);l={};l.translation=D.toArray();l.quaternion=E.toArray();l.scale=F.toArray();}if(!l){l=this.getTransformationWorld(c);}return l;};r.prototype.getRestTransformation=function(c){var i;var j=this.getCurrentView();if(j){i=j.getNodeInfos();}var k;if(i){i.forEach(function(l){if(l.target!==c){return;}if(l.transform){var s=new THREE.Vector3();var v=new THREE.Quaternion();var x=new THREE.Vector3();var y=B(l.transform);y.decompose(s,v,x);k={};k.translation=s.toArray();k.quaternion=v.toArray();k.scale=x.toArray();}else if(l[A.Scale]&&l[A.Rotate]&&l[A.Translate]){k={};k.translation=l[A.Translate].slice();k.quaternion=l[A.Rotate].slice();k.scale=l[A.Scale].slice();}});}if(!k&&c){k={};k.translation=c.userData.position?c.userData.position.toArray():c.position.toArray();k.quaternion=c.userData.quaternion?c.userData.quaternion.toArray():c.quaternion.toArray();k.scale=c.userData.scale?c.userData.scale.toArray():c.scale.toArray();k.matrix=c.matrix.clone();}return k;};r.prototype._addToTransformation=function(c,j,k,s,l,v){var x={};var i;if(j){x.translation=[];for(i=0;i<3;i++){x.translation.push(j[i]+c.translation[i]);}}else{x.translation=c.translation;}if(s){x.scale=[];for(i=0;i<3;i++){x.scale.push(s[i]*c.scale[i]);}}else{x.scale=c.scale;}if(k){var y=new THREE.Quaternion(c.quaternion[0],c.quaternion[1],c.quaternion[2],c.quaternion[3]);var z=new THREE.Quaternion(k[0],k[1],k[2],k[3]);if(l===R.Euler){var C=v?v[3]:6;var D=o.threeQuatToNeutralEuler(y,C);var E=v?v:o.threeQuatToNeutralEuler(z,C);D[0]+=E[0];D[1]+=E[1];D[2]+=E[2];x.quaternion=o.glMatrixQuatToNeutral(o.neutralEulerToGlMatrixQuat(D));}else{var F=new THREE.Matrix4().makeRotationFromQuaternion(y);var G=new THREE.Matrix4().makeRotationFromQuaternion(z);F.premultiply(G);y.setFromRotationMatrix(F);x.quaternion=[y.x,y.y,y.z,y.w];}}else{x.quaternion=c.quaternion;}return x;};r.prototype.setInterpolatedRelativeValues=function(c,v){if(!c.userData){c.userData={};}if(v.rtranslate){c.userData.offsetTranslation=v.rtranslate;}else{c.userData.offsetTranslation=null;}if(v.rscale){c.userData.offsetScale=v.rscale;}else{c.userData.offsetScale=null;}if(v.rrotate){c.userData.offsetQuaternion=v.rrotate;c.userData.originalRotationType=v.originalRotationType;}else{c.userData.offsetQuaternion=null;c.userData.originalRotationType=null;}if(v.Euler){c.userData.Euler=v.Euler;}else{c.userData.Euler=null;}if(v.ropacity!=null){c.userData.offsetOpacity=v.ropacity;}else{c.userData.offsetOpacity=null;}return this;};r.prototype._setJointNodeMatrix=function(){if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(j){if(!j.node||!j.parent){return;}var c=j.node;if(c.userData.skipUpdateJointNode){return;}var i={};i.translation=j.translation.slice();i.scale=j.scale.slice();i.quaternion=j.quaternion.slice();var k=this._addToTransformation(i,c.userData.offsetTranslation,c.userData.offsetQuaternion,c.userData.offsetScale,c.userData.originalRotationType,c.userData.Euler);c.position.fromArray(k.translation);c.scale.fromArray(k.scale);c.quaternion.fromArray(k.quaternion);c.updateMatrix();var l=c.quaternion.clone();var s=new THREE.Matrix4();if(j.parent){j.parent.updateMatrixWorld();s=j.parent.matrixWorld.clone();c.matrixWorld.multiplyMatrices(j.parent.matrixWorld,c.matrix);}else{c.matrixWorld.copy(c.matrix);}var v=new THREE.Matrix4();if(c.parent){v=c.parent.matrixWorld.clone();c.matrix.getInverse(c.parent.matrixWorld).multiply(c.matrixWorld);}else{c.matrix.copy(c.matrixWorld);}c.matrix.decompose(c.position,c.quaternion,c.scale);var x=[c.scale.x,c.scale.y,c.scale.z];this._adjustQuaternionAndScale(s,v,l,c.quaternion,k.scale,x);c.scale.x=x[0];c.scale.y=x[1];c.scale.z=x[2];if(j.nodesToUpdate){j.nodesToUpdate.forEach(function(y){if(y.matrixAutoUpdate){y.updateMatrix();}y.matrixWorld.multiplyMatrices(y.parent.matrixWorld,y.matrix);});}}.bind(this));}};r.prototype._getEndPropertyInLastPlayback=function(c,i){var j;var l=this.getCurrentView();if(!l){return j;}var s=l.getPlaybacks();if(!s||!s.length){return j;}for(var k=s.length-1;k>=0;k--){var v=s[k];var x=v.getSequence();if(x._convertedFromAbsolute){return j;}j=v.getNodeBoundaryProperty(c,i,true);if(j){break;}}return j;};r.prototype._getEndPropertyInPreviousPlayback=function(c,k,l,s){var v;var x=this._getJointByChildNode(c);if(x&&!s){return v;}var y=l.getSequence();if(y&&y._convertedFromAbsolute){return v;}var z=this.getCurrentView();if(!z){return v;}var C=z.getPlaybacks();for(var i=1;i<C.length;i++){var D=C[i];if(D!==l){continue;}for(var j=i-1;j>=0;j--){var E=C[j];v=E.getNodeBoundaryProperty(c,k,true);if(v){break;}}}return v;};r.prototype._convertTracksToRelative=function(s,c){if((c&&s._convertionDoneForReversed)||(!c&&s._convertionDone)){return this;}s._convertedFromAbsolute=false;var l=this.getCurrentView();if(!l){return this;}var v=s.getNodeAnimation();if(!v||!v.length){return this;}var x=l.getNodeInfos();if(x){x.forEach(function(y){var z;for(var i=0;i<v.length;i++){if(y.target===v[i].nodeRef){z=v[i];break;}}if(!z){return;}var C=[0,0,0];var D=[1,1,1];var E=new THREE.Quaternion();var F=new THREE.Vector3();var G=new THREE.Vector3();if(y.transform){var I=B(y.transform);I.decompose(F,E,G);C=F.toArray();D=G.toArray();}else if(y[A.Scale]&&y[A.Rotate]&&y[A.Translate]){C=y[A.Translate].slice();E=new THREE.Quaternion(y[A.Rotate][0],y[A.Rotate][1],y[A.Rotate][2],y[A.Rotate][3]);D=y[A.Scale].slice();}else{y.target.matrix.decompose(F,E,G);C=F.toArray();D=G.toArray();}var j,J,K,L;var M=z[A.Translate];if(M&&M.getIsAbsoluteValue()){J=M.getKeysCount();for(j=0;j<J;j++){K=M.getKey(j);L=[K.value[0]-C[0],K.value[1]-C[1],K.value[2]-C[2]];M.updateKey(j,L,true);}M.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var P=z[A.Scale];if(P&&P.getIsAbsoluteValue()){J=P.getKeysCount();for(j=0;j<J;j++){K=P.getKey(j);L=[K.value[0]/D[0],K.value[1]/D[1],K.value[2]/D[2]];P.updateKey(j,L,true);}P.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var Q=z[A.Opacity];if(Q&&Q.getIsAbsoluteValue()){var U=this.getRestOpacity(y.target);if(!U){U=1.0;}J=Q.getKeysCount();for(j=0;j<J;j++){K=Q.getKey(j);L=K.value/U;Q.updateKey(j,L,true);}Q.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var W=z[A.Rotate];if(W&&W.getIsAbsoluteValue()){var X;var Y=new THREE.Matrix4().makeRotationFromQuaternion(E);var Z=new THREE.Matrix4().getInverse(Y);var $=new THREE.Matrix4();var _=new THREE.Matrix4();J=W.getKeysCount();var a1=W.getKeysType();for(j=0;j<J;j++){K=W.getKey(j);if(a1===n.Quaternion){X=new THREE.Quaternion(K.value[0],K.value[1],K.value[2],K.value[3]);$.makeRotationFromQuaternion(X);_.multiplyMatrices($,Z);X.setFromRotationMatrix(_);L=X.toArray();W.updateKey(j,L,true);}else if(a1===n.Euler){var k=K.value;var e0=o.threeQuatToNeutralEuler(E,k[3]);L=[k[0]-e0[0]+o.getModulatedAngularValue(k[0]),k[1]-e0[1]+o.getModulatedAngularValue(k[1]),k[2]-e0[2]+o.getModulatedAngularValue(k[2]),k[3]];W.updateKey(j,L,true);}else if(j===0){var c1=new THREE.Vector3(K.value[0],K.value[1],K.value[2]);$.makeRotationAxis(c1,K.value[3]);_.multiplyMatrices($,Z);X=new THREE.Quaternion().setFromRotationMatrix(_);L=this._convertQuaternionToAngleAxis(X);W.updateKey(j,L,true);break;}}W.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}}.bind(this));}if(!c){s._convertionDone=true;s._convertionDoneForReversed=false;}else{s._convertionDone=false;s._convertionDoneForReversed=true;}return this;};r.prototype._getTrackKeys=function(c){var k=[];var i=c.getKeysCount();for(var j=0;j<i;j++){var l=c.getKey(j);var v;if(Array.isArray(l.value)){v=l.value.slice();}else{v=l.value;}k.push({time:l.time,value:v});}return k;};r.prototype._setJointNodeOffsets=function(c,i){var j=this._getJointByChildNode(c);if(j){var k=new THREE.Matrix4();if(c.parent){k=c.parent.matrixWorld.clone();}var l=new THREE.Matrix4();c.updateMatrixWorld();var s=new THREE.Matrix4();if(j.parent){j.parent.updateMatrixWorld();s=j.parent.matrixWorld.clone();l.getInverse(j.parent.matrixWorld).multiply(c.matrixWorld);}else{l.copy(c.matrixWorld);}var v=new THREE.Vector3();var x=new THREE.Vector3();var y=new THREE.Quaternion();l.decompose(v,y,x);if(i===A.Translate){var z=v.toArray();c.userData.offsetTranslation=[z[0]-j.translation[0],z[1]-j.translation[1],z[2]-j.translation[2]];}else if(i===A.Scale){var C=x.toArray();this._adjustQuaternionAndScale(k,s,c.quaternion,y,c.scale.toArray(),C);c.userData.offsetScale=[C[0]/j.scale[0],C[1]/j.scale[1],C[2]/j.scale[2]];}else{this._adjustQuaternionAndScale(k,s,c.quaternion,y,c.scale.toArray(),x.toArray());var D=new THREE.Quaternion(j.quaternion[0],j.quaternion[1],j.quaternion[2],j.quaternion[3]);var E=new THREE.Matrix4().makeRotationFromQuaternion(D);var F=new THREE.Matrix4().getInverse(E);var M=new THREE.Matrix4().makeRotationFromQuaternion(y);var G=new THREE.Matrix4().multiplyMatrices(M,F);var I=new THREE.Quaternion().setFromRotationMatrix(G);c.userData.offsetQuaternion=I.toArray();}}return this;};r.prototype.setTranslationKey=function(c,i,j,k){var s=j.getSequence();if(!s){return null;}var l;var v=new THREE.Vector3();c.matrix.decompose(v,new THREE.Quaternion(),new THREE.Vector3());var x=this._getJointByChildNode(c);if(x){l=x.translation.slice();c.updateMatrixWorld();var y=new THREE.Matrix4();if(x.parent){x.parent.updateMatrixWorld();y.getInverse(x.parent.matrixWorld).multiply(c.matrixWorld);}else{y.matrix.copy(c.matrixWorld);}y.decompose(v,new THREE.Quaternion(),new THREE.Vector3());}else{var z=this.getRestTransformation(c);l=z.translation;}var C=v.toArray();var D=[C[0]-l[0],C[1]-l[1],C[2]-l[2]];var E=this._getEndPropertyInPreviousPlayback(c,A.Translate,j);if(E){D[0]-=E[0];D[1]-=E[1];D[2]-=E[2];}var F=s.getNodeAnimation(c,A.Translate);var G;if(!F){F=this._scene.createTrack(null,{trackValueType:n.Vector3,isAbsoluteValue:false});s.setNodeAnimation(c,A.Translate,F,true);}else{G=this._getTrackKeys(F);}F.insertKey(i,D,k);var I=this._getTrackKeys(F);return{KeyValue:D,absoluteValue:C,offset:E,PreviousTrack:G,CurrentTrack:I};};r.prototype._adjustQuaternionAndScale=function(c,j,k,l,s,x){function y(v,U,W,X){var Y=Math.abs(v.dot(U));var Z=Math.abs(v.dot(W));var $=Math.abs(v.dot(X));if(Y>=Z&&Y>=$){return 0;}else if(Z>=Y&&Z>=$){return 1;}else{return 2;}}if(s[0]>0&&s[1]>0&&s[2]>0){return;}var z=c.clone().multiply(new THREE.Matrix4().makeRotationFromQuaternion(k));var C=new THREE.Matrix4().makeRotationFromQuaternion(l);var D=j.clone().multiply(C);var E=new THREE.Vector3();var F=new THREE.Vector3();var G=new THREE.Vector3();z.extractBasis(E,F,G);var I=[E,F,G];var J=new THREE.Vector3();var K=new THREE.Vector3();var L=new THREE.Vector3();D.extractBasis(J,K,L);var M=[1,1,1];for(var i=0;i<3;i++){var P=y(I[i],J,K,L);if(s[i]*x[P]<0){M[P]=-1;x[P]=-x[P];}}C.scale(new THREE.Vector3(M[0],M[1],M[2]));var Q=new THREE.Quaternion().setFromRotationMatrix(C);l.x=Q.x;l.y=Q.y;l.z=Q.z;l.w=Q.w;};r.prototype.setScaleKey=function(c,i,j,k){var s=j.getSequence();if(!s){return null;}var l;var v=c.scale.toArray();var x=c.quaternion.clone();var y=this._getJointByChildNode(c);if(y){var z=new THREE.Matrix4();if(c.parent){z=c.parent.matrixWorld.clone();}l=y.scale.slice();c.updateMatrixWorld();var C=new THREE.Matrix4();var D=new THREE.Matrix4();if(y.parent){y.parent.updateMatrixWorld();D=y.parent.matrixWorld.clone();C.getInverse(y.parent.matrixWorld).multiply(c.matrixWorld);}else{C.copy(c.matrixWorld);}var E=new THREE.Quaternion();var F=new THREE.Vector3();C.decompose(new THREE.Vector3(),E,F);var G=F.toArray();this._adjustQuaternionAndScale(z,D,x,E,v,G);v=G;}else{var I=this.getRestTransformation(c);l=I.scale;}var J=[v[0]/l[0],v[1]/l[1],v[2]/l[2]];var K=this._getEndPropertyInPreviousPlayback(c,A.Scale,j);if(K){J[0]/=K[0];J[1]/=K[1];J[2]/=K[2];}var L=s.getNodeAnimation(c,A.Scale);var M;if(!L){L=this._scene.createTrack(null,{trackValueType:n.Vector3,isAbsoluteValue:false});s.setNodeAnimation(c,A.Scale,L,true);}else{M=this._getTrackKeys(L);}L.insertKey(i,J,k);var P=this._getTrackKeys(L);return{KeyValue:J,absoluteValue:v,offset:K,PreviousTrack:M,CurrentTrack:P};};r.prototype.setRotationKey=function(c,i,j,k,l){var s=k.getSequence();if(!s){return null;}var v=36;var x=[j[0],j[1],j[2],v];var y=s.getNodeAnimation(c,A.Rotate);if(y&&y.getKeysType()!==n.Euler){return null;}var z;if(!y){y=this._scene.createTrack(null,{trackValueType:n.Euler,isAbsoluteValue:false});s.setNodeAnimation(c,A.Rotate,y,true);}else{z=this._getTrackKeys(y);}y.insertKey(i,x,l);var C=this._getTrackKeys(y);var D=new THREE.Quaternion();var E=new THREE.Euler(j[0],j[1],j[2]);D.setFromEuler(E);var F=this._getEndPropertyInPreviousPlayback(c,A.Rotate,k);if(F){var G=new THREE.Quaternion(F[0],F[1],F[2],F[3]);D.multiply(G);}var I=this._getJointByChildNode(c);var J=new THREE.Quaternion();if(I){J.fromArray(I.quaternion);}else{var K=this.getRestTransformation(c);J.fromArray(K.quaternion);}D.multiply(J);return{KeyValue:x,absoluteValue:D.toArray(),offset:F,PreviousTrack:z,CurrentTrack:C};};r.prototype.setAxisAngleRotationKey=function(c,i,j,k,l){var s=k.getSequence();if(!s){return null;}var v=s.getNodeAnimation(c,A.Rotate);if(v&&v.getKeysType()!==n.AngleAxis){if(!v.setKeysType(n.AngleAxis)){return null;}}var x=[j[0],j[1],j[2],j[3]];var y;if(!v){v=this._scene.createTrack(null,{trackValueType:n.AngleAxis,isAbsoluteValue:false});s.setNodeAnimation(c,A.Rotate,v,true);}else{y=this._getTrackKeys(v);}v.insertKey(i,x,l);var z=this._getTrackKeys(v);return{KeyValue:x,PreviousTrack:y,CurrentTrack:z};};r.prototype.getTotalOpacity=function(c){return c._vkGetTotalOpacity(this._jointCollection);};r.prototype.setTotalOpacity=function(c,i){var j=1;var k=this._getJointByChildNode(c);if(k&&k.parent){j=k.parent._vkGetTotalOpacity(this._jointCollection);}else if(c.parent){j=c.parent._vkGetTotalOpacity(this._jointCollection);}if(!c.userData){c.userData={};}var l=this.getOpacity(c);if(j!==0.0){l=i/j;}else{i=0.0;}c._vkSetOpacity(l,this._jointCollection);var s={changed:c,opacity:l};this.fireOpacityChanged(s);return{opacity:l,totalOpacity:i};};r.prototype.setOpacityKey=function(c,i,j,k){var s=j.getSequence();if(!s){return null;}var v=1;if(c.userData&&c.userData.opacity!==undefined&&c.userData.opacity!==null){v=c.userData.opacity;}var l=this.getRestOpacity(c);if(!l&&s._convertedFromAbsolute){l=1;}v/=l;var x=this._getEndPropertyInPreviousPlayback(c,A.Opacity,j);if(x){v/=x;}var y=s.getNodeAnimation(c,A.Opacity);var z;if(!y){y=this._scene.createTrack(null,{trackValueType:n.Opacity});s.setNodeAnimation(c,A.Opacity,y,true);}else{z=this._getTrackKeys(y);}y.insertKey(i,v,k);var C=this._getTrackKeys(y);return{KeyValue:v,totalOpacity:this.getTotalOpacity(c),PreviousTrack:z,CurrentTrack:C};};q=function(){this._visibilityChanges=new Set();};q.prototype.getInfo=function(c){var i=[];this._visibilityChanges.forEach(function(j){var k=c.createNodeProxy(j);var v=k.getVeId();c.destroyNodeProxy(k);if(v){i.push(v);}else{i.push(c.getScene().nodeRefToPersistentId(j));}});return i;};q.prototype.clear=function(){this._visibilityChanges.clear();};q.prototype.trackNodeRef=function(c){if(this._visibilityChanges.has(c)){this._visibilityChanges.delete(c);}else{this._visibilityChanges.add(c);}};return r;});
