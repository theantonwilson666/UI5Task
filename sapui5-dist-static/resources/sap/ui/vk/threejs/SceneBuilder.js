/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/base/Log","./BBoxSubdivider","./UsageCounter","../totara/TotaraUtils","./OrthographicCamera","./PerspectiveCamera","./DetailView","./AnimationHelper","./Thrustline","../View","./Billboard","./Callout","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","../AnimationPlayback","../AnimationRotateType","../RenderMode","./Material","../ObjectType","../getResourceBundle","./MarchingCubes","./ParametricGenerators","../NodeContentType","./ThreeExtensions","../thirdparty/ie-polyfills","sap/base/util/uid","./ThreeUtils","sap/base/assert"],function(t,L,B,U,T,O,P,D,A,a,V,b,C,d,f,g,h,o,p,q,r,s,u,R,M,v,w,x,y,N,z,E,F,G,H){"use strict";var S=function(c,e,i,j){this._rootNode=c;this._contentResource=e;this._resolve=i;this._reject=j;this._callouts=new Map();this._cameras=new Map();this._images=new Map();this._imageIdsAndTileWidths=new Map();this._imageTextures=new Map();this._geometries=new Map();this._meshNodes=new Map();this._meshSubmeshes=new Map();this._geometryMeshes=new Map();this._materialMeshes=new Map();this._materialClones=new Map();this._joints=[];this._annotations=new Map();if(c){this._nodes=new Map();this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._viewGroups=new Map();this._views=new Map();}else{this._nodes=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null;}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._animationHelper=new A(this);if(e){var n=e.getNodeProxy();var k=n.getNodeHierarchy();this._vkScene=k.getScene();var l=e.getSource();if(l&&l.name){this._sceneIdTreeNodesMap.set(l.name,this._nodes);this._sceneIdRootNodeMap.set(l.name,c);this._currentSceneId=l.name;}if(this._rootNode){this._rootNode.userData.skipIt=!e.name;}}this._viewThumbnails=new Map();this._thrustlines=new Map();this._animations=new Map();this._animationTracks=new Map();this._jointNodesMap=new Map();this._jointParentsMap=new Map();this._voxelThreshold=0.0;};S.prototype.getVoxelThreshold=function(){return this._voxelThreshold;};S.prototype.setVoxelThreshold=function(c){this._voxelThreshold=c;return this;};var I=[R.Default,R.Default,R.Default,R.LineIllustration,R.SolidOutline,R.ShadedIllustration];S.prototype.setScene=function(i){if(i.result!==1){var e={status:i.result};switch(i.result){case-1:e.errorText=w().getText("LOADER_FILENOTFOUND");break;case-2:e.errorText=w().getText("LOADER_WRONGFILEFORMAT");break;case-3:e.errorText=w().getText("LOADER_WRONGPASSWORD");break;case-4:e.errorText=w().getText("LOADER_ERRORREADINGFILE");break;case-5:e.errorText=w().getText("LOADER_FILECONTENT");break;default:e.errorText=w().getText("LOADER_UNKNOWNERROR");}this._reject(e);}else{this._vkScene.setSceneBuilder(this);var c=this._cameras.get(i.cameraId);this._resolve({node:this._rootNode,camera:c,backgroundTopColor:i.backgroundTopColor,backgroundBottomColor:i.backgroundBottomColor,upAxis:i.upAxis,annotations:this._annotations,contentResource:this._contentResource,builder:this});}};S.prototype.setRootNode=function(c,n,e,i){this._rootNode=c;this._nodes=new Map();this._nodes.set(n,c);this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._sequenceIdToPlaybacks=new Map();this._viewGroups=new Map();this._views=new Map();if(e){this._sceneIdTreeNodesMap.set(e,this._nodes);this._sceneIdRootNodeMap.set(e,c);this._currentSceneId=e;}if(i){this._vkScene=i;}return this;};S.prototype._resetCurrentScene=function(c){if(c&&c!==this._currentSceneId){var n=this._sceneIdTreeNodesMap.get(c);if(n){this._nodes=n;}else{this._nodes=null;}var e=this._sceneIdRootNodeMap.get(c);if(e){this._rootNode=e;}else{this._rootNode=null;}this._currentSceneId=c;}};S.prototype.getNode=function(n,c){if(c){this._resetCurrentScene(c);if(this._nodes){return this._nodes.get(n);}}else{var e=this._sceneIdTreeNodesMap.values();var i=e.next();while(!i.done){var j=i.value.get(n);if(j){return j;}i=e.next();}}return null;};S.prototype.hasMesh=function(m){return this._meshSubmeshes.has(m);};S.prototype.hasImage=function(i){return this._images.has(i);};S.prototype.setNodePersistentId=function(n,c,e){if(!n.userData.treeNode){n.userData.treeNode={};}var i=null;if(n.userData.treeNode.sid){i=n.userData.treeNode.sid;delete(n.userData.treeNode.sid);}this._resetCurrentScene(e);n.userData.treeNode.sid=c;if(this._nodes){if(i){this._nodes.delete(i);}this._nodes.set(c,n);return true;}return false;};S.prototype.setAnnotationPersistentId=function(c,e,i){this._resetCurrentScene(i);if(this._annotations){var j=this._annotations.get(c.id);if(j){this._annotations.delete(c.id);j.annotation.id=e;this._annotations.set(e,j);return true;}}return false;};var J=function(c){var m=new THREE.Matrix4();if(c.length===3){m.setPosition(new THREE.Vector3().fromArray(c));}else if(c.length===12){m.set(c[0],c[3],c[6],c[9],c[1],c[4],c[7],c[10],c[2],c[5],c[8],c[11],0.0,0.0,0.0,1.0);}else if(c.length===16){m.set(c[0],c[4],c[8],c[12],c[1],c[5],c[9],c[13],c[2],c[6],c[10],c[14],c[3],c[7],c[11],c[15]);}else{throw"Invalid matrix format";}return m;};var K={r:0.0235,g:0.0235,b:0.0235};var Q={r:0.0602,g:0.0602,b:0.0602};S.prototype._createTemporaryMaterial=function(m){var c=new M();var e=c.getMaterialRef();e.userData.defaultHighlightingEmissive=K;e.userData.defaultHighlightingSpecular=Q;e.userData.materialUsed=0;e.userData.materialId=m;e.userData.toBeUpdated=true;this._vkScene.setMaterial(m,c);return e;};S.prototype._getMaterialRef=function(m){var c=this._vkScene.getMaterial(m);return c?c.getMaterialRef():null;};S.prototype.checkMaterialExists=function(m,c){if(this._getMaterialRef(m)===null){if(c){this._createTemporaryMaterial(m);}return false;}return true;};S.prototype._attachMaterialClone=function(m,c){T.pushElementIntoMapArray(this._materialClones,m,c);};S.prototype._addDynamicObject=function(n,c,i){var e=this._rootNode.userData;if(!e._vkDynamicObjects){e._vkDynamicObjects=[];}if(e._vkDynamicObjects.indexOf(n)<0){e._vkDynamicObjects.push(n);}n._vkUpdate=c;if(i){n.userData.is2D=true;}};S.prototype.createNode=function(n,c){this._resetCurrentScene(c);var e=new THREE.Group();this._nodes.set(n.sid,e);var i;var j=this._jointNodesMap.get(n.sid);if(j&&j.length){for(i=0;i<j.length;i++){j[i].node=e;}}var k=this._jointParentsMap.get(n.sid);if(k&&k.length){for(i=0;i<k.length;i++){k[i].parent=e;}}var l=this._nodes.get(n.parentId);(l||this._rootNode).add(e);var m=e.userData;m.treeNode=n;if(n.closed){m.closed=true;}if(n.selectable===false){m.selectable=false;}if(n.visualisable===false&&n.contentType!=="SYMBOL"){m.skipIt=true;}if(n.metadata){m.metadata=n.metadata;}if(n.veids){m.veids=n.veids;}if(n.sid){m.nodeId=n.sid;}if(n.name){e.name=n.name;}if(n.visible!==undefined){e.visible=!!n.visible;}if(l){var p1;if(m.skipIt||(l.name&&e.name===l.name+" offset geometry")){m.skipIt=true;}else{p1=l;while(p1){if(p1.userData.closed){m.skipIt=true;}p1=p1.parent;}}if(l.userData.symbolContent){m.skipIt=true;m.symbolContent=true;}if(e.visible&&!m.skipIt&&this._contentResource){p1=l;while(p1){p1.visible=true;p1=p1.parent;}}}if(n.renderOrder){e.renderOrder=n.renderOrder;}m.opacity=n.opacity;if(n.transform){e.applyMatrix4(J(n.transform));if(!isFinite(e.quaternion.x)||!isFinite(e.quaternion.y)||!isFinite(e.quaternion.z)||!isFinite(e.quaternion.w)){e.quaternion.set(0,0,0,1);}}e.updateMatrixWorld(true);if(n.transformType){m.transformType=n.transformType;switch(n.transformType){case"ORTHO2D":m.originalTransform={p:e.position.clone(),q:e.quaternion.clone(),s:e.scale.clone()};this._addDynamicObject(e,b.prototype._ortho2DUpdate,true);break;case"BILLBOARD_VIEW":this._addDynamicObject(e,b.prototype._billboardViewUpdate,false);break;case"LOCK_TOVIEWPORT":this._addDynamicObject(e,b.prototype._lockToViewportUpdate,true);break;default:break;}}if(n.materialId){m.materialId=n.materialId;}if(n.geometryType){m.geometryType=n.geometryType;}if(n.meshId){this.setMeshNode(n.sid,n.meshId);}if(n.parametricId){this.setParametricNode(n.sid,n.parametricId,n.visible);}if(e.parent.userData.objectType===v.Hotspot){m.objectType=v.Hotspot;}else if(e.parent.userData.objectType===v.PMI){m.objectType=v.PMI;}else if(n.contentType==="HOTSPOT"){m.objectType=v.Hotspot;}else if(n.contentType==="PMI"){m.objectType=v.PMI;}if(n.contentType==="REFERENCE"){e._vkSetNodeContentType(N.Reference);}else if(n.contentType==="ANNOTATION"){e._vkSetNodeContentType(N.Annotation);}else if(n.contentType==="BACKGROUND"){e._vkSetNodeContentType(N.Background);}else if(n.contentType==="SYMBOL"){e._vkSetNodeContentType(N.Symbol);m.symbolContent=true;}return e;};S.prototype.removeNode=function(n){this._nodes.delete(n._vkPersistentId());this._annotations.forEach(function(c){if(c.node===n){this._annotations.delete(c.annotation.id);}}.bind(this));};S.prototype.hasNode=function(n){return this._nodes.has(n._vkPersistentId());};function W(c,m,l){var e;if(c.isPolyline){var i=new THREE.LineBasicMaterial({color:0xff0000,linewidth:1});if(m){i.color.copy(m.color);}e=new THREE.LineSegments(c,i);}else{e=new THREE.Mesh(c,m);}if(c.isPositionQuantized){Z(e,l.boundingBox);}U.increaseGeometryUsed(c);return e;}S.prototype.getChildNodeIds=function(n,c,e){this._resetCurrentScene(c);var j=this._nodes.get(n);var k=[];if(!j){return k;}if(j&&j.children){for(var i=0;i<j.children.length;i++){var l=j.children[i];if(l.userData.treeNode&&l.userData.treeNode.sid){k.push(l.userData.treeNode.sid);}else if(e&&l.userData.submeshInfo&&l.userData.submeshInfo.id){k.push(l.userData.submeshInfo.id);}}}return k;};function X(l){for(var i=0;i<l.length;i++){if(l[i].type==="box"&&l[i].data){return l[i];}}return null;}function Y(l){if(Array.isArray(l)){for(var i=0;i<l.length;i++){if(l[i].type===undefined||l[i].type==="mesh"||l[i].type==="line"){return l[i];}}}return null;}function Z(m,c){if(c&&c.length===6){m.position.set((c[3]+c[0])*0.5,(c[4]+c[1])*0.5,(c[5]+c[2])*0.5);m.scale.set(Math.max(c[3]-c[0],Number.EPSILON),Math.max(c[4]-c[1],Number.EPSILON),Math.max(c[5]-c[2],Number.EPSILON));m.updateMatrix();}}S.prototype.insertSubmesh=function(c,e){var m=this._getMaterialRef(c.materialId)||this._createTemporaryMaterial(c.materialId);var i,j;if(c.lods){var l=Y(c.lods);if(!l){return false;}j=this._geometries.get(l.id);if(j){i=W(j,m,l);if(j.userData&&j.userData.noNormal&&c.materialId){this.updateMaterialForGeometryWithoutNormal(c.materialId);}}else{var k=true;var n=l.boundingBox;if(n&&e){var p1=(n[3]-n[0])/(e[3]-e[0]);var s1=(n[4]-n[1])/(e[4]-e[1]);var t1=(n[5]-n[2])/(e[5]-e[2]);k=p1>this._voxelThreshold||s1>this._voxelThreshold||t1>this._voxelThreshold;}var u1;var v1=k&&X(c.lods);if(v1&&v1.data){var w1=T.base64ToUint8Array(v1.data);var x1=B.unpackSubDividedBoundingBox(w1);u1=x.march(x1);}i=new THREE.Mesh(u1?u1:new THREE.BoxBufferGeometry(1,1,1),m);if(n&&n.length===6){var y1=new THREE.Matrix4();y1.scale(new THREE.Vector3(Math.max(n[3]-n[0],Number.EPSILON),Math.max(n[4]-n[1],Number.EPSILON),Math.max(n[5]-n[2],Number.EPSILON)));y1.setPosition(new THREE.Vector3((n[3]+n[0])*0.5,(n[4]+n[1])*0.5,(n[5]+n[2])*0.5));i.geometry.applyMatrix4(y1);}i.userData.geometryId=l.id;i.userData.lodInfo=l;T.pushElementIntoMapArray(this._geometryMeshes,l.id,c.meshId);}}else{return false;}if(c.transform){i.applyMatrix4(J(c.transform));}i.updateMatrixWorld(true);i.userData.submeshId=c.id;i.userData.initialMaterialId=c.materialId;i.userData.meshId=c.meshId;i.userData.materialId=c.materialId;i.userData.submeshInfo=c;T.pushElementIntoMapArray(this._materialMeshes,c.materialId,c.meshId);T.pushElementIntoMapArray(this._meshSubmeshes,c.meshId,i);var z1=this._meshNodes.get(c.meshId);if(z1){z1.forEach(function(A1){var B1=(i instanceof THREE.Mesh?i._vkClone():i.clone());if(A1.userData.transformType==="ORTHO2D"){B1.position.setScalar(0);B1.scale.setScalar(1);}B1.userData.skipIt=true;B1.renderOrder=A1.renderOrder;if(A1.userData.materialId){G.disposeMaterial(B1.material);B1.material=this._getMaterialRef(A1.userData.materialId)||i.material;B1.userData.materialId=A1.userData.materialId;}if(B1.material&&A1.userData&&A1.userData.geometryType&&(A1.userData.geometryType==="PLANE"||A1.userData.geometryType==="SURFACE")){B1.material.side=THREE.DoubleSide;}A1.add(B1);B1.updateMatrixWorld(true);_(A1,c.materialId,this._materialClones);}.bind(this));}return true;};function $(c,e,j,m){for(var i=0;i<c.length;i++){var k=c[i];if(e&&k.userData.geometryId===e&&k.geometry!==j){if(k.type==="Mesh"&&!j.isPolyline){if(k.geometry){G.disposeGeometry(k);}k.geometry=j;if(j.isPositionQuantized&&!(k.parent&&k.parent.userData.transformType==="ORTHO2D")){Z(k,k.userData.lodInfo.boundingBox);}k.updateMatrixWorld(true);U.increaseGeometryUsed(j);}else{var n=W(j,k.material,k.userData.lodInfo);n.position.copy(k.position);n.quaternion.copy(k.quaternion);n.scale.copy(k.scale);n.matrix.copy(k.matrix);n.updateMatrixWorld(true);n.userData=k.userData;n.renderOrder=k.renderOrder;n.parent=k.parent;c[i]=n;k.parent=null;}}}}S.prototype._setSubmeshMaterial=function(c,m,e){U.increaseMaterialUsed(m);c.material=m;c.userData.materialId=e;delete c.userData.originalMaterial;c._vkUpdateMaterialOpacity();if(c.material!==m){T.pushElementIntoMapArray(this._materialClones,e,c.material);}};S.prototype._updateMaterial=function(n,m,c){n.children.forEach(function(e){if(e.material&&e.userData.materialId===m){this._setSubmeshMaterial(e,c,m);}}.bind(this));};function _(n,m,c){n.children.forEach(function(e){if(e.material&&(!m||m===e.material.userData.materialId)){var i=e.material;e._vkUpdateMaterialOpacity();if(e.material!==i){T.pushElementIntoMapArray(c,e.material.userData.materialId,e.material);}}});}function a1(c,e){var n=new Float32Array(c.length);var l=new THREE.Vector3();var m=new THREE.Vector3();var p2=new THREE.Vector3();var p1=new THREE.Vector3();var i,s1;for(i=0,s1=e.length;i<s1;i+=3){var pi=[e[i]*3,e[i+1]*3,e[i+2]*3];l.fromArray(c,pi[0]);m.fromArray(c,pi[1]).sub(l);p2.fromArray(c,pi[2]).sub(l);p1.crossVectors(m,p2).normalize();for(var j=0;j<3;j++){var k=pi[j];n[k]+=p1.x;n[k+1]+=p1.y;n[k+2]+=p1.z;}}for(i=0,s1=n.length;i<s1;i+=3){p1.fromArray(n,i).normalize().toArray(n,i);}return n;}S.prototype.setGeometry=function(c){var e=new THREE.BufferGeometry();var i=c.data;var j=new THREE.BufferAttribute(new Uint16Array(i.indices),1);var k=new THREE.BufferAttribute(new Float32Array(i.points),3);e.setIndex(j);e.setAttribute("position",k);if(!c.isPolyline){if(!i.normals||i.normals.length!==k.array){i.normals=a1(k.array,j.array);}var n=new THREE.BufferAttribute(new Float32Array(i.normals),3);e.setAttribute("normal",n);if(i.uvs&&i.uvs.length*3===i.points.length*2){e.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(c.data.uvs),2));}}else{e.isPolyline=true;}e.computeBoundingBox();e.computeBoundingSphere();e.isPositionQuantized=c.isPositionQuantized;e.userData.geometryId=c.id;e.userData.geometryUsed=0;this._geometries.set(c.id,e);var m=this._geometryMeshes.get(c.id);if(m){for(var l=0;l<m.length;l++){var p1=m[l];var s1=this._meshNodes.get(p1);if(s1){for(var ni=0;ni<s1.length;ni++){$(s1[ni].children,c.id,e);}}var u1=this._meshSubmeshes.get(p1);if(u1){$(u1,c.id,e);}}}if(this._fireSceneUpdated){this._fireSceneUpdated();}return this;};S.prototype.setMeshNode=function(n,m){var c=this._nodes.get(n);if(c){T.pushElementIntoMapArray(this._meshNodes,m,c);var e=this._meshSubmeshes.get(m);if(e){e.forEach(function(i){var j=(i instanceof THREE.Mesh?i._vkClone():i.clone());if(c.userData.transformType==="ORTHO2D"){j.position.setScalar(0);j.scale.setScalar(1);}j.userData.skipIt=true;j.renderOrder=c.renderOrder;if(c.userData.materialId){G.disposeMaterial(j.material);j.material=this._getMaterialRef(c.userData.materialId)||i.material;j.userData.materialId=c.userData.materialId;}c.add(j);}.bind(this));_(c,null,this._materialClones);}}};S.prototype.setParametricNode=function(n,c,e){var i=this._nodes.get(n);if(i){i.userData.parametricVisible=e!==undefined?e:true;}};S.prototype.progress=function(c){L.log("reading progress:",c);};S.prototype.loadingFinished=function(i){if(this._fireLoadingFinished){this._fireLoadingFinished(i);}};S.prototype.getGeometry=function(c){return this._geometries.get(c);};var b1={rect:g.RectangularShape,circle:g.CircularShape,none:g.None,textGlow:g.TextGlow};var c1={none:h.None,solid:h.Solid,dash:h.Dash,dot:h.Dot,dashdot:h.DashDot,dashdotdot:h.DashDotDot};var d1={left:o.Left,center:o.Center,right:o.Right};var e1={none:p.None,point:p.Point,arrow:p.Arrow};var f1=new THREE.Color();function g1(c){var m=new THREE.Matrix4();var e=new THREE.Matrix4();var n=c;while(n&&n.userData.originalTransform){H(n.userData.transformType==="ORTHO2D");var i=n.userData.originalTransform;m.compose(i.p,i.q,i.s);e.premultiply(m);n=n.parent;}e.decompose(c.position,c.quaternion,c.scale);}S.prototype.createAnnotation=function(c,e){this._resetCurrentScene(e);var n=this._nodes.get(c.nodeId);if(!n){L.warning("Annotation node not found",c);return;}if(n.userData.originalTransform){g1(n);}var i=c.type;if(i===undefined){this.createLegacyAnnotation(c,n);return;}if(i==="html"){c.id=c.id||F();var j=[];if(c.leaderLines){c.leaderLines.forEach(function(x1){if(x1.start&&x1.start.sid){j.push(this._nodes.get(x1.start.sid));}},this);}this._annotations.set(c.id,{annotation:c,node:n,attachment:(c.attachment&&c.attachment.sid)?this._nodes.get(c.attachment.sid):null,targetNodes:j});return;}var l=c.label||{};var k=c.text||{};var m=l.colour||[1,1,1,1];var p1=l.borderColour||[0,0,0,1];var s1={node:n,renderOrder:n.renderOrder||0,style:b1[l.shape]||g.RectangularShape,width:l.width||64,height:l.height||64,backgroundColor:f1.fromArray(m).getStyle(),backgroundOpacity:m[3],borderColor:f1.fromArray(p1).getStyle(),borderOpacity:p1[3],borderWidth:l.borderColour?(l.borderWidth||0):0,borderLineStyle:c1[l.borderLineStyle]||h.Solid,horizontalAlignment:d1[k.align]};if(k.html){s1.encoding=f.HtmlText;s1.text=k.html;}else{s1.encoding=f.PlainText;s1.text=k.text;s1.font=k.fontFace||"Arial";s1.fontSize=Math.abs(k.fontSize)||16;s1.fontWeight=Math.min(k.fontWeight,900);s1.fontItalic=k.fontItalic;s1.textColor=f1.fromArray(k.colour||[0,0,0]).getStyle();}if(i==="text"){var t1=n.position;s1.position=new THREE.Vector3(t1.x*2,t1.y*2,t1.z);var u1=new b(s1);u1.setText(s1.text);this._addDynamicObject(n,u1._update.bind(u1),true);}else if(i==="note"){var v1=c.attachment||{};s1.position=new THREE.Vector3().fromArray(v1.position||[0,0,0]);s1.anchorNode=this._nodes.get(v1.sid)||this._rootNode;s1.depthTest=false;var w1=new C(s1);w1.setText(s1.text);this._callouts.set(c.id,w1);this._addDynamicObject(n,w1._update.bind(w1),false);}else{L.warning("Unsupported annotation type",c);}};var h1=[g.RectangularShape,g.CircularShape,g.None,g.TextGlow];var i1=[d.Viewport,d.Screen,d.World];var j1=[h.None,h.Solid,h.Dash,h.Dot,h.DashDot,h.DashDotDot];var k1=[p.None,p.Point,p.Arrow];var l1=[o.Left,o.Center,o.Right];function m1(c){var e=c.toString(16);if(c.length>=3){e=(((c[0]*255)<<16)|((c[1]*255)<<8)|(c[2]*255)).toString(16);}return"#"+"000000".substring(e.length)+e;}function n1(c){if(!c){return false;}for(var i=0,l=c.length;i<l;i++){if(!isFinite(c[i])){return false;}}return true;}S.prototype.createLegacyAnnotation=function(c,n){var e=c.position;if(!n1(e)){L.warning("Incorrect annotation position",c);return;}c.coordinateSpace|=0;var i=c.backgroundOpacity;if(!i){i=c.backgroundColour?c.backgroundColour[3]:0;}var j=c.borderOpacity;if(!j){j=c.borderColour?c.borderColour[3]:0;}var k={node:n,coordinateSpace:i1[c.coordinateSpace],style:h1[c.shape||0],width:c.width,height:c.height,backgroundColor:c.backgroundColour?m1(c.backgroundColour):"#fff",backgroundOpacity:i,borderColor:c.borderColour?m1(c.borderColour):"#000",borderOpacity:j,borderWidth:c.borderWidth,borderLineStyle:j1[c.borderLineStyle]};if(c.encoding!==undefined){k.encoding=c.encoding?f.HtmlText:f.PlainText;k.font=c.font;k.fontSize=c.fontSize;k.fontWeight=Math.min(c.fontWeight,900);k.fontItalic=c.fontItalic;k.textColor=m1(c.textColor);k.link=c.link;k.horizontalAlignment=l1[c.textHorizontalAlignment];k.position=new THREE.Vector3().fromArray(e);}else if(c.fontFace){k.encoding=f.PlainText;k.font=c.fontFace;k.fontSize=Math.abs(c.fontSize);k.fontWeight=Math.min(c.fontWeight,900);k.textColor=m1(c.textColour);}else{k.encoding=f.HtmlText;}if(c.coordinateSpace<2){if(!k.positions){k.position=new THREE.Vector3(e[0]*2-1,e[1]*-2+1,e[2]);}k.renderOrder=(c.order|0)+1000;var l=new b(k);l.setText(c.text);this._addDynamicObject(n,l._update.bind(l),true);}else{k.anchorNode=this._nodes.get(c.sid)||this._rootNode;if(!k.postion){k.position=new THREE.Vector3().fromArray(e);}k.depthTest=false;k.renderOrder=c.order|0;if(c.alwaysOnTop){k.renderOrder=1;}var m=new C(k);m.setText(c.text);this._callouts.set(c.id,m);this._addDynamicObject(n,m._update.bind(m),false);}};S.prototype.createImageNote=function(c,e){this._resetCurrentScene(e);var n=this._nodes.get(c.nodeId);if(!n){L.warning("Image annotation node not found",c);return;}if(n.userData.originalTransform){g1(n);}if(c.type==="image"){var l=c.label||{};var m=this._getMaterialRef(l.materialId);if(!m){L.warning("Image annotation material not found",c);return;}var i=new b({node:n,renderOrder:n.renderOrder||0,coordinateSpace:d.Screen,position:new THREE.Vector3(n.position.x,n.position.y,0),width:(l.width||200)*n.scale.x*0.5,height:(l.height||200)*n.scale.y*0.5});i.setMaterial(m);if(n.userData.transformType!=="BILLBOARD_VIEW"){n.position.setScalar(0);n.scale.setScalar(1);this._addDynamicObject(n,i._update.bind(i),true);}}else{this.createLegacyImageNote(c,n);}};S.prototype.createLegacyImageNote=function(c,n){var e=new THREE.Vector3().fromArray(c.position);var i=c.width;var j=c.height;if(!c.properlyAligned){e.x+=c.width*0.5;e.y+=c.height*0.5;e.applyMatrix4(n.matrix);i=c.width*0.5*n.matrix.elements[0];j=c.height*0.5*n.matrix.elements[5];}var k=new b({node:n,coordinateSpace:d.Screen,renderOrder:(c.order|0)+1000,position:e,width:i,height:j});var m=this._getMaterialRef(c.labelMaterialId);k.setMaterial(m);this._addDynamicObject(n,k._update.bind(k),true);};S.prototype.insertLeaderLine=function(c,e){this._resetCurrentScene(e);var j=this._callouts.get(c.annotationId);if(j){var m=this._getMaterialRef(c.materialId);if(!m){L.warning("Leader line material not found",c);return;}var k=[];var n=c.points;for(var i=0,l=n.length;i<l;i++){k.push(new THREE.Vector3().fromArray(n[i]));}var p1;if(c.start){var s1=c.start||{};var t1=c.end||{};var u1=c.extension||{};p1=this._nodes.get(c.start.sid)||this._rootNode;j.addLeaderLine(k,p1,m,e1[s1.style]||p.None,e1[t1.style]||p.None,s1.size,u1.length||0);}else{p1=this._nodes.get(c.startPointSid)||this._rootNode;j.addLeaderLine(k,p1,m,k1[c.startPointHeadStyle],k1[c.endPointHeadStyle],c.pointHeadConstant,c.extensionLength);}}};S.prototype._findDetailViewNodes=function(n){var c=[];if(n){n.forEach(function(e){var i=this._nodes.get(e);if(i){c.push(i);}else{L.warning("Unknown detailView node reference",e);}}.bind(this));}return c;};S.prototype.createDetailView=function(i,c){this._resetCurrentScene(c);var n=this._nodes.get(i.nodeId);if(!n){L.warning("Detail view node not found",i);return;}var l=i.label;if(!l){this.createLegacyDetailView(i,n);return;}var e=i.attachment;var j={name:i.name,camera:l.camera?this.createCamera(l.camera):null,type:i.cutaway?q.Cutaway:q.DetailView,borderWidth:l.borderWidth||0,backgroundColor:f1.fromArray(l.colour||[1,1,1]).getStyle(),borderColor:f1.fromArray(l.borderColour||[1,1,1]).getStyle(),origin:new THREE.Vector2(n.position.x*2-1+n.scale.x,n.position.y*-2+1-n.scale.x),size:new THREE.Vector2(n.scale.x,n.scale.y),attachmentPoint:new THREE.Vector3().fromArray(e.position||[0,0,0]),veId:i.veid,visibleNodes:this._findDetailViewNodes(i.visibleNodes),targetNodes:this._findDetailViewNodes(i.targetNodes)};if(l.shape==="rect"){j.shape=!l.leaderStyle||l.leaderStyle==="none"?r.Box:r.BoxLine;}else{j.shape={none:r.Circle,line:r.CircleLine,pointer:r.CirclePointer,arrow:r.CircleArrow,bubbles:r.CircleBubbles}[l.leaderStyle]||r.Circle;}var k=new D(j);if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[];}this._rootNode.userData._vkDetailViews.push({detailView:k,node:n,renderOrder:i.renderOrder||n.renderOrder||0});};S.prototype.createLegacyDetailView=function(i,n){if(!i.properlyAligned){if(!i.shape){i.shape=i.leaderStyle?r.BoxLine:r.Box;}else{i.shape=[r.Circle,r.CircleLine,r.CirclePointer,r.CircleArrow,r.CircleBubbles][i.leaderStyle||0];}i.type=i.cutaway?q.Cutaway:q.DetailView;i.camera=i.camera?this.createCamera(i.camera):null;i.origin=new THREE.Vector2(n.position.x*2-1+n.scale.x,n.position.y*-2+1-n.scale.x);i.size=new THREE.Vector2(n.scale.x,n.scale.y);i.renderOrder=n.renderOrder;}else{i.type=[q.DetailView,q.Cutaway][i.type];i.shape=[r.Box,r.Circle,r.CircleLine,r.CirclePointer,r.CircleArrow,r.CircleBubbles,r.BoxLine,r.BoxNoOutline,r.SolidPointer,r.SolidArrow][i.shape];i.camera=this._cameras.get(i.cameraId);i.origin=new THREE.Vector2().fromArray(i.origin);i.size=new THREE.Vector2().fromArray(i.size);}var c=new D({name:i.name,camera:i.camera,type:i.type,shape:i.shape,borderWidth:i.borderWidth||0,backgroundColor:i.backgroundColour?m1(i.backgroundColour):"#fff",borderColor:i.borderColour?m1(i.borderColour):"#000",origin:i.origin,size:i.size,attachmentPoint:new THREE.Vector3().fromArray(i.attachment),metadata:i.metadata,veId:i.veid,visibleNodes:this._findDetailViewNodes(i.visibleNodes),targetNodes:this._findDetailViewNodes(i.targetNodes)});if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[];}this._rootNode.userData._vkDetailViews.push({detailView:c,node:n,renderOrder:i.renderOrder||0});};S.prototype.insertThrustline=function(i){var n=this._nodes.get(i.thrustlineId);if(n&&!this._thrustlines.get(i.thrustlineId)){var c=new a({node:n,principleAxis:new THREE.Vector3().fromArray(i.principleAxis),material:this._getMaterialRef(i.materialId)});var e=[];var j=0;var k=0;var l=0;for(var m=0;m<i.itemCount;m++){var p1={};p1.target=this._nodes.get(i.targets[m]);p1.majorAxisIndex=i.itemMajorAxisesIndices[m];var bi;p1.basisAxises=[];l=j+i.itemBasisAxisesCounts[m];for(bi=j;bi<l;bi++){var s1={};s1.x=i.itemBasisAxisesCoordinates[bi*3];s1.y=i.itemBasisAxisesCoordinates[bi*3+1];s1.z=i.itemBasisAxisesCoordinates[bi*3+2];p1.basisAxises.push(s1);}j=l;p1.dimension={};p1.dimension.x=i.itemDimensionsCoordinates[m*3];p1.dimension.y=i.itemDimensionsCoordinates[m*3+1];p1.dimension.z=i.itemDimensionsCoordinates[m*3+2];p1.center={};p1.center.x=i.itemCentersCoordinates[m*3];p1.center.y=i.itemCentersCoordinates[m*3+1];p1.center.z=i.itemCentersCoordinates[m*3+2];p1.boundPoints=[];l=k+i.itemBoundPointsCounts[m];for(bi=k;bi<l;bi++){var t1={};t1.x=i.itemBoundPointsCoordinates[bi*3];t1.y=i.itemBoundPointsCoordinates[bi*3+1];t1.z=i.itemBoundPointsCoordinates[bi*3+2];p1.boundPoints.push(t1);}k=l;e.push(p1);}c.setItems(e);var u1=0;var v1=[];for(var si=0;si<i.segmentCount;si++){var x1={};x1.startItemIndex=i.segmentsStartItemIndices[si];x1.endItemIndex=i.segmentsEndItemIndices[si];x1.startBoundIndex=i.segmentsStartBoundIndices[si];x1.endBoundIndex=i.segmentsEndBoundIndices[si];x1.ratios=[];l=u1+i.segmentRatioCounts[si];for(var ri=0;ri<l;ri++){var z1={};z1.x=i.segmentRatiosCoordinates[ri*2];z1.y=i.segmentRatiosCoordinates[ri*2+1];x1.ratios.push(z1);}u1=l;v1.push(x1);}c.setSegments(v1);this._thrustlines.set(i.thrustlineId,c);this._addDynamicObject(n,c._update.bind(c),false);}};S.prototype.updateViewsForReplacedNodes=function(n){var c=new Map();n.forEach(function(j){var k=this._nodes.get(j.sid);if(k){c.set(j.sid,k);}},this);function e(j,c){var n=j.getNodeInfos();n.forEach(function(k){var l=k.target;if(l&&l.userData&&l.userData.treeNode&&l.userData.treeNode.sid){var m=c.get(l.userData.treeNode.sid);if(m){k.target=m;m.updateMatrixWorld();}}});}function i(j,c){var k;var l=j.getPlaybacks();for(var m=0;m<l.length;m++){var p1=l[m];var s1=p1.getSequence();if(s1){var t1=false;var u1=s1.getNodeAnimation();for(var ni=0;ni<u1.length;ni++){var w1=u1[ni];var x1=w1.nodeRef;if(x1&&x1.userData&&x1.userData.treeNode&&x1.userData.treeNode.sid){k=c.get(x1.userData.treeNode.sid);if(k){s1.removeNodeAnimation(x1,null,true);for(var y1 in w1){if(y1==="nodeRef"){continue;}s1.setNodeAnimation(k,y1,w1[y1],true);}t1=true;}}}var z1=s1.getJoint();for(var ji=0;z1&&ji<z1.length;ji++){var B1=z1[ji];if(B1.parentSid){k=c.get(B1.parentSid);if(k){B1.parent=k;t1=true;}}if(B1.nodeSid){k=c.get(B1.nodeSid);if(k){B1.node=k;t1=true;}}}if(t1){s1._fireSequenceChanged();}}}n.forEach(function(v1){var A1=v1.target;if(A1&&A1.userData&&A1.userData.treeNode&&A1.userData.treeNode.sid){var k=c.get(A1.userData.treeNode.sid);if(k){v1.target=k;k.updateMatrixWorld();}}});}this._views.forEach(function(j,k){e(j,c);i(j,c);});};S.prototype._decrementResourceCounters=function(c){c.traverse(function(e){if(e.isMesh){U.decreaseMaterialUsed(e.material);U.decreaseGeometryUsed(e.geometry);}});};S.prototype.decrementResourceCountersForDeletedTreeNode=function(n,c){this._resetCurrentScene(c);var e=this;n=[].concat(n);n.forEach(function(i){var j=e._nodes.get(i);if(j){e._decrementResourceCounters(j);e._nodes.delete(i);}});return this;};S.prototype.remove=function(n,c){this._resetCurrentScene(c);var e=this;n=[].concat(n);n.forEach(function(j){var k=e._nodes.get(j);if(k){e._decrementResourceCounters(k);if(k.parent){k.parent.remove(k);}e._nodes.delete(j);for(var i=0;i<k.children.length;i++){var l=k.children[i];if(l.userData&&l.userData.treeNode&&l.userData.treeNode.sid){e.remove(l.userData.treeNode.sid,c);}}}});return this;};S.prototype.resourcesCleanUp=function(){var c=this._geometries;c.forEach(function(e){var i=e.userData.geometryUsed;if(i<=0){e.dispose();}});return this;};S.prototype.createCamera=function(c,e){this._resetCurrentScene(e);var n=c.near||1;var i=c.far||200000;if(c.origin.length===3&&c.origin[0]===0&&c.origin[1]===0&&c.origin[2]===0){c.ortho=false;c.rotate=true;}var j;if(c.ortho){j=new THREE.OrthographicCamera(-1,1,1,-1,n,i);j.zoom=c.zoom||-1;}else{j=new THREE.PerspectiveCamera(THREE.Math.radToDeg(c.fov),1,n,i);}if(c.origin){j.position.fromArray(c.origin);}if(c.up){j.up.fromArray(c.up);if(c.notUseDirectionVector){j.up.sub(j.position);}j.up.normalize();}if(c.rotate){j.userData.rotate=c.rotate;j.up.set(0,1,0);}if(c.target){var k=new THREE.Vector3().fromArray(c.target);if(!c.notUseDirectionVector){k.add(j.position);}j.lookAt(k);}this._rootNode.userData.camera=j;var l=null;if(j.isOrthographicCamera){l=new O();}else if(j.isPerspectiveCamera){l=new P();}l.setCameraRef(j);l.setUsingDefaultClipPlanes(true);var m=c.id;if(m){this._cameras.set(m,l);}this._rootNode.userData.camera=l;return l;};S.prototype.insertCamera=function(n,c,e){this._resetCurrentScene(e);var i=this._nodes.get(n);var j=this._cameras.get(c);if(i&&j){(i||this._rootNode).add(j.parent?j.clone():j);}return this;};S.prototype.getCamera=function(c){return this._cameras.get(c);};S.prototype.updateMaterialForGeometryWithoutNormal=function(m){var c=this._getMaterialRef(m);if(c&&c.emissive){c.emissive.copy(c.color);c.side=THREE.DoubleSide;}return this;};S.prototype.createMaterial=function(m){var c=[];var e=m.id;var i=this._getMaterialRef(e);if(m.lineWidth>0){if(!i||!i.isLineBasicMaterial){var j=new M(true);i=j.getMaterialRef();this._vkScene.setMaterial(e,j);}i.color=new THREE.Color(m.lineColour[0],m.lineColour[1],m.lineColour[2]);i.linewidth=m.lineWidth;i.userData.lineStyle={width:m.lineWidth,haloWidth:m.lineHaloWidth||0,endCapStyle:m.lineEndRound?1:0,dashPattern:m.lineDashPattern||[],dashPatternScale:m.lineDashPatternScale,widthCoordinateSpace:m.lineWidthCoordinateSpace};i.userData.materialInfo=m;i.userData.materialId=e;return c;}if(!i){i=this._createTemporaryMaterial(e);}delete i.userData.toBeUpdated;i.userData.materialInfo=m;if(m.diffuseColour){i.color.fromArray(m.diffuseColour);}if(m.specularColour){i.specular.fromArray(m.specularColour);}var k=true;if(m.emissiveColour){i.emissive.fromArray(m.emissiveColour);if(i.emissive.r!==0||i.emissive.g!==0||i.emissive.b!==0){k=false;i.depthFunc=THREE.LessDepth;}}if(k&&m.ambientColour){i.emissive.fromArray(m.ambientColour);i.emissive.multiplyScalar(0.2);}if(i.opacity!==undefined){i.opacity=m.opacity;i.transparent=m.opacity<0.99;if(i.transparent){i.side=THREE.DoubleSide;}}var l=i.glossiness?i.glossiness:0;var n=i.specularLevel?i.specularLevel:0;i.shininess=l*2+n*3;i.userData.defaultHighlightingEmissive=K;i.userData.defaultHighlightingSpecular=Q;c=this.updateTextureMaps(e);if(c.length>0){i.userData.imageIdsToLoad=new Set();for(var ti=0;ti<c.length;ti++){var p1=c[ti];T.pushElementIntoMapArray(this._imageTextures,p1.imageId,{textureType:p1.textureType,materialId:e});i.userData.imageIdsToLoad.add(p1.imageId);}}var s1=this._materialMeshes.get(e);if(s1){for(var mi=0;mi<s1.length;mi++){var u1=s1[mi];var v1=this._meshNodes.get(u1);if(v1){for(var ni=0;ni<v1.length;ni++){this._updateMaterial(v1[ni],e,i);}}}}return c;};S.prototype.getMaterial=function(m){return this._getMaterialRef(m);};var o1=function(c){var i="";try{var j=0x8000;var k=0;var l=c.length;var m;while(k<l){m=c.slice(k,Math.min(k+j,l));i+=String.fromCharCode.apply(null,m);k+=j;}}catch(e){i="";}return i;};S.prototype.createImage=function(c){if(c.binaryData.length<32){L.warning("SceneBuilder.createImage()","Can't create image from empty data");return this;}var e=new DataView(c.binaryData.buffer);var j=true;if(e.getUint8(0,true)===parseInt("0xFF",16)&&e.getUint8(1,true)===parseInt("0xD8",16)){j=false;}var k=o1(c.binaryData);var l="data:image/"+(j?"png":"jpeg")+";base64,"+btoa(k);this._images.set(c.id,l);var m=this._imageTextures.get(c.id);if(m){this._imageTextures.delete(c.id);for(var i=0;i<m.length;i++){var n=m[i];this.updateTextureMap(n.materialId,n.textureType);}}return this;};var q1=new THREE.TextureLoader();var r1={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glosiness:9,AmbientOcclusion:10,Decal:11};S.prototype.updateTextureMaps=function(m){var c=[];var e=this._getMaterialRef(m);if(!e){return c;}var i=e.userData.materialInfo;if(!i){return c;}if(i.textureDiffuse){var j=this.updateTextureMap(m,r1.Diffuse);if(j.imageId){c.push(j);}}else if(i.textureDecal){var k=this.updateTextureMap(m,r1.Decal);if(k.imageId){c.push(k);}}if(i.textureBump){var l=this.updateTextureMap(m,r1.Bump);if(l.imageId){c.push(l);}}if(i.textureOpacity){var n=this.updateTextureMap(m,r1.Opacity);if(n.imageId){c.push(n);}}if(i.textureEmissive){var p1=this.updateTextureMap(m,r1.Emissive);if(p1.imageId){e.emissive.setRGB(1,1,1);c.push(p1);}}if(i.textureAmbientOcclusion){var s1=this.updateTextureMap(m,r1.AmbientOcclusion);if(s1.imageId){c.push(s1);}}if(i.textureReflection){var t1=this.updateTextureMap(m,r1.Reflection);if(t1.imageId){c.push(t1);}}return c;};S.prototype.updateTextureMap=function(c,e){var i={textureType:e,imageId:null};var j=this._getMaterialRef(c);if(!j){return i;}var k=j.userData.materialInfo;if(!k){return i;}var l=null;switch(e){case r1.Diffuse:l=k.textureDiffuse;break;case r1.Decal:l=k.textureDecal;break;case r1.Bump:l=k.textureBump;break;case r1.Opacity:l=k.textureOpacity;break;case r1.Reflection:l=k.textureReflection;break;case r1.Emissive:l=k.textureEmissive;break;case r1.AmbientOcclusion:l=k.textureAmbientOcclusion;break;default:break;}if(!l){return i;}var n=l[0]||l;var p1=this._images.get(n.imageId);if(!p1){i.imageId=n.imageId;return i;}if(j.userData.imageIdsToLoad){j.userData.imageIdsToLoad.delete(n.imageId);if(j.userData.imageIdsToLoad.size===0){delete j.userData.imageIdsToLoad;}}if(j.userData.parametricType==="sphere"){n.uvHorizontalScale=-1;}var s1=n.influence!==undefined?n.influence:0;function t1(m,u1){switch(e){case r1.Diffuse:case r1.Decal:m.map=u1;m.transparent|=p1.startsWith("data:image/png");break;case r1.Bump:m.bumpMap=u1;m.bumpScale=s1;break;case r1.Opacity:m.alphaMap=u1;break;case r1.Reflection:u1.mapping=THREE.EquirectangularReflectionMapping;m.envMap=u1;m.combine=THREE.AddOperation;m.reflectivity=s1;break;case r1.Emissive:m.emissiveMap=u1;break;case r1.AmbientOcclusion:m.aoMap=u1;break;default:}m.needsUpdate=true;}q1.load(p1,function(m){m.wrapS=n.uvHorizontalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;m.wrapT=n.uvVerticalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;m.magFilter=n.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;m.minFilter=n.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter;m.anisotropy=4;var u1=n.uvHorizontalOffset||0;var v1=n.uvVerticalOffset||0;m.repeat.set(n.uvHorizontalScale||1,n.uvVerticalScale||1);m.center.set(-u1,-v1);m.offset.set(u1,v1);m.rotation=-n.uvRotationAngle;t1(j,m);var w1=this._materialClones.get(c);if(w1){w1.forEach(function(x1){t1(x1,m);});}if(this._fireSceneUpdated){this._fireSceneUpdated();}}.bind(this));return i;};S.prototype.insertPlayback=function(c,e,i){this._resetCurrentScene(i);var j=this._vkScene.findSequence(c.sequenceId);var k=new s(c.id,{sequence:j,timeScale:c.speed?1.0/c.speed:1,preDelay:c.preDelay?c.preDelay:0,postDelay:c.postDelay?c.postDelay:0,repeats:c.repeat?Math.abs(c.repeat):0,reversed:c.reversed?true:false,startTime:c.start?c.start:0});var l=this._views.get(e);if(l){l.addPlayback(k);}if(!j){T.pushElementIntoMapArray(this._sequenceIdToPlaybacks,c.sequenceId,k);}return this;};S.prototype.insertSequence=function(i,c){var e=this._vkScene.findSequence(i.id);if(e){return this;}var j;if(i.endTime){if(i.startTime){j=i.endTime-i.startTime;}else{j=i.endTime;}}else{j=1.0;}e=this._vkScene.createSequence(i.id,{name:i.name,duration:j});if(Array.isArray(i.joints)){i.joints.forEach(function(p1){var s1=this._joints[p1];if(s1){e.setJoint(s1,true);}}.bind(this));}if(i.nodes&&i.nodes.length>0){for(var n=0;n<i.nodes.length;n++){var k=i.nodes[n];if(k.empty){k.type=k.binding;var l=this._nodes.get(k.sid);this._animationHelper.insertEmptyTrack(k,e,l,this._vkScene);continue;}T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,k.trackId,{sequenceId:i.id,targetId:k.sid,type:k.binding,pivot:k.pivot,isAbsoluteValue:k.isAbsoluteValue});}}var m=this._sequenceIdToPlaybacks.get(i.id);if(m){m.forEach(function(p1){p1.setSequence(e);});}return this;};S.prototype.insertTracks=function(c){this._animationHelper.insertTracks(c,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);return this;};S.prototype.insertJoints=function(j,c){this._resetCurrentScene(c);this._joints=[];j.forEach(function(e){var n=this._nodes.get(e.childSid);var i=this._nodes.get(e.parentSid);var k={id:e.id,node:n,parent:i,translation:new Float32Array(e.t?e.t:[0,0,0]),quaternion:new Float32Array(e.q?e.q:[0,0,0,1]),scale:new Float32Array(e.s?e.s:[1,1,1])};if(!n){var l=this._jointNodesMap.get(e.childSid);if(!l){l=[];}l.push(k);this._jointNodesMap.set(e.childSid,l);}if(!i){var m=this._jointParentsMap.get(e.parentSid);if(!m){m=[];}m.push(k);this._jointParentsMap.set(e.parentSid,m);}this._joints.push(k);}.bind(this));return this;};S.prototype.finalizeAnimation=function(){var c=this._rootNode;if(c){while(c.parent){c=c.parent;}c.userData.tracks=this._tracks;}return this;};S.prototype.finalizePlaybacks=function(){var c=this._rootNode;if(c){while(c.parent){c=c.parent;}}else{return this;}if(!c.userData.animationNodeOriginalData){c.userData.animationNodeOriginalData=new Map();}var e;var i=this._viewGroups.entries();var n=i.next();while(!n.done){e=n.value[1];n=i.next();var j=[];for(var k=0;k<e.getViews().length;k++){if(e.getViews()[k].id){var l=this._views.get(e.getViews()[k].id);if(l){j.push(l);}}}}return this;};S.prototype.finalizeViewGroups=function(c){this._resetCurrentScene(c);var e=this._viewGroups.entries();var n=e.next();while(!n.done){var i=n.value[1];var j=n.value[0];if(!i||!i.views||!i.views.length){n=e.next();continue;}i.removeViews();for(var k=0;k<i.views.length;k++){var l=i.views[k].id;var m=this._views.get(l);if(m&&m.userData.viewInfo.thumbnailId&&!m.thumbnailData){var p1=this._images.get(m.userData.viewInfo.thumbnailId);if(p1){m.thumbnailData=p1;}}if(m){m.viewGroupId=j;i.addView(m);}}n=e.next();}return this;};S.prototype.insertViewGroup=function(i,c){this._resetCurrentScene(c);var e=this._viewGroups.get(i.id);if(!e){e=this._vkScene.createViewGroup({viewGroupId:i.id,name:i.name,description:i.description});this._viewGroups.set(i.id,e);}else{e.setViewGroupId(i.id);e.setName(i.name);e.setDescription(i.description);}e.type=i.type;e.metadata=i.metadata;e.veids=i.veids;e.views=i.views;e.sceneId=i.sceneId;return this;};S.prototype.getViewGroup=function(c,e){this._resetCurrentScene(e);var i=this._viewGroups.get(c);var j=[];if(i&&i.views){for(var k=0;k<i.views.length;k++){var l=i.views[k].id;var m=this._views.get(l);if(m){j.push(m);}}}return j;};S.prototype.insertView=function(c,e){this._resetCurrentScene(e);if(c.description){var i=new RegExp("^<[^>]*?>");if(i.test(c.description)){var j=new RegExp("(^(<[^>]*?>\s*)+)|((<[^>]*?>\s*)+$)","g");var k=c.description.replace(j,"");if(!k){c.description=k;}}}var l=this._vkScene.createView({viewId:c.viewId,name:c.name,description:c.description?"<pre style=\"white-space: pre-wrap;\">"+c.description+"</pre>":c.description,aspectRatio:c.safeAreaAspectRatio});l.userData={};l.userData.viewInfo=c;if(c.thumbnailId){var m=this._images.get(c.thumbnailId);if(m){l.thumbnailData=m;}else{this._viewThumbnails.set(c.thumbnailId,l);}}if(c.animatedThumbnailId){var n=this._images.get(c.animatedThumbnailId);if(n){l.animatedThumbnailData=n;l.tileWidth=this._imageIdsAndTileWidths.get(c.animatedThumbnailId);}}if(c.cameraId){l.setCamera(this._cameras.get(c.cameraId));}l.type=c.type;l.flyToTime=c.flyToTime;l.preDelay=c.preDelay;l.postDelay=c.postDelay;l.navigationMode=c.navigationMode;l.topColor=c.topColour;l.bottomColor=c.bottomColour;l.renderMode=I[c.renderMethod];l.dimension=c.dimension;l.query=c.query;l.metadata=c.metadata;l.veids=c.veids;l.viewGroupId=c.viewGroupId;l.id=c.viewId;this._views.set(c.viewId,l);if(l.viewGroupId){var p1=this._viewGroups.get(l.viewGroupId);if(p1){p1.addView(l);}}return this;};S.prototype.setModelViewVisibilitySet=function(i){var c=this._views.get(i.viewId);var e=new Set();var j=[];i.visibleNodes.forEach(function(n){var k=this._nodes.get(n);if(k){e.add(k);j.push({target:k,visible:true});}else{L.warning("Unknown modelView visible node reference",n);}}.bind(this));Array.from(e).forEach(function(n){n=n.parent;while(n&&!e.has(n)){e.add(n);j.push({target:n,visible:true});n=n.parent;}});c.updateNodeInfos(j);};S.prototype.recordHighlightedNodeInView=function(c,n,e,i){this._resetCurrentScene(i);var j=this._views.get(e);if(!j){return this;}var k=this._nodes.get(n);if(!k){return this;}j.addHighlightedNodes(c,k);return this;};S.prototype.insertHighlightStyle=function(i){var c=this._vkScene.getHighlight(i.id);if(c){return this;}if(i.duration>0){if(i.colours&&i.colours.length===1&&(!i.opacities||i.opacities.length===1)){var e=i.colours[0];i.colours.push([e[0],e[1],e[2],0]);}else if(!i.colours&&i.opacities&&i.opacities.length===1){i.opacities.push(0);}}this._vkScene.createHighlight(i.id,i);return this;};S.prototype.insertModelViewHighlight=function(i){var c=this._views.get(i.viewId);if(c){var e=[];i.highlightNodes.forEach(function(n){var m=this._nodes.get(n);if(m){e.push(m);}else{}}.bind(this));var j={duration:i.duration,cycles:i.cycles};if(!i.id){i.id=THREE.Math.generateUUID().toLowerCase();}var k=new THREE.Color(i.color1).toArray();var l=new THREE.Color(i.color2).toArray();k[3]=((i.color1>>>24)&255)/255;l[3]=((i.color2>>>24)&255)/255;j.colours=[k,l];j.opacities=[i.opacity1,i.opacity2];this._vkScene.createHighlight(i.id,j);c.addHighlightedNodes(i.id,e);}};S.prototype.createThumbnail=function(i){var c=this._viewThumbnails.get(i.imageId);if(c){c.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,i.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:c});}}};S.prototype.highlightStyleExists=function(i){var c=this._vkScene.getHighlight(i);return c!==undefined;};S.prototype.getView=function(c,e){this._resetCurrentScene(e);return this._views.get(c);};S.prototype.getSequence=function(c){return this._vkScene.findSequence(c);};S.prototype.setViewCamera=function(c,e,i){this._resetCurrentScene(i);var j=this._cameras.get(c);var k=this._views.get(e);if(j&&k){k.setCamera(j);}return this;};S.prototype.setViewNodeInfos=function(n,c,e){this._resetCurrentScene(e);var i=this._views.get(c);i.setNodeInfos(n);return this;};S.prototype.setViewThumbnail=function(i,c,e,j){this._resetCurrentScene(e);var k=this._views.get(c);var l=this._images.get(i);if(j){this._imageIdsAndTileWidths.set(i,j);}if(k&&l){if(k.userData!==undefined){if(k.userData.viewInfo.thumbnailId===i){k.thumbnailData=l;}else if(k.userData.viewInfo.animatedThumbnailId===i){k.animatedThumbnailData=l;k.tileWidth=j;}}}return this;};S.prototype.cleanup=function(){this._rootNode=null;if(this._vkScene){this._vkScene.clearMaterials();}this._callouts.forEach(function(c){c.destroy();});this._callouts.clear();this._cameras.forEach(function(c){if(!c instanceof THREE.Camera){c.destroy();}});this._cameras.clear();this._images.clear();this._imageIdsAndTileWidths.clear();this._imageTextures.clear();this._geometries.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._geometryMeshes.clear();this._materialMeshes.clear();this._materialClones.clear();this._currentSceneId=null;if(this._nodes){this._nodes.clear();}if(this._tracks){this._tracks.clear();}if(this._trackIdSequenceNodeMap){this._trackIdSequenceNodeMap.clear();}if(this._viewGroups){this._viewGroups.clear();}if(this._views){this._views.clear();}this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();};S.prototype.insertAnimationGroup=function(i){var c=this._vkScene.findSequence(i.animationGroupRef.toString());if(!c){var e;if(i.endTime){e=i.endTime-i.startTime;if(!i.startTime){i.startTime=0;}}c=this._vkScene.createSequence(i.animationGroupRef.toString(),{name:i.name,duration:e});if(!c.userData){c.userData={};}c.userData.animations=[];}if(i.modelViewRef){var m=this._views.get(i.modelViewRef);if(m){var j=this._vkScene.findSequence(i.animationGroupRef.toString());var k=new s({sequence:j,timeScale:i.playbackSpeed?1.0/i.playbackSpeed:1,preDelay:i.playbackPreDelay?i.playbackPreDelay:0,postDelay:i.playbackPostDelay?i.playbackPostDelay:0,repeat:i.playbackRepeat?Math.abs(i.playbackRepeat):0,reversed:i.playbackReversed?true:false,startTime:0});m.addPlayback(k);}}};S.prototype.insertAnimation=function(i){var c=this._animations.get(i.animationRef);if(!c){c={};c.type=i.animationType;c.targetRefs=[];c.targetPivots=[];c.sequenceId=i.animationGroupRef.toString();c.trackIds=new Set();c.tracks=[];this._animations.set(i.animationRef,c);}if(i.animationGroupRef){var e=this._vkScene.findSequence(i.animationGroupRef.toString());if(!e.userData.animations.includes(i.animationRef)){e.userData.animations.push(i.animationRef);}}};S.prototype.insertAnimationTarget=function(i){var c=this._animations.get(i.animationRef);if(c){if(!c.targetRefs.includes(i.targetRef)){c.targetRefs.push(i.targetRef);c.targetPivots.push({x:i.targetPivotX,y:i.targetPivotY,z:i.targetPivotZ});}}};S.prototype.insertAnimationTrack=function(i){var c=this._animationTracks.get(i.animationTrackRef);var e=i.animationRef;if(!c){delete i.animationRef;c=i;this._animationTracks.set(i.animationTrackRef,c);}if(!e){return;}var j=this._animations.get(e);if(!j||!j.sequenceId){return;}if(j.trackIds.has(c.animationTrackRef)){return;}j.trackIds.add(c.animationTrackRef);for(var k=0;j.targetRefs&&k<j.targetRefs.length;k++){var l=j.targetRefs[k];var m=j.targetPivots[k];var n=this._nodes.get(l);if(!n){continue;}var p1;if(m.x!==0||m.y!==0||m.z!==0){p1=[m.x,m.y,m.z];}var s1=["OPACITY","COLOUR","TRANSLATE","SCALE","ROTATE"][c.type]||"";T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,i.animationTrackRef,{sequenceId:j.sequenceId,targetId:l,type:s1,pivot:p1,isAbsoluteValue:true});var t1={};t1.times=Array.prototype.slice.call(c.times);t1.values=Array.prototype.slice.call(c.values);t1.id=i.animationTrackRef;t1.cyclicInfo={};t1.cyclicInfo.cyclicStart=c.cyclicStart;t1.cyclicInfo.cyclicEnd=c.cyclicEnd;var ki;if(j.type===0){if(c.dataType===0){if(c.values.length!==c.keyCount||c.times.length!==c.keyCount){continue;}if(c.type===3){t1.values=[];for(ki=0;ki<c.keyCount;ki++){t1.values.push(c.values[ki]);t1.values.push(c.values[ki]);t1.values.push(c.values[ki]);}}}else if(c.dataType===1||c.dataType===3){if(c.values.length!==3*c.keyCount||c.times.length!==c.keyCount){continue;}}else if(c.dataType===4||c.dataType===5||c.dataType===6){if(c.values.length!==4*c.keyCount||c.times.length!==c.keyCount){continue;}if(c.dataType===4){t1.rotateType=u.AngleAxis;}else if(c.dataType===6){t1.rotateType=u.Euler;}else{t1.rotateType=u.Quaternion;for(var vi=3;vi<t1.values.length;vi=vi+4){t1.values[vi]=-t1.values[vi];}}}}j.tracks.push(t1);}};S.prototype.setAnimationTracks=function(c){var e=this._animations.get(c);if(e){this._animationHelper.insertTracks(e.tracks,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);}};S.prototype.setAnimationPlaybacks=function(i){var c=this._viewGroups.get(i.viewGroupId);this._animationHelper.setInitialNodePositionsFromSubsequentViews(c.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromPreviousViews(c.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromCurrenetViews(c.getViews(),this._vkScene);this._animationHelper.setPlaybackStartTimes(c.getViews(),this._vkScene);this._animationHelper.buildViewsInitialState(c.getViews(),this._vkScene);};S.prototype.getSphere=function(n,c,m){var e=y.generateSphere(c,m);if(n.userData&&n.userData.nodeContentType){e.userData.nodeContentType=n.userData.nodeContentType;}e.userData.skipIt=true;e.renderOrder=n.renderOrder;n.add(e);};S.prototype.getPlane=function(n,c,m){var e=y.generatePlane(c,m);if(n.userData&&n.userData.nodeContentType){e.userData.nodeContentType=n.userData.nodeContentType;}e.userData.skipIt=true;e.renderOrder=n.renderOrder;n.add(e);};S.prototype.preferMeshes=function(){return true;};S.prototype.setParametricContent=function(n,c,e){this._resetCurrentScene(e);var i={"sphere":this.getSphere.bind(this),"plane":this.getPlane.bind(this)};if(c.type in i===false){L.warning("Attempt to load unkown parameteric type: "+c.type);return;}var j=c.type;var k=this.getNode(n,this.sceneId);var m=c.materialID;var l=null;if(m){l=this._getMaterialRef(m)||this._createTemporaryMaterial(m);if(k.userData.parametricVisible){l.userData.parametricType=j;}}i[j](k,c,l);};S.prototype.insertFillStyle=function(c){};S.prototype.insertLineStyle=function(l){};S.prototype.insertTextStyle=function(c){};return S;});
