/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../NodeHierarchy","../NodeContentType","sap/ui/base/ObjectPool","./BaseNodeProxy","./NodeProxy","./LayerProxy","../Messages","../DvlException","./checkResult","./getJSONObject","../getResourceBundle","sap/base/util/array/uniqueSort","sap/base/Log"],function(N,a,O,B,b,L,M,D,c,g,d,u,f){"use strict";var s={modeDictionary:{equals:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL_CASE_INSENSITIVE;},contains:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING_CASE_INSENSITIVE;},startsWith:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH_CASE_INSENSITIVE;}}};var h=N.extend("sap.ui.vk.dvl.NodeHierarchy",{metadata:{},_baseNodeProxyPool:new O(B),constructor:function(e){N.call(this);this._graphicsCore=e.getGraphicsCore();this._scene=e;this._dvlSceneRef=this._scene.getSceneRef();this._dvl=this._graphicsCore._getDvl();this._nodeProxies=[];this._layerProxies=[];}});h.prototype.destroy=function(){this._layerProxies.slice().forEach(this.destroyLayerProxy,this);this._nodeProxies.slice().forEach(this.destroyNodeProxy,this);this._dvl=null;this._dvlSceneRef=null;this._scene=null;this._graphicsCore=null;N.prototype.destroy.call(this);};h.prototype.getGraphicsCore=function(){return this._graphicsCore;};h.prototype.getScene=function(){return this._scene;};h.prototype.getSceneRef=function(){return this._dvlSceneRef;};h.prototype.enumerateChildren=function(n,e,i,p){if(typeof n==="function"){p=i;i=e;e=n;n=undefined;}var j;if(n){if(i||(g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){j=g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes;}else{j=[];}}else{j=g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes;}if(p){j.forEach(e);}else{var k=this._baseNodeProxyPool.borrowObject();try{j.forEach(function(n){k.init(this,n);e(k);k.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(k);}}return this;};h.prototype.enumerateAncestors=function(n,e,p){var i=g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes;if(p){i.forEach(e);}else{var j=this._baseNodeProxyPool.borrowObject();try{i.forEach(function(n){j.init(this,n);e(j);j.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(j);}}return this;};h.prototype.createNodeProxy=function(n){var e=new b(this,n);this._nodeProxies.push(e);return e;};h.prototype.destroyNodeProxy=function(n){var i=this._nodeProxies.indexOf(n);if(i>=0){this._nodeProxies.splice(i,1)[0].destroy();}return this;};h.prototype.getChildren=function(n,e){if(typeof n==="boolean"){e=n;n=undefined;}if(n){if(e||(g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){return g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes;}else{return[];}}else{return g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes;}};h.prototype.getAncestors=function(n){return g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes;};h.prototype.findNodesByName=function(q){var e=sap.ve.dvl.DVLFINDNODETYPE.DVLFINDNODETYPE_NODE_NAME,j=[],k,l;if(q===undefined||q===null||jQuery.isEmptyObject(q)){k=s.modeDictionary.contains(false);l=[""];}else{if(q.value===undefined||q.value===null||q.value===""){f.error(d().getText(M.VIT6.summary),M.VIT6.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}var p=q.hasOwnProperty("predicate")?q.predicate:"equals";if(p===undefined||p===null||p===""){f.error(d().getText(M.VIT7.summary),M.VIT7.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}else if(["equals","contains","startsWith"].indexOf(p)===-1){f.error(d().getText(M.VIT8.summary),M.VIT8.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}k=s.modeDictionary[p](q.caseSensitive);l=(typeof q.value==="string")?[q.value]:q.value;}for(var i=0;i<l.length;i++){j=j.concat(g(this._dvl.Scene.FindNodes(this._dvlSceneRef,e,k,l[i])).nodes);}return u(j);};h.prototype.createLayerProxy=function(l){var e=new L(this,l);this._layerProxies.push(e);return e;};h.prototype.destroyLayerProxy=function(l){var i=this._layerProxies.indexOf(l);if(i>=0){this._layerProxies.splice(i,1)[0].destroy();}return this;};h.prototype.getLayers=function(){return g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_LAYERS)).Layers;};h.prototype.getHotspotNodeIds=function(){var e=g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes);return e.length>0?e:this._getLegacyHotspotNodeIds();};h.prototype._getLegacyHotspotNodeIds=function(){var e=this.getLayers(),j=[];for(var i=0;i<e.length;i++){var l=this.createLayerProxy(e[i]),k=l.getName();if(k.toLowerCase()==="hotspots"){j=l.getNodes();this.destroyLayerProxy(l);break;}this.destroyLayerProxy(l);}return j;};h.prototype.createNode=function(p,n,i){var e=this._dvl.Scene.CreateNode(this._dvlSceneRef,p,n,i);this.fireNodeCreated({nodeRef:e,nodeId:e});this.fireChanged();return e;};h.prototype.createNodeCopy=function(n,p,e,i){var j=this._dvl.Scene.CreateNodeCopy(this._dvlSceneRef,n,p,sap.ve.dvl.DVLCREATENODECOPYFLAG.COPY_CHILDREN,e,i);this.fireNodeCreated({nodeRef:j,nodeId:j});this.fireChanged();return j;};h.prototype.getNodeContentType=function(n){return a.Regular;};h.prototype.removeNode=function(n){var i=[].concat(n);i.forEach(function(n){this.fireNodeRemoving({nodeRef:n,nodeId:n});try{c(this._dvl.Scene.DeleteNode(this._dvlSceneRef,n));}catch(e){var m="Failed to delete node with ID = "+n+".";if(e instanceof D){m+=" Error code: "+e.code+". Message: "+e.message+".";}f.error(m);}}.bind(this));this.fireChanged();return this;};return h;});
