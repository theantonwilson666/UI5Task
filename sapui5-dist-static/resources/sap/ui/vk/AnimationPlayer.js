/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","./Core","./AnimationMath","./AnimationTrackType","./AnimationTrackValueType","./glMatrix"],function(E,v,A,a,b,g){"use strict";var c=E.extend("sap.ui.vk.AnimationPlayer",{metadata:{associations:{viewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false}},events:{viewActivated:{type:"sap.ui.vk.View"},beforeTimeChanged:{time:{type:"float"},nextTime:{type:"float"},currentPlayback:{type:"sap.ui.vk.AnimationPlayback"},nextPlayback:{type:"sap.ui.vk.AnimationPlayback"}},timeChanged:{time:{type:"float"},previousTime:{type:"float"},currentPlayback:{type:"sap.ui.vk.AnimationPlayback"},previousPlayback:{type:"sap.ui.vk.AnimationPlayback"}},stateChanged:{playing:{type:"boolean"},stopped:{type:"boolean"},endOfAnimation:{type:"boolean"}}}},constructor:function(i,s){E.apply(this,arguments);v.observeLifetime(this);}});c.prototype._getViewStateManager=function(){var d=this.getViewStateManager();return d?sap.ui.getCore().byId(d):undefined;};c.prototype.init=function(){this._step=this._step.bind(this);this._playbackCollection=null;this._currentPlayback=null;this._time=0;this._nodeChanges=new Map();v.getEventBus().subscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);v.getEventBus().subscribe("sap.ui.vk","sequenceChanged",this._onSequenceChanged,this);v.getEventBus().subscribe("sap.ui.vk","playbacksChanged",this._onPlaybacksChanged,this);v.getEventBus().subscribe("sap.ui.vk","trackChanged",this._onTrackChanged,this);v.getEventBus().subscribe("sap.ui.vk","nodeAnimationRemoved",this._onNodeAnimationRemoved,this);};c.prototype.exit=function(){this._playbackCollection=null;this._currentPlayback=null;v.getEventBus().unsubscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);v.getEventBus().unsubscribe("sap.ui.vk","sequenceChanged",this._onSequenceChanged,this);v.getEventBus().unsubscribe("sap.ui.vk","playbacksChanged",this._onPlaybacksChanged,this);v.getEventBus().unsubscribe("sap.ui.vk","trackChanged",this._onTrackChanged,this);v.getEventBus().unsubscribe("sap.ui.vk","nodeAnimationRemoved",this._onNodeAnimationRemoved,this);};c.prototype._onViewApplied=function(d,e,f){if(f.source.getId()!=this.getViewStateManager()){return;}var h=f.view;var i=f.ignoreAnimationPosition;this.activateView(h,i);};c.prototype._onSequenceChanged=function(d,e,f){if(this._currentPlayback){var h=this._getViewStateManager();var s=this._currentPlayback.getSequence();if(h&&s){if(s.getId()===f.sequenceId){h.setJoints(s.getJoint(),this._currentPlayback);}}}this._clearPlaybackBoundaryProperties();this._setPlaybackBoundaryProperties();};c.prototype._resetNodesAnimation=function(n,p){if(!Array.isArray(n)){n=[n];}var d=this._getViewStateManager();n.forEach(function(e){if(p){d.resetNodeProperty(e,p);}else{d.resetNodeProperty(e);d.resetNodeProperty(e,a.Opacity);}});};c.prototype._onPlaybacksChanged=function(d,e,f){if(f.operation==="playbackRemoved"&&this._currentPlayback&&this._currentPlayback===f.playback&&this._currentPlayback.getSequence()){var h=this._currentPlayback.getSequence().getNodeAnimation();var i=h.map(function(j){return j.nodeRef;});this._resetNodesAnimation(i);}this._clearPlaybackBoundaryProperties();};c.prototype._onTrackChanged=function(d,e,f){this._clearPlaybackBoundaryProperties();if(f.emptyTrack&&this._currentPlayback){var h=this._getViewStateManager();var s=this._currentPlayback.getSequence();if(h&&s){var i=s.getNodeAnimation();i.forEach(function(j){for(var t in a){var k=a[t];var l=j[k];if(l&&l.getId()===f.trackId){h.resetNodeProperty(j.nodeRef,k);return;}}});}this._setPlaybackBoundaryProperties();}};c.prototype._onNodeAnimationRemoved=function(d,e,f){if(this._currentPlayback){var h=this._getViewStateManager();var s=this._currentPlayback.getSequence();if(h&&s){if(s.getId()===f.sequenceId){h.setJoints(s.getJoint(),this._currentPlayback);this._resetNodesAnimation(f.nodeRefs,f.property);}}}this._clearPlaybackBoundaryProperties();};c.prototype.getAnimatedProperty=function(n,p){var r={};var d=this._getViewStateManager();if(!d){return null;}if(p!==a.Opacity){var w=d.getTransformationWorld(n);if(p===a.Rotate){r.world=w.quaternion;}else if(p===a.Translate){r.world=w.translation;}else{r.world=w.scale;}}var e=this._nodeChanges.get(n);if(!e||e[p]===undefined){r.offsetToPrevious=null;r.offsetToRest=null;if(p===a.Opacity){r.absolute=d.getOpacity(n);r.totalOpacity=d.getTotalOpacity(n);}else{var t=d.getTransformation(n);if(p===a.Rotate){r.absolute=t.quaternion;}else if(p===a.Translate){r.absolute=t.translation;}else{r.absolute=t.scale;}}return r;}if(p===a.Opacity){var o=e[p];r.offsetToRest=o;r.offsetToPrevious=e.offsetToPrevious[p];r.opacity=e.absolute.opacity;r.totalOpacity=e["totalOpacity"];return r;}var f=e[p];r.offset=f;if(p===a.Rotate){r.absolute=e.absolute.quaternion;}else if(p===a.Translate){r.absolute=e.absolute.translate;}else{r.absolute=e.absolute.scale;}r.offsetToPrevious=e.offsetToPrevious[p];r.offsetToRest=e[p];return r;};c.prototype.setTime=function(t,p,d){this._setPlaybackBoundaryProperties();this._setTime(t,p,d);return this;};c.prototype._setTime=function(t,p,d){var e=this._time;var f=this._currentPlayback;if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){this._currentPlayback=undefined;this._time=0;}else{if(p!=null){t=this._getAbsoluteTime(t,p);}var h=this._getViewStateManager();var i=this._currentPlayback;var n;if(t<0||t>this.getTotalDuration()){n=undefined;}else if(p!=null){n=this._playbackCollection.getPlayback(p);}else{n=this._findPlaybackByAbsoluteTime(t);}if(!d&&(t!==this._time||n!==this._currentPlayback)){this.fireBeforeTimeChanged({time:this._time,nextTime:t,currentPlayback:this._currentPlayback,nextPlayback:n});}this._time=t;this._currentPlayback=n;if(h&&this._currentPlayback&&i!==this._currentPlayback){var s=this._currentPlayback.getSequence();if(s){h.setJoints(s.getJoint(),this._currentPlayback);}}else if(!this._currentPlayback||!this._currentPlayback.getSequence()){h.setJoints(undefined);}if(h){var j={nodeRefs:[],positions:[]};var o={nodeRefs:[],opacities:[]};this._collectNodeChanges();this._nodeChanges.forEach(function(k,l){var m={rtranslate:k.rtranslate,rscale:k.rscale,rrotate:k.rrotate,Euler:k.Euler,ropacity:k.offsetToPrevious&&k.offsetToPrevious.ropacity?k.offsetToPrevious.ropacity:k.ropacity};h.setInterpolatedRelativeValues(l,m);var r=h.getRestTransformation(l);var q=h._addToTransformation(r,k.rtranslate,k.rrotate,k.rscale,k.originalRotationType,k.Euler);if(q){j.nodeRefs.push(l);j.positions.push(q);k.absolute={};k.absolute.translate=q.translation;k.absolute.scale=q.scale;k.absolute.quaternion=q.quaternion;}if(k[a.Opacity]!==undefined){var u=h.getRestOpacity(l);if(u===0){u=1;}var w=k[a.Opacity]*u;l.userData.animatedOpacity=true;k.absolute={};k.absolute.opacity=w;o.nodeRefs.push(l);o.opacities.push(w);}},this);h.setTransformation(j.nodeRefs,j.positions);h.setOpacity(o.nodeRefs,o.opacities);h._propagateOpacityToJointChildren(o.nodeRefs,o.opacities);h._setJointNodeMatrix();this._nodeChanges.forEach(function(k,l){if(k[a.Opacity]!==undefined){k.totalOpacity=h.getTotalOpacity(l);}},this);}}if(!d&&(this._time!==e||this._currentPlayback!==f)){this.fireTimeChanged({time:this._time,previousTime:e,currentPlayback:this._currentPlayback,previousPlayback:f});}};c.prototype.getTime=function(){return this._time;};c.prototype.getCurrentPlayback=function(){return this._currentPlayback;};c.prototype.getCurrentPlaybackTime=function(){var t=this._time;var p=this._playbackCollection.getPlaybacks();if(!Array.isArray(p)||!this.getCurrentPlayback()){return-1;}var i=0;while(p[i]!=this.getCurrentPlayback()){t-=p[i].getDuration();i++;}return t;};c.prototype.getStartTime=function(p){if(!this._playbackCollection){return undefined;}if(typeof p==="number"){p=this._playbackCollection.getPlayback(p);}return p?p.getStartTime():undefined;};c.prototype.getTotalDuration=function(){if(!this._playbackCollection){return 0;}var t=0;this._playbackCollection.getPlaybacks().forEach(function(p){t+=p.getDuration();});return t;};c.prototype._step=function(t){if(!this._lastFrameTimestamp){this._lastFrameTimestamp=t;}var p=t-this._lastFrameTimestamp;this._lastFrameTimestamp=t;var n=this.getTime()+p/1000;var r=n>=0&&n<=this.getTotalDuration();if(n>this.getTotalDuration()){n=this.getTotalDuration();}this.setTime(n);if(r){this._frameId=window.requestAnimationFrame(this._step);}else{this.stop();}};c.prototype._interpolate=function(d,e,t,f,h){if(!e.before&&!e.after){return undefined;}if(!e.before){e.before=e.after;}if(!e.after){if(d===b.AngleAxis){e.after={value:[0,0,1,0],time:e.before.time};}else{e.after=e.before;}}var k;if(e.before.time===e.after.time){k=1;}else{k=(e.time-e.before.time)/(e.after.time-e.before.time);}return A.interpolate(d,e.before,e.after,k,t,f,h);};c.getBoundaryKey=function(t,i){var d=t.getKeysCount();if(!d){return null;}var e;if(i){e=t.getKey(0);}else{e=t.getKey(d-1);}var f=t.getKeysType();var q,r={};if(f===b.Euler){r[f]=e.value;q=A.neutralEulerToGlMatrixQuat(e.value);r.value=A.glMatrixQuatToNeutral(q);r.time=e.time;}else if(f===b.Quaternion){q=A.neutralQuatToGlMatrixQuat(e.value);r.value=A.glMatrixQuatToNeutral(q);r.time=e.time;}else if(f!==b.AngleAxis){r.value=e.value;r.time=e.time;}else{var h;var k=1;if(i){h=e;if(d>1){h=t.getKey(1);k=0;}}else{h=e;if(d>1){e=t.getKey(d-2);}}r=A.interpolate(f,e,h,k,t);r.time=i?e.time:h.time;}return r;};c.prototype._getKeyFramesBracket=function(t,d){var k=d.getKeysCount();if(k===0){return null;}var r={time:t,before:undefined,after:undefined};for(var i=0;i<k;i++){var e=d.getKey(i);if(e.time===t){r.before=r.after=e;break;}else if(e.time>t){r.before=(i===0?undefined:d.getKey(i-1));r.after=e;break;}}if(!r.before&&!r.after&&k>0){r.before=d.getKey(k-1);}if(k>1&&(!r.after&&d.isCycleForward()||!r.before&&d.isCycleBackward())){var f=d.getKey(0).time;var h=d.getKey(k-1).time-f;var j=Math.floor((t-f)/h);var l=t-h*j;return this._getKeyFramesBracket(l,d);}return r;};c.prototype._collectNodeChangesFromPlaybackBoundaryKeys=function(n,p,i){var s=p.getSequence();if(!s){return;}var d=s.getNodeAnimation();if(!d){return;}var e=this._getViewStateManager();var t=this;var f=function(k,l,m){if(!k||!l||m===undefined||m===null){return;}var o=n.get(k);if(o&&o.hasOwnProperty(l)){return;}if(!o){o={};n.set(k,o);}if(!o.offsetToPrevious){o.offsetToPrevious={};}if(l===a.Opacity){o[l]=m;if(!o.offsetToPrevious[l]){var q=e.getOpacity(k);var r=e.getRestOpacity(k);if(r===0){r=1;}if(r>0&&(q!==undefined||q!==null)){var u=e._getEndPropertyInPreviousPlayback(k,l,t._currentPlayback);if(u){q/=u;}o.offsetToPrevious[l]=q/r;}else{o.offsetToPrevious[l]=1;}}}else{o[l]=m.slice();var w=e.getRelativeTransformation(k);if(l===a.Scale){if(!o.offsetToPrevious[l]){o.offsetToPrevious[l]=w.scale.slice();var x=e._getEndPropertyInPreviousPlayback(k,l,t._currentPlayback);if(x){o.offsetToPrevious[l][0]/=x[0];o.offsetToPrevious[l][1]/=x[1];o.offsetToPrevious[l][2]/=x[2];}}}if(l===a.Translate){if(!o.offsetToPrevious[l]){o.offsetToPrevious[l]=w.translation.slice();var y=e._getEndPropertyInPreviousPlayback(k,l,t._currentPlayback);if(y){o.offsetToPrevious[l][0]-=y[0];o.offsetToPrevious[l][1]-=y[1];o.offsetToPrevious[l][2]-=y[2];}}}if(l===a.Rotate){o.offsetToPrevious[l]=[0,0,1,0];}else if(!o.offsetToPrevious[l]){o.offsetToPrevious[l]=[0,0,0];}}};var h;if(i){h=p._getNodeEndPropertiesMap();}else{h=p._getNodeStartPropertiesMap();}if(!h){return;}if(this._currentPlayback){var j=this._currentPlayback.getSequence();h.forEach(function(k,l){for(var m in k){if(j._isNodePropertyDefined(l,m)){continue;}f(l,m,k[m]);}},this);}};c.prototype._collectSequenceNodeChanges=function(t,n,p,i){var s=p.getSequence();var d=s.getNodeAnimation();if(!d){return;}var e=this._getViewStateManager();var f=function(k,l,r,m){if(!k||!l||!r||r.value===undefined||r.value===null){return;}var o=n.get(k);if(!o){o={};n.set(k,o);}if(!o.animationProperties){o.animationProperties={};}o.animationProperties[l]=true;if(m){o.originalRotationType=m;}if(!o.offsetToPrevious){o.offsetToPrevious={};}var u;if(l===a.Opacity){o[l]=r.value;o.offsetToPrevious[l]=r.value;u=e._getEndPropertyInPreviousPlayback(k,l,p,true);if(u){o[l]*=u;}}else{o[l]=r.value.slice();o.offsetToPrevious[l]=r.value.slice();u=e._getEndPropertyInPreviousPlayback(k,l,p);if(u){if(l===a.Translate){o[l][0]+=u[0];o[l][1]+=u[1];o[l][2]+=u[2];}else if(l===a.Scale){o[l][0]*=u[0];o[l][1]*=u[1];o[l][2]*=u[2];}}}if(m===b.Euler||m===b.AngleAxis){o[m]=r[m].slice();o.offsetToPrevious[l]=r[m].slice();if(u){var w=A.neutralQuatToGlMatrixQuat(u);var x=A.neutralQuatToGlMatrixQuat(o[l]);var q=g.quat.multiply(g.quat.create(),x,w);o[l]=A.glMatrixQuatToNeutral(q);}}};var h=p.getReversed();var j=s.getDuration();d.forEach(function(k){var l;for(var m in a){var o=a[m];var q=k[o];if(q&&q.getKeysCount()&&(!i||(i&&q.isInfinite()))){l=this._getKeyFramesBracket(t,q);if(!l){return;}var r=q.getKeysType();var u=null;if(h){if(r===b.AngleAxis){u=this._interpolate(r,l,q,o,true);}else{var w=this._getKeyFramesBracket(j,q);var x=this._interpolate(r,w,q,o);u=this._interpolate(r,l,q,o,x.value);}}else{u=this._interpolate(r,l,q,o);}if(o===a.Rotate){f(k.nodeRef,o,u,r);}else{f(k.nodeRef,o,u);}}}},this);};c.prototype._collectPlaybackNodeChanges=function(d,n,p){var s=p.getSequence();if(!s){return;}var t=d-p.getStartTime();if(t<0){return;}var e=s.getDuration()*p.getTimeScale()*p.getRepeats();var f=(t-p.getPreDelay())/p.getTimeScale();var h=0.0001;if(f>0&&f%s.getDuration()===0){f=s.getDuration();}else if(f>s.getDuration()+h){f=f%s.getDuration();}else if(f>s.getDuration()){f=s.getDuration();}f=p.getReversed()?p.getSequence().getDuration()-f:f;if(t<p.getPreDelay()){if(t===0){this._collectSequenceNodeChanges(f,n,p,false);}}else if(t>p.getPreDelay()+e+h){this._collectSequenceNodeChanges(f,n,p,true);}else{this._collectSequenceNodeChanges(f,n,p,false);}};c.prototype._collectNodeChanges=function(){this._nodeChanges.clear();if(!this._currentPlayback){return;}var p=this._playbackCollection.getPlaybacks();var d=this.getTime();var i;var e=0;for(i=0;i<p.length;i++){if(this._currentPlayback&&this._currentPlayback!==p[i]){continue;}this._collectPlaybackNodeChanges(d,this._nodeChanges,p[i]);e=i;}if(!this._currentPlayback.getReversed()){for(i=e-1;i>=0;i--){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],true);}for(i=e+1;i<p.length;i++){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],false);}}else{for(i=e+1;i<p.length;i++){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],false);}for(i=e-1;i>=0;i--){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],true);}}};c.prototype._clearPlaybackBoundaryProperties=function(){if(!this._playbackCollection){return;}var p=this._playbackCollection.getPlaybacks();for(var i=0;p&&i<p.length;i++){var d=p[i];if(!d){continue;}d._clearNodesBoundaryProperties();}};c.prototype._setPlaybackBoundaryProperties=function(f){if(!this._playbackCollection){return;}var d=this._time;var e=this._currentPlayback;var n=false;var p=this._playbackCollection.getPlaybacks();var i;var t=0;var h,s;if(f){this._clearPlaybackBoundaryProperties();}for(i=0;i<p.length;i++){h=p[i];if(!h){continue;}var j=this._getViewStateManager();s=h.getSequence();if(j&&s){if(!f&&h._hasCompleteNodesBoundaryProperties()){continue;}t=h.getPreDelay();this._setTime(t,i,true);h._setCurrentNodesPropertiesAsBoundary(j,false,f);t+=s.getDuration();this._setTime(t,i,true);h._setCurrentNodesPropertiesAsBoundary(j,true,f);n=true;}}if(n){if(!e){this._time=d;this._setTime(this._time,null,true);this._currentPlayback=e;}else{var k=-1;var l=0;for(i=0;i<p.length;i++){h=p[i];if(h===e){k=i;break;}var m=0;s=h.getSequence();if(s){m=s.getDuration()*h.getTimeScale()*h.getRepeats();}l+=h.getPreDelay()+m+h.getPostDelay();}if(k!==-1){var o=d-l;this._setTime(o,k,true);}}}};c.prototype.play=function(){this._lastFrameTimestamp=undefined;this._frameId=window.requestAnimationFrame(this._step);v.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:true,stopped:false,endOfAnimation:false});this.fireStateChanged({playing:true,stopped:false});return this;};c.prototype.stop=function(){if(this._frameId){window.cancelAnimationFrame(this._frameId);this._frameId=undefined;}this._lastFrameTimestamp=undefined;this.fireStateChanged({playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});v.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});return this;};c.prototype.activateView=function(d,p){this.stop();var e=this._getViewStateManager();var f=d.getPlaybacks();if(f&&f.length>0){for(var i=0;i<f.length;i++){var h=f[i];var s=h.getSequence();if(s){e._convertTracksToRelative(s,h.getReversed());}}}if(!p){this._playbackCollection=d;}else{this._playbackCollection=undefined;}this._currentPlayback=undefined;this.setTime(0);if(p){this._playbackCollection=d;}this.fireViewActivated({view:d});return this;};c.prototype._getAbsoluteTime=function(t,p){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return-1;}var d=this._playbackCollection.getPlaybacks();if(p<0||p>=d.length){return-1;}var e=this._playbackCollection.getPlayback(p);if(!e||e.getDuration()<t||t<0){return-1;}var f=t;var i=0;while(i<p){var h=d[i].getDuration();f+=h;i++;}return f;};c.prototype._findPlaybackByAbsoluteTime=function(t){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return undefined;}var p=this._playbackCollection.getPlaybacks();var l=-1;var d=-1;p.forEach(function(f,h){if(f.getStartTime()>d){l=h;d=f.getStartTime();}});var i=0;while(i<p.length){var e=p[i].getDuration();var s=p[i].getStartTime();if((i!==l&&t>=s&&t<(s+e))||(i===l&&t>=s&&t<=(s+e))){return p[i];}i++;}return undefined;};return c;});
