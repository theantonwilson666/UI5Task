/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./library","sap/ui/core/Control","sap/ui/table/TreeTable","sap/ui/table/Column","sap/ui/model/json/JSONModel","sap/ui/core/Core","sap/ui/core/ResizeHandler","sap/m/Title","sap/m/SearchField","sap/m/Toolbar","sap/m/ToolbarLayoutData","sap/m/ToolbarSpacer","sap/m/Text","sap/ui/core/Icon","./Core","./ViewStateManager","./SceneTreeRenderer","./getResourceBundle"],function(v,C,T,a,J,c,R,b,S,d,e,f,g,I,h,V,j,k){"use strict";var m=C.extend("sap.ui.vk.SceneTree",{metadata:{library:"sap.ui.vk",properties:{title:{type:"string",defaultValue:k().getText("SCENETREE_TITLE")},showTitle:{type:"boolean",defaultValue:true},showSearchField:{type:"boolean",defaultValue:true}},aggregations:{treeTable:{type:"sap.ui.table.TreeTable",multiple:false}},associations:{contentConnector:{type:"sap.ui.vk.ContentConnector",multiple:false},viewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false}},events:{contentChanged:{enableEventBubbling:true}}},constructor:function(i,s){C.apply(this,arguments);h.observeAssociations(this);}});var n="sap-icon://show",o="sap-icon://hide";var t=k().getText("SCENETREE_VISIBILITYSTATEVISIBLE"),p=k().getText("SCENETREE_VISIBILITYSTATEHIDDEN");m.prototype._createNodeForSceneTree=function(i,l,q){var r=q.getVisibilityState(l);return{name:i,id:l,visible:r};};m.prototype.setScene=function(s,i){this.setViewStateManager(i);this._setScene(s);};m.prototype._setScene=function(s){this._scene=s;this.refresh();};m.prototype.init=function(){if(C.prototype.init){C.prototype.init.apply(this);}var i=this;this._title=new b({width:"100%",textAlign:sap.ui.core.TextAlign.Center,text:this.getTitle()});this._searchField=new S({layoutData:new e({shrinkable:true,maxWidth:"400px"}),search:function(q){var r=q.getParameter("query"),s=i._scene.getDefaultNodeHierarchy(),u=i._viewStateManager;if(s&&u){var w=!r?[]:s.findNodesByName({value:r,predicate:"contains"});var x=new Set(w);var y=[];u.enumerateSelection(function(z){if(!x.has(z)){y.push(z);}});u.setSelectionState(y,false,false);u.setSelectionState(w,true,false);}}});this._toolbar=new d({content:[this._title,new f(),this._searchField]});var l=new I({src:n,tooltip:t,width:"2em",height:"1.3em",size:"1.2em",press:function(q){var r=this.getSrc()!==n;this.setSrc(r?n:o);this.setTooltip(r?t:p);i._toggleVisibilityForAllChildren(i._model.getData(),r);}});this._tree=new T({title:this._toolbar,columnHeaderHeight:32,columns:[new a({label:k().getText("SCENETREE_NAME"),tooltip:k().getText("SCENETREE_NAME"),template:new g({text:"{name}",maxLines:1,tooltip:"{name}"}),resizable:false}),new a(this.getId()+"-visibilityColumn",{label:l,template:new I({src:{path:"",formatter:function(q){if(!q){return null;}return q.visible?n:o;}},tooltip:{path:"",formatter:function(q){if(!q){return null;}return q.visible?t:p;}},height:"1.3em",size:"1.2em",press:function(q){var r=i._tree.getContextByIndex(this.getParent().getIndex());var s=r?r.getObject():null;if(s){i._viewStateManager.setVisibilityState(s.id,!s.visible,false);}}}),width:"2.5em",resizable:false,hAlign:"Center"})],enableSelectAll:false,selectionMode:"MultiToggle",selectionBehavior:"RowSelector",visibleRowCountMode:"Fixed",expandFirstLevel:false,collapseRecursive:false,rowHeight:32});this.setAggregation("treeTable",this._tree);this.attachContentChanged(function(q){l.setSrc(n);l.setTooltip(t);});this._scene=null;this._syncing=false;this._updateSelectionTimer=0;this._updateVisibilityTimer=0;this._model=new J();this._tree.setModel(this._model);this._tree.bindRows({path:"/"});this._tree.attachRowSelectionChange(this._handleRowSelectionChange.bind(this));this._tree.attachFirstVisibleRowChanged(this._updateSelection.bind(this));this._tree.getBinding("rows").attachChange(this._dataChange.bind(this));};m.prototype.setTitle=function(i){this.setProperty("title",i,true);this._title.setText(i);return this;};m.prototype.setShowTitle=function(i){this.setProperty("showTitle",i,true);this._title.setVisible(i);this._updateTitleBar();return this;};m.prototype.setShowSearchField=function(i){this.setProperty("showSearchField",i,true);this._searchField.setVisible(i);this._updateTitleBar();return this;};m.prototype._updateTitleBar=function(){this._tree.setTitle(this.getShowTitle()||this.getShowSearchField()?this._toolbar:null);this._handleResize();};m.prototype.onBeforeRendering=function(){this._tree.setVisible(true);if(!this._resizeListenerId){this._resizeListenerId=R.register(this,this._handleResize.bind(this));}};m.prototype._handleRowSelectionChange=function(l){if(this._syncing||this._tree.getBinding("rows")._aSelectedContexts!=undefined){return;}var s=[];var q=[];var r=l.getParameter("rowIndices");for(var i in r){var u=r[i];var w=this._tree.getContextByIndex(u);var x=w?w.getObject().id:null;if(x){(this._tree.isIndexSelected(u)?s:q).push(x);}}if(s.length>0){this._viewStateManager.setSelectionState(s,true);}if(q.length>0){this._viewStateManager.setSelectionState(q,false);}};m.prototype._onSelectionChanged=function(q){if(this._syncing){return;}function r(u,w){var x=u.getBinding("rows");if(x){for(var i=u.getFirstVisibleRow(),l=Math.min(i+u.getVisibleRowCount(),x.getLength());i<l;i++){var y=x.getContextByIndex(i);if(y&&y.getObject().id===w){return true;}}}return false;}var s=q.getParameter("selected");if(s.length===1&&!r(this._tree,s[0])){if(this._updateSelectionTimer>0){clearTimeout(this._updateSelectionTimer);this._updateSelectionTimer=0;}this._expandToNode(s[0],this._updateSelection.bind(this));}else if(this._updateSelectionTimer===0){this._updateSelectionTimer=setTimeout(this._updateSelection.bind(this),0);}};m.prototype._updateSelection=function(){this._updateSelectionTimer=0;if(this._syncing){return;}this._syncing=true;var q=this._viewStateManager,r=this._tree,s=r.getBinding("rows");if(q&&s){for(var i=r.getFirstVisibleRow(),l=Math.min(i+r.getVisibleRowCount(),s.getLength());i<l;i++){var u=s.getContextByIndex(i);if(u){var w=u.getObject().id;if(w){var x=q.getSelectionState(w);if(x!=r.isIndexSelected(i)){r[x?"addSelectionInterval":"removeSelectionInterval"](i,i);}}}}}this._syncing=false;};m.prototype._expandToNode=function(i,l){var q={tree:this._tree,rows:this._tree.getBinding("rows"),index:0,nodeRef:i,ancestors:new Set(this._scene.getDefaultNodeHierarchy().getAncestors(i)),callback:l};function s(u,w,x){var y=u.getFirstVisibleRow(),z=u.getVisibleRowCount();if((w<y)||(w>=(y+z))){y=Math.min(Math.max(w-(z>>1),0),x-z);setTimeout(function(){u.setFirstVisibleRow(y);},0);}}function r(q,u){if(u&&u.getParameter("reason")!=="expand"){return;}var w=q.rows.getLength();while(q.index<w){var x=q.rows.getContextByIndex(q.index);if(!x){break;}var i=x.getObject().id;if(i===q.nodeRef){s(q.tree,q.index,w);break;}if(q.ancestors.has(i)&&!q.tree.isExpanded(q.index)){q.tree.expand(q.index++);return;}q.index++;}q.rows.detachChange(q.expandHandlerProxy);q.callback();}q.expandHandlerProxy=r.bind(this,q);q.rows.attachChange(q.expandHandlerProxy);r(q);};m.prototype._dataChange=function(i){var r=i.getParameter("reason");if((r==="expand"||r==="collapse")&&this._updateSelectionTimer===0){this._updateSelectionTimer=setTimeout(this._updateSelection.bind(this),0);}};m.prototype._toggleVisibilityForAllChildren=function(l,q){var r=l.hasOwnProperty("children")?l.children:l;for(var i=0;r[i]!=null;i++){this._viewStateManager.setVisibilityState(r[i].id,q,true);}};m.prototype._onVisibilityChanged=function(i){if(this._updateVisibilityTimer===0){this._updateVisibilityTimer=setTimeout(this._updateVisibility.bind(this),0);}};m.prototype._updateVisibility=function(){this._updateVisibilityTimer=0;this._getNodeVisibilityRecursive(this._model.getData());this._tree.getModel().refresh(true);};m.prototype._getNodeVisibilityRecursive=function(l){if(l.id!=null){l.visible=this._viewStateManager.getVisibilityState(l.id);}var q=l.hasOwnProperty("children")?l.children:l;for(var i=0;q[i]!=null;i++){this._getNodeVisibilityRecursive(q[i]);}};m.prototype._handleResize=function(i){var l=i?i.size.height:this.getDomRef().clientHeight;var q=this._tree.getTitle()?2.1:1.1;this._tree.setVisibleRowCount(Math.max(Math.floor(l/(this._tree.getRowHeight()+1)-q),0));this._updateSelection();};m.prototype.refresh=function(){if(!this._scene||!this._viewStateManager||!this._viewStateManager.getNodeHierarchy()){this._model.setData([]);return;}var i=this._scene.getDefaultNodeHierarchy();var l=[];var q=function(l,r){r.forEach(function(s){if(s.userData&&s.userData.skipIt){q(l,i.getChildren(s));}else{var u=i.createNodeProxy(s);var w=this._createNodeForSceneTree(u.getName(),u.getNodeRef(),this._viewStateManager);l.push(w);i.destroyNodeProxy(u);w.children=[];q(w.children,i.getChildren(s));}}.bind(this));}.bind(this);q(l,i.getChildren());this._model.setData(l);this._tree.setModel(this._model);this._tree.bindRows({path:"/",parameters:{arrayNames:["children"]}});this._tree.getBinding("rows").attachChange(this._dataChange.bind(this));this.fireContentChanged();};m.prototype.onSetViewStateManager=function(i){this._viewStateManager=i;i.attachNodeHierarchyReplaced(this._onNodeHierarchyReplaced,this);i.attachSelectionChanged(this._onSelectionChanged,this);i.attachVisibilityChanged(this._onVisibilityChanged,this);this.refresh();};m.prototype.onUnsetViewStateManager=function(i){this._viewStateManager=null;i.detachVisibilityChanged(this._onVisibilityChanged,this);i.detachSelectionChanged(this._onSelectionChanged,this);i.detachNodeHierarchyReplaced(this._onNodeHierarchyReplaced,this);this.refresh();};m.prototype._onNodeHierarchyReplaced=function(i){this.refresh();};m.prototype._setContent=function(i){this._setScene(i);};m.prototype.onSetContentConnector=function(i){i.attachContentReplaced(this._onContentReplaced,this);i.attachContentChangesFinished(this._onContentChangesFinished,this);this._setContent(i.getContent());};m.prototype.onUnsetContentConnector=function(i){this._setContent(null);i.detachContentChangesFinished(this._onContentChangesFinished,this);i.detachContentReplaced(this._onContentReplaced,this);};m.prototype._onContentReplaced=function(i){this._setContent(i.getParameter("newContent"));};m.prototype._onContentChangesFinished=function(i){this.refresh();};return m;});
