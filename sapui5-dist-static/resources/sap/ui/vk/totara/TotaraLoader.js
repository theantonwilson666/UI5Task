sap.ui.define(["sap/base/Log","./SceneContext","./CallbackHandler","./Command","./TotaraUtils","../helpers/WorkerScriptLoader"],function(L,S,C,a,T,W){"use strict";var b=T.mark;var c=function(){this._pushMesh=false;this._performanceTimingMsg=[];this._isPostable=true;this._suppressSendRequests=false;this._loadingFinishedSent=false;this.currentSceneInfo={};this.contextMap=new Map();this.tokenContextMap=new Map();this._skipLowLODRendering=false;this._maxUrlLength=2*1024;this._maxActiveRequests=4;this._meshesBatchSize=128;this._materialsBatchSize=128;this._geometriesBatchSize=128;this._geometriesMaxBatchDataSize=1024*1024;this._geomMeshesBatchSize=128;this._geomMeshesMaxBatchDataSize=1024*1024;this._annotationsBatchSize=128;this._tracksBatchSize=128;this._sequencesBatchSize=128;this._voxelThreshold=0.0;this.onErrorCallbacks=new C();this.onImageFinishedCallbacks=new C();this.onMaterialFinishedCallbacks=new C();this.onSetGeometryCallbacks=new C();this.onSetSequenceCallbacks=new C();this.onSetTrackCallbacks=new C();this.onViewGroupUpdatedCallbacks=new C();this.onLoadingFinishedCallbacks=new C();};c.prototype.running=function(){return this._worker!==null&&this._worker!==undefined;};c.prototype.run=function(){var t=this;return new Promise(function(r){if(!t._worker){t._worker=W.loadScript("sap/ui/vk/totara/TotaraLoaderWorker.js");t._worker.onmessage=function(e){var d;var f=e.data;if(f.ready){return;}f.jsonContent=f.jsonContent||{};if(f.jsonString){var j=JSON.parse(f.jsonString);delete f.jsonString;f.jsonContent=Object.assign(j,f.jsonContent);}if(f.name==="getAuthorization"){if(f.sceneId){d=t.getContext(f.sceneId);}if(d&&d.authorizationHandler){d.authorizationHandler(f.jsonContent.url).then(function(i){t.postMessage({"method":"setAuthorization","authorizationToken":i});}).catch(function(i){t.postMessage({"method":"setAuthorization","authorizationToken":null,"error":i.toString()});});}else{t.postMessage({"method":"setAuthorization","authorizationToken":null});}return;}if(f.name==="protocol"){t.protocolVersion=f.jsonContent.version.split(".").map(function(s){return parseInt(s,10);});return;}if(f.name==="batchSizeInfo"){var g=f.jsonContent.batchSizeInfo;var h=t.getContext(f.jsonContent.sceneId).requestQueue;h.meshes.setBatchSizeInfo(g[a.getMesh]);h.materials.setBatchSizeInfo(g[a.getMaterial]);h.geometries.setBatchSizeInfo(g[a.getGeometry]);h.geomMeshes.setBatchSizeInfo(g[a.getGeomMesh]);h.annotations.setBatchSizeInfo(g[a.getAnnotation]);h.tracks.setBatchSizeInfo(g[a.getTrack]);h.sequences.setBatchSizeInfo(g[a.getSequence]);return;}d=t.processCommand(f.name,f.jsonContent,f.binaryContent,f.isInitial);if(d){t.sendRequest(d.requestQueue);}};t._worker.onerror=function(e){};}});};c.prototype.getUrl=function(){return this._url;};c.prototype.setUrl=function(u){this._url=u;return this;};c.prototype.getCorrelationId=function(){return this._correlationId;};c.prototype.setCorrelationId=function(d){this._correlationId=d;return this;};c.prototype.getSkipLowLODRendering=function(){return this._skipLowLODRendering;};c.prototype.setSkipLowLODRendering=function(s){this._skipLowLODRendering=s;return this;};c.prototype.getMaxUrlLength=function(){return this._maxUrlLength;};c.prototype.setMaxUrlLength=function(m){this._maxUrlLength=m;return this;};c.prototype.getMaxActiveRequests=function(){return this._maxActiveRequests;};c.prototype.setMaxActiveRequests=function(m){this._maxActiveRequests=m;this.postMessage({method:a.setMaxActiveRequests,maxActiveRequests:m});};c.prototype.getMeshesBatchSize=function(){return this._meshesBatchSize;};c.prototype.setMeshesBatchSize=function(m){this._meshesBatchSize=m;return this;};c.prototype.getMaterialsBatchSize=function(){return this._materialsBatchSize;};c.prototype.setMaterialsBatchSize=function(m){this._materialsBatchSize=m;return this;};c.prototype.getGeometriesBatchSize=function(){return this._geometriesBatchSize;};c.prototype.setGeometriesBatchSize=function(g){this._geometriesBatchSize=g;return this;};c.prototype.getGeometriesMaxBatchDataSize=function(){return this._geometriesMaxBatchDataSize;};c.prototype.setGeometriesMaxBatchDataSize=function(g){this._geometriesMaxBatchDataSize=g;return this;};c.prototype.getGeomMeshesBatchSize=function(){return this._geomMeshesBatchSize;};c.prototype.setGeomMeshesBatchSize=function(g){this._geomMeshesBatchSize=g;return this;};c.prototype.getGeomMeshesMaxBatchDataSize=function(){return this._geomMeshesMaxBatchDataSize;};c.prototype.setGeomMeshesMaxBatchDataSize=function(g){this._geomMeshesMaxBatchDataSize=g;return this;};c.prototype.getAnnotationsBatchSize=function(){return this._annotationsBatchSize;};c.prototype.setAnnotationsBatchSize=function(d){this._annotationsBatchSize=d;return this;};c.prototype.getTracksBatchSize=function(){return this._tracksBatchSize;};c.prototype.setTracksBatchSize=function(t){this._tracksBatchSize=t;return this;};c.prototype.getSequencesBatchSize=function(){return this._sequencesBatchSize;};c.prototype.setSequencesBatchSize=function(s){this._sequencesBatchSize=s;return this;};c.prototype.getVoxelThreshold=function(){return this._voxelThreshold;};c.prototype.setVoxelThreshold=function(v){this._voxelThreshold=v;if(this.sceneBuilder){this.sceneBuilder.setVoxelThreshold(v);}return this;};c.prototype.setSceneBuilder=function(s){this.sceneBuilder=s;this.sceneBuilder.setVoxelThreshold(this.getVoxelThreshold());};c.prototype.dispose=function(){this.contextMap.forEach(function(d){d.dispose();});this.contextMap.clear();this.tokenContextMap.clear();this.postMessage({method:"close"});this._worker=undefined;this.currentSceneInfo=null;this.sceneBuilder.cleanup();this.sceneBuilder=null;this.onErrorCallbacks=null;this.onMaterialFinishedCallbacks=null;this.onImageFinishedCallbacks=null;this.onSetGeometryCallbacks=null;this.onSetTrackCallbacks=null;this.onSetSequenceCallbacks=null;};c.prototype.cleanup=function(){this.currentSceneInfo={};this.contextMap.clear();this.tokenContextMap.clear();this.sceneBuilder.cleanup();};c.prototype.enablePushMesh=function(e){this._pushMesh=e;};c.prototype.getSceneBuilder=function(){return this.sceneBuilder;};c.prototype.getContext=function(s){return this.contextMap.get(s);};c.prototype.createContext=function(s,p){var d=new S(s,p,this);this.contextMap.set(s,d);this.tokenContextMap.set(d.requestQueue.token,d);if(d.onActiveCamera){d.onActiveCameraCallbacks.attach(d.onActiveCamera);delete d.onActiveCamera;}if(d.onInitialSceneFinished){d.onInitialSceneFinishedCallbacks.attach(d.onInitialSceneFinished);delete d.onInitialSceneFinished;}if(d.onPartialRetrievalFinished){d.onPartialRetrievalFinishedCallbacks.attach(d.onPartialRetrievalFinished);delete d.onPartialRetrievalFinished;}if(d.onViewFinished){d.onViewFinishedCallbacks.attach(d.onViewFinished);delete d.onViewFinished;}if(d.onSceneCompleted){d.onSceneCompletedCallbacks.attach(d.onSceneCompleted);delete d.onSceneCompleted;}if(d.onProgressChanged){d.setOnProgressChanged(d.onProgressChanged);delete d.onProgressChanged;}if(d.onLoadingFinished){this.onLoadingFinishedCallbacks.detachAll();this.onLoadingFinishedCallbacks.attach(d.onLoadingFinished);delete d.onLoadingFinished;}if(d.onContentChangesProgress){d.onContentChangesProgressCallbacks.attach(d.onContentChangesProgress);delete d.onContentChangesProgress;}if(d.onInitialViewCompleted){d.onInitialViewCompletedCallbacks.attach(d.onInitialViewCompleted);delete d.onInitialViewCompleted;}return d;};c.prototype.isLoadingFinished=function(){var d=this.contextMap.values();var e=d.next();while(!e.done){if(!e.value.isLoadingFinished()){return false;}e=d.next();}return true;};c.prototype.decrementResourceCountersForDeletedTreeNode=function(d,n){if(d){this.sceneBuilder.decrementResourceCountersForDeletedTreeNode(n,d.sceneId);}};function l(d,n){if(d.progressLogger){d.progressLogger.logPerformance(n,d.token);}}c.prototype.request=function(s,d,e){if(!d.root){throw"Context must include root where loaded objects are attached to";}var f=this.createContext(s,d);f.token=f.requestQueue.token;this.currentSceneInfo.id=s;f.retrievalType=S.RetrievalType.Initial;f.authorizationHandler=e;f.initialRequestTime=Date.now();if(f.enableLogger){T.createLogger(s,f,this);}f.includeHidden=d.includeHidden;f.includeBackground=d.includeBackground;f.includeParametric=d.includeParametric;f.includeAnimation=d.includeAnimation;f.selectField=d.$select;f.pushViewGroups=d.pushViewGroups;f.pushPMI=d.pushPMI;f.metadataFilter=d.metadataFilter;f.activateView=d.activateView;var g=T.createCommand(a.getScene,{sceneId:s});var m;if(sap.ui.Device.browser.msie||sap.ui.Device.browser.edge){m=Math.min(2*1024,this.getMaxUrlLength());}else if(sap.ui.Device.browser.mobile){m=Math.min(8*1024,this.getMaxUrlLength());}else{m=Math.min(64*1024,this.getMaxUrlLength());}l(f,"modelRequested");b("modelRequested");this.postMessage({method:"initializeConnection",url:this.getUrl(),cid:this.getCorrelationId(),useSecureConnection:d.useSecureConnection,maxActiveRequests:this.getMaxActiveRequests(),token:f.token,command:g,sceneId:s,maxUrlLength:m});};c.prototype.postMessage=function(m){if(this._worker){this._worker.postMessage(m);}};c.prototype.processSetSceneCommand=function(j){var d=this.getContext(j.veid);if(d){d.defaultViewId=j.defaultViewId;d.defaultViewGroupId=j.defaultViewGroupId;d.sceneThumbnailId=j.imageId;d.dimension=j.dimension;d.defaultRootEntityId=j.defaultRootEntityId;if(d.defaultViewGroupId){d.currentViewGroupId=d.defaultViewGroupId;}var i=d.includeHidden!==undefined?d.includeHidden:true;var e=d.includeAnimation!==undefined?d.includeAnimation:true;var f=d.includeBackground!=null?d.includeBackground:true;var g=d.includeParametric!=null?d.includeParametric:true;var s=d.$select!==undefined?d.$select:"name,transform,meshId,annotationId,materialId,contentType,visible,opacity,renderOrder,entityId,highlightStyleId";var p=d.pushViewGroups!==undefined?d.pushViewGroups:true;var h="nodes,bounds,animation";if(!e){h="nodes,bounds";}var v={pushMaterials:true,pushMeshes:this._pushMesh,sceneId:d.sceneId,token:d.token,includeHidden:i,includeParametric:g,includeBackground:f,pushViewGroups:p,pushPMI:d.pushPMI||false,metadataFilter:d.metadataFilter,$select:s,$expand:h};v.context=d.sceneId;if(d.activateView){v.id=d.activateView;}else if(d.defaultViewId){v.id=d.defaultViewId;}if(v.id){d.initialViewId=v.id;d.currentViewId=v.id;d.initialViewDecided=true;}this.postMessage(T.createRequestCommand(a.getView,v,true));}};c.prototype.update=function(s,d,v){this.currentSceneInfo.id=s;var e=this.getContext(s);if(!e){return Promise.reject("no context for ${sceneVeId}");}var t=this;return new Promise(function(r,f){e.nodeSidsForPartialTree=new Set(d);e.retrievalType=S.RetrievalType.Partial;var i=e.includeHidden!==undefined?e.includeHidden:true;var g=e.includeAnimation!==undefined?e.includeAnimation:true;var h=e.includeBackground!=null?e.includeBackground:true;var j=e.includeParametric!=null?e.includeParametric:true;var k=e.$select!==undefined?e.$select:"name,transform,meshId,annotationId,materialId,contentType,visible,opacity,renderOrder,entityId,highlightStyleId";var o={sceneId:s,token:e.token,pushMaterials:true,pushMeshes:t._pushMesh,filter:d.join(),includeAnimation:g,includeHidden:i,includeParametric:j,includeBackground:h,pushPMI:e.pushPMI||false,metadataFilter:e.metadataFilter,$select:k,breadcrumbs:true};if(v){o.activateView=v;}var m=T.createCommand(a.getTree,o);var n=function(){e.onPartialRetrievalFinishedCallbacks.detach(n);l(e,"updateFinished(mesh)");var p=[];var q=[];e.replacedNodes.forEach(function(x,y){q.push(x);p.push(y);});var u=p;var w=q;r({sceneVeId:s,sids:d,replacedNodeRefs:u,replacementNodeRefs:w});};e.onPartialRetrievalFinishedCallbacks.attach(n);l(e,"updateRequested");t.postMessage({method:"update",command:m});});};c.prototype.requestViewGroup=function(s,v,i){if(!v){return Promise.reject("invalid arg: viewGroupId undefined");}var d=this.getContext(s);if(!d){return Promise.reject("no context for ${sceneVeId}");}if(i!==undefined){d.includeAnimation=i;}var t=this;var p=new Promise(function(r,e){var f=t.sceneBuilder.getViewGroup(v,s);if(f&&f.length){r(f);return;}var o={sceneId:s,id:v,token:d.token};var g=function(){d.onViewGroupFinishedCallbacks.detach(g);l(d,"onViewGroupFinished");var h=t.sceneBuilder.getViewGroup(v,s);if(h&&h.length){r(h);}else{e("no view ground data");}};d.onViewGroupFinishedCallbacks.attach(g);d.currentViewGroupId=v;t.postMessage(T.createRequestCommand(a.getViewGroups,o));});return p;};c.prototype.requestView=function(s,v,d,p,i){this.currentSceneInfo.id=s;if(v!=="static"&&v!=="dynamic"){return Promise.reject("invalid arg: supported type - static, dynamic");}if(!d){return Promise.reject("invalid arg: viewId undefined");}var e=this.getContext(s);if(!e){return Promise.reject("no context for ${sceneVeId}");}e.currentViewId=d;var f=e.includeHidden!==undefined?e.includeHidden:true;var g=e.includeBackground!=null?e.includeBackground:true;var h=e.includeParametric!=null?e.includeParametric:true;var j;if(i){j=i;}else{j=e.includeAnimation!==undefined?e.includeAnimation:true;}var k=e.$select!==undefined?e.$select:"name,transform,meshId,annotationId,materialId,contentType,visible,opacity,renderOrder,entityId,highlightStyleId";var m="nodes,bounds,animation";if(!j){m="nodes,bounds";}this.hasAnimation=false;var t=this;var n=new Promise(function(r,o){var q,u;if(v==="static"){q=a.getView;u={sceneId:s,id:d,token:e.token,includeHidden:f,includeParametric:h,includeBackground:g,$select:k,$expand:m};if(p&&p.length){u.$expand="playback";e.playbackIds=p;}}else{q=a.getDynamicView;u={sceneId:s,type:d,token:e.token};}e.onSetPlaybackCallbacks.detachAll();var w=function(A){e.onSetPlaybackCallbacks.detach(w);l(e,"onSetPlayback");if(A){r(A);}else{o("no view data");}};e.onSetPlaybackCallbacks.attach(w);e.onViewFinishedCallbacks.detachAll();var x=function(A){e.onViewFinishedCallbacks.detach(x);l(e,"onViewFinished");if(!t.hasAnimation){if(A){r(A);}else{o("no view data");}}else{e.currentView=A;}};e.onViewFinishedCallbacks.attach(x);t.onSetSequenceCallbacks.detachAll();var y=function(){t.onSetSequenceCallbacks.detach(y);l(e,"onSetSequence");if(e.currentView){r(e.currentView);}};t.onSetSequenceCallbacks.attach(y);t.onSetTrackCallbacks.detachAll();var z=function(A){t.onSetTrackCallbacks.detach(z);l(e,"onSetTrack");if(e.currentView){r(e.currentView);}};t.onSetTrackCallbacks.attach(z);l(e,"viewRequested");t.postMessage(T.createRequestCommand(q,u));});return n;};c.prototype.requestMaterial=function(s,d){if(!d){return Promise.reject("invalid arg: materialId undefined");}var e=this.getContext(s);if(!e){return Promise.reject("no context for ${sceneVeId}");}var t=this;var p=new Promise(function(r,f){var g=e.sceneBuilder.getMaterial(d);if(g){r(g);return;}e.requestQueue.materials.push(d);var i=function(j){var m=t.sceneBuilder.getMaterial(d);if(m&&!m.userData.imageIdsToLoad){t.onImageFinishedCallbacks.detach(i);r(m);}};var h=function(n){if(d!=n){return;}t.onMaterialFinishedCallbacks.detach(h);var m=t.sceneBuilder.getMaterial(d);if(!m){t.onImageFinishedCallbacks.detach(i);f("no material data");}if(m.userData.imageIdsToLoad){return;}t.onImageFinishedCallbacks.detach(i);r(m);};t.onMaterialFinishedCallbacks.attach(h);t.onImageFinishedCallbacks.attach(i);t.sendRequest(e.requestQueue);});return p;};c.prototype.setSuppressSendRequests=function(s){this._suppressSendRequests=s;};c.prototype.sendRequest=function(r){if(!this._worker||this._suppressSendRequests){return false;}var s=false;while(!r.isEmpty()){var n=r.generateRequestCommand();this.postMessage(n);s=true;}return s;};c.prototype.timestamp=function(j){};c.prototype.performanceTiming=function(j){};c.prototype.checkError=function(j){if(!j){return true;}var r=j.result==="failure";if(r){if(j.message){j.error=j.message;delete j.message;}else{j.error="Unknown error";}}return r;};c.prototype.reportError=function(d,e){this.onErrorCallbacks.execute({error:e,context:d});};c.prototype.processContextCommand=function(d,n,j,e,i){if(!d){var f=n+" error: unknown context - "+JSON.stringify(j);this.contextMap.forEach(function(d){d[n].call(d,j,e);});return{error:f};}var r;try{r=d[n].call(d,j,e,i);}catch(g){r={error:g};}return r;};c.prototype.processCommand=function(n,j,d,i){if(this.checkError(j)){if(n===a.setTree){if(j.events&&j.events.length){var e=j.events[0];if(e.values&&e.values.id){this.contextMap.delete(e.values.id);}}}this.onErrorCallbacks.execute(j);return null;}var f=null;if(j.sceneId!==undefined){f=this.getContext(j.sceneId);}else if(j.token!==undefined){f=this.tokenContextMap.get(j.token);}if(f){this.currentSceneInfo.id=f.sceneId;}this.setPerformance(n,j,f?f.sceneId:null);var r;switch(n){case a.setScene:this.processSetSceneCommand(j);break;case a.setTree:case a.setTreeNode:case a.notifyFinishedTree:case a.setView:case a.setViewNode:case a.setViewGroup:case a.notifyFinishedView:case a.setCamera:case a.setMesh:case a.setMaterial:case a.setGeometry:case a.setImage:case a.setAnnotation:case a.setLineStyle:case a.setFillStyle:case a.setTextStyle:case a.setParametric:case a.setPlayback:case a.setHighlightStyle:case a.setSequence:case a.setTrack:case a.suppressSendRequests:case a.unsuppressSendRequests:r=this.processContextCommand(f,n,j,d,i);break;case a.notifyError:r={error:j.errorText};break;case a.timestamp:r=this.timestamp(j);break;case a.performanceTiming:r=this.performanceTiming(j);break;default:r={error:"Unknown command: "+n};break;}if(this.isLoadingFinished()){if(n!==a.setScene&&n!==a.setView&&n!==a.setViewNode&&n!==a.timestamp&&n!==a.performanceTiming&&n!==a.suppressSendRequests&&n!==a.unsuppressSendRequests&&this._loadingFinishedSent===false){this.onLoadingFinishedCallbacks.execute();this._loadingFinishedSent=true;L.info("Loading is finished - all streaming requests are fulfilled.");}}else if(this._loadingFinishedSent){this._loadingFinishedSent=false;}if(r&&r.error){L.error(r.error);this.onErrorCallbacks.execute(r);}return f;};c.prototype.setPerformance=function(n,j,s){var i;switch(n){case a.setGeometry:i=j.id;b("setGeometry-"+i);break;case a.setImage:i=j.id;b("setImage-"+i);break;case a.setView:i=j.viewId;b("setView-"+i);break;case a.setViewGroup:i=j.id;b("setViewGroup-"+i);break;case a.setMesh:b("setMesh-"+s);break;case a.setMaterial:b("setMaterial-"+s);break;case a.setTree:b("setTree-"+s);break;case a.performanceTiming:this._isPostable=true;this.postPerformanceTiming();break;default:break;}};c.prototype.postPerformanceTiming=function(m){if(m){this._performanceTimingMsg.push(m);}if(this._isPostable&&this._performanceTimingMsg.length>0){this.postMessage(this._performanceTimingMsg.shift());this._isPostable=false;}};c.prototype.printLogTokens=function(){this.contextMap.forEach(function(d,s){L.info("log tokens for scene => "+s);L.info("---------------------------------------");if(d.progressLogger){d.progressLogger.getTokens().forEach(function(t){L.info(t);});}L.info("---------------------------------------");});};return c;});
