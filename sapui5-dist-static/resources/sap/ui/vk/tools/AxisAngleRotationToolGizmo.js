/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../thirdparty/three","./Gizmo","./AxisAngleRotationToolGizmoRenderer","./AxisColours","../AnimationTrackType","sap/base/assert"],function(L,t,G,A,b,d,e){"use strict";var g=G.extend("sap.ui.vk.tools.AxisAngleRotationToolGizmo",{metadata:{library:"sap.ui.vk"}});var j=[0xFF0080,b.y,b.z];var k=Math.PI*2,o=Math.PI/2,p=13;var q=THREE.Math.degToRad,s=THREE.Math.radToDeg;g.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._createEditingForm(String.fromCharCode(176),84);this._gizmoIndex=-1;this._handleIndex=-1;this._value=new THREE.Vector3();this._rotationDelta=new THREE.Vector3();this._viewport=null;this._tool=null;this._sceneGizmo=new THREE.Scene();var l=new THREE.DirectionalLight(0xFFFFFF,0.5);l.position.set(1,3,2);this._sceneGizmo.add(l);this._sceneGizmo.add(new THREE.AmbientLight(0xFFFFFF,0.5));this._gizmo=new THREE.Group();this._sceneGizmo.add(this._gizmo);this._touchAreas=new THREE.Group();this._nodes=[];this._matViewProj=new THREE.Matrix4();this._gizmoSize=96;function c(f,r,h){var m=new THREE.TorusBufferGeometry(r,16/96,4,h,f===2?Math.PI:k);if(f===0){m.rotateY(o);}else if(f===1){m.rotateX(o);}else{m.rotateZ(-o);}return new THREE.Mesh(m,new THREE.MeshBasicMaterial({opacity:0.2,transparent:true}));}var i;for(i=0;i<3;i++){this._touchAreas.add(c(i,1,24));}for(i=0;i<3;i++){var a=new THREE.Mesh(new THREE.IcosahedronBufferGeometry(0.25,0),new THREE.MeshBasicMaterial({opacity:0.2,transparent:true}));a.position.setComponent(i,1.6);this._touchAreas.add(a);}};g.prototype._createGizmoObject=function(){var a=new THREE.Group();var c=a.userData;function f(m,y,z,J){var K=new THREE.TorusBufferGeometry(z,1/96,4,J,m===2?Math.PI:k);if(m===0){K.rotateY(o);}else if(m===1){K.rotateX(o);}else{K.rotateZ(-o);}var M=new THREE.Mesh(K,new THREE.MeshBasicMaterial({color:y,transparent:true}));M.matrixAutoUpdate=false;M.userData.color=y;return M;}function h(y,z){var J=96*3,K=2,M=12*3,N=2*3;y.multiplyScalar(1/J);var O=new THREE.MeshLambertMaterial({color:z});var l=new THREE.CylinderBufferGeometry(K,K,J-M,4);var m=new THREE.Matrix4().makeBasis(new THREE.Vector3(y.y,y.z,y.x),y,new THREE.Vector3(y.z,y.x,y.y));m.setPosition(y.clone().multiplyScalar((J-M)*0.5));l.applyMatrix4(m);var P=new THREE.Mesh(l,O);P.matrixAutoUpdate=false;P.userData.color=z;var Q=new THREE.CylinderBufferGeometry(0,N,M,12,1);m.setPosition(y.clone().multiplyScalar(J-M*0.5));Q.applyMatrix4(m);var R=new THREE.Mesh(Q,O);R.matrixAutoUpdate=false;P.add(R);return P;}var i;for(i=0;i<3;i++){a.add(f(i,j[i],1,128));}c.axisArrow=h(new THREE.Vector3(3,0,0),j[0]);a.add(c.axisArrow);var l=new THREE.BufferGeometry();l.setAttribute("position",new THREE.Float32BufferAttribute(new Float32Array([0,0,0,3,0,0]),3));c.arrowProjection=new THREE.Line(l,new THREE.LineDashedMaterial({color:j[0],transparent:true,scale:10,dashSize:1,gapSize:1}));c.arrowProjection.computeLineDistances();a.add(c.arrowProjection);a.add(new THREE.AxesHelper(1.5));c.arcMeshes=[];for(i=0;i<3;i++){var n=new THREE.Mesh(new THREE.Geometry(),new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,opacity:0.5,transparent:true,side:THREE.DoubleSide,depthWrite:false}));n.visible=false;c.arcMeshes.push(n);a.add(n);}c.valueLabels=[];for(i=0;i<3;i++){var r=this._createTextMesh("",64,32,p,0xFFFFFF,false);r.renderOrder=10;r.material.depthTest=false;r.visible=false;c.valueLabels.push(r);a.add(r);}var w=c.axisTitles=this._createAxisTitles();w.scale.setScalar(1/this._gizmoSize);var x=this._gizmoSize*1.6;w.children[0].position.x=x;w.children[1].position.y=x;w.children[2].position.z=x;a.add(w);return a;};g.prototype.hasDomElement=function(){return true;};g.prototype.resetValues=function(){this._value.setScalar(0);};g.prototype.show=function(a,c){this._viewport=a;this._tool=c;this.handleSelectionChanged();this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:this._getNodesProperties()},true);};g.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false);};g.prototype.getGizmoCount=function(){return this._nodes.length;};g.prototype.getTouchObject=function(i){if(this._nodes.length===0){return null;}var a=this._gizmo.children[i];u(this._touchAreas.children[2],a.children[2]);u(this._touchAreas.children[0],a.children[0]);this._updateGizmoObjectTransformation(this._touchAreas,i);return this._touchAreas;};g.prototype.highlightHandle=function(a,c,h){for(var f=0,l=this._gizmo.children.length;f<l;f++){var m=this._gizmo.children[f];var n=m.userData;for(var i=0;i<3;i++){var r=m.children[i];var w=(i===a)&&(f===c)?0xFFFF00:r.userData.color;r.material.color.setHex(w);r.material.opacity=a===-1||i===a?1:0.35;r.material.visible=h||i===a;var x=n.axisTitles.children[i];x.material.color.setHex((f===c)&&(i===a-3)?0xFFFF00:r.userData.color);x.material.opacity=h?1:0.35;n.arcMeshes[i].material.visible=h||i===a||(i===2&&a===1);}}};g.prototype._snapToAxis=function(i){var a=-this._value.y,c=-this._value.z;switch(i){case 0:a+=90;break;case 1:c+=90;break;default:break;}this.beginGesture();this._rotate(new THREE.Euler(0,q(a),q(c)));this.endGesture();};g.prototype.selectHandle=function(i,a){this._gizmoIndex=a;this._handleIndex=i;if(i>=3&&i<6){this._snapToAxis(i-3);}this._updateEditValue();this._viewport.setShouldRenderFrame();};function u(a,c){a.quaternion.copy(c.quaternion);a.position.copy(c.position);a.updateMatrix();a.updateMatrixWorld(true);}function v(a){return s(Math.atan2(a[0],a[2]));}function B(a){return s(Math.atan2(a[1],Math.sqrt(a[0]*a[0]+a[2]*a[2])));}function C(a,c){a=q(a);c=q(c);var f=Math.sin(a),h=Math.cos(a);var i=Math.sin(c),l=Math.cos(c);return[f*l,i,h*l];}function D(h,l,m,w){if(h.userData.angle1===m&&h.userData.angle2===w){return;}h.userData.angle1=m;h.userData.angle2=w;var c=new THREE.Color().setHex(j[l]);var x=[0,0,0];var y=[c.r,c.g,c.b];var z=new THREE.Vector3();var J=(l+1)%3,K=(l+2)%3;var M=w-m;var i,n=Math.min(Math.max(Math.ceil(Math.abs(M)*64/Math.PI),1),10000);var N=Math.min(k/Math.abs(M),1);var O=THREE.Math.lerp;for(i=0;i<=n;i++){var f=1-(i/n);var a=m+M*f;var r=O(N,1,f);z.set(0,0,0).setComponent(J,Math.cos(a)*r).setComponent(K,Math.sin(a)*r);x.push(z.x,z.y,z.z);var P=O(1,0.5,f);y.push(c.r*P,c.g*P,c.b*P);}var Q=[];for(i=0;i<n;i++){Q.push(0,i+1,i+2);}var R=new THREE.BufferGeometry();R.setIndex(Q);R.setAttribute("position",new THREE.Float32BufferAttribute(x,3));h.geometry=R;h.geometry.setAttribute("color",new THREE.Float32BufferAttribute(y,3));h.visible=M!==0;}g.prototype._updateGizmoObject=function(i,a,c,f){var h=this._gizmo.children[i];var l=new THREE.Euler(0,q(c-90),0,"YZX");var m=h.children[2];m.quaternion.setFromEuler(l);m.updateMatrix();l.z=q(f);var n=h.children[0];n.quaternion.setFromEuler(l);n.updateMatrix();n.position.setFromMatrixColumn(n.matrix,0).multiplyScalar(2);n.updateMatrix();var r=h.userData;var w=r.axisArrow;w.quaternion.copy(n.quaternion);w.updateMatrix();var x=r.arrowProjection;var y=Math.cos(l.z);x.quaternion.copy(m.quaternion);x.scale.setScalar(y);x.updateMatrix();x.material.scale=y*10;var z=r.arcMeshes;D(z[0],0,0,q(a));u(z[0],h.children[0]);D(z[1],1,0,q(c));u(z[1],h.children[1]);D(z[2],2,0,q(f));u(z[2],h.children[2]);var J=r.valueLabels;F(J[0],a);F(J[1],c);F(J[2],f);};g.prototype.beginGesture=function(){this._rotationDelta.setScalar(0);this._nodes.forEach(function(n){n.beginAngle=n.angle;n.beginAzimuth=n.azimuth;n.beginElevation=n.elevation;});};g.prototype._getNodesProperties=function(){return this.getValues();};g.prototype.endGesture=function(){this._nodes.forEach(function(a){delete a.beginAngle;delete a.beginAzimuth;delete a.beginElevation;});var n=this._getNodesProperties();this._tool.fireRotated({x:this._rotationDelta.x,y:this._rotationDelta.y,z:this._rotationDelta.z,nodesProperties:n});};function E(c,a){var f=window.devicePixelRatio;var w=c.width;var h=c.height;var i=w*0.5;var l=h*0.5;var r=Math.min(p*0.85*f,i-1);var m=c.getContext("2d");m.font="Bold "+p*f+"px Arial";var n=m.measureText(a);var x=Math.min(n.width*0.5-r*0.5,i-r-1);m.clearRect(0,0,w,h);m.beginPath();m.arc(i-x,l,r,o,o*3,false);m.lineTo(i+x,l-r);m.arc(i+x,l,r,-o,o,false);m.lineTo(i-x,l+r);m.closePath();m.globalAlpha=0.75;m.fillStyle="#fff";m.fill();m.globalAlpha=1;m.lineWidth=f;m.strokeStyle="#000";m.stroke();m.fillStyle="#000";m.textAlign="center";if(sap.ui.Device.browser.chrome||sap.ui.Device.browser.firefox){m.textBaseline="top";m.fillText(a,i,l-n.actualBoundingBoxDescent*0.5);}else{m.textBaseline="middle";m.fillText(a,i,l);}}function F(a,c){a.visible=c!==0;if(a.visible&&a.userData.value!==c){a.userData.value=c;var f=c.toLocaleString("fullwide",{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:1})+"°";var h=a.material.map;E(h.image,f);h.needsUpdate=true;}}g.prototype._updateEditValue=function(){var n=this._nodes[this._gizmoIndex];if(n){this._value.set(n.angle,n.azimuth,n.elevation);}};var _=new THREE.Vector3();var H=new THREE.Quaternion();g.prototype._updateNodeRotation=function(n){_.fromArray(C(n.azimuth,n.elevation));H.setFromAxisAngle(_,q(n.angle));n.node.quaternion.multiplyQuaternions(H,n.quaternion);n.node.updateMatrix();if(n.node.userData){delete n.node.userData.skipUpdateJointNode;}this._viewport._viewStateManager._setJointNodeOffsets(n.node,d.Rotate);};g.prototype._rotate=function(a){this._rotationDelta.set(s(a.x),s(a.y),s(a.z));this._nodes.forEach(function(n){n.angle=n.beginAngle+this._rotationDelta.x;n.azimuth=(n.beginAzimuth+this._rotationDelta.y)%360;n.elevation=THREE.Math.clamp(n.beginElevation+this._rotationDelta.z,-90,90);if(n.azimuth>180){n.azimuth-=360;}if(n.azimuth<-180){n.azimuth+=360;}this._updateNodeRotation(n);},this);this._updateEditValue();this._viewport.setShouldRenderFrame();};g.prototype._setRotationAxisAngle=function(a,c,f){var h=f-c;if(a!==0){h%=k;}var i=new THREE.Euler();i[["x","y","z"][a]]=h;var n=this._getNodesProperties();if(this._tool.fireEvent("rotating",{x:s(i.x),y:s(i.y),z:s(i.z),nodesProperties:n},true)){this._rotate(i);}};g.prototype.rotate=function(x,y,z){this.beginGesture();this._rotate(new THREE.Euler(q(x||0),q(y||0),q(z||0)));};g.prototype._getValueLocaleOptions=function(){return{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:2};};g.prototype.getValue=function(){return(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3)?this._value.getComponent(this._handleIndex):0;};g.prototype.setValue=function(a){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){var c=new THREE.Euler();c[["x","y","z"][this._handleIndex]]=q(a-this._value.getComponent(this._handleIndex));this.beginGesture();this._rotate(c);this.endGesture();}};g.prototype.rotateBy=function(a){this.beginGesture();this._rotate(new THREE.Euler(q(a),0,0));this.endGesture();};g.prototype.setAxis=function(a){this.beginGesture();var c=0;var f=0;if(Array.isArray(a)){c=v(a);f=B(a);}else{if("azimuth"in a){c=a.azimuth;}if("elevation"in a){f=a.elevation;}}this._nodes.forEach(function(n){n.azimuth=c;n.elevation=f;this._updateNodeRotation(n);},this);this._updateEditValue();this._viewport.setShouldRenderFrame();this.endGesture();};g.prototype.getValues=function(){var a=[];this._nodes.forEach(function(n){a.push({node:n.node,angle:n.angle,azimuth:n.azimuth,elevation:n.elevation,axis:C(n.azimuth,n.elevation)});});return a;};g.prototype._getNodeInfoByNode=function(n){var a=this._nodes;for(var i=0,l=a.length;i<l;i++){if(a[i].node===n){return a[i];}}return null;};g.prototype.setValues=function(a){a.forEach(function(c){var n=this._getNodeInfoByNode(c.node);if(n){n.angle=c.angle;if(c.axis){n.azimuth=v(c.axis);n.elevation=B(c.axis);}else{n.azimuth=c.azimuth;n.elevation=c.elevation;}n.quaternion=n.node.quaternion.clone();_.fromArray(C(n.azimuth,n.elevation));H.setFromAxisAngle(_,-q(n.angle));n.quaternion.premultiply(H);this._updateNodeRotation(n);}},this);this._updateEditValue();this._viewport.setShouldRenderFrame();};g.prototype.expandBoundingBox=function(a){if(this._viewport){this._expandBoundingBox(a,this._viewport.getCamera().getCameraRef(),true);}};g.prototype.handleSelectionChanged=function(a){this._nodes.length=0;this._gizmoIndex=this._handleIndex=-1;if(this._viewport){if(this._tool.getEnableSnapping()){this._tool.getDetector().setSource(this._viewport._viewStateManager);}this._updateSelection(this._viewport._viewStateManager);this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:this._getNodesProperties()},true);this._nodes.forEach(function(n){n.quaternion=n.node.quaternion.clone();n.angle=0;n.azimuth=0;n.elevation=0;});var c=this._nodes.length;var f=this._gizmo;while(f.children.length>c){f.remove(f.children[f.children.length-1]);}while(f.children.length<c){f.add(this._createGizmoObject());}}};g.prototype._getObjectSize=function(a){var c=new THREE.Box3();this._nodes[a].node._expandBoundingBox(c,true,false);if(c.isEmpty()){return 0;}var f=new THREE.Vector3();c.getSize(f);return f.length();};g.prototype._updateGizmoObjectTransformation=function(a,i){var n=this._nodes[i].node;var c=this._getEffectiveParent(n);a.position.setFromMatrixPosition(n.matrixWorld);if(c){a.quaternion.setFromRotationMatrix(c.matrixWorld);}else{a.quaternion.set(0,0,0,1);}var f=this._getGizmoScale(a.position);a.scale.setScalar(this._gizmoSize*f);a.updateMatrix();a.updateMatrixWorld(true);return f;};g.prototype._getValuePosition=function(a,c,f,h){f=q(f);h=q(h);var i=new THREE.Euler(0,0,0,"YZX");if(c===0){i.set(0,f,h);}else if(c===1){i.set(0,f*0.5,0);}else{i.set(0,f,h*0.5);}i.y-=o;a.set(c===0?3.25:1.25,0,0).applyEuler(i);};var I=new THREE.Vector3();g.prototype._updateGizmoTransformation=function(i,c){var a=this._gizmo.children[i];var n=this._nodes[i];var f=this._updateGizmoObjectTransformation(a,i);a.userData.axisTitles.children.forEach(function(m){m.quaternion.copy(a.quaternion).inverse().multiply(c.quaternion);});for(var h=0;h<3;h++){var l=a.userData.valueLabels[h];this._getValuePosition(l.position,h,n.azimuth,n.elevation);l.quaternion.copy(a.quaternion).inverse().multiply(c.quaternion);I.copy(l.position).applyMatrix4(a.matrixWorld);l.scale.setScalar(this._getGizmoScale(I)/(f*this._gizmoSize));}};g.prototype._getEditingFormPosition=function(){var a=this._gizmo.children[this._gizmoIndex];var n=this._nodes[this._gizmoIndex];this._updateGizmoObjectTransformation(a,this._gizmoIndex);this._getValuePosition(I,this._handleIndex,n.azimuth,n.elevation);return I.applyMatrix4(a.matrixWorld).applyMatrix4(this._matViewProj);};g.prototype.render=function(){e(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._nodes.length>0){var r=this._viewport.getRenderer(),c=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse);r.clearDepth();for(var i=0,l=this.getGizmoCount();i<l;i++){var n=this._nodes[i];this._updateGizmoObject(i,n.angle,n.azimuth,n.elevation);this._updateGizmoTransformation(i,c);}r.render(this._sceneGizmo,c);this._updateEditValue();}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex,["δ","γ","α"][this._handleIndex]);};g.prototype._getOffsetForRestTransformation=function(n){};return g;});
