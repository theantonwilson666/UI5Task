/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Tool","./HitTestToolHandler","./HitTestIdMode"],function(T,H,a){"use strict";var b=T.extend("sap.ui.vk.tools.HitTestTool",{metadata:{properties:{IdMode:{type:"sap.ui.vk.tools.HitTestIdMode",defaultValue:a.ThreeJS}},events:{hit:{parameters:{id:"any",object:"any",point:"any",clickType:"sap.ui.vk.tools.HitTestClickType"}}}},constructor:function(i,s){if(b._instance){return b._instance;}T.apply(this,arguments);this.setToolid("63150593-75f6-c330-2a7a-c1f85d36b2b9");this._viewport=null;this._handler=new H(this);this._loco=null;b._instance=this;}});b.prototype.init=function(){if(T.prototype.init){T.prototype.init.call(this);}this.setFootprint(["sap.ui.vk.threejs.Viewport"]);};b.prototype.setActive=function(v,c,g){T.prototype.setActive.call(this,v,c,g);if(this._viewport){if(v){this._prepare();}else{this._removeLocoHandler();}}return this;};b.prototype._prepare=function(){if(!this._addLocoHandler()){return false;}var o=false;if(this.isViewportType("sap.ui.vk.dvl.Viewport")&&this._viewport._dvl){this._dvlRendererId=this._viewport._dvlRendererId;this._dvl=this._viewport._dvl;o=true;}else if(this.isViewportType("sap.ui.vk.threejs.Viewport")&&(this._viewport._scene&&this._viewport._scene.getSceneRef())){o=true;}return o;};b.prototype.queueCommand=function(c){if(this._prepare()){if(this._dvlRendererId){this._dvl.Renderer._queueCommand(c,this._dvlRendererId);}}return this;};b.prototype.hitTest=function(x,y,s,c,d){if(this._prepare()){var h=null;if(this.isViewportType("sap.ui.vk.dvl.Viewport")&&this._viewport._dvl){return null;}else if(this.isViewportType("sap.ui.vk.threejs.Viewport")){if(!s||!c){h=null;}else if(this._viewport._renderer){var e=this._viewport._renderer.domElement;var m=new THREE.Vector2((x-e.offsetLeft)/e.clientWidth*2-1,(e.offsetTop-y)/e.clientHeight*2+1);var r=new THREE.Raycaster();r.setFromCamera(m,c.getCameraRef());var f=r.intersectObjects(s.getSceneRef().children,true);if(f&&f.length){for(var i in f){var g=f[i];var o=g.object;var p=o.parent;while(p){if(p.userData.closed){o=p;}p=p.parent;}while(o.parent&&o.userData.skipIt){o=o.parent;}if(o.visible&&!o.isBillboard&&!o.isDetailView){g.object=o;h=g;break;}}}}}var j=null;if(h){var k;switch(this.getIdMode()){case a.VEsID:k=this._viewport._scene.nodeRefToPersistentId(h.object);break;case a.ThreeJS:k=h.object.id;break;default:k=h.object.id;break;}j={id:k,object:h.object,point:h.point,clickType:d};this.fireHit(j);}return j;}};return b;});
