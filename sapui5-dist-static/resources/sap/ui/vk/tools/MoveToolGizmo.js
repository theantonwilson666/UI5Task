/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../getResourceBundle","../thirdparty/three","./Gizmo","./MoveToolGizmoRenderer","./CoordinateSystem","./GizmoPlacementMode","./AxisColours","../AnimationTrackType","sap/base/assert","sap/base/Log"],function(g,t,G,M,C,d,A,e,f,L){"use strict";var h=G.extend("sap.ui.vk.tools.MoveToolGizmo",{metadata:{library:"sap.ui.vk"}});h.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._createEditingForm(g().getText("TOOL_UNITS_MM"),84);this._gizmoIndex=-1;this._handleIndex=-1;this._value=new THREE.Vector3();this._moveDelta=new THREE.Vector3();this._viewport=null;this._tool=null;this._sceneGizmo=new THREE.Scene();var l=new THREE.DirectionalLight(0xFFFFFF,0.5);l.position.set(1,3,2);this._sceneGizmo.add(l);this._sceneGizmo.add(new THREE.AmbientLight(0xFFFFFF,0.5));this._gizmo=new THREE.Group();this._touchAreas=new THREE.Group();this._sceneGizmo.add(this._gizmo);this._coordinateSystem=C.World;this._placementMode=d.Default;this._nodes=[];this._matViewProj=new THREE.Matrix4();this._gizmoSize=96;function c(a,b,n){var o=96,p=1,q=24,r=4,s=48;a.multiplyScalar(1/o);var u=new THREE.MeshLambertMaterial({color:b,transparent:true});var v=new THREE.CylinderBufferGeometry(p,p,o-q,4);var m=new THREE.Matrix4().makeBasis(new THREE.Vector3(a.y,a.z,a.x),a,new THREE.Vector3(a.z,a.x,a.y));m.setPosition(a.clone().multiplyScalar((o-q)*0.5));v.applyMatrix4(m);var w=new THREE.Mesh(v,u);w.matrixAutoUpdate=false;w.userData.color=b;var x=new THREE.CylinderBufferGeometry(0,r,q,12,1);m.setPosition(a.clone().multiplyScalar(o-q*0.5));x.applyMatrix4(m);var y=new THREE.Mesh(x,u);y.matrixAutoUpdate=false;w.add(y);var z=new THREE.CylinderGeometry(s*0.5,s*0.5,s,12,1);z.applyMatrix4(m);var B=new THREE.CylinderGeometry(s*0.5,s*0.2,s,12,1);m.setPosition(a.clone().multiplyScalar(o*0.5));z.merge(B,m);n.add(new THREE.Mesh(z,u));return w;}function i(a,b,m){var n=new Float32Array(9);n[a]=n[b+6]=1;n[a+3]=n[b+3]=0.5;var v=new THREE.Vector3().setComponent(a,0.333);var o=new THREE.Vector3().setComponent(b,0.333);var k=new THREE.Geometry();k.vertices.push(new THREE.Vector3(),v,o,v.clone().add(o));k.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3));var p=new THREE.MeshBasicMaterial({color:0xFFFF00,opacity:0.5,transparent:true,visible:false,side:THREE.DoubleSide});var q=new THREE.Mesh(k,p);q.matrixAutoUpdate=false;q.userData.colors=n;var r=new THREE.BufferGeometry();var s=new Float32Array(9);s[a]=s[a+3]=s[b+3]=s[b+6]=0.333;r.setAttribute("position",new THREE.Float32BufferAttribute(s,3));r.setAttribute("color",new THREE.Float32BufferAttribute(n,3));var u=new THREE.Line(r,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:true,linewidth:window.devicePixelRatio}));u.matrixAutoUpdate=false;q.add(u);var w=new THREE.Geometry();w.vertices.push(new THREE.Vector3(),v,o,v.clone().add(o));w.faces.push(new THREE.Face3(0,1,2),new THREE.Face3(2,1,3));m.add(new THREE.Mesh(w,new THREE.MeshBasicMaterial({side:THREE.DoubleSide})));return q;}this._gizmo.add(c(new THREE.Vector3(1,0,0),A.x,this._touchAreas));this._gizmo.add(c(new THREE.Vector3(0,1,0),A.y,this._touchAreas));this._gizmo.add(c(new THREE.Vector3(0,0,1),A.z,this._touchAreas));this._gizmo.add(i(1,2,this._touchAreas));this._gizmo.add(i(2,0,this._touchAreas));this._gizmo.add(i(0,1,this._touchAreas));this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles);var k=new THREE.Geometry();k.vertices.push(new THREE.Vector3(),new THREE.Vector3());this._line=new THREE.LineSegments(k,new THREE.LineBasicMaterial());this._line.frustumCulled=false;this._line.visible=false;this._gizmo.add(this._line);};h.prototype.hasDomElement=function(){return true;};h.prototype.resetValues=function(){this._value.setScalar(0);};h.prototype.setCoordinateSystem=function(c){this._coordinateSystem=c;var s=c===C.Screen;var a=this._gizmo.children,b=this._touchAreas.children;a[2].visible=a[3].visible=a[4].visible=!s;b[2].visible=b[3].visible=b[4].visible=!s;this._axisTitles.children[2].visible=!s;this._gizmoIndex=this._handleIndex=-1;};h.prototype.show=function(v,a){this._viewport=v;this._tool=a;this._nodes.length=0;this._updateSelection(v._viewStateManager);var n=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:n},true);};h.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false);};h.prototype.getGizmoCount=function(){if(this._coordinateSystem===C.Local||this._coordinateSystem===C.Parent){return this._nodes.length;}else{return this._nodes.length>0?1:0;}};h.prototype.getTouchObject=function(i){if(this._nodes.length===0){return null;}this._updateGizmoObjectTransformation(this._touchAreas,i,true);return this._touchAreas;};var j=[1,2,4,6,5,3];h.prototype.highlightHandle=function(a,b){var i;for(i=0;i<3;i++){var c=this._gizmo.children[i];var k=j[a]&(1<<i);var l=k?0xFFFF00:c.userData.color;c.material.color.setHex(l);c.material.opacity=(k||b)?1:0.35;c.children[0].material.color.setHex(l);c.children[0].material.opacity=(k||b)?1:0.35;var m=this._axisTitles.children[i];m.material.color.setHex(l);m.material.opacity=k||b?1:0.35;}for(i=3;i<6;i++){var p=this._gizmo.children[i];p.material.visible=i===a;var n=p.children[0].geometry.attributes.color;n.copyArray(i===a?[1,1,0,1,1,0,1,1,0]:p.userData.colors);n.needsUpdate=true;p.children[0].material.opacity=(i===a||b)?1:0.35;}};h.prototype.selectHandle=function(i,a){this._gizmoIndex=a;this._handleIndex=i;if(this._tool.getAutoResetValues()){this.resetValues();}this._viewport.setShouldRenderFrame();};h.prototype.beginGesture=function(){this._beginValue=this._value.clone();this._moveDelta.setScalar(0);this._matOrigin=this._gizmo.matrixWorld.clone();this._nodes.forEach(function(n){var a=n.node;n.matOrigin=a.matrixWorld.clone();n.originLocal=a.position.clone();n.origin=new THREE.Vector3().setFromMatrixPosition(a.matrixWorld);if(a.parent){n.matParentInv=new THREE.Matrix4().getInverse(a.parent.matrixWorld);}else{n.matParentInv=new THREE.Matrix4();}});};h.prototype._printEventInfo=function(a,x,y,z,n){L.debug(a+" is fired:"+" x = "+x+"; y = "+y+"; z = "+z);n.forEach(function(p){L.debug("Node: "+p.node.name);if(p.offsetToRest){L.debug("offsetToRest: [ "+p.offsetToRest[0]+", "+p.offsetToRest[1]+", "+p.offsetToRest[2]+" ] ");}else{L.debug("offsetToRest: null");}if(p.offsetToPrevious){L.debug("offsetToPrevious: [ "+p.offsetToPrevious[0]+", "+p.offsetToPrevious[1]+", "+p.offsetToPrevious[2]+" ] ");}else{L.debug("offsetToPrevious: null");}if(p.absolute){L.debug("absolute: [ "+p.absolute[0]+", "+p.absolute[1]+", "+p.absolute[2]+" ] ");}else{L.debug("absolute: null");}if(p.world){L.debug("world: [ "+p.world[0]+", "+p.world[1]+", "+p.world[2]+" ] ");}else{L.debug("world: null");}if(p.restDifference){L.debug("restDifference: [ "+p.restDifference[0]+", "+p.restDifference[1]+", "+p.restDifference[2]+" ] ");}else{L.debug("restDifference: null");}if(p.restDifferenceInCoordinates){L.debug("restDifferenceInCoordinates: [ "+p.restDifferenceInCoordinates[0]+", "+p.restDifferenceInCoordinates[1]+", "+p.restDifferenceInCoordinates[2]+" ] ");}else{L.debug("restDifferenceInCoordinates: null");}});};h.prototype._getOffsetToRestInCooridnateSystem=function(n,o,c){if(c===C.World){return o.toArray();}else if(c===C.Custom){var a=new THREE.Matrix4().extractRotation(this._gizmo.matrixWorld);var b=new THREE.Matrix4().getInverse(a);return o.clone().applyMatrix4(b).toArray();}else if(c===C.Local){var i=new THREE.Matrix4().extractRotation(n.matrixWorld);var k=new THREE.Matrix4().getInverse(i);return o.clone().applyMatrix4(k).toArray();}else if(c===C.Screen){var s=this._viewport.getRenderer().getSize(new THREE.Vector2());var l=this._viewport.getCamera().getCameraRef();var m=new THREE.Vector4().copy(this._gizmo.position).applyMatrix4(this._matViewProj);var p=new THREE.Matrix3().setFromMatrix4(l.matrixWorld);var q=new THREE.Matrix3().getInverse(p);var r=o.clone().applyMatrix3(q);var u=2*m.w/(l.projectionMatrix.elements[0]*s.width);var v=2*m.w/(l.projectionMatrix.elements[5]*s.height);return[r.x/u,r.y/v,0.0];}};h.prototype._getNodesProperties=function(){var n=[];this._nodes.forEach(function(a){var b=a.node;var p={};p.node=b;var c=this._getEffectiveParent(b);var i=new THREE.Matrix4();if(c===b.parent){var r=this._viewport._viewStateManager.getRelativeTransformation(b);p.offsetToRestInParent=r.translation.slice();if(b.parent){i=new THREE.Matrix4().extractRotation(b.parent.matrixWorld);}p.offsetToPreviousInParent=p.offsetToRestInParent.slice();var s;if(this._playback){s=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(b,e.Translate,this._playback);if(s){p.offsetToPreviousInParent[0]-=s[0];p.offsetToPreviousInParent[1]-=s[1];p.offsetToPreviousInParent[2]-=s[2];}}var k=this._viewport._viewStateManager.getRestTransformation(b);var l=[k.translation[0],k.translation[1],k.translation[2]];if(s){l[0]+=s[0];l[1]+=s[1];l[2]+=s[2];}var q=new THREE.Quaternion();var m=new THREE.Vector3();var o=new THREE.Vector3();b.matrix.decompose(o,q,m);var u=new THREE.Matrix4().makeTranslation(-l[0],-l[1],-l[2]);var v=new THREE.Matrix4().makeTranslation(-k.translation[0],-k.translation[1],-k.translation[2]);if(m.x===0.0||m.y===0.0||m.z===0.0){m.x=1;m.y=1;m.z=1;}var w=new THREE.Matrix4().makeScale(1/m.x,1/m.y,1/m.z);var x=new THREE.Matrix4().makeRotationFromQuaternion(q.inverse());var y=w.clone().multiply(x).multiply(u).multiply(b.matrix);y.decompose(o,q,m);p.offsetToPrevious=o.toArray();var z=w.multiply(x).multiply(v).multiply(b.matrix);z.decompose(o,q,m);p.offsetToRest=o.toArray();}else{if(b.userData.skipUpdateJointNode){this._viewport._viewStateManager._setJointNodeOffsets(b,e.Translate);}if(b.userData&&b.userData.offsetTranslation){p.offsetToRestInParent=b.userData.offsetTranslation.slice();}else{p.offsetToRestInParent=[0,0,0];}p.offsetToPreviousInParent=p.offsetToRestInParent.slice();if(b.userData.skipUpdateJointNode){b.userData.skipUpdateJointNode=false;this._viewport._viewStateManager._setJointNodeMatrix();b.userData.skipUpdateJointNode=true;}var B=this._viewport._viewStateManager.getRestTransformationUsingJoint(b);var D=new THREE.Vector3();var E=new THREE.Vector3(B.scale[0],B.scale[1],B.scale[2]);var F=new THREE.Quaternion(B.quaternion[0],B.quaternion[1],B.quaternion[2],B.quaternion[3]);if(b.userData.offsetScale){E.x*=b.userData.offsetScale[0];E.y*=b.userData.offsetScale[1];E.z*=b.userData.offsetScale[2];}if(b.userData.offsetQuaternion){var H=new THREE.Quaternion(b.userData.offsetQuaternion[0],b.userData.offsetQuaternion[1],b.userData.offsetQuaternion[2],b.userData.offsetQuaternion[3]);F.multiply(H);}var I=new THREE.Matrix4().makeRotationFromQuaternion(F);var J=new THREE.Matrix4().makeTranslation(B.translation[0],B.translation[1],B.translation[2]);var K=c.matrixWorld.clone().multiply(J).multiply(I).scale(E);var N=new THREE.Matrix4().getInverse(K).multiply(b.matrixWorld);N.decompose(D,F,E);p.offsetToPrevious=D.toArray();p.offsetToRest=D.toArray();}var O=this._viewport._viewStateManager.getTransformation(b);p.absolute=[O.translation[0],O.translation[1],O.translation[2]];var P=this._viewport._viewStateManager.getTransformationWorld(b);p.world=P.translation;var Q;if(this._nodeUserDataMap){Q=this._nodeUserDataMap.get(b);}if(Q&&Q.initialTranslation){p.restDifference=[O.translation[0]-Q.initialTranslation[0],O.translation[1]-Q.initialTranslation[1],O.translation[2]-Q.initialTranslation[2]];if(this._coordinateSystem===C.Parent){p.restDifferenceInCoordinates=p.restDifference.slice();}else{var R=new THREE.Vector3(p.restDifference[0],p.restDifference[1],p.restDifference[2]).applyMatrix4(i);p.restDifferenceInCoordinates=this._getOffsetToRestInCooridnateSystem(b,R,this._coordinateSystem);}}n.push(p);}.bind(this));return n;};h.prototype.endGesture=function(){this._line.visible=false;var n=this._getNodesProperties();var o=this._moveDelta.clone();if(this._coordinateSystem===C.Custom){var a=new THREE.Matrix4().extractRotation(this._gizmo.matrixWorld);var b=new THREE.Matrix4().getInverse(a);o.applyMatrix4(b);}delete this._beginValue;this._nodes.forEach(function(c){var i=c.node;if(i.userData){delete i.userData.skipUpdateJointNode;}this._viewport._viewStateManager._setJointNodeOffsets(i,e.Translate);}.bind(this));this._tool.fireMoved({x:o.x,y:o.y,z:o.z,nodesProperties:n});this._printEventInfo("Event 'moved'",o.x,o.y,o.z,n);};h.prototype._setOffset=function(o,a){if(this._coordinateSystem===C.Local||this._coordinateSystem===C.Parent){var n=this._nodes[a];var b=n.node;var c=this._getEffectiveParent(b);if(this._coordinateSystem===C.Parent&&c){b=c;}var m=new THREE.Matrix4().getInverse(b.matrixWorld);var s=new THREE.Vector3().setFromMatrixScale(b.matrixWorld);var i=n.origin.clone().applyMatrix4(m);o=n.origin.clone().add(o).applyMatrix4(m).sub(i).multiply(s);}else if(this._coordinateSystem===C.Screen){var k=this._viewport.getRenderer().getSize(new THREE.Vector2());var p=this._gizmo.position.clone().applyMatrix4(this._matViewProj);var l=this._gizmo.position.clone().add(o).applyMatrix4(this._matViewProj);o.set(Math.round((l.x-p.x)*0.5*k.width),Math.round((l.y-p.y)*0.5*k.height),0);}var q=this._getNodesProperties();var r=o.clone();if(this._coordinateSystem===C.Custom){var u=new THREE.Matrix4().extractRotation(this._gizmo.matrixWorld);var v=new THREE.Matrix4().getInverse(u);r.applyMatrix4(v);}if(this._tool.fireEvent("moving",{x:r.x,y:r.y,z:r.z,nodesProperties:q},true)){this._printEventInfo("Event 'moving'",r.x,r.y,r.z,q);this._move(o);if(this._coordinateSystem===C.Screen){o.set(new THREE.Vector3().setFromMatrixColumn(this._matOrigin,0).normalize().dot(o),new THREE.Vector3().setFromMatrixColumn(this._matOrigin,1).normalize().dot(o),0);}else if(this._coordinateSystem===C.Custom){var w=this._getAnchorPoint();if(w){var x=new THREE.Matrix4().getInverse(w.matrixWorld);var y=new THREE.Vector3().setFromMatrixScale(w.matrixWorld);var z=w.position.clone().applyMatrix4(x);o.copy(w.position.clone().add(o).applyMatrix4(x).sub(z).multiply(y));}}this._line.geometry.vertices[0].setScalar(0).sub(o);this._line.geometry.verticesNeedUpdate=true;this._line.geometry.computeBoundingBox();o.set(Math.abs(o.x),Math.abs(o.y),Math.abs(o.z));o.multiplyScalar(1/Math.max(o.x,o.y,o.z));this._line.material.color.setRGB(o.x,o.y,o.z);this._line.visible=true;}};h.prototype._move=function(o){this._value.addVectors(this._beginValue,o);this._moveDelta.copy(o);this._nodes.forEach(function(n){var l=n.node;if(!l.userData){l.userData={};}l.userData.skipUpdateJointNode=true;});if(this._coordinateSystem===C.Local||this._coordinateSystem===C.Parent){this._nodes.forEach(function(n){var l=n.node;var m=this._getEffectiveParent(l);var p=null;if(this._coordinateSystem===C.Parent&&m){p=this._extractBasis(m.matrixWorld);}else{p=this._extractBasis(l.matrixWorld);}var q=n.origin.clone();q.add(p[0].multiplyScalar(o.x)).add(p[1].multiplyScalar(o.y)).add(p[2].multiplyScalar(o.z));l.matrixWorld.setPosition(q);l.matrix.multiplyMatrices(n.matParentInv,l.matrixWorld);l.position.setFromMatrixPosition(l.matrix);l.matrixWorldNeedsUpdate=true;}.bind(this));}else{if(this._coordinateSystem===C.Screen){var s=this._viewport.getRenderer().getSize(new THREE.Vector2());var c=this._viewport.getCamera().getCameraRef();var a=new THREE.Vector4().copy(this._gizmo.position).applyMatrix4(this._matViewProj);var b=o.x*2*a.w/(c.projectionMatrix.elements[0]*s.width);var i=o.y*2*a.w/(c.projectionMatrix.elements[5]*s.height);o.setFromMatrixColumn(c.matrixWorld,0).multiplyScalar(b);o.add(new THREE.Vector3().setFromMatrixColumn(c.matrixWorld,1).multiplyScalar(i));}this._gizmo.position.setFromMatrixPosition(this._matOrigin).add(o);if(this._coordinateSystem===C.Custom){var k=this._getAnchorPoint();if(k){k.position.copy(this._gizmo.position);}}this._nodes.forEach(function(n){if(!n.ignore){var l=n.node;l.matrixWorld.setPosition(n.origin.clone().add(o));l.matrix.multiplyMatrices(n.matParentInv,l.matrixWorld);l.position.setFromMatrixPosition(l.matrix);l.matrixWorldNeedsUpdate=true;}});}this._viewport.setShouldRenderFrame();};h.prototype.move=function(x,y,z){this.beginGesture();if(this._coordinateSystem===C.Custom){var o=new THREE.Vector3(x,y,z);var a=new THREE.Matrix4().extractRotation(this._gizmo.matrixWorld);o.applyMatrix4(a);x=o.x;y=o.y;z=o.z;}this._move(new THREE.Vector3(x,y,z||0));};h.prototype.getValue=function(){return(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3)?this._value.getComponent(this._handleIndex):0;};h.prototype.setValue=function(v){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){this.beginGesture();this._move(new THREE.Vector3().setComponent(this._handleIndex,v-this._value.getComponent(this._handleIndex)));this.endGesture();}};h.prototype.expandBoundingBox=function(b){if(this._viewport){this._expandBoundingBox(b,this._viewport.getCamera().getCameraRef(),true);}};h.prototype.handleSelectionChanged=function(a){if(this._viewport){if(this._tool.getEnableSnapping()){this._tool.getDetector().setSource(this._viewport._viewStateManager);}this._updateSelection(this._viewport._viewStateManager);var n=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:n},true);this._gizmoIndex=this._handleIndex=-1;}};h.prototype._getSelectionCenter=function(a){G.prototype._getSelectionCenter.apply(this,arguments);var b=this;function i(c,n,w,m){var u=(w/2);var x=(m/2);c.project(n);c.x=(c.x*u)+u;c.y=-(c.y*x)+x;return c;}function k(c,n,w,m){var u=(w/2);var x=(m/2);c.x=(c.x-u)/u;c.y=-(c.y-x)/x;c.unproject(n);return c;}function l(n,w,m){var c=new THREE.Vector3(b._gizmoSize,b._gizmoSize,0);var u=new THREE.Vector3(w-b._gizmoSize,b._gizmoSize,0);var x=new THREE.Vector3(w-b._gizmoSize,m-b._gizmoSize,0);var y=new THREE.Vector3(b._gizmoSize,m-b._gizmoSize,0);var z=[k(c,n,w,m),k(u,n,w,m),k(x,n,w,m),k(y,n,w,m)];return z[0].add(z[1]).add(z[2]).add(z[3]).multiplyScalar(0.25);}if(this._placementMode===d.OnScreen){var v=this._viewport.getDomRef().getBoundingClientRect();var w=v.width;var m=v.height;var n=this._viewport.getCamera().getCameraRef();var p=i(a.clone(),n,w,m);var o=p.clone();var q=[o.x<this._gizmoSize&&o.setX(b._gizmoSize)||o.x>w-this._gizmoSize&&o.setX(w-b._gizmoSize),o.y<this._gizmoSize&&o.setY(b._gizmoSize)||o.y>m-this._gizmoSize&&o.setY(m-b._gizmoSize)].some(function(c){return c!==false;})&&a.copy(k(o,n,w,m));return p.z>1.0&&a.copy(l(n,w,m))||q||a;}else if(this._placementMode===d.ObjectCenter&&this._nodes.length===1){var r=new THREE.Vector3();if(this._nodes[0].node.userData.boundingBox){this._nodes[0].node.userData.boundingBox.getCenter(r);}else{var s=new THREE.Box3();s.expandByObject(this._nodes[0].node);s.getCenter(r);}a.copy(r.applyMatrix4(this._nodes[0].node.matrixWorld));}};h.prototype._updateGizmoTransformation=function(i,c){var s=this._updateGizmoObjectTransformation(this._gizmo,i,true);this._updateAxisTitles(this._axisTitles,this._gizmo,c,this._gizmoSize+18,s);this._line.scale.setScalar(1/(this._gizmoSize*s));};h.prototype._getEditingFormPosition=function(){var s=this._updateGizmoObjectTransformation(this._gizmo,this._gizmoIndex,true);var a=new THREE.Vector3().setFromMatrixColumn(this._gizmo.matrixWorld,this._handleIndex).normalize();return a.clone().multiplyScalar((this._gizmoSize+18)*s).add(this._gizmo.position).applyMatrix4(this._matViewProj);};h.prototype.render=function(){f(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._nodes.length>0){var r=this._viewport.getRenderer(),c=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse);r.clearDepth();for(var i=0,l=this.getGizmoCount();i<l;i++){this._updateGizmoTransformation(i,c);r.render(this._sceneGizmo,c);}}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex);};return h;});
