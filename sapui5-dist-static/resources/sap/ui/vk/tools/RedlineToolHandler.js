/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/EventProvider"],function(E){"use strict";var R=E.extend("sap.ui.vk.tools.RedlineToolHandler",{metadata:{},constructor:function(t){this._priority=0;this._tool=t;this._rect=null;this._x=0;this._y=0;this._d=0;this._zoomFactor=1;}});R.prototype.destroy=function(){this._tool=null;this._rect=null;};R.prototype.hover=function(e){};R.prototype.beginGesture=function(e){var g=this._tool.getGizmo();if(g&&this._inside(e)){this._gesture=true;e.handled=true;if(g._activeElement){var b=g.getDomRef().getBoundingClientRect(),p=g._toVirtualSpace(e.x-b.left-window.pageXOffset,e.y-b.top-window.pageYOffset);g._activeElement.setOriginX(p.x);g._activeElement.setOriginY(p.y);g.rerender();}else{this._x=e.x;this._y=e.y;this._d=e.d;this._initd=e.d;}}};var T="sap.ui.vk.threejs.Viewport";var N="sap.ui.vk.NativeViewport";R.prototype._pan=function(e){var v=this.getViewport(),g=this._tool.getGizmo(),d=e.x-this._x,a=e.y-this._y;if(d||a){this._x=e.x;this._y=e.y;g.getRedlineElements().forEach(function(c){c.setOriginX(c.getOriginX()+g._toVirtualSpace(d));c.setOriginY(c.getOriginY()+g._toVirtualSpace(a));});g.rerender();var p=g._getPanningRatio();var b=v.getMetadata().getName()===T?v._viewportGestureHandler._cameraController:v;b.beginGesture(0,0);b.pan(d*p,a*p);b.endGesture();}};R.prototype._zoom=function(e){var v=this.getViewport(),g=this._tool.getGizmo(),z=1;var d=e.d-this._d;this._d=e.d;if(this._initd>0){z=1+d*(1/this._initd);}else if(e.n===2){if(e.points[0].y>e.points[1].y){z=Math.max(1-d*0.005,0.333);}else{z=Math.min(1+d*0.005,3);}}z=Math.min(Math.max(z,0.88),1.12);var a=v.getMetadata().getName();var b=32;var c=1/8;if(a===N){b=v._getZoomInLimit();c=v._getZoomOutLimit();this._zoomFactor=v._getZoomFactor();}z=Math.min(Math.max(this._zoomFactor*z,c),b)/this._zoomFactor;this._zoomFactor*=z;var o=this._getOffset(g.getDomRef());var s=1-z,p=g._toVirtualSpace(e.x-o.x,e.y-o.y);g.getRedlineElements().forEach(function(h){h.applyZoom(z);var i=h.getOriginX(),j=h.getOriginY();i+=(p.x-i)*s;j+=(p.y-j)*s;h.setOriginX(i);h.setOriginY(j);});g.rerender();var f=a===T?v._viewportGestureHandler._cameraController:v;f.beginGesture(e.x-o.x,e.y-o.y);f.zoom(z);f.endGesture();};R.prototype.move=function(e){var g=this._tool.getGizmo();if(g&&this._gesture){e.handled=true;if(g._activeElement){var b=g.getDomRef().getBoundingClientRect(),x=e.x-b.left-window.pageXOffset,y=e.y-b.top-window.pageYOffset;g._activeElement.edit(x,y);}else{if(e.n===1||e.n===2){this._pan(e);}if(e.n===2&&!e.buttons){this._zoom(e);}}}};R.prototype.endGesture=function(e){var g=this._tool.getGizmo();if(g&&this._inside(e)){this._gesture=false;e.handled=true;if(g._activeElement){g.addRedlineElement(g._activeElement);this._tool.fireElementCreated({element:g._activeElement});this._tool.stopAdding();}}};R.prototype.click=function(e){};R.prototype.doubleClick=function(e){};R.prototype.contextMenu=function(e){};R.prototype.getViewport=function(){return this._tool._viewport;};R.prototype._getOffset=function(o){var r=o.getBoundingClientRect();var p={x:r.left+window.pageXOffset,y:r.top+window.pageYOffset};return p;};R.prototype._inside=function(e){var i=this._tool._viewport.getIdForLabel();var d=document.getElementById(i);if(d==null){return false;}var o=this._getOffset(d);this._rect={x:o.x,y:o.y,w:d.offsetWidth,h:d.offsetHeight};return(e.x>=this._rect.x&&e.x<=this._rect.x+this._rect.w&&e.y>=this._rect.y&&e.y<=this._rect.y+this._rect.h);};return R;});
