/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Tool","../thirdparty/three","./PoiToolHandler","./PoiToolGizmo","../threejs/PoiHelper","./ToolNodeSet"],function(T,t,P,a,b,c){"use strict";var d=T.extend("sap.ui.vk.tools.PoiManipulationTool",{metadata:{properties:{nodeSet:{type:"sap.ui.vk.tools.ToolNodeSet",defaultValue:c.Highlight}},aggregations:{buttons:{type:"sap.m.Button",multiple:true}},events:{editing:{parameters:{nodeRef:"any"}},removing:{parameters:{nodeRef:"any"}},moving:{parameters:{x:"float",y:"float",z:"float",nodesProperties:"any[]"}},moved:{parameters:{x:"float",y:"float",z:"float",nodesProperties:"any[]"}}}},constructor:function(i,s){T.apply(this,arguments);this._viewport=null;this._poiHelper=new b();this.setAggregation("gizmo",new a());this._handler=new P(this);this._buttonPosition=new THREE.Vector2();this._selectedPoi=new Set();}});d.prototype.init=function(){if(T.prototype.init){T.prototype.init.call(this);}this._editButton=new sap.m.Button({icon:"sap-icon://edit",type:sap.m.ButtonType.Neutral,press:function(e){this.fireEditing({nodeRef:this._selectedPoi.values().next().value});}.bind(this)}).addStyleClass("sapUiVizKitPoiButtonEdit");this._deleteButton=new sap.m.Button({icon:"sap-icon://delete",type:sap.m.ButtonType.Neutral,press:function(e){this.fireRemoving({nodeRef:this._selectedPoi.values().next().value});}.bind(this)}).addStyleClass("sapUiVizKitPoiButtonDelete");this.addAggregation("buttons",this._editButton);this.addAggregation("buttons",this._deleteButton);this.setButtonsVisibility(false);this.attachMoved(function(e){var n=e.getParameter("nodesProperties");for(var i=0;i<n.length;++i){var f=n[i].node;this._poiHelper.adjustPoi(this._viewport,f);}});this.setFootprint(["sap.ui.vk.threejs.Viewport"]);};d.prototype.getSelectedPois=function(){var p=[];if(this._viewport){var v=this._viewport._viewStateManager;v.getSymbolNodes().forEach(function(e){if(v.getSelectionState(e)){p.push(e);}});}return p;};d.prototype._updateSelectedPoi=function(){if(this._viewport){var v=this._viewport._viewStateManager;var s=v.getSymbolNodes();this._selectedPoi.forEach(function(p){if(!s.includes(p)){this._selectedPoi.delete(p);}}.bind(this));s.forEach(function(p){if(v.getSelectionState(p)){this._selectedPoi.add(p);}else{this._selectedPoi.delete(p);}}.bind(this));}return this;};d.prototype._updateButtonPosition=function(n){var v=this._viewport.getDomRef().getBoundingClientRect();var e=this._poiHelper.getPoiRect(this._viewport,n);if(e){var f=new THREE.Box3();f.expandByObject(n);var g=new THREE.Vector3();f.getCenter(g);var h=this._viewport.projectToScreen(g.x,g.y,g.z,this._viewport.getCamera());var i=h.x+e.width/2;var j=v.height-h.y-e.height/2;this._buttonPosition.set(i,j);return true;}return false;};d.prototype.handlePoiSelectionChange=function(){this._updateSelectedPoi();};d.prototype.setActive=function(v,e){T.prototype.setActive.call(this,v,e);if(this._viewport){this.updateButtons();if(v){this._gizmo=this.getGizmo();this._gizmo.show(this._viewport,this);this._gizmo.rerender();this._addLocoHandler();this._viewport._viewStateManager.attachSelectionChanged(this.handlePoiSelectionChange,this);}else{this._removeLocoHandler();this._viewport._viewStateManager.detachSelectionChanged(this.handlePoiSelectionChange,this);if(this._gizmo){this._gizmo.hide();this._gizmo=null;}}}return this;};d.prototype.updateButtons=function(){this._updateSelectedPoi();var e=this.getButtons();var f;e.forEach(function(g){if(g.getVisible()){g.rerender();if(g.getDomRef()){f=g.getDomRef().parentElement;}}});if(f){if(this._selectedPoi.size&&this._updateButtonPosition(this._selectedPoi.values().next().value)){f.style.display="block";f.style.left=this._buttonPosition.x+"px";f.style.top=this._buttonPosition.y+"px";}else{f.style.display="none";}}};d.prototype.setButtonsVisibility=function(v){this.getButtons().forEach(function(e){if(e.getVisible()!==v){e.setVisible(v);}});};d.prototype.addButtons=function(e){if(!Array.isArray(e)){e=[e];}e.forEach(function(f){this.addAggregation("buttons",f);},this);};return d;});
