/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","./Gizmo","./RotateToolGizmoRenderer","./RotatableAxis","./CoordinateSystem","./AxisColours","../AnimationTrackType","../AnimationTrackValueType","./GizmoPlacementMode","sap/base/assert","sap/base/Log"],function(t,G,R,b,C,A,c,d,e,f,L){"use strict";var g=G.extend("sap.ui.vk.tools.RotateToolGizmo",{metadata:{library:"sap.ui.vk"}});g.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._createEditingForm(String.fromCharCode(176),84);this._gizmoIndex=-1;this._handleIndex=-1;this._value=new THREE.Vector3();this._rotationDelta=new THREE.Vector3();this._viewport=null;this._tool=null;this._sceneGizmo=new THREE.Scene();this._gizmo=new THREE.Group();this._touchAreas=new THREE.Group();this._sceneGizmo.add(this._gizmo);this._axis=b.All;this._coordinateSystem=C.World;this._nodes=[];this._matViewProj=new THREE.Matrix4();this._gizmoSize=96;function a(l,m,r,s){var n=new THREE.TorusBufferGeometry(r,1/96,4,s);if(l===0){n.rotateY(Math.PI/2);}else if(l===1){n.rotateX(Math.PI/2);}var o=new THREE.Mesh(n,new THREE.MeshBasicMaterial({color:m,transparent:true}));o.matrixAutoUpdate=false;o.userData.color=m;return o;}function j(l,r,s){var m=new THREE.TorusBufferGeometry(r,16/96,4,s);if(l===0){m.rotateY(Math.PI/2);}else if(l===1){m.rotateX(Math.PI/2);}return new THREE.Mesh(m,new THREE.MeshBasicMaterial({opacity:0.2,transparent:true}));}for(var i=0;i<3;i++){this._gizmo.add(a(i,A[["x","y","z"][i]],1,128));this._touchAreas.add(j(i,1,24));}this._gizmo.add(new THREE.AxesHelper(0.75));var k=new THREE.MeshBasicMaterial({color:0x0080FF,opacity:0.5,transparent:true,side:THREE.DoubleSide});this._arcMesh=new THREE.Mesh(new THREE.Geometry(),k);this._arcMesh.visible=false;this._gizmo.add(this._arcMesh);this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles);};g.prototype.hasDomElement=function(){return true;};g.prototype.setAxis=function(v){this._axis=v;var a=[b.All,b.X,b.Y,b.Z];if(this._coordinateSystem!==C.Screen){for(var i=0;i<3;i++){if(v!==b.All&&a[i+1]!==v){this._gizmo.children[i].visible=this._touchAreas.children[i].visible=false;}else{this._gizmo.children[i].visible=this._touchAreas.children[i].visible=true;}}}};g.prototype.resetValues=function(){this._value.setScalar(0);};g.prototype.setCoordinateSystem=function(a){this._coordinateSystem=a;var s=a===C.Screen;if(s){this._gizmo.children[0].visible=this._gizmo.children[1].visible=false;this._touchAreas.children[0].visible=this._touchAreas.children[1].visible=false;this._gizmo.children[2].visible=this._touchAreas.children[2].visible=true;}else{this._gizmo.children[0].visible=this._touchAreas.children[0].visible=this._axis===b.All||this._axis===b.X;this._gizmo.children[1].visible=this._touchAreas.children[1].visible=this._axis===b.All||this._axis===b.Y;this._gizmo.children[2].visible=this._touchAreas.children[2].visible=this._axis===b.All||this._axis===b.Z;}this._axisTitles.visible=!s;this._gizmoIndex=this._handleIndex=-1;};g.prototype.show=function(v,a){this._viewport=v;this._tool=a;this._nodes.length=0;this._updateSelection(v._viewStateManager);var n=this._getNodesProperties();this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:n},true);};g.prototype._prepareForCreatingRotationKey=function(a,i,p){this._nodes.forEach(function(n){var k=n.node;var l=[0,0,0];a.setTime(i,p);var m=a.getAnimatedProperty(k,c.Rotate);if(m.offsetToPrevious){l=m.offsetToPrevious;}if(!this._nodeUserDataMap){this._nodeUserDataMap=new Map();}var u=this._nodeUserDataMap.get(k);if(!u){u={};this._nodeUserDataMap.set(k,u);}u.eulerInParentCoors=new THREE.Euler(l[0],l[1],l[2]);u.startEulerInParentCoors=new THREE.Euler(l[0],l[1],l[2]);}.bind(this));var j=a.getCurrentPlayback();if(j){this._prepareForCreatingKey(j);}};g.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false);};g.prototype.getGizmoCount=function(){if(this._coordinateSystem===C.Local||this._coordinateSystem===C.Parent){return this._nodes.length;}else{return this._nodes.length>0?1:0;}};g.prototype.getTouchObject=function(i){if(this._nodes.length===0){return null;}this._updateGizmoObjectTransformation(this._touchAreas,i);return this._touchAreas;};g.prototype.highlightHandle=function(a,j){for(var i=0;i<3;i++){var k=this._gizmo.children[i];var l=i===a?0xFFFF00:k.userData.color;k.material.color.setHex(l);k.material.opacity=a===-1||i===a?1:0.35;k.material.visible=j||i===a;var m=this._axisTitles.children[i];m.material.color.setHex(l);m.material.opacity=a===-1||i===a?1:0.35;m.material.visible=j||i===a;}};g.prototype.selectHandle=function(i,a){this._gizmoIndex=a;this._handleIndex=i;if(this._tool.getAutoResetValues()){this.resetValues();}this._viewport.setShouldRenderFrame();};g.prototype.beginGesture=function(){this._beginValue=this._value.clone();this._rotationDelta.setScalar(0);this._matOrigin=this._gizmo.matrixWorld.clone();this._nodes.forEach(function(n){n.node.parent.updateMatrixWorld(true);n.matOrigin=n.node.matrixWorld.clone();n.matLocalOrigin=n.node.matrix.clone();if(n.node.parent){n.matParentInv=new THREE.Matrix4().getInverse(n.node.parent.matrixWorld);}else{n.matParentInv=new THREE.Matrix4();}n.quaternion=n.node.quaternion.clone();});};g.prototype._printEventInfo=function(a,x,y,z,n){L.debug(a+" is fired:"+" x = "+x+"; y = "+y+"; z = "+z);n.forEach(function(p){L.debug("Node: "+p.node.name);if(p.offsetToRest){L.debug("offsetToRest: [ "+p.offsetToRest[0]+", "+p.offsetToRest[1]+", "+p.offsetToRest[2]+", "+p.offsetToRest[3]+" ] ");}else{L.debug("offsetToRest: null");}if(p.offsetToRestInCoordinates){L.debug("offsetToRestInCoordinates: [ "+p.offsetToRestInCoordinates[0]+", "+p.offsetToRestInCoordinates[1]+", "+p.offsetToRestInCoordinates[2]+" ] ");}else{L.debug("offsetToRestInCoordinates: null");}if(p.offsetToPrevious){L.debug("offsetToPrevious: [ "+p.offsetToPrevious[0]+", "+p.offsetToPrevious[1]+", "+p.offsetToPrevious[2]+" ] ");}else{L.debug("offsetToPrevious: null");}if(p.absolute){L.debug("absolute: [ "+p.absolute[0]+", "+p.absolute[1]+", "+p.absolute[2]+", "+p.absolute[3]+" ] ");}else{L.debug("absolute: null");}if(p.world){L.debug("world: [ "+p.world[0]+", "+p.world[1]+", "+p.world[2]+", "+p.world[3]+" ] ");}else{L.debug("world: null");}if(p.restDifference){L.debug("restDifference: [ "+p.restDifference[0]+", "+p.restDifference[1]+", "+p.restDifference[2]+", "+p.restDifference[3]+" ] ");}else{L.debug("restDifference: null");}if(p.restDifferenceInCoordinates){L.debug("restDifference: [ "+p.restDifferenceInCoordinates[0]+", "+p.restDifferenceInCoordinates[1]+", "+p.restDifferenceInCoordinates[2]+", "+p.restDifferenceInCoordinates[3]+" ] ");}else{L.debug("restDifference: null");}});};g.prototype._getNodesProperties=function(){var n=[];this._nodes.forEach(function(a){var i=a.node;var p={};p.node=i;var u;if(this._nodeUserDataMap){u=this._nodeUserDataMap.get(i);}if(u&&u.eulerInParentCoors){var o=new THREE.Euler(u.eulerInParentCoors.x,u.eulerInParentCoors.y,u.eulerInParentCoors.z);var j=new THREE.Quaternion().setFromEuler(o);if(this._playback){var s=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(i,c.Rotate,this._playback);if(s){var k=new THREE.Quaternion(s[0],s[1],s[2],s[3]);j.multiply(k);}}p.offsetToRest=[j.x,j.y,j.z,j.w];p.offsetToPrevious=[u.eulerInParentCoors.x,u.eulerInParentCoors.y,u.eulerInParentCoors.z];}else{p.offsetToRest=null;p.offsetToPrevious=null;}var l=this._viewport._viewStateManager.getTransformation(i);p.absolute=[l.quaternion[0],l.quaternion[1],l.quaternion[2],l.quaternion[3]];var w=this._viewport._viewStateManager.getTransformationWorld(i);var m=new THREE.Quaternion(w.quaternion[0],w.quaternion[1],w.quaternion[2],w.quaternion[3]);var q=new THREE.Euler().setFromQuaternion(m);p.world=[q.x,q.y,q.z];if(u&&u.quatInitialDiffInv){var r=new THREE.Quaternion(l.quaternion[0],l.quaternion[1],l.quaternion[2],l.quaternion[3]);r.multiply(u.quatInitialDiffInv);p.restDifference=[r.x,r.y,r.z,r.w];}else{p.restDifference=null;}if(u.euler){p.restDifferenceInCoordinates=[u.euler.x,u.euler.y,u.euler.z];}else{p.restDifferenceInCoordinates=null;}p.offsetToRestInCoordinates=null;n.push(p);}.bind(this));return n;};g.prototype.endGesture=function(){this._arcMesh.visible=false;var n=this._getNodesProperties();delete this._beginValue;this._nodes.forEach(function(a){var i=a.node;var u;if(this._nodeUserDataMap){u=this._nodeUserDataMap.get(i);}if(u&&u.euler){u.startEuler.x=u.euler.x;u.startEuler.y=u.euler.y;u.startEuler.z=u.euler.z;u.startEulerInParentCoors.x=u.eulerInParentCoors.x;u.startEulerInParentCoors.y=u.eulerInParentCoors.y;u.startEulerInParentCoors.z=u.eulerInParentCoors.z;}if(this._coordinateSystem!==C.Custom){delete i.userData.skipUpdateJointNode;}this._viewport._viewStateManager._setJointNodeOffsets(i,c.Rotate);}.bind(this));this._tool.fireRotated({x:this._rotationDelta.x,y:this._rotationDelta.y,z:this._rotationDelta.z,nodesProperties:n});this._printEventInfo("Event 'rotated'",this._rotationDelta.x,this._rotationDelta.y,this._rotationDelta.z,n);};var h=function(o,a){if(Math.abs(o-a)<0.000001){return o;}if(o>a){while(o>a){a+=2*Math.PI;}if(a-o<=Math.PI){return a;}else{return a-2*Math.PI;}}else{while(o<a){a-=2*Math.PI;}if(o-a<=Math.PI){return a;}else{return a+2*Math.PI;}}};g.prototype.rotateFromRestPosition=function(x,y,z){if(this._coordinateSystem!==C.Parent){return;}this.beginGesture();this._nodes.forEach(function(i){var j=i.node;if(!j.userData){j.userData={};}j.userData.skipUpdateJointNode=true;});x=THREE.Math.degToRad(x);y=THREE.Math.degToRad(y);z=THREE.Math.degToRad(z);for(var n=0,a=this._nodes.length;n<a;n++){var i=this._nodes[n];if(!i.ignore){var j=i.node;var u;if(this._nodeUserDataMap){u=this._nodeUserDataMap.get(j);}if(u&&u.euler&&u.eulerInParentCoors){this._rotationDelta.set(THREE.Math.radToDeg(x-u.eulerInParentCoors.x),THREE.Math.radToDeg(y-u.eulerInParentCoors.y),THREE.Math.radToDeg(z-u.eulerInParentCoors.z));u.eulerInParentCoors.x=x;u.eulerInParentCoors.y=y;u.eulerInParentCoors.z=z;var o=new THREE.Euler(u.eulerInParentCoors.x,u.eulerInParentCoors.y,u.eulerInParentCoors.z);var k=new THREE.Quaternion().setFromEuler(o);var r=this._viewport._viewStateManager.getRestTransformationUsingJoint(j);var l=new THREE.Quaternion(r.quaternion[0],r.quaternion[1],r.quaternion[2],r.quaternion[3]);if(this._playback){var s=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(j,c.Rotate,this._playback);if(s){var m=new THREE.Quaternion(s[0],s[1],s[2],s[3]);k.multiply(m);}}var p=this._getEffectiveParent(j);if(p!==j.parent){this._viewport._viewStateManager._setJointNodeOffsets(j,c.Rotate);j.userData.offsetQuaternion=[k.x,k.y,k.z,k.w];j.userData.skipUpdateJointNode=false;this._viewport._viewStateManager._setJointNodeMatrix();j.userData.skipUpdateJointNode=true;}else{j.quaternion.copy(k.multiply(l));}j.updateMatrix();u.euler.x=u.eulerInParentCoors.x-u.startEulerInParentCoors.x+u.startEuler.x;u.euler.y=u.eulerInParentCoors.y-u.startEulerInParentCoors.y+u.startEuler.y;u.euler.z=u.eulerInParentCoors.z-u.startEulerInParentCoors.z+u.startEuler.z;}}}this.endGesture();};g.prototype.rotateRestPosition=function(x,y,z){this.beginGesture();this._nodes.forEach(function(i){var j=i.node;if(!j.userData){j.userData={};}j.userData.skipUpdateJointNode=true;});x=THREE.Math.degToRad(x);y=THREE.Math.degToRad(y);z=THREE.Math.degToRad(z);for(var n=0,a=this._nodes.length;n<a;n++){var i=this._nodes[n];if(!i.ignore){var j=i.node;var u;if(this._nodeUserDataMap){u=this._nodeUserDataMap.get(j);}if(u&&u.euler&&u.eulerInParentCoors){this._rotationDelta.set(THREE.Math.radToDeg(x-u.euler.x),THREE.Math.radToDeg(y-u.euler.y),THREE.Math.radToDeg(z-u.euler.z));u.euler.x=x;u.euler.y=y;u.euler.z=z;var o=new THREE.Euler(u.euler.x,u.euler.y,u.euler.z);var k=new THREE.Quaternion().setFromEuler(o);var l=new THREE.Matrix4();var m=new THREE.Matrix4();if(this._coordinateSystem===C.Local){l=j.parent.matrixWorld.clone().multiply(u.matRest);m=u.matRestInv.clone().multiply(i.matParentInv);}else if(this._gizmo&&this._coordinateSystem!==C.Parent){l=this._gizmo.matrixWorld.clone();m=m.getInverse(l);}var p=new THREE.Matrix4().makeRotationFromQuaternion(k);var q=p;if(this._coordinateSystem!==C.Parent){q=i.matParentInv.clone().multiply(l).multiply(p).multiply(m).multiply(j.parent.matrixWorld);}var r=new THREE.Matrix4().makeRotationFromQuaternion(u.quatInitialDiff).multiply(q);var s=new THREE.Euler().setFromRotationMatrix(r);if(Math.abs(s.x)<0.000001){s.x=0;}if(Math.abs(s.y)<0.000001){s.y=0;}if(Math.abs(s.z)<0.000001){s.z=0;}u.eulerInParentCoors.x=h(u.eulerInParentCoors.x,s.x);u.eulerInParentCoors.y=h(u.eulerInParentCoors.y,s.y);u.eulerInParentCoors.z=h(u.eulerInParentCoors.z,s.z);j.matrix=u.matInitialDiff.clone().multiply(q.multiply(u.matRest));j.matrix.decompose(j.position,j.quaternion,j.scale);j.updateMatrix();}}}this.endGesture();};g.prototype._updateEulerForCreatingAnimationKey=function(a){for(var n=0,i=this._nodes.length;n<i;n++){var j=this._nodes[n];if(!j.ignore){var k=j.node;var u;if(this._nodeUserDataMap){u=this._nodeUserDataMap.get(k);}if(u&&u.euler){u.euler.x=u.startEuler.x+a[0];u.euler.y=u.startEuler.y+a[1];u.euler.z=u.startEuler.z+a[2];var l=false;if((Math.abs(u.euler.x)<0.000001&&(Math.abs(u.euler.y)<0.000001||Math.abs(u.euler.z)<0.000001))||(Math.abs(u.euler.y)<0.000001&&Math.abs(u.euler.z)<0.000001)){l=true;}if(l&&this._coordinateSystem===C.Parent){u.eulerInParentCoors.x=u.startEulerInParentCoors.x+a[0];u.eulerInParentCoors.y=u.startEulerInParentCoors.y+a[1];u.eulerInParentCoors.z=u.startEulerInParentCoors.z+a[2];continue;}var r=this._viewport._viewStateManager.getRelativeTransformation(k);var o;var p=this._getEffectiveParent(k);if(p!==k.parent&&this._coordinateSystem!==C.Custom){this._viewport._viewStateManager._setJointNodeOffsets(k,c.Rotate);o=new THREE.Quaternion(k.userData.offsetQuaternion[0],k.userData.offsetQuaternion[1],k.userData.offsetQuaternion[2],k.userData.offsetQuaternion[3]);k.userData.skipUpdateJointNode=false;this._viewport._viewStateManager._setJointNodeMatrix();k.userData.skipUpdateJointNode=true;}else{o=new THREE.Quaternion(r.quaternion[0],r.quaternion[1],r.quaternion[2],r.quaternion[3]);}var m=new THREE.Matrix4().makeRotationFromQuaternion(o);if(this._playback){var s=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(k,c.Rotate,this._playback);if(s){var q=new THREE.Quaternion(s[0],s[1],s[2],s[3]);var v=new THREE.Matrix4().makeRotationFromQuaternion(q);m.multiply(new THREE.Matrix4().getInverse(v));}}var w=new THREE.Euler().setFromRotationMatrix(m);if(Math.abs(w.x)<0.00001){w.x=0;}if(Math.abs(w.y)<0.00001){w.y=0;}if(Math.abs(w.z)<0.00001){w.z=0;}u.eulerInParentCoors.x=h(u.eulerInParentCoors.x,w.x);u.eulerInParentCoors.y=h(u.eulerInParentCoors.y,w.y);u.eulerInParentCoors.z=h(u.eulerInParentCoors.z,w.z);if(l){continue;}var x=new THREE.Matrix4();var y=new THREE.Matrix4();if(this._coordinateSystem===C.Local){x=k.parent.matrixWorld.clone().multiply(u.matRest);y=u.matRestInv.clone().multiply(j.matParentInv);}else if(this._gizmo&&this._coordinateSystem!==C.Parent){x=this._gizmo.matrixWorld.clone();y=y.getInverse(x);}var z=new THREE.Quaternion(r.quaternion[0],r.quaternion[1],r.quaternion[2],r.quaternion[3]);z.multiply(u.quatInitialDiffInv);var B=new THREE.Matrix4().makeRotationFromQuaternion(z);var D=B;if(this._coordinateSystem!==C.Parent){D=y.clone().multiply(k.parent.matrixWorld).multiply(B).multiply(j.matParentInv).multiply(x);}w=new THREE.Euler().setFromRotationMatrix(D);if(Math.abs(w.x)<0.000001){w.x=0;}if(Math.abs(w.y)<0.000001){w.y=0;}if(Math.abs(w.z)<0.000001){w.z=0;}u.euler.x=h(u.euler.x,w.x);u.euler.y=h(u.euler.y,w.y);u.euler.z=h(u.euler.z,w.z);}}}};g.prototype._rotate=function(a){this._rotationDelta.set(THREE.Math.radToDeg(a.x),THREE.Math.radToDeg(a.y),THREE.Math.radToDeg(a.z));this._value.addVectors(this._beginValue,this._rotationDelta);this._nodes.forEach(function(r){var s=r.node;if(!s.userData){s.userData={};}s.userData.skipUpdateJointNode=true;});var q=new THREE.Quaternion();if(this._coordinateSystem===C.Local){q.setFromEuler(a);this._nodes.forEach(function(r){var s=r.node;s.quaternion.copy(r.quaternion).multiply(q);s.updateMatrix();});a=a.toArray();this._updateEulerForCreatingAnimationKey(a);}else{a=a.toArray();for(var i=0;i<3;i++){var j=a[i];if(j){var k=a[3].charCodeAt(i)-88;if(k>=0&&k<3){var l=new THREE.Vector3().setFromMatrixColumn(this._matOrigin,k).normalize();var m=new THREE.Matrix4().makeRotationAxis(l,j);var p=new THREE.Vector3().setFromMatrixPosition(this._matOrigin);m.setPosition(p.sub(p.clone().applyMatrix4(m)));for(var n=0,o=this._nodes.length;n<o;n++){var r=this._nodes[n];if(!r.ignore){var s=r.node;if(this._coordinateSystem!==C.Parent){s.position.setFromMatrixPosition(r.matOrigin).applyMatrix4(m).applyMatrix4(r.matParentInv);}var u=new THREE.Vector3().setFromMatrixScale(r.matOrigin);var v=l.clone().transformDirection(new THREE.Matrix4().getInverse(r.matOrigin)).multiply(u).normalize();q.setFromAxisAngle(v,j);s.quaternion.copy(r.quaternion).multiply(q);s.updateMatrix();}}}}}this._updateEulerForCreatingAnimationKey(a);}this._viewport.setShouldRenderFrame();};g.prototype._setRotationAxisAngle=function(j,k,l){var m=(l-k)%(Math.PI*2);var o=new THREE.Euler();o[["x","y","z"][j]]=m;var p=this._getNodesProperties();if(this._tool.fireEvent("rotating",{x:THREE.Math.radToDeg(o.x),y:THREE.Math.radToDeg(o.y),z:THREE.Math.radToDeg(o.z),nodesProperties:p},true)){this._printEventInfo("Event 'rotating'",THREE.Math.radToDeg(o.x),THREE.Math.radToDeg(o.y),THREE.Math.radToDeg(o.z),p);this._rotate(o);var v=[0,0,0];var q=new THREE.Vector3();var r=(j+1)%3,s=(j+2)%3;var i,n=Math.max(Math.ceil(Math.abs(m)*64/Math.PI),1);m*=this._coordinateSystem===C.Local?-1:1;for(i=0;i<=n;i++){var a=k+m*(i/n);q.set(0,0,0).setComponent(r,Math.cos(a)).setComponent(s,Math.sin(a));v.push(q.x,q.y,q.z);}var u=[];for(i=0;i<n;i++){u.push(0,i+1,i+2);}var w=new THREE.BufferGeometry();w.setIndex(u);w.setAttribute("position",new THREE.Float32BufferAttribute(v,3));this._arcMesh.geometry=w;this._arcMesh.visible=true;}};g.prototype.rotate=function(x,y,z){this.beginGesture();this._rotate(new THREE.Euler(THREE.Math.degToRad(x||0),THREE.Math.degToRad(y||0),THREE.Math.degToRad(z||0)));};g.prototype._getValueLocaleOptions=function(){return{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:2};};g.prototype.getValue=function(){return(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3)?this._value.getComponent(this._handleIndex):0;};g.prototype.setValue=function(v){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){var a=new THREE.Euler();a[["x","y","z"][this._handleIndex]]=THREE.Math.degToRad(v-this._value.getComponent(this._handleIndex));this.beginGesture();this._rotate(a);this.endGesture();}};g.prototype.expandBoundingBox=function(a){if(this._viewport){this._expandBoundingBox(a,this._viewport.getCamera().getCameraRef(),true);}};g.prototype.handleSelectionChanged=function(a){if(this._viewport){if(this._tool.getEnableSnapping()){this._tool.getDetector().setSource(this._viewport._viewStateManager);}this._updateSelection(this._viewport._viewStateManager);var n=this._getNodesProperties();this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:n},true);this._gizmoIndex=this._handleIndex=-1;}};g.prototype._getLevelingQuaternion=function(q,o){q.set(0,0,0,1);switch(this._coordinateSystem){case C.Local:q.setFromRotationMatrix(this._nodes[o].node.parent.matrixWorld);break;case C.Screen:q.copy(this._viewport.getCamera().getCameraRef().quaternion);break;case C.Custom:var a=this._getAnchorPoint();if(a){q.copy(a.quaternion);}break;default:break;}};g.prototype._getObjectSize=function(o){var a=new THREE.Box3();if(this._nodes.length===1){this._nodes[0].node._expandBoundingBox(a,true,false);}else if(this._coordinateSystem===C.Local){this._nodes[0].node._expandBoundingBox(a,true,false);}if(a.isEmpty()){return 0;}var s=new THREE.Vector3();a.getSize(s);return s.length();};g.prototype._updateGizmoTransformation=function(i,a){var s=this._updateGizmoObjectTransformation(this._gizmo,i);this._updateAxisTitles(this._axisTitles,this._gizmo,a,this._gizmoSize-12,s);};g.prototype._getEditingFormPosition=function(){var s=this._updateGizmoObjectTransformation(this._gizmo,this._gizmoIndex);var a=new THREE.Vector3().setFromMatrixColumn(this._gizmo.matrixWorld,this._handleIndex).normalize();return a.clone().multiplyScalar((this._gizmoSize-12)*s).add(this._gizmo.position).applyMatrix4(this._matViewProj);};g.prototype.render=function(){f(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._nodes.length>0){var r=this._viewport.getRenderer(),a=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);r.clearDepth();for(var i=0,l=this.getGizmoCount();i<l;i++){this._updateGizmoTransformation(i,a);r.render(this._sceneGizmo,a);}}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex);};return g;});
