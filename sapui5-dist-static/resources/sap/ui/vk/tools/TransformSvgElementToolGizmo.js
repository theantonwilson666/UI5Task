/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Gizmo","./TransformSvgElementToolGizmoRenderer","../svg/Element","../svg/Rectangle","./ToolNodeSet"],function(G,a,E,R,T){"use strict";var b=G.extend("sap.ui.vk.tools.TransformSvgElementToolGizmo",{metadata:{library:"sap.ui.vk"}});b.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}};b.prototype.show=function(v,t){this._viewport=v;this._tool=t;this._nodes=[];this._cursor=null;this.handleSelectionChanged();v.attachCameraChanged(this._handleChanged,this);v._viewStateManager.attachTransformationChanged(this._handleChanged,this);};b.prototype.hide=function(){if(this._cursor){this._viewport.removeStyleClass(this._cursor);this._cursor=null;}this._viewport._viewStateManager.detachTransformationChanged(this._handleChanged,this);this._viewport.detachCameraChanged(this._handleChanged,this);this._viewport=null;this._tool=null;this._nodes=[];};b.prototype._handleChanged=function(){if(this.getDomRef()){this.rerender();}};b.prototype._getHandleLocalPositions=function(i,m){var j=i.bbox;var x=j.x;var k=j.x+j.width;var l=(x+k)*0.5;var y=j.y+j.height*0.5;var o=j.height*0.5*i.ySign;var p=y-o;var q=y+o;var r=p-48*i.ySign/(this._viewport._camera.zoom*Math.sqrt(m[2]*m[2]+m[3]*m[3]));return[l,p,k,p,k,y,k,q,l,q,x,q,x,y,x,p,l,r,l,y];};b.prototype._selectHandle=function(i,j){this._gizmoIndex=i;this._handleIndex=j;var k=null;if(i>=0){if(j>=0){if(j<8){var l=this._nodes[i];var m=l.node._matrixWorld();var o=Math.round(Math.atan2(m[2],m[3])*4/Math.PI);k=["NSResize","NESWResize","EWResize","NWSEResize"][(16-o+j*l.xSign*l.ySign)%4];}else{k="Rotate";}}else{k="Move";}k="sapUiVkTransformationToolCursor"+k;}if(this._cursor!=k){if(this._cursor){this._viewport.removeStyleClass(this._cursor);}if(k){this._viewport.addStyleClass(k);}this._cursor=k;}};function g(m){return{x:m[4],y:m[5]};}function c(m){return{x:Math.sqrt(m[0]*m[0]+m[1]*m[1]),y:Math.sqrt(m[2]*m[2]+m[3]*m[3])};}function d(m){return Math.atan2(m[0],m[1]);}function n(i){if(i<-Math.PI){return i+Math.PI*2;}else if(i>Math.PI){return i-Math.PI*2;}return i;}function e(i){var r=null;while(i.parent){r=i;i=i.parent;}return r&&r.matrix[3]<0?-1:1;}function f(v,i,j,k){return v*j+i*k;}function h(m){return m[0]*m[3]-m[1]*m[2];}b.prototype.handleSelectionChanged=function(j){var k=this._viewport?this._viewport._viewStateManager:null;if(k===null){return;}var l=[];if(this._tool){k[this._tool.getNodeSet()===T.Highlight?"enumerateSelection":"enumerateOutlinedNodes"](function(i){var m=i._matrixWorld();var x=h(m)<0?-1:1;if(i.parent){m=E._multiplyMatrices(E._invertMatrix(i.parent._matrixWorld()),m);}l.push({node:i,bbox:i.domRef?i.domRef.getBBox():{x:0,y:0,width:0,height:0},position:g(m),scale:c(m),angle:d(m),xSign:x,ySign:e(i)});});}if(this._nodes.length===l.length&&this._nodes.every(function(v,i){return l[i].node===v.node;})){return;}this._nodes=l;if(this.getDomRef()){this.rerender();}};b.prototype.beginGesture=function(){this._nodes.forEach(function(i){var j=i.node;i.beginWorldMatrix=j._matrixWorld();i.bbox=j.domRef?j.domRef.getBBox():null;});this._eventParameters=null;};b.prototype._update=function(i,j){var k=this._handleIndex;var o=k>=0&&k<8?(k+4)%8:9;var s=1,l=1,p=1,q=0;var r=[];var t;var u={nodesProperties:r};if(k<0){t="moving";u.x=i;u.y=j;}else{var v=this._nodes[this._gizmoIndex];var m=v.beginWorldMatrix;var w=this._getHandleLocalPositions(v,m);if(k<8){t="scaling";var x=w[o*2];var y=w[o*2+1];var z=w[k*2];var A=w[k*2+1];var B=f(z-x,A-y,m[0],m[2]);var C=f(z-x,A-y,m[1],m[3]);s=k===0||k===4?1:f(m[0],m[1],B+i,C+j)/f(m[0],m[1],B,C);l=k===2||k===6?1:f(m[2],m[3],B+i,C+j)/f(m[2],m[3],B,C);if(this._tool.getUniformScaleEnabled()){if(k===0||k===4){s=l;}else if(k===2||k===6){l=s;}else{s=l=Math.max(s,l);}}u.x=s;u.y=l;}else{t="rotating";var D=E._transformPoint(w[18],w[19],m);var F=E._transformPoint(w[16],w[17],m);var H=Math.atan2(F.x-D.x,F.y-D.y);var I=Math.atan2(F.x-D.x+i,F.y-D.y+j);var J=n(I-H);u.angle=J;p=Math.cos(J);q=Math.sin(J);}}this._nodes.forEach(function(K){var L=K.node;var M=K.beginWorldMatrix.slice();var N={node:L};if(k<0){M[4]+=i;M[5]+=j;}else{var w=this._getHandleLocalPositions(K,M);if(k<8){var O=w[o*2];var P=w[o*2+1];M[4]+=(O*M[0]+P*M[2]);M[5]+=(O*M[1]+P*M[3]);M[0]*=s;M[1]*=s;M[2]*=l;M[3]*=l;M[4]-=(O*M[0]+P*M[2]);M[5]-=(O*M[1]+P*M[3]);}else{var D=E._transformPoint(w[18],w[19],M);var Q=new Float32Array([p,-q,q,p,D.x-(D.x*p+D.y*q),D.y-(D.x*-q+D.y*p)]);M=E._multiplyMatrices(Q,M);}}K.xSign=h(M)<0?-1:1;if(L.parent){M=E._multiplyMatrices(E._invertMatrix(L.parent._matrixWorld()),M);}if(k<0){var S=g(M);N.x=S.x-K.position.x;N.y=S.y-K.position.y;}else if(k<8){var U=c(M);N.x=U.x/K.scale.x;N.y=U.y/K.scale.y;}else{N.angle=n(d(M)-K.angle);}L.setMatrix(M);r.push(N);}.bind(this));this.rerender();this._eventParameters=u;this._tool.fireEvent(t,u,true);};b.prototype.endGesture=function(){if(this._eventParameters){var i=this._handleIndex;var j;if(i<0){j="moved";}else if(i<8){j="scaled";}else{j="rotated";}this._tool.fireEvent(j,this._eventParameters,true);}};b.prototype.onBeforeRendering=function(){};b.prototype.onAfterRendering=function(){};return b;});
