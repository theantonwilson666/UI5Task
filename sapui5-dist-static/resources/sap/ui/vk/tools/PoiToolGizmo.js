/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","./Gizmo","./PoiToolGizmoRenderer","./GizmoPlacementMode","sap/base/assert"],function(t,G,P,a,b){"use strict";var c=G.extend("sap.ui.vk.tools.PoiToolGizmo",{metadata:{library:"sap.ui.vk"}});c.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._viewport=null;this._tool=null;this._placementMode=a.ObjectCenter;this._nodes=[];this._poiIndex=-1;this._moveDelta=new THREE.Vector3();};c.prototype.hasDomElement=function(){return true;};c.prototype.show=function(v,d){this._viewport=v;this._tool=d;this._nodes.length=0;this._updateSelection(v._viewStateManager);var n=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:n},true);};c.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._poiIndex=-1;};c.prototype.getPOICount=function(){return this._nodes.length;};c.prototype.getPOI=function(i){return i<this._nodes.length?this._nodes[i].node:null;};c.prototype.selectPOI=function(p){this._poiIndex=p;this._viewport.setShouldRenderFrame();};c.prototype.beginGesture=function(){this._moveDelta.setScalar(0);this._nodes.forEach(function(n){var d=n.node;n.origin=new THREE.Vector3().setFromMatrixPosition(d.matrixWorld);n.matParentInv=new THREE.Matrix4();if(d.parent){n.matParentInv.getInverse(d.parent.matrixWorld);}});};c.prototype._getNodesProperties=function(){var n=[];this._nodes.forEach(function(d){n.push({node:d.node});});return n;};c.prototype.endGesture=function(){this._tool.fireMoved({x:this._moveDelta.x,y:this._moveDelta.y,z:this._moveDelta.z,nodesProperties:this._getNodesProperties()});};c.prototype._setOffset=function(o){if(this._tool.fireEvent("moving",{x:o.x,y:o.y,z:o.z,nodesProperties:this._getNodesProperties()},true)){this._move(o);}};c.prototype._move=function(o){this._moveDelta.copy(o);var i=this._viewport._isPanoramicActivated();var d=new THREE.Vector3().setFromMatrixPosition(this._viewport.getCamera().getCameraRef().matrixWorld);this._nodes.forEach(function(n){var e=n.node;if(!n.origin){n.origin=new THREE.Vector3().setFromMatrixPosition(e.matrixWorld);}var p=n.origin.clone();if(i){var f=p.distanceTo(d);p.add(o).sub(d).setLength(f).add(d);}else{p.add(o);}e.matrixWorld.setPosition(p);e.matrix.multiplyMatrices(n.matParentInv,e.matrixWorld);e.position.setFromMatrixPosition(e.matrix);e.matrixWorldNeedsUpdate=true;});this._viewport.setShouldRenderFrame();};c.prototype.move=function(x,y,z){this.beginGesture();this._move(new THREE.Vector3(x,y,z||0));};c.prototype.handleSelectionChanged=function(e){if(this._viewport){this._updateSelection(this._viewport._viewStateManager);var n=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:n},true);this._poiIndex=-1;}};c.prototype._getSelectionCenter=function(d){G.prototype._getSelectionCenter.apply(this,arguments);var e=new THREE.Vector3();if(this._nodes[0].node.userData.boundingBox){this._nodes[0].node.userData.boundingBox.getCenter(e);}else{var f=new THREE.Box3();f.expandByObject(this._nodes[0].node);f.getCenter(e);}d.copy(e.applyMatrix4(this._nodes[0].node.matrixWorld));};c.prototype._updatePoiButtons=function(){this._tool.updateButtons();};c.prototype.render=function(){b(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");this._updatePoiButtons();};return c;});
