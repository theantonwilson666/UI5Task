/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","./Element","./Ellipse","./Rectangle","./Line","./Polyline","./Path","./Text","./OrthographicCamera","../View","../NodeContentType","../TransformationMatrix","../getResourceBundle","../totara/TotaraUtils"],function(L,E,a,R,b,P,c,T,O,V,N,d,g,f){"use strict";var S=function(r,e,i,j){this._rootNode=r;this._contentResource=e;this._resolve=i;this._reject=j;this._cameras=new Map();this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._materialMap=new Map();this._materialNodesMap=new Map();this._nodes=new Map();this._viewGroups=new Map();this._views=new Map();this._viewThumbnails=new Map();this._geometries=new Map();this._geometryMeshes=new Map();this._meshNodes=new Map();this._meshSubmeshes=new Map();this._images=new Map();this._fillStyles=new Map();this._lineStyles=new Map();this._textStyles=new Map();this._joints=new Map();this._yIndex=1;if(e){var n=e.getNodeProxy();var l=n.getNodeHierarchy();this._vkScene=l.getScene();var s=e.getSource();if(s&&s.name){this._sceneIdTreeNodesMap.set(s.name,this._nodes);this._sceneIdRootNodeMap.set(s.name,r);this._currentSceneId=s.name;}if(this._rootNode){this._rootNode.userData.skipIt=!e.name;}}};S.prototype.setScene=function(i){if(i.result!==1){var e={status:i.result};switch(i.result){case-1:e.errorText=g().getText("LOADER_FILENOTFOUND");break;case-2:e.errorText=g().getText("LOADER_WRONGFILEFORMAT");break;case-3:e.errorText=g().getText("LOADER_WRONGPASSWORD");break;case-4:e.errorText=g().getText("LOADER_ERRORREADINGFILE");break;case-5:e.errorText=g().getText("LOADER_FILECONTENT");break;default:e.errorText=g().getText("LOADER_UNKNOWNERROR");}this._reject(e);}else{this._yIndex=1;this._rootNode.matrix[3]=i.upAxis===2?-1:1;var j=this._cameras.get(i.cameraId);L.info("setScene",JSON.stringify(i),j);this._resolve({node:this._rootNode,camera:j,backgroundTopColor:i.backgroundTopColor,backgroundBottomColor:i.backgroundBottomColor,contentResource:this._contentResource,builder:this});}};S.prototype.setRootNode=function(r,n,s,v){this._rootNode=r;r.sid=n;this._nodes.set(n,r);this._viewGroups=new Map();this._views=new Map();if(s){this._sceneIdTreeNodesMap.set(s,this._nodes);this._sceneIdRootNodeMap.set(s,r);this._currentSceneId=s;}if(v){this._vkScene=v;}return this;};S.prototype.setNodePersistentId=function(n,e,s){this._resetCurrentScene(s);n.sid=e;this._nodes.set(e,n);return true;};S.prototype.cleanup=function(){this._rootNode=null;this._currentSceneId=null;if(this._nodes){this._nodes.clear();}if(this._viewGroups){this._viewGroups.clear();}if(this._views){this._views.clear();}this._materialMap.clear();this._materialNodesMap.clear();this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._fillStyles.clear();this._lineStyles.clear();this._textStyles.clear();};S.prototype.getNode=function(n,s){if(s){this._resetCurrentScene(s);if(this._nodes){return this._nodes.get(n);}}else{var e=this._sceneIdTreeNodesMap.values();var i=e.next();while(!i.done){var j=i.value.get(n);if(j){return j;}i=e.next();}}return null;};S.prototype._resetCurrentScene=function(s){if(s&&s!==this._currentSceneId){var n=this._sceneIdTreeNodesMap.get(s);if(n){this._nodes=n;}else{this._nodes=new Map();}var e=this._sceneIdRootNodeMap.get(s);if(e){this._rootNode=e;}else{this._rootNode=null;}this._currentSceneId=s;}};S.prototype.createCamera=function(e,s){this._resetCurrentScene(s);var i=new O();i.setPosition(e.origin);i.setZoomFactor(e.zoom);this._cameras.set(e.id,i);return i;};S.prototype.getCamera=function(e){return this._cameras.get(e);};S.prototype.hasMesh=function(m){return this._meshSubmeshes.has(m);};S.prototype.hasImage=function(i){return this._images.has(i);};function h(l){if(Array.isArray(l)){for(var i=0;i<l.length;i++){if(l[i].type===undefined||l[i].type==="mesh"||l[i].type==="line"){return l[i];}}}return null;}S.prototype.setMeshNode=function(n,m){this._setMeshNode(this._nodes.get(n),m);};S.prototype.setModelViewVisibilitySet=function(){};S.prototype.setAnimationPlaybacks=function(){};S.prototype.loadingFinished=function(i){L.info("loadingFinished",JSON.stringify(i));this._loader.fireContentLoadingFinished({source:this._contentResource,node:this._rootNode});};S.prototype.createThumbnail=function(i){var v=this._viewThumbnails.get(i.imageId);if(v){v.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,i.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:v});}}};S.prototype.insertSubmesh=function(s){if(!s.lods){return false;}var l=h(s.lods);if(!l){return false;}s.boundingBox=l.boundingBox;var e=this._geometries.get(l.id);if(e){var n=this._meshNodes.get(s.meshId);if(n){for(var i=0;i<n.length;i++){this._addGeometryToNode(n[i],e,s);}}}else{f.pushElementIntoMapArray(this._geometryMeshes,l.id,s);}f.pushElementIntoMapArray(this._meshSubmeshes,s.meshId,s);};S.prototype.getViewGroup=function(v,s){this._resetCurrentScene(s);var e=this._viewGroups.get(v);var i=[];if(e&&e.views){for(var j=0;j<e.views.length;j++){var l=e.views[j].id;var m=this._views.get(l);if(m){i.push(m);}}}return i;};S.prototype.insertViewGroup=function(i,s){this._resetCurrentScene(s);var v=this._viewGroups.get(i.id);if(!v){v=this._vkScene.createViewGroup({viewGroupId:i.id,name:i.name,description:i.description});this._viewGroups.set(i.id,v);}else{v.setViewGroupId(i.id);v.setName(i.name);v.setDescription(i.description);}v.type=i.type;v.metadata=i.metadata;v.veids=i.veids;v.views=i.views;v.sceneId=i.sceneId;return this;};S.prototype.insertView=function(v,s){this._resetCurrentScene(s);var e=this._vkScene.createView({viewId:v.viewId,name:v.name,description:v.description?"<pre style=\"white-space: pre-wrap;\">"+v.description+"</pre>":v.description,aspectRatio:v.safeAreaAspectRatio});e.userData={viewInfo:v};if(v.thumbnailId){var i=this._images.get(v.thumbnailId);if(i){e.thumbnailData=i;}else{this._viewThumbnails.set(v.thumbnailId,e);}}if(v.cameraId){e.setCamera(this._cameras.get(v.cameraId));}e.type=v.type;e.flyToTime=v.flyToTime;e.preDelay=v.preDelay;e.postDelay=v.postDelay;e.navigationMode=v.navigationMode;e.topColor=v.topColour;e.bottomColor=v.bottomColour;e.dimension=v.dimension;e.query=v.query;e.metadata=v.metadata;e.veids=v.veids;e.viewGroupId=v.viewGroupId;e.id=v.viewId;this._views.set(v.viewId,e);if(e.viewGroupId){var j=this._viewGroups.get(e.viewGroupId);if(j){j.addView(e);}}return this;};S.prototype.getView=function(v,s){this._resetCurrentScene(s);return this._views.get(v);};S.prototype.setViewCamera=function(e,v,s){this._resetCurrentScene(s);var i=this._cameras.get(e);var j=this._views.get(v);if(i&&j){j.setCamera(i);}return this;};S.prototype.getChildNodeIds=function(n,s,e){this._resetCurrentScene(s);var j=this._nodes.get(n);var l=[];if(!j){return l;}if(j&&j.children){for(var i=0;i<j.children.length;i++){var m=j.children[i];if(m.userData.treeNode&&m.userData.treeNode.sid){l.push(m.userData.treeNode.sid);}else if(e&&m.userData.submeshInfo&&m.userData.submeshInfo.id){l.push(m.userData.submeshInfo.id);}}}return l;};S.prototype.setViewNodeInfos=function(n,v,s){this._resetCurrentScene(s);var e=this._views.get(v);e.setNodeInfos(n);return this;};S.prototype.finalizeViewGroups=function(s){this._resetCurrentScene(s);var e=this._viewGroups.entries();var n=e.next();while(!n.done){var v=n.value[1];var i=n.value[0];if(!v||!v.views||!v.views.length){n=e.next();continue;}v.removeViews();for(var j=0;j<v.views.length;j++){var l=v.views[j].id;var m=this._views.get(l);if(m&&m.userData.viewInfo.thumbnailId&&!m.thumbnailData){var p=this._images.get(m.userData.viewInfo.thumbnailId);if(p){m.thumbnailData=p;}}if(m){m.viewGroupId=i;v.addView(m);}}n=e.next();}return this;};S.prototype.setVoxelThreshold=function(v){return this;};S.prototype.getVoxelThreshold=function(){return 0.0;};S.prototype.createNode=function(n,s){this._resetCurrentScene(s);var t=n.transform;var e=new E({sid:n.sid,name:n.name,matrix:d.convertTo3x2(t)});this._nodes.set(n.sid,e);var i=e.userData;if(n.metadata){i.metadata=n.metadata;}if(n.veids){i.veids=n.veids;}if(n.parametricId){i.parametricId=n.parametricId;}else if(n.meshId){this._setMeshNode(e,n.meshId);}i.treeNode=n;e.setVisible(1,n.visible?n.visible:true);if(n.visualisable===false){i.skipIt=true;}if(n.contentType==="HOTSPOT"){e._vkSetNodeContentType(N.Hotspot);}if(n.joints){n.joints.forEach(function(l){var p=this._nodes.get(l.parentSid);if(p){p.userData.jointNodes=p.userData.jointNodes||[];p.userData.jointNodes.push(e);}else{f.pushElementIntoMapArray(this._joints,l.parentSid,e);}},this);}var j=this._joints.get(n.sid);if(j){i.jointNodes=i.jointNodes?i.jointNodes.concat(j):j;}var p=this._nodes.get(n.parentId);(p||this._rootNode).add(e);return e;};S.prototype.preferMeshes=function(){return false;};S.prototype.createAnnotation=function(e,s){};S.prototype.remove=function(n,s){this._resetCurrentScene(s);var t=this;n=[].concat(n);n.forEach(function(e){var j=t._nodes.get(e);if(j){t._nodes.delete(e);for(var i=0;i<j.children.length;i++){var l=j.children[i];if(l.userData&&l.userData.treeNode&&l.userData.treeNode.sid){t.remove(l.userData.treeNode.sid,s);}}}});return this;};S.prototype._addPolylineSegment=function(s,e,p){var j=e.length;if(j<2){return;}var m=[];var n=e[0]===e[j-1];if(n){j--;}for(var i=0,l=e.length;i<l;i++){var q=e[i]*3;m.push(p[q],p[q+this._yIndex]);}s.push({type:"polyline",points:m,closed:n});};S.prototype._addGeometryToNode=function(n,e,s){var m=s.materialId;var j=this._getMaterial(m);var p=e.data;var q=p.indices;var r=p.points;var t=new Float32Array([1,0,0,1,0,0]);if(e.isPositionQuantized&&s.boundingBox){}if(s.transform){}var i,v,w,x;var l=q.length;var y=[];if(e.isPolyline){j=Object.assign(Object.assign({},j),{color:[0,0,0,0]});var z=[];for(i=0,v=-1;i<l;i+=2,v=x){w=q[i];x=q[i+1];if(w!==v){this._addPolylineSegment(y,z,r);z.length=0;z.push(w);}z.push(x);}this._addPolylineSegment(y,z,r);}else{j=Object.assign(Object.assign({},j),{lineColor:[0,0,0,0],lineWidth:0});var A=[];for(i=0;i<l;i+=3){v=q[i]*3;w=q[i+1]*3;x=q[i+2]*3;A.push(r[v],r[v+this._yIndex],r[w],r[w+this._yIndex],r[x],r[x+this._yIndex]);}y.push({type:"mesh",points:A});}var B=new c({segments:y,isTriangleMesh:!e.isPolyline,matrix:t,material:j,materialID:m,fillStyle:e.isPolyline?null:{colour:j.color},subelement:true});B.uid+="-g";n.add(B);f.pushElementIntoMapArray(this._materialNodesMap,m,B);n.rerender();};S.prototype.setGeometry=function(e){this._geometries.set(e.id,e);var i=this._geometryMeshes.get(e.id);if(i){for(var m=0;m<i.length;m++){var s=i[m];var n=this._meshNodes.get(s.meshId);if(n){for(var j=0;j<n.length;j++){this._addGeometryToNode(n[j],e,s);}}}}if(this._fireSceneUpdated){this._fireSceneUpdated();}return this;};S.prototype._setMeshNode=function(n,m){f.pushElementIntoMapArray(this._meshNodes,m,n);var s=this._meshSubmeshes.get(m);if(s){for(var i=0;i<s.length;i++){var e=s[i];var l=h(e.lods);if(l){var j=this._geometries.get(l.id);if(j){this._addGeometryToNode(n,j,e);}}}}};function k(s){var m=new Float32Array([1,0,0,1,0,0]);if(s.t){m[4]=s.t[0];m[5]=s.t[1];}if(s.r){var x=s.r[0],y=s.r[1],z=s.r[2],w=s.r[3];var e=x*y;var i=z*z;var j=w*z;m[0]=1-(y*y+i)*2;m[1]=(e+j)*2;m[2]=(e-j)*2;m[3]=1-(x*x+i)*2;}if(s.s){m[0]*=s.s[0];m[1]*=s.s[0];m[2]*=s.s[1];m[3]*=s.s[1];}return m;}function o(s){var e=[];var m;function j(){if(e.length>0){e.forEach(function(t){var r=t.points;if(r&&r.length>=4&&r[0]===r[r.length-2]&&r[1]===r[r.length-1]){t.closed=true;r.length-=2;}});s.push({type:"path",segments:e,materialID:m});e=[];}}var l;var i=0;while(i<s.length){var n=s[i];if(n.type==="line"){if(m!==n.materialID){j();m=n.materialID;}l=k(n);var x=n.x1*l[0]+n.y1*l[2]+l[4];var y=n.x1*l[1]+n.y1*l[3]+l[5];var p=n.x2*l[0]+n.y2*l[2]+l[4];var q=n.x2*l[1]+n.y2*l[3]+l[5];var r=e.length>0?e[e.length-1].points:null;if(r&&r[r.length-2]===x&&r[r.length-1]===y){r.push(p,q);}else{e.push({type:"polyline",points:[x,y,p,q]});}s.shift();}else{i++;}}j();}S.prototype.setParametricContent=function(n,p,s){if(p==null){L.warning("Empty parametric content for node "+n);return;}this._resetCurrentScene(s);var e=this._nodes.get(n);e.uid+="-p";var j=p.shapes;if(j){o(j);for(var i=0;i<j.length;i++){var l=this._createObject(j[i]);if(l){e.add(l);}}}else{var m=this._createObject(p);if(m){e.add(m);}}e.rerender();};S.prototype._createObject=function(p){p.matrix=k(p);p.subelement=true;p.material=this._getMaterial(p.materialID);if(this._lineStyles&&p.stroke_id!==undefined){p.lineStyle=this._lineStyles.get(p.stroke_id);}if(this._fillStyles&&p.fill_id!==undefined){p.fillStyle=this._fillStyles.get(p.fill_id);}if(this._textStyles&&p.style_id!==undefined){p.style=this._textStyles.get(p.style_id);}var s;switch(p.type){case"arc":case"ellipticalArc":p.segments=[{type:"arc",cx:p.cx||0,cy:p.cy||0,rx:p.major||p.radius,ry:p.minor||p.radius,start:p.start>p.end?p.start-Math.PI*2:p.start,end:p.end}];s=new c(p);break;case"rectangle":s=new R(p);break;case"line":s=new b(p);break;case"polyline":s=new P(p);break;case"ellipse":case"circle":s=new a(p);break;case"text":if(this._rootNode.matrix[3]<0){p.matrix[2]*=-1;p.matrix[3]*=-1;}s=new T(p);break;case"path":s=new c(p);break;default:L.warning("Unsupported parametric type",p.type);s=null;break;}if(s){s.userData.po=p;s.uid+="-s";if(p.materialID){f.pushElementIntoMapArray(this._materialNodesMap,p.materialID,s);}}return s;};S.prototype.removeNode=function(n){this._nodes.delete(n.sid);};S.prototype.createMaterial=function(m){var e=m.id;var i=this._getMaterial(e);i.lineColor=m.lineColour;i.lineWidth=m.lineWidth||1;i.lineStyle={width:m.lineWidth||1,haloWidth:m.lineHaloWidth||0,endCapStyle:m.lineEndRound?1:0,dashPattern:m.lineDashPattern||[],dashPatternScale:m.lineDashPatternScale,widthCoordinateSpace:m.lineWidthCoordinateSpace};if(m.emissiveColour){i.color=m.emissiveColour;}if(m.opacity!==undefined){i.opacity=m.opacity;}var n=this._materialNodesMap.get(e);if(n){for(var j=0;j<n.length;j++){n[j].setMaterial(i,true);}}return[];};S.prototype._getMaterial=function(m){return this._materialMap.get(m)||this._createTemporaryMaterial(m);};S.prototype._createTemporaryMaterial=function(m){var e={materialId:m,lineColor:[0,0,0,1],lineWidth:1};this._materialMap.set(m,e);return e;};S.prototype.checkMaterialExists=function(m,t){if(!this._materialMap.get(m)){if(t){this._createTemporaryMaterial(m);}return false;}return true;};S.prototype.updateViewsForReplacedNodes=function(n){};S.prototype.insertFillStyle=function(e){this._fillStyles.set(e.veid,e);};S.prototype.insertLineStyle=function(l){this._lineStyles.set(l.veid,l);};S.prototype.insertTextStyle=function(t){this._textStyles.set(t.veid,t);};var u=function(i){var j="";try{var C=0x8000;var l=0;var m=i.length;var s;while(l<m){s=i.slice(l,Math.min(l+C,m));j+=String.fromCharCode.apply(null,s);l+=C;}}catch(e){j="";}return j;};S.prototype.createImage=function(i){if(i.binaryData.length<32){L.warning("SceneBuilder.createImage()","Can't create image from empty data");return this;}var e=new DataView(i.binaryData.buffer);var j=true;if(e.getUint8(0,true)===parseInt("0xFF",16)&&e.getUint8(1,true)===parseInt("0xD8",16)){j=false;}var l=u(i.binaryData);var m="data:image/"+(j?"png":"jpeg")+";base64,"+btoa(l);this._images.set(i.id,m);return this;};S.prototype.setViewThumbnail=function(i,v,s,t){this._resetCurrentScene(s);var e=this._views.get(v);var j=this._images.get(i);if(e&&j){if(e.userData!==undefined){if(e.userData.viewInfo.thumbnailId===i){e.thumbnailData=j;}}}return this;};return S;});
