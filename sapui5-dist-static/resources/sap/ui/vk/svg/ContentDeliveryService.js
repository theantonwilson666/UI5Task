/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObject","../totara/TotaraLoader","../svg/SceneBuilder","../getResourceBundle","../ObjectType"],function(L,M,T,S,g,O){"use strict";var C=M.extend("sap.ui.vk.svg.ContentDeliveryService",{metadata:{properties:{authorizationHandler:"any",maxActiveRequests:{type:"int",defaultValue:4},maxUrlLength:{type:"int",defaultValue:2048},meshesBatchSize:{type:"int",defaultValue:128},materialsBatchSize:{type:"int",defaultValue:128},geometriesBatchSize:{type:"int",defaultValue:128},geometriesMaxBatchDataSize:{type:"int",defaultValue:1048576},geomMeshesBatchSize:{type:"int",defaultValue:128},geomMeshesMaxBatchDataSize:{type:"int",defaultValue:1048576},annotationsBatchSize:{type:"int",defaultValue:128},tracksBatchSize:{type:"int",defaultValue:128},sequencesBatchSize:{type:"int",defaultValue:128},voxelThreshold:{type:"number",defaultValue:0.0},skipLowLODRendering:{type:"boolean",defaultValue:false}},events:{cameraChanged:{parameters:{sceneId:{type:"string"},camera:{type:"any"}},enableEventBubbling:true},sceneUpdated:{parameters:{},enableEventBubbling:true},viewGroupUpdated:{parameters:{currentViewGroupId:"string"},enableEventBubbling:true},sceneCompleted:{parameters:{sceneId:{type:"string"}},enableEventBubbling:true},loadingFinished:{parameters:{currentViewId:"string",currentViewGroupId:"string"},enableEventBubbling:true},contentChangesProgress:{parameters:{percent:"float"}},errorReported:{parameters:{error:{type:"any"}}},initialViewCompleted:{parameters:{sceneId:{type:"string"}},enableEventBubbling:true}}},constructor:function(i,s){this._loader=new T();this._loader.setSceneBuilder(new S());M.apply(this,arguments);this._transientSceneMap=new Map();this._currentNodeHierarchy=null;}});C.prototype.getMaxActiveRequests=function(){return this._loader.getMaxActiveRequests();};C.prototype.setMaxActiveRequests=function(m){this._loader.setMaxActiveRequests(m);return this;};C.prototype.getMaxUrlLength=function(){return this._loader.getMaxUrlLength();};C.prototype.setMaxUrlLength=function(m){this._loader.setMaxUrlLength(m);return this;};C.prototype.getMeshesBatchSize=function(){return this._loader.getMeshesBatchSize();};C.prototype.setMeshesBatchSize=function(m){this._loader.setMeshesBatchSize(m);return this;};C.prototype.getMaterialsBatchSize=function(){return this._loader.getMaterialsBatchSize();};C.prototype.setMaterialsBatchSize=function(m){this._loader.setMaterialsBatchSize(m);return this;};C.prototype.getGeometriesBatchSize=function(){return this._loader.getGeometriesBatchSize();};C.prototype.setGeometriesBatchSize=function(a){this._loader.setGeometriesBatchSize(a);return this;};C.prototype.getGeometriesMaxBatchDataSize=function(){return this._loader.getGeometriesMaxBatchDataSize();};C.prototype.setGeometriesMaxBatchDataSize=function(a){this._loader.setGeometriesMaxBatchDataSize(a);return this;};C.prototype.getGeomMeshesBatchSize=function(){return this._loader.getGeomMeshesBatchSize();};C.prototype.setGeomMeshesBatchSize=function(a){this._loader.setGeomMeshesBatchSize(a);return this;};C.prototype.getGeomMeshesMaxBatchDataSize=function(){return this._loader.getGeomMeshesMaxBatchDataSize();};C.prototype.setGeomMeshesMaxBatchDataSize=function(a){this._loader.setGeomMeshesMaxBatchDataSize(a);return this;};C.prototype.getAnnotationsBatchSize=function(){return this._loader.getAnnotationsBatchSize();};C.prototype.setAnnotationsBatchSize=function(a){this._loader.setAnnotationsBatchSize(a);return this;};C.prototype.getTracksBatchSize=function(){return this._loader.getTracksBatchSize();};C.prototype.setTracksBatchSize=function(t){this._loader.setTracksBatchSize(t);return this;};C.prototype.getSequencesBatchSize=function(){return this._loader.getSequencesBatchSize();};C.prototype.setSequencesBatchSize=function(s){this._loader.setSequencesBatchSize(s);return this;};C.prototype.getVoxelThreshold=function(){return this._loader.getVoxelThreshold();};C.prototype.setVoxelThreshold=function(v){this._loader.setVoxelThreshold(v);return this;};C.prototype.getSkipLowLODRendering=function(){return this._loader.getSkipLowLODRendering();};C.prototype.setSkipLowLODRendering=function(s){this._loader.setSkipLowLODRendering(s);return this;};function u(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&0x3|0x8);return v.toString(16).toLowerCase();});}C.prototype.initUrl=function(a,k,c){var t=this;function n(){t.fireSceneUpdated({});}function b(){var d;if(t._loader&&t._loader.currentSceneInfo){var e=t._loader.getContext(t._loader.currentSceneInfo.id);if(e){d=e.currentViewGroupId;}}t.fireViewGroupUpdated({currentViewGroupId:d});}if(!this._loader.running()||this._loader.getUrl()!==a){if(this._loader.running()){var s=this._loader.sceneBuilder;this._loader.dispose();this._loader=new T();this._loader.setSceneBuilder(s);}this._loader.onErrorCallbacks.attach(this._reportError.bind(t));this._loader.onMaterialFinishedCallbacks.attach(n);this._loader.onImageFinishedCallbacks.attach(n);this._loader.onSetGeometryCallbacks.attach(n);this._loader.onViewGroupUpdatedCallbacks.attach(b);this._loader.setUrl(a);this._loader.setCorrelationId(c?c:u());return this._loader.run();}else if(!k){this._loader.cleanup();}return Promise.resolve("Loader is ready");};C.prototype._reportError=function(e){this.fireErrorReported(e);};C.prototype._createLoadParam=function(r,a,p,c){var t=this;var i;var s=false;var b;if(this._currentNodeHierarchy){b=this._currentNodeHierarchy.getScene();}var d={root:p,includeHidden:c.getIncludeHidden(),includeAnimation:c.getIncludeAnimation(),pushPMI:c.getPushPMI(),includeBackground:c.getIncludeBackground(),includeParametric:c.getIncludeParametric(),metadataFilter:c.getMetadataFilter(),useSecureConnection:c.getUseSecureConnection(),activateView:c.getActivateView(),enableLogger:c.getEnableLogger()===true,pushViewGroups:c.getPushViewGroups(),vkScene:b,onActiveCamera:function(n){var f=false;var h=t._loader.getContext(c.getVeid());if(h&&h.phase<2){i=n;f=true;}if(!f){t.fireCameraChanged({sceneId:c.getVeid(),camera:n});}},onInitialSceneFinished:function(f){s=true;r({node:p,camera:i,contentResource:c,initialView:f,annotations:t.getSceneBuilder()._annotations,loader:t});},onSceneCompleted:function(){t.fireSceneCompleted({sceneId:c.getVeid()});},onLoadingFinished:function(){var f,h;if(t._loader&&t._loader.currentSceneInfo){var j=t._loader.getContext(t._loader.currentSceneInfo.id);if(j){f=j.currentViewId;h=j.currentViewGroupId;}}t.fireLoadingFinished({currentViewId:f,currentViewGroupId:h});},onContentChangesProgress:function(f){t.fireContentChangesProgress({source:f.source,phase:f.phase,percentage:f.percentage});},onInitialViewCompleted:function(){t.fireInitialViewCompleted({sceneId:c.getVeid()});}};var e=function(f){L.warning("Content loading error reported:",JSON.stringify(f.getParameters()));var h;if(f.getParameter("errorText")){h=f.getParameter("errorText");}else if(f.getParameter("error")){h=f.getParameter("error");}else if(f.getParameter("reason")){h=f.getParameter("reason");}else{h="failed to load: unknown reason";}if(s){var j=f.getParameter("error");if(j&&j===4){t.initUrl(this._loader.getUrl(),true);}}else{t.detachErrorReported(e);if(f.getParameter("events")){h=h+"\n"+JSON.stringify(f.getParameter("events"));}a(h);}};t.attachErrorReported(e);return d;};C.prototype.load=function(p,c,a){var t=this;var n=c.getNodeProxy();if(n){this._currentNodeHierarchy=n.getNodeHierarchy();}return new Promise(function(r,b){if(!c.getSource()||!c.getVeid()){b(g().getText("CONTENTDELIVERYSERVICE_MSG_NOURLORVEID"));return;}t.initUrl(c.getSource(),true);var d=t._createLoadParam(r,b,p,c);if(t._loader){t._loader.request(c.getVeid(),d,a);}});};C.prototype.getSceneBuilder=function(){if(this._loader){return this._loader.getSceneBuilder();}return null;};C.prototype.decrementResourceCountersForDeletedTreeNode=function(s){var c=this._loader.getContext(this._loader.currentSceneInfo.id);this._loader.decrementResourceCountersForDeletedTreeNode(c,s);};C.prototype.loadTransientScene=function(s,p,a){var t=this;return new Promise(function(r,b){if(!s||!p){b(g().getText("CONTENTDELIVERYSERVICE_MSG_INVALIDARGUMENTS"));return;}if(t._transientSceneMap.has(s)){var c=t._transientSceneMap.get(s).clone();p.add(c);r({nodeRef:c});return;}if(!t._loader){b(g().getText("CONTENTDELIVERYSERVICE_MSG_CONTENTDELIVERYSERVICENOTINITIALISED"));return;}var h=function(){t.detachLoadingFinished(h);if(t._transientSceneMap.get(s)){var c=t._transientSceneMap.get(s).clone();p.add(c);r({nodeRef:c});}};if(t._loader.contextMap.has(s)){t.attachLoadingFinished(h);return;}var d={};d.name="transient";d.userData.currentSceneId=t.getSceneBuilder()._currentSceneId;var o=function(){var f=t._loader.getContext(s);f.onSceneCompletedCallbacks.detach(o);d.userData.entityId=f.defaultRootEntityId;t._transientSceneMap.set(s,d);var c=d.clone();p.add(c);r({nodeRef:c});};var e={root:d,onSceneCompleted:o,useSecureConnection:a};t._loader.request(s,e);});};C.prototype.update=function(s,a,v){var t=this;return new Promise(function(r,b){if(!t._loader){b(g().getText("CONTENTDELIVERYSERVICE_MSG_CONTENTDELIVERYSERVICENOTINITIALISED"));return;}t._loader.update(s,a,v).then(function(c){if(t._currentNodeHierarchy){for(var i=0;i<c.replacedNodeRefs.length;i++){t._currentNodeHierarchy.fireNodeReplaced({ReplacedNodeRef:c.replacedNodeRefs[i],ReplacementNodeRef:c.replacementNodeRefs[i],ReplacedNodeId:c.replacedNodeRefs[i],ReplacementNodeId:c.replacementNodeRefs[i]});}}r({sceneVeId:c.sceneVeId,sids:c.sidArray});}).catch(function(e){return b(e);});});};C.prototype.exit=function(){if(this._loader){this._loader.dispose();this._loader=null;}this._transientSceneMap=null;};C.prototype.loadView=function(s,v,t,a){if(typeof t==="undefined"){t="static";}var b=this;return this._loader.requestView(s,t,v,null,a).then(function(c){if(b._currentNodeHierarchy&&c.updatedNodes){for(var i=0;i<c.updatedNodes.length;i++){b._currentNodeHierarchy.fireNodeUpdated({nodeRef:c.updatedNodes[i]});}}b.fireSceneUpdated({});return c;}).catch(function(e){L.error(e);return null;});};C.prototype.updatePlaybacks=function(s,v,p){var t=this;return this._loader.requestView(s,"static",v,p,true).then(function(a){if(t._currentNodeHierarchy&&a.updatedNodes){for(var i=0;i<a.updatedNodes.length;i++){t._currentNodeHierarchy.fireNodeUpdated({nodeRef:a.updatedNodes[i]});}}t.fireSceneUpdated({});return a;}).catch(function(e){L.error(e);return null;});};C.prototype.loadViewGroup=function(s,v,i){var t=this;return this._loader.requestViewGroup(s,v,i).then(function(a){t.fireSceneUpdated({});return a;}).catch(function(e){L.error(e);return null;});};C.prototype.assignMaterialToNodes=function(s,m,n,a){return(Promise.resolve());};C.prototype.printLogTokens=function(){if(this._loader){this._loader.printLogTokens();return true;}else{return false;}};return C;});
