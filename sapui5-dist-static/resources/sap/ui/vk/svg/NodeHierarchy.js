/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../NodeHierarchy","sap/ui/base/ObjectPool","./Element","./BaseNodeProxy","./NodeProxy","../Messages","../getResourceBundle","../NodeContentType","sap/base/util/uid","sap/base/assert","sap/base/Log"],function(N,O,E,B,a,M,g,b,u,c,L){"use strict";var s={equals:function(e,f){return e===f;},contains:function(e,f){return e.indexOf(f)!==-1;},startsWith:function(e,f){return e.indexOf(f)===0;}};var d=N.extend("sap.ui.vk.svg.NodeHierarchy",{metadata:{},_baseNodeProxyPool:new O(B),constructor:function(e){N.call(this);this._scene=e;this._nodeProxies=[];}});d.prototype.destroy=function(){this._nodeProxies.slice().forEach(this.destroyNodeProxy,this);this._scene=null;N.prototype.destroy.call(this);};d.prototype.getScene=function(){return this._scene;};d.prototype.getSceneRef=function(){return this._scene.getRootElement();};d.prototype.enumerateChildren=function(n,e,f,p){if(typeof n==="function"){p=f;f=e;e=n;n=undefined;}var h=this.getChildren(n,f);if(p){h.forEach(e);}else{var i=this._baseNodeProxyPool.borrowObject();try{h.forEach(function(n){i.init(this,n);e(i);i.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(i);}}return this;};d.prototype.enumerateAncestors=function(n,e,p){var f=this.getAncestors(n);if(p){f.forEach(e);}else{var h=this._baseNodeProxyPool.borrowObject();try{f.forEach(function(n){h.init(this,n);e(h);h.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(h);}}return this;};d.prototype.createNodeProxy=function(n){var e=new a(this,n);this._nodeProxies.push(e);return e;};d.prototype.destroyNodeProxy=function(n){var i=this._nodeProxies.indexOf(n);if(i>=0){this._nodeProxies.splice(i,1)[0].destroy();}return this;};d.prototype.getChildren=function(n,e){if(typeof n==="boolean"){e=n;n=undefined;}n=n||this._scene.getRootElement();return e||!n.closed?n.children:[];};d.prototype.getAncestors=function(n){var e=[];n.traverseAncestors(function(p){e.unshift(p);});if(e.length>0&&e[0]===this._scene.getRootElement()){e.shift();}return e;};d.prototype.findNodesByName=function(q){var r=[];if(q===undefined||q===null||q===""||jQuery.isEmptyObject(q)){this._scene.getRootElement().children.forEach(function(h){h.traverse(function(j){r.push(j);});});}else{var e=s[q.predicate||"equals"];if(e===undefined){L.error(g().getText(M.VIT8.summary),M.VIT8.code,"sap.ui.vk.svg.NodeHierarchy");}else if(!Array.isArray(q.value)&&typeof q.value!=="string"){L.error(g().getText(M.VIT6.summary),M.VIT6.code,"sap.ui.vk.svg.NodeHierarchy");}else{var f=Array.isArray(q.value)?q.value:[q.value];if(!q.caseSensitive){for(var i in f){f[i]=f[i].toLowerCase();}}this._scene.getRootElement().children.forEach(function(h){h.traverse(function(j){var n=j.name||"";if(!q.caseSensitive){n=n.toLowerCase();}for(var i in f){if(e(n,f[i])){r.push(j);break;}}});});}}return r;};d.prototype.createLayerProxy=function(l){return null;};d.prototype.destroyLayerProxy=function(l){return this;};d.prototype.getLayers=function(){return[];};d.prototype.getHotspotNodeIds=function(){var n=[];this._scene.getRootElement().traverse(function(e){if(e._vkGetNodeContentType()===b.Hotspot){n.push(e);}});return n;};d.prototype.attachChanged=function(e,f,l){return this.attachEvent("changed",e,f,l);};d.prototype.detachChanged=function(e,f,l){return this.detachEvent("changed",e,f,l);};d.prototype.fireChanged=function(p,e,f){return this.fireEvent("changed",p,e,f);};d.prototype.attachNodeCreated=function(e,f,l){return this.attachEvent("nodeCreated",e,f,l);};d.prototype.detachNodeCreated=function(e,f,l){return this.detachEvent("nodeCreated",e,f,l);};d.prototype.fireNodeCreated=function(p,e,f){return this.fireEvent("nodeCreated",p,e,f);};d.prototype.attachNodeRemoving=function(e,f,l){return this.attachEvent("nodeRemoving",e,f,l);};d.prototype.detachNodeRemoving=function(e,f,l){return this.detachEvent("nodeRemoving",e,f,l);};d.prototype.fireNodeRemoving=function(p,e,f){return this.fireEvent("nodeRemoving",p,e,f);};d.prototype.attachNodeReplaced=function(e,f,l){return this.attachEvent("nodeReplaced",e,f,l);};d.prototype.detachNodeReplaced=function(e,f,l){return this.detachEvent("nodeReplaced",e,f,l);};d.prototype.fireNodeReplaced=function(p,e,f){return this.fireEvent("nodeReplaced",p,e,f);};d.prototype.attachNodeUpdated=function(e,f,l){return this.attachEvent("nodeUpdated",e,f,l);};d.prototype.detachNodeUpdated=function(e,f,l){return this.detachEvent("nodeUpdated",e,f,l);};d.prototype.fireNodeUpdated=function(p,e,f){return this.fireEvent("nodeUpdated",p,e,f);};d.prototype.createNode=function(p,n,i,e,f){var h=this.getScene().getSceneBuilder();var j=null;if(h){f=f||{};f.name=f.name||n;f.sid=f.sid||u();j=h.createNode(f);if(!p){p=j.parent;}}else{if(!p){p=this._scene.getRootElement();}j=new E();j.name=n;p.add(j);}var k=p.children.indexOf(i);c(p.children[p.children.length-1]===j,g().getText("NODEHIERARCHY_MSG_CREATENODEFAILED"));if(k>=0){p.children.splice(k,0,p.children.pop());}if(e){j._vkSetNodeContentType(e);}else{j._vkSetNodeContentType(b.Regular);}if(f&&h){switch(j._vkGetNodeContentType()){case b.Annotation:f.node=j;f.nodeId=j._vkPersistentId();h.createAnnotation(f);break;default:}}this.fireNodeCreated({nodeRef:j,nodeId:j});this.fireChanged();return j;};d.prototype.getNodeContentType=function(n){if(n==null){return b.Regular;}var e=null;if(!e){e=b.Regular;}return e;};d.prototype.createNodeCopy=function(n,p,e,i){if(!p){p=this._scene.getRootElement();}var f=p.children.indexOf(i);var h=n.clone(true);h.name=e;p.add(h);c(p.children[p.children.length-1]===h,g().getText("NODEHIERARCHY_MSG_CREATENODEFAILED"));if(f>=0){p.children.splice(f,0,p.children.pop());}this.fireNodeCreated({nodeRef:h,nodeId:h});this.fireChanged();return h;};d.prototype.removeNode=function(n){var e=[].concat(n);e.forEach(function(n){if(n&&n.parent){this.fireNodeRemoving({nodeRef:n,nodeId:n});n.parent.remove(n);}}.bind(this));var f=this.getScene().getSceneBuilder();if(f){f.removeNode(n);}this.fireChanged();return this;};return d;});
