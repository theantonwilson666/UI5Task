/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/ManagedObjectObserver","sap/ui/core/Element","./Messages","./getResourceBundle","./ContentResource","./Core","sap/base/Log"],function(M,E,a,g,C,v,L){"use strict";var b=E.prototype;var c=E.extend("sap.ui.vk.ContentConnector",{metadata:{library:"sap.ui.vk",aggregations:{contentResources:{type:"sap.ui.vk.ContentResource",bindable:"bindable"},viewStateManagers:{type:"sap.ui.vk.ViewStateManager"},contentManagers:{type:"sap.ui.vk.ContentManager",visibility:"hidden"}},defaultAggregation:"contentResources",events:{contentChangesStarted:{parameters:{}},contentChangesFinished:{parameters:{content:{type:"any"},failureReason:{type:"any"}}},contentChangesProgress:{parameters:{phase:{type:"string"},percentage:{type:"float"},source:{type:"any"}}},contentLoadingFinished:{parameters:{source:{type:"any"},node:{type:"any"}}},contentReplaced:{parameters:{newContent:{type:"any"},oldContent:{type:"any"}}},contentDestroying:{parameters:{content:{type:"any"},preventGarbageCollection:{type:"function"}}}}},constructor:function(i,s){this._inLoading=false;this._delayContentResourcesUpdate=false;this._scheduleContentResourcesUpdateTimerId=null;this._content=null;this._contentManager=null;this._decryptionHandler=null;this._authorizationHandler=null;b.constructor.apply(this,arguments);v.observeLifetime(this);}});c.prototype.isTreeBinding=function(n){return n==="contentResources";};c.prototype.init=function(){if(b.init){b.init.call(this);}this._selfObserver=new M(this._observeChanges.bind(this));this._selfObserver.observe(this,{aggregations:["contentResources","viewStateManagers"]});};c.prototype.destroy=function(){c._cleanAssociatedLoaders();this._selfObserver.disconnect();this._selfObserver=null;if(this._scheduleContentResourcesUpdateTimerId){clearTimeout(this._scheduleContentResourcesUpdateTimerId);this._scheduleContentResourcesUpdateTimerId=null;}this._delayContentResourcesUpdate=false;this._setContent(null,null);b.destroy.call(this);};c.prototype._observeChanges=function(e){if(e.name==="contentResources"){if(e.mutation==="remove"){this._setContent(null,null);}else{this._scheduleContentResourcesUpdate();}}else if(e.name==="viewStateManagers"){if(e.mutation==="insert"){e.child.setContentConnector(this);}else if(e.mutation==="remove"){e.child.setContentConnector(null);}}};c.prototype.invalidate=function(o){if(o instanceof C){this._scheduleContentResourcesUpdate();return;}b.invalidate.apply(this,arguments);};c.prototype._scheduleContentResourcesUpdate=function(){if(this._inLoading){this._delayContentResourcesUpdate=true;return this;}if(!this._scheduleContentResourcesUpdateTimerId){this._scheduleContentResourcesUpdateTimerId=setTimeout(function(){this._scheduleContentResourcesUpdateTimerId=null;var e=this.getContentResources();if(e.length>0){this._collectContentResourceSourceTypeInformation(e).then(function(i){if(i.dimensions.length>1){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:g().getText(a.VIT17.cause)}});L.error(g().getText(a.VIT17.summary),a.VIT17.code,"sap.ui.vk.ContentConnector");}.bind(this),0);}else if(i.contentManagerClassNames.length>1){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:g().getText(a.VIT35.cause)}});L.error(g().getText(a.VIT35.summary),a.VIT35.code,"sap.ui.vk.ContentConnector");}.bind(this),0);}else if(i.contentManagerClassNames.length===0){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:g().getText(a.VIT36.cause)}});L.error(g().getText(a.VIT36.summary),a.VIT36.code,"sap.ui.vk.ContentConnector");}.bind(this),0);}else if(i.contentManagerClassNames.length===1){var t=this;this._getContentManagerByClassName(i.contentManagerClassNames[0]).then(function(f){if(t._contentManager&&f!==t._contentManager){t.fireContentChangesStarted();t._setContent(null,null);t.fireContentChangesFinished({content:null});}f.loadContent(t._content,e);});}}.bind(this));}else{setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null});}.bind(this),0);}}.bind(this),0);}return this;};c.prototype._handleContentChangesStarted=function(e){this._inLoading=true;this.fireContentChangesStarted();};c.prototype._handleContentChangesFinished=function(e){var f=e.getParameter("content");this._setContent(f,e.getSource());this.fireContentChangesFinished({content:f,failureReason:e.getParameter("failureReason")});this._inLoading=false;if(this._delayContentResourcesUpdate){this._delayContentResourcesUpdate=false;this._scheduleContentResourcesUpdate();}};c.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")});};c.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")});};c.prototype._getContentManagerByClassName=function(e){var f,h=this.getAggregation("contentManagers",[]);for(var i=0,j=h.length;i<j;++i){f=h[i];if(f.getMetadata().getName()===e){return Promise.resolve(f);}}var t=this;return new Promise(function(k,l){sap.ui.require([e.replace(/\./g,"/")],function(m){var f=new m();t.addAggregation("contentManagers",f);f.attachContentChangesStarted(t._handleContentChangesStarted,t);f.attachContentChangesFinished(t._handleContentChangesFinished,t);f.attachContentChangesProgress(t._handleContentChangesProgress,t);f.attachContentLoadingFinished(t._handleContentLoadingFinished,t);t._assignDecryptionHandler([f]);t._assignAuthorizationHandler([f]);k(f);});});};c.prototype.getContent=function(){return this._content;};c.prototype.getContentManager=function(){return this._contentManager;};c.prototype._assignDecryptionHandler=function(e){for(var i=0;i<e.length;i++){e[i].setDecryptionHandler(this._decryptionHandler);}};c.prototype._assignAuthorizationHandler=function(e){for(var i=0;i<e.length;i++){e[i].setAuthorizationHandler(this._authorizationHandler);}};c.prototype.setDecryptionHandler=function(h){this._decryptionHandler=h;this._assignDecryptionHandler(this.getAggregation("contentManagers",[]));return this;};c.prototype.setAuthorizationHandler=function(h){this._authorizationHandler=h;this._assignAuthorizationHandler(this.getAggregation("contentManagers",[]));return this;};c.prototype._setContent=function(n,e){var o=this._content,f=this._contentManager;if(o!==n){this._content=n;this._contentManager=e;this.fireContentReplaced({oldContent:o,newContent:n});if(o){var p=false;this.fireContentDestroying({content:o,preventGarbageCollection:function(h){p=h;}});f.destroyContent(o);if(!p){f.collectGarbage();}}}return this;};var r=[{pattern:/(^threejs[:.])|(^(threejs|stream|vds4)$)/,dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager"},{pattern:/^vdsl?$/,dimension:3,contentManagerClassName:"sap.ui.vk.dvl.ContentManager"},{pattern:/^(png|jpg|jpeg|gif|bmp|tiff?|svg)$/,dimension:2,contentManagerClassName:"sap.ui.vk.ImageContentManager"},{pattern:/^(stream2d|vds4-2d)$/,dimension:2,contentManagerClassName:"sap.ui.vk.svg.ContentManager"}];var d=function(e){return new Promise(function(f,h){var i=r.slice();var t=function(j){if(j>=i.length){h();return;}var k=i[j];(function(){var s=e.getSourceType();if(s){s=s.toLowerCase();}if(typeof k==="function"){return k(e);}else if(typeof k.pattern==="string"){var p=k.pattern.toLowerCase();if(p===s){return Promise.resolve(k);}}else if(k.pattern instanceof RegExp){if(k.pattern.test(s)){return Promise.resolve(k);}}return Promise.reject();})().then(function(l){f({dimension:l.dimension,contentManagerClassName:l.contentManagerClassName,settings:l.settings});},function(){t(j+1);});};t(0);});};c.addContentManagerResolver=function(e){if(typeof e==="function"){r.unshift(e);}else{r.unshift({pattern:e.pattern,dimension:e.dimension,contentManagerClassName:e.contentManagerClassName,settings:e.settings});}return this;};c.removeAllContentManagerResolvers=function(){r=[];return this;};c.removeContentManagerResolver=function(e){var f=typeof e==="function",h=typeof e==="string",j=typeof e==="object",k=e instanceof RegExp;for(var i=0,l=r.length;i<l;++i){if(f||h){if(r[i]===e){r.splice(i,1);return true;}}else if(k){if(typeof r[i]==="object"&&r[i].pattern instanceof RegExp&&r[i].pattern.source===e.source){r.splice(i,1);return true;}}else if(j){if(typeof r[i]==="object"&&e.pattern&&r[i].pattern===e.pattern){r.splice(i,1);return true;}}}return false;};c._cleanAssociatedLoaders=function(){for(var i=0,e=r.length;i<e;++i){var f=r[i];if(f.settings&&f.settings.loader&&f.settings.loader.exit){f.settings.loader.exit();}}};c.prototype._collectContentResourceSourceTypeInformation=function(e){var n=false,u=false,f={},h={},j=[];e.forEach(function k(i){j.push(i);i.getContentResources().forEach(k);});return Promise.all(j.map(function(i){return d(i).then(function(k){f[k.dimension]=true;h[k.contentManagerClassName]=true;return k;},function(){if(i.getSourceType()){u=true;}else{n=true;}return false;});})).then(function(k){for(var i=0,l=j.length;i<l;++i){if(k[i]){j[i]._contentManagerResolver=k[i];}}return{noSourceTypes:n,unknownSourceTypes:u,dimensions:Object.getOwnPropertyNames(f).sort(),contentManagerClassNames:Object.getOwnPropertyNames(h)};});};return c;});
