/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/Object","./AnimationTrackType","./findIndexInArray","./AnimationPlayer","./AnimationTrack","./Core"],function(B,A,f,a,b,v){"use strict";var c=B.extend("sap.ui.vk.AnimationSequence",{constructor:function(i,p){this._jsonData={};this._jsonData.id=i;this._jsonData.name=p&&p.name?p.name:"";this._jsonData.duration=p&&p.duration?p.duration:1.0;this._jsonData.joints=[];this._jsonData.nodes=[];this._trackMap=new Map();}});c.prototype.setJSONModel=function(m){this._model=m;return this;};c.prototype.getId=function(){return this._jsonData.id;};c.prototype.getName=function(){return this._jsonData.name;};c.prototype.setName=function(n){this._jsonData.name=n;if(this._model){this._model.updateBindings();}return this;};c.prototype.getDuration=function(){return this._jsonData.duration;};c.prototype.setDuration=function(d,e){this._jsonData.duration=d;if(this._model){this._model.updateBindings();}if(!e){this._fireSequenceChanged();}return this;};c.prototype._findJointIndex=function(p,n){var j=this._jsonData.joints.filter(function(d){return d.node&&d.parent;});return f(j,function(d){return(p?d.parent==p:true)&&(n?d.node==n:true);});};c.prototype.setJoint=function(j,d){if(!Array.isArray(j)){j=[j];}j.forEach(function(e){var i=this._findJointIndex(e.parent,e.node);if(i<0){if(!e.parentSid&&e.parent&&e.parent.userData&&e.parent.userData.treeNode){e.parentSid=e.parent.userData.treeNode.sid;}if(!e.nodeSid&&e.node&&e.node.userData&&e.node.userData.treeNode){e.nodeSid=e.node.userData.treeNode.sid;}e.type="RELATIVE";this._jsonData.joints.push(e);}},this);if(this._model){this._model.updateBindings();}if(!d){this._fireSequenceChanged();}return this;};c.prototype.getJoint=function(j){var r;if(!j||(!j.parent&&!j.node)){r=this._jsonData.joints;}else if(j&&j.node){r=this._jsonData.joints.filter(function(i){return i.node==j.node&&(j.parent?i.parent==j.parent:true);});}else if(j&&j.parent&&!j.node){r=this._jsonData.joints.filter(function(i){return i.parent==j.parent;});}return r;};c.prototype.removeJoint=function(j){var n=[];if(!j){this._jsonData.joints.forEach(function(d){n.push(d.node);});this._jsonData.joints.splice(0);}else if(j&&(j.node||j.parent)){var i;do{i=this._findJointIndex(j.parent,j.node);if(i>=0){n.push(this._jsonData.joints[i].node);this._jsonData.joints.splice(i,1);}}while(i>=0);}if(this._model){this._model.updateBindings();}if(n.length){v.getEventBus().publish("sap.ui.vk","nodeAnimationRemoved",{nodeRefs:n,sequenceId:this._jsonData.id});}return this;};c.prototype._findNodeIndex=function(n){return f(this._jsonData.nodes,function(d){return(d?d.nodeRef==n:true);});};c.prototype.getNodeAnimation=function(n,p){var d=function(n,p){var i=this._findNodeIndex(n);var e,r;if(i!==-1){e=this._jsonData.nodes[i];}if(e){if(p){if(e[p]){r=this._trackMap.get(e[p]);}}else{r={nodeRef:n};for(var t in A){var g=A[t];if(e[g]){r[g]=this._trackMap.get(e[g]);}}}}return r;}.bind(this);var r;if(n&&!Array.isArray(n)){return d(n,p);}else if(!n){r=[];this._jsonData.nodes.forEach(function(e){r.push(d(e.nodeRef,p));},this);}else{r=[];n.forEach(function(e){r.push(d(e,p));},this);}return r;};c.prototype.setNodeAnimation=function(n,p,t,d){var i=this._findNodeIndex(n);var e;if(i!==-1){e=this._jsonData.nodes[i];}if(!e){e={};e.nodeRef=n;if(n.userData&&n.userData.treeNode){e.sid=n.userData.treeNode.sid;}this._jsonData.nodes.push(e);}e[p]=t.getJSONData();this._trackMap.set(t.getJSONData(),t);t.setJSONModel(this._model);if(this._model){this._model.updateBindings();}if(!d){this._fireSequenceChanged();}return this;};c.prototype.removeNodeAnimation=function(n,d,e){var i=this._findNodeIndex(n);if(i===-1){return this;}var g=this._jsonData.nodes[i];var t;if(!d){for(var p in g){t=this._trackMap.get(g[p]);if(t){t.setJSONModel(null);this._trackMap.delete(g[p]);}}this._jsonData.nodes.splice(i,1);}else{t=this._trackMap.get(g[d]);if(t){t.setJSONModel(null);this._trackMap.delete(g[d]);delete g[d];}}if(this._model){this._model.updateBindings();}if(!e){v.getEventBus().publish("sap.ui.vk","nodeAnimationRemoved",{nodeRefs:[n],property:d,sequenceId:this._jsonData.id});}return this;};c.prototype.resetDuration=function(d){var m=0;this._jsonData.nodes.forEach(function(n){var t;for(var e in n){if(e==="sid"){continue;}var g=this._trackMap.get(n[e]);if(g){if(g.getKeysCount()){var k=g.getKey(g.getKeysCount()-1);t=k.time;}if(t&&t>m){m=t;}}}},this);if(m>0.0){this._jsonData.duration=m;if(this._model){this._model.updateBindings();}}if(!d){this._fireSequenceChanged();}return this;};c.prototype.getNodesBoundaryValues=function(i){var r=new Map();var s=function(n,p,d){var e=r.get(n);if(!e){e={};r.set(n,e);}e[p]=d;};this._jsonData.nodes.forEach(function(n){for(var t in n){if(t==="sid"){continue;}var d=this._trackMap.get(n[t]);if(d&&d.getKeysCount()){var e=a.getBoundaryKey(d,i);s(n.nodeRef,t,e.value);}}}.bind(this));return r;};c.prototype._fireSequenceChanged=function(){v.getEventBus().publish("sap.ui.vk","sequenceChanged",{sequenceId:this._jsonData.id});};c.prototype._isNodePropertyDefined=function(n,p){var t=this.getNodeAnimation(n,p);if(t&&t.getKeysCount()){return true;}var j={node:n};var d=this.getJoint(j);if(d&&d.length){return true;}return false;};c.prototype._getCurrentNodesProperties=function(d,n){this._jsonData.nodes.forEach(function(e){var g={};var t=d.getRelativeTransformation(e.nodeRef);for(var p in e){if(p===A.Rotate){g[A.Rotate]=t.quaternion.slice();}else if(p===A.Translate){g[A.Translate]=t.translation.slice();}else if(p===A.Scale){g[A.Scale]=t.scale.slice();}else if(p===A.Opacity){var o=d.getOpacity(e.nodeRef);var r=d.getRestOpacity(e.nodeRef);if(o!==null&&o!==undefined){if(!r){r=1;}g[A.Opacity]=o/r;}}}n.set(e.nodeRef,g);});this._jsonData.joints.forEach(function(j){if(!j.node||!j.parent){return;}var e={};var t=d.getRelativeTransformation(j.node);e[A.Rotate]=t.quaternion.slice();e[A.Translate]=t.translation.slice();e[A.Scale]=t.scale.slice();var o=d.getOpacity(j.node);var r=d.getRestOpacity(j.node);if(o!==null&&o!==undefined){if(!r){r=1;}e[A.Opacity]=o/r;}n.set(j.node,e);});};c.prototype.getJSONData=function(){return this._jsonData;};return c;});
