/*
 * ! SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.getCore().loadLibrary("sap.m");sap.ui.getCore().loadLibrary("sap.ui.comp");sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/ManagedObject","sap/m/MessageBox","sap/ui/layout/form/SimpleForm","sap/ui/comp/smartfield/SmartField","sap/ui/comp/smartfield/SmartLabel","sap/m/Dialog","sap/ui/generic/app/util/ModelUtil","sap/m/VBox","sap/m/Text","sap/base/strings/formatMessage","sap/base/Log"],function(q,M,a,S,b,c,D,d,V,T,f,L){"use strict";var A=M.extend("sap.ui.generic.app.util.ActionUtil",{metadata:{properties:{controller:{type:"object",group:"Misc",defaultValue:null},applicationController:{type:"object",group:"Misc",defaultValue:null},contexts:{type:"object",group:"Misc",defaultValue:null},successCallback:{type:"function",group:"Misc",defaultValue:null},operationGrouping:{type:"string",group:"Misc",defaultValue:null}}}});A.prototype.call=function(F,s,i,o,I,m){var t=this;return new Promise(function(r,e){var g;t._oActionPromiseCallback={resolve:r,reject:e};t._sFunctionImportPath=F;var C=t.getController();if(!C||!C.getView()){e("No View Controller provided");}t._oMetaModel=C.getView().getModel().getMetaModel();var h=F.split('/')[1];t._oFunctionImport=t._oMetaModel.getODataFunctionImport(h);t._sFunctionImportLabel=s||h;t._oSkipProperties=o||{};var p=function(){var l=t.getContexts();g=t._prepareParameters(l,i,m);g=g||[{}];t._initiateCall(g,i,I);};if(!t._oFunctionImport){e("Unknown Function Import "+h);}if(t._isActionCritical()){var j="ACTION_CONFIRM|"+h;var k;var R=C.getOwnerComponent().getAppComponent&&C.getOwnerComponent().getAppComponent().getModel("i18n")&&C.getOwnerComponent().getAppComponent().getModel("i18n").getResourceBundle();if(R&&R.hasText(j)){k=R.getText(j);}else{k=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app").getText("ACTION_CONFIRM");k=f(k,t._sFunctionImportLabel);}a.confirm(k,{title:t._sFunctionImportLabel,onClose:function(l){if(l==="OK"){p();}else if(l==="CANCEL"){t._oActionPromiseCallback.reject();}},sClass:t._getCompactModeStyleClass()});}else{p();}});};A.prototype._getCompactModeStyleClass=function(){if(this.getController().getView().$().closest(".sapUiSizeCompact").length){return"sapUiSizeCompact";}return"";};A.prototype._isActionCritical=function(){var C=this._oFunctionImport["com.sap.vocabularies.Common.v1.IsActionCritical"];if(!C){return false;}if(C.Bool===undefined){return true;}return this._toBoolean(C.Bool);};A.prototype._toBoolean=function(p){if(typeof p==="string"){var v=p.toLowerCase();return!(v=="false"||v==""||v==" ");}return!!p;};A.prototype._prepareParameters=function(C,I,m){if(!Array.isArray(C)&&!C.length){return undefined;}var e=[];C.forEach(function(s){var E=null;var o=s.getObject();if(s&&s.getPath()){var g=d.getEntitySetFromContext(s);var h=s.getModel().getMetaModel().getODataEntitySet(g,false);E=s.getModel().getMetaModel().getODataEntityType(h.entityType,false);}var k=this._getPropertyKeys(E);var p;var j={parameterData:{},additionalParameters:[],isDraftEnabled:I};if(this._oFunctionImport.parameter){for(var i=0;i<this._oFunctionImport.parameter.length;i++){var P=this._oFunctionImport.parameter[i];this._addParameterLabel(P,E);var l=P.name;var n=!!k[l];p=undefined;if(o&&o.hasOwnProperty(l)){p=o[l];}else if(n){L.error("Key parameter of action not found in current context: "+l);throw new Error("Key parameter of action not found in current context: "+l);}j.parameterData[l]=(m&&m[l])||p;var r=!!this._oSkipProperties[l];if(!r&&!n&&P.mode.toUpperCase()=="IN"){j.additionalParameters.push(P);}}e.push(j);}else{e.push(j);}}.bind(this));return e;};A.prototype._getPropertyKeys=function(e){var k={};if(e&&e.key&&e.key.propertyRef){for(var i=0;i<e.key.propertyRef.length;i++){var K=e.key.propertyRef[i].name;k[K]=true;}}return k;};A.prototype._setAdditionalParameters=function(e,k,p,g){e.filter(function(o){if(k===o.name){if(o.hasOwnProperty("com.sap.vocabularies.UI.v1.Hidden")){g.oModel.setProperty(k,p[k],g);}else{g.oModel.setProperty(k,undefined,g);}}});};A.prototype._initiateCall=function(m,I,e){var g=m[0];var h=e?"strict":"lenient";var H={Prefer:"handling="+h};var u;if(g!=undefined&&g.additionalParameters&&g.additionalParameters.length==0){this._call(g.parameterData,g.isDraftEnabled,H);}else if(g!=undefined&&g.additionalParameters&&g.additionalParameters.length>0){var t=this;var p={urlParameters:{},headers:H};var E=this.getContexts();var C=this.getApplicationController()._getChangeSetFunc(E,this.getOperationGrouping());var F=E.map(function(o,i){p.changeSetId=C(i);return this.getApplicationController().getNewActionContext(this._sFunctionImportPath,o,p);}.bind(this));var j=F.map(function(o){return o.context;});Promise.all(j).then(function(o){var k=o[0];var P=t._buildParametersForm(g,k);var _=g.additionalParameters.map(function(i){return i.name;});o.forEach(function(r,i){var s=m[i].parameterData;for(var K in s){if(o.length>1&&_.indexOf(K)>-1){t._setAdditionalParameters(m[i].additionalParameters,K,s,r);}else{r.oModel.setProperty(K,s[K],r);}}});var l=false;var n=new D({title:t._sFunctionImportLabel,content:[P.form],beginButton:new sap.m.Button({text:t._sFunctionImportLabel,type:'Emphasized',press:function(r){if(P.hasNoClientErrors()){if(P.getEmptyMandatoryFields().length==0){n.close();u={};t._oActionPromiseCallback.resolve({executionPromise:t.getApplicationController()._newPromiseAll(F.map(function(y){return y.result;})).then(function(y){t._bExecutedSuccessfully=t.getApplicationController()._checkAtLeastOneSuccess(E,y);y.forEach(function(z){z.userEnteredAdditionalParams=u;});if(t._bExecutedSuccessfully){return y;}else{return Promise.reject(y);}},function(y){t._bExecutedSuccessfully=false;y.forEach(function(z){z.userEnteredAdditionalParams=u;});throw y;})});l=true;var s=k.getObject();g.additionalParameters.forEach(function(y){var z=s[y.name];if(y.type=="Edm.Boolean"&&z==undefined){s[y.name]=false;z=false;}u[y.name]=z;o.forEach(function(B){B.oModel.setProperty(y.name,z,B);});});var v=t._sFunctionImportPath.split('/')[1];E.forEach(function(y,i){t.getApplicationController().submitActionContext(y,o[i],v);});}else{var w=new V();var R=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app").getText("ACTION_MISSING_MANDATORY");for(var i=0;i<P.getEmptyMandatoryFields().length;i++){var x=f(R,P.getEmptyMandatoryFields()[i].getTextLabel());w.addItem(new T({text:x}));}a.error(w,{sClass:t._getCompactModeStyleClass()});}}}}),endButton:new sap.m.Button({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app").getText("ACTION_CANCEL"),press:function(){F[0].abort();n.close();t._oActionPromiseCallback.reject();l=true;}}),afterClose:function(i){n.destroy();if(!l){t._oActionPromiseCallback.reject();}}}).addStyleClass("sapUiNoContentPadding");n.addStyleClass(t._getCompactModeStyleClass());n.setModel(k.oModel);if(this.getController().getView().getModel("@i18n")){n.setModel(this.getController().getView().getModel("@i18n"),"@i18n");}n.open();}.bind(this));}else{this._call(null,g!=undefined?g.isDraftEnabled:I,H);}};A.prototype._call=function(u,i,h){var C=this.getContexts();var p={urlParameters:u,operationGrouping:this.getOperationGrouping(),triggerChanges:i,headers:h};var o=this.getController();var e=this.getApplicationController()||o.getApplicationController();var t=this;t._oActionPromiseCallback.resolve({executionPromise:e.invokeActions(this._sFunctionImportPath,C,p).then(function(r){t._bExecutedSuccessfully=true;return r;},function(E){t._bExecutedSuccessfully=false;throw E;})});};A.prototype._getActionParameterData=function(p){var m=[];var r=p.getObject('/');var P={};for(var i=0;i<this._oFunctionImport.parameter.length;i++){var o=this._oFunctionImport.parameter[i];var s=o.name;if(r.hasOwnProperty(s)){var v=r[s];if(v===undefined){if(!this._toBoolean(o.nullable)){if(o.type==='Edm.Boolean'){P[s]=false;}else{m.push(o);}}}else{P[s]=v;}}else{throw new Error("Unknown parameter: "+s);}}return{preparedParameterData:P,missingMandatoryParameters:m};};A.prototype._buildParametersForm=function(p,C){var F=new S({editable:true});F.setBindingContext(C);var s;var e=[];var o;var v;for(var i=0;i<p.additionalParameters.length;i++){var P=p.additionalParameters[i];if(P["com.sap.vocabularies.UI.v1.Hidden"]&&!(P["com.sap.vocabularies.UI.v1.Hidden"].Bool=="false")){continue;}v=P["com.sap.vocabularies.Common.v1.ValueListWithFixedValues"]?"fixed-values":undefined;if(v==undefined){v=P["sap:value-list"]=="fixed-values"?"fixed-values":undefined;}s=new b("ActionUtil-"+this._sFunctionImportPath.replace("/","-")+"-"+P.name,{value:'{'+P.name+'}',textLabel:this._getParameterName(P),width:"100%"});s.data("configdata",{"configdata":{isInnerControl:false,path:P.name,entitySetObject:{},annotations:{valuelist:P["com.sap.vocabularies.Common.v1.ValueList"],valuelistType:v},modelObject:C.oModel,entityType:P.type,property:{property:P,typePath:P.name}}});if(P.nullable=="false"){s.setMandatory(true);}e.push(s);o=new c();o.setLabelFor(s);F.addContent(o);F.addContent(s);}var h=function(){var n=true;for(var i=0;i<e.length;i++){if(e[i].getValueState()!="None"){n=false;break;}}return n;};var g=function(){var m=q.grep(e,function(j){return(j.getMandatory()==true&&j.getValue()==""&&j.getDataType()!="Edm.Boolean");});return m;};return{form:F,hasNoClientErrors:h,getEmptyMandatoryFields:g};};A.prototype._getParameterName=function(p){return p["com.sap.vocabularies.Common.v1.Label"]?p["com.sap.vocabularies.Common.v1.Label"].String:p.name;};A.prototype._addParameterLabel=function(p,e){if(e&&p&&!p["com.sap.vocabularies.Common.v1.Label"]){var P=this._oMetaModel.getODataProperty(e,p.name,false);if(P&&P["com.sap.vocabularies.Common.v1.Label"]){p["com.sap.vocabularies.Common.v1.Label"]=P["com.sap.vocabularies.Common.v1.Label"];}}};A.prototype.getFunctionImportLabel=function(){return this._sFunctionImportLabel;};A.prototype.getExecutedSuccessfully=function(){return this._bExecutedSuccessfully;};return A;});
