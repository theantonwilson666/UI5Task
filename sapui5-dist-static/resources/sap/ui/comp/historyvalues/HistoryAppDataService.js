/*
 * ! SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","./Constants","./HistoryGlobalDataService"],function(B,c,H){"use strict";var D="en";var i;var a=B.extend("sap.ui.comp.historyvalues.HistoryAppDataService",{constructor:function(){B.apply(this,arguments);this._initialize();}});a.prototype._initialize=function(){this._initializeAppContainerId=this._initializeAppContainerId.bind(this);this._initializeAppData=this._initializeAppData.bind(this);this._sContainerId="";this._sItemId=c.getHistoryPrefix()+"appData";this._oPersonalizer=null;this._sAppId=g();this._oData={};this._oDataReadyPromise=this._getHistoryGlobalDataService().getApps().then(this._initializeAppContainerId).then(this._initializeAppData);};a.prototype._getHistoryGlobalDataService=function(){return H.getInstance();};a.prototype._initializeAppContainerId=function(A){this._sContainerId=A[this._sAppId];if(!this._sContainerId){this._createAndSaveContainerId(A);}return this._sContainerId;};a.prototype._initializeAppData=function(){return this._getPersonalizer().getPersData().then(function(d){this._oData=d||this._getDefaultData();return this._oData;}.bind(this));};a.prototype._getPersonalizer=function(){if(this._oPersonalizer){return this._oPersonalizer;}var p=sap.ushell.Container.getService("Personalization"),s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:false,validity:Infinity},P={container:this._sContainerId,item:this._sItemId};this._oPersonalizer=p.getPersonalizer(P,s);return this._oPersonalizer;};a.prototype._createAndSaveContainerId=function(A){this._sContainerId=this._createContainerId();A[this._sAppId]=this._sContainerId;this._getHistoryGlobalDataService().setApps(A);};a.prototype._createContainerId=function(){var u="xxxxxxxx.xxxx.4xxx.yxxx.xxxxxxxxxxxx".replace(/[xy]/g,function(p){var r=Math.random()*16|0;if(p==='y'){r=r&0x3|0x8;}return r.toString(16);});return c.getShortHistoryPrefix()+u;};a.prototype._getDefaultData=function(){return{};};a.prototype._isDataReady=function(){return this._oDataReadyPromise;};a.prototype._getHistoryEnabled=function(){return this._getHistoryGlobalDataService().getHistoryEnabled();};a.prototype.getFieldData=function(f){return this._isDataReady().then(this._getHistoryEnabled.bind(this)).then(function(e){if(!e){return[];}var d=[],l=this._getLanguage();if(this._isDefaultLanguage(l)){d=this._oData[f]||[];}else{var s=c.getHistoryPrefix()+l;if(!this._oData[s]){d=[];}else{d=this._oData[s][f]||[];}}return d.slice();}.bind(this));};a.prototype.setFieldData=function(f,d){return this._isDataReady().then(this._getHistoryEnabled.bind(this)).then(function(e){if(!e){return false;}var l=this._getLanguage();if(this._isDefaultLanguage(l)){this._oData[f]=d;}else{var s=c.getHistoryPrefix()+l;if(!this._oData[s]){this._oData[s]={};}this._oData[s][f]=d;}return this._getPersonalizer().setPersData(this._oData);}.bind(this));};a.prototype._getLanguage=function(){var l=sap.ui.getCore().getConfiguration().getLanguage()||D;var m=l.match(/[a-z]+/i);if(m[0]){l=m[0].toLowerCase();}return l;};a.prototype._isDefaultLanguage=function(l){return l===D;};a.prototype.destroy=function(){B.prototype.destroy.apply(this,arguments);this._sContainerId="";this._sItemId="";this._oPersonalizer=null;this._sAppId="";this._oData={};this._oDataReadyPromise=null;};function g(){var A=sap.ushell.Container.getService("AppLifeCycle"),C=A.getCurrentApplication(),o,m,M,I;if(C){o=C.componentInstance;}if(o){m=o.getMetadata();}if(m){M=m.getManifest();}if(M){I=M["sap.app"].id;}return c.getHistoryPrefix()+I;}return{getInstance:function(){var C=g();if(!i){i=new a();}if(i._sAppId!==C){i.destroy();i=new a();}return i;}};});
