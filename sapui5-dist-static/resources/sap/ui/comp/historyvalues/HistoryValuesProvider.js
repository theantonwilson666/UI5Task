/*
 * ! SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/EventProvider","sap/base/util/values","./Constants","./HistoryGlobalDataService","./HistoryAppDataService"],function(E,v,c,H,a){"use strict";var b=E.extend("sap.ui.comp.providers.HistoryValuesProvider",{metadata:{library:"sap.ui.comp",events:{fieldUpdated:{parameters:{fieldData:{type:"Array"}}}}},constructor:function(C,f){E.apply(this,arguments);this._initialize(C,f);}});b.prototype._initialize=function(C,f){this._oControl=C;this._sFieldName=f;};b.prototype._getHistoryGlobalDataService=function(){return H.getInstance();};b.prototype._getHistoryAppDataService=function(){return a.getInstance();};b.prototype.attachChangeListener=function(){if(this._oControl.isA("sap.m.MultiInput")){this._oControl.attachTokenUpdate(this._onMultiInputChange,this);return;}if(this._oControl.isA("sap.m.MultiComboBox")){this._oControl.attachSelectionChange(this._onMultiComboBoxChange,this);return;}if(this._oControl.isA("sap.m.Input")){this._oControl.attachChange(this._onInputChange,this);return;}if(this._oControl.isA("sap.m.ComboBox")){this._oControl.attachChange(this._onComboBoxChange,this);return;}};b.prototype._detachChangeListener=function(){if(this._oControl.isA("sap.m.MultiInput")){this._oControl.detachTokenUpdate(this._onMultiInputChange,this);return;}if(this._oControl.isA("sap.m.MultiComboBox")){this._oControl.detachSelectionChange(this._onMultiComboBoxChange,this);return;}if(this._oControl.isA("sap.m.Input")){this._oControl.detachChange(this._onInputChange,this);return;}if(this._oControl.isA("sap.m.ComboBox")){this._oControl.detachChange(this._onComboBoxChange,this);return;}};b.prototype._onMultiInputChange=function(e){var t=e.getParameter("type"),A=e.getParameter("addedTokens");if(t==="added"){var d=A.reduce(function(r,T){var D=T.data("row");if(D){D=Object.assign({},D);delete D.__metadata;delete D[c.getSuggestionsGroupPropertyName()];return r.concat(D);}return r;},[]);this.setFieldData(d);}};b.prototype._onMultiComboBoxChange=function(e){var s=e.getParameter("selected"),C=e.getParameter("changedItem");if(s&&C){var d=C.getBindingContext("list").getObject();this._processSingleValueControl(d);}};b.prototype._onInputChange=function(e){var V=e.getParameter("validated"),s=sap.ui.getCore().byId(e.getSource().getSelectedRow());if(V&&s){var d=s.getBindingContext("list").getObject();this._processSingleValueControl(d);}};b.prototype._onComboBoxChange=function(e){var V=e.getParameter("value"),n=e.getParameter("newValue"),s=e.getSource().getSelectedItem();if(V&&n&&s){var d=s.getBindingContext("list").getObject();this._processSingleValueControl(d);}};b.prototype._processSingleValueControl=function(d){if(d){d=Object.assign({},d);delete d.__metadata;delete d[c.getSuggestionsGroupPropertyName()];d=Object.keys(d).reduce(function(r,k){if(typeof d[k]==="object"&&Object.prototype.toString.call(d[k])==="[object Date]"){r[k]="/Date("+d[k].getTime()+")/";}else{r[k]=d[k];}return r;},{});this.setFieldData([d]);}};b.prototype._getDistinct=function(d){var u={},D=[];d.forEach(function(x){var k=v(x).join();if(!u[k]){D.push(x);u[k]=true;}},this);return D;};b.prototype.getFieldData=function(){return this._getHistoryAppDataService().getFieldData(this._sFieldName);};b.prototype.setFieldData=function(f){return this._getHistoryAppDataService().getFieldData(this._sFieldName).then(function(F){var m=c.getMaxHistoryItems(),d=this._getDistinct(f.concat(F));d=d.slice(0,m);this.fireEvent("fieldUpdated",{fieldData:d});return this._getHistoryAppDataService().setFieldData(this._sFieldName,d);}.bind(this));};b.prototype.getHistoryEnabled=function(){return this._getHistoryGlobalDataService().getHistoryEnabled();};b.prototype.destroy=function(){E.prototype.destroy.apply(this,arguments);if(this._oControl){this._detachChangeListener();this._oControl=null;}this._sFieldName="";this._oDataReadyPromise=null;};return b;});
