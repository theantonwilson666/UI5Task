/*
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/library","sap/ui/comp/library","sap/ui/model/BindingMode","sap/ui/comp/util/FormatUtil","sap/ui/comp/providers/ValueHelpProvider","sap/ui/comp/providers/ValueListProvider","sap/ui/comp/smartfield/BindingUtil","sap/ui/comp/odata/MetadataAnalyser","sap/m/HBox","sap/base/Log","sap/base/strings/capitalize"],function(B,c,l,a,F,V,b,d,M,H,L,e){"use strict";var C=l.smartfield.ControlContextType;var f=c.ValueState;var g=B.extend("sap.ui.comp.smartfield.ControlFactoryBase",{constructor:function(m,p){B.apply(this,arguments);this.sName="ControlFactoryBase";this._oModel=m;this._oParent=p;this._oBinding=new d();this._aProviders=[];this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");}});g.prototype.createControl=function(h){var m,o;m=this._getCreator(h);if(m){o=this[m]();this._addAriaLabelledBy(o);if(o&&o.onCreate){this[o.onCreate](o.control,o.params);}}return o;};g.prototype.updateControl=function(){var i,m,s=this._oParent,o=s.data("configdata");if(o&&o.configdata){m=s.getMode();i=s.getFirstInnerControl();if(o.configdata.onText&&(m==="display"||m==="display_uom")){o.configdata.onText(i);}else if(o.configdata.onInput&&m==="edit"){o.configdata.onInput(i);}}};g.prototype._addAriaLabelledBy=function(o){var t;if((this._oParent.getControlContext()===C.None)||(this._oParent.getControlContext()===C.Form)||(this._oParent.getControlContext()===C.SmartFormGrid)){if(o){t=o.control;if(t instanceof H){if(t.getItems().length>0){t=t.getItems()[0];}}}if(t&&t.addAriaLabelledBy&&this._oParent.getAriaLabelledBy().length>0){t.removeAllAriaLabelledBy();this._oParent.getAriaLabelledBy().forEach(function(A){t.addAriaLabelledBy(A);});}}};g.prototype.addValidations=function(o,m){var s,E,t=this;s=function(S,h){var i,j,k=h.getSource();if(k){if(k.setValueState){k.setValueState(S);}j=h.getParameter("exception");if(j){i=j.message;}if(!i){i=h.getParameter("message");}if(k.setValueStateText){k.setValueStateText(i);}}if(m){t._oParent[m](S===f.Error);}};E=function(h){s(f.Error,h);};o.attachFormatError(E);o.attachParseError(E);o.attachValidationError(E);o.attachValidationSuccess(function(h){t._oParent.onValidation(h);s(f.None,h);});};g.prototype._getDisplayBehaviourConfiguration=function(D){var s=null,i=this._oParent._getComputedTextInEditModeSource()==="ValueListNoValidation";var o=this._oParent.getConfiguration();if(o){s=o.getDisplayBehaviour();}if(!s&&this._oMetaData&&this._oMetaData.entityType){s=this._oHelper.oAnnotation.getTextArrangement(this._oMetaData.property.property,this._oMetaData.entityType,i);}if(!s){s=this._oParent.data(D?D:"defaultInputFieldDisplayBehaviour");}return s;};g.prototype._getPreventInitialDataFetchInVHDialog=function(E){var o=this._oParent.getConfiguration();if(o&&!o.isPropertyInitial("preventInitialDataFetchInValueHelpDialog")){return o.getPreventInitialDataFetchInValueHelpDialog();}if(M.isValueList(E)&&E["com.sap.vocabularies.Common.v1.ValueList"]&&E["com.sap.vocabularies.Common.v1.ValueList"].FetchValues){return E["com.sap.vocabularies.Common.v1.ValueList"].FetchValues.Int!=="1";}return false;};g.prototype._formatDisplayBehaviour=function(D,k,s){var h=this._getDisplayBehaviourConfiguration(D);if(D==="defaultCheckBoxDisplayBehaviour"){return this._getFormattedExpressionFromDisplayBehaviour(h,k);}if(D==="defaultComboBoxReadOnlyDisplayBehaviour"&&!h){h="descriptionAndId";}return F.getFormattedExpressionFromDisplayBehaviour(h||"idOnly",k,s);};g.prototype._getFormattedExpressionFromDisplayBehaviour=function(D,v){var k="";switch(D){case"OnOff":k=v?"SMARTFIELD_CB_ON":"SMARTFIELD_CB_OFF";break;case"TrueFalse":k=v?"SMARTFIELD_CB_TRUE":"SMARTFIELD_CB_FALSE";break;default:k=v?"SMARTFIELD_CB_YES":"SMARTFIELD_CB_NO";break;}return this._oRb.getText(k);};g.prototype.shouldCreateValueHelpForControl=function(o){if(!o){return false;}var p=this._oParent;return p&&((p.getMode()==="edit")||(o.getMetadata().getName()==="sap.ui.comp.smartfield.DisplayComboBox"));};g.prototype.getDropdownItemKeyType=function(){};g.prototype.getValueStateBindingInfoForRecommendationStateAnnotation=function(){};g.prototype.createValueHelp=function(s){var v,E=s.edmProperty,o=s.valueHelp;if(o.annotation&&(E["sap:value-list"]||E["com.sap.vocabularies.Common.v1.ValueList"])){var D=o.displayBehaviour||this._getDisplayBehaviourConfiguration("defaultDropDownDisplayBehaviour"),h=this._oParent.data("dateFormatSettings"),p=this._getPreventInitialDataFetchInVHDialog(E);if(typeof h==="string"){try{h=JSON.parse(h);}catch(i){}}var A,j;if(typeof o.annotation==="string"){j=o.annotation;}else if(o&&typeof o.annotation==="object"){A=o.analyser.getValueListAnnotationForFunctionImport({"":o.annotation},E.name).primaryValueListAnnotation;}var k=s.control,m=s.model,O=s.onValueListChange;if(!o.noDialog){if(k.setFilterSuggests){k.setFilterSuggests(false);}var n=new V({fieldName:E.name,control:k,model:m,dateFormatSettings:h,displayBehaviour:D,loadAnnotation:true,fullyQualifiedFieldName:j,metadataAnalyser:o.analyser,annotation:A,title:o.dialogtitle,preventInitialDataFetchInValueHelpDialog:p,supportMultiSelect:!!o.supportMultiSelect,supportRanges:!!o.supportRanges,takeOverInputValue:true,type:o.type,maxLength:E.maxLength});if(O){n.attachValueListChanged(O);}this._aProviders.push(n);if(k.setShowValueHelp){k.setShowValueHelp(true);}}var q=true,r=true;if(this._oParent._getHistoryEnabled){q=this._oParent._getHistoryEnabled();r=this._oParent.isPropertyInitial("historyEnabled");}if(!o.noTypeAhead||!k.isA("sap.m.Input")){v={control:k,model:m,dateFormatSettings:h,displayBehaviour:D,fieldViewMetadata:E,loadAnnotation:true,fullyQualifiedFieldName:j,metadataAnalyser:o.analyser,annotation:A,aggregation:o.aggregation,typeAheadEnabled:!o.noTypeAhead,dropdownItemKeyType:this.getDropdownItemKeyType(k),maxLength:E.maxLength,fieldHistoryEnabled:q,fieldHistoryEnabledInitial:r};var t=new b(this.getValueListProviderConfiguration(v));if(!o.noTypeAhead){if(k.setShowSuggestion){k.setShowSuggestion(true);}}if(O){t.attachValueListChanged(O);}this._aProviders.push(t);}}};g.prototype.getValueListProviderConfiguration=function(s){return{control:s.control,model:s.model,dateFormatSettings:s.dateFormatSettings,displayBehaviour:s.displayBehaviour,fieldViewMetadata:s.fieldViewMetadata,loadAnnotation:true,fullyQualifiedFieldName:s.fullyQualifiedFieldName,metadataAnalyser:s.metadataAnalyser,annotation:s.annotation,aggregation:s.aggregation,typeAheadEnabled:s.typeAheadEnabled,dropdownItemKeyType:s.dropdownItemKeyType,maxLength:s.maxLength,fieldHistoryEnabled:s.fieldHistoryEnabled,fieldHistoryEnabledInitial:s.fieldHistoryEnabledInitial};};g.prototype.getAttribute=function(n){var i=this._oParent.getBindingInfo(n);if(i){return this._oBinding.toBindingPath(i);}return this._oParent["get"+n.substring(0,1).toUpperCase()+n.substring(1)]();};g.prototype.getCustomDataConfiguration=function(){var o=this._oParent.data("configdata");return o&&o.configdata?o.configdata:null;};g.prototype.createAttributes=function(A,t,n,E){var h=this,m={};for(var p in n){if(n.hasOwnProperty(p)){var o=this._oParent.getBindingInfo(p);if(o){m[p]=this._oBinding.toBinding(o);}else if((p==="valueState")&&this._oParent.isPropertyInitial("valueState")){o=this.getValueStateBindingInfoForRecommendationStateAnnotation();if(o){m[p]=o;}else{m[p]=this._oParent["get"+e(p)]();}}else{m[p]=this._oParent["get"+e(p)]();}}}if(A){m[A]={model:this._oMetaData.model,path:this._oMetaData.path,type:t?this._oTypes.getType(t):null,mode:this._oParent.getBindingMode("value")};var i=this.getCustomDataConfiguration();if(i&&i.currency){m[A].mode=a.OneWay;}}if(E){m[E.event]=function(j){try{var P=j.getParameters();var k={value:P[E.parameter],newValue:P[E.parameter]};h._oParent.fireChange(k);}catch(q){L.warning(q);}};}return m;};g.prototype.mapBindings=function(A,N){var n,i;for(n in N){i=this._oParent.getBindingInfo(n);if(i){A[N[n]]=this._oBinding.toBinding(i);}else{A[N[n]]=this._oParent["get"+n.substring(0,1).toUpperCase()+n.substring(1)]();}}};g.prototype.getFormatSettings=function(s){var m=null,h,o,i;if(s){m=this._oParent.data(s);if(!m){h=this._oParent.getCustomData();if(h){i=h.length;while(i--){o=h[i];if(o.getKey()===s){m=o.getValue();break;}}}}if(m&&typeof(m)==="string"){try{m=JSON.parse(m);}catch(j){return null;}}}return m;};g.prototype.destroyValueHelp=function(){this._aProviders.forEach(function(p){p.destroy();});this._aProviders=[];};g.prototype.destroy=function(){this.destroyValueHelp();if(this._oBinding){this._oBinding.destroy();}this._oBinding=null;this._oParent=null;this._oModel=null;this._oRb=null;};return g;},true);
