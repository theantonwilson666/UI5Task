/*
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/Core","sap/ui/model/CompositeType","sap/ui/comp/util/FormatUtil","sap/ui/model/ParseException","sap/ui/model/ValidateException","sap/base/util/isPlainObject","sap/base/assert"],function(c,C,F,P,V,i,a){"use strict";var T=C.extend("sap.ui.comp.smartfield.type.TextArrangement",{constructor:function(o,b,s){this.getPrimaryType().call(this,o,b);C.call(this,o,b);this.init(o,b,s);a(s.keyField!==undefined,"Missing value for the keyField. - "+this.getName());a(s.descriptionField!==undefined,"Missing value for the descriptionField. - "+this.getName());},metadata:{"abstract":true}});T.prototype.init=function(o,b,s){this.sName="TextArrangement";this.bParseWithValues=true;this.async=true;var d={textArrangement:"idOnly"};var D={onBeforeValidateValue:function(){}};this.oSettings=Object.assign(D,s);this.oFormatOptions=Object.assign(d,o);this.fnParser=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"parse"});this.fnValidator=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"validate"});this.bValueListNoValidation=s.valueListNoValidation;};T.prototype.parseValue=function(v,s,b){var r,t=this.oFormatOptions.textArrangement;if(typeof v==="string"){v=v.replace(/\s+$/,"");}if(v===""||(t==="idOnly")){r=this.parseIDOnly(v,s);}else{r=this.fnParser(v,s,b,this.oFormatOptions,this.oSettings);}if(r[0]&&r[0].toUpperCase&&this.oFormatOptions.displayFormat==="UpperCase"){r[0]=r[0].toUpperCase();}return r;};T.prototype.parseIDOnly=function(v,s){v=this.getPrimaryType().prototype.parseValue.call(this,v,s);return[v,undefined];};T.prototype.parseIDAndDescription=function(v,s,b,o){var r=/.*\s\(.*\)/i;if(r.test(v)){var d=/\s\(/gi;if(v.match(d).length>1){throw new P(this.getResourceBundleText("SMARTFIELD_NOT_FOUND"));}var e=T.splitIDAndDescription(v,{separator:d,textArrangement:o.textArrangement});v=e[0];}return this.parseIDOnly(v,s);};T.prototype.parseDescriptionOnly=function(v,s,b,o,S){return new Promise(function(r,R){if(v===null||v===""){return r([v,""]);}function h(D){var I,k=S.keyField,e=S.descriptionField;var g=f(v,{key:e,value:k,data:D});var j=g.length;if(j===1){I=this.getPrimaryType().prototype.parseValue.call(this,g[0],s);r([I,undefined]);return;}if(j===0){g=f(v,{key:k,value:e,data:D});j=g.length;}if(!this.bValueListNoValidation){if(j===0){R(new V(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return;}if(j>1){R(new V(this.getResourceBundleText("SMARTFIELD_DUPLICATE_VALUES")));return;}}I=this.getPrimaryType().prototype.parseValue.call(this,v,s);r([I,undefined]);}function d(e){R(new V(this.getResourceBundleText("SMARTFIELD_INVALID_ENTRY")));}var O={filterFields:this.getFilterFields(),success:h.bind(this),error:d.bind(this)};this.onBeforeValidateValue(v,O);}.bind(this));};T.prototype.validateValue=function(v,b){this.validateIDOnly(v);var I=v[0];if(I===null){return;}if(this.oFormatOptions.textArrangement==="descriptionOnly"){this.validateDescriptionOnly(v,this.oSettings);return;}if(this.oFormatOptions.textArrangement==="idOnly"){this.validateIDOnly(v,this.oSettings);return;}var p=new Promise(function(r,R){function h(D){var s=Object.assign({},this.oSettings,{data:D,reject:R});var e=this.fnValidator(v,s);if(e){r(v);}}function d(e){R(new V(this.getResourceBundleText("SMARTFIELD_INVALID_ENTRY")));}var o={filterFields:this.getFilterFields(),success:h.bind(this),error:d.bind(this),bCheckValuesValidity:b};this.onBeforeValidateValue(I,o);}.bind(this));if(this.bValueListNoValidation){return;}else{return p;}};T.prototype.validateIDOnly=function(v){this.getPrimaryType().prototype.validateValue.call(this,v[0]);};T.prototype.validateIDAndDescription=function(v,s){var o={key:s.keyField,value:s.descriptionField,data:s.data};if(this.oFormatOptions&&this.oFormatOptions.displayFormat){o.displayFormat=this.oFormatOptions.displayFormat;}var d=f(v[0],o);var r=s.reject;if(!this.bValueListNoValidation){if(d.length===0){r(new V(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return false;}if(d.length>1){r(new V(this.getResourceBundleText("SMARTFIELD_DUPLICATE_VALUES")));return false;}}return true;};T.prototype.validateDescriptionOnly=function(v,s){};T.prototype.formatValue=function(v,t){var k;if(!Array.isArray(v)){return v;}if(this.bValueListNoValidation&&v[1]===undefined){v.splice(1,1);}k=this.getPrimaryType().prototype.formatValue.call(this,v[0],t);if(k===""||k===null){return k;}if(k&&this.oFormatOptions.displayFormat==="UpperCase"){k=k.toUpperCase();}var d=v[1];if(d===""&&this.oFormatOptions.textArrangement!=="idOnly"){this._sTextArrangementLastReadValue=null;}if(i(d)){d="";}return F.getFormattedExpressionFromDisplayBehaviour(this.oFormatOptions.textArrangement,k,d);};T.prototype.destroy=function(){this.oFormatOptions=null;this.oSettings=null;this.fnParser=null;this.fnValidator=null;};T.prototype.getName=function(){return"sap.ui.comp.smartfield.type.TextArrangement";};T.prototype.onBeforeValidateValue=function(v,s){this.oSettings.onBeforeValidateValue(v,s);};T.prototype.getResourceBundleText=function(k,p){return c.getLibraryResourceBundle("sap.ui.comp").getText(k,p);};T.prototype.getPrimaryType=function(){};T.prototype.getValidator=function(s){switch(s.textArrangement){case"idAndDescription":case"descriptionAndId":return this[s.prefix+"IDAndDescription"];case"descriptionOnly":return this[s.prefix+"DescriptionOnly"];default:return this[s.prefix+"IDOnly"];}};T.prototype.getFilterFields=function(v){return["keyField"];};function f(k,s){var v=[];if(s.displayFormat==="UpperCase"){k=k.toLowerCase();}s.data.forEach(function(d,I,D){var b=s.displayFormat==="UpperCase"?d[s.key].toLowerCase():d[s.key];if(b===k){v.push(d[s.value]);}});return v;}T.splitIDAndDescription=function(v,s){var b=s.separator.exec(v),I=b["index"];switch(s.textArrangement){case"idAndDescription":return[v.slice(0,I),v.slice(I+2,-1)];case"descriptionAndId":return[v.slice(I+2,-1),v.slice(0,I)];default:return["",""];}};return T;});
