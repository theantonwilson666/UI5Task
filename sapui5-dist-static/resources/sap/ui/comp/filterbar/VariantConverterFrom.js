/*
 * ! SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/comp/library','sap/ui/comp/util/DateTimeUtil','sap/m/MultiComboBox','sap/m/MultiInput','sap/m/DatePicker','sap/m/DateRangeSelection',"sap/base/Log","sap/ui/core/format/DateFormat"],function(l,D,M,a,b,c,L,d){"use strict";var A=l.ANALYTICAL_PARAMETER_PREFIX;var V=l.valuehelpdialog.ValueHelpRangeOperation;var e=function(){};e.prototype.convert=function(s,f,S){var C=null,r=null,o;if(s){this._bStrictMode=S;o=JSON.parse(s);if(f&&f.getFilterBarViewMetadata&&o){this._sBasicSearchName=null;this._sBasicSearchValue=null;if(f.getBasicSearchName){this._sBasicSearchName=f.getBasicSearchName();}C={};if(o.Parameters){this._addParameters(o.Parameters,f,C);}if(o.SelectOptions){this._addSelectOptions(o.SelectOptions,f,C);}r={payload:null,variantId:null};r.payload=JSON.stringify(C);if(o.SelectionVariantID){r.variantId=o.SelectionVariantID;}if(this._sBasicSearchValue){r.basicSearch=this._sBasicSearchValue;}}}return r;};e.prototype.retrieveVariantId=function(s){var v=null;var S;if(s){S=JSON.parse(s);if(S&&S.SelectionVariantID){v=S.SelectionVariantID;}}return v;};e.prototype._getParameterMetaData=function(n,f,i){if(this._bStrictMode){return this._getParameterMetaDataStrictMode(n,f);}return this._getParameterMetaDataNonStrictMode(n,f,i);};e.prototype._getFilter=function(n,f){var i,j,g,F;F=f.getFilterBarViewMetadata();if(F){for(i=0;i<F.length;i++){g=F[i];for(j=0;j<g.fields.length;j++){if(n===g.fields[j].fieldName){return g.fields[j];}}}}return null;};e.prototype._getParameter=function(n,f){var j,g;if(f.getAnalyticalParameters){g=f.getAnalyticalParameters();if(g){for(j=0;j<g.length;j++){if(n===g[j].fieldName){return g[j];}}}}return null;};e.prototype._getParameterWithInnerPrefix=function(n,f){var p=n;if(n.indexOf(A)!==0){p=A+n;}return this._getParameter(p,f);};e.prototype._getParameterMetaDataStrictMode=function(n,f){var m=this._getExactFilterParameterMatch(n,f);if(m){return m;}return null;};e.prototype._getParameterMetaDataNonStrictMode=function(o,f,i){var m,n,N,t,s=o,h=false,_=function(){return(h&&s===t)||(!h&&s!==t);};if(o.indexOf(A)===0){s=o.substr(A.length);h=true;}if(s.indexOf("P_")===0){n=s;N=s.substr(2);}else{n="P_"+s;N=s;}if(s!==n){t=n;}else if(s!==N){t=N;}m=this._getExactParameterMatch(s,f);if(m){return m;}m=this._getExactParameterMatch(t,f);if(m){return m;}if(_()){m=this._getFilter(N,f);if(m){return m;}}return null;};e.prototype._getExactParameterMatch=function(n,f){var p;p=this._getParameterWithInnerPrefix(n,f);if(p){return p;}return null;};e.prototype._getExactFilterParameterMatch=function(n,f){var F,p;F=this._getFilter(n,f);if(F){return F;}p=this._getParameterWithInnerPrefix(n,f);if(p){return p;}return null;};e.prototype._addParameters=function(s,f,C){var i;var n,v;var F;for(i=0;i<s.length;i++){v=s[i].PropertyValue;n=s[i].PropertyName;if(this._sBasicSearchName&&(n===this._sBasicSearchName)){this._sBasicSearchValue=v;continue;}F=this._getParameterMetaData(n,f,true);if(F){f.determineControlByName(n);this._addAccordingMetaData(C,f,F,v);}else{L.error("neither metadata nor custom information for filter '"+n+"'");}}};e.prototype._addSelectOptions=function(s,f,C){var i;var n,r;var F,o;for(i=0;i<s.length;i++){n=s[i].PropertyName;r=s[i].Ranges;if(this._sBasicSearchName&&(n===this._sBasicSearchName)){if(r&&r.length>0){this._sBasicSearchValue=r[0].Low;}continue;}f.determineControlByName(n);F=this._getParameterMetaData(n,f,false);if(F){o=F.control;this._addRangesAccordingMetaData(C,f,F,r,o);}else{L.error("neither metadata nor custom information for filter '"+n+"'");}}};e.convertOption=function(s,v){var i;switch(s){case"CP":i=V.Contains;if(v){var n=v.indexOf('*');var f=v.lastIndexOf('*');if(n>-1){if((n===0)&&(f!==(v.length-1))){i=V.EndsWith;v=v.substring(1,v.length);}else if((n!==0)&&(f===(v.length-1))){i=V.StartsWith;v=v.substring(0,v.length-1);}else{v=v.substring(1,v.length-1);}}}break;case"EQ":case"BT":case"LE":case"GE":case"GT":case"LT":i=s;break;default:L.error("Suite Option is not supported '"+s+"'");i=undefined;v=undefined;}return{op:i,v:v};};e.prototype._getYearMonthDatePattern=function(s){var m=s.match(/^([0-9]{4})([0-9]{2})([0-9]{2})$/);if(m){return[m[1],m[2],m[3]];}};e.prototype._getTimeZoneFormat=function(m){return m.split(/[\s+-]/)[0];};e.prototype._createDateObject=function(s){var f,g,m,p,P,o,t,h;if(!s){return;}f=s.split(".");g=f[0];m=f[1];if(m){m=this._getTimeZoneFormat(m);}P=g.split("T");h=P[0].split("-");if(h.length===1){p=this._getYearMonthDatePattern(h[0]);if(p){h=p;}}if(P.length<2){o=new Date(h[0],h[1]-1,h[2]);}else{t=P[1].split(":");o=new Date(h[0],h[1]-1,h[2],t[0],t[1],t[2],m?m:0);}o.setFullYear(h[0]);return o;};e.prototype._addRangesAccordingMetaData=function(C,f,F,r,o,n){var i,O;var g=function(F,f,v,q){if(f&&f.isInUTCMode&&v.indexOf("PT")===-1&&(F.filterType==="date")){if(f.isInUTCMode()){v=v.split('T')[0]+"T00:00:00";}else if(!f.isInUTCMode()&&(v.split("T").length===1)){v+="T00:00:00";}}if(v.indexOf('Z')!==(v.length-1)){if(f&&f.isInUTCMode&&!f.isInUTCMode()){q=D.localToUtc(this._createDateObject(v)).toJSON();}else{q=this._createDateObject(v).toJSON();}}else{L.error("Property '"+F.fieldName+"' was added with zulu time zone information.");}return q;}.bind(this);var h=function(v){var q=d.getTimeInstance({pattern:"'PT'hh'H'mm'M'ss'S'"});return q.parse(v);};var j=function(v){var q=v;if(v&&F){if(F.filterType==="numeric"){if((F.type==="Edm.Decimal")||(F.type==="Edm.Float")||(F.type==="Edm.Double")||(F.type==="Edm.Single")){q=parseFloat(v);}else{q=parseInt(v);}}else{switch(F.type){case"Edm.DateTime":q=g(F,f,v,q);break;case"Edm.Time":if(v.indexOf("PT")===0){q=h(v);}else{q=g(F,f,v,q);}break;case"Edm.String":if(F.isCalendarDate&&!(F.filterType==="stringdate"&&F.controlType==="date")){q=g(F,f,v,q);}break;case"Edm.DateTimeOffset":q=v;break;case"Edm.Date":var S=v.split('T'),t=S[1];if(t){t=this._getTimeZoneFormat(t);}q=(t)?S[0]+"T"+t:v;break;default:q=v;break;}}}return q;};var k=function(q,r){var i,I,O;for(i=0;i<r.length;i++){O=e.convertOption(r[i].Option,r[i].Low);if(O&&O.op){I={"exclude":(r[i].Sign==="E"),"operation":O.op,"keyField":q,"value1":j(O.v),"value2":j(r[i].High)};if(!C[q]){C[q]={ranges:[],items:[],value:null};}C[q].ranges.push(I);}}};var m=function(r){for(var i=0;i<r.length;i++){if(r[i].Sign==="E"){return true;}}return false;};if(r&&r.length>0){if(F.isCustomFilterField){if(!C._CUSTOM){C._CUSTOM={};}if(Array.isArray(r)&&r.length>1){C._CUSTOM[F.fieldName]=r.map(function(R){return R.Low;});}else{C._CUSTOM[F.fieldName]=r[0].Low;}return;}if(F.conditionType){for(i=0;i<r.length;i++){if(!r[i].High){r[i].High=r[i].Low;}}k(F.fieldName,r);return;}if(F.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.single){if(!r[0].Low&&o&&(o instanceof b)){C[F.fieldName]=null;}else{C[F.fieldName]=j(r[0].Low);}}else if(F.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.interval){if(o&&(o instanceof c)){if(r[0].Low&&r[0].High){C[F.fieldName]={low:j(r[0].Low),high:j(r[0].High)};}else if(r[0].Low&&!r[0].High){C[F.fieldName]={low:j(r[0].Low),high:j(r[0].Low)};}else if(!r[0].Low&&r[0].High){C[F.fieldName]={low:j(r[0].High),high:j(r[0].High)};}else{C[F.fieldName]={low:null,high:null};}}else{if(F.type==="Edm.Time"){k(F.fieldName,r);}else{C[F.fieldName]={low:r[0].Low===undefined?null:j(r[0].Low),high:r[0].High===undefined?null:j(r[0].High)};}}}else if(F.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.multiple){C[F.fieldName]={ranges:[],items:[],value:null};var s=(F.type==="Edm.DateTimeOffset")||F.isCalendarDate||(F.type==="Edm.DateTime")||(F.type==="Edm.Time");var p=(o instanceof a)&&m(r);if(o&&!s&&((o instanceof M)||(o instanceof a))&&!p){for(i=0;i<r.length;i++){O=e.convertOption(r[i].Option,j(r[i].Low));if(O.op===V.EQ){C[F.fieldName].items.push({key:j(O.v)});}}}else{k(F.fieldName,r);}}else{k(F.fieldName,r);}L.warning("potential reduced information for filter '"+F.fieldName+"'");}else{L.warning("no Ranges-section found for filter '"+F.fieldName+"'");}};e.prototype._addAccordingMetaData=function(C,f,F,v){var h=F.type==="Edm.DateTime"?"":v;var r=[{Sign:"I",Low:v,High:h,Option:"EQ"}];this._addRangesAccordingMetaData(C,f,F,r);};return e;},true);
