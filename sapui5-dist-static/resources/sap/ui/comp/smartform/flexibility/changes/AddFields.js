/*!
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/ui/core/util/reflection/JsControlTreeModifier","sap/base/util/merge","sap/base/util/ObjectPath"],function(B,D,J,m,O){"use strict";function a(f){return typeof f==="function";}function g(G,i){return G+"-element"+i;}function c(C){var M=false;M=C.content.field&&(C.content.field.selector||C.content.field.id)&&C.content.field.jsTypes&&C.content.field.value&&C.content.field.valueProperty;if(!M){throw new Error("Change does not contain sufficient information to be applied: ["+C.layer+"]"+C.namespace+"/"+C.fileName+"."+C.fileType);}}function b(e,o){var f=m({},e);f.fieldSelector.id=g(f.fieldSelector.id,0);return o.createControlForProperty(f).then(function(s){var n=e.modifier.getId(s.control);e.labelFor=n;return o.createLabel(e).then(function(l){return{label:l,control:s.control};});});}function d(e,p){var f=m({aggregationName:"formElements",payload:e.payload||{}},p);var o=e.instance;return Promise.resolve().then(function(){if(a(o.createLayout)){return o.createLayout(f);}}).then(function(l){if(O.get("control",l)){l.layoutControl=true;return l;}return b(f,o);});}var A={};A.applyChange=function(C,G,p){var o=C.getDefinition();var e=C.getContent();var M=p.modifier;var f=p.appComponent;var F=e.field.selector;var v=p.view;var s=e.field.id;if(M.bySelector(F||s,f,v)){return B.markAsNotApplicable("Control to be created already exists:"+F||s);}var h=e.field.index;var S=C.getDependentControl("form",p);var j=S&&M.getFlexDelegate(S);if(!j){c(o);var k=M.createControl("sap.ui.comp.smartform.GroupElement",f,v,F||s);if(!F){F=M.getSelector(s,f);}C.setRevertData({newFieldSelector:F});for(var i=0;i<e.field.jsTypes.length;i++){var l=e.field.jsTypes[i];var P=e.field.valueProperty[i];var n=e.field.value[i];var E=e.field.entitySet;this.addElementIntoGroupElement(M,v,k,l,P,n,E,i,f);}M.insertAggregation(G,"groupElements",k,h);return true;}return A._addFieldFromDelegate(S,G,F,s,h,e.field.value[0],C,M,v,f);};A._addFieldFromDelegate=function(s,G,f,F,i,e,C,M,v,o){return D.getDelegateForControl({control:s,modifier:M}).then(function(h){var j={appComponent:o,view:v,fieldSelector:f||F,bindingPath:e,modifier:M,element:s};return d(h,j);}).then(function(I){var h;if(!I.layoutControl){h=M.createControl("sap.ui.comp.smartform.GroupElement",o,v,f||F);M.insertAggregation(h,"label",I.label,0,v);M.insertAggregation(h,"fields",I.control,0,v);}else{h=I.control;}M.insertAggregation(G,"groupElements",h,i,v);if(I.valueHelp){M.insertAggregation(s,"dependents",I.valueHelp,0,v);}if(!f){f=M.getSelector(F,o);}C.setRevertData({newFieldSelector:f,valueHelpSelector:I.valueHelp&&M.getSelector(I.valueHelp,o)});});};A.addElementIntoGroupElement=function(M,v,G,j,p,P,e,i,o){var V;var s=M.getId(G);var f=g(s,i);try{V=M.createControl(j,o,v,f);}catch(E){return B.markAsNotApplicable(E&&E.message||"Control couldn't be created");}M.bindProperty(V,p,P);M.setProperty(V,"expandNavigationProperties",true);M.insertAggregation(G,"elements",V,i,v,true);if(e){M.setProperty(V,"entitySet",e);}};A.completeChangeContent=function(C,s,p){var o=p.appComponent;var e=C.getDefinition();if(!e.content){e.content={};}if(!e.content.field){e.content.field={};}if(s.fieldValues){e.content.field.value=s.fieldValues;}else if(s.bindingPath){e.content.field.value=[s.bindingPath];}else{throw new Error("oSpecificChangeInfo.fieldValue or bindingPath attribute required");}if(s.valueProperty){e.content.field.valueProperty=s.valueProperty;}else if(s.bindingPath){e.content.field.valueProperty=["value"];}else{throw new Error("oSpecificChangeInfo.valueProperty or bindingPath attribute required");}if(s.newControlId){e.content.field.selector=J.getSelector(s.newControlId,o);}else{throw new Error("oSpecificChangeInfo.newControlId attribute required");}if(s.jsTypes){e.content.field.jsTypes=s.jsTypes;}else if(s.bindingPath){e.content.field.jsTypes=["sap.ui.comp.smartfield.SmartField"];}else{throw new Error("oSpecificChangeInfo.jsTypes or bindingPath attribute required");}if(s.index===undefined){throw new Error("oSpecificChangeInfo.index attribute required");}else{e.content.field.index=s.index;}if(s.entitySet){e.content.field.entitySet=s.entitySet;}if(s.relevantContainerId){C.addDependentControl(s.relevantContainerId,"form",p);}};A.revertChange=function(C,G,p){var o=p.appComponent;var v=p.view;var M=p.modifier;var r=C.getRevertData();var f=r.newFieldSelector;var e=M.bySelector(f,o,v);M.removeAggregation(G,"groupElements",e);M.destroy(e);var V=r.valueHelpSelector;if(V){var h=M.bySelector(V,o,v);var s=C.getDependentControl("form",p);M.removeAggregation(s,"dependents",h);M.destroy(h);}C.resetRevertData();return true;};A.getCondenserInfo=function(C){return{affectedControl:C.getContent().field.selector,classification:sap.ui.fl.condenser.Classification.Create,targetContainer:C.getSelector(),targetAggregation:"groupElements",setTargetIndex:function(C,n){C.getContent().field.index=n;},getTargetIndex:function(C){return C.getContent().field.index;}};};A.getChangeVisualizationInfo=function(C){return{affectedControls:[C.getContent().field.selector]};};return A;},true);
