/*
 * ! SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/library','sap/ui/comp/library','sap/m/library','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/util/DateTimeUtil','sap/ui/core/SeparatorItem','sap/m/GroupHeaderListItem','sap/m/Column','sap/m/ColumnListItem','sap/m/Text','sap/m/Token','./BaseValueListProvider','sap/ui/core/ListItem','sap/ui/model/Filter','sap/ui/model/Sorter','sap/ui/model/json/JSONModel','sap/ui/model/FilterOperator','sap/ui/comp/util/FormatUtil','sap/ui/comp/smartfilterbar/FilterProvider','sap/ui/comp/historyvalues/HistoryValuesProvider','sap/ui/comp/historyvalues/HistoryOptOutProvider','sap/ui/comp/historyvalues/Constants','sap/m/ComboBox','sap/m/MultiComboBox','sap/base/util/deepEqual','sap/ui/Device','sap/base/Log','sap/base/util/values','sap/m/Label'],function(c,l,L,M,D,S,G,C,d,T,e,B,f,F,g,J,h,j,k,H,m,n,o,p,q,r,s,v,t){"use strict";var u=l.smartfilterbar.DisplayBehaviour;var P=L.PopinDisplay;var W=L.WrappingType;var V=c.ValueState;var w={Recommendations:10,RecentlyUsed:20,Others:30};var y="list";var z=B.extend("sap.ui.comp.providers.ValueListProvider",{constructor:function(a){if(!k){k=sap.ui.require("sap/ui/comp/smartfilterbar/FilterProvider");}if(a){this.sAggregationName=a.aggregation;this.bTypeAheadEnabled=!!a.typeAheadEnabled;this.bEnableShowTableSuggestionValueHelp=a.enableShowTableSuggestionValueHelp===undefined?true:a.enableShowTableSuggestionValueHelp;this.dropdownItemKeyType=a.dropdownItemKeyType;this.sDeferredGroupId=a.deferredGroupId;this.sContext=a.context;this._fieldHistoryEnabled=a.fieldHistoryEnabled;this._fieldHistoryEnabledInitial=a.fieldHistoryEnabledInitial;}this._aRecommendations=[];this._oRecommendationListPromise=Promise.resolve();this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this._groupHeaderFactory=this._groupHeaderFactory.bind(this);B.apply(this,arguments);this._onInitialise();}});z.prototype._onInitialise=function(){if(!this.bTypeAheadEnabled){this.oAfterRenderingEventDelegate={onAfterRendering:this._onMetadataInitialised};this.oControl.addEventDelegate(this.oAfterRenderingEventDelegate,this);}else if(this.oControl.attachSuggest){this._fSuggest=function(E){this.oControl=E.getSource();if(!this.bInitialised){return;}if(!this._oTemplate||!this.oControl.data("_hassuggestionTemplate")){this._createSuggestionTemplate();}var i=E.getParameter("suggestValue");this._fetchData(i);}.bind(this);this.oControl.attachSuggest(this._fSuggest);if(!this.oFilterModel){var a=this;var b=this.oControl.setParent;this.oControl.setParent=function(N,A,i){var O=this.getParent();var R=b.apply(this,arguments);N=this.getParent();var x=!(N&&(O===null));if((N!==O)&&x){a.unbindAggregation();}return R;};}this._handleSelect();}this.oControl.setModel(new J(),y);this._setupHistoryValues();this._setupRecommendations();};z.prototype._onMetadataInitialised=function(){if(this.bInitialised){if(this.oAfterRenderingEventDelegate){this.oControl.removeEventDelegate(this.oAfterRenderingEventDelegate);}if(this.oPrimaryValueListAnnotation){if(this.sAggregationName&&this.sAggregationName=="suggestionRows"){this._createSuggestionTemplate();}else{this._createDropDownTemplate();}this._fetchData();if(this._isControlDropdown()){if(this.mOutParams&&Object.keys(this.mOutParams).length>1){this._handleOutParameters();}if(this.mInParams&&Object.keys(this.mInParams).length>1){this._handleInParameters();}}}else{s.error("ValueListProvider","Missing primary ValueListAnnotation for "+(this._sFullyQualifiedFieldName||this.sFieldName));}if(this.oAfterRenderingEventDelegate){delete this.oAfterRenderingEventDelegate;}}};z.prototype._onAnnotationLoad=function(a){B.prototype._onAnnotationLoad.call(this,a);if(!this._isControlSupportedForHistory(this.oControl)){return;}if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){this._setupSuggestionInteractions();}};z.prototype._isSortable=function(N){if(this.oPrimaryValueListAnnotation){for(var i=0;i<this.oPrimaryValueListAnnotation.valueListFields.length;i++){if(this.oPrimaryValueListAnnotation.valueListFields[i].name===N){return this.oPrimaryValueListAnnotation.valueListFields[i].sortable!==false;}}return false;}return false;};z.prototype._createDropDownTemplate=function(){this._oTemplate=new f({key:{path:this._resolveSuggestionBindingPath(this.sKey),type:this.dropdownItemKeyType},text:{parts:[{path:this._resolveSuggestionBindingPath(this.sKey),type:this.dropdownItemKeyType},{path:this._resolveSuggestionBindingPath(this.sDescription)}],formatter:j.getFormatterFunctionFromDisplayBehaviour(this.sDDLBDisplayBehaviour)}});if(this._oRecommendationListAnnotation){this._oTemplate.bindProperty("additionalText",{path:this._resolveSuggestionBindingPath(this._oRecommendationListAnnotation.rankProperty)});}this._oSorter=null;if(this.sDDLBDisplayBehaviour===u.idOnly||this.sDDLBDisplayBehaviour===u.idAndDescription){if(this._isSortable(this.sKey)){this._oSorter=new g(this.sKey);}}else{if(this._isSortable(this.sDescription)){this._oSorter=new g(this.sDescription);}else if((this.sDescription!==this.sKey)&&this._isSortable(this.sKey)){this._oSorter=new g(this.sKey);}}};z.prototype._createSuggestionTemplate=function(){var i=0,a=0,b=0,x=this._aHighImportanceCols||this._aRecommendationCols||this._aCols;this._oTemplate=new d();if(x){this.oControl.removeAllSuggestionColumns();a=x.length;for(i=0;i<a;i++){var A=false,E="1px",I=x[i].width;if(r.system.phone){I=undefined;if(i>=2){A=true;E=(i+1)*10+"rem";}}this.oControl.addSuggestionColumn(new C({header:new t({wrapping:true,wrappingType:W.Hyphenated,text:x[i].label}),demandPopin:A,popinDisplay:P.Inline,minScreenWidth:E,width:I}));this._oTemplate.addCell(new t({wrapping:true,text:{path:this._resolveSuggestionBindingPath(x[i].template),type:x[i].oType}}));if(I){b+=parseFloat(I.substring(0,I.length-2));}}if(b>0){this.oControl.setProperty('maxSuggestionWidth',b+a+"em",true);}}this.oControl.data("_hassuggestionTemplate",true);if(this.oControl&&this.oControl._oSuggestionTable){this.oControl._oSuggestionTable.addStyleClass("sapUiCompValueListProviderTable");}};z.prototype._handleRowSelect=function(a,b){var K,i,x;if(a){K=a[this.sKey];i=a[this.sDescription];}if(K||(K==="")){if(this.oControl.addToken){i=j.getFormattedExpressionFromDisplayBehaviour(this.sTokenDisplayBehaviour,K,i);x=new e();x.setKey(K);x.setText(i);x.setTooltip(i);x.data("row",a);if(b){b(x);}if(this.oControl.getValue()===""){this.oControl.setValue("");}delete this.oControl.__sValidationText;}else{this.oControl.setValue(K);this.oControl.fireChange({value:K,validated:true});}}this._calculateAndSetFilterOutputData([a]);};z.prototype._multiInputValidator=function(a){if(!this.bInitialised){return;}if(this._aValidators){var b;this._aValidators.some(function(E){b=E(a);return b;},this);if(b){return b;}}var R=a.suggestionObject,i,I=a.text;if(R){var x=this._getSuggestionsModelName(),A=R.getBindingContext(x);i=A.getObject();this._handleRowSelect(i,a.asyncCallback);}else if(I){this._validateInput(I,a.asyncCallback);}};z.prototype._validateInput=function(i,a){var b,x=[],A=this.oControl,E;if(this.sDisplayFormat==="UpperCase"){i=i.toUpperCase();}if(A.__sValidationText!==i){A.__sValidationText=i;if(i===this._truncateSearchText(i)){A.__bValidatingToken=true;this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){x=k.generateFilters(this.aFilterField,this.mFilterInputData);}x.push(new F(this.sKey,h.EQ,i));if(this.bSupportBasicSearch){E={"search-focus":this.sKey};}b=new Promise(function(R,I){this.oODataModel.read("/"+this.sValueListEntitySetName,{filters:x,urlParameters:E,success:function(K){if(!this.oControl||!this.oControl.hasOwnProperty("__bValidatingToken")){return;}var N=K;delete this.oControl.__bValidatingToken;if(K){if(K.results&&K.results.length>=1){if(K.results.length===1){N=K.results[0];}if(this.oControl.data("__validationError")){this.oControl.data("__validationError",null);this.oControl.setValueState("None");}}else{this.oControl.setValueState("Error");this.oControl.data("__validationError",true);}if(N&&N[this.sKey]){A._pendingAutoTokenGeneration=true;this._handleRowSelect(N,a);A._pendingAutoTokenGeneration=false;}}this._afterTokenValidate();R();}.bind(this),error:function(){if(this.oControl.data("__validationError")){this.oControl.setValueState("None");}delete this.oControl.__bValidatingToken;this._afterTokenValidate();R();}.bind(this)});}.bind(this));this._addValidationPromise(b);}}else{if(A.data("__validationError")){A.setValueState(V.Error);}}};z.prototype._validateStringSingleWithValueList=function(E){var a;if(E.getParameter("validated")){return;}a=E.getParameter("value");if(a===""||a===undefined){return;}this._validateInput(a);};z.prototype._afterTokenValidate=function(){if(this.oFilterProvider&&this.oFilterProvider._oSmartFilter&&this.oFilterProvider._oSmartFilter.bIsSearchPending&&this.oFilterProvider._oSmartFilter.search){if(this.oFilterProvider._oSmartFilter.getLiveMode&&this.oFilterProvider._oSmartFilter.getLiveMode()){return;}this.oFilterProvider._oSmartFilter.search();}};z.prototype._onSuggestionItemSelected=function(E){var R=E.getParameter("selectedRow");if(R){var a=this._getSuggestionsModelName();this._handleRowSelect(R.getBindingContext(a).getObject());}};z.prototype._setFilterOutputDataFromSelectedRow=function(R){var a,b,i;if(R){a=this._getSuggestionsModelName();b=R.getBindingContext(a);i=b.getObject();this._calculateAndSetFilterOutputData([i]);}};z.prototype._onMultiComboBoxItemSelected=function(E){if(!E.getParameter("selected")){return;}var R=E.getParameter("changedItem");this._setFilterOutputDataFromSelectedRow(R);};z.prototype._onComboBoxItemSelected=function(E){var a=E.getParameter("value"),N=E.getParameter("newValue"),b=E.getParameter("filterChangeReason");if(b&&!a&&!N){return;}var R=this.oControl.getSelectedItem();this._setFilterOutputDataFromSelectedRow(R);};z.prototype._handleSelect=function(){if(this.oControl.addValidator){this._aValidators=this.oControl&&this.oControl.isA('sap.m.MultiInput')?this.oControl.getValidators().slice():[];this.oControl.removeAllValidators();this._fValidator=this._multiInputValidator.bind(this);this.oControl.addValidator(this._fValidator);}else if(this.oControl.attachSuggestionItemSelected){this.oControl.attachSuggestionItemSelected(this._onSuggestionItemSelected,this);if(this.sContext==="SmartFilterBar"&&this._fieldViewMetadata&&this._fieldViewMetadata.hasValueListAnnotation){this.oControl.attachChange(this._validateStringSingleWithValueList,this);}}if(this.oControl.setRowResultFunction){this.oControl.setRowResultFunction(function(a){var b,R="",i=this._getSuggestionsModelName();if(a){b=a.getBindingContext(i);}if(b&&this.sKey){R=b.getProperty(this.sKey);}return R;}.bind(this));}};z.prototype._filterDropdownRowsByInParameters=function(){this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){this.oControl.setBusy(true);this._fetchData();this._mLastFilterInputData=this.mFilterInputData;this._cleanupControlSelection();}};z.prototype.isInSmartFilterBar=function(){return!!this.oFilterModel;};z.prototype._isControlDropdown=function(a){if(!a){a=this.oControl;}return!!(a.isA("sap.m.MultiComboBox")||a.isA("sap.m.ComboBox"));};z.prototype._cleanupControlSelection=function(){if(this.isInSmartFilterBar()&&this.oControl.isA("sap.m.MultiComboBox")){this.oFilterModel.setProperty("/"+this.sFieldName+"/items",[]);this.oControl.setSelectedKeys(null);}else{this.oControl.setSelectedKey(null);this.oControl.clearSelection();}};z.prototype._openDropdown=function(){if(this.oControl.isA("sap.m.MultiComboBox")){p.prototype.open.apply(this.oControl,arguments);}else if(this.oControl.isA("sap.m.ComboBox")){o.prototype.open.apply(this.oControl,arguments);}};z.prototype._handleOutParameters=function(){if(this.oControl.isA("sap.m.MultiComboBox")){this.oControl.attachSelectionChange(this._onMultiComboBoxItemSelected,this);}else if(this.oControl.isA("sap.m.ComboBox")){this.oControl.attachChange(this._onComboBoxItemSelected,this);}};z.prototype._handleInParameters=function(){this.oControl.setBusyIndicatorDelay(0);this._calculateFilterInputData();this._mLastFilterInputData=this.mFilterInputData;this.oControl.open=function(){this._calculateFilterInputData();if(q(this._mLastFilterInputData,this.mFilterInputData)){this._openDropdown();return;}this._filterDropdownRowsByInParameters();this._openDropdown();}.bind(this);this.oControl.addEventDelegate({onmousedown:function(E){if(E.target===this.oControl.getIcon().getFocusDomRef()){this._bSkipFocusIn=true;}}.bind(this),onmouseup:function(E){if(this._bSkipFocusIn&&E.target===this.oControl.getIcon().getFocusDomRef()){this.oControl.open();}this._bSkipFocusIn=false;}.bind(this),onfocusin:function(E){if(this._bSkipFocusIn){return E;}setTimeout(function(){this._calculateFilterInputData();if(q(this._mLastFilterInputData,this.mFilterInputData)){return;}this._filterDropdownRowsByInParameters();}.bind(this));return E;}.bind(this)});};z.prototype._fetchData=function(a){var b={},i=[],x=this._getBindingLength(),A="",E,I;a=a||"";if(this.bTypeAheadEnabled){if(a&&this.sDisplayFormat==="UpperCase"){a=a.toUpperCase();}if(this.bSupportBasicSearch){if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){b={"search-focus":this.sKey,"search":a};}else{b.custom={"search-focus":this.sKey,"search":a};}}this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){i=k.generateFilters(this.aFilterField,this.mFilterInputData,{dateSettings:this._oDateFormatSettings});}if(!this.bSupportBasicSearch){if(this._fieldViewMetadata&&this._fieldViewMetadata.filterType==="numc"){i.push(new F(this.sKey,h.Contains,a));}else{A=this._truncateSearchText(a);if(A===a){i.push(new F(this.sKey,h.StartsWith,A));}else{this.oControl.closeSuggestions();return;}}}x=10;}b["$top"]=x;b["$skip"]=0;if(!this.sValueListEntitySetName){s.error("ValueListProvider","Empty sValueListEntitySetName for "+this.sAggregationName+" binding! (missing primaryValueListAnnotation)");}if(this.sDeferredGroupId){b["batchGroupId"]=this.sDeferredGroupId;}if(this.aSelect&&this.aSelect.length){b["$select"]=this.aSelect.toString();}if(!(this._shouldHaveRecommendations()||this._shouldHaveHistory())||!this._isControlSupportedForHistory(this.oControl)){if(this.bTypeAheadEnabled&&this.bEnableShowTableSuggestionValueHelp){I={dataReceived:function(O){var Q=O.getSource(),R;if(Q){R=Q.getLength();if(R&&R<=x){this.oControl.setShowTableSuggestionValueHelp(false);}else{this.oControl.setShowTableSuggestionValueHelp(true);}}}.bind(this)};}else if(this.bTypeAheadEnabled){this.oControl.setShowTableSuggestionValueHelp(false);}if(this.aSelect&&this.aSelect.length){b["select"]=this.aSelect.toString();delete b["$select"];}if(this._isControlDropdown(this.oControl)&&(this.mInParams&&Object.keys(this.mInParams).length>1||this.mConstParams&&Object.keys(this.mConstParams).length>=1)){if(!I){I={dataReceived:function(){this.oControl.setBusy(false);}.bind(this)};}this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){i=k.generateFilters(this.aFilterField,this.mFilterInputData,{dateSettings:this._oDateFormatSettings});}}this.oControl.bindAggregation(this.sAggregationName,{path:"/"+this.sValueListEntitySetName,length:x,parameters:b,filters:i,sorter:this._oSorter,events:I,template:this._oTemplate,templateShareable:true});return;}this._bindInnerControlSuggestions();var K=this;E=new Promise(function(O,Q){if(!K.sValueListEntitySetName){O({results:[]});}K.oODataModel.read("/"+K.sValueListEntitySetName,{urlParameters:b,filters:i,sorters:K._oSorter&&[K._oSorter],success:function(R){O(R);},error:function(R){Q(R);}});});var N=Promise.resolve([]);if(this._shouldHaveHistory()){N=K._oHistoryValuesProvider.getFieldData();}Promise.all([E,this._oRecommendationListPromise,N]).then(function(R){var O=[],Q=[],U=[],X=[],Y=K._getSuggestionsModelName(),Z=K.oControl;if(!Z){return;}var $=Z.getModel(Y);if(Array.isArray(R[0]&&R[0].results)){Q=K._addSuggestionsToGroup(R[0].results,w.Others);}if(Array.isArray(R[1]&&R[1].results)){U=K._addSuggestionsToGroup(R[1].results,w.Recommendations);}if(K._shouldHaveHistory()&&Array.isArray(R[2])){X=K._addSuggestionsToGroup(R[2],w.RecentlyUsed);X=K._parseHistoryJsonDates(X);}O=O.concat(U).concat(X).concat(Q);O=K._getDistinctSuggestions(O);O=O.filter(K._filterSuggestionsWithInParams.bind(K,K.mFilterInputData));K._showSuggestionsMoreButton(Q.length>=x);if(K.oControl.isA("sap.m.MultiInput")){K.oControl._oSuggPopover._oProposedItem=null;}$.setData(O);});};z.prototype._sortRecommendations=function(a,b){var R=this._oRecommendationListAnnotation.rankProperty,i=parseFloat(a[R]),x=parseFloat(b[R]);return x-i;};z.prototype._showSuggestionsMoreButton=function(b){if(!this.bTypeAheadEnabled){return;}if(this.bEnableShowTableSuggestionValueHelp){this.oControl.setShowTableSuggestionValueHelp(b);}else{this.oControl.setShowTableSuggestionValueHelp(false);}};z.prototype._addSuggestionsToGroup=function(a,i){if(!a){return[];}return a.map(function(b){var x={};x[n.getSuggestionsGroupPropertyName()]=i;return Object.assign({},b,x);});};z.prototype._groupHeaderFactory=function(a){var b=this._getGroupHeaderTitle(a.key);if(this._isControlDropdown()){return new S({key:n.getHistoryPrefix()+a.key+".key",text:b});}return new G({title:b});};z.prototype._getGroupHeaderTitle=function(a){switch(a){case w.Recommendations:return this._oResourceBundle.getText("VALUELIST_RECOMMENDATIONS_TITLE");case w.RecentlyUsed:return this._oResourceBundle.getText("VALUELIST_RECENTLY_USED_TITLE");default:return this._oResourceBundle.getText("VALUELIST_OTHERS_TITLE");}};z.prototype._getGroupHeaderSorter=function(){if(this._groupHeaderSorter){return this._groupHeaderSorter;}this._groupHeaderSorter=new g({path:n.getSuggestionsGroupPropertyName(),descending:false,group:function(a){return a.getProperty(n.getSuggestionsGroupPropertyName());}});return this._groupHeaderSorter;};z.prototype._getDistinctSuggestions=function(a){var U={},b=[];a.forEach(function(x){var i=Object.assign({},x);delete i[n.getSuggestionsGroupPropertyName()];delete i.__metadata;var K=v(i).join();if(!U[K]){b.push(x);U[K]=true;}},this);return b;};z.prototype._resolveRecommendationListAnnotationData=function(R){var a=R.fieldsToDisplay,b,x,A;this._aRecommendationCols=[];this.aRecommendationSelect=[];for(var i=0;i<a.length;i++){b=a[i];x=this._getColumnConfigFromField(b);if(b.visible){this._aRecommendationCols.push(x);this.aRecommendationSelect.push(b.name);}}if(this._aHighImportanceCols&&this._oRecommendationListAnnotation){A=this._oRecommendationListAnnotation.rankField[0];A=this._getColumnConfigFromField(A);this._aHighImportanceCols.push(A);}};z.prototype._setupRecommendations=function(){if(!this._shouldHaveRecommendations()||!this._isControlSupportedForHistory(this.oControl)){return;}this._resolveRecommendationListAnnotationData(this._getRecommendationListAnnotation());this._fetchRecommendations();};z.prototype._shouldHaveRecommendations=function(){return M.isRecommendationList(this._fieldViewMetadata);};z.prototype._getRecommendationListAnnotation=function(){if(!this._oRecommendationListAnnotation){var R=this._oMetadataAnalyser._getRecommendationListAnnotation(this._sFullyQualifiedFieldName);this._oRecommendationListAnnotation=this._oMetadataAnalyser._enrichRecommendationListAnnotation(R);}return this._oRecommendationListAnnotation;};z.prototype._fetchRecommendations=function(){var a=this;this._oRecommendationListPromise=new Promise(function(b,i){a.oODataModel.read("/"+a._oRecommendationListAnnotation.path,{urlParameters:{$skip:0,$top:5,$select:a.aRecommendationSelect.toString()},sorter:a._oSorter,success:function(x){var R=a._addSuggestionsToGroup(x.results,w.Recommendations),A=a._getSuggestionsModelName(),E=a.oControl.getModel(A),I=E.getData(),K=R.sort(a._sortRecommendations.bind(a));a._aRecommendations=K;if(Array.isArray(I)){K=[].concat(I).concat(K);}E.setData(K);a._showSuggestionsMoreButton(false);b(x);},error:function(x){i(x);}});});};z.prototype._createHistoryValuesProvider=function(){return new H(this.oControl,this._sFullyQualifiedFieldName);};z.prototype._createHistoryOptOutProvider=function(){return m.createOptOutSettingPage();};z.prototype._setupHistoryValues=function(){if(!this._shouldHaveHistory()||!this._isControlSupportedForHistory(this.oControl)){return;}this._oHistoryValuesProvider=this._createHistoryValuesProvider();this._createHistoryOptOutProvider();this._oHistoryValuesProvider.getHistoryEnabled().then(function(E){if(!E||!this._oHistoryValuesProvider){return;}this._oHistoryValuesProvider.attachChangeListener();this._oHistoryValuesProvider.attachEvent("fieldUpdated",this._onHistoryFieldUpdated,this);this._oHistoryValuesProvider.getFieldData().then(this._onHistoryDataInitialized.bind(this));}.bind(this));};z.prototype._onHistoryDataInitialized=function(a){this._updateModelHistoryData(a);return a;};z.prototype._onHistoryFieldUpdated=function(E){var a=E.getParameter("fieldData")||[];if(this.oControl.isA("sap.m.Input")){setTimeout(function(){this._updateModelHistoryData(a);this.oControl&&this.oControl._oSuggPopover._oPopover.close();}.bind(this));return;}this._updateModelHistoryData(a);if(this.oControl.isA("sap.m.ComboBox")){setTimeout(function(){this.oControl&&this.oControl._oSuggestionPopover._oPopover.close();}.bind(this));}};z.prototype._updateModelHistoryData=function(a){if(!this.oControl){return;}a=this._parseHistoryJsonDates(a);var b=[],R=this._addSuggestionsToGroup(a,w.RecentlyUsed),i=this._getSuggestionsModelName(),x=this.oControl.getModel(i),O=x.getData();if(!Array.isArray(O)){O=[];}b=this._getDistinctSuggestions(b.concat(R).concat(O));x.setData(b);this._showSuggestionsMoreButton(false);};z.prototype._shouldHaveHistory=function(){if(!this._fieldHistoryEnabled||!this._fieldViewMetadata||!this._sFullyQualifiedFieldName||!this.oControl||(this._isControlDropdown()&&(this._fieldHistoryEnabledInitial||this._fieldHistoryEnabledInitial===undefined)&&this._fieldHistoryEnabled)){return false;}var a=window["sap-ushell-config"],b,i,E;if(a){b=a.apps;}if(b){i=b.inputFieldHistory;}if(i){E=i.enabled;}return sap.ushell&&sap.ushell.Container&&E&&!M.isPotentiallySensitive(this._fieldViewMetadata);};z.prototype._bindInnerControlSuggestions=function(){if(this.sAggregationName&&this.oControl.isBound(this.sAggregationName)){return;}if(this.sAggregationName&&this.sAggregationName==="suggestionRows"){this._createSuggestionTemplate();}else{this._createDropDownTemplate();}var b={path:this._getSuggestionsModelName()+">/",template:this._oTemplate,templateShareable:true,length:this._getBindingLength()};b.groupHeaderFactory=this._groupHeaderFactory;b.sorter=this._getGroupHeaderSorter();if(this.sAggregationName){this.oControl.bindAggregation(this.sAggregationName,b);}};z.prototype._setupSuggestionInteractions=function(){if(this.sAggregationName==="suggestionRows"){this._setupInputSuggestionInteractions();return;}this._setupComboBoxSuggestionInteractions();};z.prototype._setupInputSuggestionInteractions=function(){var i=this.oControl;i.setFilterSuggests(true);i.setFilterFunction(function(a,I){var b=this._getSuggestionsModelName(),x=I.getBindingContext(b).getObject(),K=x[this.sKey],A=x[this.sDescription],E=j.getFormatterFunctionFromDisplayBehaviour(this.sDDLBDisplayBehaviour),N=E(K,A);a=a.replace(/\*$/,"");a=a.replace(/^\*/,"");var O=Object.keys(x).some(function(K){var R=x[K]+"";return R.toLowerCase().indexOf(a.toLowerCase())!==-1;});var Q=N.toLowerCase().indexOf(a.toLowerCase())!==-1;return O||Q;}.bind(this));i.attachLiveChange(function(E){var a=E.getParameter("value"),A=[w.RecentlyUsed,w.Recommendations];if(a===""){this.oControl._oSuggPopover._oPopover.close();this._showInitialSuggestions(A);}},this);i.addEventDelegate({onmousedown:function(E){if((this.oControl.getAggregation("_suggestionPopup")&&this.oControl.getAggregation("_suggestionPopup").isOpen())||E.target.tagName!=="INPUT"){return;}this._bindInnerControlSuggestions();setTimeout(function(){this._showInitialSuggestions("suggestionRows",i.getValue());}.bind(this));},onkeyup:function(E){this._bindInnerControlSuggestions();if(E.keyCode!==9){return;}setTimeout(function(){this._showInitialSuggestions("suggestionRows",i.getValue());}.bind(this));}},this);if(i.isA("sap.m.MultiInput")||!this._shouldHaveRecommendations()){return;}i.attachSuggestionItemSelected(function(E){var a=this._getSuggestionsModelName(),b=E.getParameter("selectedRow"),I;if(b){var x=b.getBindingContext(a).getObject();I=x&&x[this.sKey];}if(this._isNotRecommendationItemSelected("suggestionRows",I)){this._setControlValueState(V.Warning);}else{this._setControlValueState(V.None);}},this);};z.prototype._setupComboBoxSuggestionInteractions=function(){var a=this.oControl;a.setShowSecondaryValues(true);a.addEventDelegate({onmousedown:function(E){if((this.oControl.getPicker()&&this.oControl.getPicker().isOpen())||E.target.tagName!=="INPUT"){return;}this._bindInnerControlSuggestions();setTimeout(function(){this._showInitialSuggestions("items",a.getValue());}.bind(this));},onkeyup:function(E){this._bindInnerControlSuggestions();if(E.keyCode!==9){return;}setTimeout(function(){this._showInitialSuggestions("items",a.getValue());}.bind(this));}},this);if(a.isA("sap.m.MultiComboBox")||!this._shouldHaveRecommendations()){return;}a.attachChange(function(E){if(this._isNotRecommendationItemSelected("items",E.getParameter("value"))){this._setControlValueState(V.Warning);}else{this._setControlValueState(V.None);}},this);};z.prototype._isNotRecommendationItemSelected=function(a,b){return this._findSuggestionItemGroup(a,b)!==w.Recommendations;};z.prototype._findSuggestionItemGroup=function(a,b){var x=this.oControl.getBinding(a),I=x?x.getCurrentContexts():[],A;for(var i=0;i<I.length;i++){var E=I[i].getObject(),K=E[this.sKey],N=E[this.sDescription];if(K===b||N===b){A=E;break;}}return A?A[n.getSuggestionsGroupPropertyName()]:null;};z.prototype._setControlValueState=function(a){this.oControl.setValueState(a?a:V.None);this.oControl.setValueStateText(" ");};z.prototype._showInitialSuggestions=function(a,b){var i=this,x=[w.RecentlyUsed,w.Recommendations],A=[w.RecentlyUsed],E=[];if(this._isNotRecommendationItemSelected(a,b)){E=x;}else if(this._shouldHaveHistory()){E=A;}this._calculateFilterInputData();this.oControl.showItems(function(b,I){var K=i._getSuggestionsModelName(),N=I.getBindingContext(K),O=N?N.getObject():{},Q=O[n.getSuggestionsGroupPropertyName()];return i._filterSuggestionsWithInParams(i.mFilterInputData,O)&&E.indexOf(Q)!==-1;});};z.prototype._filterSuggestionsWithInParams=function(a,i){if(!a||a.length===0){return true;}return Object.keys(a).every(function(K){var b=i[K];var x=a[K];if(!b){return true;}if(typeof x==="string"){return x===b;}if(typeof x==="object"&&x.items&&x.items.length>0){return x.items.some(function(A){return A.key===b;});}return true;});};z.prototype._getSuggestionsModelName=function(){var a;if(!this._isControlSupportedForHistory(this.oControl)){return a;}if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){a=y;}return a;};z.prototype._resolveSuggestionBindingPath=function(a){var b=this._getSuggestionsModelName();if(b){a=b+">"+a;}return a;};z.prototype._isControlSupportedForHistory=function(a){if(!a){return false;}if(a.isA("sap.ui.comp.smartfield.DisplayComboBox")){return false;}if(a.isA("sap.m.ComboBox")||a.isA("sap.m.MultiComboBox")||a.isA("sap.m.Input")||a.isA("sap.m.MultiInput")){return true;}return false;};z.prototype._getBindingLength=function(){var i=300;if(this.oODataModel&&this.oODataModel.iSizeLimit&&this.oODataModel.iSizeLimit>i){i=this.oODataModel.iSizeLimit;}return i;};z.prototype._parseHistoryJsonDates=function(a){return a.map(function(i){return Object.keys(i).reduce(function(R,K){if(D._hasJsonDateString(i[K])){R[K]=D._parseJsonDateString(i[K]);}else{R[K]=i[K];}return R;},{});});};z.prototype._truncateSearchText=function(a){var i=-1;if(this._sMaxLength){i=parseInt(this._sMaxLength);}else if(this._fieldViewMetadata&&this._fieldViewMetadata.maxLength){i=parseInt(this._fieldViewMetadata.maxLength);}if(i>-1&&a.length>i){a=a.substr(0,i);}return a;};z.prototype.unbindAggregation=function(){if(this.oControl){this.oControl.unbindAggregation(this.sAggregationName);}return this;};z.prototype.destroy=function(){if(this.oControl){if(this.oControl.detachSuggest&&this._fSuggest){this.oControl.detachSuggest(this._fSuggest);this._fSuggest=null;}if(this.oControl.removeValidator&&this._fValidator){this.oControl.removeValidator(this._fValidator);this._fValidator=null;}else if(this.oControl.detachSuggestionItemSelected){this.oControl.detachSuggestionItemSelected(this._onSuggestionItemSelected,this);}if(this.oControl.detachChange){this.oControl.detachChange(this._validateStringSingleWithValueList,this);}this.oControl.unbindAggregation(this.sAggregationName);this.oControl.data("_hassuggestionTemplate",false);delete this.oControl.__sValidationText;delete this.oControl.__bValidatingToken;}if(this._oHistoryValuesProvider){this._oHistoryValuesProvider.destroy();this._oHistoryValuesProvider=null;}B.prototype.destroy.apply(this,arguments);if(this.oJsonModel){this.oJsonModel.destroy();this.oJsonModel=null;}if(this._oTemplate){this._oTemplate.destroy();}this._oTemplate=null;this.sAggregationName=null;this.bTypeAheadEnabled=null;this._oSorter=null;};return z;});
