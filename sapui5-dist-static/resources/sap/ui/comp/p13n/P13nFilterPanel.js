/*
 * ! SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/m/P13nFilterPanel','sap/ui/comp/p13n/P13nConditionPanel','sap/m/Panel','sap/m/library','sap/m/P13nFilterItem','sap/ui/comp/p13n/P13nOperationsHelper','sap/m/P13nFilterPanelRenderer'],function(P,a,b,l,c,d,e){"use strict";var f=l.P13nPanelType,g=l.P13nConditionOperation;var h=P.extend("sap.ui.comp.p13n.P13nFilterPanel",{metadata:{library:"sap.ui.comp.p13n"},renderer:e.renderer});h.prototype.setConditions=function(C){this._oConditionPanel.setConditions(C);return this;};h.prototype.getConditions=function(){return this._oConditionPanel.getConditions();};h.prototype.setContainerQuery=function(C){this.setProperty("containerQuery",C);this._oConditionPanel.setContainerQuery(C);return this;};h.prototype.setLayoutMode=function(m){this.setProperty("layoutMode",m);this._oConditionPanel.setLayoutMode(m);return this;};h.prototype.validateConditions=function(){return this._oConditionPanel.validateConditions();};h.prototype.removeInvalidConditions=function(){this._oConditionPanel.removeInvalidConditions();};h.prototype.removeValidationErrors=function(){this._oConditionPanel.removeValidationErrors();};h.prototype.setIncludeOperations=function(o,t){t=t||"default";this._aIncludeOperations[t]=o;if(this._oConditionPanel){this._oConditionPanel.setOperations(this._aIncludeOperations[t],t);}};h.prototype.getIncludeOperations=function(t){if(this._oConditionPanel){return this._oConditionPanel.getOperations(t,false);}};h.prototype.setExcludeOperations=function(o,t){t=t||"default";this._aExcludeOperations[t]=o;if(this._oConditionPanel){this._oConditionPanel.setOperations(this._aExcludeOperations[t],t,true);}};h.prototype.getExcludeOperations=function(t){if(this._oConditionPanel){return this._oConditionPanel.getOperations(t,true);}};h.prototype.setKeyFields=function(k,K){this._aKeyFields=k;if(this._oConditionPanel){k.some(function(o){if(o.isDefault){this._oConditionPanel.setAutoAddNewRow(true);}}.bind(this));this._oConditionPanel.setKeyFields(k);}};h.prototype.setMaxIncludes=function(m){this.setProperty("maxIncludes",m);if(this._oConditionPanel){this._oConditionPanel.setMaxConditions(m);}return this;};h.prototype.setMaxExcludes=function(m){this.setProperty("maxExcludes",m);return this;};h.prototype.init=function(){this.setType(f.filter);this.setTitle(sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("FILTERPANEL_TITLE"));sap.ui.getCore().loadLibrary("sap.ui.layout");this._aKeyFields=[];this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._aIncludeOperations={};this._aExcludeOperations={};this._oPanel=new b({expanded:true,expandable:false,width:"auto"}).addStyleClass("sapMFilterPadding");this._oConditionPanel=new a({maxConditions:this.getMaxIncludes(),alwaysShowAddIcon:false,layoutMode:this.getLayoutMode(),dataChange:this._handleDataChange()});this._oConditionPanel._sAddRemoveIconTooltipKey="FILTER";this._oPanel.addContent(this._oConditionPanel);this.addAggregation("content",this._oPanel);if(!this._oOperationsHelper){this._oOperationsHelper=new d();}this._updateOperations();};h.prototype.onBeforeRendering=function(){var k=[],K,m,E=this.getEnableEmptyOperations();if(this._bUpdateRequired){this._bUpdateRequired=false;var M=this.getMessageStrip();if(M){M.addStyleClass("sapUiResponsiveMargin");this.insertAggregation("content",M,0);}K=[];m=(this.getBindingInfo("items")||{}).model;var G=function(n,o,i){var B=i.getBinding(n),j;if(B&&o){return o.getObject()[B.getPath()];}j=i.getMetadata();return j.hasProperty(n)?j.getProperty(n).get(i):j.getAggregation(n).get(i);};this.getItems().forEach(function(i){var o=i.getBindingContext(m),F,n,j;if(i.getBinding("key")){o.getObject()[i.getBinding("key").getPath()]=i.getKey();}K.push(F={key:i.getColumnKey(),text:G("text",o,i),tooltip:G("tooltip",o,i),maxLength:G("maxLength",o,i),type:G("type",o,i),typeInstance:G("typeInstance",o,i),formatSettings:G("formatSettings",o,i),precision:G("precision",o,i),scale:G("scale",o,i),isDefault:G("isDefault",o,i),values:G("values",o,i)});if(E){n=i.getNullable();j={};Object.keys(F).forEach(function(s){j[s]=F[s];});k.push(j);this._enhanceFieldOperationsWithEmpty(F,n);this._modifyFieldOperationsBasedOnMaxLength(j);}this._modifyFieldOperationsBasedOnMaxLength(F);},this);this.setKeyFields(K,k);var C=[];m=(this.getBindingInfo("filterItems")||{}).model;this.getFilterItems().forEach(function(F){var o=F.getBindingContext(m);if(F.getBinding("key")&&o){o.getObject()[F.getBinding("key").getPath()]=F.getKey();}C.push({key:F.getKey(),keyField:G("columnKey",o,F),operation:G("operation",o,F),value1:G("value1",o,F),value2:G("value2",o,F),exclude:G("exclude",o,F)});});this.setConditions(C);}};h.prototype._updateOperations=function(){if(this.getMaxIncludes()!=0){this._oOperationsHelper.getIncludeTypes().forEach(function(t){this.setIncludeOperations(this._oOperationsHelper.getIncludeOperationsByType(t),t);}.bind(this));}if(this.getMaxExcludes()!=0){this._oOperationsHelper.getExcludeTypes().forEach(function(t){this.setExcludeOperations(this._oOperationsHelper.getExcludeOperationsByType(t),t);}.bind(this));}};h.prototype._modifyFieldOperationsBasedOnMaxLength=function(F){var o;if(F.maxLength===1||F.maxLength==="1"){o=F.operations?F.operations:this._oConditionPanel.getOperations(F.type);F.operations=[];o.forEach(function(O){if([g.Contains,g.StartsWith,g.EndsWith].indexOf(O)===-1){F.operations.push(O);}},this);}};h.prototype._enhanceFieldOperationsWithEmpty=function(F,n){var i,E;if(["string","stringdate"].indexOf(F.type)>-1||(["date","datetime"].indexOf(F.type)>-1&&n)){i=this._oConditionPanel.getOperations(F.type,false).slice();E=this._oConditionPanel.getOperations(F.type,true).slice();if(i.length===0){i=this._oConditionPanel.getOperations("default",false);}if(E.length===0){E=this._oConditionPanel.getOperations("default",true);}if(i.indexOf(g.Empty)===-1){i.push(g.Empty);}if(E.indexOf(g.NotEmpty)===-1){E.push(g.NotEmpty);}if(!Array.isArray(F.operations)){F.operations=[];}F.operations=F.operations.concat(i).concat(E);}};h.prototype._handleDataChange=function(){var t=this;return function(E){var n=E.getParameter("newData");var o=E.getParameter("operation");var k=E.getParameter("key");var C=E.getParameter("index");var F;var I=-1;t.getFilterItems().some(function(j,i){I=i;return j.getKey()===k;},this);switch(o){case"update":F=t.getFilterItems()[I];if(F){F.setExclude(n.exclude);F.setColumnKey(n.keyField);F.setOperation(n.operation);F.setValue1(n.value1);F.setValue2(n.value2);}t.fireUpdateFilterItem({key:k,index:I,filterItemData:F});t.fireFilterItemChanged({reason:"updated",key:k,index:I,itemData:{columnKey:n.keyField,operation:n.operation,exclude:n.exclude,value1:n.value1,value2:n.value2}});break;case"add":if(C>=0){I++;}F=new c({columnKey:n.keyField,exclude:n.exclude,operation:n.operation});F.setValue1(n.value1);F.setValue2(n.value2);t._bIgnoreBindCalls=true;t.fireAddFilterItem({key:k,index:I,filterItemData:F});t.fireFilterItemChanged({reason:"added",key:k,index:I,itemData:{columnKey:n.keyField,operation:n.operation,exclude:n.exclude,value1:n.value1,value2:n.value2}});t._bIgnoreBindCalls=false;break;case"remove":t._bIgnoreBindCalls=true;t.fireRemoveFilterItem({key:k,index:I});t.fireFilterItemChanged({reason:"removed",key:k,index:I});t._bIgnoreBindCalls=false;break;default:throw"Operation'"+o+"' is not supported yet";}t._notifyChange();};};h.prototype.getConditionPanel=function(){return this._oConditionPanel;};h.prototype.setInnerTitle=function(t){this._oPanel&&this._oPanel.setHeaderText(t);};h.prototype.setSuggestCallback=function(s){if(this._oConditionPanel){this._oConditionPanel.setSuggestCallback(s);}};return h;});
