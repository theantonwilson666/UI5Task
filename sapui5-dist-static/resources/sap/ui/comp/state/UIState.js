/*
 * ! SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/comp/library','sap/ui/base/ManagedObject','sap/ui/comp/odata/MetadataAnalyser','sap/ui/model/odata/AnnotationHelper','sap/ui/model/Context','sap/ui/thirdparty/jquery'],function(c,M,a,A,C,q){"use strict";var U=M.extend("sap.ui.comp.state.UIState",{metadata:{library:"sap.ui.comp",properties:{presentationVariant:{type:"object"},selectionVariant:{type:"object"},variantName:{type:"string"},valueTexts:{type:"object"},semanticDates:{type:"object"}}}});U._getFilterNamesWithValuesForCurrentLanguage=function(v){var p=[],l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().getLanguage();if(v&&v.Texts){v.Texts.some(function(t){if(t.Language===l){t.PropertyTexts.forEach(function(P){var o,f=false;for(var i=0;i<p.length;i++){if(p[i].filterName===P.PropertyName){o=p[i];f=true;break;}}if(P.PropertyName&&P.ValueTexts&&(Object.keys(P.ValueTexts).length>0)){P.ValueTexts.forEach(function(V){if(!o){o={filterName:P.PropertyName,keys:[]};}o.keys.push(V.PropertyValue);});}if(!f&&o&&o.keys.length){p.push(o);}});return true;}return false;});}return p;};U._getFilterNamesWithValuesFromSelectOption=function(s,i){var S=[];if(s&&s.SelectOptions){s.SelectOptions.forEach(function(o){var b=i?(i.indexOf(o.PropertyName)<0):true;if(b){var O={filterName:o.PropertyName,keys:[]};o.Ranges.forEach(function(r){if(r.Option==="EQ"&&r.Sign==="I"){O.keys.push(r.Low);}});S.push(O);}});}return S;};U._determineFiltersWithOnlyKeyValues=function(f,F){var b,I,d=[];f=f||[];F=F||[];F.forEach(function(o){var O={filterName:o.filterName,keys:[]};I=null;f.some(function(e){if(o.filterName===e.filterName){I=e;}return I!==null;});for(var i=0;i<o.keys.length;i++){b=false;if(I){for(var j=0;j<I.keys.length;j++){if(o.keys[i]===I.keys[j]){b=true;break;}}}if(!b){O.keys.push(o.keys[i]);}}if(O.keys.length){d.push(O);}});return d;};U.determineFiltersWithOnlyKeyValues=function(v,s,i){var V=U._getFilterNamesWithValuesForCurrentLanguage(v);var S=U._getFilterNamesWithValuesFromSelectOption(s,i);return U._determineFiltersWithOnlyKeyValues(V,S);};U.calculateValueTexts=function(s,d){var v=null;var f=function(p,e){var P=null;if(!v){v={"Texts":[{"ContextUrl":"","Language":sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().getLanguage(),"PropertyTexts":[]}]};}for(var i=0;i<v.Texts[0].PropertyTexts.length;i++){if(v.Texts[0].PropertyTexts[i].PropertyName===p){P=v.Texts[0].PropertyTexts[i];break;}}if(!P){P={"PropertyName":p,ValueTexts:[]};v.Texts[0].PropertyTexts.push(P);}P.ValueTexts.push({"PropertyValue":e.key,"Text":e.text});};if(d&&s&&s.SelectOptions){s.SelectOptions.forEach(function(S){if(d[S.PropertyName]){if(d[S.PropertyName].ranges){d[S.PropertyName].ranges.forEach(function(e){if(e.hasOwnProperty("text")){f(S.PropertyName,e);}});}if(d[S.PropertyName].items){d[S.PropertyName].items.forEach(function(e){if(e.hasOwnProperty("text")){f(S.PropertyName,e);}});}}});}return v;};U.enrichWithValueTexts=function(p,v){var e=false,t,l,P,E=p;l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().getLanguage().toLowerCase();if(v&&v.Texts){v.Texts.some(function(o){if(o.Language&&o.Language.toLowerCase()===l){t=o;}return t!==null;});if(t&&t.PropertyTexts){if(!P){P=JSON.parse(p);}t.PropertyTexts.forEach(function(o){var b=P[o.PropertyName];if(b&&b.ranges&&o.ValueTexts){o.ValueTexts.forEach(function(V){var d=null,n=-1;if(V.Text){b.ranges.some(function(f,i){if(!f.exclude&&(f.operation==="EQ")&&(f.value1===V.PropertyValue)){d=f;n=i;}return(d!=null);});}if(d){e=true;if(!b.items){b.items=[];}b.items.push({key:V.PropertyValue,text:V.Text});P[o.PropertyName].ranges.splice(n,1);}});}});if(e){E=JSON.stringify(P);}}}return E;};U.createFromSelectionAndPresentationVariantAnnotation=function(v,s,p){var S={};if(s&&s.SelectOptions&&s.SelectOptions.length){S.SelectOptions=s.SelectOptions.map(function(o){return{PropertyName:o.PropertyName.PropertyPath,Ranges:o.Ranges.map(function(r){var b=new C(null,"/");return{Sign:a.getSelectionRangeSignType([r.Sign.EnumMember]),Option:a.getSelectionRangeOptionType([r.Option.EnumMember]),Low:r.Low&&A.format(b,r.Low)||undefined,High:r.High&&A.format(b,r.High)||undefined};})};});}if(s&&s.Parameters&&s.Parameters.length){S.Parameters=s.Parameters.map(function(o){var b=new C(null,"/");return{PropertyName:o.PropertyName.PropertyPath,PropertyValue:o.PropertyValue&&A.format(b,o.PropertyValue)||undefined};});}var P={};if(p&&p.lineItemAnnotation){if(!P.Visualizations){P.Visualizations=[];}var f=[];if(p.lineItemAnnotation.fields){var l=p.lineItemAnnotation.labels;var u=p.lineItemAnnotation.urlInfo;var i=p.lineItemAnnotation.importance;var m=p.lineItemAnnotation.criticality;p.lineItemAnnotation.fields.forEach(function(F){var o={Value:F};o.Label=l[F]?l[F]:null;o.IconUrl=u[F]?u[F]:null;o.Importance=i[F]?i[F]:null;o.Criticality=m[F]?m[F]:null;f.push(o);});}P.Visualizations.push({Type:"LineItem",Content:f});}if(p&&p.chartAnnotation){if(!P.Visualizations){P.Visualizations=[];}P.Visualizations.push({Type:"Chart",Content:{ChartType:p.chartAnnotation.chartType,Measures:p.chartAnnotation.measureFields,MeasureAttributes:Object.keys(p.chartAnnotation.measureAttributes).map(function(b){return{Measure:b,Role:p.chartAnnotation.measureAttributes[b].role};}),Dimensions:p.chartAnnotation.dimensionFields,DimensionAttributes:Object.keys(p.chartAnnotation.dimensionAttributes).map(function(b){return{Dimension:b,Role:p.chartAnnotation.dimensionAttributes[b].role};})}});}if(p&&p.maxItems){P.MaxItems=parseInt(p.maxItems);}if(p&&p.sortOrderFields){P.SortOrder=p.sortOrderFields.map(function(F){return{Property:F.name,Descending:F.descending};});}if(p&&p.groupByFields){P.GroupBy=p.groupByFields;}if(p&&p.requestAtLeastFields){P.RequestAtLeast=p.requestAtLeastFields;}return new U({presentationVariant:!q.isEmptyObject(P)?P:undefined,selectionVariant:!q.isEmptyObject(S)?S:undefined,variantName:v?v:undefined});};U.calcSemanticDates=function(s,d){var S=null;var f=function(p,e){var P=null;if(!S){S={"Dates":[]};}for(var i=0;i<S.Dates.length;i++){if(S.Dates[i].PropertyName===p){P=S.Dates[i];break;}}if(!P){P={"PropertyName":p,"Data":e.conditionTypeInfo.data};S.Dates.push(P);}};if(d&&s&&s.SelectOptions){s.SelectOptions.forEach(function(o){if(d[o.PropertyName]){if(d[o.PropertyName].ranges){if(d[o.PropertyName].hasOwnProperty("conditionTypeInfo")){f(o.PropertyName,d[o.PropertyName]);}}}});}return S;};U.enrichWithSemanticDates=function(p,s){var e=false,P,E=p;if(s&&s.Dates){if(!P){P=JSON.parse(p);}s.Dates.forEach(function(o){var b=P[o.PropertyName];if(b&&b.ranges&&o.Data){e=true;if(!b.items){b.items=[];}b.ranges[0].semantic=o.Data;}});if(e){E=JSON.stringify(P);}}return E;};return U;});
