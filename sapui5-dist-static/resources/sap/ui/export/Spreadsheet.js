/*!
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/core/Core','./ExportDialog','sap/ui/base/EventProvider','sap/ui/Device','sap/ui/export/SpreadsheetExport','sap/base/Log','sap/ui/export/ExportUtils'],function(q,l,C,E,a,D,S,L,b){'use strict';var c='sap.ui.export.Spreadsheet';var d=a.extend(c,{constructor:function(s){a.call(this,s);this._mSettings={customizing:{},fileName:'Export',showProgress:true,worker:true};['count','dataSource','fileName','fileType','showProgress','workbook','worker'].forEach(function(p){if(typeof s[p]!=='undefined'){this._mSettings[p]=p!=='dataSource'?s[p]:this.processDataSource(s[p]);}}.bind(this));this.codeListsPromise=this.codeListsPromise instanceof Promise?this.codeListsPromise:Promise.resolve();}});function e(s,o,m){if(!(m[s]instanceof Object)){m[s]={};}if(!isNaN(o.digits)){m[s].scale=o.digits;}if(!isNaN(o.UnitSpecificScale)){m[s].scale=o.UnitSpecificScale;}if(isNaN(m[s].scale)){delete m[s];}}d.prototype.setDefaultExportSettings=function(p){var s,m,u;var o=C.getConfiguration().getFormatSettings().getCustomCurrencies();if(o){m=p.customizing.currency={};for(s in o){e(s,o[s],m);}}return this.codeListsPromise.then(function(f){var h,U,i;if(!Array.isArray(f)){return;}u=p.customizing.unit={};h=f[0];U=f[1];for(i in h){e(i,h[i],m);}for(i in U){e(i,U[i],u);}}).then(function(){return C.getLibraryResourceBundle('sap.ui.export',true);}).then(function(r){var w=p.workbook.context;if(!(w instanceof Object)){w=p.workbook.context={};}if(!w.title){w.title=r.getText('XLSX_DEFAULT_TITLE');}if(!w.sheetName){w.sheetName=r.getText('XLSX_DEFAULT_SHEETNAME');}});};d.requestCodeLists=function(m){if(!m.isA(['sap.ui.model.odata.ODataMetaModel','sap.ui.model.odata.v4.ODataMetaModel'])){return Promise.resolve([null,null]);}return Promise.all([m.requestCurrencyCodes(),m.requestUnitsOfMeasure()]);};d.prototype.attachBeforeExport=function(o,h,f){return this.attachEvent('beforeExport',o,h,f);};d.prototype.detachBeforeExport=function(h,o){return this.detachEvent('beforeExport',h,o);};d.prototype.attachBeforeSave=function(o,h,f){return this.attachEvent('beforeSave',o,h,f);};d.prototype.detachBeforeSave=function(h,o){return this.detachEvent('beforeSave',h,o);};d.prototype.destroy=function(){a.prototype.destroy.apply(this,arguments);this.cancel();this.bIsDestroyed=true;};d.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null;}return this;};d.prototype.onprogress=function(f,t){var p;if(isNaN(f)||isNaN(t)){return;}p=Math.round(f/t*100);L.debug('Spreadsheet export: '+p+'% loaded.');};var g=function(B){var i;if(typeof B.getTotalSize==='function'){i=B.getTotalSize();}else if(!B.isA('sap.ui.model.TreeBinding')&&typeof B.isLengthFinal==='function'&&B.isLengthFinal()){i=B.getLength();}if(typeof i!=='number'||i<0||isNaN(i)){i=null;}return i;};d.prototype.createDataSourceFromBinding=function(B){var o=[];if(B.isA('sap.ui.model.ClientListBinding')){var f=B.getModel().getProperty(B.getPath());o={data:(f instanceof Array)?f:[],type:'array'};}if(B.isA('sap.ui.model.ClientTreeBinding')){L.error('Unable to create dataSource configuration due to not supported Binding: '+B.getMetadata().getName());}if(typeof B.getDownloadUrl==='function'){var m=B.getModel(),s=B.getDownloadUrl('json'),h=m.sServiceUrl,v=m.isA('sap.ui.model.odata.v4.ODataModel');s=b.interceptUrl(s);h=b.interceptUrl(h);o={type:'odata',dataUrl:s,serviceUrl:h,headers:v?m.getHttpHeaders(true):m.getHeaders(),count:g(B),useBatch:v||m.bUseBatch};if(m.getMetaModel()&&typeof m.getMetaModel().requestCurrencyCodes==='function'&&typeof m.getMetaModel().requestUnitsOfMeasure==='function'){this.codeListsPromise=d.requestCodeLists(m.getMetaModel(),this._mSettings);}}return o;};d.prototype.processDataSource=function(o){var m=null;var s=typeof o;if(!o){return;}if(s=='string'){return{count:this._mSettings.count,dataUrl:o,type:'odata',useBatch:false};}if(s!='object'){L.error('Spreadsheet#setDataSource: Unable to apply data source of type '+s);return;}if(o instanceof Array){m={data:o,type:'array'};}if(o.dataUrl){m=o;}if(o.isA&&o.isA(['sap.ui.model.ListBinding','sap.ui.model.TreeBinding'])){m=this.createDataSourceFromBinding(o);}return m;};function _(s,p){return new Promise(function(r,R){var f;var h=D.system.desktop?2000000:100000;var n=p.dataSource.type=='array'?p.dataSource.data.length:p.dataSource.count;var i=p.workbook.columns.length;function o(m){if(m.progress){if(f){f.updateStatus(m.fetched,m.total);}s.onprogress(m.fetched,m.total);}if(m.finished&&s.process!==null){s.process=null;if(!m.spreadsheet){R('Spreadsheet export: The process was canceled');return;}var k=s.fireEvent('beforeSave',{data:m.spreadsheet},true,true);if(f){window.setTimeout(f.finish,1000);}if(k){b.saveAsFile(new Blob([m.spreadsheet],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),p.fileName);}r();}if(typeof m.error!='undefined'){var t=m.error.message||m.error;s.process=null;if(f){f.finish();}R(t);E.showErrorMessage(t);}}function j(){if(!p.showProgress){if(s.process){R('Cannot start export: the process is already running');return;}s.process=S.execute(p,o);return;}E.getProgressDialog().then(function(k){f=k;if(s.process){R('Cannot start export: the process is already running');return;}f.oncancel=function(){return s.process&&s.process.cancel();};f.open();f.updateStatus(0,p.dataSource.count);s.process=S.execute(p,o);});}if(i<=0){R('No columns to export.');}else if(n*i>h||!n){E.showWarningDialog({rows:n,columns:i}).then(j).catch(function(){R('Export cancelled by the user.');});}else{j();}});}d.prototype.build=function(){var p=this._mSettings;if(this.bIsDestroyed){var m=c+': Cannot trigger build - the object has been destroyed';L.error(m);return Promise.reject(m);}return this.setDefaultExportSettings(p).then(function(){this.fireEvent('beforeExport',{exportSettings:p},false,false);b.validateSettings(p);return _(this,p);}.bind(this));};return d;});
