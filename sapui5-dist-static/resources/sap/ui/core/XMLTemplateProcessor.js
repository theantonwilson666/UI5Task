/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/thirdparty/jquery','sap/ui/base/DataType','sap/ui/base/ManagedObject','sap/ui/core/CustomData','./mvc/View','./mvc/EventHandlerResolver','./ExtensionPoint','./StashedControlSupport','sap/ui/base/SyncPromise','sap/base/Log','sap/base/util/ObjectPath','sap/base/util/values','sap/base/assert','sap/base/security/encodeXML','sap/base/util/LoaderExtensions','sap/base/util/JSTokenizer','sap/base/util/isEmptyObject'],function(q,D,M,C,V,E,a,S,b,L,O,v,c,d,f,J,g){"use strict";function h(e,i,N,j,R){var B=M.bindingParser(i,j,true,false,false,false,R);if(B&&typeof B==="object"){return B;}var p=i=B||i;var A=D.getType(e);if(A){if(A instanceof D){p=A.parseValue(i,{context:j,locals:R});if(!A.isValid(p)){L.error("Value '"+i+"' is not valid for type '"+A.getName()+"'.");}}}else{throw new Error("Property "+N+" has unknown type "+e);}return typeof p==="string"?M.bindingParser.escape(p):p;}function l(e){return e.localName||e.baseName||e.nodeName;}var X="http://www.w3.org/1999/xhtml";var k="http://www.w3.org/2000/xmlns/";var m="http://www.w3.org/2000/svg";var n="sap.ui.core";var o="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1";var r="http://schemas.sap.com/sapui5/extension/sap.ui.core.support.Support.info/1";var s="http://schemas.sap.com/sapui5/extension/sap.ui.core.xmlcomposite/1";var U="http://schemas.sap.com/sapui5/extension/sap.ui.core.Internal/1";var P="http://schemas.sap.com/sapui5/preprocessorextension/";function t(A,e){function i(p,B,F,G,H){var I,K,N=[];for(I=p.firstChild;I;I=I.nextSibling){K=e(p,B,F,I,false,G,H);if(K){N.push(K.unwrap());}}return b.resolve(N);}function j(p,B,F,G,H){var I,K=Promise.resolve(),N=[G];for(I=p.firstChild;I;I=I.nextSibling){K=K.then(e.bind(null,p,B,F,I,false,G,H));N.push(K);}return Promise.all(N);}return A?j:i;}var u={};u.loadTemplate=function(e,i){var R=e.replace(/\./g,"/")+("."+(i||"view")+".xml");return f.loadResource(R).documentElement;};u.loadTemplatePromise=function(e,i){var R=e.replace(/\./g,"/")+("."+(i||"view")+".xml");return f.loadResource(R,{async:true}).then(function(j){return j.documentElement;});};u.parseViewAttributes=function(e,j,p){var A=j.getMetadata().getAllProperties();for(var i=0;i<e.attributes.length;i++){var B=e.attributes[i];if(B.name==='controllerName'){j._controllerName=B.value;}else if(B.name==='resourceBundleName'){j._resourceBundleName=B.value;}else if(B.name==='resourceBundleUrl'){j._resourceBundleUrl=B.value;}else if(B.name==='resourceBundleLocale'){j._resourceBundleLocale=B.value;}else if(B.name==='resourceBundleAlias'){j._resourceBundleAlias=B.value;}else if(B.name==='class'){j.addStyleClass(B.value);}else if(!p[B.name]&&A[B.name]){p[B.name]=h(A[B.name].type,B.value,B.name,j._oContainingView.oController);}}};u.enrichTemplateIds=function(e,i){u.enrichTemplateIdsPromise(e,i,false);return e;};u.enrichTemplateIdsPromise=function(e,i,A){return z(e,i,true,A).then(function(){return e;});};u.parseTemplate=function(e,i){return u.parseTemplatePromise(e,i,false).unwrap();};u.parseTemplatePromise=function(i,j,A,B){return z(i,j,false,A,B).then(function(){var p=b.resolve(arguments[0]);if(j.isA("sap.ui.core.Fragment")){return p;}var F=arguments;if(j.isA("sap.ui.core.mvc.View")&&j._epInfo&&j._epInfo.all.length>0){p=T(A,j,{"content":j._epInfo.all});}return p.then(function(){if(Array.isArray(F[0])){F[0]=F[0].filter(function(e){return!e._isExtensionPoint;});}return F[0];});});};function w(R){var e,i=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/;if(!R||typeof R!=="object"){e="core:require in XMLView can't be parsed to a valid object";}else{Object.keys(R).some(function(K){if(!i.test(K)){e="core:require in XMLView contains invalid identifier: '"+K+"'";return true;}if(!R[K]||typeof R[K]!=="string"){e="core:require in XMLView contains invalide value '"+R[K]+"'under key '"+K+"'";return true;}});}return e;}function x(j,A){var p=j.getAttributeNS(n,"require"),R,B,F;if(p){try{R=J.parseJS(p);}catch(e){L.error("Require attribute can't be parsed on Node: ",j.nodeName);throw e;}F=w(R);if(F){throw new Error(F+" on Node: "+j.nodeName);}if(!g(R)){B={};if(A){return new Promise(function(G,H){var I=Object.keys(R).reduce(function(i,K){B[K]=sap.ui.require(R[K]);return i&&B[K]!==undefined;},true);if(I){G(B);return;}sap.ui.require(v(R),function(){var K=arguments;Object.keys(R).forEach(function(N,i){B[N]=K[i];});G(B);},H);});}else{Object.keys(R).forEach(function(K){B[K]=sap.ui.requireSync(R[K]);});return b.resolve(B);}}}}function T(A,e,i){var j=b.resolve();if(!g(i)){var B=[];var R;if(A){j=new Promise(function(p){R=p;});}Object.keys(i).forEach(function(F){var G=i[F];G.forEach(function(H){H.targetControl=e;var I=sap.ui.require(H.providerClass);if(I){B.push(I.applyExtensionPoint(H));}else{var p=new Promise(function(K,N){sap.ui.require([H.providerClass],function(Q){K(Q);},N);}).then(function(K){return K.applyExtensionPoint(H);});B.push(p);}});});if(A){Promise.all(B).then(R);}}return j;}function y(e,i,p){var j=p;for(var A=0;A<100;A++){var R=e.lookupNamespaceURI(j);if(R==null||R===i){return j;}j=p+A;}throw new Error("Could not find an unused namespace prefix after 100 tries, giving up");}function z(p,A,B,F,G){var R=[],I=y(p,U,"__ui5"),H=x(p,F)||b.resolve();p.setAttributeNS(k,"xmlns:"+I,U);F=F&&A._sProcessingMode==="sequential";L.debug("XML processing mode is "+(F?"sequential":"default"),"","XMLTemplateProcessor");var K=sap.ui.getCore().getConfiguration().getDesignMode();if(K){A._sapui_declarativeSourceInfo={xmlNode:p,xmlRootNode:A._oContainingView===A?p:A._oContainingView._sapui_declarativeSourceInfo.xmlRootNode};}var N=A.sViewName||A._sFragmentName;if(!N){var Q=A;var W=0;while(++W<1000&&Q&&Q!==Q._oContainingView){Q=Q._oContainingView;}N=Q.sViewName;}if(A.isSubView()){a1(p,true,false,H);}else{if(p.localName==="View"&&p.namespaceURI!=="sap.ui.core.mvc"){L.warning("XMLView root node must have the 'sap.ui.core.mvc' namespace, not '"+p.namespaceURI+"'"+(N?" (View name: "+N+")":""));}b1(p,false,false,H);}var i=0;function Y(){for(;i<R.length;i++){var e=R[i];if(e&&typeof e.then==='function'){return e.then(Z).then(Y);}}return R;}function Z(e){var j=[i,1].concat(e);Array.prototype.splice.apply(R,j);}return H.then(Y);function $(e){return e;}function _(e){return A._oContainingView.createId(e);}function a1(p,e,j,j1){if(p.nodeType===1){var k1=l(p);if(p.namespaceURI===X||p.namespaceURI===m){R.push("<"+k1+" ");var l1=false;for(var i=0;i<p.attributes.length;i++){var m1=p.attributes[i];var n1=m1.value;if(m1.name==="id"){l1=true;n1=h1(A,p);}R.push(m1.name+"=\""+d(n1)+"\" ");}if(e===true){R.push("data-sap-ui-preserve"+"=\""+A.getId()+"\" ");if(!l1){R.push("id"+"=\""+A.getId()+"\" ");}}R.push(">");var o1=p;if(window.HTMLTemplateElement&&p instanceof HTMLTemplateElement&&p.content instanceof DocumentFragment){o1=p.content;}b1(o1,false,false,j1);R.push("</"+k1+">");}else if(k1==="FragmentDefinition"&&p.namespaceURI===n){b1(p,false,true,j1);}else{H=H.then(function(){return e1(p,j1).then(function(r1){for(var i=0;i<r1.length;i++){var s1=r1[i];if(A.getMetadata().hasAggregation("content")){A._epInfo=A._epInfo||{contentControlsCount:0,last:null,all:[]};if(s1._isExtensionPoint){s1.index=A._epInfo.contentControlsCount;s1.targetControl=A;s1.aggregationName="content";if(A._epInfo.last){A._epInfo.last._nextSibling=s1;}A._epInfo.last=s1;A._epInfo.all.push(s1);}else{A._epInfo.contentControlsCount++;A.addAggregation("content",s1);}}else if(A.getMetadata().hasAssociation(("content"))){A.addAssociation("content",s1);}}return r1;});});R.push(H);}}else if(p.nodeType===3&&!j){var p1=p.textContent||p.text,q1=l(p.parentNode);if(p1){if(q1!="style"){p1=d(p1);}R.push(p1);}}}function b1(p,e,j,j1){var k1=p.childNodes;for(var i=0;i<k1.length;i++){a1(k1[i],e,j,j1);}}function c1(e,j){var j1;var k1=sap.ui.getCore().getLoadedLibraries();q.each(k1,function(o1,p1){if(e===p1.namespace||e===p1.name){j1=p1.name+"."+((p1.tagNames&&p1.tagNames[j])||j);}});j1=j1||e+"."+j;function l1(n1){if(!n1){L.error("Control '"+j1+"' did not return a class definition from sap.ui.define.","","XMLTemplateProcessor");n1=O.get(j1);}if(!n1){L.error("Can't find object class '"+j1+"' for XML-view","","XMLTemplateProcessor");}return n1;}var m1=j1.replace(/\./g,"/");var n1=sap.ui.require(m1);if(!n1){if(F){return new Promise(function(o1,p1){sap.ui.require([m1],function(n1){n1=l1(n1);o1(n1);},p1);});}else{n1=sap.ui.requireSync(m1);n1=l1(n1);}}return n1;}function d1(e,j,j1){if(e.namespaceURI===X||e.namespaceURI===m){var id=e.attributes['id']?e.attributes['id'].textContent||e.attributes['id'].text:null;if(B){return u.enrichTemplateIdsPromise(e,A,F).then(function(){return[];});}else{var l1=function(k1){var n1={id:id?h1(A,e,id):undefined,xmlNode:e,containingView:A._oContainingView,processingMode:A._sProcessingMode};if(A.fnScopedRunWithOwner){return A.fnScopedRunWithOwner(function(){return new k1(n1);});}return new k1(n1);};if(F){return new Promise(function(k1,n1){sap.ui.require(["sap/ui/core/mvc/XMLView"],function(m1){k1([l1(m1)]);},n1);});}else{var m1=sap.ui.requireSync("sap/ui/core/mvc/XMLView");return b.resolve([l1(m1)]);}}}else{return e1(e,j,j1);}}function e1(e,j,j1){if(l(e)==="ExtensionPoint"&&e.namespaceURI===n){if(B){return b.resolve([]);}else{var k1=A instanceof V?A._oContainingView:A;var l1=a._factory.bind(null,k1,e.getAttribute("name"),function(){var n1=b.resolve();var o1=[];var p1=e.childNodes;for(var i=0;i<p1.length;i++){var q1=p1[i];if(q1.nodeType===1){n1=n1.then(d1.bind(null,q1,j,j1));o1.push(n1);}}return b.all(o1).then(function(r1){var s1=[];r1.forEach(function(t1){s1=s1.concat(t1);});return s1;});});return b.resolve(A.fnScopedRunWithOwner?A.fnScopedRunWithOwner(l1):l1());}}else{var m1=c1(e.namespaceURI,l(e));if(m1&&typeof m1.then==='function'){return m1.then(function(n1){return f1(e,n1,j,j1);});}else{return f1(e,m1,j,j1);}}}function f1(j1,k1,l1,m1){var ns=j1.namespaceURI,o1={},p1={},q1="",r1=[],s1=null,t1=null,u1=j1.getAttribute("stashed")==="true";if(!B){j1.removeAttribute("stashed");}if(!k1){return b.resolve([]);}var v1=k1.getMetadata();var w1=v1.getAllSettings();var x1=x(j1,F);if(x1){l1=b.all([l1,x1]).then(function(e){return Object.assign({},e[0],e[1]);});}l1=l1.then(function(j){if(g(j)){j=null;}if(!B){for(var i=0;i<j1.attributes.length;i++){var n1=j1.attributes[i],C1=n1.name,D1=n1.namespaceURI,E1=w1[C1],F1=n1.value;if(C1==="id"){o1[C1]=h1(A,j1,F1);}else if(C1==="class"){q1+=F1;}else if(C1==="viewName"){o1[C1]=F1;}else if(C1==="fragmentName"){o1[C1]=F1;o1['containingView']=A._oContainingView;}else if((C1==="binding"&&!E1)||C1==='objectBindings'){if(!u1){var G1=M.bindingParser(F1,A._oContainingView.oController);if(G1){o1.objectBindings=o1.objectBindings||{};o1.objectBindings[G1.model||undefined]=G1;}}}else if(C1==='metadataContexts'){if(!u1){var H1=null;try{H1=u._calculatedModelMapping(F1,A._oContainingView.oController,true);}catch(e){L.error(A+":"+e.message);}if(H1){o1.metadataContexts=H1;if(u._preprocessMetadataContexts){u._preprocessMetadataContexts(k1.getMetadata().getName(),o1,A._oContainingView.oController);}}}}else if(C1.indexOf(":")>-1){D1=n1.namespaceURI;if(D1===o){var I1=l(n1);r1.push(new C({key:I1,value:h("any",F1,I1,A._oContainingView.oController)}));}else if(D1===r){t1=F1;}else if(D1&&D1.startsWith(P)){L.debug(A+": XMLView parser ignored preprocessor attribute '"+C1+"' (value: '"+F1+"')");}else if(D1===U&&l(n1)==="invisible"){E1=w1.visible;if(E1&&E1._iKind===0&&E1.type==="boolean"){o1.visible=false;}}else if(D1===n||D1===U||C1.startsWith("xmlns:")){}else{if(!s1){s1={};}if(!s1.hasOwnProperty(n1.namespaceURI)){s1[n1.namespaceURI]={};}s1[n1.namespaceURI][l(n1)]=n1.nodeValue;L.debug(A+": XMLView parser encountered unknown attribute '"+C1+"' (value: '"+F1+"') with unknown namespace, stored as sap-ui-custom-settings of customData");}}else if(E1&&E1._iKind===0){o1[C1]=h(E1.type,F1,C1,A._oContainingView.oController,j);}else if(E1&&E1._iKind===1&&E1.altTypes){if(!u1){o1[C1]=h(E1.altTypes[0],F1,C1,A._oContainingView.oController,j);}}else if(E1&&E1._iKind===2){if(!u1){var G1=M.bindingParser(F1,A._oContainingView.oController,false,false,false,false,j);if(G1){o1[C1]=G1;}else{L.error(A+": aggregations with cardinality 0..n only allow binding paths as attribute value (wrong value: "+C1+"='"+F1+"')");}}}else if(E1&&E1._iKind===3){if(!u1){o1[C1]=_(F1);}}else if(E1&&E1._iKind===4){if(!u1){o1[C1]=F1.split(/[\s,]+/g).filter($).map(_);}}else if(E1&&E1._iKind===5){if(!u1){var J1=[];E.parse(F1).forEach(function(K1){var L1=E.resolveEventHandler(K1,A._oContainingView.oController,j);if(L1){J1.push(L1);}else{L.warning(A+": event handler function \""+K1+"\" is not a function or does not exist in the controller.");}});if(J1.length){o1[C1]=J1;}}}else if(E1&&E1._iKind===-1){if(V.prototype.isPrototypeOf(k1.prototype)&&C1=="async"){o1[C1]=h(E1.type,F1,C1,A._oContainingView.oController,j);}else{L.warning(A+": setting '"+C1+"' for class "+v1.getName()+" (value:'"+F1+"') is not supported");}}else{c(C1==='xmlns',A+": encountered unknown setting '"+C1+"' for class "+v1.getName()+" (value:'"+F1+"')");if(u._supportInfo){u._supportInfo({context:j1,env:{caller:"createRegularControls",error:true,info:"unknown setting '"+C1+"' for class "+v1.getName()}});}}}if(s1){r1.push(new C({key:"sap-ui-custom-settings",value:s1}));}if(r1.length>0){o1.customData=r1;}}return j;});var y1=t(F,z1);function z1(j1,A1,B1,e,n1,l1,m1){var C1,D1;if(e.nodeType===1){if(e.namespaceURI===s){o1[l(e)]=e.querySelector("*");return;}C1=e.namespaceURI===ns&&B1&&B1[l(e)];if(C1){return y1(e,C1,false,l1,m1);}else if(A1){if(!n1&&e.getAttribute("stashed")==="true"&&!B){var E1=e;e=e.cloneNode();E1.removeAttribute("stashed");D1=function(){var j=h1(A,e);S.createStashedControl({wrapperId:j,fnCreate:function(){var G1=F;F=false;try{return z1(j1,A1,B1,E1,true,l1,m1).unwrap();}finally{F=G1;}}});};if(A.fnScopedRunWithOwner){A.fnScopedRunWithOwner(D1);}else{D1();}e.removeAttribute("visible");g1(e,"invisible");}if(o1[A1.name]&&o1[A1.name].path&&typeof o1[A1.name].path==="string"){m1={aggregation:A1.name,id:o1.id};}return d1(e,l1,m1).then(function(G1){for(var j=0;j<G1.length;j++){var H1=G1[j];var I1=A1.name;if(H1._isExtensionPoint){if(!o1[I1]){o1[I1]=[];}var J1=p1[I1];if(!J1){J1=p1[I1]=[];}H1.index=o1[I1].length;H1.aggregationName=I1;H1.closestAggregationBindingCarrier=m1&&m1.id;H1.closestAggregationBinding=m1&&m1.aggregation;var K1=J1[J1.length-1];if(K1){K1._nextSibling=H1;}J1.push(H1);}else if(A1.multiple){if(!o1[I1]){o1[I1]=[];}if(typeof o1[I1].path==="string"){c(!o1[I1].template,"list bindings support only a single template object");o1[I1].template=H1;}else{o1[I1].push(H1);}}else{c(!o1[I1],"multiple aggregates defined for aggregation with cardinality 0..1");o1[I1]=H1;}}return G1;});}else if(l(j1)!=="FragmentDefinition"||j1.namespaceURI!==n){throw new Error("Cannot add direct child without default aggregation defined for control "+v1.getElementName());}}else if(e.nodeType===3){var F1=e.textContent||e.text;if(F1&&F1.trim()){throw new Error("Cannot add text nodes as direct child of an aggregation. For adding text to an aggregation, a surrounding html tag is needed: "+F1.trim());}}}var A1=v1.getDefaultAggregation();var B1=v1.getAllAggregations();return y1(j1,A1,B1,l1,m1).then(function(){var e;var j=b.resolve();var n1=b.resolve();var C1=j1.getAttribute("type");if(B&&j1.hasAttribute("id")){i1(A,j1);}else if(!B){if(k1.getMetadata().isA("sap.ui.core.Fragment")&&C1!=="JS"&&A._sProcessingMode==="sequential"){o1.processingMode="sequential";}if(k1.getMetadata().isA("sap.ui.core.mvc.View")){var D1=function(){if(!k1._sType&&!o1.viewName){o1.viewName="module:"+k1.getMetadata().getName().replace(/\./g,"/");}if(k1.getMetadata().isA("sap.ui.core.mvc.XMLView")&&A._sProcessingMode==="sequential"){o1.processingMode="sequential";}return V._legacyCreate(o1,undefined,k1._sType||C1);};if(A.fnScopedRunWithOwner){e=A.fnScopedRunWithOwner(D1);}else{e=D1();}}else if(k1.getMetadata().isA("sap.ui.core.Fragment")&&F){var E1="sap/ui/core/Fragment";var F1=sap.ui.require(E1);o1.name=o1.name||o1.fragmentName;if(F1){n1=F1.load(o1);}else{n1=new Promise(function(H1,I1){sap.ui.require([E1],function(F1){F1.load(o1).then(function(J1){H1(J1);});},I1);});}}else{var G1=function(){var H1;if(A.fnScopedRunWithOwner){H1=A.fnScopedRunWithOwner(function(){var H1=new k1(o1);return H1;});}else{H1=new k1(o1);}j=T(F,H1,p1);return H1;};if(G&&G.fnRunWithPreprocessor){e=G.fnRunWithPreprocessor(G1);}else{e=G1();}}}return n1.then(function(H1){return H1||e;}).then(function(H1){if(q1&&H1.addStyleClass){H1.addStyleClass(q1);}if(!H1){H1=[];}else if(!Array.isArray(H1)){H1=[H1];}if(u._supportInfo&&H1){for(var i=0,I1=H1.length;i<I1;i++){var J1=H1[i];if(J1&&J1.getId()){var K1=u._supportInfo({context:j1,env:{caller:"createRegularControls",nodeid:j1.getAttribute("id"),controlid:J1.getId()}}),L1=t1?t1+",":"";L1+=K1;u._supportInfo.addSupportInfo(J1.getId(),L1);}}}if(K){H1.forEach(function(J1){if(v1.getCompositeAggregationName){var M1=j1.getElementsByTagName(J1.getMetadata().getCompositeAggregationName());for(var i=0;i<M1.length;i++){j1.removeChild(M1[0]);}}J1._sapui_declarativeSourceInfo={xmlNode:j1,xmlRootNode:A._sapui_declarativeSourceInfo.xmlRootNode,fragmentName:v1.getName()==='sap.ui.core.Fragment'?o1['fragmentName']:null};});}return j.then(function(){return H1;});});});}function g1(e,j){var j1=y(e,U,I);e.setAttributeNS(U,j1+":"+j,"true");}function h1(A,p,e){if(p.getAttributeNS(U,"id")){return p.getAttribute("id");}else{return _(e?e:p.getAttribute("id"));}}function i1(A,p){p.setAttribute("id",_(p.getAttribute("id")));g1(p,"id");}}u._preprocessMetadataContexts=null;u._calculatedModelMapping=function(B,e,A){var j,p={},F=M.bindingParser(B,e);function G(H){if(H.length%2===0){throw new Error("The last entry is no binding");}for(var i=1;i<=H.length;i=i+2){if(typeof H[i-1]=='string'){throw new Error("Binding expected not a string");}if(H[i]){if((typeof H[i]!='string')||(H[i]!=",")){throw new Error("Missing delimiter ','");}}}}if(F){if(!F.formatter){j=F;F={parts:[j]};}else{G(F.formatter.textFragments);}for(var i=0;i<F.parts.length;i++){j=F.parts[i];p[j.model]=p[j.model]||(A?[]:null);if(Array.isArray(p[j.model])){p[j.model].push(j);}else{p[j.model]=j;}}}return p;};return u;},true);
