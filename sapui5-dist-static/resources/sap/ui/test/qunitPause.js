/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define("sap/ui/test/qunitPause",[],function(){"use strict";var P={NONE:"none",TIMEOUT:"timeout",ASSERT:"assert"};var t={};var _={pause:[],resume:[]};var a={};var p=false;var b=P.NONE;function s(){return b!==P.NONE;}function c(){return b.indexOf(P.ASSERT)>-1;}function i(){return QUnit.test.length===2;}function d(){var O=window.setTimeout;window.setTimeout=function w(C,D){var I=O.apply(null,arguments);t[I]={delay:D||0,callback:C,startTime:Date.now()};return I;};}function e(){var n=i()?"pushResult":"push";var q=QUnit.assert[n];QUnit.assert[n]=function(){var r=this;var A=arguments;var u=i()?arguments[0].result:arguments[0];var I=r.test&&sap.ui.test&&sap.ui.test.Opa&&sap.ui.test.Opa.config.testName===r.test.testName;if(I&&!u&&c()){var O=new sap.ui.test.Opa();var v=true;h();var w=new Promise(function(x){g(function(){if(v){v=false;x();}});q.apply(r,A);});O.iWaitForPromise(w);}else{q.apply(r,A);}};}function f(){if(s()){a=t[QUnit.config.timeout];if(!a){throw new Error("QUnitPause should be loaded before QUnit!");}a.originalCallback=a.callback;a.callback=function(){h();g(function(){var n=Math.max(0,a.delay-(Date.now()-a.startTime));QUnit.config.timeout=setTimeout(a.originalCallback,n);});};clearTimeout(QUnit.config.timeout);QUnit.config.timeout=setTimeout(a.callback,QUnit.config.testTimeout);t={};}}function o(){return l("pause").apply(this,arguments);}function g(){return l("resume").apply(this,arguments);}function h(){if(s()&&!p){p=true;m("pause");clearTimeout(QUnit.config.timeout);}else if(!c()){setTimeout(function(){j();},0);}}function j(){m("resume",true);p=false;}function k(r){var I=false;for(var K in P){if(P[K]===r){I=true;}}return I;}function l(E){return function(C,T,A){_[E].push({cb:C,context:T,args:A,called:false});};}function m(E,C){_[E].forEach(function(L){if(!C||!L.called){L.cb.apply(L.context,L.args);L.called=true;}});}return{PAUSE_RULES:P,paused:p,get pauseRule(){return b;},set pauseRule(r){var R=r.split(",");b="";var n=R.filter(k).join(",");b=n?n:P.NONE;},shouldPause:s,shouldPauseOnAssert:c,setupAfterQUnit:e,setupBeforeQUnit:d,setupBeforeOpaTest:f,onPause:o,onResume:g,emitPause:h,emitResume:j};},true);
