/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2013 SAP AG. All rights reserved
 */
sap.ui.define(["sap/landvisz/library","sap/ui/thirdparty/jquery"],function(l,q){"use strict";var C=l.ConnectionLine;var a=function(){};a.init=function(){this.setting={showLog:true,animationSpeed:10};this.initialized=false;this.initialRow=0;this.initialCol=0;this.allConnections=[];this.clvConnections=[];this.sourceDoneList={};this.targetDoneList={};this.nodeDoneList={};this.sourceConnectionMatrix={};this.targetConnectionMatrix={};this.connectionMatrix={};this.topPostions={};this.connectedNodesLayout={};this.svgForConnections=null;this.isConnectionEntity=false;this.isSystemEntity=false;};a.hideConnections=function(){if(this.svgForConnections){q(this.svgForConnections.canvas).hide();}};a.getConnectedNodesLayoutTrack=function(c){if(c.length>0){this.allConnections=c;if(q.isEmptyObject(this.connectedNodesLayout)){for(var i=0;i<this.allConnections.length;i++){this.getAllTargets(this.allConnections[i].getSource());this.getAllSources(this.allConnections[i].getSource());}}var n={};n.row=this.initialRow;n.col=this.initialCol;var b;var d;var f=true;for(var k in this.sourceConnectionMatrix){this.connectionMatrix[k]=[];this.connectionMatrix[k].sources=this.sourceConnectionMatrix[k];this.connectionMatrix[k].targets=this.targetConnectionMatrix[k];if(!this.connectedNodesLayout[k]&&f==true){this.connectedNodesLayout[k]=n;b=this.connectionMatrix[k];d=k;f=false;}}this.assignIndexToConnectedNodes(b,d);}return this.connectedNodesLayout;};a.assignIndexToConnectedNodes=function(n,k){if(n.targets.length>0)this.assignTargetIndex(k);if(n.sources.length>0)this.assignSourceIndex(k)};a.assignTargetIndex=function(n){var b=this.connectionMatrix[n];var r=this.connectedNodesLayout[n].row;var c=this.connectedNodesLayout[n].col;var t;for(var i=0;i<b.targets.length;i++){t=this.connectionMatrix[b.targets[i]];if(i==0)c++;else{r++;if(t&&t.targets.length>0)c=c+t.targets.length-1;}var d={};d.row=r;d.col=c;if(!this.connectedNodesLayout[b.targets[i]])this.connectedNodesLayout[b.targets[i]]=d;if(t)this.assignIndexToConnectedNodes(t,b.targets[i]);}};a.assignSourceIndex=function(n){var b=this.connectionMatrix[n];var r=this.connectedNodesLayout[n].row;var c=this.connectedNodesLayout[n].col;for(var i=0;i<b.sources.length;i++){if(!this.connectedNodesLayout[b.sources[i]]){c--;r++;var d={};d.row=r;d.col=c;this.connectedNodesLayout[b.sources[i]]=d;if(this.connectionMatrix[b.targets[i]])this.assignIndexToConnectedNodes(this.connectionMatrix[b.targets[i]],b.targets[i]);}}};a.getAllTargets=function(s){var t=[];if(!this.sourceDoneList[s]){this.sourceDoneList[s]=true;for(var j=0;j<this.allConnections.length;j++){if(s==this.allConnections[j].getSource()){t.push(this.allConnections[j].getTarget());}}this.targetConnectionMatrix[s]=t;}};a.getAllSources=function(s){var b=[];if(!this.targetDoneList[s]){this.targetDoneList[s]=true;for(var j=0;j<this.allConnections.length;j++){if(s==this.allConnections[j].getTarget()){b.push(this.allConnections[j].getSource());}}this.sourceConnectionMatrix[s]=b;}};a.getConnectedNodesLayout=function(c){if(c.length>0){this.allConnections=c;if(q.isEmptyObject(this.connectedNodesLayout)){for(var i=0;i<this.allConnections.length;i++){this.getSourceTargetConnections(this.allConnections[i].getSource());this.getTargetSourceConnections(this.allConnections[i].getTarget());}for(var k in this.sourceConnectionMatrix){this.connectionMatrix[k]=q.merge(q.merge([],this.sourceConnectionMatrix[k]),this.targetConnectionMatrix[k]);}var n={};n.row=this.initialRow;n.col=this.initialCol;for(var k in this.connectionMatrix){if(this.connectionMatrix[k].length==1){this.connectedNodesLayout[k]=n;this.nodeDoneList[k]=true;if(!this.topPostions[this.initialRow]){this.topPostions[this.initialRow]=[];}this.topPostions[this.initialRow].push(this.initialCol);this.findConnectedNodes(k);break;}}}}return this.connectedNodesLayout;};a.getAllConnections=function(){if(this.allConnections.length==0){q(this.connectionsData).find('CONNECTION').each(function(){var c=this.parseSingleConnection(q(this));this.allConnections.push(c);});}return this.allConnections;};a.parseSingleConnection=function(c){var p={};q(c).children('DATA').each(function(){var b=q(this).attr('property');var v=typeof q(this).attr('value')==="string"?q(this).attr('value').trim():q(this).attr('value')!=null?String(q(this).attr('value')).trim():"";switch(b.toUpperCase()){case'CONNECTION-UUID':p.uuid=v;break;case'CONNECTION-TYPE':p.type=v;break;case'TEXT':p.text=v;break;case'SOURCE-ENTITY-UUID':p.source=v;break;case'TARGET-ENTITY-UUID':p.target=v;break;}});return p;};a.getSourceTargetConnections=function(s){var b=[];if(!this.sourceDoneList[s]){this.sourceDoneList[s]=true;for(var j=0;j<this.allConnections.length;j++){if(s==this.allConnections[j].getSource()){b.push(this.allConnections[j].getTarget());this.getSourceTargetConnections(this.allConnections[j].getTarget());}}this.sourceConnectionMatrix[s]=b;}};a.getTargetSourceConnections=function(t){var b=[];if(!this.targetDoneList[t]){this.targetDoneList[t]=true;for(var j=0;j<this.allConnections.length;j++){if(t==this.allConnections[j].getTarget()){b.push(this.allConnections[j].getSource());this.getTargetSourceConnections(this.allConnections[j].getSource());}}this.targetConnectionMatrix[t]=b;}};a.findConnectedNodes=function(n){var b=this.connectionMatrix[n];var c=0;var r=this.connectedNodesLayout[n].row;var d=this.connectedNodesLayout[n].col;var e=[];for(var i=0;i<b.length;i++){if(!this.nodeDoneList[b[i]]){e[c]=b[i];c++;}}c=b.length-e.length;for(var i=0;i<e.length;i++){c++;if(c==1){d++;}else{if(c==2){if(r!=0){var f=d;var g=r-1;if(b.length>2&&!this.inTopPosition(g,f)){r--;}}d++;}else if(c>=3){r++;}}var h={};h.row=r;h.col=d;this.connectedNodesLayout[e[i]]=h;this.nodeDoneList[e[i]]=true;if(!this.topPostions[r]){this.topPostions[r]=[];}this.topPostions[r].push(d);var j=this.findConnectedNodes(e[i]);r=j;}return r;};a.inTopPosition=function(r,c){if(this.topPostions[r]){for(var i=0;i<this.topPostions[r].length;i++){if(this.topPostions[r][i]==c){return true;}}}return false;};a.renderConnections=function(s,c,t){for(var i=0;i<this.allConnections.length;i++){var b=this.allConnections[i];b.sourceEntity=this.getEntity(s,c,this.allConnections[i].getSource());b.targetEntity=this.getEntity(s,c,this.allConnections[i].getTarget());this.clvConnections.push(b);}if(this.clvConnections.length==0)return;var e=this.svgForConnections.append("marker").attr("id","endMarker").attr("viewBox","0 0 10 10").attr("markerWidth",10).attr("markerHeight",3).attr("refX",7).attr("refY",4).attr("orient","auto").attr("markerUnits","strokeWidth");e.append("path").attr("d","M0,0 L10,4 L0,8 z");for(var i=0;i<this.clvConnections.length;i++){this.drawConnection(this.clvConnections[i],t);}};a.getEntity=function(s,c,b){var d;this.isConnectionEntity=false;this.isSystemEntity=false;for(var i=0;i<c.length;i++){d=c[i].getConnectionId();if(b==d)return c[i].$();}for(var i=0;i<s.length;i++){d=s[i].getSystemId();if(b==d)return s[i].$();}};a.drawConnection=function(c,t){var s=c.sourceEntity;var b=c.targetEntity;var d=this.getX(s);var e=this.getY(s);var f=this.getX(b);var g=this.getY(b);var h=c.getSource();var i=c.getTarget();var j=this.connectedNodesLayout[h];var k=this.connectedNodesLayout[i];var m=null;if(k.row==j.row){m=this.svgForConnections.append("line");if(t==C.Arrow){d=d+122;f=f-122;m.attr("marker-end","url(#endMarker)");}m.attr("x1",d);m.attr("y1",e);m.attr("x2",f);m.attr("y2",g);m.attr("stroke","#999");m.attr("stroke-width",2);m.transition().duration(1500).delay(1000);}else if(k.col==j.col){m=this.svgForConnections.append("line");if(t==C.Arrow){e=e+95;g=g-95;m.attr("marker-end","url(#endMarker)");}m.attr("x1",d);m.attr("y1",e);m.attr("x2",f);m.attr("y2",g);m.attr("stroke","#999");m.attr("stroke-width",2);m.transition().duration(1500).delay(1000);}else if(k.col>j.col){if(k.row<j.row){m=this.svgForConnections.append("line");if(t==C.Arrow){d=d+95;m.attr("marker-end","url(#endMarker)");}m.attr("x1",d);m.attr("y1",e);m.attr("x2",f);m.attr("y2",e);m.attr("stroke","#999");m.attr("stroke-width",2);m.transition().duration(1500).delay(1000);m=this.svgForConnections.append("line");if(t==C.Arrow){g=g+95;m.attr("marker-end","url(#endMarker)");}m.attr("x1",f);m.attr("y1",e);m.attr("x2",f);m.attr("y2",g);m.attr("stroke","#999");m.attr("stroke-width",2);m.transition().duration(1500).delay(1000);}else{m=this.svgForConnections.append("line");if(t==C.Arrow){e=e+95;m.attr("marker-end","url(#endMarker)");}m.attr("x1",d);m.attr("y1",e);m.attr("x2",d);m.attr("y2",g);m.attr("stroke","#999");m.attr("stroke-width",2);m.transition().duration(1500).delay(1000);m=this.svgForConnections.append("line");if(t==C.Arrow){f=f-122;m.attr("marker-end","url(#endMarker)");}m.attr("x1",d);m.attr("y1",g);m.attr("x2",f);m.attr("y2",g);m.attr("stroke","#999");m.attr("stroke-width",2);m.transition().duration(1500).delay(1000);}}else{m=this.svgForConnections.append("line");m.transition();m.attr("x1",d);m.attr("y1",e);m.attr("x2",f);m.attr("y2",e);m.attr("marker-end","url(#endMarker)");m.attr("stroke","#999");m.attr("stroke-width",2);m.transition().duration(1500).delay(1000);m.attr("x1",d);m=this.svgForConnections.append("line");m.transition();m.attr("x1",f);m.attr("y1",e);m.attr("x2",f);m.attr("y2",g);m.attr("marker-end","url(#endMarker)");m.attr("stroke","#999");m.attr("stroke-width",2);m.transition().duration(1500).delay(1000);}};a.getX=function(e){var s=parseInt(e.css('left'));var b=e[0].clientWidth;return s+(b/2);};a.getY=function(e){var s=parseInt(e.css('top'));var b=e[0].clientHeight;return s+(b/2);};a.getTargetXMiddle=function(t){var b=parseInt(t.css('left'));var c=t.outerWidth();if(t.hasClass('clv_entity_container')){return(b+26+((c-26)/2));}else if(t.hasClass('networkConnectionEntity')){var d=parseInt(t.parent().css('left'));return(d+b+(c/2));}else{return null;}};a.getTargetYCenter=function(t){var b=parseInt(t.css('top'));var c=t.outerHeight();if(t.hasClass('clv_entity_container')){return(b+32+((c-32)/2));}else if(t.hasClass('networkConnectionEntity')){var d=parseInt(t.parent().css('top'));return(d+b+(c/2));}else{return null;}};a.showConnections=function(){if(this.svgForConnections){q(this.svgForConnections.canvas).show();}};a.destroyConnections=function(){if(this.svgForConnections){this.svgForConnections.canvas.remove();this.svgForConnections=null;}};a.getConnectedNodes=function(n){var c=[];for(var i=0;i<this.allConnections.length;i++){if(n==this.allConnections[i].source){c.push(this.allConnections[i].target);}else if(n==this.allConnections[i].target){c.push(this.allConnections[i].source);}}return c;};a.deinitialize=function(){if(this.initialized){if(this.svgForConnections){this.svgForConnections.canvas.remove();this.svgForConnections=null;}this.allConnections=[];this.clvConnections=[];this.sourceDoneList={};this.targetDoneList={};this.nodeDoneList={};this.sourceConnectionMatrix={};this.targetConnectionMatrix={};this.connectionMatrix={};this.topPostions={};this.connectedNodesLayout={};this.initialized=false;}};a.getBoxViewConnectedNodesLayout=function(c){var f={};var t=[];var b={};if(c.length>0){this.allConnections=c;for(var i=0;i<this.allConnections.length;i++){var e=false;for(var d in f){if(this.allConnections[i].getSource()==d){e=true;break;}}if(!e){f[this.allConnections[i].getSource()]={};}}for(var d in f){var s=[];for(var j=0;j<this.allConnections.length;j++){if(d==this.allConnections[j].getSource()){var g=[];for(var k=0;k<this.allConnections.length;k++){if(this.allConnections[j].getTarget()==this.allConnections[k].getTarget())g.push(this.allConnections[k].getSource());}var h={};if(g.length>1){if(t.length>0){var m=false;for(var i=0;i<t.length;i++){for(var n in t[i]){if(this.allConnections[j].getTarget()==n){m=true;}}if(m){break;}}if(!m){h[this.allConnections[j].getTarget()]=g;t.push(h);}}else{h[this.allConnections[j].getTarget()]=g;t.push(h);}}else{h[this.allConnections[j].getTarget()]={};s.push(h);}}}f[d].secondLevelEntities=s;}b.maxColumnCount=0;for(var d in f){var s=f[d].secondLevelEntities;b[d]={};b[d].row=this.initialRow;b[d].col=this.initialCol;b[d].colspan=s.length>0?s.length:1;for(var i=0;i<s.length;i++){for(var n in s[i]){b[n]={};b[n].row=this.initialRow+1;b[n].col=this.initialCol+i;}}this.initialCol+=b[d].colspan;}b.thirdLevelEntitiesCount=t.length;for(var i=0;i<t.length;i++){for(var d in t[i]){b[d]={};b[d].row=this.initialRow+2;b[d].col=0;if(t[i][d].length==2){var o=b[t[i][d][0]].col;var p=b[t[i][d][0]].col+b[t[i][d][0]].colspan-1;var r=b[t[i][d][1]].col;var u=b[t[i][d][1]].col+b[t[i][d][1]].colspan-1;if(o<r){b[d].col=(p+r)/2;}else{b[d].col=(u+o)/2;}}else{for(var j=0;j<t[i][d].length;j++){var v=b[t[i][d][j]].col+b[t[i][d][j]].colspan-1;if(b[d].col<v)b[d].col=v;}b[d].col=b[d].col/2;}}}b.maxColumnCount=this.initialCol;}return b;};return a;},true);
