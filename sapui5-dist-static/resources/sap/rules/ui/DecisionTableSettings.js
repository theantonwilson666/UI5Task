/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/rules/ui/library","sap/ui/core/Control","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Switch","sap/m/Select","sap/m/MessageBox","sap/m/Table","sap/m/Text","sap/m/CheckBox","sap/m/Input","sap/m/Button","sap/rules/ui/ExpressionAdvanced","sap/ui/layout/VerticalLayout","sap/rules/ui/type/Expression","sap/rules/ui/Constants","sap/rules/ui/AstExpressionBasic","sap/rules/ui/services/AstExpressionLanguage","sap/rules/ui/ast/util/AstUtil"],function(q,l,C,S,L,a,b,M,T,c,d,I,B,E,V,f,g,A,h,k){"use strict";var D=C.extend("sap.rules.ui.DecisionTableSettings",{metadata:{library:"sap.rules.ui",properties:{cellFormat:{type:"sap.rules.ui.DecisionTableCellFormat",defaultValue:sap.rules.ui.DecisionTableCellFormat.Both},hitPolicies:{type:"sap.rules.ui.RuleHitPolicy[]",defaultValue:[sap.rules.ui.RuleHitPolicy.FirstMatch,sap.rules.ui.RuleHitPolicy.AllMatch]},modelName:{type:"string",defaultValue:""},newDecisionTable:{type:"boolean",defaultValue:false},decisionTableFormat:{type:"sap.rules.ui.DecisionTableFormat",defaultValue:sap.rules.ui.DecisionTableFormat.CellFormat}},aggregations:{mainLayout:{type:"sap.ui.layout.form.SimpleForm",multiple:false}},defaultAggregation:"mainLayout",associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,singularName:"expressionLanguage"},astExpressionLanguage:{type:"sap.rules.ui.services.AstExpressionLanguage",multiple:false,singularName:"astExpressionLanguage"}},events:{},publicMethods:[]}});sap.rules.ui.DecisionTableSettings.prototype._addColumnToJsonModel=function(s){var e=this.getModel();var m=e.getData();var j=e.oData.DecisionTable.DecisionTableColumns.results;var o={Condition:{Expression:"",FixedOperator:"",Id:this.mNextColumnId,RuleId:m.Id,ValueOnly:this._getCellFormat(),Version:m.Version},Id:this.mNextColumnId,RuleId:m.Id,Sequence:s+1,Type:sap.rules.ui.DecisionTableColumn.Condition,Version:m.Version,Status:"C"};this.mNextColumnId++;j.splice(s,0,o);for(var i=s+1;i<j.length;i++){j[i].Sequence=i+1;if(j[i].Status&&j[i].Status==="C"){continue;}j[i].Status="U";}this._setDisplayModelData(m);};sap.rules.ui.DecisionTableSettings.prototype._addNodeObject=function(e){var n=[];var o=sap.ui.getCore().byId(this.getAstExpressionLanguage());var i=o._astBunldeInstance.ASTUtil;var u=[];u.Root=e.Root;u.SequenceNumber=e.Sequence;u.ParentId=e.ParentId;u.Reference=e.Reference;u.Id=e.NodeId;u.Type=e.Type;u.Value=e.Value?e.Value:"";if(e.Type==="I"){u.Value=e.IncompleteExpression;}if(e.Function){u.Function=e.Function;}if(e.Type!=="P"&&!e.Function){var O=[];O.BusinessDataType=e.Output?e.Output.BusinessDataType:e.BusinessDataType;O.DataObjectType=e.Output?e.Output.DataObjectType:e.DataObjectType;u.Output=O;}i.createNode(u);};sap.rules.ui.DecisionTableSettings.prototype._bindPredefinedTable=function(p,K){var t=this;this.oPredefinedTable.destroyItems();var m=this.getModel("oDataModel");var e;if(this.getExpressionLanguage()){e=sap.ui.getCore().byId(this.getExpressionLanguage());}else{e=sap.ui.getCore().byId(this.getAstExpressionLanguage());}var v=new sap.ui.model.odata.v2.ODataModel(e.getModel().sServiceUrl);var j=true;var s;var H;var o;var n=function(P){if(P&&P.length>0){t.oPredefinedTable.setBusy(true);for(var i=0;i<P.length;i++){s="";if(K==="/DecisionTableColumnResults"&&P[i].Type==="RESULT"){H={RuleId:P[i].RuleId,Id:P[i].Id,Version:P[i].Version};s=m.createKey(K,H);o=new sap.ui.model.Context(m,s);}else if(K==="/Attributes"){H={DataObjectId:P[i].DataObjectId,Id:P[i].Id,VocabularyId:P[i].VocabularyId};s=v.createKey(K,H);o=new sap.ui.model.Context(v,s);o.DataObjectAttributeinfo=P[i];}if(t.getExpressionLanguage()){var Q=o?o.getObject(s).BusinessDataType:"";if(Q===g.DATE_BUSINESS_TYPE||Q===g.TIMESTAMP_BUSINESS_TYPE||Q===g.NUMBER||Q===g.STRING||Q===g.BOOLEAN_BUSINESS_TYPE||Q===g.BOOLEAN_ENHANCED_BUSINESS_TYPE){j=true;}else{j=false}}if(s&&j){t.oPredefinedTable.addItem(t._predefinedFactory("col-"+i,o));}}t.oPredefinedTable.setBusy(false);t._internalModel.setProperty("/needToRefresh",false);}};if(K==="/DecisionTableColumnResults"){var r=this.getModel().getProperty("/DecisionTable/DecisionTableColumns/results");var u=t.getModel("settingsModel").attributeSequenceArray;var w=[];if(u&&u.length>0){var x=0;for(var y in r){if(r[y].Type===g.CONDITION){w.push(r[y]);x=x+1;}}for(var z in u){for(var F=x;F<r.length;F++){if(r[F].Result&&(r[F].Result.DataObjectAttributeId===u[z])){w.push(r[F]);}}}n(w);}else{n(r);}}else if(K==="/Attributes"){var G=this.getModel("settingsModel").oData.newDOAttributeList;var R=this.getModel("settingsModel").oData.resultDataObjectChanged;var J=this.getModel("settingsModel").oData.refreshButtonClicked;var N=this.getModel("settingsModel").oData.resultAttributeSequenceChanged;var u=this.getModel("settingsModel").attributeSequenceArray;if(R&&!J&&N){var O=this._getOrderedAttributesArray(G);n(O);}else{v.read(p,{urlParameters:{"$expand":"Attributes"},success:function(i){if(i.Attributes.results<=0){t.attributeListEmpty=true;}var P=i.Attributes.results;var O=t._getOrderedAttributesArray(P);if(O.length>0){t.getModel("settingsModel").oData.newDOAttributeList=O;n(O);}else{t.getModel("settingsModel").oData.newDOAttributeList=P;n(P);}},error:function(i){M.error(i.responseText,{title:t.oBundle.getText("ERROR_DIALOG"),actions:[sap.m.MessageBox.Action.OK]});}});}}};sap.rules.ui.DecisionTableSettings.prototype._getAttributeSequenceArray=function(){var e=this.getModel("settingsModel").attributeSequenceArray;if(!this.getModel("settingsModel").attributeSequenceArray){var s=this.getModel("settingsModel");var j=s.getData();var p=j.predefinedResults;var t=[];var i=0;for(var m in p){t[i]=p[m].DataObjectAttributeId?p[m].DataObjectAttributeId:p[m].Id;i++;}this.getModel("settingsModel").attributeSequenceArray=t;}return this.getModel("settingsModel").attributeSequenceArray;};sap.rules.ui.DecisionTableSettings.prototype._getOrderedAttributesArray=function(e){var i=this.getModel("settingsModel").attributeSequenceArray;if(!i){i=this._getAttributeSequenceArray();}var o=[];if(i&&i.length>0&&(this.getModel("settingsModel").getData().resultAttributeSequenceChanged||this.getModel("settingsModel").getData().refreshButtonClicked)){for(var j in i){for(var m in e){if(e[m].Id===i[j]){o.push(e[m]);}}}}return o;};sap.rules.ui.DecisionTableSettings.prototype._calcNextColumnId=function(){var e=this.getModel();var m=e.getData();var j=m.DecisionTable?m.DecisionTable.DecisionTableColumns.results:[];var n=0;for(var i=0;i<j.length;i++){if(j[i].Id>n){n=j[i].Id;}}var o=n+1;return o;};sap.rules.ui.DecisionTableSettings.prototype._callRefreshResultsFunctionImport=function(){var t=this;var o=this.getModel("oDataModel");var m=this.getModel().getData();var i={groupId:"changes"};o.setDeferredGroups([i.groupId]);var s=function(r){if(t.needToRenderPredefinedResultsTable){t._createPredefinedResultsTable();}t.getModel().getData().needToRefresh=false;};var j=function(e){sap.m.MessageToast.show(e);};var n=function(r){var R=m.Id;o.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:i.groupId,urlParameters:{RuleId:R}});o.submitChanges({groupId:i.groupId,success:s,error:j});};if(m.needToRefresh){n();}};sap.rules.ui.DecisionTableSettings.prototype._changeColumnInputMode=function(o,e){var s=e.getSource();this._openWarningDialog(s,o);};sap.rules.ui.DecisionTableSettings.prototype._changeColumnStatusToUpdate=function(o){var m=o.getModel();var s=o.getProperty("Status");if(!s||s!=="C"){m.setProperty(o.getPath()+"/Status","U");}};sap.rules.ui.DecisionTableSettings.prototype._changeInputMode=function(s,o,e){if(!s){o.setSelectedKey(this.oBundle.getText("valueOnly"));return;}o.setEnabled(false);this.getModel().setProperty(e.sPath+"/Condition/ValueOnly",false);this._changeColumnStatusToUpdate(e);};sap.rules.ui.DecisionTableSettings.prototype._createDefaultColumn=function(){var _=this.getModel();var m=_.getData();if(!m.DecisionTable){m.DecisionTable={DecisionTableColumns:[]};}if(m.DecisionTable.DecisionTableColumns&&m.DecisionTable.DecisionTableColumns.results){m.DecisionTable.DecisionTableColumns.results.push({Condition:{Expression:"",FixedOperator:"",Id:this.mNextColumnId++,RuleId:m.Id,Version:m.Version,ValueOnly:this._getCellFormat()},Id:1,Sequence:1,Type:sap.rules.ui.DecisionTableColumn.Condition,Status:"C"});}};sap.rules.ui.DecisionTableSettings.prototype._createTable=function(){this.conditionsTable=new T({backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.None,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new sap.m.Column({width:"50%",header:new sap.m.Label({text:this.oBundle.getText("colOfDecisionTable"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("colOfDecisionTable"))}),new sap.m.Column({width:"25%",header:new sap.m.Label({text:this.oBundle.getText("label"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("label"))}),new sap.m.Column({width:"25%",header:new sap.m.Label({text:this.oBundle.getText("fixedOperator"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("fixedOperator"))}),new sap.m.Column({width:"20%"})]}).data("hrf-id","columnsTable",true);var _=this.getModel();this.conditionsTable.setModel(_);this.conditionsTable.bindItems({path:"/DecisionTable/DecisionTableColumns/results",factory:this._tableColumnsFactory.bind(this)});this.conditionsTable.setBusyIndicatorDelay(0);return this.conditionsTable;};sap.rules.ui.DecisionTableSettings.prototype._createRefreshButton=function(){var _=function(){var n=this.getModel("settingsModel").oData.results.resultsEnumration;var o=this.getModel().oData.ResultDataObjectId;var p=[];var s=false;if(o){for(var i=0;i<n.length;i++){if(n[i].id===o){if(n[i].columns){p=n[i].columns;s=true;break;}else{this.getModel("settingsModel").setProperty("/refreshButtonEnabled",true,null,true);this.getModel("settingsModel").setProperty("/resultDataObjectId",o);s=true;var t=this.oBundle.getText("refreshingWillDeleteMsg");var u=this.oBundle.getText("refreshAreyouSureMsg");return t+u;}}}if(!s){p=null;}if(p&&p.length>0){var v=this._ruleResultColumns();var w=this._getResultsUpdates(v,p);return this._getMessageByResultUpdates(w);}}this.getModel("settingsModel").setProperty("/refreshButtonEnabled",false,null,true);return null;}.bind(this);var e=function(){this._updateRefreshFlags(true,false,true);}.bind(this);var j=_();var m=function(){var i=j;M.warning(i,{title:this.oBundle.getText("refeshResultWarningTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(o){if(o===sap.m.MessageBox.Action.OK){e();}}});}.bind(this);var r=new B({layoutData:new sap.ui.layout.ResponsiveFlowLayoutData({weight:1}),icon:sap.ui.core.IconPool.getIconURI("synchronize"),width:"3rem",type:sap.m.ButtonType.Transparent,text:"",press:m,visible:true,enabled:"{settingsModel>/refreshButtonEnabled}"}).setTooltip(this.oBundle.getText("refreshBtn"));this.refreshButton=r;return r;};sap.rules.ui.DecisionTableSettings.prototype._createInfoMessageStrip=function(t,e){var o=sap.ui.getCore().byId(e);if(!o){o=new sap.m.MessageStrip({visible:true,id:e,text:t,type:sap.ui.core.MessageType.Information,showIcon:true,showCloseButton:true}).addStyleClass("sapRULTDecisionTableSettingsMessageStrip");}return o;};sap.rules.ui.DecisionTableSettings.prototype._createLayout=function(){var F=new S({editable:true,layout:"ResponsiveGridLayout",maxContainerCols:1,columnsL:1,columnsM:1,labelSpanM:1,content:[new L({text:this.oBundle.getText("hitPolicy")}).setTooltip(this.oBundle.getText("hitPolicy")),new b({width:"220px",enabled:"{settingsModel>/hitPolicy/enabled}",items:{path:"settingsModel>/hitPolicy/hitPolicyEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>text}"})},selectedKey:"{/DecisionTable/HitPolicy}",change:function(e){var _=this.getModel();var m=_.getData();if(m.DecisionTable.HitPolicyStatus!="C"){m.DecisionTable.HitPolicyStatus="U";}}.bind(this)}),new L(),new sap.ui.layout.HorizontalLayout({}),new L({text:this.oBundle.getText("conditionsTableLabelText")}).setTooltip(this.oBundle.getText("conditionsTableLabelTooltip")),this._createTable(),new L(),new sap.ui.layout.HorizontalLayout({}),new L({text:this.oBundle.getText("output")}).setTooltip(this.oBundle.getText("output")),new sap.ui.layout.HorizontalLayout({content:[this._createResultInput(),this._createRefreshButton()]}),new L(),this._createPredefinedResultsLayout()]}).addStyleClass("sapRULTDecisionTableSettingsForm");return F;};sap.rules.ui.DecisionTableSettings.prototype._createPredefinedResultsLayout=function(){if(this.needToRenderPredefinedResultsTable){var v=new sap.ui.layout.VerticalLayout({content:[this._createInfoMessageStrip(this.oBundle.getText("PredefinedMessageStripHiddenAccessInfoText"),"id_HiddenAccessMessageStrip"),this._createInfoMessageStrip(this.oBundle.getText("PredefinedMessageStripEditableAccessInfoText"),"id_EditableAccessMessageStrip"),this._createPredefinedResultsTable()]});return v;}else{return new L();}};sap.rules.ui.DecisionTableSettings.prototype._createPredefinedResultsTable=function(){if(!this.oPredefinedTable){this.oPredefinedTable=new sap.m.Table("idPredefinedTable",{backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.All,swipeDirection:sap.m.SwipeDirection.Both,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new sap.m.Column({width:"45%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedResultColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new sap.m.Column({width:"30%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedAccessColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new sap.m.Column({width:"45%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedValuesColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new sap.m.Column({width:"20%",header:new sap.m.Label({text:this.oBundle.getText("ReorderResultDOAttributes"),design:sap.m.LabelDesign.Bold})})]});}var r=this.getModel("settingsModel").getProperty("/resultDataObjectChanged");var R=this.getModel("settingsModel").getProperty("/refreshButtonClicked");var _=this.getModel();var e="";if(!r&&!R){this.oPredefinedTable.setModel(_);this._bindPredefinedTable("/DecisionTable/DecisionTableColumns/results","/DecisionTableColumnResults");this.oPredefinedTable.setBusyIndicatorDelay(0);return this.oPredefinedTable;}else{var e=this.getModel().getProperty("/ResultDataObjectId");this._getLatestResultDataObjects(e);}return null;};sap.rules.ui.DecisionTableSettings.prototype._createResultInput=function(){var m=this.getModel();var r=m.oData.ResultDataObjectId;var s=this.getModel("settingsModel");var e=s.oData.results.resultsEnumration;if(r!==g.NO_RESULT||r!==""){e.splice(0,1);s.oData.results.resultsEnumration=e;}var i=m.oData&&m.oData.ResultDataObjectLabel?m.oData.ResultDataObjectLabel:m.oData.ResultDataObjectName;this.oResultInput=new I({width:"220px",valueHelpOnly:true,showValueHelp:true,selectedKey:"{/ResultDataObjectId}",value:i,tooltip:this.oBundle.getText("chooseResultTooltip"),suggestionItems:{path:"settingsModel>/results/resultsEnumration",template:new sap.ui.core.Item({key:"{settingsModel>id}",text:"{settingsModel>label}"})},valueHelpRequest:function(o){var j=o.getSource();var _=this.getModel();var n=_.getData();var p=function(){var u=function u(v){var w=v.getParameter("value");var F=new sap.ui.model.Filter("name",sap.ui.model.FilterOperator.Contains,w);v.getSource().getBinding("items").filter([F]);};this.oSelectDialog=new sap.m.SelectDialog({title:this.oBundle.getText("chooseResultDialogTitle"),styleClass:"sapUiPopupWithPadding",rememberSelections:true,items:{path:"settingsModel>/results/resultsEnumration",template:new sap.m.StandardListItem({title:"{settingsModel>label}",description:"{settingsModel>description}"})},search:u,liveChange:u,confirm:function(v){var w=v.getParameter("selectedItem");var x=v.getParameter("selectedContexts");if(w){var y=x[0].getProperty().id;j.setSelectedKey(y);m=this.getModel();m.oData.ResultDataObjectId=y;m.oData.ResultDataObjectName=x[0].getProperty().name;m.oData.ResultDataObjectLabel=x[0].getProperty().label;var z=this.getModel("settingsModel");z.setProperty("/resultDataObjectChanged",true);z.setProperty("/resultAttributeSequenceChanged",false);z.attributeSequenceArray=[];z.oData.predefinedResults=[];if(this.needToRenderPredefinedResultsTable){this._createPredefinedResultsTable();}if(!n.ResultDataObjectStatus){n.ResultDataObjectStatus="U";if(n.ResultDataObjectId!=w.getInfo()){this._updateRefreshFlags(false,false,false);}}}v.getSource().getBinding("items").filter([]);if(this.oSelectDialog&&this.oSelectDialog._oDialog){this.oSelectDialog._oDialog.destroy();this.oSelectDialog=null;}}.bind(this),cancel:function(v){if(this.oSelectDialog&&this.oSelectDialog._oDialog){this.oSelectDialog._oDialog.destroy();this.oSelectDialog=null;}this.oSelectDialog=null;}.bind(this)});this.oSelectDialog.setModel(this.oResultInput.getModel("settingsModel"),"settingsModel");this.oSelectDialog.open();}.bind(this);function t(){M.warning(this.oBundle.getText("changeResultWarningMsg"),{title:this.oBundle.getText("changeResultWarningTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(u){if(u===sap.m.MessageBox.Action.OK){p();}}});}if(n.ResultDataObjectStatus){p();}else if(this.getProperty("newDecisionTable")){n.ResultDataObjectStatus="C";p();}else{t.call(this);}}.bind(this)});return this.oResultInput;};sap.rules.ui.DecisionTableSettings.prototype._destroyElement=function(e){var i=sap.ui.getCore().byId(e);if(i){if(e==="idPredefinedTable"){i.destroyColumns();}i.destroy();}};sap.rules.ui.DecisionTableSettings.prototype._findAndRemoveDeletedAttributeFromOModel=function(){var _=this.getModel("settingsModel");var j=_.oData.predefinedResults;for(var e in j){var p=_.oData.predefinedResults;var t=[];var i="";if(!j[e].AttributeInBackend){i=e;for(var m in p){if(m===i){continue;}else{t[m]={};t[m].AccessMode=p[m].AccessMode;t[m].Expression=p[m].Expression;}}}var o=this.getModel();var n=o.oData.DecisionTable.DecisionTableColumns.results;for(var r=0;r<n.length;r++){if(n[r].Result&&n[r].Result.DataObjectAttributeId===i){this.sequenceOfAttributeDeleted=n[r].Sequence;this._removeColumnFromJsonModel(this.sequenceOfAttributeDeleted,"C");}}}};sap.rules.ui.DecisionTableSettings.prototype._findPropertyAccessMode=function(){var e=this.oModels.oDataModel.oServiceData.oMetadata.mEntityTypes["/DecisionTableColumnResults"].property;if(e){for(var n=0;n<e.length;n++){if(e[n].name===g.KEY_ACCESSMODE){return true;}}return false;}};sap.rules.ui.DecisionTableSettings.prototype._getASTExpressionBasicForCondition=function(o){var t=this;var e=sap.ui.getCore().byId(this.getAstExpressionLanguage());var s=o.getProperty("Condition/Expression");var i=this._getExpressionFromAstNodes(o);if(i&&i.relString){i.relString=i.relString.replace(/\\/g,"\\\\").replace(/{/g,"\\{").replace(/}/g,"\\}");}var j=new A({astExpressionLanguage:e,value:i.relString?i.relString:"",placeholder:this.oBundle.getText("expressionPlaceHolder"),valueState:i.valueState,jsonData:i.JSON,change:function(m){var n=m.getSource();o=n.getBindingContext();var p=o.getPath();var r=m.getParameter("astNodes");var u=m.getParameter("newValue");if(r&&r.length===1&&r[0].Type==="I"&&r[0].Value&&r[0].Value!==""){n.setValueState("Error");}else{n.setValueState("None");}var v=o.getModel();var w=o.getProperty("Condition/ValueOnly");var x=t._getASTNodes(r,o);v.setProperty(p+"/Condition/ASTNodes",x);t._setExpressionRelevantOperators(u,o.getProperty("Condition/Id"),w,j);if(x.length===1&&x[0].Value===""){v.setProperty(p+"/Condition/FixedOperator","");v.setProperty(p+"/Condition/ASTNodes",[]);}t._changeColumnStatusToUpdate(o);n._validateControl();}.bind(this)}).setBindingContext(o);this._setExpressionRelevantOperators(i.relString,o.getProperty("Condition/Id"),o.getProperty("Condition/ValueOnly"),j);j.addStyleClass("sapRULDecisionTableSettingsAstExpression");return j;};sap.rules.ui.DecisionTableSettings.prototype._getASTExpressionBasicForPredefined=function(o,e,i,j,m){var t=this;var s="";var r=o.getObject(o.getPath());if(r&&!s){s=r.DataObjectAttributeId?r.DataObjectAttributeId:r.Id;}else if(o.DataObjectAttributeinfo){s=o.DataObjectAttributeinfo.Id;}if(s){i=this._getExpressionFromAstNodes(o,m);var n=this.getModel().oData.ResultDataObjectId;this.attributeInfo="/"+n+"/"+s;}if(i&&i.relString){i.relString=i.relString.replace(/\\/g,"\\\\").replace(/{/g,"\\{").replace(/}/g,"\\}");}var p=sap.ui.getCore().byId(this.getAstExpressionLanguage());var u=j?j:sap.rules.ui.ExpressionType.NonComparison;var v=new A({id:e,astExpressionLanguage:p,value:i.relString?i.relString:"",jsonData:i.JSON,attributeInfo:this.attributeInfo,placeholder:this.oBundle.getText("expressionPlaceHolder"),valueState:i.valueState,change:function(w){t.expressionControl=w.getSource();var m=w.getParameter("astNodes");var x=o.getModel();var P=o.getPath();var y=w.getParameter("newValue");var z=t._getASTNodes(m,o);if(z&&z.length===1&&z[0].Type==="I"&&z[0].Value!==""){t.expressionControl.setValueState("Error");}else{t.expressionControl.setValueState("None");}t.getModel("settingsModel").setProperty("/resultAttributeChanged",true);t._updateResultAttributeJSON(o,null,null,z,false,false,false);t.expressionControl._validateControl();}.bind(this)}).setBindingContext(o);return v;};sap.rules.ui.DecisionTableSettings.prototype._getASTNodes=function(e,o){var m=[];for(var n in e){var u={};if(e[n].Root){u.Sequence=1;u.Root=true;}else{u.Sequence=e[n].SequenceNumber;u.ParentId=e[n].ParentId;}if(e[n].Function){u.Function=e[n].Function?e[n].Function:"";}if(e[n].Type!=="P"&&e[n].Type!=="O"&&!e[n].Function){u.BusinessDataType=e[n].Output?e[n].Output.BusinessDataType:e[n].BusinessDataType;u.DataObjectType=e[n].Output?e[n].Output.DataObjectType:e[n].DataObjectType;u.Value=e[n].Value?e[n].Value:"";}else if(e[n].Type==="O"){u.Reference=e[n].Reference;}if(e[n].Type==="I"){u.IncompleteExpression=e[n].Value;}u.NodeId=e[n].Id;u.Type=e[n].Type;u.RuleId=o.getProperty("RuleId")?o.getProperty("RuleId"):this.getModel().getData().DecisionTable.RuleId;u.Version=o.getProperty("Version")?o.getProperty("Version"):this.getModel().getData().DecisionTable.Version;u.Id=o.getProperty("Id");m.push(u);}return m;};sap.rules.ui.DecisionTableSettings.prototype._getBindModelName=function(){var p="";var m=this.getModelName();if(m){p=m+">";}return p;};sap.rules.ui.DecisionTableSettings.prototype._getCellFormat=function(){var s=this.getProperty("cellFormat");var e=this.getProperty("decisionTableFormat");if(e===sap.rules.ui.DecisionTableFormat.RuleFormat){return(this.getModel().getData().RuleFormat===sap.rules.ui.RuleFormat.Basic)?true:false;}return(s!==sap.rules.ui.DecisionTableCellFormat.Text)?true:false;};sap.rules.ui.DecisionTableSettings.prototype._getCellFormatAcccessOptions=function(){var s=this.getProperty("cellFormat");var o={CellFormat:s,cellFormatEnumration:[{key:g.KEY_EDITABLE,value:this.editableModeText},{key:g.KEY_HIDDEN,value:this.hiddenModeText}]};return o;};sap.rules.ui.DecisionTableSettings.prototype._getCellFormatData=function(){var s=this.getProperty("cellFormat");var o={CellFormat:s,cellFormatEnumration:[{key:this.oBundle.getText("advancedMode"),value:this.oBundle.getText("advancedMode")},{key:this.oBundle.getText("valueOnly"),value:this.oBundle.getText("valueOnly")}]};return o;};sap.rules.ui.DecisionTableSettings.prototype._getColumnInputMode=function(v){if(!v){return this.oBundle.getText("advancedMode");}return(this.oBundle.getText("valueOnly"));};sap.rules.ui.DecisionTableSettings.prototype._getExpressionAdvanceColumn=function(o){var e=sap.ui.getCore().byId(this.getExpressionLanguage());return new E({expressionLanguage:e,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,type:sap.rules.ui.ExpressionType.NonComparison,value:{path:"Condition/Expression",events:{change:function(i){var s=i.getSource();var j=s.getContext();var m=j.getProperty("Id");var v=j.getProperty("Condition/ValueOnly");this._setExpressionRelevantOperators(s.getValue(),m,v);}.bind(this)}},enabled:true,change:function(i){var s=i.getSource();var j=s.getBindingContext();var m=j.getProperty("Id");var n=j.getModel();var v=j.getProperty("Condition/ValueOnly");var p=s.getValue().replace(/\s*$/,"");s.setValue(p);this._setExpressionRelevantOperators(p,m,v);this._changeColumnStatusToUpdate(j);var r=j.getProperty("Condition/Expression");if(!r){n.setProperty(j.getPath()+"/Condition/FixedOperator","");}}.bind(this)});};sap.rules.ui.DecisionTableSettings.prototype._getExpressionFieldForCondition=function(o){var e;if(this.getExpressionLanguage()){e=this._getExpressionAdvanceColumn(o);}else{e=this._getASTExpressionBasicForCondition(o);}return e;};sap.rules.ui.DecisionTableSettings.prototype._getExpressionFieldForPredefined=function(o,e,i,j,m){var n;if(this.getExpressionLanguage()){n=this._getPredefinedExpressionAdvanced(o,e,i,j);}else{n=this._getASTExpressionBasicForPredefined(o,e,i,j,m);}return n;};sap.rules.ui.DecisionTableSettings.prototype._getExpressionFromAstNodes=function(o,e){var t=this;var i=sap.ui.getCore().byId(this.getAstExpressionLanguage());var j=i._astBunldeInstance.TermsProvider.TermsProvider;var m="";var n="";var p=[];var P=o.getPath();var r=o.getObject(P);if(r&&r.Type==="CONDITION"){p=r.Condition.ASTNodes?r.Condition.ASTNodes:r.Condition.DecisionTableColumnConditionASTs;}else if(r&&r.Type==="RESULT"){p=r.Result.DecisionTableColumnResultASTs;}else{p=e;}var s=i._astBunldeInstance.ASTUtil;s.clearNodes();p=p&&p.results?p.results:p;if(p&&p.length>0){for(var u in p){this._addNodeObject(p[u]);}var e=s.getNodes();m=s.toAstExpressionString(e);if(e&&e.length===1&&e[0].Type==="I"&&e[0].Value&&e[0].Value!==""){m.valueState="Error";}else{m.valueState="None";}}return m;};sap.rules.ui.DecisionTableSettings.prototype._getFixedOperatorDataForExpression=function(e,v,j){var m=e?true:false;var n={fixOperatorEnumration:[{key:"",value:"None"}],fixOperatorEnabled:m};var s=[];if(this.getExpressionLanguage()&&m){var o=sap.ui.getCore().byId(this.getExpressionLanguage());var F;if(!v){F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonExistOp}];}else{F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp}];}s=o.getSuggestionsByCategories(e,F);for(var i=0;i<s.length;i++){n.fixOperatorEnumration.push({key:s[i].text,value:s[i].text});}}else if(this.getAstExpressionLanguage()&&e&&e!==""){s=j._getSuggestionsForTheGivenInput(e).autoComplete.categories.operators;if(s){if(s.comparision&&s.comparision.length>0){var p=s.comparision;for(var i=0;i<p.length;i++){n.fixOperatorEnumration.push({key:p[i].name,value:p[i].label});}}if(s.logical&&s.logical.length>0){var r=s.logical;for(var i=0;i<r.length;i++){n.fixOperatorEnumration.push({key:r[i].name,value:r[i].label});}}if(s.array&&s.array.length>0){var t=s.array;for(var i=0;i<t.length;i++){n.fixOperatorEnumration.push({key:t[i].name,value:t[i].label});}}if(s.range&&s.range.length>0){var u=s.range;for(var i=0;i<u.length;i++){n.fixOperatorEnumration.push({key:u[i].name,value:u[i].label});}}if(s.miscellaneous&&s.miscellaneous.length>0){var w=s.miscellaneous;for(var i=0;i<w.length;i++){n.fixOperatorEnumration.push({key:w[i].name,value:w[i].label});}}if(s.functional&&s.functional.length>0){var x=s.functional;for(var i=0;i<x.length;i++){n.fixOperatorEnumration.push({key:x[i].name,value:x[i].label});}}}}return n;};sap.rules.ui.DecisionTableSettings.prototype._getHitPoliciesData=function(){var e=this.getProperty("hitPolicies");var j=e.length;var H={hitPolicyEnumration:[]};for(var i=0;i<j;i++){H.hitPolicyEnumration.push({key:e[i],text:this.oBundle.getText(e[i])});}H.enabled=j>1?true:false;return H;};sap.rules.ui.DecisionTableSettings.prototype._getInputModeEnabled=function(s,v){if(s!==sap.rules.ui.DecisionTableCellFormat.Both||v===false){return false;}return true;};sap.rules.ui.DecisionTableSettings.prototype._getLatestResultDataObjects=function(n){var t=this;var m=t.getModel().getData();var p=m.ProjectId;var s=t.getModel("settingsModel");var e;if(this.getExpressionLanguage()){e=sap.ui.getCore().byId(this.getExpressionLanguage());}else{e=sap.ui.getCore().byId(this.getAstExpressionLanguage());}var v=new sap.ui.model.odata.v2.ODataModel(e.getModel().sServiceUrl);var P="/DataObjects(VocabularyId='"+p+"',Id='"+n+"')";t._bindPredefinedTable(P,"/Attributes");t.oPredefinedTable.setBusyIndicatorDelay(0);return t.oPredefinedTable;};sap.rules.ui.DecisionTableSettings.prototype._getMessageByResultUpdates=function(r){var m=this.oBundle.getText("refreshingWillDeleteMsg");var e=this.oBundle.getText("refreshAreyouSureMsg");var i=r.addedColumns.length+r.changedColumns.length+r.removedColumns.length;if(i!=0){var j=function(t){return"'"+t+"'";};var n=(r.addedColumns.length==0)?"":this.oBundle.getText("columnsWereAdded",r.addedColumns.map(j).toString());var o=(r.changedColumns.length==0)?"":this.oBundle.getText("columnsWereChanged",r.changedColumns.map(j).toString());var p=(r.removedColumns.length==0)?"":this.oBundle.getText("columnsWereRemoved",r.removedColumns.map(j).toString());var s=n+o+p+((r.removedColumns.length==0)?"":m)+e;this.getModel("settingsModel").setProperty("/refreshButtonEnabled",true,null,true);return s;}else{this.getModel("settingsModel").setProperty("/refreshButtonEnabled",false,null,true);}return null;};sap.rules.ui.DecisionTableSettings.prototype._getPredefinedExpressionAdvanced=function(o,e,i,j){var t=this;var s="";var r=o.getObject(o.getPath());if(r&&!s){s=r.DataObjectAttributeId?r.DataObjectAttributeId:r.Id;}var m=sap.ui.getCore().byId(this.getExpressionLanguage());var n=j?j:sap.rules.ui.ExpressionType.NonComparison;return new E({expressionLanguage:m,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,id:e,type:n,value:i,editable:true,attributeInfo:s,change:function(p){t.expressionControl=p.getSource();this.getModel("settingsModel").setProperty("/resultAttributeChanged",true);this._updateResultAttributeJSON(o,null,t.expressionControl.getValue(),null,false,false,false);}.bind(this)});};sap.rules.ui.DecisionTableSettings.prototype._getResultsData=function(){var e;if(this.getAstExpressionLanguage()){e=sap.ui.getCore().byId(this.getAstExpressionLanguage());}else{e=sap.ui.getCore().byId(this.getExpressionLanguage());}var r=[{id:g.NO_RESULT,name:"",label:""}];r=r.concat(e.getResults());var R={resultsEnumration:r};return R;};sap.rules.ui.DecisionTableSettings.prototype._getResultsUpdates=function(r,e){var m=[],n=[],o=[];var i=0,j=0;for(i=0;i<r.length;i++){var p=false;for(j=0;j<e.length;j++){if(e[j].name===r[i].Result.DataObjectAttributeName){p=true;if((e[j].businessDataType!==r[i].Result.BusinessDataType)||(e[j].name!==r[i].Result.DataObjectAttributeName)){o.push(r[i].Result.DataObjectAttributeName);}}}if(!p){n.push(r[i].Result.DataObjectAttributeName);}p=false;}for(j=0;j<e.length;j++){var s=false;for(i=0;i<r.length;i++){if(e[j].name===r[i].Result.DataObjectAttributeName){s=true;}}if(!s){m.push(e[j].name);}s=false;}return{addedColumns:m,changedColumns:o,removedColumns:n};};sap.rules.ui.DecisionTableSettings.prototype._getSelectedVisibilityStatus=function(s){if(s===this.hiddenModeText){return g.KEY_HIDDEN;}else{return g.KEY_EDITABLE;}};sap.rules.ui.DecisionTableSettings.prototype._initServiceModel=function(){var o=this.getModel("oDataModel");var s=o.sServiceUrl;var m=new sap.ui.model.odata.v2.ODataModel({serviceUrl:s,defaultBindingMode:sap.ui.model.BindingMode.TwoWay});var e=m.getMetaModel();if(e&&e.oMetadata&&e.oMetadata.bLoaded){var i=e.oMetadata.oMetadata.dataServices.schema[0].namespace;var p=i+"."+g.PREDEFINED_RESULT;if(e.oMetadata&&e.oMetadata._entitySetMap&&e.oMetadata._entitySetMap[p]){this.needToRenderPredefinedResultsTable=true;}}};sap.rules.ui.DecisionTableSettings.prototype._initSettingsModel=function(){var i={};i.hitPolicy=this._getHitPoliciesData();i.tableData={};i.removeRowEnabled=false;i.cellFormat=this._getCellFormatData();i.accessOptions=this._getCellFormatAcccessOptions();i.updateAllRows=false;i.predefinedResults=[];i.resultDataObjectChanged=false;i.resultAttributeChanged=false;i.refreshButtonClicked=false;i.results=this._getResultsData();this._internalModel=new sap.ui.model.json.JSONModel(i);this.setModel(this._internalModel,"settingsModel");this._initServiceModel();};sap.rules.ui.DecisionTableSettings.prototype._openWarningDialog=function(s,o){var e=new sap.m.Dialog({title:this.oBundle.getText("changeInputModeDialogTitle"),width:"70%",type:'Message',state:'Warning',content:new c({text:this.oBundle.getText("changeInputModeDialogDescription")}),beginButton:new B({text:this.oBundle.getText("okBtn"),press:function(){e.close();e.destroy();this._changeInputMode(true,s,o);}.bind(this)}),endButton:new B({text:this.oBundle.getText("cancelBtn"),press:function(){e.close();e.destroy();this._changeInputMode(false,s,o);}.bind(this)}),afterClose:function(){e.close();e.destroy();}});e.open();};sap.rules.ui.DecisionTableSettings.prototype._predefinedFactory=function(i,o){var e="exp"+i;var t=o.getProperty("Type");var j=[];var m=o.getProperty("DataObjectAttributeLabel")||o.getProperty("Label")||(o.DataObjectAttributeinfo?o.DataObjectAttributeinfo.Label:undefined);var n=o.getProperty("DataObjectAttributeName")||o.getProperty("Name")||(o.DataObjectAttributeinfo?o.DataObjectAttributeinfo.Name:undefined);var p=m?m:n;var r=o.getProperty("DataObjectAttributeId")||o.getProperty("Id")||(o.DataObjectAttributeinfo?o.DataObjectAttributeinfo.Id:undefined);var s;var u=o.getProperty("BusinessDataType");var v;var w=this._internalModel.getProperty("/predefinedResults");var x=this.getModel("settingsModel").getProperty("/resultAttributeSequenceChanged");var R=this._internalModel.getProperty("/resultDataObjectChanged");var y=this._internalModel.getProperty("/refreshButtonClicked");if(R&&!x){this._updateResultAttributeJSON(o,g.EDITABLE,"",[],R,y,x);v=g.EDITABLE;s="";}else if(y||x){var z=w[r];v=z?z.AccessMode:g.EDITABLE;s=z?z.Expression:"";j=z?z.ASTNodes:[];this._updateResultAttributeJSON(o,v,s,j,R,y,x);}else{s=o.getProperty("Expression");var F=o.getProperty("DecisionTableColumnResultASTs");for(var G in F){j.push(o.getProperty("/"+F[G]));}v=o.getProperty("AccessMode");this._updateResultAttributeJSON(o,v,s,j,false,false,false);}var H=this._getSelectedVisibilityStatus(v);return new sap.m.ColumnListItem({visible:true,vAlign:sap.ui.core.VerticalAlign.Middle,cells:[new sap.m.Label({visible:true,design:sap.m.LabelDesign.Standard,text:p,labelFor:e,textAlign:sap.ui.core.TextAlign.Begin,textDirection:sap.ui.core.TextDirection.Inherit}),new sap.m.Select({width:"65%",id:"select"+i,items:{path:"settingsModel>/accessOptions/cellFormatEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>value}"})},selectedKey:H,enabled:true,change:function(J){this._setColumnAccessMode(o,J);}.bind(this)}),this._getExpressionFieldForPredefined(o,e,s,u,j),new sap.ui.layout.HorizontalLayout({content:[new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:"sap-icon://arrow-top",visible:true,press:function(J){this._moveAttributePosition(o,g.UP);}.bind(this)}).setTooltip(this.oBundle.getText("MoveResultAttributeUP")),new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:"sap-icon://arrow-bottom",press:function(J){this._moveAttributePosition(o,g.DOWN);}.bind(this)}).setTooltip(this.oBundle.getText("MoveResultAttributeDown"))]})]});};sap.rules.ui.DecisionTableSettings.prototype._moveAttributePosition=function(o,s){var e=this.getModel("settingsModel");var i=e.getData();var m=this.getModel().getData();var p=m.ProjectId;var j=o.getProperty("DataObjectAttributeId")||o.getProperty("Id")||(o.DataObjectAttributeinfo?o.DataObjectAttributeinfo.Id:undefined);var r=this.getModel().getData().ResultDataObjectId;var n=[];if(this.getModel("settingsModel").getData().resultDataObjectChanged&&!this.getModel("settingsModel").getData().resultAttributeSequenceChanged){this.getModel("settingsModel").attributeSequenceArray=undefined;}var n=this.getModel("settingsModel").attributeSequenceArray;if(!n){n=this._getAttributeSequenceArray();}if(n&&n.length>0){var t=n.indexOf(j);var u=-1;if(s===g.UP){u=t===0?0:t-1;}else{u=t===n.length?t:t+1;}this._internalModel.getProperty("/predefinedResults")[n[t]].SequenceChanged=true;this._internalModel.getProperty("/predefinedResults")[n[t]].NewSequence=u+1;this._internalModel.getProperty("/predefinedResults")[n[u]].SequenceChanged=true;this._internalModel.getProperty("/predefinedResults")[n[u]].NewSequence=t+1;var v=n[u];n[u]=n[t];n[t]=v;this.getModel("settingsModel").attributeSequenceArray=n;}this.getModel("settingsModel").setProperty("/resultAttributeSequenceChanged",true);var P="";if(this.getModel("settingsModel").getData().resultDataObjectChanged){var P="/DataObjects(VocabularyId='"+p+"',Id='"+r+"')";this._bindPredefinedTable(P,"/Attributes");}else{var P="/DecisionTable/DecisionTableColumns/results";this._bindPredefinedTable(P,"/DecisionTableColumnResults");}this.oPredefinedTable.setBusyIndicatorDelay(0);};sap.rules.ui.DecisionTableSettings.prototype._prepareNewRule=function(){this._updateDecisionTableHeader();this._createDefaultColumn();if(!this.needToRenderPredefinedResultsTable){this._setDefaultResult();}};sap.rules.ui.DecisionTableSettings.prototype._removeColumnFromJsonModel=function(s,e){var j=this.getModel();var m=j.getData();var n=m.DecisionTable.DecisionTableColumns.results;if(!e||e!=="C"){if(!m.DecisionTable.DecisionTableColumns.deleted){m.DecisionTable.DecisionTableColumns.deleted=[];}m.DecisionTable.DecisionTableColumns.deleted.push(n[s-1]);}n.splice(s-1,1);for(var i=s-1;i<n.length;i++){n[i].Sequence--;if(n[i].Status&&n[i].Status==="C"){continue;}n[i].Status="U";}this._setDisplayModelData(m);};sap.rules.ui.DecisionTableSettings.prototype._ruleResultColumns=function(){var e=this.getModel().oData.DecisionTable.DecisionTableColumns.results;function i(j){return j.Result!=null;}return e.filter(i);};sap.rules.ui.DecisionTableSettings.prototype._setColumnAccessMode=function(o,e){this.enableAccessValue=!this.enableAccessValue;var i=e.oSource.sId.split("select")[1];var u="exp"+i;this.expressionControl=sap.ui.getCore().byId(u);this.getModel("settingsModel").setProperty("/resultAttributeChanged",true);var s=e.getSource();var j=s.getSelectedKey();if(this.expressionControl instanceof E){if(j===g.KEY_HIDDEN){this.expressionControl.setValue("");this._updateResultAttributeJSON(o,this.hiddenModeText,null,null,false,false,false);}else{this.expressionControl.setValueStateText("");this.expressionControl.addStyleClass("sapRULExpressionAdvancedResultTable");this._updateResultAttributeJSON(o,this.editableModeText,null,null,false,false,false);}}else{if(j===g.KEY_HIDDEN){this.expressionControl.setValue("");this.expressionControl._input[0].textContent="";var m=this.expressionControl.sId+"-input";var n={"expId":m};var p=sap.ui.getCore().getEventBus();p.publish("sap.ui.rules","_onHiddenSelected",n);this._updateResultAttributeJSON(o,g.HIDDEN,null,null,null,false,false,false);}else{this.expressionControl._input[0].classList.remove("sapAstExpressionInputError");this._updateResultAttributeJSON(o,this.editableModeText,null,null,false,false,false);}}this._internalModel.setProperty("/resultAttributeChanged",true);};sap.rules.ui.DecisionTableSettings.prototype._updateApplyBtnActions=function(){if(this._internalModel){var p=this._internalModel.oData.predefinedResults;var e=false;for(var i in p){if(p[i].AccessMode===g.HIDDEN){if(this.getAstExpressionLanguage()&&p[i].ASTExpressionCleared){e=true;break;}if(this.getExpressionLanguage()&&(p[i].ASTExpressionCleared||!p[i].Expression)){e=true;break;}}}if(e){sap.ui.getCore().byId("ApplyBtn").setEnabled(false);}else{sap.ui.getCore().byId("ApplyBtn").setEnabled(true);}}};sap.rules.ui.DecisionTableSettings.prototype._setDefaultResult=function(){var _=this.getModel();var m=_.getData();var r=this._internalModel.getData().results.resultsEnumration;if(r.length===2){m.ResultDataObjectId=r[1].id;m.ResultDataObjectName=r[1].name;m.ResultDataObjectLabel=r[1].label?r[1].label:r[1].name;m.ResultDataObjectStatus="C";}};sap.rules.ui.DecisionTableSettings.prototype._setDisplayModelData=function(m){this.resultCounter=0;var e=this.getModel();e.setData(m);};sap.rules.ui.DecisionTableSettings.prototype.setExpressionLanguage=function(e){this.setAssociation("expressionLanguage",e,true);this._decisionTableHeaderSettingFormatter.setExpressionLanguage(e);};sap.rules.ui.DecisionTableSettings.prototype._setExpressionRelevantOperators=function(e,i,v,j){var F=this._getFixedOperatorDataForExpression(e,v,j);this._internalModel.setProperty("/tableData/"+i,F,false);this._updateRemoveRowEnabled();};sap.rules.ui.DecisionTableSettings.prototype._tableColumnsFactory=function(i,o){var t=this;var e=o.getProperty("Id");var s=o.getProperty("Sequence");var j=o.getProperty("Label");var m=o.getProperty("Status");var n=o.getProperty("Type");var p=o.getProperty("Condition/FixedOperator");var O=this.getAstExpressionLanguage()?this.astUtil._getCapitalOperatorName(p):p;var r="";if(this.getAstExpressionLanguage()){r="sapRULDecisionTableSettingsTableContent";}return new sap.m.ColumnListItem({visible:n===sap.rules.ui.DecisionTableColumn.Condition,cells:[this._getExpressionFieldForCondition(o),new sap.m.Input({value:j,maxLength:g.MAX_LABEL_LENGTH,change:function(u){var v=u.getSource().getValue().trim();var w=u.getSource();var x=o.getModel();x.setProperty(o.getPath()+"/Label",v);this._changeColumnStatusToUpdate(o);}.bind(this)}).addStyleClass(r),new sap.m.Select({width:"100%",showSecondaryValues:true,items:{path:"settingsModel>/tableData/"+e+"/fixOperatorEnumration",template:new sap.ui.core.ListItem({key:"{settingsModel>key}",text:"{settingsModel>key}",additionalText:"{settingsModel>value}"})},selectedKey:O,enabled:"{settingsModel>/tableData/"+e+"/fixOperatorEnabled}",change:function(u){var v=u.getSource();var w=o.getModel();var x=v.getSelectedKey();var O=this.getAstExpressionLanguage()?t.astUtil._getCamelCaseOperatorName(x):x;w.setProperty(o.getPath()+"/Condition/FixedOperator",O);this._changeColumnStatusToUpdate(o);}.bind(this)}).addStyleClass(r),new sap.ui.layout.HorizontalLayout({content:[new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("sys-cancel"),visible:"{settingsModel>/removeRowEnabled}",press:function(u){this._internalModel.setProperty("/tableData",{},true);this._removeColumnFromJsonModel(s,m);}.bind(this)}).setTooltip(this.oBundle.getText("removeColumn")).addStyleClass(r),new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("add"),press:function(u){this._addColumnToJsonModel(s);}.bind(this)}).setTooltip(this.oBundle.getText("addColumn")).addStyleClass(r)]})]});};sap.rules.ui.DecisionTableSettings.prototype._updateDecisionTableHeader=function(){var _=this.getModel();var e;if(this.getAstExpressionLanguage()){e=sap.ui.getCore().byId(this.getAstExpressionLanguage());}else{e=sap.ui.getCore().byId(this.getExpressionLanguage());}var s=e.getExpressionLanguageVersion();var m=_.getData();m.Type=sap.rules.ui.RuleType.DecisionTable;m.ExpressionLanguageVersion=s;};sap.rules.ui.DecisionTableSettings.prototype._updateRefreshFlags=function(n,i,r){this.getModel().getData().needToRefresh=n;this.getModel("settingsModel").setProperty("/refreshButtonEnabled",i,null,true);this.getModel("settingsModel").setProperty("/refreshButtonClicked",r);this._callRefreshResultsFunctionImport();};sap.rules.ui.DecisionTableSettings.prototype._updateRemoveRowEnabled=function(){var e=this.getModel().getProperty("/DecisionTable/DecisionTableColumns/results");var v=0;for(var i=0;i<e.length;i++){if(e[i].Type==="CONDITION"){v++;}}var j=v>1;this._internalModel.setProperty("/removeRowEnabled",j,null,true);};sap.rules.ui.DecisionTableSettings.prototype._updateResultAttributeJSON=function(o,s,e,i,r,j,m){var n=o.getProperty("DataObjectAttributeId")||o.getProperty("Id")||(o.DataObjectAttributeinfo?o.DataObjectAttributeinfo.Id:undefined);var p="/predefinedResults/"+n;if(this.getModel("settingsModel").attributeSequenceArray){this._internalModel.setProperty(p+"/AttributeSequence",parseInt(this.getModel("settingsModel").attributeSequenceArray.indexOf(n))+1);}if(this._internalModel.getProperty("/predefinedResults")){var t=[];if(this._internalModel.getProperty(p)){if(m){this._internalModel.setProperty(p+"/updateAttributeSequence",true);t=this._internalModel.getProperty(p).ASTNodes;}if(r){this._internalModel.setProperty(p+"/AccessMode",g.EDITABLE);this._internalModel.setProperty(p+"/Expression","");this._internalModel.setProperty(p+"/ASTNodes",t);this._internalModel.setProperty(p+"/updatePredefinedResults",true);}if(j){var u=this._internalModel.getProperty(p);this._internalModel.setProperty(p+"/isAttributeinBackend",true);this._internalModel.setProperty(p+"/AccessMode",s);this._internalModel.setProperty(p+"/Expression",e);this._internalModel.setProperty(p+"/ASTNodes",i);this._internalModel.setProperty(p+"/updatePredefinedResults",true);}if(!r&&!j&&s){if(this._internalModel.getProperty(p+"/AccessMode")!==s){this._internalModel.setProperty(p+"/AccessMode",s);this._internalModel.setProperty(p+"/updatePredefinedResults",true);if(s===g.HIDDEN){this._internalModel.setProperty(p+"/ASTExpressionCleared",true);}}}if(!r&&!j&&(e||e==="")){this._internalModel.setProperty(p+"/Expression",e);this._internalModel.setProperty(p+"/updatePredefinedResults",true);}if(!r&&!j&&i&&!m){this._internalModel.setProperty(p+"/ASTNodes",i);this._internalModel.setProperty(p+"/updatePredefinedResults",true);var v=this._internalModel.getProperty(p+"/AccessMode");var w=this._internalModel.getProperty(p+"/ASTExpressionCleared");var x=i.length;if(v===g.HIDDEN&&w){if((this.getAstExpressionLanguage()&&x>0)){this._internalModel.setProperty(p+"/ASTExpressionCleared",false);}}}if(this.getExpressionLanguage()&&!r&&!j){this._internalModel.setProperty(p+"/updatePredefinedResults",true);var v=this._internalModel.getProperty(p+"/AccessMode");var w=this._internalModel.getProperty(p+"/ASTExpressionCleared");if(v===g.HIDDEN&&w&&e){this._internalModel.setProperty(p+"/ASTExpressionCleared",false);}}}else{this._internalModel.setProperty(p,o.getObject(o.sPath));if(o.getObject(o.sPath).Result){this._internalModel.setProperty(p,o.getObject(o.sPath).Result);}this._internalModel.setProperty(p+"/ASTNodes",i);if(r){this._internalModel.setProperty(p+"/AccessMode",g.EDITABLE);this._internalModel.setProperty(p+"/Expression","");this._internalModel.setProperty(p+"/ASTNodes",[]);}if(j){this._internalModel.setProperty(p+"/AccessMode",s);this._internalModel.setProperty(p+"/Expression",e);this._internalModel.setProperty(p+"/ASTNodes",i);this._internalModel.setProperty(p+"/isAttributeinBackend",true);}}}if(this.expressionControl&&p&&this._internalModel.getProperty(p+"/AccessMode")===g.HIDDEN){var i=this._internalModel.getProperty(p+"/ASTNodes");if(this.getAstExpressionLanguage()&&i&&i.length>0){if(i[0].Type==="I"&&i[0].Value!==""){this.expressionControl.setValueStateText(this.oBundle.getText("PredefinedResultsValueStateText"));}else{this.expressionControl.setValueStateText("");}}else if(this.getExpressionLanguage()){if(!e){this.expressionControl.setValueStateText("");}else if(e&&this.expressionControl.getValueStateText()){this.expressionControl.setValueStateText(this.oBundle.getText("PredefinedResultsValueStateText"));}else{this.expressionControl.setValueStateText("");}}}else if(this.expressionControl&&p&&this._internalModel.getProperty(p+"/AccessMode")===g.EDITABLE){this.expressionControl.setValueStateText("");}};sap.rules.ui.DecisionTableSettings.prototype.getButtons=function(o){var e=[];var i=new B({text:this.oBundle.getText("cancelBtn")}).setTooltip(this.oBundle.getText("cancelBtnTooltip"));i.attachPress(function(){o.close();},this);var j=sap.ui.getCore().byId("ApplyBtn");if(!j){j=new B({text:this.oBundle.getText("applyChangesBtn"),id:"ApplyBtn"}).setTooltip(this.oBundle.getText("applyChangesBtnTooltip"));}j.attachPress(function(){if(!this._applyButtonPressed){sap.ui.core.BusyIndicator.show();this.multiHeaderFlag=false;this._applySettingsModelChangesToOData(o);this._applyButtonPressed=true;}},this);e.push(j);e.push(i);return e;};sap.rules.ui.DecisionTableSettings.prototype.init=function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.editableModeText=g.EDITABLE;this.hiddenModeText=g.HIDDEN;this.needCreateLayout=true;this.firstLoad=true;this.resultCounter=0;this.enableAccessValue=false;this.needToRenderPredefinedResultsTable=false;this.attributeListEmpty=false;this.astUtil=new k();this._applyButtonPressed=false;this.onsapescape=function(e){e.stopPropagation();};this._decisionTableHeaderSettingFormatter=new f();this.setBusyIndicatorDelay(0);this._destroyElement("idPredefinedTable");this._destroyElement("id_HiddenAccessMessageStrip");this._destroyElement("id_EditableAccessMessageStrip");};sap.rules.ui.DecisionTableSettings.prototype.onBeforeRendering=function(){this.mNextColumnId=this._calcNextColumnId();if(this.firstLoad){this._initSettingsModel();if(this.getProperty("newDecisionTable")===true){this.mNextColumnId=1;this._prepareNewRule();}this.firstLoad=false;}if(this.needCreateLayout){var e=this.getAggregation("mainLayout");if(e){e.destroy();}e=this._createLayout();this.setAggregation("mainLayout",e,true);this.needCreateLayout=false;this.conditionsTable.getBinding("items").attachDataRequested(function(){this.setBusy(true);}.bind(this));this.conditionsTable.getBinding("items").attachDataReceived(function(){this.setBusy(false);}.bind(this));}};sap.rules.ui.DecisionTableSettings.prototype._applySettingsModelChangesToOData=function(o){var t=this;var _;if(this.getExpressionLanguage()){_=sap.ui.getCore().byId(this.getExpressionLanguage());}else{_=sap.ui.getCore().byId(this.getAstExpressionLanguage());}var n=this.mNextColumnId;var m=this.getModel();var e=this.getModel("oDataModel");var j=this.getModel("dtModel");var s=this.getModel("settingsModel");var p=this.getBindingContext("dummy");var r=p.getProperty("Id");var v=p.getProperty("Version");var H=m.oData.DecisionTable.HitPolicy;var R=s.getProperty("/resultDataObjectChanged");var u=s.getProperty("/resultAttributeChanged");var w=s.getProperty("/resultAttributeSequenceChanged");var x=s.getProperty("/refreshButtonClicked");var y=this.getProperty("newDecisionTable");var z=[];var F={groupId:"changes"};var G=false;var J=false;var K=function(){var j1={};j1.groupId=F.groupId;var i={RuleId:r,Version:v,HitPolicy:H};var k1="/DecisionTables(Version='"+v+"',RuleId='"+r+"')";e.update(k1,i,j1);};var N=function(i){var j1={};var k1={RuleId:r,Version:v,Sequence:1,Id:1};j1.properties=k1;e.createEntry("/DecisionTableRows",j1);};var O=function(i){e.callFunction("/SetRuleResultDataObject",{method:"POST",groupId:F.groupId,urlParameters:{RuleId:r,ResultDataObjectId:(i!==g.NO_RESULT)?i:""}});};var P=function(i){var k1=s.oData.predefinedResults;if(k1){var l1;for(l1 in k1){if(k1[l1].updatePredefinedResults||k1[l1].updateAttributeSequence){G=true;var m1="/PredefinedResults(RuleId='"+r+"',DataObjectAttributeId='"+l1+"')";var n1={AccessMode:k1[l1].AccessMode,Type:"DT"};var j1={groupId:F.groupId};if(t.getAstExpressionLanguage()&&k1[l1].ASTNodes){var o1=k1[l1].Id;if(R||x){for(var p1 in z){if(z[p1].Type==="RESULT"&&z[p1].Result.DataObjectAttributeId===l1){o1=z[p1].Result.Id;break;}}}var q1="/DecisionTableColumnResults(RuleId='"+r+"',Version='"+v+"',Id="+o1+")";var r1={BusinessDataType:k1[l1].BusinessDataType};if(k1[l1].updatePredefinedResults){e.update(q1,r1,j1);$(o1,"/DeleteDTColResultASTDraft");Z(k1[l1].ASTNodes,"/DecisionTableColumnResultASTs",o1);}}else{n1.Expression=k1[l1].Expression;}if(k1[l1].SequenceChanged){n1.Sequence=k1[l1].AttributeSequence;}if(u||k1[l1].SequenceChanged){e.update(m1,n1,j1);}}}if(!k1){G=false;}}};var Q=function(){e.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:F.groupId,urlParameters:{RuleId:r}});};var U=function(i,k1){var j1={};if(!k1.getProperty("DecisionTable")){var l1={RuleId:r,Version:v,HitPolicy:H};j1.properties=l1;e.createEntry("/DecisionTables",j1);}else{K();}N();};var W=function(i,k1,l1){var j1={};var m1={RuleId:i.RuleId,Version:i.Version,Id:i.Id,Type:sap.rules.ui.DecisionTableColumn.Condition,Sequence:k1,Label:l1};j1.properties=m1;e.createEntry("/DecisionTableColumns",j1);j1.properties=i;e.createEntry("/DecisionTableColumnConditions",j1);};var X=function(i){var k1="/DecisionTableColumns(RuleId='"+r+"',Version='"+v+"',Id="+i+")";$(i,"/DeleteDTColConditionASTDraft");e.remove(k1,F);};var Y=function(g1){var k1;var l1=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");for(var i=0;i<g1.length;i++){k1=g1[i];if(k1.Condition.Expression===""){M.error(l1.getText("emptyConditionError"));J=true;return false;}else{return true;}}};var Z=function(i,k1,l1){for(var m1 in i){i[m1].Id=l1;var j1={};if(i[m1].Type==="I"){i[m1].IncompleteExpression=i[m1].Value;}j1.properties=i[m1];j1.groupId="changes";e.createEntry(k1,j1);}};var $=function(i,k1){var j1={};j1.Id=i;j1.RuleId=r;j1.Version=v;e.callFunction(k1,{method:"POST",groupId:"changes",urlParameters:j1});};var a1=function(g1,k1,h1){var l1="/DecisionTableColumns(RuleId='"+r+"',Version='"+v+"',Id=ID_PROPERTY)";var m1="/DecisionTableColumnConditions(Version='"+v+"',RuleId='"+r+"',Id=ID_PROPERTY)";var n1="/DecisionTableColumnResults(Version='"+v+"',RuleId='"+r+"',Id=ID_PROPERTY)";var o1;var Id="";var q1="";var r1={};for(var i=0;i<g1.length;i++){var s1=[];o1=g1[i];if(o1.Status){var t1;var u1;if(o1.Condition&&o1.Condition.parserResults){t1=(o1.Condition.parserResults.converted&&o1.Condition.parserResults.converted.Expression)?o1.Condition.parserResults.converted.Expression:o1.Condition.Expression;u1=(o1.Condition.parserResults.converted&&o1.Condition.parserResults.converted.FixedOperator)?o1.Condition.parserResults.converted.FixedOperator:o1.Condition.FixedOperator;}G=true;if(o1.Status==="U"){if(!(o1.Result&&k1)){Id=o1.Id;var v1={Sequence:o1.Sequence,Label:o1.Label};var w1=l1.replace("ID_PROPERTY",Id);if(o1.Label){e.update(w1,v1,F);}}if(o1.Condition){q1=m1.replace("ID_PROPERTY",Id);var x1=o1.Condition.ValueOnly;r1={Id:Id,Expression:t1?t1:o1.Condition.Expression,FixedOperator:u1?u1:o1.Condition.FixedOperator,ValueOnly:x1};e.update(q1,r1,F);if(t.getAstExpressionLanguage()&&h1[i].Condition.ASTNodes){$(Id,"/DeleteDTColConditionASTDraft");Z(h1[i].Condition.ASTNodes,"/DecisionTableColumnConditionASTs",Id);}}}else if(o1.Status==="C"){var y1={};var z1=o1.Condition;y1.Expression=t1?t1:o1.Condition.Expression;y1.FixedOperator=u1?u1:z1.FixedOperator;y1.RuleId=z1.RuleId;y1.Id=z1.Id;y1.Version=z1.Version;delete y1.parserResults;W(y1,o1.Sequence,o1.Label);if(t.getAstExpressionLanguage()){Z(h1[i].Condition.ASTNodes,"/DecisionTableColumnConditionASTs",y1.Id);}}}}};var b1=function(k1){if(!k1){return;}G=true;for(var i=0;i<k1.length;i++){var l1=k1[i];X(l1.Id);}};var c1=function(){var i=[j.getProperty("/ruleBindingPath"),"/DecisionTable/DecisionTableColumns"].join("");var k1="Condition,Result";if(t.getAstExpressionLanguage()){k1="Condition/DecisionTableColumnConditionASTs,Result/DecisionTableColumnResultASTs";}var j1={urlParameters:{"$expand":k1},success:function(l1){e.setDeferredGroups([F.groupId]);z=l1.results;i1(true);if(G){e.submitChanges({groupId:F.groupId,success:function(){sap.ui.core.BusyIndicator.hide();o.setState(sap.ui.core.ValueState.Success);o.close();return;}});}else{sap.ui.core.BusyIndicator.hide();o.setState(sap.ui.core.ValueState.Success);o.close();}}};e.read(i,j1);};var d1=function(i){var k1=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");var l1=false;sap.ui.core.BusyIndicator.hide();var m1=i.__batchResponses["0"].__changeResponses;for(var n1 in m1){if(m1[n1].message){var o1=m1[n1].response.body;M.error(o1,{title:k1.getText("RequestFailedText"),actions:[sap.m.MessageBox.Action.OK]});o.setState(sap.ui.core.ValueState.Error);l1=true;}}if((!l1||!G)&&o.isOpen()){G=false;if(R){c1();}else{sap.ui.core.BusyIndicator.hide();o.setState(sap.ui.core.ValueState.Success);o.close();}}if(!l1){sap.m.MessageToast.show(t.oBundle.getText("settingsApplySuccess"));}};var e1=function(k1){var j1={};j1.groupId=F.groupId;var h1=m.getData();var l1=h1.ResultDataObjectName;var m1=_.getResultInfo(l1);var n1=m1?m1.requiredParams:[];var o1=n1.length;for(var i=0;i<o1;i++){var p1={RuleId:r,Version:v,Id:n,Type:sap.rules.ui.DecisionTableColumn.Result,Sequence:k1};j1.properties=p1;e.createEntry("/DecisionTableColumns",j1);var q1={RuleId:r,Version:v,Id:n,DataObjectAttributeName:n1[i].name,DataObjectAttributeId:n1[i].paramId,BusinessDataType:n1[i].businessDataType};n++;k1++;j1.properties=q1;e.createEntry("/DecisionTableColumnResults",j1);}};var f1;var g1;if(this.getExpressionLanguage()){f1=_.convertRuleToCodeValues(m.oData);g1=f1.output.decisionTableData.DecisionTable.DecisionTableColumns.results;}else{g1=m.oData.DecisionTable.DecisionTableColumns.results;}e.setDeferredGroups([F.groupId]);b1(m.oData.DecisionTable.DecisionTableColumns.deleted);var h1=m.oData.DecisionTable.DecisionTableColumns.results;a1(g1,R,h1);if(x){this._findAndRemoveDeletedAttributeFromOModel();}var i1=function(i){if(u||w){P();}var k1=m.oData.needToRefresh;if(k1){G=true;Q();}if(y){G=true;U(g1.length,p);}else if(m.oData.DecisionTable.HitPolicyStatus==="U"){G=true;K(r,v,H,F);}if(y&&!i){e1(g1.length+1);}};if(R){G=true;O(m.oData.ResultDataObjectId);}else if(x){c1();}else{i1(false);}var j1={};j1.success=d1;j1.groupId=F.groupId;if(G){e.submitChanges(j1);}if(x&&this.attributeListEmpty){o.setState(sap.ui.core.ValueState.Success);sap.ui.core.BusyIndicator.hide();o.close();sap.m.MessageToast.show(this.oBundle.getText("settingsApplySuccess"));return;}if(!G&&!R&&!x&&!u){o.setState(sap.ui.core.ValueState.Success);sap.ui.core.BusyIndicator.hide();o.close();sap.m.MessageToast.show(this.oBundle.getText("settingsApplySuccess"));}};return D;},true);
