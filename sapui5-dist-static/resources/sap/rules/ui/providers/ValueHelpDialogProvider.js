/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/rules/ui/Constants","sap/ui/core/LocaleData"],function(C,L){"use strict";var v={};v._createCpValueHelp=function(a,c,r,V){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");var A=false;var b="";if(a&&a.valueListObject){this.basicMode=true;this.valueHelpMetadata=a.valueListObject.metadata;b=a.expressionLanguage.getModel().sServiceUrl;}else{this.advancedMode=true;this.valueHelpMetadata=a.metadata;var t=this.getExpressionTokens();if(t&&t.length>0){A=(t[t.length-1].tokenType!=="whitespace");}b=sap.ui.getCore().byId(this.getExpressionLanguage()).getModel().sServiceUrl;}this.businessDataType=this.valueHelpMetadata.businessDataType;this.serviceUrl=this.valueHelpMetadata.serviceURL;this.attributeId=this.valueHelpMetadata.attributeId;this.dataObjectId=this.valueHelpMetadata.dataObjectId;this.vocabularyId=this.valueHelpMetadata.vocabularyId;this._updateModal(true);if(this.oDialog){this.oDialog.destroy();}sap.ui.core.BusyIndicator.show(0);this._createDialog(b,a,c,this.businessDataType,A,r,V);};v._createDialog=function(b,a,c,d,A,r,V){this._createValueHelpDialog(b,a,c,d,A,r,V);this._createSmartFilterBar(b,a);this.oValueHelpDialog.setFilterBar(this.oFilterBar);this.oValueHelpDialog.open();this.oValueHelpDialog.getTable().setBusy(true);};v._createValueHelpDialogOLD=function(d,c,b){var t=this;var m=new sap.ui.model.json.JSONModel(d.results);this.oValueHelpDialog=new sap.ui.comp.valuehelpdialog.ValueHelpDialog({supportMultiselect:false,supportRanges:false,horizontalScrolling:false,title:t.oBundle.getText("valueHelpTitle"),key:"Name",descriptionKey:"Description",beforeOpen:function(){this.oValueHelpDialog.setModel(m,"valueHelpModel");this.oValueHelpDialog.getTable().addColumn(new sap.ui.table.Column({label:new sap.m.Text({text:t.oBundle.getText("valueHelpKeyColumnHeader")}),template:new sap.m.Text({text:"{valueHelpModel>Value}"})})).addColumn(new sap.ui.table.Column({label:new sap.m.Text({text:t.oBundle.getText("valueHelpDescriptionColumnHeader")}),template:new sap.m.Text({text:"{valueHelpModel>Description}"})})).bindRows({path:"valueHelpModel>/"});},ok:function(e){var s=e.getParameter("tokens")[0].data("row");var a=s.Value;if(b===C.DATE_BUSINESS_TYPE){a=t._formatDate(a);}if(a){t.sKey=a;t.setIntructionToken(a);t.valueHelpCtrl.setValue(a);t.valueHelpCtrl.fireChange();}this.oValueHelpDialog.close();t._updateModal(false);t.focus(t.codeMirror);},cancel:function(){t._updateModal(false);this.oValueHelpDialog.close();t.focus(t.codeMirror);},afterClose:function(){t._updateModal(false);this.oValueHelpDialog.destroy();t.focus(t.codeMirror);}});this.oValueHelpDialog.setModel(m);this.oValueHelpDialog.open();};v._createValueHelpDialog=function(b,a,c,d,A,r,V){var t=this;var e=a.expressionLanguage.getModel();var f="Attributes(Id='"+this.attributeId+"',VocabularyId='"+this.vocabularyId+"',DataObjectId='"+this.dataObjectId+"')";if(f.includes(":")){f=f=f.replace(":","%3A");}this.attributeName=e.oData[f].Name;sap.ui.core.BusyIndicator.show(0);this.oValueHelpDialog=new sap.ui.comp.valuehelpdialog.ValueHelpDialog({supportMultiselect:false,supportRanges:false,horizontalScrolling:false,title:t.attributeName,resizable:false,beforeOpen:function(){t._bindTable(b,a);},ok:function(E){var s=E.getParameter("tokens")[0].data("row");var g=s.Value;if(d===C.DATE_BUSINESS_TYPE){g=t._formatDate(g);}if(d===C.NUMBER){g=parseInt(g);}if(t.basicMode){var o=sap.ui.getCore().byId("valueHelpCtrl");o.setValue(g);o.fireChange();}else{t.setTextOnCursor(g,c,r,d,A,V);}t._updateModal(false);t.oValueHelpDialog.close();t.focus(t.codeMirror);},cancel:function(){t._updateModal(false);t.oValueHelpDialog.close();t.focus(t.codeMirror);},afterClose:function(){t._updateModal(false);t.oValueHelpDialog.destroy();t.focus(t.codeMirror);t.oFilterBar.destroy();sap.ui.core.BusyIndicator.hide();}});};v.setTextOnCursor=function(V,c,r,b,a,d){function g(n,p){var q=n+1;for(var j=q;j<p.length;j++){if(p[j].length===0){q++;}else{break;}}return q;}var T="String",e="Date",f="Timestamp",h="Time";var k;var F=((b===T)||(b===e)||(b===f)||(b===h))?"'"+V+"'":V;var t=this.getExpressionTokens();var l=this.getValue().split("\n");var m=-1;var o={start:{line:c.line,ch:c.ch},end:{line:c.line,ch:c.ch}};for(var i=0;i<t.length;i++){m=(t[i].start===0)?g(m,l):m;if(m===c.line&&(t[i].end>c.ch)||(t[i].end>=c.ch&&d)){o.start.ch=t[i].start;o.end.ch=t[i].end;r=true;break;}}if(r){this.codeMirror.replaceRange(F,o.start,o.end);k=this.codeMirror.findPosH(o.start,F.length,"char",true);this.codeMirror.setCursor(k);}else{F=a?" "+F:F;this.codeMirror.replaceRange(F,c);k=this.codeMirror.findPosH(c,F.length,"char",true);this.codeMirror.setCursor(k);}var E=sap.ui.getCore().byId(this.getExpressionLanguage());this.getFormattingTokens(E);this.ValueHelpRequested=false;};v.focus=function(){if(this.codeMirror){var l=this.codeMirror.getLine(this.codeMirror.lastLine());var c=l.length;this.codeMirror.setCursor({line:this.codeMirror.lastLine(),ch:c});this.codeMirror.focus();}};v._updateModal=function(m){var p=sap.ui.getCore().byId("popover");if(p){p.setModal(m);}};v._formatDate=function(a){var l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var o=L.getInstance(l);this.oFormatDate=sap.ui.core.format.DateFormat.getInstance({pattern:o.getDatePattern('short'),calendarType:sap.ui.core.CalendarType.Gregorian},l);return this.oFormatDate.format(this.oFormatDate.parse(a));};v._createSmartFilterBar=function(b,a){var t=this;if(this.basicMode){this.entitySet=a.valueListObject.metadata.entitySet;a=a.valueListObject;}else{this.entitySet=a.metadata.entitySet;}this.oFilterBar=new sap.ui.comp.smartfilterbar.SmartFilterBar({entitySet:t.entitySet,enableBasicSearch:true,advancedMode:true,filterBarExpanded:true,search:function(){t.onSearch(b,a);},filterChange:function(e){t.setValueStateFilter(e);},controlConfiguration:[t._createControlConfiguration()]});var m=new sap.ui.model.odata.v2.ODataModel(b);this.oFilterBar.setModel(m);};v._createControlConfiguration=function(){var c=[new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Value",label:"Value",visibleInAdvancedArea:true,width:"100px",index:1}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Description",label:"Description",visibleInAdvancedArea:true,width:"100px",index:2}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"VocabularyId",label:"VocabularyId",width:"100px",visible:false,index:3}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"DataObjectId",label:"DataObjectId",visible:false,width:"100px",groupId:"abc",index:4}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"AttributeId",label:"AttributeId",visible:false,width:"100px",index:5}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Version",label:"Version",visible:false,width:"100px",index:6})];return c;};v.onSearch=function(b,a){this.oValueHelpDialog.getTable().setBusy(true);this._unBindTable();this._bindTable(b,a);};v._bindTable=function(b,a){var s=this.serviceUrl;var f=this._fetchFilterParams(a);var e={valueHelp:{collection:s,properties:[C.PROPERTY_VALUE,C.PROPERTY_DESCRIPTION]}};var t=this.oValueHelpDialog.getTable();t.setThreshold(10);for(var i=0;i<e.valueHelp.properties.length;i++){this._addValueHelpColumn(e.valueHelp.properties[i],t);}var m=new sap.ui.model.odata.v2.ODataModel(b);t.setModel(m);t.bindRows(e.valueHelp.collection,null,f);t.getBinding("rows").attachDataReceived(this._handleRowsDataReceived,this);};v._handleRowsDataReceived=function(e){var t=this;var d=e.getParameter("data");if(jQuery.isEmptyObject(d)||(d&&d.results&&d.results.length===0)){this.oValueHelpDialog.getTable().setNoData(t.oBundle.getText("no_data"));}else{this.oValueHelpDialog.getTable().setNoData(t.oBundle.getText("searching"));}this.oValueHelpDialog.getTable().setBusy(false);};v._addValueHelpColumn=function(c,t){var o=new sap.ui.table.Column().setLabel(new sap.m.Label({text:c}));if(c===C.PROPERTY_VALUE){o.setSortProperty(c);}t.addColumn(o.setTemplate(new sap.m.Text().bindProperty("text",c)));};v._unBindTable=function(){var t=this.oValueHelpDialog.getTable();t.destroyColumns();t.unbindRows();};v._fetchFilterParams=function(a){var t=this;var s=[];var f=[new sap.ui.model.Filter("AttributeId",sap.ui.model.FilterOperator.EQ,this.attributeId),new sap.ui.model.Filter("DataObjectId",sap.ui.model.FilterOperator.EQ,this.dataObjectId),new sap.ui.model.Filter("VocabularyId",sap.ui.model.FilterOperator.EQ,this.vocabularyId)];var F=this.oFilterBar.getFilters();var b=this.oFilterBar.getParameters();if(!jQuery.isEmptyObject(b)&&F&&F.length>0){b=this.oFilterBar.getParameters().custom.search;s=this._getSearchFilters(b);F=t._formatFilterParams(F);f.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(F),new sap.ui.model.Filter(s)],and:true}));}else if(!jQuery.isEmptyObject(b)){b=this.oFilterBar.getParameters().custom.search;s=this._getSearchFilters(b);f.push(s);}else if(F&&F.length>0){F=t._formatFilterParams(F);f.push(F[0]);}return f;};v._formatFilterParams=function(f){var t=this;if(f[0]&&f.length===1&&f[0].aFilters[0]&&f[0].aFilters[0].sOperator){f=t._formatSingleFilter(f);}else if(f[0]&&f[0].aFilters[0]&&f[0].aFilters[0].aFilters[0]&&f[0].aFilters[0].aFilters[0].aFilters&&f[0].aFilters[1].aFilters[0].aFilters){f=t._formatMultiFilter(f,0,true);f=t._formatMultiFilter(f,1,true);}else if(f[0]&&f[0].aFilters[0]&&f[0].aFilters[1]&&f[0].aFilters[0].aFilters[0]&&f[0].aFilters[0].aFilters[0].aFilters&&f[0].aFilters[1].aFilters){f=t._formatMultiFilter(f,0,true);f=t._formatMultiFilter(f,1,false);}else if(f[0]&&f[0].aFilters[0]&&f[0].aFilters[1]&&f[0].aFilters[1].aFilters[0]&&f[0].aFilters[0].aFilters&&f[0].aFilters[1].aFilters[0].aFilters){f=t._formatMultiFilter(f,0,false);f=t._formatMultiFilter(f,1,true);}else if(f[0]&&f[0].aFilters[0]&&f[0].aFilters[1]&&f[0].aFilters[0].aFilters&&f[0].aFilters[1].aFilters){f=t._formatMultiFilter(f,0,false);f=t._formatMultiFilter(f,1,false);}return f;};v._formatSingleFilter=function(f){var t=this;var _=null;for(var i=0;i<f[0].aFilters.length;i++){if(f[0].aFilters[i].sOperator==="Contains"){f[0].aFilters[i].sOperator="EQ";}else if(f[0].aFilters[i].sOperator==="BT"){var c=t._manageParam(f[0].aFilters[i].sPath,f[0].aFilters[i].sOperator,f[0].aFilters[i].oValue1,f[0].aFilters[i].oValue2);delete f[0].aFilters[i];f[0].aFilters[i]=c;}else if(f[0].aFilters[i].sOperator==="StartsWith"){_=(f[0].aFilters[i].sPath===C.PROPERTY_VALUE)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(f[0].aFilters[i].sOperator+" operator not supported");}else if(f[0].aFilters[i].sOperator==="EndsWith"){_=(f[0].aFilters[i].sPath===C.PROPERTY_VALUE)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(f[0].aFilters[i].sOperator+" operator not supported");}}return f;};v._formatMultiFilter=function(f,i,m){var t=this;var _=null;var c=[];if(m){c=f[0].aFilters[i].aFilters[0].aFilters;}else{c=f[0].aFilters[i].aFilters;}for(var a=0;a<c.length;a++){if(c[a].sOperator==="Contains"){c[a].sOperator="EQ";}else if(c[a].sOperator==="BT"){var b=t._manageParam(c[a].sPath,c[a].sOperator,c[a].oValue1,c[a].oValue2);delete c[a];c[a]=b;}else if(c[a].sOperator==="StartsWith"){_=(c[a].sPath===C.PROPERTY_VALUE)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(c[a].sOperator+" operator not supported");}else if(c[a].sOperator==="EndsWith"){_=(c[a].sPath===C.PROPERTY_VALUE)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(c[a].sOperator+" operator not supported");}}return f;};v._manageParam=function(p,o,a,b){var f=[];if(a&&b){f=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(p,sap.ui.model.FilterOperator.GT,a),new sap.ui.model.Filter(p,sap.ui.model.FilterOperator.LT,b)],and:true});}return f;};v._getSearchFilters=function(s){return new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(C.PROPERTY_VALUE,sap.ui.model.FilterOperator.EQ,s),new sap.ui.model.Filter(C.PROPERTY_DESCRIPTION,sap.ui.model.FilterOperator.EQ,s)],and:false});};v.setValueStateFilter=function(e){var i=e.getSource().sId;this._valueFieldValue=sap.ui.getCore().byId(i+"-filterItemControlA_-Value");if(this._valueFieldValue){this._valueFieldValue.setValueState("None");this._valueFieldValue.setValueStateText("");}this._valueFieldDescription=sap.ui.getCore().byId(i+"-filterItemControlA_-Description");if(this._valueFieldDescription){this._valueFieldDescription.setValueState("None");this._valueFieldDescription.setValueStateText("");}};return v;},true);
