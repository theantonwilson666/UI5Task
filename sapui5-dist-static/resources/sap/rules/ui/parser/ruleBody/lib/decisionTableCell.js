jQuery.sap.declare("sap.rules.ui.parser.ruleBody.lib.decisionTableCell");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.parsingBackendMediator");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.ASTConvertor");jQuery.sap.require("sap.rules.ui.parser.infrastructure.errorHandling.hrfException");jQuery.sap.require("sap.rules.ui.parser.infrastructure.messageHandling.lib.responseCollector");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.constants");jQuery.sap.require("sap.rules.ui.parser.ruleBody.lib.constants");jQuery.sap.require("sap.rules.ui.parser.AST.lib.bundleAst");jQuery.sap.require("sap.rules.ui.parser.resources.vocabulary.lib.constants");sap.rules.ui.parser.ruleBody.lib.decisionTableCell=sap.rules.ui.parser.ruleBody.lib.decisionTableCell||{};sap.rules.ui.parser.ruleBody.lib.decisionTableCell.lib=(function(){var p=new sap.rules.ui.parser.businessLanguage.lib.parsingBackendMediator.lib.parsingBackendMediatorLib();var A=sap.rules.ui.parser.businessLanguage.lib.ASTConvertor.lib;var h=sap.rules.ui.parser.infrastructure.errorHandling.hrfException.lib;var r=sap.rules.ui.parser.infrastructure.messageHandling.lib.responseCollector.lib.ResponseCollector;var a=sap.rules.ui.parser.businessLanguage.lib.constants.lib;var b=sap.rules.ui.parser.ruleBody.lib.constants.lib;var c=RulesAPI_Ast;var d=c.astOperations;var v=sap.rules.ui.parser.resources.vocabulary.lib.constants.lib;function D(i,l,m,o,q,t){this.cellExpression=m;this.headerExpression=i;this.operator=l;this.businessDataType=o;this.vocabulary=q;this.vocaDataProvider=t;this.status=a.statusEnum.SUCCESS;this.convertedHeader={};this.convertedHeader.text=null;this.convertedHeader.AST=null;this.convertedCell={};this.convertedCell.text=null;this.convertedCell.AST=null;this.convertedCondition={};this.convertedCondition.text=null;this.convertedCondition.AST=null;this.convertedOperator={};this.convertedOperator.text=this.operator;this.convertedOperator.AST=null;this.valueHelp=null;this.tokensRequested=false;this.tokens=[];this.headerTokens=[];this.operatorTokens=[];this.cellTokens=[];this.currCursorInfo={};this.needASTResult=false;}var s=function s(o){var i=null;if(o&&o.hasOwnProperty(b.expressionProperties.AST)&&o.hasOwnProperty(b.expressionProperties.text)){i={};i[b.expressionProperties.text]=o[b.expressionProperties.text];if(o[b.expressionProperties.AST]){i[b.expressionProperties.AST]=JSON.parse(o[b.expressionProperties.AST].serialize());}else{i[b.expressionProperties.AST]=null;}i=JSON.stringify(i);}return i;};var e=function e(t){t=t.replace(/(\r\n|\n|\r|\t|\f)/gm," ");return JSON.parse(t);};var f=function f(i,l,o){var m='';if(i){m+=i;}if(o){m+=" "+o;}if(l){m+=" "+l;}return m;};var g=function g(i,l,o){var m,q=0,t=l.length;if(i){q=i.length+1;t=l.length-i.length-1;if(o){q+=o.length+1;t-=(o.length+1);}}m=l.substr(q,t);return m;};var j=function j(i){var l;var m;var o=false;if(i){l=parseInt(i.replace(/\./g,''),10);m=parseInt(a.supportedVersions.NEW_AST.replace(/\./g,''),10);o=(l>=m);}return o;};var n=function n(i,l,m){var o=false;var t=m?m.getTermModes():null;if(j(l)){if(i&&((i[a.propertiesEnum.locale]&&i[a.propertiesEnum.locale][a.propertiesEnum.convert]&&i[a.propertiesEnum.locale][a.propertiesEnum.convert][a.propertiesEnum.source]===a.CODE_TEXT)||(i.hasOwnProperty(a.propertiesEnum.termMode)&&i[a.propertiesEnum.termMode].hasOwnProperty(a.propertiesEnum.convert)&&i[a.propertiesEnum.termMode][a.propertiesEnum.convert]&&i[a.propertiesEnum.termMode][a.propertiesEnum.convert][a.propertiesEnum.source]===a.CODE_TEXT))){o=true;}else if(!((i&&i.hasOwnProperty(a.propertiesEnum.locale)&&i[a.propertiesEnum.locale].hasOwnProperty(a.propertiesEnum.convert))||(i&&i.hasOwnProperty(a.propertiesEnum.termMode)&&i[a.propertiesEnum.termMode].hasOwnProperty(a.propertiesEnum.convert)))&&t&&t.indexOf(v.TermModeRelated.TERM_MODE_BY_DESCRIPTION)===-1){o=true;}}return o;};var k=function k(i,l){var m=false;if(j(l)&&i&&((i[a.propertiesEnum.locale]&&i[a.propertiesEnum.locale][a.propertiesEnum.convert]&&i[a.propertiesEnum.locale][a.propertiesEnum.convert][a.propertiesEnum.target]===a.CODE_TEXT)||(i.hasOwnProperty(a.propertiesEnum.termMode)&&i[a.propertiesEnum.termMode].hasOwnProperty(a.propertiesEnum.convert)&&i[a.propertiesEnum.termMode][a.propertiesEnum.convert]&&i[a.propertiesEnum.termMode][a.propertiesEnum.convert][a.propertiesEnum.target]===a.CODE_TEXT))){m=true;}return m;};D.prototype.deserializeExpressionParts=function i(){this.headerExpression=this.headerExpression?e(this.headerExpression).text:null;this.cellExpression=this.cellExpression?e(this.cellExpression).text:null;this.operator=this.operator?e(this.operator).text:null;};D.prototype.getParserAST=function w(i,l,m,o,q){function t(i){if(i===null||i===undefined||i===""){return true;}return false;}var u=p.parseInputRT(i,l,this.vocaDataProvider,m,o,this.vocabulary,q);if(u===undefined||(u===null&&t(i)===false)){r.getInstance().addMessage("error_in_parsing_expression",[i]);throw new h.HrfException("error_in_parsing_expression: "+i,false);}if(l===p.PARSE_MODE){if(u!==null&&u.status===a.statusEnum.ERROR){throw new h.HrfException('',false);}}return u;};D.prototype.getParserConvertedExpression=function l(i){return i[b.parserResultEnum.convertedExpression];};D.prototype.hasParserConvertedExpression=function l(i){if(i.status===a.statusEnum.SUCCESS){if(!i.hasOwnProperty(a.propertiesEnum.convertedExpression)){this.status=a.statusEnum.ERROR;}else{return true;}}return false;};D.prototype.validateAndConvert=function E(l,m){var o;var q;var t;if(l.hasOwnProperty(a.propertiesEnum.tokens)&&(l[a.propertiesEnum.tokens]===true)){this.tokensRequested=true;}function u(i){var F={};if(this.convertedHeader.text&&i>this.convertedHeader.text.length){F.position=i-this.convertedHeader.text.length-this.convertedOperator.text.length-2;F.expressionPart=b.expressionParts.cell;}else{F.position=i;F.expressionPart=b.expressionParts.header;}return F;}function w(i){var F={};if(i){if(i.hasOwnProperty('cursorPosition')&&i.cursorPosition!==undefined&&i.cursorPosition!==null){F.cursorInfo=u.call(this,i.cursorPosition);}r.getInstance().addMessage(i.errorID,undefined,null,F,i.errorDetails);}}function x(){var t={};t.status=this.status;if(this.status===a.statusEnum.SUCCESS){if(this.convertedCell.text||this.convertedHeader.text){t.converted={};if(this.needASTResult){t.converted.header=s(this.convertedHeader);t.converted.fixedOperator=s(this.convertedOperator);t.converted.cell=s(this.convertedCell);}else{t.converted.header=this.convertedHeader.text;t.converted.fixedOperator=this.convertedOperator.text;t.converted.cell=this.convertedCell.text;}}t.actualReturnType=this.actualReturnType;if(this.valueHelp){t.valueHelp=this.valueHelp;}}if(this.tokensRequested){t.tokens={};t.tokens.header=this.headerTokens;t.tokens.fixedOperator=this.operatorTokens;t.tokens.cell=this.cellTokens;}return t;}function y(){if(this.operator){this.operatorTokens=this.getParserAST(this.operator,a.TOKEN_TYPES,null,null,l);}else{this.operatorTokens=[];}var F=0;var G=0;var H=0;if(this.headerExpression){F=this.headerExpression.length;}if(this.operator){G=this.operator.length+1;}if(this.cellExpression){H=1;}var I=F+G+H;var J=0;var K=this.tokens;var L=false;var i=0;for(i=0;i<K.length;++i){if(K[i].start===I){J=i;L=true;break;}if((K[i].start<I)&&(I<=K[i].end)){J=i;K[i].start=I;L=true;break;}if(K[i].end<I){continue;}}if(L){for(i=J;i<K.length;++i){K[i].start-=I;K[i].end-=I;this.cellTokens.push(K[i]);}}}function z(i,q,l){var F;var G=null;var H={};var I=null;var J={};H.text=null;H.AST=null;F=this.getParserAST(i,a.VALIDATE_MODE,null,q,l);if(this.tokensRequested){if(F.tokens){G=F.tokens;}else{G=[];}}if(F.status===a.statusEnum.SUCCESS){this.actualReturnType=F.actualReturnType;if(F.valueHelp){this.valueHelp=F.valueHelp;}if(F.hasOwnProperty(a.propertiesEnum.convertedExpression)){H.text=this.getParserConvertedExpression(F);if(this.needASTResult){I=new A.ASTConvertor(F.model);H.AST=I.getAST();}}}else{w.call(this,F);this.status=a.statusEnum.ERROR;}J.converted=H;J.tokens=G;return J;}this.needASTResult=k(l,m);if(n(l,m,this.vocaDataProvider)){this.deserializeExpressionParts();}var B={};if(this.headerExpression){B=z.call(this,this.headerExpression,a.TYPE_SINGLE_EXPRESSION,l);this.convertedHeader=B.converted;this.headerTokens=B.tokens;}if(this.status===a.statusEnum.SUCCESS&&this.cellExpression){o=f(this.headerExpression,this.cellExpression,this.convertedOperator.text);q=this.businessDataType||a.TYPE_BOOLEAN_ENHANCED;B=z.call(this,o,q,l);this.convertedCondition=B.converted;this.tokens=B.tokens;if(this.status===a.statusEnum.SUCCESS&&this.convertedCondition&&this.convertedCondition.text){this.convertedCell.text=g(this.convertedHeader.text,this.convertedCondition.text,this.convertedOperator.text);if(this.needASTResult){var C=d.split(this.convertedHeader.AST,this.convertedCondition.AST,A.ASTConvertor.operatorsMap[this.convertedOperator.text]);if(C){this.convertedOperator.AST=C.operator;this.convertedCell.AST=C.rest;}else{this.convertedOperator.AST=this.convertedOperator.text?d.buildOperator(A.ASTConvertor.operatorsMap[this.convertedOperator.text]):null;this.convertedCell.AST=null;}}}}if(this.tokensRequested){y.call(this);}t=x.call(this);return t;};return{DecisionTableCell:D,isASTVersion:j,needDeserializeInput:n,needASTResult:k,serializeExpression:s,deserializeExpression:e,concatToDecisionTableCondition:f,splitDecisionTableCondition:g};}());
