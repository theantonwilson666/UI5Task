/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/ui/thirdparty/jquery","./library","sap/m/Label","sap/rules/ui/RuleBase","sap/m/Panel","sap/ui/core/Title","sap/ui/layout/form/Form","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/Text","sap/m/Button","sap/ui/layout/Grid","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement","sap/rules/ui/ExpressionAdvanced","sap/m/Link","sap/m/FlexBox","sap/m/Dialog","sap/rules/ui/TextRuleSettings","sap/rules/ui/oldast/lib/AstYamlConverter","sap/rules/ui/Constants","sap/rules/ui/AstExpressionBasic","sap/rules/ui/services/ExpressionLanguage","sap/rules/ui/services/AstExpressionLanguage"],function(L,q,l,a,R,P,T,F,b,c,d,B,G,f,g,E,h,k,D,m,A,C,n,o,p){"use strict";var r=R.extend("sap.rules.ui.TextRule",{metadata:{properties:{enableSettings:{type:"boolean",group:"Misc",defaultValue:false},enableElse:{type:"boolean",defaultValue:true},enableElseIf:{type:"boolean",defaultValue:true}},aggregations:{"_toolbar":{type:"sap.m.Toolbar",multiple:false,singularName:"_toolbar"},"_verticalLayout":{type:"sap.ui.core.Control",multiple:false,visibility:"visible",singularName:"_verticalLayout"}}},_addConditionBlock:function(e,t){var i=this;var j=this._getModel();var s=e.getSource();var u=s.getParent();if(t===this.typeElseIf&&!(u instanceof P)){u=s.getParent().getParent();}var v=u.getParent();var w=v.indexOfContent(u);var x=this._internalModel.getProperty("/ruleId");var y=this._internalModel.getProperty("/ruleVersion");var z=w+1;var H=false;var I;var K;var J={RuleId:x,RuleVersion:y};if(t===i.typeElse){K="/TextRuleDefaultBranches";H=true;}else{K="/TextRuleBranches";if(s.getParent()instanceof P){I=z;H=true;}else{I=z+1;}J.Sequence=I;}this._updateBusyState(true);var M={};M.properties=J;M.success=function(N){var O={};O.verticalLayout=v;O.nIndex=w;O.bfirst=H;i._addConditionSuccess(N,i,O);if(H){s.destroy();}};M.error=function(){L.info("Error creating "+K+"entity");};j.createEntry(K,M);},_addConditionSuccess:function(e,t,i){var N;var j;var s=e.Id;var u=t._getModel();var H={RuleId:e.RuleId,Id:s,RuleVersion:e.RuleVersion};var v=u.createKey("/TextRuleConditions",H);var w=new sap.ui.model.Context(u,v);var x="TextRuleResultExpressions";if(this.getAstExpressionLanguage()){x="TextRuleResultExpressions/TextRuleResultExpressionASTs,TextRuleConditionASTs"}u.read(v,{urlParameters:{"$expand":x},success:function(y){var V=i.verticalLayout;t.getModel("displayModel").getProperty("/textRuleConditions").push(y);t.getModel("displayModel").setProperty("/bCancelButtonVisible("+y.Id+")",y.TextRuleResultExpressions.results.length>1);if(y.Type===t.typeElse){t.getModel("displayModel").getProperty("/textRuleConditions/Else").push(y);var z=t._createElseFormLayout(w,t.oBundle.getText("titleElse"),true);V.removeContent(i.nIndex);V.insertContent(z,i.nIndex);}else if(y.Type===t.typeElseIf){t.getModel("displayModel").getProperty("/textRuleConditions/ElseIf").push(y);if(i.bfirst){j=i.nIndex;V.removeContent(i.nIndex);}else{j=i.nIndex+1;}N=" ("+j+")";var I=t._createFormLayout(w,t.oBundle.getText("titleElseIf")+N,true);V.insertContent(I,j);t._adjustElseIfTitle(i.verticalLayout,j,true);}t._updateBusyState(false);sap.m.MessageToast.show(t.oBundle.getText("branchCreatedSuccess"));},error:function(){L.info("Error reading TextRuleResultExpressions");}});},_adjustElseIfTitle:function(v,e,i){var j=v.getContent();var s=this.oBundle.getText("titleElseIf");var t;if(i){t=e+1;}else{t=e;}for(;t<j.length;t++){var u=j[t];if(u.getHeaderText().indexOf(s)>-1&&u.getHeaderToolbar()){u.getHeaderToolbar().getContent()[0].setText(s+" ("+t+")");}}},_addToolBar:function(){var t=new b({design:"Transparent",enabled:"{TextRuleModel>/editable}"});var e=new sap.m.Title({text:this.oBundle.getText("textRule")});var s=new B({text:"",press:this._openTextRuleSettings.bind(this),visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},enabled:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement}}).setTooltip(this.oBundle.getText("settings"));s.setIcon("sap-icon://action-settings");t.addContent(e);t.addContent(new c({}));t.addContent(s);t.addContent(new c({width:"1em"}));this.setAggregation("_toolbar",t,true);},_addTextRuleControl:function(){this.verticalLayout=new sap.ui.layout.VerticalLayout({width:"100%"});this.setAggregation("_verticalLayout",this.verticalLayout,true);},_bindRule:function(){var t=this;var M=this._getModel();var s=[this._getBindModelName(),this.getBindingContextPath()].join("");if(s&&M){M.setDeferredGroups(["read"]);M.read(s,{groupId:"read",urlParameters:{"$expand":"TextRule"}});var e=[s,"/TextRule/TextRuleResults"].join("");var i={groupId:"read"};if(this.getAstExpressionLanguage()){i.urlParameters={"$expand":"TextRuleResultASTs"};}M.read(e,i);var j="TextRuleResultExpressions";if(this.getAstExpressionLanguage()){j="TextRuleResultExpressions/TextRuleResultExpressionASTs,TextRuleConditionASTs"}e=[s,"/TextRule/TextRuleConditions"].join("");M.read(e,{groupId:"read",urlParameters:{"$expand":j}});M.submitChanges({groupId:"read",success:function(u){t._handleVerticalLayoutDataReceived(u);},error:function(){L.info("Error reading TextRule data from backend");}});}},_bindVerticalLayout:function(){var I=this._getIfPanel();this.verticalLayout.addContent(I);if(this.getEnableElseIf()===true){var e=this._getElseIfPanel();for(var i=0;i<e.length;i++){this.verticalLayout.addContent(e[i]);}}if(this.getEnableElse()===true){var j=this._getElsePanel();this.verticalLayout.addContent(j[0]);}},_createFormLayout:function(e,t,i){var j=this;var s=new b({design:"Transparent"});var u=new sap.m.Title({text:t});s.addContent(u);var v=new P({expandable:true,expanded:i,height:"100%",backgroundDesign:"Translucent",content:[new F({editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout({labelSpanXL:2,labelSpanL:2,labelSpanM:2,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:4,emptySpanL:4,emptySpanM:4,emptySpanS:4,columnsL:1,columnsM:1}),formContainers:[j._createIfBlockFormContainer(e,t),]}),new F({editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout({labelSpanXL:2,labelSpanL:2,labelSpanM:2,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:3,emptySpanL:3,emptySpanM:3,emptySpanS:3,columnsL:1,columnsM:1}),formContainers:[j._createThenFormContainer(e,this.oBundle.getText("then"))]})]}).addStyleClass("sapTextRulePanel");if(t!==this.typeIf){var w=new B({visible:"{TextRuleModel>/editable}",text:this.oBundle.getText("addButton"),tooltip:this.oBundle.getText("addNewElseIf"),press:function(y){j._addConditionBlock(y,j.typeElseIf);}}).setBindingContext(e);var x=new B({text:this.oBundle.getText("deleteButton"),tooltip:this.oBundle.getText("deleteElseIf"),visible:"{TextRuleModel>/editable}",press:function(y){j._deleteConditionBlock(y);}}).setBindingContext(e);s.addContent(new c());s.addContent(w);s.addContent(new c({width:"0.5px"}));s.addContent(x);}v.setHeaderToolbar(s);return v;},_createElseFormLayout:function(e,t,i){var j=this;var s=new b({design:"Transparent"});var u=new sap.m.Title({text:t});var v=new B({text:this.oBundle.getText("deleteButton"),tooltip:this.oBundle.getText("deleteElse"),visible:"{TextRuleModel>/editable}",press:function(x){j._deleteConditionBlock(x);}}).setBindingContext(e);s.addContent(u);s.addContent(new c());s.addContent(v);var w=new P({expandable:true,expanded:i,height:"100%",backgroundDesign:"Translucent",content:new F({editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout({labelSpanXL:2,labelSpanL:2,labelSpanM:2,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:3,emptySpanL:3,emptySpanM:3,emptySpanS:3,columnsL:1,columnsM:1}),formContainers:[this._createThenFormContainer(e,t)]})}).addStyleClass("sapTextRulePanel");w.setHeaderToolbar(s);return w;},_createIfBlockFormContainer:function(e,t){var i=e?e.getProperty("Expression"):"";var j=true;var s=new f({formElements:[new g({label:new a({text:""}),fields:[this._getExpressionAdvancedText(e,i,undefined,undefined,j)]})]});return s;},_createThenFormContainer:function(e,t){var s=new f({visible:false});if(e.getProperty("Type")!==this.typeElse){var u=new b({content:[new c({width:"2em"}),new a({text:t}).addStyleClass("sapTextRuleFontSize")]});s.setToolbar(u);}var v=e.getProperty("Id");var w=this.getModel("displayModel").getProperty("/textRuleConditions");for(var i=0;i<w.length;i++){if(v===w[i].Id){var x=w[i].TextRuleResultExpressions.results;if(x){for(var j=0;j<x.length;j++){var H={RuleId:x[j].RuleId,ConditionId:x[j].ConditionId,ResultId:x[j].ResultId,RuleVersion:x[j].RuleVersion};var y=this._getModel().createKey("/TextRuleResultExpressions",H);var z=new sap.ui.model.Context(this._getModel(),y);var I=x[j].BusinessDataType;if(this.getExpressionLanguage()){if(I===C.DATE_BUSINESS_TYPE||I===C.TIMESTAMP_BUSINESS_TYPE||I===C.NUMBER||I===C.STRING||I===C.BOOLEAN_BUSINESS_TYPE||I===C.BOOLEAN_ENHANCED_BUSINESS_TYPE){s.addFormElement(this._formElementsFactory(t+"result"+j,z));}}else{s.addFormElement(this._formElementsFactory(t+"result"+j,z));}}}}}var J=s.getFormElements();for(var K in J){if(J[K].getVisible()){s.setVisible(true);break;}}return s;},_createTextRuleSettings:function(){var M=this._getModel();var e=this.getBindingContext();var t=new m({newTextRule:this._internalModel.getProperty("/newTextRule")});if(this.getAstExpressionLanguage()){t.setAstExpressionLanguage(this.getAstExpressionLanguage());}else{t.setExpressionLanguage(this.getExpressionLanguage());}var s=JSON.stringify(this._settingsModel.getData());var i=JSON.parse(s);var j=new sap.ui.model.json.JSONModel(i);t.setModel(j);t.setModel(this._internalModel,"TextRuleModel");t.setModel(M,"oDataModel");t.setBindingContext(e,"dummy");return t;},_decideSettingsEnablement:function(e,i){return e&&i;},_deleteConditionBlock:function(e){var t=this;var i=this._getModel();var s=e.getSource();var j=s.getParent().getParent();var v=j.getParent();var u=v.indexOfContent(j);var w=s.getBindingContext();var x=w.getProperty("Id");var y=w.getProperty("Type");var K;if(y===t.typeElse){K="/TextRuleDefaultBranches";}else if(y===t.typeElseIf){K="/TextRuleBranches";}var H={RuleId:w.getProperty("RuleId"),Id:x,RuleVersion:w.getProperty("RuleVersion")};var z=i.createKey(K,H);var _=function(){var j;v.removeContent(u);if(y===t.typeElse){t.getModel("displayModel").setProperty("/textRuleConditions/Else",[]);j=t._getElsePanel();v.insertContent(j[0],u);}else{if(u===1&&v.getContent().length<=2){t.getModel("displayModel").setProperty("/textRuleConditions/ElseIf",[]);j=t._getElseIfPanel();v.insertContent(j[0],u);}else{var I=t.getModel("displayModel").getProperty("/textRuleConditions/ElseIf");for(var J in I){if(I[J].Id===x){I.splice(J,1);t.getModel("displayModel").setProperty("/textRuleConditions/ElseIf",I);break;}}}t._adjustElseIfTitle(v,u,false);}t._updateBusyState(false);sap.m.MessageToast.show(t.oBundle.getText("branchDeletedSuccess"));};this._updateBusyState(true);i.remove(z,{success:function(I){_();},error:function(){L.info("Error deleting "+K+"entity");}});},_formRuleData:function(e,i){var j=this.getBindingContextPath();var s=j.split("/")[2];var t=e.getProperty("RuleId");var v=e.getProperty("Version");var u=q.extend({},this.getModel().oData);u=u[s];if(!u){u={};}if(!u.DecisionTable){u.DecisionTable={};}u.Type="DT";u.DecisionTable.metadata={};u.DecisionTable.RuleID=t;u.DecisionTable.version=v;u.DecisionTable.HitPolicy="FM";u.DecisionTable.DecisionTableColumns={};u.DecisionTable.DecisionTableColumns.results=[];u.DecisionTable.DecisionTableColumns.results.push({"metadata":{},"RuleId":t,"Id":1,"Version":v,"Sequence":1,"Type":"CONDITION","Condition":{"metadata":{},"RuleId":t,"Id":1,"Version":v,"Expression":i,"Description":null,"ValueOnly":false,"FixedOperator":null},"Result":null});u.DecisionTable.DecisionTableRows={};u.DecisionTable.DecisionTableRows.results=[];u.DecisionTable.DecisionTableColumnsCondition={};u.DecisionTable.DecisionTableColumnsCondition.results=[];u.DecisionTable.DecisionTableColumnsResult={};u.DecisionTable.DecisionTableColumnsResult.results=[];return u;},_addTextRuleResultExpression:function(e){var t=this;var j=this._getModel();var s=e.getSource();var u=s.getParent();var v=u.getParent();var w=v.getParent().indexOfFormElement(v)+1;var x=this._internalModel.getProperty("/ruleId");var y=this._internalModel.getProperty("/ruleVersion");var z=w+1;var H=null;if(e&&e.oSource&&e.oSource.getBindingContext()&&e.oSource.getBindingContext().getModel()&&e.oSource.getBindingContext().getPath()&&e.oSource.getBindingContext().getModel().getProperty(e.oSource.getBindingContext().getPath())){H=e.oSource.getBindingContext().getModel().getProperty(e.oSource.getBindingContext().getPath()).ConditionId;}var K="/TextRuleResultExpressions";var I={RuleId:x,RuleVersion:y,ConditionId:H,Sequence:z,};var J={};J.properties=I;J.success=function(M){var N={RuleId:M.RuleId,ConditionId:M.ConditionId,ResultId:M.ResultId,RuleVersion:M.RuleVersion};var O=t._getModel().createKey("/TextRuleResultExpressions",N);var Q=new sap.ui.model.Context(t._getModel(),O);var S=t.getModel("displayModel").getProperty("/textRuleConditions");for(var i=0;i<S.length;i++){if(H===S[i].Id&&S[i].TextRuleResultExpressions){var U=S[i].TextRuleResultExpressions.results;if(U&&Q){U.push(Q.getModel().getProperty(Q.getPath()));t.getModel("displayModel").setProperty("/bCancelButtonVisible("+H+")",U.length>1);}v.getParent().insertFormElement(t._formElementsFactory(t.oBundle.getText("then")+"result"+w,Q),w);break;}}};J.error=function(){L.info(t.oBundle.getText("errorCreating")+K+t.oBundle.getText("entity"));};j.createEntry(K,J);},_deleteTextRuleResultExpression:function(e){var t=this;var j=this._getModel();var s=e.getSource();var u=s.getParent();var v=u.getParent();var w=v.getParent().indexOfFormElement(v);var x=this._internalModel.getProperty("/ruleId");var y=this._internalModel.getProperty("/ruleVersion");var z=s.getBindingContext();var H=z.getProperty("ConditionId");var I=z.getProperty("ResultId");var K="/TextRuleResultExpressions";var J={RuleId:x,RuleVersion:y,ConditionId:H,ResultId:I,};var M=j.createKey(K,J);j.remove(M,{success:function(N){var O=t.getModel("displayModel").getProperty("/textRuleConditions");for(var i=0;i<O.length;i++){if(H===O[i].Id&&O[i].TextRuleResultExpressions){var Q=O[i].TextRuleResultExpressions.results;if(Q){for(var S in Q){if(Q[S].ResultId===I){Q.splice(S,1);}}}t.getModel("displayModel").setProperty("/bCancelButtonVisible("+H+")",Q.length>1);v.getParent().removeFormElement(w);break;}}},error:function(){L.info(t.oBundle.getText("errorDeleting")+sKeytext+t.oBundle.getText("entity"));}});},_decideCancelButtonEnablement:function(e,O,i){return e&&!O&&i==="2.0"?true:false;},_formElementsFactory:function(i,e){var t=this;var j=e.getProperty("ResultId"),s=e.getProperty("RuleId"),v=e.getProperty("RuleVersion"),u=e.getProperty("ConditionId"),V=true;var H={RuleId:s,Id:j,RuleVersion:v};if(this.getAstExpressionLanguage()){this._internalModel.setProperty("/expressionLanguageVersion","2.0");}else{this._internalModel.setProperty("/expressionLanguageVersion","1.0");}var w=e.getProperty("Expression");var x=e.getModel().createKey("/TextRuleResults",H);this._internalModel.getProperty("/textRuleResultExpressions").push(e.getModel().getProperty(e.getPath()));var y=e.getModel().getProperty(x+"/BusinessDataType");var z=e.getModel().getProperty(x+"/DataObjectAttributeName");var I=e.getModel().getProperty(x+"/DataObjectAttributeLabel");var J=I?I:z;var K=e.getModel().getProperty(x+"/AccessMode");var M=e.getModel().getProperty(x+"/DataObjectAttributeId");if(K===C.EDITABLE){V=true;}else if(K===C.HIDDEN){V=false;}var N=new a({text:J,tooltip:J,labelFor:Q});var O=this._getExpressionAdvancedText(e,w,y,M,false,N.getId());var Q=O.getId();var S=new g({visible:V,label:N,fields:[O,new sap.ui.layout.HorizontalLayout({layoutData:new sap.ui.layout.GridData({span:"L1 M1 S1"}),content:[new sap.m.Button({enabled:"{TextRuleModel>/editable}",type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("sys-cancel"),visible:{parts:[{path:"displayModel>/bCancelButtonVisible("+u+")"},{path:"TextRuleModel>/resultDataObjectId"},{path:"TextRuleModel>/expressionLanguageVersion"}],formatter:this._decideCancelButtonEnablement},press:function(U){t._deleteTextRuleResultExpression(U);}.bind(this)}).setTooltip(this.oBundle.getText("removeColumn")),new sap.m.Button({enabled:"{TextRuleModel>/editable}",type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("add"),visible:t.bOperationsContext,press:function(U){t._addTextRuleResultExpression(U);}.bind(this)}).setTooltip(this.oBundle.getText("addColumn"))]})]}).setBindingContext(e);return S;},_getBindModelName:function(){var e="";var i=this.getModelName();if(i){e=i+">";}return e;},_getBlankContent:function(){var e=new a({text:this.oBundle.getText("startTextRule")});var s=new d();s.setText("\u00a0");var i=new h({enabled:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},text:" "+this.oBundle.getText("settings"),press:[this._openTextRuleSettings,this]}).addStyleClass("sapTextRuleLink");var j=new k({justifyContent:"Center",items:[e,s,i],visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement}}).addStyleClass("sapUiMediumMargin");return j;},_getConvertedExpression:function(e,i,j){var s=sap.ui.getCore().byId(this.getExpressionLanguage());var t=this._formRuleData(j,e);var u;if(i){u=s.convertRuleToCodeValues(t);}else{u=s.convertRuleToDisplayValues(t);}t.Type="TextRule";return u;},_getDataLoadedPromise:function(){if(!this._dataLoaded){this._setDataLoadedPromise();}return this._dataLoaded.promise();},_getElseButton:function(){var t=this;if(!sap.ui.getCore().getElementById("_elseButton")){this.oElseButton=new sap.m.Button({id:"_elseButton",text:this.oBundle.getText("addElse"),tooltip:this.oBundle.getText("addElse"),enabled:"{TextRuleModel>/editable}",press:function(e){t._addConditionBlock(e,t.typeElse);}});}return this.oElseButton;},_getElseIfButton:function(){var t=this;if(!sap.ui.getCore().getElementById("_elseIfButton")){this.oElseIfButton=new sap.m.Button({id:"_elseIfButton",text:this.oBundle.getText("addElseIf"),tooltip:this.oBundle.getText("addElseIf"),enabled:"{TextRuleModel>/editable}",press:function(e){t._addConditionBlock(e,t.typeElseIf);}});}return this.oElseIfButton;},_getElseIfPanel:function(){var t=this.oBundle.getText("titleElseIf");var e=[];var j=this._displayModel.getProperty("/textRuleConditions/ElseIf");if(j.length>0){for(var i=0;i<j.length;i++){var H={RuleId:j[i].RuleId,Id:j[i].Id,RuleVersion:j[i].RuleVersion};var s=this._getModel().createKey("/TextRuleConditions",H);var u=new sap.ui.model.Context(this._getModel(),s);var v=i+1;var N=" ("+v+")";e.push(this._createFormLayout(u,t+N,false));}}else{var w=new P({headerText:t,visible:"{TextRuleModel>/editable}",content:this._getElseIfButton()});e.push(w);}return e;},_getElsePanel:function(){var t=this.oBundle.getText("titleElse");var e=[];var i=this._displayModel.getProperty("/textRuleConditions/Else");if(i.length>0){var H={RuleId:i[0].RuleId,Id:i[0].Id,RuleVersion:i[0].RuleVersion};var s=this._getModel().createKey("/TextRuleConditions",H);var j=new sap.ui.model.Context(this._getModel(),s);e.push(this._createElseFormLayout(j,t),false);}else{var u=new P({headerText:t,visible:"{TextRuleModel>/editable}",content:this._getElseButton()});e.push(u);}return e;},_getExpressionAdvancedText:function(i,j,s,t,u,v){var w=this;var x=null;var y="";var z=s?s:sap.rules.ui.ExpressionType.BooleanEnhanced;this.valueState="None";this.bOperationsContext=false;if(this.getAstExpressionLanguage()){x=sap.ui.getCore().byId(this.getAstExpressionLanguage());var H=this._getExpressionFromAstNodes(i);if(H&&H.relString){H.relString=H.relString.replace(/\\/g,"\\\\").replace(/{/g,"\\{").replace(/}/g,"\\}");}var I=this._internalModel.getProperty("/ruleBindingPath").split("/")[2];var J=i.getObject("/"+I).ResultDataObjectId;this._internalModel.setProperty("/resultDataObjectId",J);if(t){y="/"+J+"/"+t;}if(J){J=J;}if(!J&&!u){this.bOperationsContext=true;}return new n({astExpressionLanguage:x,value:H.relString,jsonData:H.JSON,attributeInfo:y,resultDataObjectId:J,conditionContext:u,operationsContext:this.bOperationsContext,editable:"{TextRuleModel>/editable}",placeholder:this.oBundle.getText("expressionPlaceHolder"),valueState:this.valueState,ariaLabelledBy:v,change:function(e){var S=e.getSource();var M=sap.ui.getCore().getEventBus();i=S.getBindingContext();var N=i.getPath();var O=e.getParameter("astNodes");if(O&&O.length>0&&O[0].Type==="I"&&O[0].Value!=""&&O[0].Value!=undefined){e.oSource.setValueState("Error");}else{e.oSource.setValueState("None");}M.publish("sap.ui.rules","astCreating");var Q=i.getModel();if(!Q.hasPendingChanges()){w._removeAndUpdateExisitingNodes(N,i,O,j,Q);}}.bind(this)}).setBindingContext(i);}else if(this.getExpressionLanguage()){x=sap.ui.getCore().byId(this.getExpressionLanguage());var K=w._getConvertedExpression(j,false,i);var H=w._getExpressionFromParseResults(j,K);H=H?H:j;return new E({expressionLanguage:x,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,type:z,value:H,attributeInfo:t,editable:"{TextRuleModel>/editable}",change:function(M){var S=M.getSource();i=S.getBindingContext();var N=i.getPath();K=w._getConvertedExpression(S.getValue(),true,i);var O=w._getExpressionFromParseResults(S.getValue(),K);O=O?O:S.getValue();w._updateModelExpression(N,i,O);var Q=K.output.decisionTableData.DecisionTable.DecisionTableColumns.results["0"].Condition.parserResults;if(Q.status!=="Error"){w._astUtils.Id=0;var U=Q.converted.ASTOutput;try{var V=JSON.stringify(w._astUtils.parseConditionStatement(U));var W=i.oModel.oMetadata.mEntityTypes["/TextRuleConditions"].property;var X=0;if(W){for(var Y=0;Y<W.length;Y++){if(W[Y].name==="AST"){X=W[Y].maxLength;}}if(V&&V.length<=X){w._updateModelExpressionModelAst(N,i,V);}}}catch(e){L.error("Exception while converting ast for expression"+S.getValue()+" :"+e.message);}}}.bind(this)}).setBindingContext(i);}},_removeAndUpdateExisitingNodes:function(s,e,i,j,M){var t=this;var u=sap.ui.getCore().getEventBus();M.setDeferredGroups(["astGroupId"]);M.update(e.getPath(),{"Expression":e.getProperty("Expression")},{groupId:"astGroupId"});t._removeExistingAstNodes(s,e,i,j,M);t._updateModelAstNodes(s,e,i,M);M.submitChanges({groupId:"astGroupId",success:function(v){u.publish("sap.ui.rules","astCreated");}});},_getExpressionFromParseResults:function(e,i){if(i&&i.output.decisionTableData.DecisionTable.DecisionTableColumns.results[0].Condition.parserResults&&i.output.decisionTableData.DecisionTable.DecisionTableColumns.results[0].Condition.parserResults.converted){return i.output.decisionTableData.DecisionTable.DecisionTableColumns.results[0].Condition.parserResults.converted.Expression;}else{return e;}},_getExpressionFromAstNodes:function(e){var t=this;var i=sap.ui.getCore().byId(this.getAstExpressionLanguage());var j="";var s=[];var u=[];if(t.includes(e.sPath,"TextRuleConditions")){s=e.getObject(e.sPath).TextRuleConditionASTs;}else{s=e.getObject(e.sPath).TextRuleResultExpressionASTs;}var v=i._astBunldeInstance.ASTUtil;v.clearNodes();s=s.__list;if(s&&s.length>0){for(var w in s){var x=s[w];t._addNodeObject(e.getObject("/"+x));}u=v.getNodes();j=v.toAstExpressionString(u);if(u&&u[0].Type==="I"&&u[0].Value!=""&&u[0].Value!=undefined){this.valueState="Error"}else{this.valueState="None"}}return j;},_addNodeObject:function(e){var N=[];var i=sap.ui.getCore().byId(this.getAstExpressionLanguage());var j=i._astBunldeInstance.ASTUtil;var u=[];u.Root=e.Root;u.SequenceNumber=e.Sequence;u.ParentId=e.ParentId;u.Reference=e.Reference;u.Id=e.NodeId;u.Type=e.Type;u.Value=e.Value?e.Value:"";if(e.Type==="I"){u.Value=e.IncompleteExpression;}if(e.Function){u.Function=e.Function;}if(e.Type!=="P"&&!e.Function){var O=[];O.BusinessDataType=e.Output?e.Output.BusinessDataType:e.BusinessDataType;O.DataObjectType=e.Output?e.Output.DataObjectType:e.DataObjectType;u.Output=O;}j.createNode(u);},_getIfPanel:function(){var t=this.oBundle.getText("titleIf");var i=this._displayModel.getProperty("/textRuleConditions/If");var H={RuleId:i[0].RuleId,Id:i[0].Id,RuleVersion:i[0].RuleVersion};var s=this._getModel()?this._getModel().createKey("/TextRuleConditions",H):"";var e=new sap.ui.model.Context(this._getModel(),s);return this._createFormLayout(e,t,true);},_getModel:function(){var e=this.getModelName();if(e){return this.getModel(e);}return this.getModel();},_handleVerticalLayoutDataReceived:function(e){var i=e.__batchResponses[1].data;if(i&&i.results){this._internalModel.setProperty("/textRuleResults",i.results);}var j=e.__batchResponses[2].data;var s;if(!j){return;}var v=this.getAggregation("_verticalLayout");if(j.results&&j.results.length===0){s=this._getBlankContent();v.addContent(s);this._internalModel.setProperty("/newTextRule",true);this._updateBusyState(false);}else{this._segregateTextRuleData(j.results);if(this._displayModel.getProperty("/textRuleConditions/If").length===0){s=this._getBlankContent();v.addContent(s);this._internalModel.setProperty("/newTextRule",true);this._updateBusyState(false);}else{this._bindVerticalLayout();this._internalModel.setProperty("/newTextRule",false);}}},_initDisplayModel:function(){var e={};e.textRuleConditions=[];e.textRuleConditions.If=[];e.textRuleConditions.ElseIf=[];e.textRuleConditions.Else=[];this._displayModel=new sap.ui.model.json.JSONModel(e);this.setModel(this._displayModel,"displayModel");},_initInternalModel:function(){var e={};e.editable=this.getEditable();e.newTextRule=true;e.enableSettings=true;e.projectId="";e.projectVersion="";e.ruleId="";e.ruleVersion="";e.ruleBindingPath="";e.textRuleResults=[];e.textRuleResultExpressions=[];e.resultDataObjectId="";e.expressionLanguageVersion="";this._internalModel=new sap.ui.model.json.JSONModel(e);this.setModel(this._internalModel,"TextRuleModel");var i=this.getModel("ruleBuilderInternalModel");var t=this.getModel("TextRuleModel");if(i&&t){var j=i&&i.getObject("/textRuleConfiguration")?i.getObject("/textRuleConfiguration").enableSettings:true;t.setProperty("/enableSettings",j);}},_initSettingsModel:function(){this._settingsModel=new sap.ui.model.json.JSONModel();this.setModel(this._settingsModel,"settingModel");},_openTextRuleSettings:function(){var t=this._createTextRuleSettings();var e=new D({contentWidth:"70%",contentHeight:"315px",title:this.oBundle.getText("textRuleSettings")});e.addContent(t);var j=t.getButtons(e);for(var i=0;i<j.length;i++){e.addButton(j[i]);}e.attachBeforeClose(function(s){var u=e.getState();if(u===sap.ui.core.ValueState.Success){if(this._internalModel.getProperty("/resultChanged")){var v=sap.ui.getCore().getEventBus();v.publish("sap.ui.rules","refreshTextRuleModel");}this._resetControl();}e.destroy();},this);e.open();},_resetControl:function(){this._unbindVerticalLayout();this._initInternalModel();this._initSettingsModel();this._initDisplayModel();var M=this._getModel();var e=this.getBindingContextPath();if(!e||!M){return;}this._updateBusyState(true);M.removeData();this._resetContent=false;var s=e.split("'");this._internalModel.setProperty("/projectId",s[1]);this._internalModel.setProperty("/projectVersion",s[3]);this._internalModel.setProperty("/ruleId",s[5]);this._internalModel.setProperty("/ruleVersion",s[7]);this._internalModel.setProperty("/ruleBindingPath",e);var i=new sap.ui.model.Context(M,e);this.setBindingContext(i);this._bindRule();},_segregateTextRuleData:function(e){var j=[];j.If=[];j.ElseIf=[];j.Else=[];for(var i=0;i<e.length;i++){j.push(e[i]);this.getModel("displayModel").setProperty("/bCancelButtonVisible("+e[i].Id+")",e[i].TextRuleResultExpressions.results.length>1);if(e[i].Type===this.typeIf){j.If.push(e[i]);}else if(e[i].Type===this.typeElseIf){j.ElseIf.push(e[i]);}else if(e[i].Type===this.typeElse){j.Else.push(e[i]);}}this.getModel("displayModel").setProperty("/textRuleConditions",j);},_updateBusyState:function(e){var t=this;if(e){this.setBusy(true);}else{setTimeout(function(){t.setBusy(false);},1500);}},_unbindVerticalLayout:function(){var v=this.getAggregation("_verticalLayout");if(v){v.destroyContent();}},_updateModelExpression:function(s,e,i){e.getModel().setProperty(s+"/Expression",i,e,true);},_updateModelAstNodes:function(s,e,i,M){var s=e.getPath();var j=this.getModel().getObject(s);var t=j.RuleId;var u=j.RuleVersion;var v="";var w={};if(this.includes(s,"TextRuleConditions")){w.Id=j.Id;v="/TextRuleConditionASTs";}else{w.ConditionId=j.ConditionId;w.ResultId=j.ResultId;v="/TextRuleResultExpressionASTs";}for(var x in i){var y={};if(i[x].Root){y.Sequence=1;y.Root=true;}else{y.Sequence=i[x].SequenceNumber;y.ParentId=i[x].ParentId;}if(i[x].Reference){y.Reference=i[x].Reference;}if(i[x].Function){y.Function=i[x].Function?i[x].Function:"";}if(i[x].Type!=="P"&&!i[x].Function){y.BusinessDataType=i[x].Output?i[x].Output.BusinessDataType:i[x].BusinessDataType;y.DataObjectType=i[x].Output?i[x].Output.DataObjectType:i[x].DataObjectType;y.Value=i[x].Value?i[x].Value:"";}if(i[x].Type==="I"){y.IncompleteExpression=i[x].Value;}y.NodeId=i[x].Id;y.Type=i[x].Type;y.RuleId=t;y.RuleVersion=u;for(var z in w){y[z]=w[z];}var H={};H.properties=y;H.groupId="astGroupId";M.createEntry(v,H);}},_removeExistingAstNodes:function(s,e,i,j,M){var t=this;var u=this.getModel().getObject(s);var v=u.RuleId;var w=u.RuleVersion;var x="";var y={};if(t.includes(s,"TextRuleConditions")){y.Id=u.Id;x="/DeleteTextRuleConditionASTDraft";}else if(t.includes(s,"TextRuleResultExpression")){y.ConditionId=u.ConditionId;y.ResultId=u.ResultId;x="/DeleteTextRuleResultExpressionASTDraft";}else{y.Id=u.Id;x="/DeleteTextRuleResultASTDraft";}y.RuleId=v;y.RuleVersion=w;M.callFunction(x,{method:"POST",groupId:"astGroupId",urlParameters:y});},_updateModelExpressionModelAst:function(s,e,i){if(e.getModel().getProperty(s+"/AST")){e.getModel().setProperty(s+"/AST",i,e,true);}},init:function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.typeIf="If";this.typeElseIf="ElseIf";this.typeElse="Else";this._resetContent=true;this._initInternalModel();this._initDisplayModel();this._initSettingsModel();this._addToolBar();this._addTextRuleControl();this._astUtils=A;},onAfterRendering:function(){var v=this.getAggregation("_verticalLayout");var t=this;v.addEventDelegate({"onAfterRendering":function(){t._updateBusyState(false);}},this);},onBeforeRendering:function(){if(this._resetContent){this._resetControl();}},setEnableSettings:function(v){this.setProperty("enableSettings",v,true);this._internalModel.setProperty("/enableSettings",v);return this;},setModelName:function(v){this.setProperty("modelName",v);this._resetContent=true;return this;},setExpressionLanguage:function(v){this.setAssociation("expressionLanguage",v,true);var e=(v instanceof Object)?v:sap.ui.getCore().byId(v);if(!e){return this;}var V=this.getAggregation("_verticalLayout");if(V){var i=V.getBinding("content");if(i){i.refresh();}}return this;},setAstExpressionLanguage:function(v){this.setAssociation("astExpressionLanguage",v,true);var e=(v instanceof Object)?v:sap.ui.getCore().byId(v);if(!e){return this;}var V=this.getAggregation("_verticalLayout");if(V){var i=V.getBinding("content");if(i){i.refresh();}}return this;},setEditable:function(v){this.setProperty("editable",v,true);this._internalModel.setProperty("/editable",v);return this;},setBindingContextPath:function(v){var e=this.getBindingContextPath();if(v&&(e!==v)){this._unbindVerticalLayout();this.setProperty("bindingContextPath",v);this._resetContent=true;}return this;},includes:function(e,s){var i=false;if(e.indexOf(s)!==-1){i=true;}return i;}});return r;},true);
