/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/m/Dialog","sap/ui/core/Control","sap/m/Button","sap/m/TextArea","sap/m/Text","sap/m/MessageBox","sap/ui/layout/HorizontalLayout","sap/rules/ui/Utils","sap/ui/core/Popup","jquery.sap.global","sap/rules/ui/ExpressionBase","sap/ui/comp/odata/MetadataAnalyser","sap/rules/ui/providers/ValueHelpProvider","sap/ui/core/LocaleData","sap/rules/ui/Constants","sap/rules/ui/codemirror/lib/codemirror","sap/rules/ui/codemirror/addon/hint/show-hint","sap/rules/ui/codemirror/mode/hdf/hdf","sap/rules/ui/codemirror/addon/display/placeholder","sap/rules/ui/codemirror/addon/mh/mark-selection","sap/rules/ui/codemirror/addon/hint/hdf-hint","sap/rules/ui/codemirror/addon/closeBrackets/closebrackets","sap/rules/ui/codemirror/addon/search/search"],function(L,D,C,B,a,b,M,H,U,P,q,E,c,V,d,e){"use strict";var f=E.extend("sap.rules.ui.ExpressionAdvanced",{metadata:{properties:{type:{type:"sap.rules.ui.ExpressionType",defaultValue:sap.rules.ui.ExpressionType.All,bindable:"bindable"},collection:{type:"boolean",defaultValue:false},placeholder:{type:"string",defaultValue:null},focusOnLoad:{type:"boolean",defaultValue:false},attributeInfo:{type:"string",defaultValue:"",bindable:"bindable"}},aggregations:{_expressionArea:{type:"sap.m.TextArea",multiple:false,visibility:"hidden"}},events:{"change":{},"liveChange":{},"valueHelpRequest":{parameters:{fromSuggestions:{type:"boolean"}}}},publicMethosds:["validate"]}});f.prototype.init=function(){E.prototype.init.apply(this,arguments);var g=jQuery.sap.getModulePath("sap.rules.ui.codemirror.lib")+"/codemirror.css";var s=jQuery.sap.getModulePath("sap.rules.ui.codemirror.addon.hint")+"/show-hint.css";jQuery.sap.includeStyleSheet(g);jQuery.sap.includeStyleSheet(s);this.pop=new P(q('<span></span>')[0],false,false,false);this.errorWidgets=[];this.expressionTokens=[];this._liveValue="";this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.dataModel=this.initControlDataModel();this.oTextArea=new a({width:"100%"});this.validationCompleteEvent=document.createEvent("Event");this.validationCompleteEvent.initEvent("validationCompleteEvent",true,false);this.setAggregation("_expressionArea",this.oTextArea,true);this.bFlagForEventListener=true;var l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var o=d.getInstance(l);this.oFormatDate=sap.ui.core.format.DateFormat.getInstance({pattern:o.getDatePattern('short'),calendarType:sap.ui.core.CalendarType.Gregorian},l);this._dateBusinessDataType="Date";this._valueHelpSelectionText="Select from value help...";this._hasValueSource="HasValueSource";this._propertyValue="Value";this._propertyDescription="Description";};f.prototype._processValidationResult=function(r){if(r.status===sap.rules.ui.ValidationStatus.Error){var m=U.parseUTFToString(r.errorDetails);m=m.replace(/\r\n/g," ").replace(/\r/g," ").replace(/\n/g," ");this.errorCursorPosition=r.cursorPosition;this.setValueStateText(m);}else{this.oTextArea.setValueState("None");this.oTextArea.setValueStateText("");this.setValueStateText("");jQuery(this.codeMirror.getWrapperElement()).removeClass('sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError');}};f.prototype.validateExpression=function(I){for(var i=0;i<this.errorWidgets.length;i++){this.codeMirror.removeLineWidget(this.errorWidgets[i]);}this.errorWidgets=[];var g=this.codeMirror?this.codeMirror.getValue():this.getValue();var r={};var h={};var o=sap.ui.getCore().byId(this.getExpressionLanguage());if(o){h=o.validateExpression(I||g,this.getProperty("type"),this.getCollection(),false);if(h&&this.isActive()){r=h;this._processValidationResult(r);if(r.deferredResult){r.deferredResult.done(function(r){this._processValidationResult(r);document.dispatchEvent(this.validationCompleteEvent);}.bind(this));}}}return h;};f.prototype._showPopUp=function(){var g="Error";var h=this.getProperty("valueStateText");var t=this.getId()+'-message';var p=this.pop;if(!this.pop){return;}p.attachClosed(function(){q.sap.byId(t).remove();});var i=P.Dock;var j='sapMInputBaseMessage'+g+' sapMFocus';var T='sapMValueStateMessageError sapMText';var r=sap.ui.getCore().getLibraryResourceBundle('sap.m');if(g===sap.ui.core.ValueState.Success){j='sapUiInvisibleText';h='';}var o=q('<div>',{'id':t,'class':j,'role':'tooltip','aria-live':'assertive'}).append(q('<span>',{'aria-hidden':true,'class':'sapUiHidden','text':r.getText('INPUTBASE_VALUE_STATE_'+g.toUpperCase())})).append(q('<span>',{'id':t+'-text','class':T,'text':h}));p.setContent(o[0]);p.close(0);p.open(0,i.BeginTop,i.BeginBottom,jQuery(this.codeMirror.getWrapperElement()),null,"none flip",true);var s=this.pop.oContent.clientWidth;var k=document.getElementById(this.getAggregation("_expressionArea"));if(!k){return;}var l=k.sId.clientWidth;if(s>l){jQuery(".sapMText").css('width',l);jQuery(".sapMText").css('padding-left','12px');jQuery(".sapMText").css('padding-right','12px');jQuery(".sapMText").css('padding-top','8px');jQuery(".sapMText").css('padding-bottom','8px');}};f.prototype._closePopUp=function(){if(this.pop){this.pop.close(0);}};f.prototype._showErrorMessage=function(){var g=this.getValueStateText();if(g&&g!==""){this._setExpressionErrorStyle();}};f.prototype.initControlDataModel=function(){var o=new sap.ui.model.json.JSONModel();var g={};o.setData(g);return o;};f.prototype.setExpressionTokens=function(t){var m=0,n=false;this.expressionTokens=[];if(t instanceof Array){for(var i=0;i<t.length;i++){var g=t[i];var h=/\n/;if(h.test(g.token)){m=g.start+g.token.lastIndexOf('\n')+1;n=true;continue;}if(n){g.start=g.start-m;g.end=g.end-m+1;}else{g.end=g.end+1;}this.expressionTokens.push(g);}}};f.prototype.getExpressionTokens=function(){return this.expressionTokens;};f.prototype.getValue=function(){if(this.codeMirror!==undefined){return this.codeMirror.getValue();}return this.getProperty("value");};f.prototype.setValue=function(v){if(v===undefined||v===null){v="";}this._liveValue=v;this.oTextArea.setValue(v);if(this.getProperty("value")===v){return;}this.setProperty("value",v,true);if(this.codeMirror!==undefined){this.codeMirror.setValue(v);}};f.prototype.setPlaceholder=function(v){this.setProperty("placeholder",v);var m=(this.getEditable())?v:"";this.dataModel.setProperty("/placeholder",m);};f.prototype.getPlaceholder=function(){return this.dataModel.getProperty("/placeholder");};f.prototype.setValueStateText=function(m){this.setProperty("valueStateText",m,true);if(m){this._showErrorMessage(m);}else{jQuery(this.codeMirror.getWrapperElement()).removeClass('CodeMirror-error');jQuery(this.codeMirror.getWrapperElement()).removeClass('sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError');}};f.prototype.setEditable=function(v){this.setProperty("editable",v);this.getAggregation("_expressionArea").setProperty("editable",v);if(this.codeMirror){jQuery(this.codeMirror.getWrapperElement()).addClass('CodeMirror-rules-Not-Editable');}var _=(v)?this.getProperty("placeholder"):"";this.dataModel.setProperty("/placeholder",_);this.invalidate();};f.prototype.setType=function(t){if(t===e.DATE_BUSINESS_TYPE||t===e.TIMESTAMP_BUSINESS_TYPE||t===e.NUMBER||t===e.STRING||t===e.BOOLEAN_BUSINESS_TYPE||t===e.BOOLEAN_ENHANCED_BUSINESS_TYPE){this.setProperty("type",t);}if(this.codeMirror){this.codeMirror.options.returnType=t;}};f.prototype.setCollection=function(i){this.setProperty("collection",i,true);if(this.codeMirror){this.codeMirror.options.collection=i;}};f.prototype.validate=function(){return this.validateExpression();};f.prototype.setFocusOnLoad=function(v){this.dataModel.setProperty("/focus",v);this.setProperty("focusOnLoad",v,true);};f.prototype.focus=function(){if(this.codeMirror){var l=this.codeMirror.getLine(this.codeMirror.lastLine());var g=l.length;this.codeMirror.setCursor({line:this.codeMirror.lastLine(),ch:g});this.codeMirror.focus();}};f.prototype.onAliasLinkPress=function(g){var h=sap.ui.getCore().byId(this.getExpressionLanguage());if(h){h.onAliasLinkPress(g);h.attachEvent("aliasDialogClosed",this.aliasClickCancel,this);}};f.prototype.onCreateAliasLinkForText=function(t){var g=sap.ui.getCore().byId(this.getExpressionLanguage());if(g){g.attachEvent("aliasDialogClosed",this.replaceTextWithAlias,this);g.onCreateAliasLinkForText(t);}};f.prototype.replaceTextWithAlias=function(o){if(o.getParameter("isSave")){this.codeMirror.replaceSelection(o.getParameter("savedAliasName"));}};f.prototype.aliasClickCancel=function(o){this.codeMirror.focus();this.codeMirror.execCommand("goLineEnd");this.fireDialog({dialogStatus:sap.rules.ui.ValueListDialogMode.Close});};f.prototype.onAfterRendering=function(){this.timer=null;this.needAutoComplete=false;this.endCompletion=false;this._setCodeMirror();this._setEditorStyle();this._handleMousedown();this._handleChange();this._handleFocusLeave();this._handleEndCodeCompletion();this._handleKeyPress();this._handleEditableProperty();this._handleOnLoadValidation();this._refreshOnNavigationEnd();this._handleFocus();this._handleValueListSelect();this._handleCalendarChange();if(this.bFlagForEventListener){this.bFlagForEventListener=false;this.fnMouseDownListsner=function(o){this.bFlagForChangeBeforeBlur=o.target.className.indexOf("CodeMirror-hint")>-1;}.bind(this);this.fnBlurListsner=function(o){if(this.bFlagForChangeBeforeBlur){this.bFlagForChangeBeforeBlur=false;o.stopPropagation();this.codeMirror.focus();}}.bind(this);document.addEventListener("mousedown",this.fnMouseDownListsner,true);document.getElementById(this.getId()).addEventListener("blur",this.fnBlurListsner,true);}};f.prototype._handleCalendarChange=function(){var t=this;this.codeMirror.on('onChangeDate',function(){t._createCalendarDialog(t.codeMirror.getCursor());}.bind(this));};f.prototype._createCalendarDialog=function(g){var A=false;var t=this;var o=new sap.ui.unified.Calendar({width:"100%",select:this.handleCalendarSelect.bind(this)});this._oSelectNewDateDialog=new D({title:this.oBundle.getText("calendarTitle"),content:[o],beginButton:new B({text:this.oBundle.getText("okBtn"),enabled:false,press:function(){var h=this.updateText(o);t._updateModal(false);t.setTextOnCursor(h,g,false,this._dateBusinessDataType,A,false);t._oSelectNewDateDialog.close();t.focus(t.codeMirror);}.bind(this)}),endButton:new B({text:this.oBundle.getText("clsBtn"),press:function(){t._updateModal(false);t._oSelectNewDateDialog.close();t.focus(t.codeMirror);}.bind(this)})});this._oSelectNewDateDialog.open();};f.prototype._updateModal=function(m){var p=sap.ui.getCore().byId("popover");if(p){p.setModal(m);}};f.prototype.handleCalendarSelect=function(o){var g=o.getSource(),s=g.getSelectedDates()[0].getStartDate();if(s){this._oSelectNewDateDialog.getBeginButton().setEnabled(true);}};f.prototype.updateText=function(o){var s=o.getSelectedDates();var g;if(s.length>0){g=s[0].getStartDate();return this.oFormatDate.format(g);}};f.prototype._raiseError=function(s){L.error(s);var o=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.setValueStateText(o.getText("valueHelpTechnicalError"));this._showPopUp();};f.prototype._handleValueListSelect=function(){this.codeMirror.on('onValueListSelect',function(){var s=this.codeMirror.currentHintData.data.listCompletion;var v=[];for(var g=0;g<s.length;g++){if(s[g].text===this._valueHelpSelectionText){v=s[g].info;}}var h=sap.ui.getCore().byId(this.getExpressionLanguage());v.expressionLanguage=h;var i=h.getValueHelpCallback();this.oTextArea.setValueState("None");this.oTextArea.setValueStateText("");this.setValueStateText("");jQuery(this.codeMirror.getWrapperElement()).removeClass('sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError');if((typeof i)!=="function"&&v.metadata.hasOwnProperty(this._hasValueSource)&&v.metadata.HasValueSource===true){this._createCpValueHelp(v,this.codeMirror.getCursor(),false);}else{if((typeof i)!=="function"){this._raiseError("value help callback is not set or is not a function");}else{i.call(this,v);var m=v[0].model;if(!(m instanceof sap.ui.model.odata.v2.ODataModel)){this._raiseError("value help model is not an oData V2 model");}else if(m.isMetadataLoadingFailed()){this._raiseError("model metadata loading has failed in the past");}else if(!(m.getMetaModel().oModel)){m.attachMetadataLoaded(function(){this._createValueHelpProvider(v[0]);}.bind(this));m.attachMetadataFailed(function(){this._raiseError("attached model metadata failed");}.bind(this));}else{this._createValueHelpProvider(v[0]);}}}}.bind(this));};f.prototype._createValueHelpProvider=function(v,r){var m=v.model;this.oMetadataAnalyzer=new sap.ui.comp.odata.MetadataAnalyser(m);var A=v.metadata.propertyPath;var o=this.oMetadataAnalyzer.getValueListAnnotation(A);if(!o.primaryValueListAnnotation){this._raiseError("proprety path is wrong");return;}var t=this.getExpressionTokens();var g=false;if(t.length>0){g=(t[t.length-1].tokenType!=="whitespace");}if(this.oValueHelpDialogProvider){this.oValueHelpDialogProvider.destroy();}this.oValueHelpDialogProvider=new V({annotation:o.primaryValueListAnnotation,additionalAnnotations:o.additionalAnnotations,control:this,model:m,preventInitialDataFetchInValueHelpDialog:false,supportMultiSelect:false,supportRanges:false,takeOverInputValue:false,fieldName:o.primaryValueListAnnotation.valueListTitle,title:o.primaryValueListAnnotation.valueListTitle,cursorPosition:this.codeMirror.getCursor(),bReplaceWord:r,businessDataType:v.metadata.businessDataType,bAddSpace:g});this.fireValueHelpRequest({fromSuggestions:false});};f.prototype._createCpValueHelp=function(v,g,r,h){var i=v.metadata.businessDataType;var t=this.getExpressionTokens();var A=false;var p=sap.ui.getCore().byId("popover");if(p){p.setModal(true);}if(t.length>0){A=(t[t.length-1].tokenType!=="whitespace");}if(this.oDialog){this.oDialog.destroy();}var j=sap.ui.getCore().byId(this.getExpressionLanguage()).getModel().sServiceUrl;this._createDialog(j,v,g,i,A,r,h);};f.prototype._createDialog=function(g,v,h,i,A,r,j){this._createValueHelpDialog(g,v,h,i,A,r,j);this._createSmartFilterBar(g,v);this.oValueHelpDialog.setFilterBar(this.oFilterBar);this.oValueHelpDialog.open();this.oValueHelpDialog.getTable().setBusy(true);};f.prototype._createValueHelpDialog=function(g,v,h,i,A,r,j){var t=this;var k=v.expressionLanguage.getModel();var l="Attributes(Id='"+v.metadata.attributeId+"',VocabularyId='"+v.metadata.vocabularyId+"',DataObjectId='"+v.metadata.dataObjectId+"')";if(l.includes(":")){l=l=l.replace(":","%3A");}this.attributeName=k.oData[l].Name;sap.ui.core.BusyIndicator.show(0);this.oValueHelpDialog=new sap.ui.comp.valuehelpdialog.ValueHelpDialog({supportMultiselect:false,supportRanges:false,horizontalScrolling:false,title:t.attributeName,resizable:false,beforeOpen:function(){t._bindTable(g,v);},ok:function(o){var s=o.getParameter("tokens")[0].data("row");var m=s.Value;if(i===t._dateBusinessDataType){m=t._formatDate(m);}t.setTextOnCursor(m,h,r,i,A,j);t._updateModal(false);t.oValueHelpDialog.close();t.focus(t.codeMirror);},cancel:function(){t._updateModal(false);t.oValueHelpDialog.close();t.focus(t.codeMirror);},afterClose:function(){t._updateModal(false);t.oValueHelpDialog.destroy();t.focus(t.codeMirror);t.oFilterBar.destroy();sap.ui.core.BusyIndicator.hide();}});};f.prototype._formatDate=function(v){return this.oFormatDate.format(this.oFormatDate.parse(v));};f.prototype._createSmartFilterBar=function(g,v){var t=this;this.oFilterBar=new sap.ui.comp.smartfilterbar.SmartFilterBar({entitySet:v.metadata.entitySet,enableBasicSearch:true,advancedMode:true,filterBarExpanded:true,search:function(){t.onSearch(g,v);},filterChange:function(o){t.setValueStateFilter(o);},controlConfiguration:[t._createControlConfiguration()]});var m=new sap.ui.model.odata.v2.ODataModel(g);this.oFilterBar.setModel(m);};f.prototype._createControlConfiguration=function(){var g=[new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Value",label:"Value",visibleInAdvancedArea:true,width:"100px",index:1}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Description",label:"Description",visibleInAdvancedArea:true,width:"100px",index:2}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"VocabularyId",label:"VocabularyId",width:"100px",visible:false,index:3}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"DataObjectId",label:"DataObjectId",visible:false,width:"100px",groupId:"abc",index:4}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"AttributeId",label:"AttributeId",visible:false,width:"100px",index:5}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Version",label:"Version",visible:false,width:"100px",index:6})];return g;};f.prototype.onSearch=function(g,v){this.oValueHelpDialog.getTable().setBusy(true);this._unBindTable();this._bindTable(g,v);};f.prototype._bindTable=function(g,v){var s=v.metadata.serviceURL;var F=this._fetchFilterParams(v);var m={valueHelp:{collection:s,properties:[this._propertyValue,this._propertyDescription]}};var t=this.oValueHelpDialog.getTable();t.setThreshold(10);for(var i=0;i<m.valueHelp.properties.length;i++){this._addValueHelpColumn(m.valueHelp.properties[i],t);}var o=new sap.ui.model.odata.v2.ODataModel(g);t.setModel(o);t.bindRows(m.valueHelp.collection,null,F);t.getBinding("rows").attachDataReceived(this._handleRowsDataReceived,this);};f.prototype._handleRowsDataReceived=function(o){var t=this;var g=o.getParameter("data");if(jQuery.isEmptyObject(g)||(g&&g.results&&g.results.length===0)){this.oValueHelpDialog.getTable().setNoData(t.oBundle.getText("no_data"));}else{this.oValueHelpDialog.getTable().setNoData(t.oBundle.getText("searching"));}this.oValueHelpDialog.getTable().setBusy(false);};f.prototype._addValueHelpColumn=function(o,t){var g=new sap.ui.table.Column().setLabel(new sap.m.Label({text:o}));if(o===this._propertyValue){g.setSortProperty(o);}t.addColumn(g.setTemplate(new sap.m.Text().bindProperty("text",o)));};f.prototype._unBindTable=function(){var t=this.oValueHelpDialog.getTable();t.destroyColumns();t.unbindRows();};f.prototype._fetchFilterParams=function(v){var t=this;var s=[];var F=[new sap.ui.model.Filter("AttributeId",sap.ui.model.FilterOperator.EQ,v.metadata.attributeId),new sap.ui.model.Filter("DataObjectId",sap.ui.model.FilterOperator.EQ,v.metadata.dataObjectId),new sap.ui.model.Filter("VocabularyId",sap.ui.model.FilterOperator.EQ,v.metadata.vocabularyId)];var g=this.oFilterBar.getFilters();var h=this.oFilterBar.getParameters();if(!jQuery.isEmptyObject(h)&&g&&g.length>0){h=this.oFilterBar.getParameters().custom.search;s=this._getSearchFilters(h);g=t._formatFilterParams(g);F.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(g),new sap.ui.model.Filter(s)],and:true}));}else if(!jQuery.isEmptyObject(h)){h=this.oFilterBar.getParameters().custom.search;s=this._getSearchFilters(h);F.push(s);}else if(g&&g.length>0){g=t._formatFilterParams(g);F.push(g[0]);}return F;};f.prototype._formatFilterParams=function(F){var t=this;if(F[0]&&F.length===1&&F[0].aFilters[0]&&F[0].aFilters[0].sOperator){F=t._formatSingleFilter(F);}else if(F[0]&&F[0].aFilters[0]&&F[0].aFilters[0].aFilters[0]&&F[0].aFilters[0].aFilters[0].aFilters&&F[0].aFilters[1].aFilters[0].aFilters){F=t._formatMultiFilter(F,0,true);F=t._formatMultiFilter(F,1,true);}else if(F[0]&&F[0].aFilters[0]&&F[0].aFilters[1]&&F[0].aFilters[0].aFilters[0]&&F[0].aFilters[0].aFilters[0].aFilters&&F[0].aFilters[1].aFilters){F=t._formatMultiFilter(F,0,true);F=t._formatMultiFilter(F,1,false);}else if(F[0]&&F[0].aFilters[0]&&F[0].aFilters[1]&&F[0].aFilters[1].aFilters[0]&&F[0].aFilters[0].aFilters&&F[0].aFilters[1].aFilters[0].aFilters){F=t._formatMultiFilter(F,0,false);F=t._formatMultiFilter(F,1,true);}else if(F[0]&&F[0].aFilters[0]&&F[0].aFilters[1]&&F[0].aFilters[0].aFilters&&F[0].aFilters[1].aFilters){F=t._formatMultiFilter(F,0,false);F=t._formatMultiFilter(F,1,false);}return F;};f.prototype._formatSingleFilter=function(F){var t=this;var _=null;for(var i=0;i<F[0].aFilters.length;i++){if(F[0].aFilters[i].sOperator==="Contains"){F[0].aFilters[i].sOperator="EQ";}else if(F[0].aFilters[i].sOperator==="BT"){var g=t._manageParam(F[0].aFilters[i].sPath,F[0].aFilters[i].sOperator,F[0].aFilters[i].oValue1,F[0].aFilters[i].oValue2);delete F[0].aFilters[i];F[0].aFilters[i]=g;}else if(F[0].aFilters[i].sOperator==="StartsWith"){_=(F[0].aFilters[i].sPath===this._propertyValue)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(F[0].aFilters[i].sOperator+" operator not supported");}else if(F[0].aFilters[i].sOperator==="EndsWith"){_=(F[0].aFilters[i].sPath===this._propertyValue)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(F[0].aFilters[i].sOperator+" operator not supported");}}return F;};f.prototype._formatMultiFilter=function(F,i,m){var t=this;var _=null;var g=[];if(m){g=F[0].aFilters[i].aFilters[0].aFilters;}else{g=F[0].aFilters[i].aFilters;}for(var h=0;h<g.length;h++){if(g[h].sOperator==="Contains"){g[h].sOperator="EQ";}else if(g[h].sOperator==="BT"){var j=t._manageParam(g[h].sPath,g[h].sOperator,g[h].oValue1,g[h].oValue2);delete g[h];g[h]=j;}else if(g[h].sOperator==="StartsWith"){_=(g[h].sPath===this._propertyValue)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(g[h].sOperator+" operator not supported");}else if(g[h].sOperator==="EndsWith"){_=(g[h].sPath===this._propertyValue)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(g[h].sOperator+" operator not supported");}}return F;};f.prototype._manageParam=function(p,o,v,g){var h=[];if(v&&g){h=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(p,sap.ui.model.FilterOperator.GT,v),new sap.ui.model.Filter(p,sap.ui.model.FilterOperator.LT,g)],and:true});}return h;};f.prototype._getSearchFilters=function(s){return new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(this._propertyValue,sap.ui.model.FilterOperator.EQ,s),new sap.ui.model.Filter(this._propertyDescription,sap.ui.model.FilterOperator.EQ,s)],and:false});};f.prototype.setValueStateFilter=function(o){var i=o.getSource().sId;this._valueFieldValue=sap.ui.getCore().byId(i+"-filterItemControlA_-Value");if(this._valueFieldValue){this._valueFieldValue.setValueState("None");this._valueFieldValue.setValueStateText("");}this._valueFieldDescription=sap.ui.getCore().byId(i+"-filterItemControlA_-Description");if(this._valueFieldDescription){this._valueFieldDescription.setValueState("None");this._valueFieldDescription.setValueStateText("");}};f.prototype.onValueHelpLinkPress=function(v,g){if(!this.getEditable()){return;}var h=sap.ui.getCore().byId(this.getExpressionLanguage());var j=h.getValueHelpCallback();var t=this.getExpressionTokens();var i;var k;var l=this.codeMirror.getCursor().line;var m;for(i=0;i<t.length;i++){if(t[i].tokenType==='valueList'&&t[i].info&&t[i].info.id===g&&t[i].token===v){k=[t[i].info];m=t[i].end;break;}}var n={};n.ch=m;n.line=l;if((typeof j)==="function"){j.call(this,k);var o=k[0].model;if(!o.getMetaModel().oModel){o.attachMetadataLoaded(function(){this._createValueHelpProvider(k[0],true);}.bind(this));}else{this._createValueHelpProvider(k[0],true);}}else if(k&&k[0].metadata.hasOwnProperty(this._hasValueSource)&&k[0].metadata.HasValueSource===true){k[0].expressionLanguage=h;this._createCpValueHelp(k[0],n,true,true);}};f.prototype._createSearchCursor=function(v){var g=this.codeMirror;g.getCursor().ch=g.getCursor().ch+v.length;var h=g.getSearchCursor(v,g.getCursor(),typeof v=="string"&&v==v.toLowerCase());return h;};f.prototype.setTextOnCursor=function(v,g,r,h,A,k){function l(y,z){var G=y+1;for(var j=G;j<z.length;j++){if(z[j].length===0){G++;}else{break;}}return G;}var T="String",m="Date",n="Timestamp",o="Time";var p;var F=((h===T)||(h===m)||(h===n)||(h===o))?"'"+v+"'":v;var t=this.getExpressionTokens();var s=this.getValue().split("\n");var u=-1;var w={start:{line:g.line,ch:g.ch},end:{line:g.line,ch:g.ch}};for(var i=0;i<t.length;i++){u=(t[i].start===0)?l(u,s):u;if(u===g.line&&(t[i].end>g.ch)||(t[i].end>=g.ch&&k)){w.start.ch=t[i].start;w.end.ch=t[i].end;r=true;break;}}if(r){this.codeMirror.replaceRange(F,w.start,w.end);p=this.codeMirror.findPosH(w.start,F.length,"char",true);this.codeMirror.setCursor(p);}else{F=A?" "+F:F;this.codeMirror.replaceRange(F,g);p=this.codeMirror.findPosH(g,F.length,"char",true);this.codeMirror.setCursor(p);}var x=sap.ui.getCore().byId(this.getExpressionLanguage());this.getFormattingTokens(x);this.ValueHelpRequested=false;};f.prototype._setCodeMirror=function(){var g=this.getEditable();var h;if("getAttributeInfo"in this&&this.getAttributeInfo()){h=this.getAttributeInfo();}var j=sap.ui.getCore().byId(this.getExpressionLanguage());var v;if(h){v=j.getValueListAttribute(h);}function k(i,y,z){var A=i.options.expressionEditor;if((A.getEditable()!==false)&&sap.ui.getCore().byId(A.getExpressionLanguage())){window.clearTimeout(A.timer);A.timer=window.setTimeout(function(){i.execCommand(y);},z);return window.CodeMirror.Pass;}return null;}function o(i){var A=i.options.expressionEditor;if(A.getEditable()!==false){window.clearTimeout(A.timer);A.needAutoComplete=true;A.timer=window.setTimeout(function(){if(A.needAutoComplete&&sap.ui.getCore().byId(A.getExpressionLanguage())){i.execCommand("autocomplete");}},500);return window.CodeMirror.Pass;}return null;}function l(i){return k(i,"enterAutocomplete",500);}function m(i){return k(i,"colonAutocomplete",500);}function n(i){k(i,"autocomplete",0);}function s(i){return k(i,"autocomplete",500);}function p(y){var A=y.options.expressionEditor;var z=y.getRange({line:0,ch:0},y.getCursor());if(y.options.headerValue){var F=y.options.headerValue+" ";if(y.options.fixedOperator){F=F+y.options.fixedOperator+" ";}z=F+z;}var G=y.options.relDelegate.getSuggestions(z,y.options.returnType,y.options.collection);var I;if(G&&G.hasOwnProperty("suggs")&&G.suggs.length>0){I=G.suggs;for(var i=0;i<I.length;i++){if(I[i].tokenType==='valueList'&&I[i].info.metadata.hasOwnProperty(A._hasValueSource)){A._createCpValueHelp(I[i].info,y.getCursor(),false);}}}}this.keyMap={"Tab":false,"Shift-Tab":false,"Ctrl-Space":n,"Backspace":o,"Enter":l,"':'":m,"'+'":o,"'-'":o,"'*'":o,"'/'":o,"'_'":o,"'o'":o,"'q'":o,"'w'":o,"'e'":o,"'r'":o,"'t'":o,"'y'":o,"'u'":o,"'i'":o,"'p'":o,"'.'":o,"'a'":o,"'s'":o,"'d'":o,"'f'":o,"'g'":o,"'h'":o,"'j'":o,"'k'":o,"'l'":o,"'z'":o,"'x'":o,"'c'":o,"'v'":o,"'b'":o,"'n'":o,"'m'":o,"'O'":o,"'Q'":o,"'W'":o,"'E'":o,"'R'":o,"'T'":o,"'Y'":o,"'U'":o,"'I'":o,"'P'":o,"'A'":o,"'S'":o,"'D'":o,"'F'":o,"'G'":o,"'H'":o,"'J'":o,"'K'":o,"'L'":o,"'Z'":o,"'X'":o,"'C'":o,"'V'":o,"'B'":o,"'N'":o,"'M'":o,"'0'":false,"'1'":false,"'2'":false,"'3'":false,"'4'":false,"'5'":false,"'6'":false,"'7'":false,"'8'":false,"'9'":false,"' '":s,"F4":p};function r(A){return A.keyMap;}if(this.expressionTokens.length===0){var t=sap.ui.getCore().byId(this.getExpressionLanguage());if(t){this.getFormattingTokens(t);}}var u=r(this);var w=this.oTextArea.getId()+'-inner';var x=(U.msieversion()>=0);if(x){jQuery('#'+w).attr('placeholder',this.getProperty('placeholder'));}this.codeMirror=window.CodeMirror.fromTextArea(document.getElementById(w),{mode:"text/hdf",lineNumbers:false,lineWrapping:true,matchBrackets:g===true?true:false,highlightSelectionMatches:g===true?{showToken:/\w/}:{},relDelegate:j,returnType:this.getProperty("type"),collection:this.getProperty("collection"),valueListAttribute:v,expressionEditor:this,stillNeedShowHint:true,shouldValidate:true,styleSelectedText:true,smartIndent:true,autoCloseBrackets:true,indentUnit:6});this.codeMirror.addKeyMap(u,true);};f.prototype.getFormattingTokens=function(o){this.tokens=[];this.valueListAttrInfo=o.getValueListAttribute(this.mProperties.attributeInfo);var g=o.getExpressionMetadata(this._liveValue);if(g){this.tokens=g.tokens;}if(o._hasValueSource&&this.valueListAttrInfo){this.newExpression=this.valueListAttrInfo.navPath+" "+e.IS_EQUAL_TO+" "+this._liveValue;g=o.getExpressionMetadata(this.newExpression);if(g){var t=g.tokens;for(var h=0;h<t.length;h++){for(var p=0;p<this.tokens.length;p++){if(t[h].tokenType==="valueList"&&t[h].token===this.tokens[p].token){this.tokens[p].info=t[h].info;this.tokens[p].tokenType=t[h].tokenType;}}}}}this.setExpressionTokens(this.tokens);};f.prototype._setEditorStyle=function(){if(this.getValueStateText()&&this.getValueStateText()!==""){jQuery(this.codeMirror.getWrapperElement()).addClass('CodeMirror-error');jQuery(this.codeMirror.getWrapperElement()).addClass('sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError');jQuery('#'+this.oTextArea.getId()).addClass('sapMInputBaseError');}jQuery('#'+this.oTextArea.getId()).removeClass().addClass('sapMInput');jQuery(this.codeMirror.getWrapperElement()).addClass('sapMInputBaseInner CodeMirror-rules');if(!this.getEditable()){jQuery(this.codeMirror.getWrapperElement()).addClass('CodeMirror-rules-Not-Editable');}else{jQuery(this.codeMirror.getWrapperElement()).removeClass('CodeMirror-rules-Not-Editable');}if(this.codeMirror){this.codeMirror.refresh();}};f.prototype._handleOnLoadValidation=function(){if(this.getValidateOnLoad()){this.validateExpression();this.setValidateOnLoad(false);}};f.prototype._handleEditableProperty=function(){if(this.getEditable()===false){this.codeMirror.setOption("readOnly","true");this.codeMirror.setOption("theme","read-only");}};f.prototype._handleFocus=function(){var o=this.codeMirror;if(this.getFocusOnLoad()){this.focus();}this.codeMirror.on("focus",function(g,h){var i=g.options.expressionEditor.getProperty("valueStateText");if(i&&i!==""){g.options.expressionEditor._showPopUp();}g.options.stillNeedShowHint=true;jQuery('#'+g.options.expressionEditor.oTextArea.getId()).addClass('sapMInputFocused');jQuery(g.getWrapperElement()).removeClass('CodeMirror-errorBackground');});if(this.dataModel.getProperty("/focus")===true){window.setTimeout(function(){var l=o.getLine(o.lastLine());var g=l.length;o.setCursor({line:o.lastLine(),ch:g});},10);}};f.prototype._refreshOnNavigationEnd=function(){jQuery(".sapMNav").on('webkitTransitionEnd oTransitionEnd transitionend msTransitionEnd',jQuery.proxy(_,this));function _(){if(this.codeMirror){this.codeMirror.refresh();}}};f.prototype._handleKeyPress=function(){this.codeMirror.on("keyHandled",function(g,k,h){if(h.keyCode===27&&this&&this.endCompletion===true){h.stopPropagation();this.endCompletion=false;}if(h.ctrlKey===true&&k==="Ctrl-A"){h.stopPropagation();}});};f.prototype._handleEndCodeCompletion=function(){this.codeMirror.on("endCompletion",function(g){g.options.expressionEditor.needAutoComplete=false;g.options.expressionEditor.endCompletion=!g.options.expressionEditor.endCompletion;});};f.prototype._handleMousedown=function(){this.codeMirror.on("mousedown",function(g,h){h.stopPropagation();var t=h.target||h.srcElement;if(t&&h.button===0){var j=t.className.split(/\s+/);for(var i=0;i<j.length;i++){if(j[i]==='cm-valuehelp'){var v=j[++i].split('-valuehelpid-')[1];g.options.expressionEditor.onValueHelpLinkPress(t.textContent,v);}}}});};f.prototype._handleChange=function(){this.codeMirror.on("change",function(g,h){var A=g.options.expressionEditor;if(A.codeMirror.state.completionActive&&A.keyMap["'"+h.text[0]+"'"]===false){A.codeMirror.state.completionActive.close();}jQuery(A.codeMirror.getWrapperElement()).removeClass('CodeMirror-error');jQuery(A.codeMirror.getWrapperElement()).removeClass('sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError');A._liveValue=g.getValue();var o=sap.ui.getCore().byId(A.getExpressionLanguage());if(o){A.getFormattingTokens(o);}A.codeMirror.options.shouldValidate=true;A.fireLiveChange({newValue:g.getValue()});if(h.origin!=="+delete"){g.operation(function(){for(var l=0,i=g.lineCount();l<i;++l){g.indentLine(l,"smart");}});}});};f.prototype._handleFocusLeave=function(){this.codeMirror.on("blur",function(g){var A=g.options.expressionEditor;A._closePopUp();A.codeMirror.options.stillNeedShowHint=false;if(A.codeMirror.options.shouldValidate&&!A.bFlagForPreventBlurWhenPopOverOpen){A.setValue(A.codeMirror.getValue());if(!(A instanceof sap.rules.ui.DecisionTableCellExpressionAdvanced)){A.validate();}A._closePopUp();A.fireChange({newValue:g.getValue()});A.codeMirror.options.shouldValidate=false;}jQuery('#'+A.oTextArea.getId()).removeClass('sapMInputFocused');A.dataModel.setProperty("/focus",false);});};f.prototype._setExpressionErrorStyle=function(){var g=this.getProperty("valueStateText");if(g!==""&&g!==undefined&&this.codeMirror){jQuery(this.codeMirror.getWrapperElement()).addClass('CodeMirror-error');jQuery(this.codeMirror.getWrapperElement()).addClass('sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError');jQuery('#'+this.oTextArea.getId()).addClass('sapMInputBaseError');var h;if(this.errorCursorPosition<0){var l=this.codeMirror.getLine(this.codeMirror.lastLine());h=l.length;jQuery(this.codeMirror.getWrapperElement()).addClass('CodeMirror-errorBackground');}else{var i=g.lastIndexOf("'");if(i>0){var o=g.substring(0,i);i=o.lastIndexOf("'");if(i>0){o=o.substring(i+1);}var j=false;for(var k=this.codeMirror.lastLine();!j&&k>=0;k--){var m=this.codeMirror.getLine(k);h=m.lastIndexOf(o);if(h>=0){j=true;this.codeMirror.setSelection({line:k,ch:h},{line:k,ch:h+o.length});}}}}}};f.prototype.getSelectedText=function(){return this.codeMirror.getSelection();};f.prototype.exit=function(){document.removeEventListener("mousedown",this.fnMouseDownListsner,true);};return f;},true);
