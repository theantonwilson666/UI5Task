sap.ui.define(["sap/ui/thirdparty/jquery","../../library","sap/ui/core/Control","sap/m/List","sap/ui/model/json/JSONModel","sap/m/ListMode","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/rules/ui/parser/infrastructure/util/utilsBase","sap/ui/core/LocaleData","sap/rules/ui/Constants","sap/m/DatePicker","sap/m/DateTimePicker","sap/m/TimePicker","sap/m/Dialog","sap/m/Button"],function(q,l,C,L,J,a,b,S,c,d,e,D,f,T,g,B){"use strict";var h=C.extend("sap.rules.ui.ast.autoCompleteContent.AutoSuggestionFixedValuePanel",{metadata:{library:"sap.rules.ui",properties:{reference:{type:"object",defaultValue:null,},vocabularyInfo:{type:"object",defaultValue:null},data:{type:"object",defaultValue:null},dialogOpenedCallbackReference:{type:"object",defaultValue:null,},inputValue:{type:"string",defaultValue:""}},aggregations:{PanelLayout:{type:"sap.m.Panel",multiple:false}},events:{}},init:function(){this.infraUtils=new sap.rules.ui.parser.infrastructure.util.utilsBase.lib.utilsBaseLib();this.needCreateLayout=true;this.businessDataType="S";this._propertyValue="Value";this._propertyDescription="Description";this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.vocabularyInfo=this.getVocabularyInfo();this.autoSuggestionData=this.getData();var o=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var i=d.getInstance(o);this.oFormatDate=sap.ui.core.format.DateFormat.getInstance({pattern:i.getDatePattern('short'),calendarType:sap.ui.core.CalendarType.Gregorian},o);},onBeforeRendering:function(){this._reference=this.getReference();this._dialogOpenedCallbackReference=this.getDialogOpenedCallbackReference();this.vocabularyInfo=this.getVocabularyInfo();this.valueHelpData=this.getData();if(this.needCreateLayout){var i=this._createLayout(this.vocabularyInfo);this.setAggregation("PanelLayout",i,true);this.needCreateLayout=false;}},onAfterRendering:function(){var i="#"+this.fixedValueTextArea.getId();$(i).on('keydown',function(j){if(j.key=='Enter'){j.preventDefault();}});},initializeVariables:function(){},_createLayout:function(v){var t=this;var i=false;if(this.getData().valuehelp){i=true;}else{i=false;}this._invisibleText=new sap.ui.core.InvisibleText({text:this.oBundle.getText("fixedValueInvisibleText")});this.fixedValueTextArea=new sap.m.Input({showValueHelp:i,showSuggestion:true,autocomplete:false,ariaLabelledBy:this._invisibleText.getId(),valueHelpRequest:function(){t._dialogOpenedCallbackReference(true);t._setModal(true);t._generateValueHelpInfoAndCreateDialog(v)},value:this.getInputValue(),change:function(k){t._setModal(false);var E=t._formatText(k);E.oSource.mProperties.forceFireChange=true;t._reference(E);}.bind(this),width:"auto"});var j=new sap.m.Panel({headerText:this.oBundle.getText("fixedValuePanelTitle"),expandable:true,expanded:false,content:[this._invisibleText,this.fixedValueTextArea],width:"auto"});this.toolBarSpacerAfterInput=new sap.m.ToolbarSpacer({width:"1em"});this.toolBarSpacerAfterDateLink=new sap.m.ToolbarSpacer({width:"1em"});this.dateContent=this._createDateLink();this.timeContent=this._createTimeStampLink();j.addContent(this.toolBarSpacerAfterInput);j.addContent(this.dateContent);j.addContent(this.toolBarSpacerAfterDateLink);j.addContent(this.timeContent);return j;},_setModal:function(v){var p=sap.ui.getCore().byId("popover");if(p){p.setModal(v);}},_generateValueHelpInfoAndCreateDialog:function(v){var t=this;var i=this.getData().valuehelp;if(i){i.expressionLanguage=v;i.HasValueSource=true;if(i.sourceType==="U"){i.entitySet="Enumerations";i.serviceURL="/Enumerations";}else{i.entitySet="ExternalValues";i.serviceURL="/ExternalValues";}var j=v.getModel().sServiceUrl;t._createDialog(j,i);}},_createDialog:function(i,v,j){this._createValueHelpDialog(i,v);this._createSmartFilterBar(i,v);this.oValueHelpDialog.setFilterBar(this.oFilterBar);this._openValueHelpDialog();},_openValueHelpDialog:function(){this.oValueHelpDialog.open();this.oValueHelpDialog.getTable().setBusy(true);},_createValueHelpDialog:function(i,v){var t=this;var j=v.expressionLanguage.getModel();var k="Attributes(Id='"+v.attributeId+"',VocabularyId='"+v.vocabularyId+"',DataObjectId='"+v.dataObjectId+"')";if(k.includes(":")){k=k=k.replace(":","%3A");}this.attributeName=v.attributeName;if(!j.oData[k]){v.dataObjectId=this._getStructureObjectForTableType(v.attributeId,v);}sap.ui.core.BusyIndicator.show(0);this.oValueHelpDialog=new sap.ui.comp.valuehelpdialog.ValueHelpDialog({supportMultiselect:false,supportRanges:false,horizontalScrolling:false,title:t.attributeName,resizable:false,beforeOpen:function(){t._bindTable(i,v);},ok:function(E){var s=E.getParameter("tokens")[0].data("row");var m=s.Value;if(t.businessDataType==="D"||t.businessDataType==="U"){m=t._getValidValue(m);}var u=this._syncToken(m,t.businessDataType);E.getParameter("tokens")[0].data("row").Value=u;E.oSource.mProperties.forceFireChange=true;t._dialogOpenedCallbackReference(false);t.oValueHelpDialog.close();t._setModal(false);t.oValueHelpDialog.destroy();sap.ui.core.BusyIndicator.hide();t._reference(E);}.bind(this),cancel:function(){t.oFilterBar.destroy();t._setModal(false);t.oValueHelpDialog.close();t.oValueHelpDialog.destroy();sap.ui.core.BusyIndicator.hide();},afterClose:function(){t._dialogOpenedCallbackReference(false);t.oFilterBar.destroy();sap.ui.core.BusyIndicator.hide();}});},_getStructureObjectForTableType:function(i,v){var j=v.expressionLanguage.getData().ValueSources;for(var k in j){if(i===j[k].AttributeId){return j[k].DataObjectId;}}return v.dataObjectId;},_syncToken:function(t,i){var j=false;var k=false;i=this.getData().valuehelp.attributeDataType;if(i!="G"){var n=t.replace(/'/g,"").replace(/"/g,"");}else{n="'"+t+"'";}if(i==="N"){var m=parseFloat(n);var s=m.toString();if(s!=n){i="Operations"}else if(s==="NaN"){i="S"}else{n=m;}}if(i==="S"||i==="D"||i==="U"){if(!(i==="S")){if(i==="D"){this._dateBusinessDataType="D";}else if(i==="U"){this._dateBusinessDataType="U";}n=this._getValidDateValue(n);}n=n.toString();if(n==="'"){j=true;}if(n.substr(0,"'")!=="'"){j=true;}if(n.substr(n.length-1,"'")!=="'"){k=true;}if(j){n="'"+n;}if(k){n=n+"'";}}if(i==="B"){n=(n==="true");}return n;},_getValidDateValue:function(v){var i,j;var s="";var k=this._getDateTimeFormatterForParsing();if(k){i=k.parse(v);}if(this._dateBusinessDataType==="D"){j=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});s=j.format(i);}else if(this._dateBusinessDataType==="U"){j=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"});s=j.format(i);}if(s!==""){s;}return v;},_createSmartFilterBar:function(i,v){var t=this;this.oFilterBar=new sap.ui.comp.smartfilterbar.SmartFilterBar({entitySet:v.entitySet,enableBasicSearch:true,advancedMode:true,filterBarExpanded:true,search:function(){t.onSearch(i,v);},filterChange:function(E){t.setValueStateFilter(E);},controlConfiguration:[t._createControlConfiguration()]});var m=new sap.ui.model.odata.v2.ODataModel(i);this.oFilterBar.setModel(m);},_createControlConfiguration:function(){var i=[new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Value",label:"Value",visibleInAdvancedArea:true,width:"100px",index:1}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Description",label:"Description",visibleInAdvancedArea:true,width:"100px",index:2}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"VocabularyId",label:"VocabularyId",width:"100px",visible:false,index:3}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"DataObjectId",label:"DataObjectId",visible:false,width:"100px",groupId:"abc",index:4}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"AttributeId",label:"AttributeId",visible:false,width:"100px",index:5}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Version",label:"Version",visible:false,width:"100px",index:6})];return i;},onSearch:function(i,v){this.oValueHelpDialog.getTable().setBusy(true);this._unBindTable();this._bindTable(i,v);},_bindTable:function(j,v){var s=v.serviceURL;var F=this._fetchFilterParams(v);var E={valueHelp:{collection:s,properties:[this._propertyValue,this._propertyDescription]}};var t=this.oValueHelpDialog.getTable();t.setThreshold(10);for(var i=0;i<E.valueHelp.properties.length;i++){this._addValueHelpColumn(E.valueHelp.properties[i],t);}var m=new sap.ui.model.odata.v2.ODataModel(j);t.setModel(m);t.bindRows(E.valueHelp.collection,null,F);t.getBinding("rows").attachDataReceived(this._handleRowsDataReceived,this);},_handleRowsDataReceived:function(E){var t=this;var i=E.getParameter("data");if(q.isEmptyObject(i)||(i&&i.results&&i.results.length===0)){this.oValueHelpDialog.getTable().setNoData(t.oBundle.getText("no_data"));}else{this.oValueHelpDialog.getTable().setNoData(t.oBundle.getText("searching"));}this.oValueHelpDialog.getTable().setBusy(false);},_addValueHelpColumn:function(o,t){var i=new sap.ui.table.Column().setLabel(new sap.m.Label({text:o}));if(o===this._propertyValue){i.setSortProperty(o);}t.addColumn(i.setTemplate(new sap.m.Text().bindProperty("text",o)));},_unBindTable:function(){var t=this.oValueHelpDialog.getTable();t.destroyColumns();t.unbindRows();},_fetchFilterParams:function(v){var t=this;var s=[];var F=[new sap.ui.model.Filter("AttributeId",sap.ui.model.FilterOperator.EQ,v.attributeId),new sap.ui.model.Filter("DataObjectId",sap.ui.model.FilterOperator.EQ,v.dataObjectId),new sap.ui.model.Filter("VocabularyId",sap.ui.model.FilterOperator.EQ,v.vocabularyId)];var i=this.oFilterBar.getFilters();var j=this.oFilterBar.getParameters();if(!q.isEmptyObject(j)&&i&&i.length>0){j=this.oFilterBar.getParameters().custom.search;s=this._getSearchFilters(j);i=t._formatFilterParams(i);F.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(i),new sap.ui.model.Filter(s)],and:true}));}else if(!q.isEmptyObject(j)){j=this.oFilterBar.getParameters().custom.search;s=this._getSearchFilters(j);F.push(s);}else if(i&&i.length>0){i=t._formatFilterParams(i);F.push(i[0]);}return F;},_formatFilterParams:function(F){var t=this;if(F[0]&&F.length===1&&F[0].aFilters[0]&&F[0].aFilters[0].sOperator){F=t._formatSingleFilter(F);}else if(F[0]&&F[0].aFilters[0]&&F[0].aFilters[0].aFilters[0]&&F[0].aFilters[0].aFilters[0].aFilters&&F[0].aFilters[1].aFilters[0].aFilters){F=t._formatMultiFilter(F,0,true);F=t._formatMultiFilter(F,1,true);}else if(F[0]&&F[0].aFilters[0]&&F[0].aFilters[1]&&F[0].aFilters[0].aFilters[0]&&F[0].aFilters[0].aFilters[0].aFilters&&F[0].aFilters[1].aFilters){F=t._formatMultiFilter(F,0,true);F=t._formatMultiFilter(F,1,false);}else if(F[0]&&F[0].aFilters[0]&&F[0].aFilters[1]&&F[0].aFilters[1].aFilters[0]&&F[0].aFilters[0].aFilters&&F[0].aFilters[1].aFilters[0].aFilters){F=t._formatMultiFilter(F,0,false);F=t._formatMultiFilter(F,1,true);}else if(F[0]&&F[0].aFilters[0]&&F[0].aFilters[1]&&F[0].aFilters[0].aFilters&&F[0].aFilters[1].aFilters){F=t._formatMultiFilter(F,0,false);F=t._formatMultiFilter(F,1,false);}return F;},_formatSingleFilter:function(F){var t=this;var _=null;for(var i=0;i<F[0].aFilters.length;i++){if(F[0].aFilters[i].sOperator==="Contains"){F[0].aFilters[i].sOperator="EQ";}else if(F[0].aFilters[i].sOperator==="BT"){var j=t._manageParam(F[0].aFilters[i].sPath,F[0].aFilters[i].sOperator,F[0].aFilters[i].oValue1,F[0].aFilters[i].oValue2);delete F[0].aFilters[i];F[0].aFilters[i]=j;}else if(F[0].aFilters[i].sOperator==="StartsWith"){_=(F[0].aFilters[i].sPath===this._propertyValue)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(F[0].aFilters[i].sOperator+" operator not supported");}else if(F[0].aFilters[i].sOperator==="EndsWith"){_=(F[0].aFilters[i].sPath===this._propertyValue)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(F[0].aFilters[i].sOperator+" operator not supported");}}return F;},_formatMultiFilter:function(F,i,m){var t=this;var _=null;var j=[];if(m){j=F[0].aFilters[i].aFilters[0].aFilters;}else{j=F[0].aFilters[i].aFilters;}for(var k=0;k<j.length;k++){if(j[k].sOperator==="Contains"){j[k].sOperator="EQ";}else if(j[k].sOperator==="BT"){var n=t._manageParam(j[k].sPath,j[k].sOperator,j[k].oValue1,j[k].oValue2);delete j[k];j[k]=n;}else if(j[k].sOperator==="StartsWith"){_=(j[k].sPath===this._propertyValue)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(j[k].sOperator+" operator not supported");}else if(j[k].sOperator==="EndsWith"){_=(j[k].sPath===this._propertyValue)?this._valueFieldValue:this._valueFieldDescription;_.setValueState("Error");_.setValueStateText(j[k].sOperator+" operator not supported");}}return F;},_manageParam:function(p,o,v,i){var j=[];if(v&&i){j=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(p,sap.ui.model.FilterOperator.GT,v),new sap.ui.model.Filter(p,sap.ui.model.FilterOperator.LT,i)],and:true});}return j;},_getSearchFilters:function(s){return new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(this._propertyValue,sap.ui.model.FilterOperator.EQ,s),new sap.ui.model.Filter(this._propertyDescription,sap.ui.model.FilterOperator.EQ,s)],and:false});},setValueStateFilter:function(E){var i=E.getSource().sId;this._valueFieldValue=sap.ui.getCore().byId(i+"-filterItemControlA_-Value");if(this._valueFieldValue){this._valueFieldValue.setValueState("None");this._valueFieldValue.setValueStateText("");}this._valueFieldDescription=sap.ui.getCore().byId(i+"-filterItemControlA_-Description");if(this._valueFieldDescription){this._valueFieldDescription.setValueState("None");this._valueFieldDescription.setValueStateText("");}},_formatText:function(E){var t=this;var i=this.getData().businessDataTypeList;if(i&&i.length>0){this.businessDataType=this.getData().businessDataTypeList[0];}else{this.businessDataType="N"}var j=E.getSource().getValue();E.getSource().setValue(j);return E;},_createDateLink:function(){var t=this;this.dateContent=new sap.m.Link({wrapping:true,text:this.oBundle.getText("select_date"),press:function(E){t.dateContext="D";t._createDateTimeDialog();}});return this.dateContent;},_createTimeStampLink:function(){var t=this;this.timeContent=new sap.m.Link({wrapping:true,text:this.oBundle.getText("select_date_time"),press:function(E){t.dateContext="U";t._createDateTimeDialog();}});return this.timeContent;},_createDateTimeDialog:function(){var t=this;var o=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var i=d.getInstance(o);var j=i.getDatePattern('medium');var k=i.getTimePattern('medium');var v=j+" "+k;if(this.dateContext){this._dateBusinessDataType=this.dateContext;}if(this._dateBusinessDataType==="D"){this.control=new D({width:"auto",valueFormat:j});}if(this._dateBusinessDataType==="U"){var t=this;this.control=new f({width:"auto",valueFormat:v});}this._oSelectNewDateDialog=new g({title:this.oBundle.getText("calendarTitle"),afterClose:function(){t._dialogOpenedCallbackReference(false);},content:[this.control],beginButton:new B({text:this.oBundle.getText("okBtn"),enabled:true,press:function(E){var m=this._updateText(this.control);E.oSource.mProperties.value="'"+m+"'";E.oSource.mProperties.dateSelected=this._dateBusinessDataType;E.oSource.mProperties.forceFireChange=true;t._reference(E);t._setModal(false);t._oSelectNewDateDialog.close();}.bind(this)}),endButton:new B({text:this.oBundle.getText("clsBtn"),press:function(){t._setModal(false);t._oSelectNewDateDialog.close();}.bind(this)})});this._dialogOpenedCallbackReference(true);this._setModal(true);this._oSelectNewDateDialog.open();},_updateText:function(o){var s=o._getInputValue();var i=this._getValidValue(s);return i;},_getValidValue:function(v){var i,j;var s="";if(this.dateContext){this._dateBusinessDataType=this.dateContext;}var k=this._getDateTimeFormatterForParsing();if(k){i=k.parse(v);}if(this._dateBusinessDataType==="D"){j=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});s=j.format(i);}else if(this._dateBusinessDataType==="U"){j=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"});s=j.format(i);}if(s!==""){return s;}return v;},_getDateTimeFormatterForParsing:function(){var i;var o=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var j=d.getInstance(o);var k=j.getDatePattern('medium');var t=j.getTimePattern('medium');if(this.dateContext==="D"){i=sap.ui.core.format.DateFormat.getDateInstance({pattern:k});}else if(this.dateContext==="U"){i=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:k+" "+t});}return i;}});return h;},true);
