sap.ui.define(["sap/ui/thirdparty/jquery","../../library","sap/ui/core/Control","sap/m/List","sap/ui/model/json/JSONModel","sap/m/ListMode","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/rules/ui/parser/infrastructure/util/utilsBase"],function(q,l,C,L,J,a,b,S,i){"use strict";var c=C.extend("sap.rules.ui.ast.autoCompleteContent.AutoSuggestionVocabularyPanel",{metadata:{library:"sap.rules.ui",properties:{reference:{type:"object",defaultValue:null,},dialogOpenedCallbackReference:{type:"object",defaultValue:null,},data:{type:"object",defaultValue:null},context:{type:"string",defaultValue:""},},aggregations:{PanelLayout:{type:"sap.m.Panel",multiple:false}},events:{}},init:function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.infraUtils=new sap.rules.ui.parser.infrastructure.util.utilsBase.lib.utilsBaseLib();this.needCreateLayout=true;this.AttributeSegmentSelected=true;this.dataObjectName="";},onBeforeRendering:function(){this._reference=this.getReference();this._dialogOpenedCallbackReference=this.getDialogOpenedCallbackReference();if(this.needCreateLayout){var d=this._createLayout();this.setAggregation("PanelLayout",d,true);this.needCreateLayout=false;}},initializeVariables:function(){},_createAggregateFunctionSection:function(){var A=new sap.m.Panel({expandable:false,expanded:true,width:"auto",content:[new sap.m.Link({wrapping:true,text:this.oBundle.getText("aggregateFunctionPanelTitle"),press:function(e){var f=new sap.ui.layout.HorizontalLayout({content:[new sap.m.Label({text:this.oBundle.getText("function")+": "}),new sap.m.Select({width:"200px",height:"60px"}),new sap.m.Label({text:" "+this.oBundle.getText("oflabel")+" "}),new sap.m.TextArea({value:"",showExceededText:true,width:"150%",height:"65px"})]});var w=new sap.ui.layout.HorizontalLayout({content:[new sap.m.Label({text:this.oBundle.getText("where_label")+":"}),new sap.m.TextArea({value:"",showExceededText:true,width:"300px"})]});var G=new sap.ui.layout.HorizontalLayout({content:[new sap.m.Label({text:this.oBundle.getText("group_by")+": "}),new sap.m.TextArea({value:"",showExceededText:true,width:"300px"})]});var F=new sap.ui.layout.HorizontalLayout({content:[new sap.m.Label({text:this.oBundle.getText("function_label")+":",}),new sap.m.TextArea({value:"",enabled:false,width:"300px"})]});var v=new sap.ui.layout.VerticalLayout({content:[f,w,G,F]});var t=this;var g=new sap.m.Dialog({title:this.oBundle.getText("configure_aggr_title"),contentWidth:"800px",contentHeight:"500px",showHeader:true,content:[v],afterClose:function(){t._dialogOpenedCallbackReference(false);},buttons:[new sap.m.Button({text:this.oBundle.getText("applyChangesBtn"),tooltip:this.oBundle.getText("applyChangesBtn"),press:function(h){g.close();}}),new sap.m.Button({text:this.oBundle.getText("cancelBtn"),tooltip:this.oBundle.getText("cancelBtn"),press:function(h){g.close();}})]});g.open();}})]});var d=new sap.m.CustomListItem({content:A});return d;},_createLayout:function(){var t=this;this.VocabularyTerms=this.getData();var m=new sap.ui.model.json.JSONModel();var d=[];for(var e=0;e<5&&e<this.VocabularyTerms.length;e++){d.push(this.VocabularyTerms[e]);}m.setData(d);this.vocabularylist=new sap.m.List({growingScrollToLoad:true,enableBusyIndicator:true});this.vocabularylist.bindItems({path:"/",sorter:new sap.ui.model.Sorter("label"),rememberSelections:false,mode:a.SingleSelectMaster,template:new sap.m.DisplayListItem({label:"{label}",type:"Active",press:function(E){t._setModal(false);t._reference(E);}})});this.vocabularylist.setModel(m);var f=this.getMoreVocabulariesLink();var v=new sap.m.Panel({headerText:this.oBundle.getText("vocabularyPanelTitle"),expandable:true,expanded:true,content:this.vocabularylist,width:"auto"});if(this.VocabularyTerms.length>=5){v.addContent(f);}return v;},_setModal:function(v){var p=sap.ui.getCore().byId("popover");if(p){p.setModal(v);}},getMoreVocabulariesLink:function(){var t=this;var m=new sap.m.Link({text:this.oBundle.getText("more_link"),tooltip:this.oBundle.getText("more_link_tooltip"),enabled:true,press:function(e){t._setModal(true);t._dialogOpenedCallbackReference(true);var d=t.isDoAndAttrsPresent(t.VocabularyTerms);if(d||t.VocabularyTerms[0].isParentEntity){t.getDataObjectsDialog();}else{t.getAttributesDialog(t.dataObjectName);}}});return m;},isDoAndAttrsPresent:function(t){if(t){var d=false;var e=false;for(var f=0;f<t.length;f++){if(t[f].isParentEntity&&t[f].type!=="AO"){d=true;}else{e=true;}}return d&&e;}return false;},getDataObjectsDialog:function(){var t=this;var s=this.oBundle.getText("searchTextVocabulary");var d=this.getSearchField(s);this.detailedVocabularyList=this.initializeVocabularyList(this.VocabularyTerms);this.bindFilteredTermsToList(this.detailedVocabularyList,"DataObjects","",false);var v=new sap.ui.layout.VerticalLayout({content:[d,t.detailedVocabularyList]}).addStyleClass("sapAstVocabularyPanel");this.dataObjectsDialog=new sap.m.Dialog({title:this.oBundle.getText("selectVocabularyTitle"),contentWidth:"500px",contentHeight:"500px",showHeader:true,content:[v],afterClose:function(){t._dialogOpenedCallbackReference(false);},buttons:[new sap.m.Button({text:this.oBundle.getText("cancelBtn"),tooltip:this.oBundle.getText("cancelBtn"),press:function(e){t._setModal(false);t.dataObjectsDialog.close();}})]});t.dataObjectsDialog.open();},getAttributesDialog:function(d){var t=this;var s=this.getAttributesSegmentedButtons();var e=this.oBundle.getText("searchTextAttr");if(this.AttributeSegmentSelected){e=this.oBundle.getText("searchTextAttr");}if(this.AssociationSegmentSelected){e=this.oBundle.getText("searchTextAssoc");}var f=this.getSearchField(e);this.detailedVocabularyList=this.initializeVocabularyList(this.VocabularyTerms);this.bindFilteredAttributesAndAssociationsToList(this.detailedVocabularyList,"Attributes","E",false);var v=new sap.ui.layout.VerticalLayout({content:[s,f,t.detailedVocabularyList]}).addStyleClass("sapAstVocabularyPanel");t.attributesDialog=new sap.m.Dialog({title:this.oBundle.getText("selectAttrAssocTitle"),contentWidth:"500px",contentHeight:"500px",showHeader:true,content:[v],afterClose:function(){t._dialogOpenedCallbackReference(false);},buttons:[new sap.m.Button({text:this.oBundle.getText("cancelBtn"),tooltip:this.oBundle.getText("cancelBtn"),press:function(g){t._setModal(false);t.attributesDialog.close();}})]});t.attributesDialog.open();},getAttributesSegmentedButtons:function(){var t=this;var d=new sap.m.SegmentedButton({items:[new sap.m.SegmentedButtonItem({text:this.oBundle.getText("attributes"),width:"230px",press:function(){t._setModal(false);t.AttributeSegmentSelected=true;t.AssociationSegmentSelected=false;t.searchField.setValue("");t.searchField.setPlaceholder(t.oBundle.getText("searchTextAttr"));t.bindFilteredAttributesAndAssociationsToList(t.detailedVocabularyList,"Attributes","E",false);}}),new sap.m.SegmentedButtonItem({text:this.oBundle.getText("associations"),width:"230px",press:function(){t._setModal(false);t.AttributeSegmentSelected=false;t.AssociationSegmentSelected=true;t.searchField.setValue("");t.searchField.setPlaceholder(t.oBundle.getText("searchTextAssoc"));t.bindFilteredAttributesAndAssociationsToList(t.detailedVocabularyList,"Association","AO",false);}})]});return d;},bindFilteredTermsToList:function(o,d,s,r){var m=new sap.ui.model.json.JSONModel(this.VocabularyTerms);for(var e in m.oData){if(m.oData[e].type==="T"){m.oData[e].displayType="Table";}else if(m.oData[e].type==="S"){m.oData[e].displayType="Structure";}else if(m.oData[e].type==="E"){if(m.oData[e].isParentEntity){m.oData[e].displayType="Element";}else{var f="Attribute";m.oData[e].displayType=m.oData[e].bussinessDataType?f+" ("+m.oData[e].bussinessDataType+")":f;}}else if(m.oData[e].type==="AO"){m.oData[e].displayType="Association";}else if(m.oData[e].ResultDataObjectId&&!m.oData[e].type){m.oData[e].displayType="Rule";}else{m.oData[e].displayType=m.oData[e].type;}}var t=this;var g="/";if(!o){o=new sap.m.List({});}o.setModel(m);o.bindItems({path:g,sorter:new sap.ui.model.Sorter("type"),template:new sap.m.DisplayListItem({label:"{label}",value:"{displayType}",type:"Active",customData:[new b({Type:"sap.ui.core.CustomData",key:"id",value:"{id}"})],press:function(E){t._setModal(false);if(t.dataObjectsDialog.isOpen()){t.dataObjectsDialog.close();}else{t.attributesDialog.close()}t._reference(E);}}),rememberSelections:false,mode:a.SingleSelectMaster});if(r){var h=[];var j="label";h.push(new sap.ui.model.Filter(j,sap.ui.model.FilterOperator.Contains,s));o.getBinding("items").filter(h);o.getModel().refresh(true);}},bindFilteredAttributesAndAssociationsToList:function(o,d,s,r){var m=new sap.ui.model.json.JSONModel(this.VocabularyTerms);var t=this;var e="/";if(!o){o=new sap.m.List({});}if(m&&m.oData){for(var f in m.oData){if(m.oData[f].type==="E"){var g="Attribute";m.oData[f].displayType=m.oData[f].bussinessDataType?g+" ("+m.oData[f].bussinessDataType+")":g;}}}o.setModel(m);o.bindItems({path:e,sorter:new sap.ui.model.Sorter("label"),template:new sap.m.DisplayListItem({label:"{label}",value:"{displayType}",type:"Active",press:function(E){t._setModal(false);t.attributesDialog.close();t._reference(E);}}),rememberSelections:false,mode:a.SingleSelectMaster});if(r){o.getBinding("items").filter(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("type",sap.ui.model.FilterOperator.Contains,d),new sap.ui.model.Filter("label",sap.ui.model.FilterOperator.Contains,s),],and:true}));}else{var h=[];var j="type";h.push(new sap.ui.model.Filter(j,sap.ui.model.FilterOperator.Contains,s));o.getBinding("items").filter(h);o.getModel().refresh(true);}},getDataObjectFilter:function(){if(this.AttributeSegmentSelected){return new sap.ui.model.Filter("DataObjectId",sap.ui.model.FilterOperator.Contains,this.dataObjectId)}if(this.AssociationSegmentSelected){return new sap.ui.model.Filter("SourceDataObjectId",sap.ui.model.FilterOperator.Contains,this.dataObjectId)}},getSearchFilters:function(s){return new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("name",sap.ui.model.FilterOperator.Contains,s),new sap.ui.model.Filter("label",sap.ui.model.FilterOperator.Contains,s)],and:false});},getSearchField:function(p){var t=this;this.searchField=new sap.m.SearchField({showSearchButton:false,width:"462px",placeholder:p,liveChange:function(e){if(t.dataObjectsDialog){t.searchTheValueInDataObjects(e.getParameter("newValue"),s);}else{var s="Attributes";if(t.AttributeSegmentSelected){s="Attributes";}if(t.AssociationSegmentSelected){s="Association";}t.searchValueInAttributesAndAssociation(e.getParameter("newValue"),s);}}});return this.searchField;},searchTheValueInDataObjects:function(s,d){this.bindFilteredTermsToList(this.detailedVocabularyList,d,s,true);},searchValueInAttributesAndAssociation:function(s,d){if(this.AttributeSegmentSelected){d="E";}if(this.AssociationSegmentSelected){d="AO";}this.bindFilteredAttributesAndAssociationsToList(this.detailedVocabularyList,d,s,true);},initializeVocabularyList:function(v){var m=new sap.ui.model.json.JSONModel(v);var d="/";var e=new sap.m.List({headerText:this.oBundle.getText("vocabulary")});e.setModel(m);e.bindItems({path:d,sorter:new sap.ui.model.Sorter("label"),template:new sap.m.DisplayListItem({label:"{label}",value:"{type}",type:"Active",customData:[new b({Type:"sap.ui.core.CustomData",key:"id",value:"{id}"})]})});return e;}});return c;},true);
