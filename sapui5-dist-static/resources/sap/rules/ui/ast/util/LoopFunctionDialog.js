sap.ui.define(["sap/ui/core/Control","sap/m/List","sap/ui/model/json/JSONModel","sap/rules/ui/ast/constants/Constants","sap/rules/ui/ast/provider/TermsProvider"],function(C,L,J,a,T){"use strict";var b;var c=function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.functionLabelDisplay="";this.functionLabel="";this._loopFunctionSelected="";this._whereExpressionId="";this.dataObjectId="";this.dataObjectLabel="";this.dataObjectIdSelected="";this.selectedData=[{operationSelected:"",preSuggestionContext:"",cancelButton:false,addButton:true}];this.enabledData={enabled:false};this.dataObjectIdData={dataObjectId:""};};c.prototype._filterloopFunctionVocabulary=function(t){var v=[];var d=T.getInstance();if(t&&t.length>0){for(var i=0;i<t.length;i++){var r=t[i].ResultDataObjectId;if(t[i].type&&t[i].type==="T"){v.push(t[i]);}else if(r){var e=d.getTermByTermId(r);if(e&&e.getDataObjectType()===a.Table){v.push(t[i]);}}}return{terms:v};}};c.prototype._createLoopFunctionDropDown=function(l,A){var t=this;var m=new sap.ui.model.json.JSONModel(l);this.functionLoop=new sap.m.Select({width:"200px",selectedKey:this._loopFunctionSelected,forceSelection:false,showSecondaryValues:true,layoutData:new sap.ui.layout.GridData({span:"L3 M3 S3"}),ariaLabelledBy:A,change:function(e){t._loopFunctionSelected=e.getSource().getSelectedItem().getText();if(t.dataObjectId&&t._loopFunctionSelected){t.functionLabelDisplay=t._loopFunctionSelected+'('+t.dataObjectLabel+')';t.functionLabel=t._loopFunctionSelected+'('+t.dataObjectId+')';t.functionLabelField.setValue(t.functionLabelDisplay);if((t.oModel.getData().selectionData[0].operationSelected!==""&&t._loopFunctionSelected===a.FOREACH)){t.applyButton.setEnabled(true);}else{t.applyButton.setEnabled(false);}t.astExpressionBasicForWhere.setEditable(true);}else{t.applyButton.setEnabled(false);t.astExpressionBasicForWhere.setEditable(false);t.astExpressionBasicForWhere.setValue("");t.functionLabelField.setValue("");}}.bind(this)}).addStyleClass("sapAstExpressionDialogField");this.functionLoop.setModel(m);this.functionLoop.bindItems({path:"/loop",template:new sap.ui.core.ListItem({text:"{name}",key:"{name}",additionalText:"{label}"})});return this.functionLoop;};c.prototype._getOperationAstExpressionBasic=function(d,A){var t=this;this.astExpressionBasicForOperation=new sap.rules.ui.AstExpressionBasic({astExpressionLanguage:this._oAstExpressionLanguage,value:"{operationSelected}",conditionContext:false,operationsContext:true,editable:true,placeholder:this.oBundle.getText("expressionPlaceHolder"),ariaLabelledBy:A,dataObjectInfo:"{preSuggestionContext}",change:function(e){var s=parseInt(e.getSource().getBindingContext().sPath.split("/")[2]);t._expressionForOperationInput=e.getParameter("newValue");var f=t.oModel.getData().selectionData;if(t._expressionForOperationInput){f[s].operationSelected=t._expressionForOperationInput.trim();}if((t.oModel.getData().selectionData[0].operationSelected!==""&&t._loopFunctionSelected===a.FOREACH)){t.applyButton.setEnabled(true);}else{t.applyButton.setEnabled(false);}t._setPreSuggestionContextChange(s);}.bind(this)});this.astExpressionBasicForOperation.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForOperation;};c.prototype._tableColumnsFactory=function(i,o){var t=this;var d=new sap.m.ColumnListItem({cells:[t._getOperationAstExpressionBasic("loopOperationsLabelId"),new sap.ui.layout.HorizontalLayout({content:[new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("sys-cancel"),visible:"{cancelButton}",enabled:"{/enabledData/enabled}",press:function(e){var s=e.getSource().getIdForLabel().split("-")[2];t._removeColumnFromJsonModel(parseInt(s));}.bind(this)}),new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("add"),visible:"{addButton}",enabled:"{/enabledData/enabled}",press:function(e){var s=e.getSource().getIdForLabel().split("-")[2];t._addColumnToJsonModel(parseInt(s));}.bind(this)})]})]});return d;};c.prototype._addColumnToJsonModel=function(s){var n={operationSelected:"",preSuggestionContext:"",cancelButton:true,addButton:true,};this.selectedData.splice(s+1,0,n);if(this.selectedData.length>1){this.selectedData[0].cancelButton=true;}this._setPreSuggestionContext();this.oModel.setData({selectionData:this.selectedData,enabledData:this.enabledData,dataObjectIdData:this.dataObjectIdData});};c.prototype._setPreSuggestionContext=function(){for(var i=1;i<this.selectedData.length;i++){for(var j=0;j<i;j++){this.selectedData[i].preSuggestionContext=this.selectedData[j].preSuggestionContext+this.selectedData[j].operationSelected+",";}}};c.prototype._setPreSuggestionContextChange=function(s){if(s>=0&&s<this.selectedData.length-1){for(var j=s;j<this.selectedData.length-1;j++){this.selectedData[j+1].preSuggestionContext=this.selectedData[j].preSuggestionContext+this.selectedData[j].operationSelected+",";}}};c.prototype._removeColumnFromJsonModel=function(s){this.selectedData.splice(s,1);if(this.selectedData.length===1){this.selectedData[0].cancelButton=false;}if(s!==1){this._setPreSuggestionContext();}this.oModel.setData({selectionData:this.selectedData,enabledData:this.enabledData,dataObjectIdData:this.dataObjectIdData});};c.prototype._getSuggestionsForTheGivenInput=function(i){var t=this._oAstExpressionLanguage.getTokensForGivenStringInput(i);var u=this._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(t);var s={};s.AttributeContext=true;s.OperationsContext=false;var d=this._oAstExpressionLanguage.getSuggesstions(u,s);return d;};c.prototype._createVocabularyDropDown=function(A){var t=this;var d=this._getSuggestionsForTheGivenInput("");var v=this._filterloopFunctionVocabulary(d.autoComplete.categories.terms);var m=new sap.ui.model.json.JSONModel(v);this.vocabularySelect=new sap.m.Select({width:"100%",selectedKey:this.dataObjectIdSelected,forceSelection:false,ariaLabelledBy:A,change:function(E){t.dataObjectIdSelected=E.getSource().getSelectedItem().getKey();t.dataObjectId="/"+E.getSource().getSelectedItem().getKey();t.dataObjectLabel=E.getSource().getSelectedItem().getText();if(t.dataObjectId){t.oModel.getData().dataObjectIdData.dataObjectId=t.dataObjectId;t.oModel.getData().enabledData.enabled=true;}this.selectedData=[{operationSelected:"",preSuggestionContext:"",cancelButton:false,addButton:true}];t.selectedData[0].preSuggestionContext=this._loopFunctionSelected+"("+t.dataObjectId+",";t._bindOperations();var s=t._setDataObjectInfoForWhereConditionAutoSuggestion();t.astExpressionBasicForWhere.setDataObjectInfo(s);if(t.dataObjectId&&t._loopFunctionSelected){t.functionLabelDisplay=t._loopFunctionSelected+'('+t.dataObjectLabel+')';t.functionLabel=t._loopFunctionSelected+'('+t.dataObjectId+')';t.functionLabelField.setValue(t.functionLabelDisplay);if((t.oModel.getData().selectionData[0].operationSelected!==""&&t._loopFunctionSelected===a.FOREACH)){t.applyButton.setEnabled(true);}else{t.applyButton.setEnabled(false);}t.astExpressionBasicForWhere.setValue("");t._whereExpressionId="";t.astExpressionBasicForWhere.setEditable(true);}else{t.applyButton.setEnabled(false);t.astExpressionBasicForWhere.setEditable(false);t.astExpressionBasicForWhere.setValue("");t.functionLabelField.setValue("");}}.bind(this)}).addStyleClass("sapAstExpressionDialogField");this.vocabularySelect.setModel(m);this.vocabularySelect.bindItems({path:"/terms",template:new sap.ui.core.ListItem({text:"{label}",key:"{id}"})});var e=d.autoComplete.categories.vocabularyRules;for(var f in e){var i=new sap.ui.core.ListItem({text:e[f].label,key:e[f].id});this.vocabularySelect.addItem(i);}return this.vocabularySelect;};c.prototype._bindOperations=function(){this.oModel=new sap.ui.model.json.JSONModel();this.oModel.setData({selectionData:this.selectedData,enabledData:this.enabledData,dataObjectIdData:this.dataObjectIdData});this.conditionsTable.setModel(this.oModel);};c.prototype._createWhereAstExpressionBasic=function(A){var t=this;this.astExpressionBasicForWhere=new sap.rules.ui.AstExpressionBasic({astExpressionLanguage:this._oAstExpressionLanguage,enableAggregateFunctionWhereClause:true,value:this._whereExpressionId,editable:"{/value}",dataObjectInfo:this._setDataObjectInfoForWhereConditionAutoSuggestion(),ariaLabelledBy:A,change:function(e){t._whereExpressionId=e.getParameter("newValue");if(t.selectedData.length===1&&t._whereExpressionId){t.selectedData[0].preSuggestionContext=t._loopFunctionSelected+"("+a.FILTER+"("+t.dataObjectId+","+t._whereExpressionId+") ,";}else if(t.selectedData.length===1&&!t._whereExpressionId){t.selectedData[0].preSuggestionContext=t._loopFunctionSelected+"("+t.dataObjectId+",";}else if(t.selectedData.length>1&&t._whereExpressionId){t.selectedData[0].preSuggestionContext=t._loopFunctionSelected+"("+a.FILTER+"("+t.dataObjectId+","+t._whereExpressionId+") ,";t._setPreSuggestionContextChange(0);}else if(t.selectedData.length>1&&!t._whereExpressionId){t.selectedData[0].preSuggestionContext=t._loopFunctionSelected+"("+t.dataObjectId+",";t._setPreSuggestionContextChange(0);}t._bindOperations();}.bind(this)});this.astExpressionBasicForWhere.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForWhere;};c.prototype._setDataObjectInfoForWhereConditionAutoSuggestion=function(){if(this.dataObjectId){var d=this.dataObjectId;return this._loopFunctionSelected+"("+a.FILTER+"("+d+",";}};c.prototype._createFunctionLabel=function(){this.functionLabelField=new sap.m.TextArea({value:this.functionLabelDisplay,enabled:false,width:"100%"}).addStyleClass("sapAstExpressionDialogTextField");return this.functionLabelField;};c.prototype._clearData=function(){this.functionLabelDisplay="";this.functionLabel="";this._loopFunctionSelected="";this._whereExpressionId="";this.dataObjectId="";this.dataObjectLabel="";this.dataObjectIdSelected="";this.operationsPreExpression="";this.selectedData=[{operationSelected:"",preSuggestionContext:"",cancelButton:false,addButton:true}];this.enabledData={enabled:false};this.dataObjectIdData={dataObjectId:""};};c.prototype._createTable=function(){var t=this;this.conditionsTable=new sap.m.Table({backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.None,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new sap.m.Column({width:"89%"}).setStyleClass("sapAstOperationColumn"),new sap.m.Column({width:"11%"})]}).addStyleClass("sapAstOperationTable");this._bindOperations();var i=t._tableColumnsFactory();this.conditionsTable.bindItems("/selectionData",i);return this.conditionsTable;};c.prototype._convertFunctionLabelToText=function(d,f){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var o=this.termsProvider.getTermNameFromASTNodeReference(d);f=f.replace(d,o);return f};c.prototype._createLoopFunctionDialog=function(d,e,A,f,j){var t=this;var s=0;this._clearData();this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this._oAstExpressionLanguage=A;this._loopFunctionSelected=a.FOREACH;if(j){this._loopFunctionSelected=j.function;this._whereExpressionId=j.filter;this.dataObjectId=j.dataObject;this.functionLabel=j.functionLabel;this.dataObjectIdSelected=j.dataObject.replace("/","");this.operationArray=j.actions;t.functionLabelDisplay=this._convertFunctionLabelToText(j.dataObject,j.functionLabel);;if(this.dataObjectId){this.dataObjectIdData.dataObjectId=this.dataObjectId;this.enabledData.enabled=true;this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;this.dataObjectLabel=this.termsProvider.getTermNameFromASTNodeReference(this.dataObjectId);}if(this.operationArray&&this.operationArray.length>0){this.selectedData=[];for(var i=0;i<this.operationArray.length;i++){var n={operationSelected:"",preSuggestionContext:"",cancelButton:true,addButton:true,};n.operationSelected=this.operationArray[i];this.selectedData.push(n);s++;}if(s===1){this.selectedData[0].cancelButton=false;}if(!this._whereExpressionId){t.selectedData[0].preSuggestionContext=this._loopFunctionSelected+"("+this.dataObjectId+",";}else{t.selectedData[0].preSuggestionContext=this._loopFunctionSelected+"("+a.FILTER+"("+this.dataObjectId+","+t._whereExpressionId+") ,";}t._setPreSuggestionContextChange(0);}}var g=t._createLoopFunctionDropDown(d,"LoopFuntionLabelId");var v=new sap.m.Text({text:t.oBundle.getText("vocabulary"),tooltip:t.oBundle.getText("vocabulary"),textAlign:"End",layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"})});var o=t._createTable();var w=t._createWhereAstExpressionBasic("loopWhereLabelId");var F=t._createFunctionLabel();var h=new sap.ui.layout.form.SimpleForm({layout:sap.ui.layout.form.SimpleFormLayout.ResponsiveGridLayout,editable:true,content:[new sap.m.Label("loopFunctionSelectionLabelId",{text:t.oBundle.getText("function"),tooltip:t.oBundle.getText("function"),labelFor:g.getId()}),g,v,t._createVocabularyDropDown(v.getId()),new sap.m.Label("loopWhereLabelId",{text:t.oBundle.getText("where"),tooltip:t.oBundle.getText("where"),labelFor:w.getId()}),w,new sap.m.Label("loopOperationsLabelId",{text:"",tooltip:"",labelFor:o.getId()}).addStyleClass(""),o,new sap.m.Label({text:t.oBundle.getText("function_label"),tooltip:t.oBundle.getText("function_label"),labelFor:F.getId()}),F]});var l=new sap.m.Dialog({title:this.oBundle.getText("loopFunctionTitle"),contentWidth:"800px",showHeader:true,draggable:true,beforeClose:function(){f(false);},content:[h],buttons:[this.applyButton=new sap.m.Button({text:this.oBundle.getText("apply"),tooltip:this.oBundle.getText("applyChangesBtnTooltip"),press:function(k){var m=t._createJson();k.getSource().mProperties={value:t.functionLabel,jsonData:m};e(k);t._setModal(false);l.close();l.destroy();}}),new sap.m.Button({text:this.oBundle.getText("cancel"),tooltip:this.oBundle.getText("cancelBtnTooltip"),press:function(k){t._setModal(false);l.close();l.destroy();}})]}).addStyleClass("sapUiSizeCompact");;t._setModal(true);l.open();};c.prototype._setModal=function(v){var p=sap.ui.getCore().byId("popover");if(p){p.setModal(v);}};c.prototype._getOperations=function(){var d=[];for(var i=0;i<this.oModel.getData().selectionData.length;i++){if(this.oModel.getData().selectionData[i].operationSelected!==""){d.push(this.oModel.getData().selectionData[i].operationSelected);}}return d;};c.prototype._createJson=function(){var d=this._getOperations();var w=this._whereExpressionId;var j={"function":this._loopFunctionSelected,"filter":w,"functionLabel":this.functionLabel,"dataObject":this.dataObjectId,"actions":d,"doVocabId":this.dataObjectId};return j;};c.prototype.includes=function(p,s){var r=false;if(p.indexOf(s)!==-1){r=true;}return r;};return{getInstance:function(){b=new c();return b;}};},true);
