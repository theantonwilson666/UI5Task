sap.ui.define(["sap/ui/core/Control","sap/ui/core/Item","sap/ui/core/ValueState","sap/m/Select","sap/m/Input","sap/m/Button","sap/m/SelectDialog","sap/m/StandardListItem","sap/m/Text","sap/m/DatePicker","sap/ui/model/type/Float","sap/ui/model/type/Date","sap/ui/model/type/Time","sap/ui/model/type/DateTime","sap/ui/core/HTML","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","./Utils","sap/m/DateTimePicker","sap/m/TimePicker","sap/rules/ui/providers/ValueHelpProvider","sap/rules/ui/providers/ValueHelpDialogProvider","sap/ui/core/LocaleData","sap/rules/ui/Constants"],function(C,a,V,S,I,B,b,c,T,D,d,f,g,h,H,J,F,j,U,k,l,m,n,L,o){"use strict";return C.extend("sap.rules.ui.InstructionRenderer",{metadata:{properties:{instructions:{type:"any"}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:true,visibility:"hidden"}},events:{"change":{}},publicMethods:["getTokensAndTexts","getExpression"]},init:function(){this.INTERNAL_MODEL="internal";this.TOKEN="token";this.TEXT="text";this.MODEL_INSTRUCTIONS="/instructions";this.LINE_GAP_CLASS="sapUiSmallMarginTop";this.TOKENS_GAP_CLASS="sapUiTinyMarginEnd";var e="'";var O="'";this.VALIDATION_REGEX="^["+O+"][^"+e+"]*["+O+"]$"+"|"+"^[^"+e+"]*$";this.lineBreakIndexes={start:{},end:{}};this._internalModel=new J({instructions:[]});this._internalModel.setSizeLimit(300);this.setModel(this._internalModel,this.INTERNAL_MODEL);},setInstructions:function(i){this.setProperty("instructions",i);this.destroyAggregation("_content");if(!i||!i.length){i=[];}this.getModel(this.INTERNAL_MODEL).setProperty(this.MODEL_INSTRUCTIONS,i);},setUseIndent:function(u){this.setProperty("useIndent",u,true);this.destroyAggregation("_content");},onBeforeRendering:function(){var e=this.getAggregation("_content");if(!e){var p=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);if(!p){return;}try{var q=this._createControls(p);for(var i=0,r=q.length;i<r;++i){this.addAggregation("_content",q[i],true);}}catch(s){console.error(s);}}},renderer:function(r,e){r.write("<div class='sapUiSizeCompact' ");r.writeControlData(e);r.write(">");var p=e.getAggregation("_content");if(p){if(e._getIndent()){r.write(e._getTableStart());}for(var i=0,q=p.length;i<q;++i){var s=e.lineBreakIndexes.start[i];var t=e.lineBreakIndexes.end[i];if(s&&e._getIndent()){r.write(e._getLogicalOperatorStart());}r.renderControl(p[i]);if(t&&e._getIndent()){r.write(e._getLogicalOperatorEnd());}}if(e._getIndent()){r.write(e._getTableEnd());}}r.write("</div>");},getTokensAndTexts:function(){var t=[];var e=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);for(var i=0,p=e.length;i<p;++i){var q=e[i];var r={text:q[this.TEXT],token:q[this.TOKEN]};t.push(r);}return t;},getExpression:function(){var e=[];var p=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);for(var i=0,q=p.length;i<q;++i){var r=p[i];var t=r[this.TOKEN];e.push(t);}var s=p[p.length-1].token;if(!s&&s!==0){e.pop(p.length-1);}return e.join(" ");},_onChange:function(e){var i=e.getSource().data("instructionNum");this.fireEvent("change",{instructionNum:i});},_createControls:function(e){this.lineBreakIndexes={start:{},end:{}};var p=[];var q=[];var i,r;var s;var t;var u;for(i=0,r=e.length;i<r;++i){s=e[i];t=this._getCreateFunction(s);if(t===null){var v=" ";this._showErrorMessage(v);q=[];break;}q.push(t);}for(i=0,r=q.length;i<r;++i){s=e[i];t=q[i];u=q[i+1];var w=this.MODEL_INSTRUCTIONS+"/"+i+"/";var x=this.INTERNAL_MODEL+">"+w;var y=t.apply(this,[s,u,w,x]);var z=y.controls;y.controls.forEach(function(A){A.data({instructionNum:i});if(A.attachChange){A.attachChange(this._onChange.bind(this));}}.bind(this));if(y.needLineBreak){this.lineBreakIndexes.start[p.length]=true;this.lineBreakIndexes.end[p.length+z.length-1]=true;}p.push.apply(p,z);}return p;},_getCreateFunction:function(i){var e=null;if(i.valueListObject){e=this._createValueListControl;return e;}else if(i.visible===false){e=this._createHiddenControl;}else if(i.type&&i.type==="action"){e=this._createAddRepetitiveControl;}else if(i.tokenType=="ConjunctionOperator"&&!i.editable){e=this._createNonEditableLogicalOperator;}else if(i.tokenType=="ConjunctionOperator"&&i.editable){e=this._createEditableLogicalOperator;}else if(i.editable===false){e=this._createTextControl;}else if(i.businessDataType==="Number"){e=this._createNumberControl;}else if(i.businessDataType==="Date"){e=this._createDateControl;}else if(i.businessDataType==="Time"){e=this._createTimeControl;}else if(i.businessDataType==="Timestamp"){e=this._createDateTimeControl;}else if(i.businessDataType==="TimeSpan"){e=this._createNumberControl;}else if(i.businessDataType==="String"){e=this._createGeneralInputControl;}else if(i.businessDataType==="Boolean"){e=this._createBooleanSelectionControl;}else if(i.valueOptions&&i.valueOptions.type==="Set"){e=this._createSelectionControl;}return e;},_createHiddenControl:function(i,e,p,q){return[];},_createValueListControl:function(i,e,p,q){var t=this;this.valueHelpCtrl=new I({showValueHelp:true,id:"valueHelpCtrl",valueHelpRequest:function(){if(t.valueHelpCtrl.oValueHelpDialogProvider){t.valueHelpCtrl.oValueHelpDialogProvider._onInitialise();}else{n._createCpValueHelp(i,0,false,false);}},value:{path:q+this.TEXT},change:function(r){var s=r.getSource().getParent();s._syncToken(p);},width:"auto"});var v=i.valueListAnnotation;if(v){this.valueHelpCtrl.oValueHelpDialogProvider=new m({annotation:v.primaryValueListAnnotation,additionalAnnotations:v.additionalAnnotations,control:this.valueHelpCtrl,model:i.valueListObject.model,preventInitialDataFetchInValueHelpDialog:false,supportMultiSelect:false,supportRanges:false,takeOverInputValue:false,fieldName:v.primaryValueListAnnotation.valueListTitle,title:v.primaryValueListAnnotation.valueListTitle,cursorPosition:0,bReplaceWord:false,businessDataType:"string",bAddSpace:false});var P=this.getParent().getParent();if(P instanceof sap.m.Popover){this.valueHelpCtrl.oValueHelpDialogProvider._popover=P;}}this.valueHelpCtrl.addStyleClass(this.TOKENS_GAP_CLASS);return{controls:[this.valueHelpCtrl],needLineBreak:false};},_createSelectionControl:function(i,e,p,q){var P=this.getParent();var r=new S({items:{path:q+"valueOptions/values",template:new a({key:"{"+this.INTERNAL_MODEL+">"+this.TOKEN+"}",text:"{"+this.INTERNAL_MODEL+">"+this.TEXT+"}"})},forceSelection:false,selectedKey:"{"+q+this.TOKEN+"}",width:"auto",change:function(s){},enabled:(P.bReadOnly&&P instanceof sap.rules.ui.DecisionTableCellExpressionBasic)?false:true});r.addStyleClass(this.TOKENS_GAP_CLASS);return{controls:[r],needLineBreak:false};},_createAddRepetitiveControl:function(i,e,p,q){var r=[];var s=new B({text:"",press:i.callback});s.setIcon("sap-icon://add");r.push(s);return{controls:r,needLineBreak:false};},_createTextControl:function(i,e,p,q){var r=[];var s=new T({text:"{"+q+this.TEXT+"}",width:"auto"}).addStyleClass("sapUiTinyMarginTop").addStyleClass("sapRULExpressionBasic");r.push(s);return{controls:r,needLineBreak:false};},_createNumberControl:function(i,e,p,q){var v=this._createValueRange(i);var r=new I({width:"auto",type:"Text",value:{path:q+this.TOKEN,type:new d({minIntegerDigits:0,minFractionDigits:0},v)},valueStateText:this._getValueStateText(v),change:function(s){}});r.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(r);return{controls:[r],needLineBreak:false};},_createDateControl:function(i,e,p,q){var v=this._createValueRange(i);this._removeTextSingleQuote(p);var r=new D({width:"auto",type:"Date",value:{path:q+this.TEXT},valueStateText:this._getValueStateText(v),change:function(s){var P=s.getSource().getParent();P._syncToken(p);}});r.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(r);return{controls:[r],needLineBreak:false};},_createTimeControl:function(i,e,p,q){var v=this._createValueRange(i);this._removeTextSingleQuote(p);var r=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var s=L.getInstance(r);var t=s.getTimePattern('medium');var u=new l({width:"auto",type:"Time",value:{path:q+this.TEXT},valueStateText:this._getValueStateText(v),change:function(w){var P=w.getSource().getParent();P._syncToken(p);},valueFormat:t});u.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(u);return{controls:[u],needLineBreak:false};},_createDateTimeControl:function(i,e,p,q){var v=this._createValueRange(i);this._removeTextSingleQuote(p);var r=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var s=L.getInstance(r);var t=s.getDatePattern('short');var u=s.getTimePattern('medium');var w=t+" "+u;var x=new k({width:"auto",value:{path:q+this.TEXT},valueStateText:this._getValueStateText(v),change:function(y){var P=y.getSource().getParent();P._syncToken(p);},valueFormat:w});x.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(x);return{controls:[x],needLineBreak:false};},_createGeneralInputControl:function(i,e,p,q){this._removeTextSingleQuote(p);var r=new I({value:{path:q+this.TEXT,type:new sap.ui.model.type.String(null,{search:this.VALIDATION_REGEX})},width:"auto",change:function(s){var t=s.getSource();var v=t.getValue();t.setValue(v.replace(/\'/g,""));var P=s.getSource().getParent();P._syncToken(p);}});r.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(r);return{controls:[r],needLineBreak:false};},_createBooleanSelectionControl:function(i,e,p,q){var r=new sap.m.Select({selectedKey:"{"+q+this.TOKEN+"}",width:"auto",items:[{text:"true",key:"true"},{text:"false",key:"false"}],forceSelection:false});r.addStyleClass(this.TOKENS_GAP_CLASS);return{controls:[r],needLineBreak:false};},_createNonEditableLogicalOperator:function(i,e,p,q){var r=this._createLineBreak();var s=[];var t=new H({content:"<B class='sapMText sapUiTinyMarginTop sapUiTinyMarginEnd'>"+i[this.TEXT]+"</B>"});if(!this._getIndent()){s.push(r);}s.push(t);return{controls:s,needLineBreak:true};},_createEditableLogicalOperator:function(i,e,p,q){var r=this._createLineBreak();var s=[];var t=new S({items:{path:q+"valueOptions/values",template:new a({key:"{"+this.INTERNAL_MODEL+">"+this.TOKEN+"}",text:"{"+this.INTERNAL_MODEL+">"+this.TEXT+"}"})},selectedKey:"{"+q+this.TOKEN+"}",width:"auto",change:function(u){}});t.addStyleClass(this.TOKENS_GAP_CLASS);if(!this._getIndent()){s.push(r);}s.push(t);return{controls:s,needLineBreak:true};},_createSpace:function(){var e=new H({content:'<span>&nbsp;</span>'});return e;},_createLineBreak:function(){var e=new H({content:'<DIV class="'+this.LINE_GAP_CLASS+'"></DIV>'});return e;},_getTableStart:function(){return'<table><td></td><td style="vertical-align:top;">';},_getTableEnd:function(){return'</td></tr></table>';},_getLogicalOperatorStart:function(){return'<div class="'+this.LINE_GAP_CLASS+'"></td></tr><tr><td style="vertical-align:top;">';},_getLogicalOperatorEnd:function(){return'</td><td style="vertical-align:top;">';},_getIndent:function(){var i;try{i=this.getProperty("useIndent");}catch(e){i=false;}return i;},_createValueRange:function(i){var r=null;if(i.valueOptions&&i.valueOptions.type==="Range"){r={};var e=i.valueOptions;if(e.from){r.minimum=e.from;}if(e.to){r.maximum=e.to;}}return r;},_getValueStateText:function(v){var t;if(!v){return t;}if(v.minimum!==undefined&&v.maximum!==undefined){t="";}else if(v.minimum!==undefined){t="";}else if(v.maximum!==undefined){t="";}else{t="";}return t;},_attachValidationHandlers:function(i){i.attachParseError(function(e){e.getParameter("element").setValueState("Error");e.getParameter("element").setValueStateText(e.getParameter("message"));});i.attachValidationSuccess(function(e){e.getParameter("element").setValueState("None");});},_showErrorMessage:function(e){jQuery.sap.require("sap.m.MessageBox");sap.m.MessageBox.alert(e,{icon:sap.m.MessageBox.Icon.ERROR});},_removeTextSingleQuote:function(e){var i=this._internalModel;var v=i.getProperty(e+this.TEXT);i.setProperty(e+this.TEXT,v.replace(/\'/g,""));},_syncToken:function(e){var i=this._internalModel,p=false,q=false;var r="";var s="";if(i){r=i.getProperty(e+this.TEXT);if(i.oData&&i.oData.instructions){var t=i.oData.instructions;for(var u in t){s=t[u].businessDataType;}}}var v=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var w=L.getInstance(v);this.oFormatDate=sap.ui.core.format.DateFormat.getInstance({pattern:w.getDatePattern('short'),calendarType:sap.ui.core.CalendarType.Gregorian},v);if(s===o.STRING||s===o.DATE_BUSINESS_TYPE||s===o.TIMESTAMP_BUSINESS_TYPE||s==="Time"){if(s===o.DATE_BUSINESS_TYPE){r=this.oFormatDate.format(this.oFormatDate.parse(r));}r=r.toString();if(r==="'"){p=true;}if(r.substr(0,"'")!=="'"){p=true;}if(r.substr(r.length-1,"'")!=="'"){q=true;}if(p){r="'"+r;}if(q){r=r+"'";}}if(s===o.NUMBER){r=parseInt(r);}i.setProperty(e+this.TOKEN,r);}});});
