/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/rules/ui/Utils","sap/rules/ui/AstExpressionBasic","sap/rules/ui/Constants"],function(q,l,U,A,C){"use strict";var D=A.extend("sap.rules.ui.DecisionTableCellAstExpressionBasic",{metadata:{library:"sap.rules.ui",properties:{headerValue:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperator:{type:"string",defaultValue:"",bindable:"bindable"},type:{type:"sap.rules.ui.ExpressionType",defaultValue:sap.rules.ui.ExpressionType.BooleanEnhanced,bindable:"bindable"}}}});D.prototype.validateExpression=function(){var e=this.getValue();if(e){var v=this.getHeaderValue()+" "+this.getFixedOperator()+" "+e;}else{this.setValueStateText("");}};D.prototype.init=function(){sap.rules.ui.AstExpressionBasic.prototype.init.apply(this,arguments);this.bFlagForChangeBeforeBlur=false;this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");};D.prototype.onAfterRendering=function(){var t=this;this._oAstExpressionLanguage=sap.ui.getCore().byId(this.getAstExpressionLanguage());sap.rules.ui.AstExpressionBasic.prototype.onAfterRendering.apply(this,arguments);this.oDecisionTableCell=(this.getParent()&&this.getParent().getParent())?this.getParent().getParent():null;this._handleValidation();if(q.sap.byId(this.getId()).closest('td').next().width()){this._showPopUp();}if(this.oDecisionTableCell){this.markerString=this.oDecisionTableCell._getMarkerString().trim();var v=this.oDecisionTableCell.getValueStatePath();var d=this.oDecisionTableCell.getModel("dtModel");var o=this.oDecisionTableCell.getAggregation("_displayedControl");if(o){d.setProperty(v.slice(8),sap.ui.core.ValueState.None);}}};D.prototype._handleValidation=function(){this.validateExpression();};D.prototype.exit=function(){this._handleValidation();if(this.bFocusCellAfterEscape&&this.oDecisionTableCell){var h=this.oDecisionTableCell.getDomRef().parentElement.parentElement;if(h){q(h).focus();}}};D.prototype.createEventListeners=function(){};D.prototype._updateModelAstNodes=function(m,c){if(this.oDecisionTableCell){var a=c.ASTNodes;for(var n in a){var u={};if(a[n].Root){u.Sequence=1;u.Root=true;}else{u.Sequence=a[n].SequenceNumber;u.ParentId=a[n].ParentId;}if(a[n].Function){u.Function=a[n].Function?a[n].Function:"";}if(a[n].Type==="I"){u.IncompleteExpression=a[n].Value;}if(a[n].Type!=="P"&&a[n].Type!=="O"&&!a[n].Function){u.BusinessDataType=a[n].Output?a[n].Output.BusinessDataType:a[n].BusinessDataType;u.DataObjectType=a[n].Output?a[n].Output.DataObjectType:a[n].DataObjectType;u.Value=a[n].Value?a[n].Value:"";}else if(a[n].Type==="O"){u.Reference=a[n].Reference;}u.NodeId=a[n].Id;u.Type=a[n].Type;u.RuleId=c.RuleId;u.Version=c.Version;u.ColId=c.ColId;u.RowId=c.RowId;var p={};p.properties=u;p.groupId="changes";m.createEntry("/DecisionTableRowCellASTs",p);}}};D.prototype._removeExistingAstNodes=function(m,c,p,a){if(this.oDecisionTableCell){var P={};P.ColId=c.ColId;P.RowId=c.RowId;P.RuleId=c.RuleId;P.Version=c.Version;var k;var b=[];var s;if(a&&a.length>0){for(var i=0;i<a.length;i++){k={};k.ColId=c.ColId;k.RowId=c.RowId;k.RuleId=c.RuleId;k.Version=c.Version;k.NodeId=a[i].Id;s=m.createKey("DecisionTableRowCellASTs",k);b.push(s);}}if(p&&m.getProperty(p)&&"DecisionTableRowCellASTs"in m.getProperty(p)&&m.getProperty(p).DecisionTableRowCellASTs&&"__list"in m.getProperty(p).DecisionTableRowCellASTs){m.getProperty(p).DecisionTableRowCellASTs.__list=b;}m.callFunction("/DeleteDTRowCellASTDraft",{method:"POST",groupId:"changes",urlParameters:P});}};D.prototype._checkEmptyMarkerNode=function(a){if(a&&a.length===1&&((a[0].Type==="I"&&(a[0].Value===""||a[0].Value===this.markerString))||a[0].Type==="M")){return false;}return true;};D.prototype._removeAndUpdateExisitingNodes=function(m,d,p,a,c){m.setDeferredGroups(["changes"]);var e=sap.ui.getCore().getEventBus();m.update(p,{"Content":m.getProperty(c)},{groupId:"changes",success:function(d){e.publish("sap.ui.rules","astCreated");}});this._removeExistingAstNodes(m,d,p,a);if(this._checkEmptyMarkerNode(a)){this._updateModelAstNodes(m,d);}m.submitChanges({groupId:"changes"});};D.prototype._changeValue=function(e){var d={};if(this.oDecisionTableCell){var s=e.getSource();var E=sap.ui.getCore().getEventBus();var v=e.getParameter("newValue");s.setValue(v);var a=this.oDecisionTableCell.getAggregation("_displayedControl");a.setValue(e.getParameter("displayText"));a.JSON=this.getJsonData();a.relString=this.relString;var o=sap.ui.getCore().byId(this.getAstExpressionLanguage());var m=this.getBindingContext().getModel();d=this.oDecisionTableCell.getKeyProperties();var b=e.getParameter("astNodes");if(b&&b.length===1&&b[0].Type==="I"&&b[0].Value!==""&&b[0].Value!==this.markerString){a.setValueState("Error");a.setTooltip(this.oBundle.getText("invalidExpression"));}else{a.setValueState("None");}d.ASTNodes=b;var c=this.oDecisionTableCell.getValuePath();var p="/"+c.split("/")[1];E.publish("sap.ui.rules","astCreating");if(!m.hasPendingChanges()){this._removeAndUpdateExisitingNodes(m,d,p,b,c);}}};return D;},true);
