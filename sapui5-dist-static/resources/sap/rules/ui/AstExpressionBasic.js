sap.ui.define(["sap/base/Log","sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","sap/m/ResponsivePopover","sap/m/List","sap/ui/model/json/JSONModel","sap/m/ListMode","sap/m/PlacementType","sap/m/StandardListItem","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/rules/ui/parser/infrastructure/util/utilsBase","sap/rules/ui/services/AstExpressionLanguage","sap/rules/ui/ExpressionAdvanced","sap/rules/ui/AutoCompleteSuggestionContent","sap/rules/ui/ExpressionBase","sap/rules/ui/ast/constants/Constants","sap/rules/ui/ast/util/AggregateFunctionDialog","sap/rules/ui/ast/util/SelectFunctionDialog","sap/rules/ui/ast/provider/TermsProvider","sap/rules/ui/ast/parser/bundlelibrary","sap/ui/core/LocaleData","sap/rules/ui/ast/util/LoopFunctionDialog"],function(L,q,l,C,R,a,J,b,P,S,c,d,f,A,E,g,h,j,k,m,T,n,o,p){"use strict";var r=h.extend("sap.rules.ui.AstExpressionBasic",{metadata:{properties:{library:"sap.rules.ui",value:{type:"string",defaultValue:""},dataObjectInfo:{type:"string",bindable:"bindable",defaultValue:""},resultDataObjectId:{type:"string",defaultValue:""},conditionContext:{type:"boolean",defaultValue:false},operationsContext:{type:"boolean",defaultValue:false},jsonData:{type:"array",bindable:"bindable",defaultValue:[]},enableAggregateFunctionVocabulary:{type:"boolean",defaultValue:false},enableAggregateFunctionWhereClause:{type:"boolean",defaultValue:false},isAttributeContext:{type:"boolean",defaultValue:false},placeholder:{type:"string",defaultValue:""},isAssociationContext:{type:"boolean",defaultValue:false},enableAggregateFunctionAttribute:{type:"boolean",defaultValue:false}},aggregations:{},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},ariaHasPopup:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaHasPopup"}},events:{"change":{},"liveChange":{}}},init:function(){this.infraUtils=new sap.rules.ui.parser.infrastructure.util.utilsBase.lib.utilsBaseLib();this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.aggregateFunctionCallBack=q.proxy(this._updateAggregateFunction,this);this.functionCallBack=q.proxy(this._updateSelectFunction,this);this.loopFunctionCallBack=q.proxy(this._updateLoopFunction,this);this._reference=q.proxy(this.callback,this);this._isDialogOpenedCallbackReference=q.proxy(this.isDialogOpenedCallback,this);this._uiModel=[];this._cursorPostion=0;this._selectedSpans=null;this._hasTextContent=false;this._createPopver();this._attributeContext=false;this._bCtrlSpacePressed=false;this.bShiftPressed=false;this.shiftKey="";this.isDialogOpen=false;this._focusedOut=false;this._jsonArray=[];this.functionClicked=false;this.isAutoSuggestionRequired=true;this.isDotRequired=true;this.aggregateFunctionDialog=k.getInstance();this.selectFunctionDialog=m.getInstance();this.loopFunctionDialog=p.getInstance();this.astLibInstance=n.getInstance();this.bTypingFlow=false;this.bEditInBetween=false;this.nIndexOfToken=0;this.tempRelString="";this.filterText="";this.filterTextLength=0;var e=sap.ui.getCore().getEventBus();e.subscribeOnce("sap.ui.rules","_onHiddenSelected",this._hiddenAccessModeSelected,this);},onBeforeRendering:function(){this._enableAggregateFunctionVocabulary=this.getEnableAggregateFunctionVocabulary();this._enableAggregateFunctionWhereClause=this.getEnableAggregateFunctionWhereClause();this._ariaLabelledById=this.getAriaLabelledBy();this._enableAggregateFunctionAttribute=this.getEnableAggregateFunctionAttribute();},callback:function(e,i){this._setTextOnCursorPosition(e);},isDialogOpenedCallback:function(i){this.isDialogOpen=i;if(!i){this.functionClicked=false;}},onAfterRendering:function(){this.referenceId="";this.isAutoSuggestionRequired=true;this.dotInOperationsContext=false;this._oAstExpressionLanguage=sap.ui.getCore().byId(this.getAstExpressionLanguage());this._input=this.$("input");this._validateControl();this._input[0].contentEditable=this.getEditable();this._input[0].classList.add("sapAstExpressionInput");if(!this.getEditable()){this._input[0].classList.add("sapAstExpressionInputNotEditable");}else{this._input[0].classList.remove("sapAstExpressionInputNotEditable");}if(this.aCustomStyleClasses&&this.aCustomStyleClasses.length>0){this._input[0].classList.add(this.aCustomStyleClasses[0]);}if(this.getJsonData()){this._jsonArray=this.getJsonData();}if(this.getValue()&&this.getValue().trim()){var e=this.markerString?this.markerString.trim():"";if(e===this.getValue()){this.setValue("");}this._uiModel=this._convertInputToUiModel(this.getValue());this._uiModelToSpan(this._uiModel);this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1]);if(!this.bTypingFlow&&this._selectedSpans[0]&&!this._selectedSpans[0].textContent.endsWith(j.DOT)&&this._selectedSpans[0].getAttribute(j.TOKEN_TYPE)!==j.WS&&this._selectedSpans[0].getAttribute(j.TOKEN_TYPE)!==j.UNDEFINED&&!this.dotInOperationsContext&&!(this._enableAggregateFunctionVocabulary&&this._jsonArray.length===0)&&!this._isFirstTokenUpdateOrAppendOperation()){this._createSpaceSpanItem();}this.bTypingFlow=false;if(!this.dataObjectInfo&&this.getIsAttributeContext()){this.dataObjectInfo=this.getDataObjectInfo()+(this.relString?this.relString.replace(".",""):"");}if(!this.dataObjectInfo){this.dataObjectInfo=this.getDataObjectInfo()+this.relString;}this._hasTextContent=true;}else{this.relString="";this._uiModel=[];this._uiModelToSpan(this._uiModel);this.dataObjectInfo="";}this._cursorPostion=this._getCaretPosition();this._setCurrentCursorPosition(this._cursorPostion);this._setUpEventHandlers();if(this._ariaLabelledById){this._input[0].setAttribute("aria-labelledby",this._ariaLabelledById+" "+this._input[0].id);}this._input[0].setAttribute("aria-haspopup","list");this._input[0].setAttribute("aria-label",this._input[0].textContent);},_convertInputToUiModel:function(i){if(i){this.astNodesString=this._oAstExpressionLanguage.getAstNodesString(i);this.relString=this._oAstExpressionLanguage.getRelStringForGivenAstString(this.astNodesString).relString;this._tokens=this._oAstExpressionLanguage.getTokensForGivenStringInput(i);try{this.astresponseNodes=JSON.parse(this.astNodesString);}catch(e){L.error("Error in parsing string to JSON: "+e.message);}if(this.astresponseNodes&&this.astresponseNodes[0]&&(this.astresponseNodes[0].Function||(this.astresponseNodes[0].Type&&this.astresponseNodes[0].Type!=="I"))){this.displayString=this._oAstExpressionLanguage._astBunldeInstance.ASTUtil.toAstExpressionString(astNodes);this._jsonArray=this.displayString.JSON;}return this._oAstExpressionLanguage.convertTokensToUiModel(this._tokens,this._jsonArray);}return[];},_generateIDStringFromUIModel:function(){var i="";for(var t in this._uiModel){if(this._uiModel[t].reference!==null){if(this._uiModel[t].text.length>0){i=i+this._uiModel[t].reference;}}else{i=i+this._uiModel[t].text;}}return i;},_getSuggestionsForTheGivenInput:function(i){var _=this._attributeContext;var e=false;var s=false;var t=this.getIsAssociationContext();if(this.getDataObjectInfo()&&!this.functionClicked&&!this.bEditInBetween){i=this.dataObjectInfo;}if(this.getHeaderInfo()&&this.getHeaderInfo().headerValue){i=this.getHeaderInfo().headerValue+" "+i;}if(this.getAttributeInfo()&&i===""){i=this.getAttributeInfo()+" "+j.EQUAL+" ";}if(!this._oAstExpressionLanguage){this._oAstExpressionLanguage=sap.ui.getCore().byId(this.getAstExpressionLanguage());}if(this.getDataObjectInfo()&&this.getIsAttributeContext()){_=this.getIsAttributeContext();i=i.replace(/\./g,"");}if(this._enableAggregateFunctionVocabulary){_=false;t=true;}if(this.getOperationsContext()&&!this._enableAggregateFunctionVocabulary){e=true;}if(this.getOperationsContext()&&i!==""){if(this.dotInOperationsContext&&this._selectedSpans[0]&&this._selectedSpans[0].textContent.endsWith(j.DOT)){_=true;}else if(this._isFirstTokenUpdateOrAppendOperation()&&this._selectedSpans[0].textContent===" "+j.DOT){_=true;i=i.trim();}else if(!_){_=false;s=this._addDotToMiscellaneousSuggestions();}}var u=this._oAstExpressionLanguage.getTokensForGivenStringInput(i);var v=this._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(u);var w={};w.AttributeContext=_;w.OperationsContext=e;w.AssociationContext=t;var x=this._filterSuggestionBasedOnCardinality(v,w);if(s){var y={name:j.DOT,label:this.oBundle.getText("DOTLABEL")};x.autoComplete.categories.operators=x.autoComplete.categories.operators?x.autoComplete.categories.operators:{};var z=x.autoComplete.categories.operators;if(!("miscellaneous"in z)){z.miscellaneous=[];}z.miscellaneous.push(y);}x.autoComplete.businessDataTypeList=x.businessDataTypeList;if(this._enableAggregateFunctionVocabulary&&x&&x.autoComplete&&x.autoComplete.categories&&x.autoComplete.categories.terms&&x.autoComplete.categories.terms.length===0){this._oAutoSuggestionPopUp.close();}return x;},_filterSuggestionBasedOnCardinality:function(u,s){var e=this._oAstExpressionLanguage.getSuggesstions(u,s);if((this._enableAggregateFunctionAttribute||this._enableAggregateFunctionWhereClause)&&e&&e.autoComplete&&e.autoComplete.categories&&e.autoComplete.categories.terms){for(var i=0;i<e.autoComplete.categories.terms.length;i++){if(e.autoComplete.categories.terms[i].cardinality&&e.autoComplete.categories.terms[i].cardinality===j.ONE_TO_N){e.autoComplete.categories.terms.splice(i,1);}}}return e;},_getSuggestionsForEditedInput:function(F){this.tempRelString=this._cursorPostion===0?"":this._calculateStringAndIndexOfNewToken();if(this._enableAggregateFunctionWhereClause){this.tempRelString=this.getDataObjectInfo()+this.tempRelString;}var t=this._oAstExpressionLanguage.getTokensForGivenStringInput(this.tempRelString);var e=this._getStringForFilterAndTempRelString(t);this._suggestionsList=this._getSuggestionsForTheGivenInput(e.tempRelString);if(F){var s=e.filterText;var i=this._filterSuggestionList(s);if(i.hasSuggestions){this._suggestionsList=i;}}if(!F&&e.filterText){var u=this._getTermIdForTheGivenText(e.filterText);var v=e.tempRelString+u;this._suggestionsList=this._getSuggestionsForTheGivenInput(v);}},_addDotToMiscellaneousSuggestions:function(){if(this.relString&&this.relString.trim().toUpperCase().indexOf(j.UPDATE)===0){var u=this._uiModel.length;var e=this._uiModel[u-1];if(this.bEditInBetween&&this.nIndexOfToken){e=this._uiModel[this.nIndexOfToken];}var i=e.dataObjectType;var s=e.getReference();var t=s?s.split("/"):[];if(!s){return false;}if(i===j.ASSOCIATIONDOTYPE){return true;}else if(t&&t.length>2){return false;}else{s=t[1];s=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(s);if(s&&s._isDataObjectElement){return false;}else{return true;}}}return false;},_constructExpandedRelString:function(e){var i="";if(e.function===j.AVG||e.function===j.SUM||e.function===j.MIN||e.function===j.MAX){i=(typeof e.vocabulary==="string"||e.vocabulary instanceof String)?e.attribute:this._fetchAttributesSelectFunction(e);return e.function+"("+this.getTable(e)+","+i+this.getGroupByAttributes(e.groupBy)+")";}else if(e.function===j.COUNTDISTINCT||e.function===j.DISTINCT){i=(typeof e.vocabulary==="string"||e.vocabulary instanceof String)?e.attribute:this._fetchAttributesSelectFunction(e);return e.function+"("+this.getTable(e)+","+i+")";}else if(e.function===j.COUNT){return e.function+"("+this.getTable(e)+this.getGroupByAttributes(e.groupBy)+")";}else if(e.function===j.TOP||e.function===j.BOTTOM||e.function===j.SELECT||e.function===j.FIRST){return this._constructExpandedRelStringForSelect(e);}else if(e.function===j.FOREACH){return e.function+"("+this.getTable(e)+" , "+this._fetchForEachOperations(e.actions)+")";}},_fetchForEachOperations:function(O){var s="";for(var i=0;i<O.length-1;i++){if(O[i]!==""){s=s+O[i]+" , ";}}s=s+O[i];return s;},_fetchAttributesSelectFunction:function(e){if(this._hasAssociationId(e.vocabulary,e.function)){return this._returnAttributeBasedOnCardinality(e.vocabulary)}else if(e.vocabulary.attributes&&Object.keys(e.vocabulary.attributes).length===1){for(var i in e.vocabulary.attributes){return i;}}},_getAttributesSelectQuery:function(e){var s=",";var i="";if(e&&!q.isEmptyObject(e.attributes)){for(var t in e.attributes){i+=s+t;}}return i;},_constructSelectQuery:function(e){var i="";if(e.doVocabId){i=e.doVocabId;}else{i=e.dataObject;}if(this._getAttributesSelectQuery(e)){return j.SELECT+"("+this._constructSortQuery(e)+this._getAttributesSelectQuery(e)+")";}else if(e.filter){return j.FILTER+"("+i+","+e.filter+")"}else{return i;}},_constructSortQuery:function(e){var i="";var s="";if(e.doVocabId){s=e.doVocabId;}else{s=e.dataObject;}if(!e.filter){i=s;}else{i=j.FILTER+"("+s+","+e.filter+")";}if(!q.isEmptyObject(e.attributes)){for(var t in e.attributes){if(e.attributes[t]!==j.NOSORT){i=e.attributes[t]+"("+i+","+t+")";}}}return i;},_constructExpandedRelStringForSelect:function(e){if(e.function===j.TOP||e.function===j.BOTTOM){return e.function+"("+this._constructSelectQuery(e)+","+e.count+")";}else if(e.function===j.SELECT){return this._constructSelectQuery(e);}else if(e.function===j.FIRST){return e.function+"("+this._constructSelectQuery(e)+")";}},getTable:function(e){var i=(typeof e.vocabulary==="string"||e.vocabulary instanceof String)?e.vocabulary:this._getDataObjectInfoBaseOnVocaulary(e);if(!e.filter&&(typeof e.vocabulary==="object"||e.vocabulary instanceof Object)){return this._constructExpandedRelStringForSelect(e.vocabulary);}else if(e.filter&&(typeof e.vocabulary==="object"||e.vocabulary instanceof Object)){return j.FILTER+"("+this._constructExpandedRelStringForSelect(e.vocabulary)+","+e.filter+")";}else if(!e.filter){return i;}else{return j.FILTER+"("+i+","+e.filter+")";}},_getDataObjectInfoBaseOnVocaulary:function(e){var i=e.dataObject;if(this._hasAssociationId(e.vocabulary,e.function)){i=this._returnDataObjectBasedOnCardinality(e.vocabulary);}return i;},_hasAssociationId:function(v,e){var i="";if((typeof v==="object"||v instanceof Object)){if(v&&v.attributes){for(var s in v.attributes){i=v.doVocabId+s.replace(j.DOT,"");break;}}}if(i){var t=i.split("/");var u=t[1];if(t.length>3){for(var w=2;w<t.length-1;w++){u+=j.DOT+t[w];}}if(this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(u)&&this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(u)._dataObjectType==="AO"){return true;}}return false;},_returnAttributeBasedOnCardinality:function(v){var e="";if((typeof v==="object"||v instanceof Object)){if(v&&v.attributes){for(var i in v.attributes){e=v.doVocabId+i.replace(j.DOT,"");break;}}}if(e){var s=e.split("/");var t=s[1];var u=0;var w;var x="";if(s.length>2){for(var y=2;y<s.length;y++){t+=j.DOT+s[y];w=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(t);if(w&&w._dataObjectType==="AO"&&w._cardinality==="1..n"){u=y;}}if(u>0){for(var y=u+1;y<s.length;y++){x+="/"+s[y];}}if(u===0){for(var y=2;y<s.length;y++){x+="/"+s[y];}}}if(x){return j.DOT+x;}else{return"./"+s[s.length-1];}}},_returnDataObjectBasedOnCardinality:function(v){var e="";if((typeof v==="object"||v instanceof Object)){if(v&&v.attributes){for(var i in v.attributes){e=v.doVocabId+i.replace(j.DOT,"");break;}}}else{e=v;}if(e){var s=e.split("/");var t=s[1];var u=0;var w;var x="";if(s.length>2){for(var y=2;y<s.length;y++){t+=j.DOT+s[y];w=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(t);if(w&&w._dataObjectType==="AO"&&w._cardinality==="1..n"){u=y;}}if(u>0){for(var y=1;y<=u;y++){x+="/"+s[y];}}}if(x){return x;}else{return"/"+s[1];}}},getGroupByAttributes:function(e){var s=",";var t="";if(e&&e.length>0){for(var i=0;i<e.length;i++){t+=(s+e[i]);}}return t;},_fetchAttributes:function(v){if(typeof v==="string"||v instanceof String){var s=v.split("/");var e="";if(s.length>3){for(var i=2;i<s.length;i++){e+="/"+s[i];}return j.DOT+e;}else{return"./"+s[2];}}else if(Object.keys(v.attributes).length===1){for(var t in v.attributes){return t;}}else{}},_createUUID:function(){return this.infraUtils.createUUID();},_createSpanItem:function(i){var e=this.getId();this.ruleWithElementDO=false;if(i.tokenType===j.TERM){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var t=i.reference.split("/")[1];var s=this.termsProvider.getTermByTermId(t);if(s&&s.Type==="Rule"&&s.ResultDataObjectId!==""&&s.ResultDataObjectId!==undefined){var u=this.termsProvider.getTermByTermId(s.ResultDataObjectId);if(u&&u.getIsDataObjectElement()){s=u;this.ruleWithElementDO=true;}}if(s&&i&&(s._isDataObjectElement||i.dataObjectType==="ruleWithElementDO")){t="/"+t;}else{t=i.reference;}var v=this.termsProvider.getTermNameFromASTNodeReference(t);if(v){if("dataObjectType"in i&&i.dataObjectType!=j.Element&&!this._enableAggregateFunctionVocabulary&&!this.ruleWithElementDO){i.text=v;if(this._addDotToReferenceText(i)){i.text=v+j.DOT;}}else if((i.resultDataObjectId!==""&&i.resultDataObjectId!==undefined&&!this.ruleWithElementDO)||(i.tokenType===j.TERM&&i.dataObjectType!=j.Element&&!this.ruleWithElementDO&&!this._enableAggregateFunctionVocabulary)){i.text=v;if(this._addDotToReferenceText(i)){i.text=v+j.DOT;}}else{i.text=v;}}}if(i.tokenType===j.FUNCTION&&i.json){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var v=this.termsProvider.getTermNameFromASTNodeReference(i.json.dataObject);i.text=i.text.replace(i.json.dataObject,v)}if(i.tokenType===j.DATEBUSINESSDATATYPE||i.tokenType===j.TIMEBUSINESSDATATYPE){var w=this._getDateTimeFormatter(i.tokenType);var x=i.text.replace(/\'/g,"");var D=w.format(w.parse(x));if(D!==""){i.text="'"+D+"'";}}var y=i.id.replace("/","");var N=q('<span>',{id:e+"-"+y,class:i.cssClass,reference:i.reference,resultDataObjectId:i.resultDataObjectId,json:JSON.stringify(i.json),tokenType:i.tokenType})["text"](i.text);return N;},_getDateTimeFormatter:function(t){var e=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var i=o.getInstance(e);if(t===j.DATEBUSINESSDATATYPE){var s=i.getDatePattern('medium');var u=sap.ui.core.format.DateFormat.getDateInstance({pattern:s});return u;}else if(t===j.TIMEBUSINESSDATATYPE){var s=i.getDatePattern('medium');var v=i.getTimePattern('medium');var w=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:s+" "+v});return w;}},_isFirstTokenUpdateOrAppendOperation:function(){var O=false;if(this.relString&&(this.relString.trim().toUpperCase().indexOf(j.UPDATE)===0||this.relString.trim().toUpperCase().indexOf(j.APPEND)===0)){O=true;}return O;},_addDotToReferenceText:function(i){if(this._uiModel&&this.nIndexOfToken&&this._uiModel[this.nIndexOfToken]&&i&&'startIndex'in i&&this._uiModel[this.nIndexOfToken].startIndex!==i.startIndex){return false;}var O=this._isFirstTokenUpdateOrAppendOperation()&&this.dotInOperationsContext;if(O||(!O&&this._attributeContext)||(!O&&i.dataObjectType==="AO")||(!this._isFirstTokenUpdateOrAppendOperation()&&(i.dataObjectType==="S"||i.dataObjectType==="T"))){this._attributeContext=true;return true;}return false;},_uiModelToSpan:function(u){var t="";var H="";for(var i=0;i<u.length;i++){H+=this._createSpanItem(u[i])[0].outerHTML;}this._input.html(H);return t;},_closeAutoSuggestionPopup:function(){if(this._oAutoSuggestionPopUp)this._oAutoSuggestionPopUp.close();},_setUpEventHandlers:function(){var t=this,i=q(this._input),s=[16,17,18,93,13,9,35,36,45,34,33,40,37,38,39,27,44,145,19,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135];if(!this._focusedOut){t._setCurrentCursorPosition(t._cursorPostion);}this._input.on('keydown',function(e){if(e.keyCode===8||e.keyCode==46){t._selectedSpans=t._getSelectedSpans();t._handleBackSpaceAndDeleteKey(e);}else if(e.keyCode===40||e.keyCode===38){t._handleArrowNavigation(e);}else if(e.key==="Control"){t.ctrlPressed=true;}else if(t.ctrlPressed&&(e.keyCode===32||e.key===" ")){t._initializeCursorSpan();t.ctrlPressed=false;t._bCtrlSpacePressed=true;if(!t.dataObjectInfo){t.dataObjectInfo=t.getDataObjectInfo();}if(!t.relString){t.relString="";}}else if(e.key==="Shift"){t.bShiftPressed=true;}else if(t.bShiftPressed&&s.indexOf(e.keyCode)===-1){t.shiftKey=e.key;t.bShiftPressed=false;}else if(e.key==="Tab"||e.keyCode===27){t._closeAutoSuggestionPopup();}else if(s.indexOf(e.keyCode)!==-1&&e.keyCode!==35&&e.keyCode!==36&&e.keyCode!==37&&e.keyCode!==39){e.preventDefault();}});this._input.on("click",function(u){t.ctrlPressed=false;t.forceFireChange=false;t._initializeCursorSpan();var v;if(!t.getEditable()){return;}if(t._selectedSpans&&t._selectedSpans[0]&&t._selectedSpans[0].getAttribute(j.JSON)){t.functionClicked=true;var _=t._getSuggestionsForTheGivenInput(t._contextForPerviousSpans(t._selectedSpans));t.isDialogOpen=true;try{v=JSON.parse(t._selectedSpans[0].getAttribute(j.JSON));if(v.function===j.FOREACH){t.loopFunctionDialog._createLoopFunctionDialog(_.autoComplete.categories.functions,t.loopFunctionCallBack,t._oAstExpressionLanguage,t._isDialogOpenedCallbackReference,v);}else if(v.function===j.TOP||v.function===j.BOTTOM||v.function===j.SELECT||v.function===j.FIRST){t.selectFunctionDialog._createSelectFunctionDialog(_.autoComplete.categories.functions,t.functionCallBack,t._oAstExpressionLanguage,t._isDialogOpenedCallbackReference,v);}else{v.selectExpression=typeof v.vocabulary==="object"||v.vocabulary instanceof Object?t._constructExpandedRelStringForSelect(v.vocabulary):"";t.aggregateFunctionDialog._createAggregationFunctionDialog(_.autoComplete.categories.functions,t.aggregateFunctionCallBack,t._oAstExpressionLanguage,t._isDialogOpenedCallbackReference,v);}}catch(e){L.error("Error in parsing string to JSON: "+e.message);}}t._closeAutoSuggestionPopup();});this._input.on('keyup',function(e){var u=q(this);var v=false;if(e.keyCode==8||e.keyCode==46){t._updateUiModel();t._calculateStringAndIndexOfNewToken();}t._initializeCursorSpan();if(!t.dataObjectInfo){t.dataObjectInfo=t.getDataObjectInfo();}if(e.key==="Control"||e.keyCode===35||e.keyCode===36||e.keyCode===37||e.keyCode===39||e.keyCode===20||e.keyCode===144){return;}if(t.bEditInBetween){t.bTypingFlow=!t._bCtrlSpacePressed;t._getSuggestionsForEditedInput(true);}if(t._bCtrlSpacePressed){if(!t.bEditInBetween){t._suggestionsList=t._getSuggestionsForTheGivenInput(t.relString);var w=t._input.children()[t._input.children().length-1];if(w){t._selectedSpans=[];t._selectedSpans.push(w);}}if((t._selectedSpans[0]&&t._selectedSpans[0].getAttribute(j.TOKEN_TYPE)===j.UNDEFINED&&t._selectedSpans[0].textContent.startsWith(j.SINGLE_QUOTE))||(t._selectedSpans[0].className==="sapAstLiteralClass")){t._suggestionsList.autoComplete.showLiteral=true;t._suggestionsList.autoComplete.literalInput=t._selectedSpans[0].textContent;if(t._selectedSpans[0]&&t._selectedSpans[0].getAttribute("reference")){t._suggestionsList.autoComplete.literalInput=t._selectedSpans[0].getAttribute("reference");}}t._showAutoSuggestion(t._suggestionsList);t._bCtrlSpacePressed=false;return;}var x=u.data('before');var y=this.textContent;if(y&&e.key!==" "){y=y.trim();}if(x){x=x.trim();}if(y!==x){t.bTypingFlow=true;if(((e.keyCode!==8&&e.keyCode!==46)&&s.indexOf(e.keyCode)===-1)||(e.key==="Shift"&&t.shiftKey!=="")){var z=e.key==="Shift"?t.shiftKey:e.key;t._updateUIModelForFreeFlow(z);if(z===" "&&((t._selectedSpans[0].className!=="sapAstLiteralClass"&&t._selectedSpans[0].className!=="sapAstAuxilaryNodeClass")||(t._selectedSpans[0].className==="sapAstLiteralClass"&&!(t.filterTextLength<t._selectedSpans[0].textContent.length)))){t.nIndexOfToken+=1;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:0});}v=true;t.shiftKey="";}t._handleKeyUpEvent(y,e,v);u.data('before',y);t._bCtrlSpacePressed=false;}});this._input.on('focusout',function(e){t._focusedOut=true;if(!t.isDialogOpen&&!t._oAutoSuggestionPopUp.isOpen()){t._validateControl();}t._handlePopupFocusOut(e);});this._input.on('focus',function(e){t._focusedOut=false;var u=q(this);u.data('before',u.context.textContent);});},_handleBackSpaceAndDeleteKey:function(e){var s=false;var t=this;if(e.keyCode==46){s=true;}t._calculateStringAndIndexOfNewToken();if(s&&t.bEditInBetween&&t._selectedSpans&&"className"in t._selectedSpans[0]&&(t._selectedSpans[0].className=="sapAstAuxilaryNodeClass"&&this._getFullTextContentLength()===this._cursorPostion)){var u=t._getSelectedSpanGivenIndex(this.nIndexOfToken+1);if(u&&u[0]&&u[0].className==="sapAstObjectClass"){t._selectedSpans=u;t._setCaretPosition({spanIndex:t.nIndexOfToken+1,position:0});t._calculateStringAndIndexOfNewToken();}}if(t._selectedSpans[0].className==="sapAstObjectClass"){var v=t._selectedSpans[0].textContent;var w=t._selectedSpans[0].getAttribute(j.REFERENCE).split("/");var x="";var y="";var z=v.split(j.DOT);var B="";var D="";var F;if((t.filterTextLength>0&&!s)||s){for(var i=1;i<w.length;i++){B=y;y+=z[i-1]+j.DOT;t._attributeContext=true;if(t.filterText.indexOf(y)>=0&&(!(t.filterText==y)||(s&&t.filterText==y))){x+="/"+w[i];continue;}else{break;}}var G=T.getInstance();D=x.replace(/\//,"");D=D.replace(/\//g,".");if(D){F=G.getTermByTermId(D);}if(F&&F._dataObjectType==="AO"){x=w[0]===j.DOT?j.DOT+x:x;this.isDotRequired=false;}else if(F&&(F._dataObjectType==="T"||F._dataObjectType==="S")){this.isDotRequired=false;}else{this.isDotRequired=true;}var H=t._cursorPostion>0?B.length:t._cursorPostion-t._selectedSpans[0].textContent.length-B.length;t._selectedSpans[0].textContent=B;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:H});t._selectedSpans[0].setAttribute(j.REFERENCE,x);e.preventDefault();if(x===""){t._removeSpans();t.nIndexOfToken=t.nIndexOfToken>0?t.nIndexOfToken-1:0;t._selectedSpans=t._getSelectedSpanGivenIndex(this.nIndexOfToken);var I=t._selectedSpans?t._selectedSpans[0].textContent.length:0;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:I});}}}else if(t._selectedSpans[0]&&t.filterTextLength!==0&&((t._selectedSpans[0].className==="sapAstFunctionClass"&&t._selectedSpans[0].getAttribute(j.JSON))||(t._selectedSpans[0].className==="sapAstLiteralClass"&&t._selectedSpans[0].textContent.startsWith("'")&&t.bEditInBetween&&t.filterTextLength===t._selectedSpans[0].textContent.length))){t._removeSpans();t.nIndexOfToken=t.nIndexOfToken>0?t.nIndexOfToken-1:0;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:t._cursorPostion});e.preventDefault();}else if(t._selectedSpans[0]&&t._selectedSpans[0].getAttribute("class")==="sapAstLiteralClass"&&(t._selectedSpans[0].getAttribute("tokentype")==="D"||t._selectedSpans[0].getAttribute("tokentype")==="T"||t._selectedSpans[0].getAttribute("tokentype")==="U")){t._removeSpans();t.nIndexOfToken=t.nIndexOfToken>0?t.nIndexOfToken-1:0;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:t._cursorPostion});}},_handlePopupFocusOut:function(e){var i=e.currentTarget.id;var s=e.relatedTarget;if(s&&i!==s.id&&!this._isAutoSuggestionPopover(s)){if(this._oAutoSuggestionPopUp.isOpen()){this._closeAutoSuggestionPopup();}this._fireChange(this.textContent);}},_isAutoSuggestionPopover:function(e){var i=[];var I=false;while(e){if(e.id&&e.id.indexOf("autoCompletePopover")!==-1){I=true;break;}i.unshift(e);e=e.parentNode;}return I;},_initializeCursorSpan:function(){this._selectedSpans=this._getSelectedSpans();this._cursorPostion=this._getCaretPosition();if(this._cursorPostion===0){this.filterTextLength=0;}if(this._cursorPostion<this._input.text().length){this.bEditInBetween=true;this._calculateStringAndIndexOfNewToken();}else{this.bEditInBetween=false;this.filterTextLength=this._selectedSpans[0].textContent.length;this.nIndexOfToken=this._input.children().length-1;}},_handleArrowNavigation:function(e){e.preventDefault();this._bPopUpFocused=true;var s=this._oAutoSuggestionPopUp.getContent()[0];var i=s.getAggregation("mainLayout").getItems()[0];$(i).focus();},_handleKeyUpEvent:function(e,i,s){var t=this;var u;var v=this._oAstExpressionLanguage.getTokensForGivenStringInput(this._uiModeltoString());if(!this.bEditInBetween){u=this._getStringForFilterAndTempRelString(v);if(i.keyCode===8||i.keyCode===46){this.dataObjectInfo=this.getDataObjectInfo()+u.tempRelString;}}if(this._jsonArray.length>0){v=this._convertInputToUiModel(this.relString);}this._uiModel=t._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(v);this._uiModelToSpan(this._uiModel);this._uiModeltoString();this._getSelectedSpanFromIndex();if(!this._bCtrlSpacePressed&&s&&this.getDataObjectInfo()&&v[v.length-2].type!==this.astLibInstance.IDPParser.ALL_STRING){this.dataObjectInfo=this.getDataObjectInfo()+u.tempRelString;}var w=this.filterTextLength;if(this.bEditInBetween){if(i.keyCode===8||i.keyCode===46){w=this._cursorPostion===0&&this.nIndexOfToken===0&&this.filterTextLength>0?0:this.filterTextLength;}else if(!this._uiModel[this.nIndexOfToken].text.endsWith(i.key)&&(this._selectedSpans[0].className!=="sapAstLiteralClass")&&(this._selectedSpans[0].className!=="")){this.nIndexOfToken+=1;w=1;}else if(i.key==="'"){w=1;}this._getSelectedSpanFromIndex();if(i.key!=="'"&&this._selectedSpans[0]&&"className"in this._selectedSpans[0]&&this._selectedSpans[0].className==="sapAstLiteralClass"){w=this.filterTextLength;}}else{this.nIndexOfToken=this._input.children().length-1;w=this._cursorPostion;}var x=this._selectedSpans?this._selectedSpans[0]:null;if(this.bEditInBetween&&i.key==="'"&&x&&x.nextSibling&&'getAttribute'in x.nextSibling&&(x.nextSibling.getAttribute("tokenType")==='U'||x.nextSibling.getAttribute("tokenType")==='N')){this._setCaretPosition({spanIndex:this.nIndexOfToken+1,position:w-1,});}else if(this.bEditInBetween&&i.key==="'"&&x&&x.nextSibling&&'getAttribute'in x.nextSibling&&x.nextSibling.className==='sapAstLiteralClass'){this._setCaretPosition({spanIndex:this.nIndexOfToken+1,position:w,});}else{this._setCaretPosition({spanIndex:this.nIndexOfToken,position:w,keyCode:i.keyCode});}if(e!==""&&i.key!=='Backspace'){var y=i.key!==" ";if(!this.bEditInBetween){this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1]);this._suggestionsList=this._getSuggestionsForTheGivenInput(u.tempRelString);var z=u.filterText;var F=this._filterSuggestionList(z);if(F.hasSuggestions){this._suggestionsList=F;}if(!F.hasSuggestions&&u.filterText){var B=this._getTermIdForTheGivenText(u.filterText);if(B){var D=u.tempRelString+B;this._suggestionsList=this._getSuggestionsForTheGivenInput(D);}else{this._suggestionsList=F;}}if(!(i.keyCode===8||i.keyCode===46)){this._showAutoSuggestion(this._suggestionsList,y);}}if(this._selectedSpans[0]&&this._selectedSpans[0].className!==""&&this._selectedSpans[0].className!=="sapAstLiteralClass"||(this._selectedSpans[0]&&this._selectedSpans[0].getAttribute(j.TOKEN_TYPE)===j.UNDEFINED&&!t._selectedSpans[0].textContent.startsWith(j.SINGLE_QUOTE))){this._showAutoSuggestion(this._suggestionsList,y);}}else{this._closeAutoSuggestionPopup();}},_getTermIdForTheGivenText:function(t){var e=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var i=e.getTermByTermLabel(t);var s="";if(i){s="/"+i._termId;}else{var u=e.getTermByTermName(t);s=u?"/"+u._termId:"";}return s;},_setCaretPosition:function(e){var s=window.getSelection(),t=this.$("input"),u,v,I,F,w=0;var x=function(w){var y=t.children(),z,B,D=0;for(var i=0;i<y.length;i++){z=y[i];B=z.innerText||"";if(D+B.length>w){return{spanIndex:i,position:D+B.length-w};}D+=B.length;}return{spanIndex:Math.max(i-1,0),position:100};};if(typeof e==="number"){e=x(e);}I=e&&e.span;if(e){u=t[0];if(!I){I=u&&u.children&&u.children.length>e.spanIndex?u.childNodes[e.spanIndex]:null;}if(I){v=document.createRange();F=I.firstChild?I.firstChild:I;if(this.bEditInBetween&&this.bTypingFlow){if(e.spanIndex===0&&e.position===0){w=0;}else if(F&&F.length){w=Math.min(F.length,e.position);}}else if(F&&F.length){w=Math.min(F.length,e.position);}}if(!(typeof w==="number")||(F&&F.length&&w>F.length)||w<0){w=0;}if(F){v.setStart(F,w);v.collapse(true);s.removeAllRanges();s.addRange(v);}}},_getStringForFilterAndTempRelString:function(t){var s="";var i="";var e;var u;var v;var w;for(var x in t){e=t[x];w=t[x-1];u=e.type?e.type:e._type;v=w?(w.type?w.type:w._type):null;if(u===this.astLibInstance.IDPParser.EOF||u===this.astLibInstance.IDPParser.DOT){continue;}else if(u===this.astLibInstance.IDPParser.ALL_STRING||(v&&v===this.astLibInstance.IDPParser.ALL_STRING)){i+=e.text;}else{s+=e.text;}}return{tempRelString:s,filterText:i};},_isEmptySpace:function(s){return s===String.fromCharCode(160)||s===" ";},_bRequiredFilteredSuggestion:function(t){return!(this._isEmptySpace(t)||t===""||this._selectedSpans[0].className==="sapAstLiteralClass");},_updateUIModelForFreeFlow:function(s){var t=this;var e=this._selectedSpans[0];if(this._uiModel.length===0){var i={id:t._createUUID(),tokenType:j.UNDEFINED};if(e&&'textContent'in e){i['text']=e.textContent;}else{i['text']=s;}this._uiModel.push(i);this._uiModelToSpan(this._uiModel);}else if(e.className==="sapAstObjectClass"){if(s===j.DOT&&this.getOperationsContext()){this.dotInOperationsContext=true;this._attributeContext=true;}else{var u=e.getAttribute(j.REFERENCE);if(e.textContent.startsWith(s)&&this.bEditInBetween){e.setAttribute(j.REFERENCE,s+" "+u);this._cursorPosition+=1;}else if(e.textContent.endsWith(s)){e.setAttribute(j.REFERENCE,u+s);}}}else if(s===j.SINGLE_QUOTE&&this.bEditInBetween&&e&&e.className!='sapAstLiteralClass'){e.textContent=e.textContent.replace(j.SINGLE_QUOTE,j.SINGLE_QUOTE+j.SINGLE_QUOTE);}else if(this.bEditInBetween&&e.nextSibling&&e.nextSibling.className&&e.nextSibling.className==="sapAstFunctionClass"&&((e.className!=="sapAstLiteralClass"&&e.className!=="sapAstAuxilaryNodeClass")||(s!==" "&&e.className==="sapAstAuxilaryNodeClass"&&e.textContent.endsWith(event.key)))){e.textContent+=" ";}this._updateUiModel();},_filterSuggestionList:function(t){var e=false;var F={autoComplete:{categories:{functions:{},operators:{},terms:[]},showLiteral:this._suggestionsList.autoComplete.showLiteral,businessDataTypeList:this._suggestionsList.autoComplete.businessDataTypeList},businessDataTypeList:this._suggestionsList.autoComplete.businessDataTypeList};if(this._suggestionsList.autoComplete.valuehelp){F.autoComplete.valuehelp=this._suggestionsList.autoComplete.valuehelp;}var s=this._suggestionsList.autoComplete.categories;var u=function(z){var D=[];var B,G,N;for(var i=0;i<z.length;i++){B=(z[i].label).toLowerCase();N=(z[i].name).toLowerCase();G=t.toLowerCase();if(((" "+B).indexOf(" "+G)!==-1)||((" "+N).indexOf(" "+G)!==-1)){D.push(z[i]);e=true;}}return D;};var v=function(){if(s.terms){F.autoComplete.categories.terms=u(s.terms);}if(s.functions){var i=s.functions.advanced;if(i&&i.length>0){var z=u(i);if(z&&z.length>0){F.autoComplete.categories.functions.advanced=z;}}var B=s.functions.aggregate;if(B&&B.length>0){var z=u(B);if(z&&z.length>0){F.autoComplete.categories.functions.aggregate=z;}}var D=s.functions.selection;if(D&&D.length>0){var z=u(D);if(z&&z.length>0){F.autoComplete.categories.functions.selection=z;}}var G=s.functions.window;if(G&&G.length>0){var z=u(G);if(z&&z.length>0){F.autoComplete.categories.functions.window=z;}}var H=s.functions.time_duration;if(H&&H.length>0){var z=u(H);if(z&&z.length>0){F.autoComplete.categories.functions.time_duration=z;}}var I=s.functions.loop;if(I&&I.length>0){var z=u(I);if(z&&z.length>0){F.autoComplete.categories.functions.loop=z;}}var K=s.functions.operations;if(K&&K.length>0){var z=u(K);if(z&&z.length>0){F.autoComplete.categories.functions.operations=z;}}}if(s.operators){var M=s.operators.arithmetic;if(M&&M.length>0){var z=u(M);if(z&&z.length>0){F.autoComplete.categories.operators.arithmetic=z;}}var N=s.operators.comparision;if(N&&N.length>0){var z=u(N);if(z&&z.length>0){F.autoComplete.categories.operators.comparision=z;}}var O=s.operators.logical;if(O&&O.length>0){var z=u(O);if(z&&z.length>0){F.autoComplete.categories.operators.logical=z;}}var Q=s.operators.array;if(Q&&Q.length>0){var z=u(Q);if(z&&z.length>0){F.autoComplete.categories.operators.array=z;}}var U=s.operators.range;if(U&&U.length>0){var z=u(U);if(z&&z.length>0){F.autoComplete.categories.operators.range=z;}}var V=s.operators.miscellaneous;if(V&&V.length>0){var z=u(V);if(z&&z.length>0){F.autoComplete.categories.operators.miscellaneous=z;}}var W=s.operators.functional;if(W&&W.length>0){var z=u(W);if(z&&z.length>0){F.autoComplete.categories.operators.functional=z;}}}};if(s){v();}if(!e){var w;if(this.bEditInBetween){w=this._oAstExpressionLanguage.getTokensForGivenStringInput(this.tempRelString)}else{w=this._oAstExpressionLanguage.getTokensForGivenStringInput(this.relString);}var x=w.length-2;t=w[x].text;w=w.slice(0,x);var y=this._getStringForFilterAndTempRelString(w);s=this._getSuggestionsForTheGivenInput(y.tempRelString).autoComplete.categories;v();}F.hasSuggestions=e;return F;},_fireChange:function(t){if(this.isDialogOpen&&!this.forceFireChange){return;}var e="";if(!this.relString&&t){this.relString=t;}if(!this.relString){this.relString="";}if(this.markerString){this.markerRelString=this.markerString+this.relString;e=this._oAstExpressionLanguage.getAstNodesString(this.markerRelString);}else{e=this._oAstExpressionLanguage.getAstNodesString(this.relString);}this.astresponseNodes=JSON.parse(e);if(this._getValueAfterReplacingSpace(this.getValue())!==this._getValueAfterReplacingSpace(this.relString)){this.setValue(this.relString);this.setJsonData(this._jsonArray);this.fireChange({newValue:this.relString,astNodes:this.astresponseNodes,displayText:this._input[0].textContent.trim()});}},_getValueAfterReplacingSpace:function(v){if(v){return v.replace(/([^']+)|('(?:[^'\\]|\\.)+')/g,function(e,i,s){if(i){return i.replace(/\s/g,"");}else{return s;}});}return"";},_contextForPerviousSpans:function(s){var i="";var t;var u=this.getDomRef("input").children;for(var v=0;v<u.length;v++){var w=$("#"+u[v].id);if(u[v].id!==s[0].id){if(w[0].getAttribute(j.JSON)){try{t=JSON.parse(w[0].getAttribute(j.JSON));if(t.expandedText){i+=t.expandedText;}}catch(e){L.error("Error in parsing string to JSON: "+e.message);}}else if(w[0].getAttribute(j.REFERENCE)){i+=w[0].getAttribute(j.REFERENCE);}else{i+=w[0].textContent}}else{i+="";break;}}return i;},_updateSelectFunction:function(e){this.isDialogOpen=false;this._selectedSpans[0].setAttribute(j.JSON,JSON.stringify(e.getSource().mProperties.jsonData));this._selectedSpans[0].textContent=e.getSource().mProperties.value;this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._input.empty();this._uiModelToSpan(this._uiModel);this._setCurrentCursorPosition(this._cursorPostion);},_updateLoopFunction:function(e){this.isDialogOpen=false;this._selectedSpans[0].setAttribute(j.JSON,JSON.stringify(e.getSource().mProperties.jsonData));this._selectedSpans[0].textContent=e.getSource().mProperties.value;this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._input.empty();this._uiModelToSpan(this._uiModel);this._setCurrentCursorPosition(this._cursorPostion);},_updateAggregateFunction:function(e){this.isDialogOpen=false;this._selectedSpans[0].setAttribute(j.JSON,JSON.stringify(e.getSource().mProperties.jsonData));this._selectedSpans[0].textContent=e.getSource().mProperties.value;this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._input.empty();this._uiModelToSpan(this._uiModel);this._setCurrentCursorPosition(this._cursorPostion);},_getNewSpaceSpan:function(){var i={};i.id=this._createUUID();i.text=" ";i.tokenType=j.WS;i.cssClass="sapAstAuxilaryNodeClass";return this._createSpanItem(i);},_createSpaceSpanItem:function(){var e=this._getNewSpaceSpan();var s=this._selectedSpans[0]?this._selectedSpans[0].id:"";var i="#"+s;$(e[0]).insertAfter(i);this._updateUiModel();this._cursorPostion+=e[0].textContent.length;this._selectedSpans=$(e);this._uiModel=this._convertInputToUiModel(this.relString);this._hasTextContent=true;this.nIndexOfToken+=1;},_addSpace:function(){this._createSpaceSpanItem();if(this.bEditInBetween){this._getSuggestionsForEditedInput(false);}else{this._suggestionsList=this._getSuggestionsForTheGivenInput(this.relString);}this._setCaretPosition({spanIndex:this.nIndexOfToken,position:this._selectedSpans[0].textContent.length});this._showAutoSuggestion(this._suggestionsList);},_removeSpans:function(){var e=false;if(this._uiModel.length===0||this._input.children().length===0){return e;}this._prevNodeofRemovedNode=null;for(var i=0;i<this._selectedSpans.length;i++){this._prevNodeofRemovedNode=$("#"+this._selectedSpans[i].id).prev()[0];if(this._selectedSpans[i]instanceof HTMLSpanElement){if(this._selectedSpans[i].textContent){this._cursorPostion-=this._selectedSpans[i].textContent.length;}$(this._selectedSpans[i]).remove();e=true;}if("getAttribute"in this._selectedSpans[i]&&this._selectedSpans[i].getAttribute("class")==="sapAstObjectClass"){this._attributeContext=false;}}if(this.getDomRef("input")&&this.getDomRef("input").textContent&&!this.getDomRef("input").textContent.length>0){this._hasTextContent=false;}return e;},_showAutoSuggestion:function(s,e){var i=q(this._selectedSpans);var x=0;if(this._cursorPostion!==0){if(i&&i[0]instanceof HTMLPreElement){x=12;}else{if("position"in i&&i.position()){x=parseInt(i.position().left,10);}x+=parseInt(i.width(),10);}}var y=3;x+=10;var t=this;setTimeout(function(){if(t._oAutoSuggestionPopUp&&!t._oAutoSuggestionPopUp.isOpen()){t._oAutoSuggestionPopUp.destroyContent();t._oAutoSuggestionPopUp.addContent(new sap.rules.ui.AutoCompleteSuggestionContent({content:s.autoComplete,reference:t._reference,enableAggregateFunctionVocabulary:t._enableAggregateFunctionVocabulary,enableAggregateFunctionWhereClause:t._enableAggregateFunctionWhereClause,dialogOpenedCallbackReference:t._isDialogOpenedCallbackReference,vocabularyInfo:t._oAstExpressionLanguage,expand:e}));t._oAutoSuggestionPopUp.setOffsetX(x);t._oAutoSuggestionPopUp.setOffsetY(y);t._oAutoSuggestionPopUp.openBy(t.getDomRef("input"));}else{t._oAutoSuggestionPopUp.destroyContent();t._oAutoSuggestionPopUp.addContent(new sap.rules.ui.AutoCompleteSuggestionContent({content:s.autoComplete,reference:t._reference,enableAggregateFunctionVocabulary:t._enableAggregateFunctionVocabulary,enableAggregateFunctionWhereClause:t._enableAggregateFunctionWhereClause,dialogOpenedCallbackReference:t._isDialogOpenedCallbackReference,vocabularyInfo:t._oAstExpressionLanguage,expand:e}));t._oAutoSuggestionPopUp.setOffsetX(x);t._oAutoSuggestionPopUp.setOffsetY(y);}if(!t._oAutoSuggestionPopUp.isOpen()){t._oAutoSuggestionPopUp.setOffsetX(x);t._oAutoSuggestionPopUp.setOffsetY(y);t._oAutoSuggestionPopUp.openBy(t.getDomRef("input"));}},600);},_isLastTokenSpaceItem:function(){var i=true;var e=[];if(this.bEditInBetween&&this.tempRelString!=""&&this.nIndexOfToken>=0){e=this._uiModel[this.nIndexOfToken];if(this._attributeContext||(this._selectedSpans[0].textContent!==this.filterText)){return true;}}else if(this._uiModel&&this._uiModel.length>0){e=this._uiModel[this._uiModel.length-1];}if(e&&(e.tokenType===j.WS||e.tokenType===j.UNDEFINED)){return true;}if(e&&e.tokenType!==j.WS&&e.dataObjectType&&e.dataObjectType!=="S"&&e.dataObjectType!=="T"&&e.dataObjectType!=="AO"&&(e.tokenType===j.TERM&&!e.getText().endsWith(j.DOT))){i=false;}else if(e&&e.tokenType!==j.WS&&e.tokenType!==j.TERM&&e.reference===undefined){i=false;}else if(e&&e.tokenType!==j.WS&&this._isFirstTokenUpdateOrAppendOperation()&&!this._attributeContext){i=false;}else if(e&&(e.tokenType==="D"||e.tokenType==="T")&&this._uiModel[0]&&"getText"in this._uiModel[0]){i=false;}else if(e&&e.tokenType==="ID"&&!e.dataObjectType){var s=e.getReference()?e.getReference().split("/")[1]:"";if(T.getInstance().getTermByTermId(s).isResultDataObjectElement){i=false;}}return i;},_addItemToEmptyInput:function(e,i,s,t){if(t.resultDataObjectId&&t.resultDataObjectId!==""&&t.tokenType===j.TERM){this.ruleContext=true;}i=this._createSpanItem(t);this._uiModel.push(t);this._uiModeltoString();this._uiModel=this._convertInputToUiModel(this.relString);this._cursorPostion=t.text.length;this._uiModelToSpan(this._uiModel);this._selectedSpans=i;if(this.getIsAttributeContext()&&!this.isAssociation&&!t.json&&this._oAutoSuggestionPopUp&&this._oAutoSuggestionPopUp.isOpen){this.isAutoSuggestionRequired=false;this._oAutoSuggestionPopUp.close();}},_addAtBeginningForInBetween:function(e,s,i,t){$(e[0]).insertBefore(s);this._cursorPostion=t.text.length;this._selectedSpans=$(e);$(i[0]).insertBefore(s);t.bAddSpaceAutoMatically=false;if(!t.text.endsWith(j.DOT)){this._cursorPostion+=1;this._selectedSpans=$(i);this.nIndexOfToken+=1;}},_handleUndefinedForInBetween:function(e,i,s,t,u,v){if(e.textContent.startsWith(j.SINGLE_QUOTE)){this._selectedSpans[0].textContent+=i.text;this._cursorPostion+=i.text.length;}else{var w=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=i.text;this._cursorPostion+=i.text.length-w;this._replacePreviousUndefinedTokens();if(s&&s.getAttribute(j.TOKEN_TYPE)===j.TERM&&s.textContent.endsWith(j.DOT)){this.nIndexOfToken-=1;}}if(t&&t.getAttribute(j.TOKEN_TYPE)!==j.WS){$(u[0]).insertAfter(v);i.bAddSpaceAutoMatically=false;}if(i.reference){this._selectedSpans[0].setAttribute(j.REFERENCE,i.reference);}if(i.json){this._selectedSpans[0].setAttribute(j.JSON,JSON.stringify(i.json));}},_addInBetweenTermsForInBetween:function(e,i,s,t,u){if(this.filterText.indexOf(j.DOT)>-1){this._appendItemText(this.filterText,e,t);}else if(this.getOperationsContext()&&this.bEditInBetween&&e.getAttribute("tokentype")==="ID"&&e.textContent.endsWith(j.DOT)){this._appendItemText(e.textContent,e,t);}else{this._selectedSpans[0].textContent=t.text;this._selectedSpans[0].setAttribute("reference",t.reference);}this._cursorPostion=this._cursorPostion-this.filterText.length+this._selectedSpans[0].textContent.length;},_appendItemText:function(e,s,t){var u=e.split(j.DOT);var v=s.getAttribute("reference").split("/");var w="";var x="";for(var i=0;i<u.length-1;i++){x+=u[i]+j.DOT;w+="/"+v[i+1];}if(v[0]===j.DOT){w=j.DOT+w;}t.reference=t.reference.replace(".","");this._selectedSpans[0].textContent=x+t.text;this._selectedSpans[0].setAttribute("reference",w+t.reference);},_addItemInBetween:function(e,i,s,t,u){var v=i.previousSibling;var w=i.nextSibling;e=this._createSpanItem(t);var x=this._getNewSpaceSpan();if(this._cursorPostion===0&&this.nIndexOfToken===0&&!v){this._addAtBeginningForInBetween(e,s,x,t);}else if(i.getAttribute(j.TOKEN_TYPE)===j.UNDEFINED){this._handleUndefinedForInBetween(i,t,v,w,x,s);}else if(t.json){$(e[0]).insertAfter(s);this._selectedSpans=e;this._cursorPostion+=e[0].textContent.length;this.nIndexOfToken+=1;if(w.getAttribute(j.TOKEN_TYPE)!==j.WS){$(x[0]).insertAfter(s);t.bAddSpaceAutoMatically=false;this.nIndexOfToken+=1;}}else if((i.getAttribute(j.TOKEN_TYPE)===j.TERM&&!(i.textContent.endsWith(j.DOT)&&this.filterText===i.textContent))||(i.getAttribute(j.TOKEN_TYPE)===j.FUNCTION&&i.textContent.length===1)){if(this.getOperationsContext()&&this._attributeContext&&e[0].textContent===j.DOT){this._selectedSpans[0].textContent+=t.text;this.isAutoSuggestionRequired=true;this.dotInOperationsContext=true;this._cursorPostion=this._cursorPostion+1;}else{this._addInBetweenTermsForInBetween(i,e,s,t,x);}}else if(i.getAttribute(j.TOKEN_TYPE)===j.TERM&&i.textContent.endsWith(j.DOT)){this._selectedSpans[0].textContent+=t.text;if(t.text===j.DOT&&this._attributeContext){this.isAutoSuggestionRequired=true;this.dotInOperationsContext=true;this._cursorPostion=this._cursorPostion+1;}else{if(t.reference){var y=i.getAttribute(j.REFERENCE)?i.getAttribute(j.REFERENCE)+t.reference:t.reference;this._selectedSpans[0].setAttribute(j.REFERENCE,y);}if(t.json){this._selectedSpans[0].setAttribute(j.JSON,JSON.stringify(t.json));}}this._cursorPostion+=t.text.length;}else if(i.className==="sapAstLiteralClass"){var z=this.filterTextLength;if(this._selectedSpans[0].getAttribute(j.TOKEN_TYPE)==j.DATEBUSINESSDATATYPE||this._selectedSpans[0].getAttribute(j.TOKEN_TYPE)===j.TIMEBUSINESSDATATYPE){this._selectedSpans[0].setAttribute(j.REFERENCE,t.text);}this._selectedSpans[0].textContent=t.text;this._cursorPostion+=t.text.length-z;if(w&&w.getAttribute(j.TOKEN_TYPE)===j.WS){t.bAddSpaceAutoMatically=false;}}else if(u){var z=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=t.text;this._cursorPostion+=t.text.length-z;if(v&&v.getAttribute(j.TOKEN_TYPE)===j.TERM&&v.textContent.endsWith(j.DOT)){this.nIndexOfToken-=1;}if(t.reference){this._selectedSpans[0].setAttribute(j.REFERENCE,t.reference);}}else{$(e[0]).insertAfter(s);if(i.getAttribute(j.TOKEN_TYPE)!==j.WS){$(x[0]).insertAfter(s);this._cursorPostion+=1;this.nIndexOfToken+=1;}this._selectedSpans=$(e);this._cursorPostion+=e[0].textContent.length;if(!this._isLastTokenSpaceItem()){this._addSpace();}else{this.nIndexOfToken+=1;}if(w&&w.getAttribute(j.TOKEN_TYPE)!==j.WS){x=this._getNewSpaceSpan();$(x[0]).insertAfter($("#"+this._selectedSpans[0].id));t.bAddSpaceAutoMatically=false;}}if(t.text.endsWith(" (")){this.nIndexOfToken+=2;}this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._uiModelToSpan(this._uiModel);this._getSelectedSpanFromIndex();this._getSuggestionsForEditedInput(false);},_addItemsToTheEnd:function(e,i,s,t,u){if(i.getAttribute(j.TOKEN_TYPE)===j.UNDEFINED){if(i.textContent.startsWith(j.SINGLE_QUOTE)){this._selectedSpans[0].textContent+=t.text;this._cursorPostion+=t.text.length;}else{var v=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=t.text;this._cursorPostion+=t.text.length-v;if(t.tokenType===j.TERM){this._cursorPostion+=1;}this._replacePreviousUndefinedTokens();}if(t.reference){this._selectedSpans[0].setAttribute(j.REFERENCE,t.reference);}if(t.json){this._selectedSpans[0].setAttribute(j.JSON,JSON.stringify(t.json));}}else if(t.json||i.getAttribute(j.TOKEN_TYPE)===j.WS){e=this._createSpanItem(t);$(e[0]).insertAfter(s);this._selectedSpans=e;this._cursorPostion+=e[0].textContent.length;this.nIndexOfToken+=1;}else if(u){var v=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=t.text;this._cursorPostion+=t.text.length-v;if(t.tokenType===j.TERM){this._cursorPostion+=1;}if(t.reference){this._selectedSpans[0].setAttribute(j.REFERENCE,t.reference);}}else{this._selectedSpans[0].textContent+=t.text;if(t.text===j.DOT&&this._attributeContext){this.isAutoSuggestionRequired=true;this.dotInOperationsContext=true;this._cursorPostion=this._cursorPostion+1;}else{if(t.reference){var w=this._selectedSpans[0].getAttribute(j.REFERENCE)?this._selectedSpans[0].getAttribute(j.REFERENCE)+t.reference:t.reference;this._selectedSpans[0].setAttribute(j.REFERENCE,w);}if(t.json){this._selectedSpans[0].setAttribute(j.JSON,JSON.stringify(t.json));}this._cursorPostion+=t.text.length;}}this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._uiModelToSpan(this._uiModel);this._hasTextContent=true;if(this.getIsAttributeContext()&&!this.isAssociation&&!t.json&&this._oAutoSuggestionPopUp&&this._oAutoSuggestionPopUp.isOpen()){this.isAutoSuggestionRequired=false;this._oAutoSuggestionPopUp.close();}},_bReplaceFunctionWithSelectedItem:function(e,i){if(e&&e.className==="sapAstFunctionClass"){var s=i.text.toLowerCase();var t=i.label?i.label.toLowerCase():"";var u=e.textContent.toLowerCase();return(s.startsWith(u)||t.indexOf(u)>-1);}return false;},_resetCursorForRerendering:function(){var e=0;if(this.bEditInBetween){e=this._getFullTextContentLength();if(e!==this._cursorPostion&&this._cursorPostion!==0){this._cursorPostion=e;}}},_getFullTextContentLength:function(){var e=0;for(var i=0;i<=this.nIndexOfToken;i++){e+=this._getSelectedSpanGivenIndex(i)[0].textContent.length;}return e;},_setTextOnCursorPosition:function(e){this.dotInOperationsContext=false;this.bTypingFlow=false;var i;this._resetCursorForRerendering();var s=this._selectedSpans?this._selectedSpans[0]:{};var t="#"+s.id;var u=(s.getAttribute(j.TOKEN_TYPE)===j.WS||this._uiModel.length===0)?"":s.id;var v=this._getItemFromSuggestionModel(e,u);this.ruleContext=false;this.forceFireChange=false;var w=this._bReplaceFunctionWithSelectedItem(s,v);if(!this._selectedSpans[0].textContent.endsWith(".")&&!w&&!this._isLastTokenSpaceItem()&&e.getSource().mProperties&&e.getSource().mProperties.label&&e.getSource().mProperties.label!==j.DOT&&this._cursorPostion>0){this._createSpaceSpanItem();s=this._selectedSpans[0];t="#"+s.id;}if(e&&e.getSource()&&e.getSource().mProperties.forceFireChange){this.forceFireChange=true;}if(this._uiModel.length===0){this._addItemToEmptyInput(e,i,t,v);}else if(s&&this.bEditInBetween){this._addItemInBetween(i,s,t,v,w);}else if(s){this._addItemsToTheEnd(i,s,t,v,w);if(this.isAssociation){this._cursorPostion+=1;}}else{console.error("could not find the user selected span - currentSpan");}if(this._bPopUpFocused){this._input.focus();this._bPopUpFocused=false;}if(!this.bEditInBetween){this.nIndexOfToken=this._input.children().length-1;this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1]);}this._setCaretPosition({spanIndex:this.nIndexOfToken,position:this._selectedSpans[0]?this._selectedSpans[0].textContent.length:this._cursorPostion});if(this.isAutoSuggestionRequired){if((v.bAddSpaceAutoMatically&&!this._isLastTokenSpaceItem())&&!(this.bEditInBetween&&this._uiModel[this.nIndexOfToken+1].tokenType===j.WS)){this._addSpace();}else{if(this.bEditInBetween&&!this._isLastTokenSpaceItem()){this._setCaretPosition({spanIndex:this.nIndexOfToken+1,position:1});}else if(!this.bEditInBetween){this._suggestionsList=this._getSuggestionsForTheGivenInput(this.relString);}this._showAutoSuggestion(this._suggestionsList);}}},_replacePreviousUndefinedTokens:function(){var e=this._selectedSpans[0];var i=e.previousSibling;var s;while(i&&i.previousSibling){if((i.getAttribute(j.TOKEN_TYPE)===j.WS&&i.previousSibling.getAttribute(j.TOKEN_TYPE)===j.UNDEFINED)||i.getAttribute(j.TOKEN_TYPE)===j.UNDEFINED){s=i;i=i.previousSibling;s.remove();this.nIndexOfToken-=1;}else{break;}}if(i&&!i.previousSibling&&i.getAttribute(j.TOKEN_TYPE)===j.UNDEFINED){i.remove();this.nIndexOfToken-=1;}},_getItemFromSuggestionModel:function(e,i){this._attributeContext=false;this.isAssociation=false;var s={};var t=e.getSource();s.id=this._createUUID();if(t&&t.getBindingContext()){var B=t.getBindingContext().getObject();s.dataObjectType=B.type;if(B.ResultDataObjectId){s.resultDataObjectId=B.ResultDataObjectId;if(B.displayType&&B.displayType==="Rule"||s.resultDataObjectId){var u=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var v=u.getTermByTermId(B.ResultDataObjectId);if(v&&v.getIsDataObjectElement()){this.ruleWithElementDO=true;s.dataObjectType="ruleWithElementDO";s.cssClass="sapAstObjectClass";s.tokenType=j.TERM;s.text=(B.label!==null&&B.label!=="")?B.label:B.name;s.bAddDotAutomatically=false;s.bAddSpaceAutoMatically=true;s.id=B.id?"/"+B.id:"";s.reference=B.id?"/"+B.id:"";}else{var s=this._createObjectSpanItem(s,i,B);}}}else if(B.type===j.Element){s.tokenType=j.TERM;s.cssClass="sapAstObjectClass";s.id="";s.text=(B.label!==null&&B.label!=="")?B.label:B.name;if(this.getDataObjectInfo()&&this.isDotRequired&&!B.isParentEntity){s.reference=B.id?"./"+B.id:"";}else{this.isDotRequired=true;s.reference=B.id?"/"+B.id:"";}s.bAddDotAutomatically=false;s.bAddSpaceAutoMatically=true;if(i&&i.indexOf("-")>0){i=i.substring(i.indexOf("-")+1)}s.id=i!==''?i+j.DOT+B.id:B.id;var w=T.getInstance();var x=w.getTermByTermId(s.id);if(x&&x._isDataObjectElement){s._isDataObjectElement=true;}}else if("type"in B){var s=this._createObjectSpanItem(s,i,B);}else{s.text=B.name;if(B&&"noOfMandatoryArgs"in B){if(B.noOfMandatoryArgs==="0"){s.text+=" ( )";}else{s.text+=" (";}}s.bAddDotAutomatically=false;s.bAddSpaceAutoMatically=true;}}else if(e.getParameter("tokens")){var V=e.getParameter("tokens")[0].data("row");;s.text=V.Value;s.bAddDotAutomatically=false;s.bAddSpaceAutoMatically=true;s.cssClass="sapAstLiteralClass";}else if(e.getSource().mProperties.jsonData){s.text=e.getSource().mProperties.value;s.json=e.getSource().mProperties.jsonData;s.bAddDotAutomatically=false;s.bAddSpaceAutoMatically=true;}else{s.text=e.getSource().mProperties.value.trim();s.bAddDotAutomatically=false;s.bAddSpaceAutoMatically=true;}if(this.getDataObjectInfo()&&!this.bEditInBetween){if(s.json){this.dataObjectInfo+=this._constructExpandedRelString(s.json);}else if(this.getIsAttributeContext()&&s.text=="."){this.dataObjectInfo+=s.reference?s.reference.replace(".",""):s.text;}else if(s.text!="."){this.dataObjectInfo+=s.reference?s.reference:s.text;}if(s&&s.dataObjectType==="E"){this.dataObjectInfo+=" ";}}if(e.getSource().mProperties.label===j.DOT){s.bAddDotAutomatically=false;s.bAddSpaceAutoMatically=false;this._attributeContext=true;}return s;},_createObjectSpanItem:function(i,e,B){i.tokenType=j.TERM;i.cssClass="sapAstObjectClass";i.id="";i.text=(B.label!==null&&B.label!=="")?B.label:B.name;if(B.type!==j.ASSOCIATIONDOTYPE){i.reference=B.id?"/"+B.id:"";if(e&&e.indexOf("-")>0){e=e.substring(e.indexOf("-")+1)}i.id=e!==''?e+j.DOT+B.id:B.id;}else{this.isAssociation=true;if(this.getDataObjectInfo()&&this.isDotRequired){i.reference=B.id?"./"+B.id:"";this.isDotRequired=false;}else{i.reference=B.id?"/"+B.id:"";}i.id+=B.id;}if(this.getDataObjectInfo()){this.isDotRequired=false;}this._attributeContext=true;i.bAddDotAutomatically=true;i.bAddSpaceAutoMatically=false;if(this._isFirstTokenUpdateOrAppendOperation()&&this.getOperationsContext()&&!this.getConditionContext()){this._attributeContext=false;i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=false;this.isDotRequired=false;}return i;},_createPopver:function(){var t=this;if(!this._oAutoSuggestionPopUp){this._oAutoSuggestionPopUp=new R("autoCompletePopover_"+this._createUUID(),{content:new sap.rules.ui.AutoCompleteSuggestionContent(),showArrow:false,placement:P.Vertical,horizontalScrolling:true,showHeader:true,contentWidth:"400px",title:this.oBundle.getText("astSuggestionDialogTitle"),initialFocus:t,afterOpen:function(){var e;if(t.bEditInBetween){e=t.filterTextLength;}else{e=t._selectedSpans[0].textContent.length;}var i=t._cursorPostion===0?0:e;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:i});}});}},_getCaretPosition:function(I,s){var t,u,v,w=0;var x=function(N){return(I&&N===I)||(!I&&(N===u.anchorNode||N===u.anchorNode.parentNode));};var y=function(N){var z;if(x(N)){return false;}if(N.nodeType===3){w+=N.textContent.length;}else{for(var i=0;i<N.childNodes.length;i++){z=N.childNodes[i];if(x(z)){return false;}w+=z.textContent.length;}}return true;};try{if(window.getSelection&&window.getSelection().getRangeAt){t=window.getSelection().getRangeAt(0);u=window.getSelection();v=this._input[0].childNodes;for(var i=0;i<v.length;i++){if(!y(v[i])){break;}}return(s||t.startOffset)+w;}}catch(e){return this._cursorPostion;}return 0;},_getSelectedSpans:function(){var s=window.getSelection();var e=new Array();if("getRangeAt"in s){var i=s.getRangeAt(0);if(i.startContainer==i.endContainer){e.push(i.startContainer.parentNode);}else{var t=$(i.startContainer.parentNode);var u=$(i.endContainer.parentNode);e.push(t);$(i.startContainer.parentNode).nextAll().each(function(){var v=$(this).attr('id');if(v!=$(u).attr('id')){e.push($(this));}else{e.push(u);return false;}});}}else{e.push(s.anchorNode.parentNode);}return e;},_createRange:function(e,i,s){if(!s){s=document.createRange();s.selectNode(e);s.setStart(e,0);}if(i.count===0){s.setEnd(e,i.count);}else if(e&&i.count>0){if(e.nodeType===Node.TEXT_NODE){if(e.textContent!=undefined&&e.textContent.length<i.count){i.count-=e.textContent.length;}else{s.setEnd(e,i.count);i.count=0;}}else{for(var t=0;t<e.childNodes.length;t++){s=this._createRange(e.childNodes[t],i,s);if(i.count===0){break;}}}}return s;},_setCurrentCursorPosition:function(e){if(e>=0){var s=window.getSelection();var i=this._createRange($("#"+this.getDomRef("input").id)[0],{count:e});if(i){i.collapse(false);s.removeAllRanges();s.addRange(i);}}},_updateUiModel:function(){var t=this;if(this.getDomRef("input")){var i=this.getDomRef("input").children;t._uiModel=[];for(var s=0;s<i.length;s++){var u=i[s].getAttribute(j.TOKEN_TYPE)!==j.GEOBUSINESSDATATYPE?i[s].getAttribute(j.REFERENCE):undefined;var v=i[s].getAttribute(j.JSON);var w={"id":i[s].id,"cssClass":i[s].className,"reference":u,"tokenType":i[s].getAttribute(j.TOKEN_TYPE),"text":i[s].textContent};if(v){try{w.json=JSON.parse(v);}catch(e){L.error("Error in parsing string to JSON: "+e.message);}}this._uiModel.push(w);}t._uiModeltoString();}},_uiModeltoString:function(){var t=this;t.relString="";t._jsonArray=[];this._uiModel.forEach(function(i,e){if(i.reference){t.relString+=i.reference;}else if(i.json){t.relString+=t._constructExpandedRelString(i.json);t._jsonArray.push(i.json);}else{t.relString+=i.text;}});return t.relString;},_calculateStringAndIndexOfNewToken:function(){var t=this;var i="";var s="";if(this.getDomRef("input")){var u=this.getDomRef("input").children;var v=this._selectedSpans?this._selectedSpans[0].id:"";for(var w=0;w<u.length;w++){var x=u[w].getAttribute(j.TOKEN_TYPE)!==j.GEOBUSINESSDATATYPE?u[w].getAttribute(j.REFERENCE):undefined;var y=u[w].getAttribute(j.JSON);if(y){try{y=JSON.parse(y);}catch(e){L.error("Error in parsing string to JSON: "+e.message);}}if(u[w].id===v){this.nIndexOfToken=w;var z=s+u[w].textContent;var B=u[w].textContent;var D=z.length-this._cursorPostion;this.filterTextLength=D>=0?B.length-D:B.length;var F=this.filterTextLength<0?B:B.slice(0,this.filterTextLength);this.filterText=F;if(x){i+=this._constructReferenceForFilter(F,x,D);}else if(y){i+=t._constructExpandedRelString(y);}else{i+=F;}break;}s+=u[w].textContent;if(x){i+=x;}else if(y){i+=t._constructExpandedRelString(y);}else{i+=u[w].textContent;}}}return i;},_constructReferenceForFilter:function(e,s,t){var u=e.split(".");var v=s.split("/");var w="";if((t<=0&&u.length===0)||(this._enableAggregateFunctionWhereClause&&s&&t<=0)){return s;}if(u.length>1){if(t<=0){if(this.bTypingFlow){return s+u[u.length-1];}else{return s;}}for(var i=1;i<u.length;i++){w+="/"+v[i];}w+=u[u.length-1];this._attributeContext=true;}else{w=e;this._attributeContext=false;}return w;},_getSelectedSpanFromIndex:function(){if(this.getDomRef("input")){var e=this.getDomRef("input").children;this._selectedSpans=$(e[this.nIndexOfToken]);}},_getSelectedSpanGivenIndex:function(i){if(this.getDomRef("input")){var e=this.getDomRef("input").children;if(e[i]){return $(e[i]);}else{return null;}}},_isChildOf:function(e,i){while(e!==null){if(e.id===i){return true;}e=e.parentNode;}return false;},_getCurrentCursorPosition:function(){var e=this.getDomRef("input").id;var s=window.getSelection(),i=-1,t;if(s.focusNode){if(this._isChildOf(s.focusNode,e)){t=s.focusNode;i=s.focusOffset;while(t){if(t.id===e){break;}if(t.previousSibling){t=t.previousSibling;i+=t.textContent.length;}else{t=t.parentNode;if(t===null){break}}}}}return i;},_hiddenAccessModeSelected:function(e,D,i){if(this._input&&this._input[0].id===i.expId){this.expId=i.expId}},_validateControl:function(){var v=this.getValueState();var e=this.getValueStateText();if((this.astresponseNodes&&this.astresponseNodes.length===1&&this.astresponseNodes[0].Type==="I")&&this.astresponseNodes[0].Value!==""||(this.astresponseNodes&&v==="Error")){this._input[0].classList.add("sapAstExpressionInputError");if(e){this._input[0].title=e;}else{this._input[0].title=this.oBundle.getText("invalidExpression");}}else if(this.oBundle.getText("PredefinedResultsValueStateText")===e){this._input[0].classList.add("sapAstExpressionInputError");if(e){this._input[0].title=e;}else{this._input[0].title=this.oBundle.getText("invalidExpression");}}else if(this._input[0].classList.contains("sapAstExpressionInputError")){this._input[0].classList.add("sapAstExpressionInputError");this._input[0].title=this.oBundle.getText("PredefinedResultsValueStateText");this.expId="";}else if(this._input[0].id===this.expId&&this._input[0].textContent!==""){this.expId="";}else{if(this._input[0].classList.contains("sapAstExpressionInputError")){this._input[0].classList.remove("sapAstExpressionInputError");}}}});return r;},true);
