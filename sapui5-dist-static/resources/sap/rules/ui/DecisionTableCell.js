/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/rules/ui/DecisionTableCellExpressionAdvanced","sap/rules/ui/type/DecisionTableCell","sap/rules/ui/DecisionTableCellExpressionBasic","sap/m/Popover","sap/rules/ui/Constants","sap/rules/ui/ast/constants/Constants","sap/rules/ui/services/AstExpressionLanguage","sap/rules/ui/ast/util/AstUtil","sap/ui/core/LocaleData"],function(q,l,D,a,b,P,C,c,A,d,L){"use strict";var e=sap.ui.core.Control.extend("sap.rules.ui.DecisionTableCell",{metadata:{library:"sap.rules.ui",properties:{valuePath:{type:"string",defaultValue:"",bindable:"bindable"},valueOnlyPath:{type:"string",defaultValue:"",bindable:"bindable"},headerValuePath:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperatorPath:{type:"string",defaultValue:"",bindable:"bindable"},typePath:{typePath:"string",bindable:"bindable"},valueStatePath:{type:"string",defaultValue:"null",bindable:"bindable"},valueStateTextPath:{type:"string",defaultValue:"null",bindable:"bindable"},valueModelName:{type:"string",defaultValue:"",bindable:"bindable"},displayModelName:{type:"string",defaultValue:"",bindable:"bindable"},editable:{type:"boolean",defaultValue:true},inFocus:{type:"boolean",defaultValue:false},decisionTableCellType:{type:"sap.rules.ui.type.DecisionTableCell",multiple:false},ruleFormatPath:{type:"string",defaultValue:"null",bindable:"bindable"},decisionTableFormat:{type:"sap.rules.ui.DecisionTableFormat",defaultValue:sap.rules.ui.DecisionTableFormat.CellFormat},keyProperties:{type:"object",defaultValue:"{}"},attributeInfoPath:{type:"string",defaultValue:null,bindable:"bindable"},attributeNamePath:{type:"string",defaultValue:null,bindable:"bindable"},headerInfo:{type:"object",defaultValue:{}}},aggregations:{_displayedControl:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,validateOnLoad:true,singularName:"expressionLanguage"},astExpressionLanguage:{type:"sap.rules.ui.services.AstExpressionLanguage",multiple:false,singularName:"astExpressionLanguage"}}}});e.prototype._addNodeObject=function(f){var n=[];var o=sap.ui.getCore().byId(this.getAstExpressionLanguage());var g=o._astBunldeInstance.ASTUtil;var u=[];u.Root=f.Root;u.SequenceNumber=f.Sequence;u.ParentId=f.ParentId;u.Reference=f.Reference;u.Id=f.NodeId;u.Type=f.Type;u.Value=f.Value?f.Value:"";if(f.Type==="I"){u.Value=f.IncompleteExpression;}if(f.Function){u.Function=f.Function;}if(f.Type!=="P"&&!f.Function){var O=[];O.BusinessDataType=f.Output?f.Output.BusinessDataType:f.BusinessDataType;O.DataObjectType=f.Output?f.Output.DataObjectType:f.DataObjectType;u.Output=O;}g.createNode(u);};e.prototype._bindPopOverFragment=function(E){var t=this;var f=(this.getExpressionLanguage()&&this.getDisplayModelName())?this.getDisplayModelName()+">"+this.getValuePath():this.getValuePath();var v=this.getValueModelName()?this.getValueModelName()+">"+this.getValuePath():this.getValuePath();var g=(this.getExpressionLanguage()&&this.getDisplayModelName())?this.getDisplayModelName()+">"+this.getHeaderValuePath():this.getHeaderValuePath();var h=(this.getExpressionLanguage()&&this.getDisplayModelName())?this.getDisplayModelName()+">"+this.getFixedOperatorPath():this.getFixedOperatorPath();var F=this.getModel().getProperty(this.getFixedOperatorPath());var i=this.getAggregation("_displayedControl");if(v&&v!=="null"){if(!this.getTypePath()){if(this.getAstExpressionLanguage()){E.setHeaderInfo(this.getHeaderInfo());E.markerString=this._getMarkerString().trim();var j="";F=this.astUtil._getCapitalOperatorName(F);if(i.relString){if(this.includes(i.relString,E.markerString)){j=i.relString.replace(E.markerString,"");}else{j=i.relString;}}if(j.startsWith(F+" ")){j=j.split(F+" ")[1];}var k=i.JSON;E.setValue(j);E.setJsonData(k);E.setValueState(i.getValueState());}else{E.bindValue({parts:[{path:g},{path:h},{path:v},{path:f}],type:this.getDecisionTableCellType()});}}else{if(this.getAstExpressionLanguage()){E.setAttributeInfo(this.getAttributeInfoPath());E.setValue(i.relString);E.setJsonData(i.JSON);E.setValueState(i.getValueState());}else{E.bindValue({parts:[{path:v},{path:this.getTypePath()},{path:f}],type:this.getDecisionTableCellType()});if(this.getTypePath()){E.bindType(this.getTypePath());}}}}if(g){E.bindHeaderValue(g);if(h){E.bindFixedOperator(h);}}if("getAttributeInfo"in E&&this.getAttributeInfoPath()&&this.getExpressionLanguage()){E.bindAttributeInfo(this.getAttributeInfoPath());}if("getAttributeName"in E&&this.getAttributeNamePath()){E.bindAttributeName(this.getAttributeNamePath());}};e.prototype._createStaticControl=function(){var t=this;var E=this.getModel("dtModel").getProperty("/editable");var f=this.getModel().getProperty(this.getFixedOperatorPath());var o=this.getAstExpressionLanguage()?this.astUtil._getCapitalOperatorName(f):f;var g=this.getAggregation("_displayedControl");if(g){g.destroy();}g=new sap.m.Input({editable:false});if(E){g.addStyleClass("sapRULDecisionTableSCellEditable");}else{g.removeStyleClass("sapRULDecisionTableSCellEditable");}g.addDelegate({onclick:function(n){if(E){this.onFocusIn();}}.bind(this),onkeyup:function(n){if(n.keyCode===13&&E){this.onFocusIn();}else{return;}}.bind(this)});var v=this.getValuePath();var h;var p="/"+v.split("/")[1];var i=new sap.ui.model.Context(this.getModel(),p);if(this.getExpressionLanguage()){v=this.getDisplayModelName()+">"+v;}if(v&&v!=="null"){var j=this.getTypePath()?false:true;var k="";if(j&&this.getAstExpressionLanguage()){k=this._getMarkerString();}g.bindValue({path:v,formatter:function(V){if(t.getAstExpressionLanguage()){var n=t._getExpressionFromAstNodes(i,true);if(n&&j){if(k!==""&&t.includes(n,k)){return n.split(k)[1];}else if(n.startsWith(o+" ")){return n.split(o+" ")[1];}else{return n;}}else{return n;}}else{return V;}}});g.bindProperty("tooltip",{path:v,formatter:function(V){if(t.getAstExpressionLanguage()){var n=t._getExpressionFromAstNodes(i,true);if(n&&j){if(k!==""&&t.includes(n,k)){return n.split(k)[1];}else if(n.startsWith(o+" ")){return n.split(o+" ")[1];}else{return n;}}else{return n;}}else{return V;}}});}var m=this.getValueStatePath();if(m&&m!=="null"&&!this.getAstExpressionLanguage()){g.bindProperty("valueState",{path:m,formatter:function(V){var n=sap.ui.core.ValueState.None;if(V===sap.ui.core.ValueState.Error){n=sap.ui.core.ValueState.Error;}return n;}.bind(this)});}return g;};e.prototype._getLocaleData=function(){var o=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();return L.getInstance(o);};e.prototype._getDateFormatter=function(){var o=this._getLocaleData();var f=o.getDatePattern('medium');var g=sap.ui.core.format.DateFormat.getDateInstance({pattern:f});return g;};e.prototype._getDateTimeFormatter=function(){var o=this._getLocaleData();var f=o.getDatePattern('medium');var t=o.getTimePattern('medium');var g=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:f+" "+t});return g;};e.prototype._getExpressionFromAstNodes=function(o,i){var t=this;var f=sap.ui.getCore().byId(this.getAstExpressionLanguage());var g=f._astBunldeInstance.TermsProvider.TermsProvider;var h="";var j="";var k=this.getModel("displayModel");var m=o.getModel();var p=o.getPath();var n=m.getObject(p);var r=0;var s=0;var u=n?n.DecisionTableRowCellASTs:[];var v=f._astBunldeInstance.ASTUtil;var F=[c.AVG,c.SUM,c.COUNT,c.COUNTDISTINCT,c.DISTINCT,c.MIN,c.MAX,c.FILTER,c.TOP,c.BOTTOM,c.FIRST,c.SELECT,c.SORTASC,c.SORTDESC];v.clearNodes();if(u&&u.__list&&u.__list.length>0){u=u.__list;for(var w in u){this._addNodeObject(o.getObject("/"+u[w]));}var x=v.getNodes();if(i){var y=this._getDateFormatter();var z=this._getDateTimeFormatter();h=v.toAstExpressionStringForDt(x,y,z);}else{h=v.toAstExpressionString(x);}s=h.JSON.length;if(h&&h.relString){h.relString=h.relString.replace(/\\/g,"\\\\").replace(/{/g,"\\{").replace(/}/g,"\\}");}this.getAggregation("_displayedControl").relString=h?h.relString:"";this.getAggregation("_displayedControl").shortRELString=h?h.shortRELString:"";this.getAggregation("_displayedControl").JSON=h?h.JSON:[];t.getAggregation("_displayedControl").displayString=h?h.displayString:"";if(x&&x[0].Type==="I"&&x[0].Value!=""){this.getAggregation("_displayedControl").setValueState("Error");}else{this.getAggregation("_displayedControl").setValueState("None");}var B=h.shortRELString?h.shortRELString.split(" "):[];B=h.displayString?h.displayString.split(" "):[];for(var E in B){var G="";if(B[E].startsWith("./")||B[E].startsWith("/")&&!t.includes(B[E],C.MARKER_STRING)){G=g.getTermNameFromASTNodeReference(B[E]);}if(G!==""){j=j+" "+G;}else{if(t.includes(B[E],"/"+C.MARKER_STRING)){B[E]=B[E].replace("/"+C.MARKER_STRING,"");}if(this.getAggregation("_displayedControl").getValueState()==="Error"&&t.includes(B[E],"====")){B[E]=B[E].replace("====","");}if(t.includes(B[E],C.MARKER_STRING)){B[E]=B[E].replace(C.MARKER_STRING,"");}var H=B[E].split("(");if(t.includes(F,H[0])&&r<s){B[E]=B[E].replace(h.JSON[r].dataObject,g.getTermNameFromASTNodeReference(h.JSON[r].dataObject));r++;}j=j+" "+B[E];}}if(j!=""){h=j.trim();}}return(h instanceof Object?h.shortRELString:h.trim());};e.prototype._getMarkerString=function(){var m;var h=this.getHeaderInfo().headerValue;if(h===undefined||h.trim()===""){return"";}var v=h.split(" ");var f=v[v.length-1]!==""?v[v.length-1]:v[v.length-2];var o=["=","!=",">",">=","<","<=","IN","NOTIN","EXISTSIN","NOTEXISTSIN","MATCHES","NOTMATCHES","CONTAINS","NOTCONTAINS","STARTSWITH","NOTSTARTSWITH","ENDSWITH","NOTENDSWITH","ISWITHIN","ISNOTWITHIN","+","-","/","*"];var g=["AND","OR"];if(g.indexOf(f)>-1){m="";}else if(o.indexOf(f)>-1){m="/"+C.MARKER_STRING+" ==== ";}else{m="/"+C.MARKER_STRING+" ";}return m;};e.prototype._setDisplayedControl=function(){var o=this._createStaticControl();this.setAggregation("_displayedControl",o,true);};e.prototype.init=function(){this.astUtil=new d();this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");};e.prototype.onAfterRendering=function(){this.bColumnResized=false;var E=sap.ui.getCore().getEventBus();E.unsubscribe("sap.ui.rules","_onColumnResized",this._setColumnResized,this);};e.prototype.onBeforeRendering=function(){var E=sap.ui.getCore().getEventBus();E.subscribeOnce("sap.ui.rules","_onColumnResized",this._setColumnResized,this);if(!this.bColumnResized){this._setDisplayedControl();}};e.prototype._setColumnResized=function(E,o){this.bColumnResized=true;};e.prototype.onFocusIn=function(){var f=function(E){var o=E.getSource().getAggregation('content')[1];o.setVisible(true);var h=this.getAggregation("_displayedControl");h.setEnabled(false);}.bind(this);var B=function(E){var h=this.getAggregation("_displayedControl");if(h){h.setEnabled(true);}}.bind(this);var g=function(E){if(this._oPopover){var o=this._oPopover.getAggregation('content')[1];if(o instanceof sap.rules.ui.ExpressionAdvanced){if(o.codeMirror){var h=o.codeMirror.getValue();o.setValue(h);}}else if(o instanceof sap.rules.ui.AstExpressionBasic){o._fireChange(o._input.text())}this._oPopover.destroy();this._oPopover=null;var j=this.getAggregation("_displayedControl");j.focus();}}.bind(this);this._oPopover=null;if(!this._oPopover){var v=this.getModel().getProperty(this.getValueOnlyPath());var V=this.getModel().getProperty(this.getRuleFormatPath());var s=this.getDecisionTableFormat();if(sap.ui.getCore().byId("popover")){sap.ui.getCore().byId("popover").destroy();}if(this.getAstExpressionLanguage()){this._oPopover=sap.ui.xmlfragment("sap.rules.ui.fragments.DecisionTableCellAstExpressionBasic",this);this._oPopover.setTooltip(this.oBundle.getText("ctrlSpaceCue"));var o=this._oPopover.getAggregation('content')[1];o.setAstExpressionLanguage(this.getAstExpressionLanguage());o.attachChange(sap.rules.ui.DecisionTableCellAstExpressionBasic.prototype._changeValue);}else{if(s===sap.rules.ui.DecisionTableFormat.RuleFormat){if(V.toUpperCase()===sap.rules.ui.RuleFormat.Advanced){this._oPopover=sap.ui.xmlfragment("sap.rules.ui.fragments.DecisionTableCellExpressionAdvanced",this);}else{this._oPopover=sap.ui.xmlfragment("sap.rules.ui.fragments.DecisionTableCellExpressionBasic",this);}}else if(v){this._oPopover=sap.ui.xmlfragment("sap.rules.ui.fragments.DecisionTableCellExpressionBasic",this);}else{this._oPopover=sap.ui.xmlfragment("sap.rules.ui.fragments.DecisionTableCellExpressionAdvanced",this);}var o=this._oPopover.getAggregation('content')[1];o.setExpressionLanguage(this.getExpressionLanguage());}this._oPopover.attachAfterOpen(f);this._oPopover.attachBeforeClose(B);this._oPopover.attachAfterClose(g);this.addDependent(this._oPopover);var n=q.sap.byId(this.getId()).closest('td').width()*0.93;var w=n+"px";var S=this._oPopover.getAggregation('content')[0];S.setWidth(w);if(this.getModel("settingModel")&&this.getModel("settingModel").oData){o.resultDataObjectId=this.getModel("settingModel").oData.ResultDataObjectId;o.resultDataObjectName=this.getModel("settingModel").oData.ResultDataObjectName;}this._bindPopOverFragment(o);var i=this.getAggregation("_displayedControl");this._oPopover.openBy(i);}};e.prototype.includes=function(p,s){var r=false;if(p.indexOf(s)!==-1){r=true;}return r;};return e;},true);
