// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["./abap.bootstrap.utils","sap/base/util/ObjectPath"],function(a,O){"use strict";var S="sap-ushell-reloaded";function X(w,x){this._oWindow=w||window;this._sXhrLogonMode=x;this._bPending=false;}X.prototype.handleEvent=function(e){if(this._bPending){return true;}if(e.type==="logon"){this._bPending=true;if(this._sXhrLogonMode==="logoffAndRedirect"){this._showErrorAndReload({key:"bootstrap.xhr.authenticationRequired",text:"Authentication required"},{key:"bootstrap.xhr.sessionExpired",text:"Your session has expired. Press OK to reload."},this._logoffAndRedirect,this._handleAuthenticationRequiredNoUi5.bind(this));}else{this._showErrorAndReload({key:"bootstrap.xhr.authenticationRequired",text:"Authentication required"},{key:"bootstrap.xhr.sessionExpired",text:"Your session has expired. Press OK to reload."},this._reloadPage,this._handleAuthenticationRequiredNoUi5.bind(this));}}else{sap.ui2.srvc.log.error("Cannot handle event with type: "+e.type,null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler");}return true;};X.prototype._getUpdatedLocationSearchForReload=function(c){var r=Date.now(),b=new RegExp(["(.*)([?&])",S,"(=[^&]*)?(.*)"].join("")),R,m=false;if(typeof c!=="string"){throw new Error("Illegal argument: sCurrentLocationSearch must be a string");}R=c.replace(b,function(M,p,o,v,s){m=true;return[p,o,S,"=",r,s].join("");});if(!m){if(c){R=[c,"&",S,"=",r].join("");}else{R=["?",S,"=",r].join("");}}return R;};X.prototype._reloadPage=function(){var t=this;t._oWindow.setTimeout(function(){t._oWindow.location.search=t._getUpdatedLocationSearchForReload(t._oWindow.location.search);},0);};X.prototype._logoffAndRedirect=function(){var l=a.getLocationHref(),c=O.get("sap-ushell-config.services.Container.adapter.config.client"),u;u=new URI("/sap/public/bc/icf/logoff").absoluteTo(l).search("sap-client="+c+"&propagateLogoff=false&redirectURL="+encodeURIComponent(l)).toString();document.location=u;};X.prototype._isPageReloaded=function(){return new RegExp(["[?&]",S].join("")).test(this._oWindow.location.search);};X.prototype._handleAuthenticationRequiredNoUi5=function(r){if(!this._isPageReloaded()){sap.ui2.srvc.log.error("Illegal state: XHR authentication (mode=reload) requested before SAPUI5 is initialized. "+"This should not happen if the FioriLaunchpad.html page is loaded from the server. Trying to reload page once.",null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler");var m="Authentication required\n\nYour session might have expired. Press OK to reload.";this._oWindow.alert(m);r.call(this);}else{sap.ui2.srvc.log.error("Illegal state: XHR authentication (mode=reload) requested before SAPUI5 is initialized and page reload has been triggered once."+" Stopping reload to avoid endless loop. This state cannot be overcome. Please ensure that the FioriLaunchpad.html"+" page is not cached, but always loaded from the server.",null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler");}};X.prototype._showErrorAndReload=function(t,m,r,f){var T,M;if(sap&&sap.ui&&(typeof sap.ui.getCore==="function")&&sap.ui.getCore().isInitialized()&&jQuery.sap.isDeclared("sap.m.MessageBox",true)){jQuery.sap.require("sap.m.MessageBox");if(jQuery.sap.isDeclared("sap.ushell.resources",true)){jQuery.sap.require("sap.ushell.resources");T=this._getText(t);M=this._getText(m);}if(jQuery.sap.isDeclared("sap.ui.core.BusyIndicator",true)){jQuery.sap.require("sap.ui.core.BusyIndicator");if(typeof sap.ui.core.BusyIndicator.show==="function"&&typeof sap.ui.core.BusyIndicator.hide==="function"){sap.ui.core.BusyIndicator.hide();sap.ui.core.BusyIndicator.show=function(){};}}if(sap&&sap.ca&&sap.ca.ui&&sap.ca.ui.utils&&sap.ca.ui.utils.busydialog){if(typeof sap.ca.ui.utils.busydialog.releaseBusyDialog==="function"){for(var i=0;i<200;++i){sap.ca.ui.utils.busydialog.releaseBusyDialog();}}}sap.m.MessageBox.show(M,{icon:sap.m.MessageBox.Icon.ERROR,title:T,actions:[sap.m.MessageBox.Action.OK],onClose:r.bind(this)});}else{f.call(this,r);}};X.prototype._getText=function(t){var T=sap.ushell.resources.i18n.getText(t.key);if(T&&(T!==t.key)){return T;}return t.text;};return X;},true);
