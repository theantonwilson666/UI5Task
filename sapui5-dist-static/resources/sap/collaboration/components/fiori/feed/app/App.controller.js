/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/core/mvc/Controller","jquery.sap.global","sap/collaboration/components/utils/OdataUtil","sap/collaboration/components/utils/CommonUtil","sap/ui/core/mvc/View","sap/ui/core/library","sap/collaboration/library"],function(C,q,O,a,V,c,l){"use strict";var F=l.FeedType;var b=c.mvc.ViewType;sap.ui.controller("sap.collaboration.components.fiori.feed.app.App",{onInit:function(){this.oApp=this.getView().oApp;this.oOdataModel=this.getView().getViewData().odataModel;this.oLangBundle=this.getView().getViewData().langBundle;this.sPrefixId=this.getView().getViewData().controlId;this.sAppType=this.getView().getViewData().appType;this.sFeedType=this.getView().getViewData().feedType;this.sGroupIds=this.getView().getViewData().groupIds;this.oBusinessObject=this.getView().getViewData().object;},onBeforeRendering:function(){try{this.initializeUtils();this.createDetailPage();}catch(e){q.sap.log.error(e,"","sap.collaboration.components.fiori.feed.app.App.controller.onBeforeRendering()");this.oCommonUtil.displayError();}},initializeUtils:function(){if(!this.oODataUtil){this.oODataUtil=new O();}if(!this.oCommonUtil){this.oCommonUtil=this.oCommonUtil=new a();}},createDetailPage:function(){try{var v=this.sPrefixId+"detailView";if(!this.oApp.getPage(v)){this.initOData();var d=sap.ui.view({id:v,viewData:{controlId:this.sPrefixId,jamURL:this.sJamUrl,jamToken:this.sJamToken,appType:this.sAppType,feedType:this.sFeedType,groupIds:this.sGroupIds,object:this.oBusinessObject,langBundle:this.oLangBundle},type:b.JS,viewName:"sap.collaboration.components.fiori.feed.commons.Detail"});this.oApp.addPage(d);this.oApp.setInitialPage(d);}}catch(e){q.sap.log.error(e,"","sap.collaboration.components.fiori.feed.app.App.controller.createDetailPage()");throw e;}},getGroupIds:function(){var g;if(this.sFeedType===F.group&&(this.sGroupIds===undefined||this.sGroupIds==="")){g=this.oODataUtil.getGroupsData(this.oOdataModel,"/Groups");this.sGroupIds=this.oODataUtil.getGroupIds(g);}else if(this.sFeedType===F.objectGroup&&(this.sGroupIds===undefined||this.sGroupIds==="")){g=this.oODataUtil.getGroupsData(this.oOdataModel,"/BusinessObjects('"+this.oBusinessObject.id+"')/AssignedGroups");this.sGroupIds=this.oODataUtil.getGroupIds(g);}else if(this.sFeedType===F.objectGroup&&!(this.sGroupIds===undefined||this.sGroupIds==="")){g=this.oODataUtil.getGroupsData(this.oOdataModel,"/BusinessObjects('"+this.oBusinessObject.id+"')/AssignedGroups");var s=this.oODataUtil.getGroupIds(g);this.sGroupIds=this.filterGroupIds(s);}},filterGroupIds:function(s){var g;var d=s.split(",");var I=this.sGroupIds.split(",");for(var i=0;i<I.length;i++){if(d.indexOf(I[i])===-1){I.splice(i,1);i=i-1;}}if(I.length!==0){g=I.join();}else{g="";}return g;},initOData:function(){var s=this;var B=[];var A=false;var p=function(d){s.parseBatchResults(d);};var f=function(e){q.sap.log.error(e,"","sap.collaboration.components.fiori.feed.dialog.Component.initOdata(), fnBatchErrorCallback()");throw e;};try{B=this.createBatchRequests();this.oODataUtil.executeODataBatchRequest(this.oOdataModel,B,p,A,f);}catch(i){q.sap.log.error(i,"","sap.collaboration.components.fiori.feed.app.App.controller.initOdata()");throw i;}},createBatchRequests:function(){var s=this;var B=[];try{if(!s.sJamUrl){B.push(s.oODataUtil.createJamUrlBatchOperation(s.oOdataModel));}B.push(s.oODataUtil.createJamTokenBatchOperation(s.oOdataModel));switch(s.sFeedType){case F.object:B=B.concat(s.createExternalUrlBatchRequest(s.oODataUtil,s.oBusinessObject));break;case F.group:B.push(s.oODataUtil.createGetGroupsDataBatchOperation(s.oOdataModel));break;case F.objectGroup:B.push(s.createObjectGroupBatchRequest(s.oODataUtil,s.oBusinessObject));break;}}catch(o){q.sap.log.error(o,"","sap.collaboration.components.fiori.feed.app.App.controller.createBatchRequests()");throw o;}return B;},createExternalUrlBatchRequest:function(o,B){var s=this;var d=[];if(o&&B){if(B.id){d.push(o.createExternalOdataUrlBatchOperation(s.oOdataModel,B.id));}if(B.type){d.push(o.createExternalOdataUrlBatchOperation(s.oOdataModel,B.type));}}return d;},createObjectGroupBatchRequest:function(o,B){var s=this;var d;if(o&&B&&B.id){d=o.createGetObjectGroupsBatchOperation(s.oOdataModel,B.id);}else{var e=new Error("Missing parameters. Cannot create a batch request for Object Group.");q.sap.log.error(e,"","sap.collaboration.components.fiori.feed.app.App.controller.createObjectGroupBatchRequest()");throw e;}return d;},parseBatchResults:function(B){var s=this;var i=0;if(!s.sJamUrl){if(B[i].error){throw new Error(B[i].error);}else{s.sJamUrl=B[i][s.oODataUtil.OdataUtilConstants.EndPoint.GetCollaborationHostUrl].Url;}i++;}if(B[i].error){throw new Error(B[i].error);}else{s.sJamToken=B[i][s.oODataUtil.OdataUtilConstants.EndPoint.GetSingleUseToken].Id;}i++;if(s.sFeedType==F.object){if(B[i].error){throw new Error(B[i].error);}else{s.oBusinessObject.id=B[i][s.oODataUtil.OdataUtilConstants.EndPoint.GetExternalODataURL].URL;s.oBusinessObject.odata_url=s.oBusinessObject.id;}i++;if(B[i].error){throw new Error(B[i].error);}else{s.oBusinessObject.type=B[i][s.oODataUtil.OdataUtilConstants.EndPoint.GetExternalODataURL].URL;s.oBusinessObject.metadata_url=s.oBusinessObject.type;}}else if(s.sFeedType==F.group||s.sFeedType==F.objectGroup){if(B[i].error){throw new Error(B[i].error);}else{var d=s.oODataUtil.getGroupIds(B[i].results);if(!s.sGroupIds){s.sGroupIds=d;}else{s.sGroupIds=s.filterGroupIds(d);}}}}});});
