/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/collaboration/components/utils/CommonUtil','sap/collaboration/components/utils/JamUtil','sap/collaboration/components/utils/OdataUtil','sap/collaboration/library','sap/ui/core/UIComponent','jquery.sap.global','sap/ui/model/odata/ODataModel','sap/ui/core/mvc/View','sap/ui/core/library','sap/m/Dialog','sap/m/Button','sap/ui/Device'],function(C,J,O,l,U,q,a,V,c,D,B,b){"use strict";var d=c.mvc.ViewType;var A=l.AppType;var F=l.FeedType;var e=U.extend("sap.collaboration.components.fiori.feed.dialog.Component",{metadata:{includes:["../../../resources/css/Sharing.css"],properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"575px"},height:{type:"sap.ui.core.CSSSize",defaultValue:"605px"},feedType:{type:"string",defaultValue:F.object},groupIds:{type:"string"},object:{type:"object"},businessObject:{type:"object"}},aggregations:{},events:{}},systemSettings:{oDataServiceUrl:"/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV",oCollaborationHostRestService:"/sap/bc/ui2/smi/rest_tunnel/Jam//v1",oCollaborationHostODataService:"/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData"},init:function(){this.oCommonUtil=new C();this.oJamUtil=new J();this.oLangBundle=this.oCommonUtil.getLanguageBundle();this.sJamUrl=undefined;this.sJamToken=undefined;this.oOdataModel=undefined;this.oODataUtil=undefined;this.oBusinessObject={};U.prototype.init.apply(this);},setSettings:function(s){if(s){this.setFeedType(s.feedType);this.setGroupIds(s.groupIds);this.setObject(s.object);this.setBusinessObject(s.businessObject);}else{var E=new Error("Settings object is undefined");q.sap.log.error(E.stack);}},open:function(){this._logComponentProperties();try{this._validateInputParameters(this.mProperties);this._createFeedDialog();this._requestWidgetData();this.oFeedDialog.open();}catch(E){q.sap.log.error(E.stack);this.oCommonUtil.displayError();}},onBeforeRendering:function(){},onAfterRendering:function(){},render:function(r){},_requestWidgetData:function(){var s=this._getCSRFToken();var f=this;var g=true;var h=this.systemSettings.oCollaborationHostRestService;this._initOData();if(this.getObject()){this._getObjectWithoutMapping();}else if(this.getBusinessObject()){this._getObjectWithMapping();}var i=function(){if(this.readyState==4){if(this.status==201){f.sJamToken=this.responseXML.getElementsByTagName('single_use_token')[0].attributes[0].value;if(f.sJamUrl&&f.oBusinessObject.odata_url&&f.oBusinessObject.metadata_url){f._createFeedView();f.oFeedDialog.addContent(f.oFeedView);setTimeout(function(){f.oFeedDialog.setBusy(false);},3000);}}else{var E="The single use token from SAP Jam was not returned successfully";q.sap.log.error(E,"","sap.collaboration.components.utils.JamUtil.getJamSinglelUseTokens()");if(f.oFeedDialog.isOpen()===true){f.oFeedDialog.close();}f.oCommonUtil.displayError();}}};this.oJamUtil.getJamSinglelUseTokens(h,i,g,s);},_getObjectWithoutMapping:function(){var s=this;var f=true;var g=[];var p=function(i){s._parseBatchResults(i);if(s.sJamToken){s._createFeedView();s.oFeedDialog.addContent(s.oFeedView);setTimeout(function(){s.oFeedDialog.setBusy(false);},3000);}};var h=function(E){q.sap.log.error(E,"","sap.collaboration.components.fiori.feed.dialog.Component._getObjectWithoutMapping(), fnBatchErrorCallback()");throw E;};g=this._createBatchRequests();this.oODataUtil.executeODataBatchRequest(this.oOdataModel,g,p,f,h);},_getObjectWithMapping:function(){var s=this;var g=new q.Deferred();g.done(function(j){s.sJamUrl=j;});var f=new q.Deferred();f.done(function(m){s._setMappedObject(m);});q.when(g,f).fail(function(S){if(s.oFeedDialog&&s.oFeedDialog.isOpen()){s.oFeedDialog.close();}s.oCommonUtil.displayError();});this.oODataUtil.getJamUrl(this.oOdataModel,g);this.oODataUtil.getExternalObjectMapping(this.oOdataModel,this.getBusinessObject(),f);},_setMappedObject:function(m){var s=this;this.oBusinessObject.id=m.Exid;this.oBusinessObject.type=m.ObjectType;this.oBusinessObject.odata_url=this.oBusinessObject.id;this.oBusinessObject.metadata_url=this.oBusinessObject.type;if(this.sJamToken){this._createFeedView();this.oFeedDialog.addContent(this.oFeedView);setTimeout(function(){s.oFeedDialog.setBusy(false);},3000);}},_initOData:function(){var f=true;var o=this.systemSettings.oDataServiceUrl;if(!this.oOdataModel){this.oOdataModel=new a(o,f);}if(!this.oOdataModel.oMetadata.oMetadata){var E=new Error("Metadata is undefined");q.sap.log.error(E,"","sap.collaboration.components.fiori.feed.dialog.Component._requestWidgetData()");throw E;}if(!this.oODataUtil){this.oODataUtil=new O();}},_getCSRFToken:function(){var s="";var o=this.systemSettings.oCollaborationHostODataService;var f=function(g){if(this.readyState==4){if(this.status==200){s=this.getResponseHeader('x-csrf-token');}}};this.oJamUtil.getCSRFToken(o,f,false);return s;},_createBatchRequests:function(){var s=this;var f=[];if(!s.sJamUrl){f.push(s.oODataUtil.createJamUrlBatchOperation(s.oOdataModel));}f=f.concat(s._createExternalUrlBatchRequest(s.oODataUtil,s.getObject()));return f;},_createExternalUrlBatchRequest:function(o,f){var s=this;var g=[];if(o&&f){if(f.id){g.push(o.createExternalOdataUrlBatchOperation(s.oOdataModel,f.id));}if(f.type){g.push(o.createExternalOdataUrlBatchOperation(s.oOdataModel,f.type));}}return g;},_parseBatchResults:function(f){var s=this;var i=0;if(!s.sJamUrl){if(f[i].error){throw new Error(f[i].error);}else{s.sJamUrl=f[i][s.oODataUtil.OdataUtilConstants.EndPoint.GetCollaborationHostUrl].URL;}i++;}if(f[i].error){throw new Error(f[i].error);}else{s.oBusinessObject.id=f[i][s.oODataUtil.OdataUtilConstants.EndPoint.GetExternalODataURL].URL;s.oBusinessObject.odata_url=s.oBusinessObject.id;}i++;if(f[i].error){throw new Error(f[i].error);}else{s.oBusinessObject.type=f[i][s.oODataUtil.OdataUtilConstants.EndPoint.GetExternalODataURL].URL;s.oBusinessObject.metadata_url=s.oBusinessObject.type;}},_createFeedView:function(){var s=this;if(!s.oFeedView){s.oFeedView=sap.ui.view({id:s.getId()+"_FeedView",height:"100%",viewData:{controlId:s.getId(),jamURL:s.sJamUrl,jamToken:s.sJamToken,appType:A.widget,feedType:s.getFeedType(),groupIds:s.getGroupIds(),businessObject:s.oBusinessObject,langBundle:s.oLangBundle},type:d.JS,viewName:"sap.collaboration.components.fiori.feed.commons.Detail"});}else{s.oFeedView.getController().sFeedType=s.getFeedType();s.oFeedView.getViewData().groupIds=s.getGroupIds();s.oFeedView.getController().oBusinessObject=s.oBusinessObject;}},_createFeedDialog:function(){var s=this;if(!this.oFeedDialog){this.oFeedDialog=new D(this.getId()+"FeedDialog",{title:this.oLangBundle.getText("FEED_DIALOG_TITLE"),stretch:false,contentWidth:this.getWidth(),contentHeight:this.getHeight(),content:[],endButton:new B({text:this.oLangBundle.getText("CLOSE_BUTTON_TEXT"),press:function(){s.oFeedDialog.close();}})});if(b.system.phone){this.oFeedDialog.setStretch(true);}}this.oFeedDialog.setBusy(true);},_validateInputParameters:function(i){var E;if(!i){E=new Error("Input paremeters are undefined");q.sap.log.error(E.stack);throw E;}else if(i.businessObject){var f=i.businessObject;if(q.isEmptyObject(f)){E=new Error("Business Object is empty");q.sap.log.error(E.stack);throw E;}if(!f.appContext){E=new Error("Application context is undefined");q.sap.log.error(E.stack);throw E;}if(!f.odataServicePath){E=new Error("OData Service Path is undefined");q.sap.log.error(E.stack);throw E;}if(!f.collection){E=new Error("Collection is undefined");q.sap.log.error(E.stack);throw E;}if(!f.key){E=new Error("Key is undefined");q.sap.log.error(E.stack);throw E;}if(!f.name){E=new Error("Name is undefined");q.sap.log.error(E.stack);throw E;}}else if(i.object){var o=i.object;if(q.isEmptyObject(o)){E=new Error("Business Object is empty");q.sap.log.error(E.stack);throw E;}if(!o.id){E=new Error("Object is undefined");q.sap.log.error(E.stack);throw E;}if(!o.type){E=new Error("Missing Object Type");q.sap.log.error(E.stack);throw E;}}else{E=new Error("Neither an Object nor a Business Object was passed");throw E;}},_logComponentProperties:function(){q.sap.log.debug("Share Component properties:","","sap.collaboration.components.fiori.dialog.Component._logComponentProperties()");q.sap.log.debug("width: "+this.getWidth());q.sap.log.debug("height: "+this.getHeight());q.sap.log.debug("oDataServiceUrl: "+this.systemSettings.oDataServiceUrl);q.sap.log.debug("feedType: "+this.getFeedType());q.sap.log.debug("groupIds: "+this.getGroupIds());q.sap.log.debug("object: "+JSON.stringify(this.getObject()));q.sap.log.debug("businessObject: "+JSON.stringify(this.getBusinessObject()));}});return e;});
