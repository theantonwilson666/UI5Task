/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['./helper/AttachmentsUtil','./helper/ShareUtil','sap/collaboration/components/utils/CommonUtil','sap/collaboration/components/utils/OdataUtil','sap/ui/core/mvc/Controller','jquery.sap.global','sap/ui/model/odata/ODataModel','sap/ui/model/odata/CountMode','sap/m/StandardListItem','sap/m/library'],function(A,S,C,O,a,q,b,c,d,m){"use strict";var L=m.ListType;sap.ui.controller("sap.collaboration.components.fiori.sharing.Sharing",{onInit:function(){this.oNoteTextArea=this.getView().oNoteTextArea;this.oAttachmentsInput=this.getView().oAttachmentsInput;this.oTargetFolderInput=this.getView().oTargetFolderInput;this.oODataUtil=undefined;this.sPrefixId=this.getView().getViewData().controlId;this.oLangBundle=this.getView().getViewData().langBundle;this.iJamGroupsCount=0;this.sObjectId=this.getView().getViewData().objectId;this.sObjectShare=this.getView().getViewData().objectShare;this.oObjectDisplay=this.getView().getViewData().objectDisplay;this.oExternalObject=undefined;this.oMappedExternalObject=undefined;this.sMemberEmail=undefined;this.oSharingDialog=this.getView().getViewData().sharingDialog;this.fNoGroupsCallBack=this.getView().getViewData().noGroupsCallBack;this.oCommonUtil=new C();this.oAttachments=this.getView().getViewData().attachments;this.bAttachmentsCB=false;this.aFiles=[];this.aSelectedFiles=[];this.sSelectedFolderId='';this.oItemTemplate=undefined;this.oSelectedGroup=undefined;this.gettingSuggestions=undefined;},onBeforeRendering:function(){try{this.sSelectedGroupId='';this.sSelectedGroupName='';if(!this.oSMIODataModel){this.initializeOdataModel();}if(!this.oODataUtil){this.initializeOdataUtils();}if(!this.oAttachmentsUtil){this.initializeAttachmentsUtil();}this.initializeShareUtil();this.preRenderSetup();this.fetchData();this.clearAttachmentsData();this.oAttachments=this.getView().getViewData().attachments;if(this.oAttachments&&this.oAttachments.attachmentsArray){this.aFiles=this.oAttachments.attachmentsArray;if(this.aFiles.length>0){this.getView().oAttachmentsInput.setEnabled(true);}else{this.getView().oAttachmentsInput.setEnabled(false);}if(this.oFileSelectionDialog){var o=this.oAttachmentsUtil.createAttachmentsModel(this.aFiles);this.oFileSelectionDialog.setModel(o);}this.showAttachmentsFields(true);}else{this.showAttachmentsFields(false);}if(this.sObjectId!=this.getView().getViewData().objectId){this.sObjectId=this.getView().getViewData().objectId;}if(this.sObjectShare!=this.getView().getViewData().objectShare||sap.ui.getCore().byId(this.sPrefixId+"_NoteTextArea").setValue!==this.getView().getViewData().objectShare){this.sObjectShare=this.getView().getViewData().objectShare;sap.ui.getCore().byId(this.sPrefixId+"_NoteTextArea").setInitialValue(this.sObjectShare);}if(this.oObjectDisplay!=this.getView().getViewData().objectDisplay){if(this.oObjectDisplay!=undefined){this.getView().oSharingVBox.removeItem(0);}this.oObjectDisplay=this.getView().getViewData().objectDisplay;this.getView().oSharingVBox.insertItem(this.oObjectDisplay,0);}}catch(e){if(this.oSharingDialog){throw e;}this.oCommonUtil.displayError(e);}},onAfterRendering:function(){setTimeout(function(){sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect").focus();}.bind(this),1);},onExit:function(){this.getView().destroyContent();},preRenderSetup:function(){this.getView().oGroupSelect.setEnabled(false);this.setGroupSelectionText("");if(this.oAttachments&&this.oAttachments.attachmentsArray){this.getView().oTargetFolderInput.setEnabled(false);}this.getView().oNoteTextArea.setEnabled(false);if(this.oSharingDialog){this.oSharingDialog.getButtons()[0].setEnabled(false);this.oSharingDialog.getButtons()[1].setEnabled(false);}},fetchData:function(){var s=this;var g=new q.Deferred();g.done(function(i){s.iJamGroupsCount=i;if(s.iJamGroupsCount>0){s.postFetchSetup();setTimeout(function(){s.getView().getContent()[0].getItems()[1].getContent()[1].focus();},50);}else{if(s.fNoGroupsCallBack){s.fNoGroupsCallBack();}}});var e=new q.Deferred();e.done(function(u){if(!s.sJamUrl){s.sJamUrl=u;}});var f=new q.Deferred();f.done(function(i){s.oMappedExternalObject=i;});f.fail(function(){s.oMappedExternalObject=undefined;q.sap.log.debug('Mapping Internal BO to External BO failed');});var h=new q.Deferred();h.done(function(i){if(!s.sMemberEmail){s.sMemberEmail=i;}});q.when(g,e,f).fail(function(E){if(s.oSharingDialog){s.oSharingDialog.close();}if(E.statusCode===401||E.statusCode===403){s.oCommonUtil.displayError(s.oLangBundle.getText("SHARE_AUTHORIZATION_FAILURE_MSG"));}else{s.oCommonUtil.displayError();}});this.oJamODataModel.read('/Groups/$count',{success:function(D,r){g.resolve(parseInt(r.body));},error:function(E){g.reject(E.response);}});this.oJamODataModel.read('/Self',{success:function(D,r){h.resolve(this.oCommonUtil.getODataResult(D).Email);}.bind(this),error:function(E){h.reject(E.response);}});if(!this.sJamUrl){this.oSMIODataModel.read('/GetCollaborationHostURL',{success:function(D,r){e.resolve(D.GetCollaborationHostURL.URL);},error:function(E){e.reject(E.response);}});}else{e.resolve();}this.oExternalObject=this.getView().getViewData().externalObject;if(this.oExternalObject){this.oSMIODataModel.read('/MapInternalBOToExternalBO',{urlParameters:{ApplicationContext:"'"+s.oExternalObject.appContext+"'",ODataCollection:"'"+s.oExternalObject.collection+"'",ODataKeyPredicate:"'"+s.oExternalObject.key+"'",ODataServicePath:"'"+s.oExternalObject.odataServicePath+"'"},success:function(D,r){f.resolve(D.MapInternalBOToExternalBO);},error:function(E){f.reject(E.response);}});}},postFetchSetup:function(){this.setGroupSelectionEnabled(true);},initializeOdataModel:function(){var e=true;this.sSMIODataServiceUrl=this.getView().getViewData().odataServiceUrl;this.oSMIODataModel=new b(this.sSMIODataServiceUrl,e);this.sJamODataServiceUrl=this.getView().getViewData().collaborationHostODataServiceUrl;this.oJamODataModel=new b(this.sJamODataServiceUrl,e);this.oJamODataModel.setDefaultCountMode(c.Inline);},initializeOdataUtils:function(){this.oODataUtil=new O();},initializeAttachmentsUtil:function(){this.oAttachmentsUtil=new A(this.oLangBundle,this.oODataUtil,this.oJamODataModel);},initializeShareUtil:function(){this.oShareUtil=new S(this.oLangBundle,this.oODataUtil,this.oSMIODataModel,this.oCommonUtil,this.oJamODataModel,this.getView().getViewData().collaborationHostRestService);},setGroupSelectionText:function(t){var g=sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect");g.setValue(t);},setGroupSelectionEnabled:function(e){var g=sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect");g.setEnabled(e);},setFolderSelectionEnabled:function(e){this.oTargetFolderInput.setEnabled(e);},showAttachmentsFields:function(v){this.getView().AttachmentsInputLayout.setVisible(v);this.getView().oTargetFolderInputLayout.setVisible(v);this.getView().oAttachmentCB.setVisible(v);},clearAttachmentsData:function(){this.aFiles=[];this.aSelectedFiles=[];this.sSelectedFolderId='';this.bAttachmentsCB=false;this.oAttachmentsInput.setValue("");this.getView().oAttachmentCB.setSelected(this.bAttachmentsCB);this.getView().oAttachmentCB.setEnabled(false);this.oTargetFolderInput.setValue("");if(this.oFolderSelectionDialog){this.oAttachmentsUtil.resetFolderSelection(this.getSelectedGroupId());}},onAttachmentsValueHelpPress:function(o){if(this.oSharingDialog){var s=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var i=this.oSharingDialog.getContent()[0].getDomRef().offsetWidth;}if(!this.oFileSelectionDialog){var e=this.oAttachmentsUtil.createAttachmentsModel(this.aFiles);this.oFileSelectionDialog=this.oAttachmentsUtil.createFileSelectionDialog(this.sPrefixId,e,this.onFileSelectionDialogConfirm(),i,s);}var B=this.oFileSelectionDialog.getBinding("items");B.filter([]);this.oFileSelectionDialog.open();},onFileSelectionDialogConfirm:function(){var s=this;return function(e){s.aSelectedFiles=[];var f=e.getParameter("selectedContexts");for(var i=0;i<f.length;i++){s.aSelectedFiles.push(f[i].getObject());}if(s.aSelectedFiles&&s.aSelectedFiles.length>0){s.postFileSelectionSetup(true);}else{s.postFileSelectionSetup(false);}};},postFileSelectionSetup:function(f){if(f===true){if(this.aSelectedFiles.length==1){this.oAttachmentsInput.setValue(this.oLangBundle.getText("SELECTED_ATTACHMENT_FIELD_TEXT",[this.aSelectedFiles.length]));}else{this.oAttachmentsInput.setValue(this.oLangBundle.getText("SELECTED_ATTACHMENTS_FIELD_TEXT",[this.aSelectedFiles.length]));}this.getView().oAttachmentCB.setEnabled(true);if(this.sSelectedGroupId!==''){this.setFolderSelectionEnabled(true);}}else{this.oAttachmentsInput.setValue("");this.bAttachmentsCB=false;this.getView().oAttachmentCB.setSelected(this.bAttachmentsCB);this.postAttachmentCheckBoxSelection();this.getView().oAttachmentCB.setEnabled(false);this.setFolderSelectionEnabled(false);}},onGroupSelectValueHelpPress:function(e){if(!this.oItemTemplate){this.oItemTemplate=new d({title:{parts:["Name","GroupType"],formatter:function(n,g){return n+" ("+g+")";}},type:L.Active,tooltip:"{Name}"});}if(this.oSharingDialog){var s=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var i=this.oSharingDialog.getContent()[0].getDomRef().offsetWidth;}if(!this.oGroupSelectionDialog){this.oGroupSelectionDialog=this.oShareUtil.createGroupSelectionDialog(this.sPrefixId,this.oItemTemplate,this._onGroupSelectionDialogConfirm(),i,s,this.oJamODataModel);}else{this.oGroupSelectionDialog.setModel(this.oJamODataModel);this.oGroupSelectionDialog.bindAggregation("items","/Groups",this.oItemTemplate);}this.oGroupSelectionDialog.open();},_onGroupSelectionDialogConfirm:function(){var s=this;return function(e){var f=e.getParameter("selectedContexts");for(var i=0;i<f.length;i++){s.oSelectedGroup=f[i].getObject();}if(s.oSelectedGroup){s.postGroupSelectionSetup(true);}else{s.postGroupSelectionSetup(false);}};},postGroupSelectionSetup:function(g){if(g===true){if(this.oSelectedGroup!==undefined){this.sSelectedGroupId=this.oSelectedGroup.Id.toString();this.sSelectedGroupName=this.oSelectedGroup.Name.toString();this.setGroupSelectionText(this.sSelectedGroupName);}if(this.oAttachments&&this.oAttachments.attachmentsArray){this.sSelectedFolderId='';this.oAttachmentsUtil.resetFolderSelection(this.getSelectedGroupId());var s=this.oAttachmentsUtil.getCurrentFolder();this.oTargetFolderInput.setValue(s.name);}if(this.aSelectedFiles&&this.aSelectedFiles.length>0){this.setFolderSelectionEnabled(true);}if(this.bAttachmentsCB===false){this.getView().oNoteTextArea.setEnabled(true);}if(this.oSharingDialog){this.oSharingDialog.getButtons()[0].setEnabled(true);this.oSharingDialog.getButtons()[1].setEnabled(true);}}else{this.setFolderSelectionEnabled(false);this.getView().oNoteTextArea.setEnabled(false);}},onTargetFolderValueHelpPress:function(o){if(this.oSharingDialog){var s=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var i=this.oSharingDialog.getContent()[0].getDomRef().offsetWidth;}if(!this.oFolderSelectionDialog){this.oFolderSelectionDialog=this.oAttachmentsUtil.createFolderSelectionDialog(this.sPrefixId,this.getSelectedGroupId(),this.onFolderSelectionDialogConfirm(),this.onFolderSelectionDialogCancel(),i,s);this.sSelectedFolderId='';}this.oFolderSelectionDialog.getContent()[0].oController.setFolderSelectionDialogTitle(this.oTargetFolderInput.getValue());this.oFolderSelectionDialog.open();},onFolderSelectionDialogConfirm:function(e){var s=this;return function(){var o=s.oAttachmentsUtil.getCurrentFolder();s.sSelectedFolderId=o.id;s.oTargetFolderInput.setValue(o.name);};},onFolderSelectionDialogCancel:function(e){var s=this;return function(e){s.oAttachmentsUtil.setCurrentFolderId(s.sSelectedFolderId);};},onAttachmentCheckBoxSelected:function(){this.bAttachmentsCB=this.getView().oAttachmentCB.getSelected();this.postAttachmentCheckBoxSelection();},atMentionsButtonPressed:function(){this.getView().oNoteTextArea.atMentionsButtonPressed();},onSuggestion:function(e){if(this.gettingSuggestions){this.gettingSuggestions.abort();}var t=this;var v=e.getParameter("value");var n=this.getView().oNoteTextArea;if(v.trim()===""){n.showSuggestions([]);n.setSuggestionHeight(undefined);return;}var g=this.getSelectedGroupId();var p="/Members_Autocomplete";var P={"async":true,"urlParameters":{"Query":"'"+v+"'","GroupId":"'"+g+"'","$top":"4"},"success":function(D,r){var j=t.oCommonUtil.getODataResult(D);if(j.length===0){n.closeSuggestionPopover();n.setSuggestionHeight(undefined);}else{var s=[];var J=j.length;for(var i=0;i<J;i++){s.push({fullName:j[i].FullName,email:j[i].Email,userImage:t._buildThumbnailImageURL(j[i].Id)});}n.showSuggestions(s);J>=3?n.setSuggestionHeight("12rem"):n.setSuggestionHeight(undefined);}},"error":function(E){q.sap.log.error("Failed to get suggestions: "+E.statusText);}};this.gettingSuggestions=this.oJamODataModel.read(p,P);},postAttachmentCheckBoxSelection:function(){if(this.bAttachmentsCB===true){this.getView().oNoteTextArea.setEnabled(false);}else{if(this.sSelectedGroupId!==''){this.getView().oNoteTextArea.setEnabled(true);}}},getSharingData:function(){var f;if((this.oNoteTextArea.getValue()!==undefined&&this.oNoteTextArea.getValue()!=="")||(this.sObjectId!==undefined&&this.sObjectId!=="")){f={note:this.oNoteTextArea.convertTextWithFullNamesToEmailAliases(),uiUrl:this.sObjectId};}if(JSON.stringify(this.oExternalObject)==='{}'){this.oExternalObject=undefined;}return{feedContent:f,groupId:this.getSelectedGroupId(),folderId:this.getSelectedFolderId(),aFilesToUpload:this.aSelectedFiles,externalObject:this.oExternalObject,mappedExternalObject:this.oMappedExternalObject,groupName:this.getSelectedGroupName(),memberEmail:this.sMemberEmail};},getSelectedGroupId:function(){return this.sSelectedGroupId;},getSelectedGroupName:function(){return this.sSelectedGroupName;},getSelectedFolderId:function(){return this.sSelectedFolderId;},shareToJam:function(){var s=this.getSharingData();var e=this;if(s.aFilesToUpload.length===0&&(!s.feedContent||(!s.feedContent.uiUrl&&s.feedContent.note.trim()===""))&&!s.externalObject){var r=e.oLangBundle.getText("SHARING_NOTHING_TO_SHARE_MSG");this.oCommonUtil.showMessage(r,{duration:3000,autoclose:false});}else{if(!this.bAttachmentsCB){this.oShareUtil.shareBusinessObject(s);}if(s.aFilesToUpload.length>0){this.oShareUtil.uploadAttachments(s);var r=this.oLangBundle.getText("SHARING_ACKNOWLEDGMENT_MSG");setTimeout(function(){e.oCommonUtil.showMessage(r,{duration:3000,width:"30em",autoClose:false});},500);}}},_buildThumbnailImageURL:function(u){return this.oJamODataModel.sServiceUrl+"/Members('"+q.sap.encodeURL(u)+"')/ThumbnailImage/$value";}});});
