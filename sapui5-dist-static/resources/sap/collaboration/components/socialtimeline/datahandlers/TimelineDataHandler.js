/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
sap.ui.define(['sap/ui/base/Object','jquery.sap.global','sap/collaboration/components/socialtimeline/filter/FilterType'],function(B,q,F){"use strict";var T=B.extend("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler",{constructor:function(b,j,s,S,t,p,a,c){this._oLogger=q.sap.log.getLogger("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler");this._oFilterConstants=new F();this._oBusinessObjectMap=b;this._oJamDataHandler=j;this._oServiceDataHandler=S;this._oTimelineTermsUtility=t;this._oSMIntegrationDataHandler=s;this._bSocialFeaturesEnabled=a;this._bBackendFeaturesEnabled=c;this._iPageSize=p;this._iPageSize=p;this._iTimelineEntriesPageSize=p;this._iTimelineEntriesSkip=0;this._iFeedEntriesPageSize=p*2;this._sBusinessObjectKey="";this._sFeedEntriesNextLink="";this._fCustomActionCallBack=b.customActionCallback;this._aTimelineEntries=[];this._aFeedEntries=[];this._oExternalBO={};this._oMemberDataBuffer={};this._oExternalBOMapping={};},setBusinessObject:function(o){this._setBusinessObjectValues(o);this._resetBusinessObjectData();this.getExternalBOMapping();},reset:function(){this._iTimelineEntriesSkip=0;this._iTimelineEntriesPageSize=this._iPageSize;this._sFeedEntriesNextLink="";this._aTimelineEntries=[];this._aFeedEntries=[];},getTimelineData:function(f,b){var p=q.Deferred();var t=this;if(f.type===this._oFilterConstants.FILTER_TYPE.feedUpdates){if(b){this._setBusinessObjectValues(b);this._resetBusinessObjectData();p=this.getExternalBOMapping().then(function(){return t._getExternalObjectJamOnlyFeedEntries();});}else{p=this._getExternalObjectFeedEntries();}}else if(f.type===this._oFilterConstants.FILTER_TYPE.systemUpdates||f.type===this._oFilterConstants.FILTER_TYPE.custom){p=this._getTimelineEntries(f);}else{this._oLogger.error("The filter type is invalid.");p.resolve([]);}return p.promise();},getExternalBOMapping:function(){var i={"appContext":this._oBusinessObjectMap.applicationContext,"collection":this._oBusinessObjectMap.collection,"name":this._sBusinessObjectName,"key":this._sBusinessObjectKey,"odataServicePath":this._oBusinessObjectMap.servicePath};var p=this._oSMIntegrationDataHandler.mapInternalBOToExternalBO(i).then(function(e){this._oExternalBOMapping=e;this._oExternalBOMapping.Name=this._sBusinessObjectName;}.bind(this));return p.promise();},_setBusinessObjectValues:function(b){this._sBusinessObjectKey=b.key;this._sBusinessObjectName=b.name;},_resetBusinessObjectData:function(){this.reset();if(this._oTimelineEntriesReadRequest){this._oTimelineEntriesReadRequest.abort();}if(this._oFeedEntriesReadRequest){this._oFeedEntriesReadRequest.abort();}},_getExternalObjectFeedEntries:function(){var t=this;var p=this._oJamDataHandler.getExternalObject(this._oExternalBOMapping).then(function(e){t._oExternalBO=e;if(t._sFeedEntriesNextLink==undefined){var g=q.Deferred();g.resolve({"results":[]},null);return{request:null,promise:g};}else if(t._sFeedEntriesNextLink==""){return t._oJamDataHandler.getFeedEntries(e.Id);}else{return t._oJamDataHandler.getFeedEntries(null,t._sFeedEntriesNextLink);}}).then(function(g){t._oFeedEntriesReadRequest=g.request;return g.promise;}).then(function(f){t._sFeedEntriesNextLink=f.__next;return f.results;}).then(function(f){return t._mapFeedEntriesToTimelineItems(f);});return p.promise();},_getExternalObjectJamOnlyFeedEntries:function(){var g=function(){var p=q.Deferred();if(this._sFeedEntriesNextLink===undefined){var a=q.Deferred();a.resolve({"results":[]},null);p={request:null,promise:a};}else if(this._sFeedEntriesNextLink===""){p=this._oJamDataHandler.getExternalObjectByExidAndObjectType(this._oExternalBOMapping);}else{p=this._oJamDataHandler.getExternalObjectByExidAndObjectType(null,this._sFeedEntriesNextLink);}return p.promise;}.bind(this);var p=g().then(function(e){this._oExternalBO=e.results;var f=e.results.FeedEntries;this._sFeedEntriesNextLink=f.__next;return this._mapFeedEntriesToTimelineItems(f.results);}.bind(this));return p.promise();},_getTimelineEntries:function(f){var t=this;var b=f.type;if(b!==this._oFilterConstants.FILTER_TYPE.custom){b=undefined;}else{b=f.value;}var r=this._oServiceDataHandler.readTimelineEntries(this._oBusinessObjectMap.collection,this._sBusinessObjectKey,b,this._iTimelineEntriesSkip,this._iTimelineEntriesPageSize);this._oTimelineEntriesReadRequest=r.request;var g=r.promise.then(function(a){var c=a.results;t._iTimelineEntriesPageSize=c.length;t._iTimelineEntriesSkip+=t._iTimelineEntriesPageSize;return t._mapTimelineEntriesToTimelineItems(c);}).then(function(a){if(t._bSocialFeaturesEnabled===true){return t._fillPicturesForTimelineItems(a);}return a;});return g.promise();},_fillPicturesForTimelineItems:function(t){var a=this;var p=q.Deferred();var e=[];t.forEach(function(o){if(!o.timelineItemData.userPicture){e.push(o.timelineItemData.userEmail);}});var u=e.filter(function(b,i){return e.indexOf(b)==i;});if(u.length>0){var g=this._oJamDataHandler.getUserInfoBatch(u);g.promise.done(function(U){var b=q.grep(U,function(o){return o.results.length>0;});b.forEach(function(o){a.addUserInfoToBuffer(o.results[0]);});t.forEach(function(o){if(!o.timelineItemData.userPicture){o.timelineItemData.userPicture=a.getUserPicture(o.timelineItemData.userEmail);}});p.resolve(t);});g.promise.fail(function(E){p.resolve(t);});}else{p.resolve(t);}return p.promise();},_getAtMentions:function(f){var a={};var g=this._oJamDataHandler.getAtMentions(f.Id);g.promise.done(function(j,r){var J=j.results;for(var i=0;i<J.length;i++){if(J[i]){a[i]=J[i];}}});g.promise.fail(function(){this._oLogger.error('Failed to get the @mentions.');});return a;},_mapFeedEntriesToTimelineItems:function(f){var t=this;var o=[];f.forEach(function(a){var b={};b.timelineItemData=t._mapFeedEntryToTimelineItem(a);b._feedEntryData=a;if(a.ConsolidatedCount>1){b._feedEntryData._consolidatedUrl="<collaboration_host_url>"+a.Id;}o.push(b);});return o;},_mapFeedEntryToTimelineItem:function(f){var P="sap-icon://post";if(!this.getUserInfoFromBuffer(f.Creator.Email)){this.addUserInfoToBuffer(f.Creator);}var t={feedId:f.Id,dateTime:f.CreatedAt,userName:f.Creator.FullName,userEmail:f.Creator.Email,title:f.Action,text:f.Text,textWithPlaceholders:f.TextWithPlaceholders,replyCount:f.RepliesCount,icon:P};t.userPicture=this.getUserPicture(t.userEmail);return t;},_mapTimelineEntriesToTimelineItems:function(t){var a=this;var o=[];t.forEach(function(b){var c={};c.timelineItemData=a._mapTimelineEntryToTimelineItem(b);var C=undefined;if(a._fCustomActionCallBack){C=a._fCustomActionCallBack(b);if(C){var d=true;if(!q.isArray(C)){a._oLogger.error("The type defined for the return statement of the function 'customActionCallback' is "+typeof(C)+", expected type is array. Custom actions have been removed.");d=false;}else{for(var i=0;i<C.length;i++){if(typeof(C[i])!=='object'){a._oLogger.error("The function 'customActionCallback' returned the item "+JSON.stringify(C[i])+" of type "+typeof(C[i])+", expected type is object. Custom actions have been removed.");d=false;break;}else if(!C[i].key||!C[i].value){a._oLogger.error("The function 'customActionCallback' returned the item "+JSON.stringify(C[i])+" with the property 'key' or 'value' as undefined. Custom actions have been removed.");d=false;break;}else if(typeof(C[i].value)!=='string'){a._oLogger.error("The function 'customActionCallback' returned the item "+JSON.stringify(C[i])+" with the property 'value' as type "+typeof(C[i].value)+", expected type is string. Custom actions have been removed.");d=false;break;}}}if(d){C.oDataEntry=b;c.timelineItemData.customActionData=C;}}}o.push(c);});return o;},_mapTimelineEntryToTimelineItem:function(t){var o=this._oTimelineTermsUtility.getTimelineEntryFields(this._oBusinessObjectMap.collection);var a={dateTime:t[o.TimeStamp],userName:t[o.ActorName],userEmail:t[o.ActorExtID].toLowerCase(),title:t[o.ActionText],text:t[o.SummaryText],icon:t[o.Icon],timelineEntryDetails:this._processTimelineEntryDetails(t[o.TimelineDetailNavigationPath].results,this._oBusinessObjectMap.collection)};a.userPicture=this.getUserPicture(a.userEmail);return a;},_processTimelineEntryDetails:function(t,e){var a=this;var b=[];var o=a._oTimelineTermsUtility.getTimelineEntryDetailFields(e);t.forEach(function(c){var d={};d.afterValue=c[o.AfterValue];d.beforeValue=c[o.BeforeValue];d.changeType=c[o.ChangeType];d.propertyLabel=c[o.PropertyLabel];b.push(d);});return b;},getUserPicture:function(u){var m=this.getUserInfoFromBuffer(u);if(!m){return"";}return m.picture;},buildImageUrl:function(o){return this._oJamDataHandler._oCollabModel.sServiceUrl+"/"+o.__metadata.uri+"/ThumbnailImage/$value";},addUserInfoToBuffer:function(m){var u=this.buildImageUrl(m);var U=m.Email.toLowerCase();this._oMemberDataBuffer[U]={"email":U,"fullname":m.FullName,"id":m.Id,"address":m.MemberProfile.Address,"title":m.Title,"role":m.Role,"picture":u};},getUserInfoFromBuffer:function(u){var U=u.toLowerCase();return this._oMemberDataBuffer[U];},getCurrentExternalBO:function(){return this._oExternalBO;}});return T;});
