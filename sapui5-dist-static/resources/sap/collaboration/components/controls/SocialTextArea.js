/*
* ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
*/
sap.ui.define(['jquery.sap.global','sap/ui/model/json/JSONModel','sap/m/TextArea','sap/m/Popover','sap/m/List','sap/m/StandardListItem','./SuggestionUtility','../utils/LanguageBundle','sap/m/library','sap/ui/Device'],function(q,J,T,P,L,S,a,b,m,D){var c=m.ListSeparators;var d=m.ListMode;var e=m.PlacementType;q.sap.includeStyleSheet(q.sap.getResourcePath("sap/collaboration/components/resources/css/SocialTextArea",".css"));var f=T.extend("sap.collaboration.components.controls.SocialTextArea",{metadata:{library:"sap.collaboration",properties:{initialValue:{type:"string",group:"Data",defaultValue:null},enableNotifyAll:{type:"boolean",group:"Behavior",defaultValue:true},suggestionPlacement:{type:"sap.m.PlacementType",group:"Misc",defaultValue:e.VerticalPreferedBottom},suggestionHeight:{type:"sap.ui.core.CSSSize",group:"Appearance"},},events:{suggest:{parameters:{value:{type:"string"}}},afterSuggestionClose:{}}},renderer:{}});f.prototype.init=function(){T.prototype.init.apply(this);this.addStyleClass("sapCollaborationSocialTextArea");this._sTextAreaOldValue="";this._sTextAreaCurrentValue="";this._aAtMentionBuffer=[];this._mCurrentAtMention=undefined;this._oModel=new J();var s=new S({title:"{fullName}",description:"{email}",icon:"{userImage}"});this._oList=new L(this.getId()+"-list",{mode:d.SingleSelectMaster,rememberSelections:false,showSeparators:c.None}).setModel(this._oModel).bindItems("/",s);this._oPop=new P(this.getId()+"-pop",{showHeader:false,showArrow:false,content:[this._oList],}).setInitialFocus(this);this._oSuggestionUtil=a;this._oLangBundle=new b();this._oList.attachSelectionChange(this.onSelectionChange.bind(this));};f.prototype.exit=function(){this._oPop.destroy();this._oPop=undefined;this._oSuggestionUtil=undefined;};f.prototype.onBeforeRendering=function(){this._oPop.setPlacement(this.getSuggestionPlacement());this.getEnableNotifyAll()?this._oList.setProperty("noDataText",this._oLangBundle.getText("ST_NO_SUGGESTIONS",["@@notify"])):this._oList.setProperty("noDataText",this._oLangBundle.getText("ST_ADD_POST_NO_SUGGESTIONS"));};f.prototype.onAfterRendering=function(){T.prototype.onAfterRendering.apply(this);this._oPop.setContentWidth((q(this.getDomRef()).width()).toString()+"px");var E=q("#"+this.getId()).children()[0];if(E){q("#"+E.id).css({'height':'100%'});}q("#"+this.getId()).css({'padding-top':'0','padding-bottom':'0'});};f.prototype.oninput=function(g){T.prototype.oninput.apply(this,[g]);if(g.isMarked("invalid")){return;}this._sTextAreaCurrentValue=this.getValue();if(this._sTextAreaCurrentValue.trim()===""){this._aAtMentionBuffer=[];this.closeSuggestionPopover();}else{this._triggerSuggestions(this._sTextAreaCurrentValue,this._sTextAreaOldValue);}this._sTextAreaOldValue=this._sTextAreaCurrentValue;};f.prototype.onSelectionChange=function(g){var l=g.getParameter("listItem");var F=l.getProperty("title");var E=l.getProperty("description");this._sTextAreaCurrentValue=this._oSuggestionUtil.getTextAreaValueAfterSuggestionSelected(F,E,this._mCurrentAtMention,this._aAtMentionBuffer,this._sTextAreaCurrentValue,F==="@@notify");this.setValue(this._sTextAreaCurrentValue);this._sTextAreaOldValue=this._sTextAreaCurrentValue;this.closeSuggestionPopover();this.selectText(this._mCurrentAtMention.endIndex+2,this._mCurrentAtMention.endIndex+2);this._oList.removeSelections();};f.prototype.showSuggestions=function(s){if(s.length!==0&&s[s.length-1].fullName!=="@@notify"&&this.getEnableNotifyAll()){s.push({fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"});}if(s.length!==0){this._oPop.close();}this._oModel.setData(s);this._oPop.openBy(this);return this;};f.prototype.setInitialValue=function(t){this.setProperty("initialValue",t,true);this.setValue(t);this._aAtMentionBuffer=[];this._sTextAreaCurrentValue=t;this._sTextAreaOldValue=t;return this;};f.prototype.setSuggestionHeight=function(h){this.setProperty("suggestionHeight",h,true);this._oPop.setContentHeight(h);return this;};f.prototype.closeSuggestionPopover=function(){this._oPop.close();this.fireAfterSuggestionClose();return this;};f.prototype.clearText=function(){this._sTextAreaCurrentValue="";this._sTextAreaOldValue="";this._aAtMentionBuffer=[];this.setValue("");return this;};f.prototype.convertTextWithFullNamesToEmailAliases=function(){return this._oSuggestionUtil.convertTextWithFullNamesToEmailAliases(this.getValue(),this._aAtMentionBuffer);};f.prototype.atMentionsButtonPressed=function(){var C=this.getDomRef("inner").selectionStart;var A=this._oSuggestionUtil.atMentionsButtonPressed(this.getValue(),C);this.setValue(A.newValue);this._sTextAreaCurrentValue=this.getValue();this.focus();this.selectText(A.cursorPosition,A.cursorPosition);this._triggerSuggestions(this._sTextAreaCurrentValue,this._sTextAreaOldValue);this._sTextAreaOldValue=this._sTextAreaCurrentValue;return this;};f.prototype._triggerSuggestions=function(t,g){if(!D.system.phone){var o=this._oSuggestionUtil.getChangesInTextArea(t,g);if(o.operation==="addChar"){this._handleAddedCharacters(o,t);}else if(o.operation==="deleteChar"){this._handleDeletedCharacters(o,t,this._aAtMentionBuffer);}}};f.prototype._handleAddedCharacters=function(t,g){var h=t.changeIndex;var s=t.charactersChanged;var A=this._aAtMentionBuffer.length;var I=this.getEnableNotifyAll();if(I&&s[0]==="@"&&g[h-1]==="@"&&(g[h-2]===" "||g[h-2]==="\n"||g[h-2]===undefined)){this.showSuggestions([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}]);for(var i=0;i<A;i++){if(this._aAtMentionBuffer[i].startIndex===h-1){this._aAtMentionBuffer[i].endIndex+=s.length;}else if(h<this._aAtMentionBuffer[i].startIndex){this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[i],s.length);}}}else if(s[0]==="@"||(s[0]===" "&&s[1]==="@")){if(s[1]==="@"){h+=1;}var C=this._oSuggestionUtil.addToAtMentionBuffer(this._aAtMentionBuffer,h,s);this._mCurrentAtMention=this._aAtMentionBuffer[C];if(s==="@ "){this._mCurrentAtMention.endIndex-=1;}var j=g[this._mCurrentAtMention.startIndex-1];var n=this._mCurrentAtMention.endIndex+1;if(j===" "||j===undefined||j==='\n'){var N=g[n];while(N!==" "&&N!==undefined&&N!=='\n'){n+=1;N=g[n];}this._mCurrentAtMention.endIndex=n-1;this.fireSuggest({value:g.substring(h+1,n)});}else{this.closeSuggestionPopover();}}else{for(var i=A-1;i>=0;i--){if(h>this._aAtMentionBuffer[i].startIndex){var k=this._oSuggestionUtil.getStringAfterAtMention(h+s.length-1,g,this._aAtMentionBuffer[i]);var l=this._oSuggestionUtil.getStringBeforeAtMention(this._aAtMentionBuffer[i],g,h);var Q=l+s+k;var r=new RegExp("^"+Q);if(I&&r.test("@notify")){this._aAtMentionBuffer[i].endIndex=this._aAtMentionBuffer[i].endIndex+s.length;this._mCurrentAtMention=this._aAtMentionBuffer[i];this.showSuggestions([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}]);}else if(!Q.match(/ /g)||(Q.match(/ /g)&&Q.match(/ /g).length===1)){if((this._aAtMentionBuffer[i].atMentioned===true||this._aAtMentionBuffer[i].notifyAll===true)&&h<=this._aAtMentionBuffer[i].endIndex){var o=this._aAtMentionBuffer[i].startIndex;var p=g.slice(0,o)+" "+g.slice(o+1,g.length);this.setValue(p);this._sTextAreaCurrentValue=p;this._aAtMentionBuffer.splice(i,1);this.selectText(h+1,h+1);this.closeSuggestionPopover();}else if(Q.search("\n")===-1&&Q.search("@")===-1){this._aAtMentionBuffer[i].endIndex=this._aAtMentionBuffer[i].startIndex+Q.length;this._mCurrentAtMention=this._aAtMentionBuffer[i];var j=g[this._mCurrentAtMention.startIndex-1];if(j===" "||j===undefined||j==='\n'){this.fireSuggest({value:Q});}}else{this.closeSuggestionPopover();}}else{this.closeSuggestionPopover();}break;}this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[i],s.length);if(i===0){this.closeSuggestionPopover();}}}};f.prototype._handleDeletedCharacters=function(t,g){var i=t.changeIndex;var s=t.charactersChanged;var C=undefined;var A=this._oSuggestionUtil.isDeletedCharPartOfAtMentioned(this._aAtMentionBuffer,i);if(A!==undefined){if(this._aAtMentionBuffer[A].atMentioned===true||this._aAtMentionBuffer[A].notifyAll===true){this.closeSuggestionPopover();this._sTextAreaCurrentValue=this._sTextAreaCurrentValue.substr(0,this._aAtMentionBuffer[A].startIndex)+this._sTextAreaCurrentValue.substr(this._aAtMentionBuffer[A].endIndex-t.numberOfCharsChanged+1);this.setValue(this._sTextAreaCurrentValue);this.selectText(this._aAtMentionBuffer[A].startIndex,this._aAtMentionBuffer[A].startIndex);this._sTextAreaOldValue=this._sTextAreaCurrentValue;C=1+this._aAtMentionBuffer[A].endIndex-this._aAtMentionBuffer[A].startIndex;this._aAtMentionBuffer.splice(A,1);}else{C=t.numberOfCharsChanged;var h=g[this._aAtMentionBuffer[A].startIndex-1];if(s.search("@")!==-1&&g[t.changeIndex-1]!=="@"){this.closeSuggestionPopover();this._aAtMentionBuffer.splice(A,1);}else if(h===" "||h===undefined||h==='\n'){this._aAtMentionBuffer[A].endIndex-=C;var v=g.substring(this._aAtMentionBuffer[A].startIndex+1,this._aAtMentionBuffer[A].endIndex+1);var r=new RegExp("^"+v);if(v!==""&&r.test("@notify")){this.showSuggestions([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}]);}else{this.fireSuggest({value:v});}}}}A=A||0;C=C||t.numberOfCharsChanged;for(var j=A;j<this._aAtMentionBuffer.length;j++){if(i<this._aAtMentionBuffer[j].startIndex){this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[j],-C);}}};return f;});
