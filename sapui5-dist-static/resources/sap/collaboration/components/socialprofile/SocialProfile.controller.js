/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/collaboration/components/utils/CommonUtil','sap/collaboration/components/utils/OdataUtil','sap/ui/core/mvc/Controller','sap/ui/model/odata/ODataModel','sap/ui/model/json/JSONModel','jquery.sap.global'],function(C,O,a,b,J,q){"use strict";sap.ui.controller("sap.collaboration.components.socialprofile.SocialProfile",{onInit:function(){this.getView().getViewData().collaborationHostServiceUrl?this._sJamODataServiceUrl=this.getView().getViewData().collaborationHostServiceUrl:this._sJamODataServiceUrl="/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData";this.getView().getViewData().smiServiceUrl?this._sSMIODataServiceUrl=this.getView().getViewData().smiServiceUrl:this._sSMIODataServiceUrl="/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV";this._oODataUtil=new O();this._oCommonUtil=new C();this._sPrefixId=this.getView().getId();this._sJamURL="";this._sJamUserId="";this._sPopoverPrefix=this.getView().getViewData().popoverPrefix;this._fnUserInfoFetchedCallback=this.getView().getViewData().afterUserInfoRetrieved;this._initializeModels();},onBeforeRendering:function(){if(this._memberId!==this.getView().getViewData().memberId){this.getView().resetHeader();this._clearViewData();this._memberId=this.getView().getViewData().memberId;var m=this.getView().getViewData().memberInfo;if(q.isEmptyObject(m)){this._getMember();}else{this._setMember(m);if(this._fnUserInfoFetchedCallback){this._fnUserInfoFetchedCallback(m);}}}},_initializeModels:function(){var A=true;this._oJamODataModel=new b(this._sJamODataServiceUrl,A);this._oJSONModel=new J({});this.getView().setModel(this._oJSONModel);},_getMember:function(){var t=this;if(this._oSocialProfileRequest){this._oSocialProfileRequest.abort();}var p="Members_FindByEmail";var P={};P.urlParameters={"Email":"'"+t._memberId+"'","$expand":"MemberProfile/PhoneNumbers","$select":"Id,FullName,Title,Email,WebURL,MemberProfile"};P.success=function(d,r){var m=t._oCommonUtil.getODataResult(d);if(!q.isEmptyObject(m)){var c=m.MemberProfile.PhoneNumbers.results;var e=c.length;for(var i=0;i<e;i++){if(c[i]['PhoneNumberType']==='Work'){m.MemberProfile.WorkPhoneNumber=c[i]['PhoneNumber'];}if(c[i]['PhoneNumberType']==='Mobile'){m.MemberProfile.MobilePhoneNumber=c[i]['PhoneNumber'];}}t._oJSONModel.setData(m);t._sJamUserId=m.Id;var I=t._buildThumbnailImageURL(t._sJamUserId);sap.ui.getCore().byId(t._sPrefixId+"_HeaderUserImage").setSrc(I);if(t._fnUserInfoFetchedCallback){t._fnUserInfoFetchedCallback(m);}}};P.error=function(e){if(e.response&&e.response.statusCode){q.sap.log.error("SAP Jam request failed at sap.collaboration.components.socialprofile.SocialProfileController._getMember()");t.getView().setHeaderNoUser();}};this._oSocialProfileRequest=this._oJamODataModel.read(p,P);},_setMember:function(m){var M={"UserImage":m.picture,"Id":m.id,"FullName":m.fullname,"Title":m.title,"Email":m.email,"MemberProfile":{"Address":m.address,"WorkPhoneNumber":m.workPhoneNumber,"MobilePhoneNumber":m.mobilePhoneNumber}};this._sJamUserId=m.id;this._oJSONModel.setData(M);},_clearViewData:function(){sap.ui.getCore().byId(this._sPrefixId+"_HeaderUserImage").setSrc();sap.ui.getCore().byId(this._sPrefixId+"_FullName").setText();sap.ui.getCore().byId(this._sPrefixId+"_Role").setText();sap.ui.getCore().byId(this._sPrefixId+"_MobileNumber").setText();sap.ui.getCore().byId(this._sPrefixId+"_WorkNumber").setText();sap.ui.getCore().byId(this._sPrefixId+"_Email").setText();sap.ui.getCore().byId(this._sPrefixId+"_CompanyAddress").setText();},_buildThumbnailImageURL:function(u){return this._sJamODataServiceUrl+"/Members('"+q.sap.encodeURL(u)+"')/ThumbnailImage/$value";}});});
