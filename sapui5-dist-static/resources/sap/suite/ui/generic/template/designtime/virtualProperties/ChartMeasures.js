sap.ui.define(["sap/suite/ui/generic/template/changeHandler/util/AnnotationChangeUtilsV2","sap/suite/ui/generic/template/designtime/utils/DesigntimeUtils","sap/suite/ui/generic/template/changeHandler/util/ChangeHandlerUtils","sap/base/util/deepExtend","sap/base/util/isEmptyObject"],function(A,D,C,d,a){"use strict";var b={},p=false,M="com.sap.vocabularies.UI.v1.ChartMeasureRoleType",c="com.sap.vocabularies.UI.v1.DataPoint",e="com.sap.vocabularies.UI.v1.ChartType/Area",f="com.sap.vocabularies.UI.v1.ChartType/Donut",g="com.sap.vocabularies.UI.v1.ChartType/Bullet";b._setPostponedRetemplating=function(v){p=v;};b._getPostponedRetemplating=function(){return p;};b.getMeasureDefinition=function(E){var m={Measure:{displayName:"Measure",type:"Edm.PropertyPath",namespace:"com.sap.vocabularies.UI.v1",annotation:"Chart",nullable:false},Role:{displayName:"Role",type:"EnumType",namespace:"com.sap.vocabularies.UI.v1",annotation:"Chart",possibleValues:{Axis1:{displayName:"Axis 1"},Axis2:{displayName:"Axis 2"},Axis3:{displayName:"Axis 3"}}},DataPointAnnotationPath:{displayName:"Data Point Reference",type:"Edm.AnnotationPath",namespace:"com.sap.vocabularies.UI.v1",annotation:"Chart",refersTo:{annotation:"DataPoint",namespace:"com.sap.vocabularies.UI.v1"}}};var o={properties:["ImprovementDirection","DeviationRangeLowValue","DeviationRangeHighValue","ToleranceRangeLowValue","ToleranceRangeHighValue"],expressionTypes:{"DeviationRangeLowValue":["Path"],"DeviationRangeHighValue":["Path"],"ToleranceRangeLowValue":["Path"],"ToleranceRangeHighValue":["Path"]}};var h=D.getChartFromParent(E),i=h&&h.entityType[h.chartID];if(!h||!i||!i.ChartType){return m;}switch(i.ChartType.EnumMember){case e:m.Role.nullable=false;m.DataPoint={displayName:"Data Point Properties",type:"ComplexType",namespace:"com.sap.vocabularies.UI.v1",annotation:"DataPoint",whiteList:{properties:["Value","TargetValue","CriticalityCalculation"],mandatory:["Value","TargetValue"],expressionTypes:{Value:["Path"],TargetValue:["Path","String","Int","Decimal"]},CriticalityCalculation:o}};break;case g:m.Role.nullable=true;m.DataPoint={displayName:"Data Point Properties",type:"ComplexType",namespace:"com.sap.vocabularies.UI.v1",annotation:"DataPoint",whiteList:{properties:["Value","TargetValue","ForecastValue","MinimumValue","MaximumValue","Criticality","CriticalityCalculation"],mandatory:["Value"],expressionTypes:{Value:["Path"],TargetValue:["Path","String","Int","Decimal"],ForecastValue:["Path","String","Int","Decimal"],Criticality:["Path"]},CriticalityCalculation:o}};break;case f:m.Role.nullable=true;m.DataPoint={displayName:"Data Point Properties",type:"ComplexType",namespace:"com.sap.vocabularies.UI.v1",annotation:"DataPoint",whiteList:{properties:["Value","TargetValue","Criticality","CriticalityCalculation"],mandatory:["Value"],expressionTypes:{Value:["Path"],TargetValue:["Path","String","Int","Decimal"],Criticality:["Path"]},CriticalityCalculation:o}};break;default:break;}return m;};b.getChartFromConnectedField=function(E,i){var r=C.getLineItemRecordForColumn(E),o,F;if(i===undefined){return;}if(r&&r.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"&&r.Target&&r.Target.AnnotationPath.indexOf("FieldGroup")>=0){var s=r.Target.AnnotationPath,h=C.getEntityTypeFromAnnotationPath(E,s);if(h){s=s.substring(1);F={target:h.namespace+"."+h.name,fieldGroup:s,data:h[s]};}}var I=F&&F.data,j=[];if(I){j=JSON.parse(JSON.stringify(I.Data));}if(i>=0){var k=(j[i].Target&&j[i].Target.AnnotationPath).replace(/@/g,"");var l=C.getEntityTypeFromAnnotationPath(E,k);var q=k.search("/");var m=k.substring(q+1);o={chartID:m,entityType:l};}return o;};b.getMeasures=function(E,I){var m={},h=[],s,q,k,o,l,n={},r,t,u;if(E.sId.indexOf("FieldGroup")>=0){t=this.getChartFromConnectedField(E,I);}else{t=D.getChartFromParent(E);}u=t&&t.entityType[t.chartID];if(u&&u.Measures){var v=d({},v,u);for(var i=0;i<v.Measures.length;i++){s=v.Measures[i].PropertyPath;k=false;if(v.MeasureAttributes){for(var j=0;j<v.MeasureAttributes.length;j++){o=v.MeasureAttributes[j];n={};if(o.Measure&&o.Measure.PropertyPath===s){k=true;if(o.DataPoint&&o.DataPoint.AnnotationPath){q=o.DataPoint.AnnotationPath.split("#").reverse()[0];l=q?c+"#"+q:c;r=t.entityType&&t.entityType[l]!==undefined?t.entityType[l]:t[l];if(r){d(n,r);}}m={Measure:{PropertyPath:o.Measure&&o.Measure.PropertyPath},DataPointAnnotationPath:{AnnotationPath:o.DataPoint&&o.DataPoint.AnnotationPath},DataPoint:n};if(o.Role&&o.Role.EnumMember){switch(o.Role.EnumMember){case"com.sap.vocabularies.UI.v1.ChartMeasureRoleType/Axis1":m.Role={EnumMember:"Axis1"};break;case"com.sap.vocabularies.UI.v1.ChartMeasureRoleType/Axis2":m.Role={EnumMember:"Axis2"};break;case"com.sap.vocabularies.UI.v1.ChartMeasureRoleType/Axis3":m.Role={EnumMember:"Axis3"};break;default:break;}}h.push(m);break;}}}if(!k){m={Measure:v.Measures[i]};h.push(m);}}}return h;};b.setMeasures=function(o,n,h){var i,j,k,m,E,N,s,l=[],q,r={},t,O;if(o.sId.indexOf("FieldGroup")>=0){var I=h.metadataPath.match(/\d+/g).map(Number)[0];t=this.getChartFromConnectedField(o,I);O=t&&t.entityType[t.chartID];}else{t=D.getChartFromColumn(o);O=t&&t.entityType&&t.entityType[t.chartID];}if(!O||a(O)||!t||!n){return l;}if(h.delayRefresh){p=true;}var u=d({},O),T;if(t.hasOwnProperty("entityType")){if(t.entityType.hasOwnProperty("namespace")&&t.entityType.hasOwnProperty("name")){T=t.entityType.namespace+"."+t.entityType.name;}else{T=t.entityType;}}else{T=t.namespace+"."+t.name;}if(u.Measures){for(i=u.Measures.length-1;i>=0;i--){E=false;m=u.Measures[i].PropertyPath;for(j=0;j<n.length;j++){if(n[j].Measure&&n[j].Measure.PropertyPath===m){E=true;break;}}if(!E){u.Measures.splice(i,1);if(u.MeasureAttributes){for(j=u.MeasureAttributes.length-1;j>=0;j--){q=u.MeasureAttributes[j].Measure;if(q&&q.PropertyPath===m){u.MeasureAttributes.splice(j,1);if(!m&&O.Measures.length>n.length){h.noRefreshOnChange=true;h.refreshPropertiesPane=true;}break;}}}}}}for(i=0;i<n.length;i++){N=n[i];if(a(N)){N={Measure:{PropertyPath:""}};}E=false;if(u.MeasureAttributes){for(j=0;j<u.MeasureAttributes.length;j++){q=u.MeasureAttributes[j].Measure;if(N.Measure&&q&&q.PropertyPath===N.Measure.PropertyPath){E=true;if(N.DataPointAnnotationPath&&(!u.MeasureAttributes[j].DataPoint||u.MeasureAttributes[j].DataPoint.AnnotationPath!==N.DataPointAnnotationPath.AnnotationPath)){h.refreshPropertiesPane=true;p=true;}break;}}}if(N.DataPointAnnotationPath&&N.DataPointAnnotationPath.AnnotationPath){s=N.DataPointAnnotationPath.AnnotationPath;}else if(N.Measure&&N.Measure.PropertyPath){s="@"+c+"#"+N.Measure.PropertyPath;N.DataPointAnnotationPath={AnnotationPath:s};h.retemplateAfterPanelRefresh=true;h.refreshPropertiesPane=true;}else{s="";}r={Measure:{PropertyPath:N.Measure.PropertyPath},DataPoint:{AnnotationPath:s},RecordType:"com.sap.vocabularies.UI.v1.ChartMeasureAttributeType"};if(N.Role){switch(N.Role.EnumMember){case"Axis2":r.Role={EnumMember:M+"/Axis2"};break;case"Axis3":r.Role={EnumMember:M+"/Axis3"};break;default:r.Role={EnumMember:M+"/Axis1"};break;}}else{var v="Axis1";if(O.MeasureAttributes){var P=["Axis1","Axis2","Axis3"];v="Axis3";for(k=0;k<O.MeasureAttributes.length;k++){var R=O.MeasureAttributes[k].Role.EnumMember.split("/").reverse()[0];var w=P.indexOf(R);if(w!==-1){P.splice(w,1);}}if(P.length>0){v=P[0];}}N.Role={EnumMember:v};r.Role={EnumMember:M+"/"+v};}if(!E){if(!u.Measures){u.Measures=[];}u.Measures.push(N.Measure);if(!u.MeasureAttributes){u.MeasureAttributes=[];}u.MeasureAttributes.push(r);}else{u.MeasureAttributes[j]=r;}var x=D.modifyDataPointForChart(T,t.entityType?t.entityType:t,N,l);if(x){var y=["@",c,x];u.MeasureAttributes.DataPoint={AnnotationPath:y.join('')};}if(N.Measure.PropertyPath===""){h.noRefreshOnChange=true;if(O.Measures.length>u.Measures.length&&!p){k=0;while(!p&&k<O.Measures.length){if(O.Measures[k].PropertyPath){p=true;}k++;}}}else if(N.Measure.PropertyPath!==""&&N.DataPoint&&N.DataPoint.Value&&!h.noRefreshOnChange){p=false;}}if(p&&h.noRefreshOnChange){var H=false;k=0;while(!H&&k<u.Measures.length){if(!u.Measures[k].PropertyPath){H=true;}k++;}if(!H){h.noRefreshOnChange=false;h.refreshPropertiesPane=true;p=false;}}var z=A.createCustomAnnotationTermChange(T,u,O,t.chartID);l.push(z);return l;};return b;});
