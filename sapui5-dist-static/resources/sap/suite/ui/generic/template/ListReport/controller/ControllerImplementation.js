sap.ui.define(["sap/ui/model/Filter","sap/suite/ui/generic/template/ListReport/extensionAPI/ExtensionAPI","sap/suite/ui/generic/template/listTemplates/listUtils","sap/suite/ui/generic/template/ListReport/controller/IappStateHandler","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsHandler","sap/suite/ui/generic/template/ListReport/controller/WorklistHandler","sap/suite/ui/generic/template/lib/ShareUtils","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/ObjectPath","sap/suite/ui/generic/template/js/StableIdHelper","sap/base/util/deepExtend","sap/suite/ui/generic/template/lib/CreateWithDialogHandler","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper","sap/suite/ui/generic/template/ListReport/controller/MultiEditHandler","sap/suite/ui/generic/template/js/placeholderHelper","sap/ui/generic/app/navigation/service/SelectionVariant"],function(F,E,l,I,M,W,S,c,a,O,b,d,C,e,f,p,g){"use strict";var L=new a("ListReport.controller.ControllerImplementation").getLogger();var m={getMethods:function(v,t,o){var s={};s.oWorklistData={bWorkListEnabled:false,bVariantDirty:true};var h;var w=null;function j(){var i=o.getOwnerComponent();var Z=t.oComponentUtils.getTemplatePrivateModel();Z.setProperty("/listReport/isLeaf",i.getIsLeaf());}function k(i){var Z=i.getSource();var $=o.getOwnerComponent().getAnnotationPath();if($!==undefined){A(Z,$);}o.onInitSmartFilterBarExtension(i);o.templateBaseExtension.onInitSmartFilterBar(i);s.oIappStateHandler.onSmartFilterBarInitialise();}function A(i,Z){var $=new g(JSON.stringify(i.getUiState().getSelectionVariant()));var _=o.getOwnerComponent().getModel().getMetaModel();var a1=o.getOwnerComponent().getEntitySet();var b1=_.getODataEntityType(_.getODataEntitySet(a1).entityType);var c1=_.getObject(b1.$path+"/"+Z);if(c1){c1=l.createSVObject(c1,i);c1.FilterContextUrl=$.getFilterContextUrl();s.oIappStateHandler.setFiltersUsingUIState(c1.toJSONObject(),true,false);}else{var d1=o.getOwnerComponent().getAppComponent().getNavigationController();d1.navigateToMessagePage({title:t.oCommonUtils.getText("ST_ERROR"),text:"Manifest property 'annotationPath' is configured with "+Z+" but no such annotation found.",description:""});}}var n;var q=new Promise(function(i){n=i;});q.then(function(){n=null;});var r;var u=new Promise(function(i){r=i;});function x(){if(!n){s.oIappStateHandler.changeIappState(true,false);}}function U(i){t.oCommonUtils.setEnabledToolbarButtons(i);if(!c.isSmartChart(i)){t.oCommonUtils.setEnabledFooterButtons(i);}}function R(i){var Z;Z=i.getSource();Z.getChartAsync().then(function($){$.attachSelectData(U.bind(null,Z));$.attachDeselectData(U.bind(null,Z));});}function y(i){var Z=i.getParameters();var $=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationPressed($,Z);}function z(i){var Z,$;Z=i.getParameters();$=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained($,Z,s,undefined,undefined);}function B(i){var Z,$,_,a1,b1,c1;Z=i.getParameters().mainNavigation;b1=i.getParameters();c1=i.getSource();if(Z){$=c1.getText&&c1.getText();_=t.oCommonUtils.getCustomData(i);if(_&&_["LinkDescr"]){a1=_["LinkDescr"];Z.setDescription(a1);}}c1=s.oSmartTable;t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(c1,b1,s,$,Z);}function D(Z){var $=v.getItems();for(var i=0;i<$.length;i++){if(!Z||$[i].getBindingContextPath()===Z){return $[i];}}}function N(i){t.oCommonEventHandlers.onListNavigate(i,s,undefined,true);}function G(i,Z){t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){t.oCommonEventHandlers.addEntry(Z,false,s.oSmartFilterbar,i);},Function.prototype,s);}function H(i){var Z=b.getStableId({type:"ListReportAction",subType:"Create",sQuickVariantKey:i});var $=b.getStableId({type:"ListReportAction",subType:"CreateWithDialog"});if($&&o.byId($)){o.byId($).setVisible(true);t.oCommonUtils.executeIfControlReady(s.oCreateWithDialogHandler.createWithDialog.bind(null,o.byId($)),Z);}else{t.oCommonUtils.executeIfControlReady(G.bind(null,undefined),Z);}}function J(i){var Z=o.getOwnerComponent().getCreateWithFilters();var $=Z.strategy||"extension";var _;switch($){case"extension":_=o.getPredefinedValuesForCreateExtension(s.oSmartFilterbar);break;default:L.error($+" is not a valid strategy to extract values from the SmartFilterBar");return;}G(_,i.getSource());}function K(i){var Z=t.oComponentUtils.getTemplatePrivateModel();var $=Z.getProperty("/listReport/deleteEnabled");if($){t.oCommonEventHandlers.deleteEntries(i);}}function P(i){if(!t.oComponentUtils.isDraftEnabled()){return;}var Z=t.oComponentUtils.getTemplatePrivateModel();var $=Z.getProperty("/listReport/vDraftState");switch($){case"1":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("HasDraftEntity","EQ",false));break;case"2":i.push(new F("IsActiveEntity","EQ",false));break;case"3":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("SiblingEntity/IsActiveEntity","EQ",null));i.push(new F("DraftAdministrativeData/InProcessByUser","NE",""));break;case"4":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("SiblingEntity/IsActiveEntity","EQ",null));i.push(new F("DraftAdministrativeData/InProcessByUser","EQ",""));break;default:var _=Z.getProperty("/listReport/activeObjectEnabled");if(_){i.push(new F("IsActiveEntity","EQ",true));}else{var a1=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});if(i[0]&&i[0].aFilters){var b1=i[0];i[0]=new F([b1,a1],true);}else{i.push(a1);}}break;}}function Q(i){var Z={shareEmailPressed:function(){var a1=t.oCommonUtils.getText("EMAIL_HEADER",[t.oServices.oApplication.getAppTitle()]);sap.m.URLHelper.triggerEmail(null,a1,document.URL);},shareJamPressed:function(){S.openJamShareDialog(t.oServices.oApplication.getAppTitle());},getDownloadUrl:function(){var a1=s.oSmartTable.getTable();var b1=a1.getBinding("rows")||a1.getBinding("items");return b1&&b1.getDownloadUrl()||"";},getServiceUrl:function(){var a1="";var b1=t.oComponentUtils.getSettings();var c1=s.oSmartFilterbar&&s.oSmartFilterbar.getUseDateRangeType();if(!c1&&e.isServiceUrlAllowedBySemanticDateRangeFilter(b1,s.oSmartFilterbar)){a1=Z.getDownloadUrl();if(a1){a1+="&$top=0&$inlinecount=allpages";}}var d1={serviceUrl:a1};o.onSaveAsTileExtension(d1);return d1.serviceUrl;},getModelData:function(){var a1=O.get("sap.ushell.Container.getUser");var b1=o.getOwnerComponent();var c1=b1.getAppComponent();var d1=c1.getMetadata();var e1=d1.getManifestEntry("sap.ui");var f1=(e1&&e1.icons&&e1.icons.icon)||"";var g1=d1.getManifestEntry("sap.app");var h1=(g1&&g1.title)||"";return{serviceUrl:Z.getServiceUrl(),icon:f1,title:h1,isShareInJamActive:!!a1&&a1().isJamActive(),customUrl:S.getCustomUrl()};}};S.openSharePopup(t.oCommonUtils,i,Z);var $=this.getView().byId("template::Share");var _=this.getView().byId("bookmarkButton");_.setBeforePressHandler(function(){$.focus();});}function T(i){var Z=i.getId();var $=s.oSmartFilterbar;var _="";var a1=[];if(i.fetchVariant()&&i.fetchVariant().filter&&i.fetchVariant().filter.filterItems){a1=i.fetchVariant().filter.filterItems;}var b1={search:!!$.getBasicSearchValue(),filter:!!(a1.length||$.retrieveFiltersWithValues().length)};if(b1.search||b1.filter){_=t.oCommonUtils.getContextText("NOITEMS_LR_SMARTTABLE_WITH_FILTER",Z);}else{_=t.oCommonUtils.getContextText("NOITEMS_LR_SMARTTABLE",Z);}i.setNoData(_);}function V(i){var Z=i.getId();var $=s.oSmartFilterbar;var _=[];if(i.fetchVariant()&&i.fetchVariant().filter&&i.fetchVariant().filter.filterItems){_=i.fetchVariant().filter.filterItems;}var a1="";var b1={search:!!$.getBasicSearchValue(),filter:!!(_.length||$.retrieveFiltersWithValues().length)};if(b1.search||b1.filter){a1=t.oCommonUtils.getContextText("NOITEMS_SMARTCHART_WITH_FILTER",Z);}else{a1=t.oCommonUtils.getContextText("NOITEMS_SMARTCHART",Z);}i.getChartAsync().then(function(c1){c1.setCustomMessages({NO_DATA:a1});});}function X(i){var Z=i.getEntitySet();t.oComponentUtils.preloadComponent(Z);}var Y;return{onInit:function(){var i=o.getOwnerComponent().getAppComponent();var Z=i.getConfig();s.oWorklistData.bWorkListEnabled=!!Z.pages[0].component.settings&&Z.pages[0].component.settings.isWorklist;s.oSmartFilterbar=o.byId("listReportFilter");s.oSmartTable=o.byId("listReport");s.updateControlOnSelectionChange=U;h=t.oComponentUtils.getFclProxy();s.bLoadListAndFirstEntryOnStartup=h.isListAndFirstEntryLoadedOnStartup();var $=new M(s,o,t);s.oMultipleViewsHandler=$;s.refreshModel=function(){var b1=t.oCommonUtils.refreshModel(s.oSmartTable);if(b1){$.refreshSiblingControls(s.oSmartTable);}};s.oCreateWithDialogHandler=new C(s,o,t);s.oWorklistHandler=new W(s,o,t);s.oIappStateHandler=new I(s,o,t);s.oMultiEditHandler=new f(s,o,t);s.oIappStateHandler.onSFBVariantInitialise();if(s.oWorklistData.bWorkListEnabled){s.oWorklistHandler.fetchAndSaveWorklistSearchField();}var _=t.oComponentUtils.getTemplatePrivateModel();_.setProperty("/generic/bDataAreShownInTable",false);_.setProperty("/listReport/firstSelection",false);_.setProperty("/listReport/isHeaderExpanded",true);_.setProperty("/listReport/deleteEnabled",false);var a1=b.getStableId({type:"ListReportAction",subType:"MultiEdit"});_.setProperty("/generic/controlProperties/"+a1,{enabled:false});if(t.oComponentUtils.isDraftEnabled()){_.setProperty("/listReport/activeObjectEnabled",false);_.setProperty("/listReport/vDraftState","0");}_.setProperty("/listReport/multipleViews/msgVisibility",false);v.getSmartTable=function(){return s.oSmartTable;};v.getItems=function(){var b1=s.oSmartTable.getTable();if(c.isUiTable(b1)){return b1.getRows();}return b1.getItems();};v.displayNextObject=function(b1){return new Promise(function(c1,d1){w={aWaitingObjects:b1,resolve:c1,reject:d1};});};v.onComponentActivate=function(){u.then(function(){var b1=s.oIappStateHandler.parseUrlAndApplyAppState();b1.then(n);});};v.refreshBinding=function(b1,c1){if(s.oIappStateHandler.areDataShownInTable()){if(s.oMultipleViewsHandler.refreshOperation(2,null,!b1&&c1)){return;}if(b1||c1[s.oSmartTable.getEntitySet()]){t.oCommonUtils.refreshModel(s.oSmartTable);t.oCommonUtils.refreshSmartTable(s.oSmartTable);}}};v.getCurrentState=function(){return{permanentState:{data:s.oIappStateHandler.getCurrentAppState(),lifecycle:{permanent:true}}};};v.applyState=function(b1){q.then(function(){s.oIappStateHandler.applyState(b1.permanentState);});};j();o.byId("template::FilterText").attachBrowserEvent("click",function(){o.byId("page").setHeaderExpanded(true);});},handlers:{addEntry:H,addEntryWithFilters:J,deleteEntries:K,deleteEntry:function(i){t.oCommonEventHandlers.deleteEntry(i);},updateTableTabCounts:function(){s.oMultipleViewsHandler.fnUpdateTableTabCounts();},onCancelCreateWithPopUpDialog:function(){s.oCreateWithDialogHandler.onCancelPopUpDialog();},onSaveCreateWithPopUpDialog:function(i){s.oCreateWithDialogHandler.onSavePopUpDialog(i);},onSelectionChange:function(i){var Z=i.getSource();U(Z);},onMultiSelectionChange:function(i){t.oCommonEventHandlers.onMultiSelectionChange(i);},onSmartFieldUrlPressed:function(i){t.oCommonEventHandlers.onSmartFieldUrlPressed(i,s);},onContactDetails:function(i){t.oCommonEventHandlers.onContactDetails(i);},onSmartFilterBarInitialise:k,onSmartFilterBarInitialized:r,onBeforeSFBVariantFetch:function(){s.oIappStateHandler.onBeforeSFBVariantFetch();},onAfterSFBVariantSave:function(){s.oIappStateHandler.onAfterSFBVariantSave();},onAfterSFBVariantLoad:function(i){s.oIappStateHandler.onAfterSFBVariantLoad(i);},onDataRequested:function(){s.oMultipleViewsHandler.onDataRequested();},onDataReceived:function(Z){if(Y){Y();}Y=Function.prototype;t.oCommonEventHandlers.onDataReceived(Z);if(w){var $;var _=false;for(var i=0;i<w.aWaitingObjects.length&&!_;i++){$=D(w.aWaitingObjects[i]);if($){N($);w.resolve();_=true;}}if(!_){$=D();if($){N($);w.resolve();}else{w.reject();}}w=null;return;}var a1=Z.getSource().getTable();h.handleDataReceived(a1,N);var b1=t.oComponentUtils.getTemplatePrivateModel();b1.setProperty("/listReport/firstSelection",true);s.oIappStateHandler.setDataShownInTable(true);var c1=['FE-DATA-LOADED','FE-DATA-LOADED-FIRSTTIMEONLY','FE-HEADER-LOADED','FE-HEADER-LOADED-FIRSTTIMEONLY'];p.resetPlaceHolders(t,c1);},onSmartChartDataReceived:function(){s.oMultipleViewsHandler.onDataRequested();},onBeforeRebindTable:function(i){var Z=i.getSource();T(Z);var $=i.getParameters().bindingParams;$.events["dataRequested"]=X.bind(null,Z);s.oMultipleViewsHandler.aTableFilters=d({},$.filters);var _=$.filters.slice(0);t.oCommonEventHandlers.onBeforeRebindTable(i,{determineSortOrder:s.oMultipleViewsHandler.determineSortOrder,ensureExtensionFields:o.templateBaseExtension.ensureFieldsForSelect,addTemplateSpecificFilters:P,addExtensionFilters:o.templateBaseExtension.addFilters,resolveParamaterizedEntitySet:s.oMultipleViewsHandler.fnResolveParameterizedEntitySet,isFieldControlRequired:false,isPopinWithoutHeader:true,isDataFieldForActionRequired:true,isFieldControlsPathRequired:true,isMandatoryFiltersRequired:true});o.onBeforeRebindTableExtension(i);s.oMultipleViewsHandler.onRebindContentControl($,_);l.handleErrorsOnTableOrChart(t,i);},onListNavigate:function(i){t.oCommonEventHandlers.onListNavigate(i,s);},onCallActionFromToolBar:function(i){t.oCommonEventHandlers.onCallActionFromToolBar(i,s);},onDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(i,s);},onDataFieldWithIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldWithIntentBasedNavigation(i,s);},onBeforeSemanticObjectLinkNavigationCallback:function(){return new Promise(function(i){t.oServices.oDataLossHandler.performIfNoDataLoss(function(){i(true);},function(){i(false);});});},onBeforeSemanticObjectLinkPopoverOpens:function(i){var Z=i.getSource();var $=s.oSmartFilterbar.getUiState().getSelectionVariant();if(s.oSmartFilterbar.getEntitySet()!==Z.getEntitySet()){$.FilterContextUrl=t.oServices.oApplication.getNavigationHandler().constructContextUrl(Z.getEntitySet(),Z.getModel());}var _=JSON.stringify($);t.oCommonUtils.semanticObjectLinkNavigation(i,_,o);},onSemanticObjectLinkNavigationPressed:y,onSemanticObjectLinkNavigationTargetObtained:z,onSemanticObjectLinkNavigationTargetObtainedSmartLink:B,onDraftLinkPressed:function(i){var Z=i.getSource();var $=Z.getBindingContext();t.oCommonUtils.showDraftPopover($,Z);},onAssignedFiltersChanged:function(i){if(i.getSource()){o.byId("template::FilterText").setText(i.getSource().retrieveFiltersWithValuesAsText());}},onFilterChange:x,onFiltersDialogBeforeOpen:function(){s.oIappStateHandler.onFiltersDialogBeforeOpen();},onFiltersDialogClosed:function(){s.oIappStateHandler.onFiltersDialogClosed();},onSearchButtonPressed:function(){s.refreshModel();s.oIappStateHandler.changeIappState(false,true);},onAfterTableVariantSave:function(){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyTableVariant:function(){if(!n){s.oIappStateHandler.onAfterApplyTableVariant();}},onAfterChartVariantSave:function(i){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyChartVariant:function(i){if(!n){s.oIappStateHandler.onAfterApplyTableVariant();}},onBeforeRebindChart:function(i){var Z=i.getSource();V(Z);var $=i.getParameters().bindingParams;s.oMultipleViewsHandler.aTableFilters=d({},$.filters);var _=$.filters.slice(0);var a1={setBindingPath:Z.setChartBindingPath.bind(Z),ensureExtensionFields:Function.prototype,addTemplateSpecificFilters:P,addExtensionFilters:o.templateBaseExtension.addFilters,resolveParamaterizedEntitySet:s.oMultipleViewsHandler.fnResolveParameterizedEntitySet,isFieldControlRequired:false,isMandatoryFiltersRequired:true};t.oCommonUtils.onBeforeRebindTableOrChart(i,a1,s.oSmartFilterbar);o.onBeforeRebindChartExtension(i);s.oMultipleViewsHandler.onRebindContentControl($,_);l.handleErrorsOnTableOrChart(t,i);},onChartInitialized:function(i){R(i);t.oCommonUtils.checkToolbarIntentsSupported(i.getSource());},onSelectionDetailsActionPress:function(i){s.oMultipleViewsHandler.onDetailsActionPress(i);},onShareListReportActionButtonPress:function(i){t.oCommonUtils.executeIfControlReady(Q,"template::Share");},onInlineDataFieldForAction:function(i){t.oCommonEventHandlers.onInlineDataFieldForAction(i,s);},onInlineDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onInlineDataFieldForIntentBasedNavigation(i.getSource(),s);},onDeterminingDataFieldForAction:function(i){t.oCommonEventHandlers.onDeterminingDataFieldForAction(i,s.oSmartTable);},onDeterminingDataFieldForIntentBasedNavigation:function(i){var Z=i.getSource();t.oCommonEventHandlers.onDeterminingDataFieldForIntentBasedNavigation(Z,s.oSmartTable.getTable(),s);},onTableInit:function(i){var Z=i.getSource();t.oCommonUtils.checkToolbarIntentsSupported(Z);},onSearchWorkList:function(i){s.oWorklistHandler.performWorklistSearch(i);},onWorkListTableSettings:function(i){s.oWorklistHandler.openWorklistPersonalisation(i);},onActiveButtonPress:function(i){var Z=o.byId("template::PageVariant");var $=t.oComponentUtils.getTemplatePrivateModel();var _=$.getProperty("/listReport/activeObjectEnabled");$.setProperty("/listReport/activeObjectEnabled",!_);Z.currentVariantSetModified(true);s.oSmartFilterbar.search();s.oIappStateHandler.changeIappState(true,true);},onMultiEditButtonPress:function(){s.oMultiEditHandler.onMultiEditButtonPress();}},formatters:{formatDraftType:function(i,Z,$){if(i&&i.DraftUUID){if(!Z){return sap.m.ObjectMarkerType.Draft;}else if($){return i.InProcessByUser?sap.m.ObjectMarkerType.Locked:sap.m.ObjectMarkerType.Unsaved;}}return sap.m.ObjectMarkerType.Flagged;},formatDraftVisibility:function(i,Z){if(i&&i.DraftUUID){if(!Z){return sap.m.ObjectMarkerVisibility.TextOnly;}}return sap.m.ObjectMarkerVisibility.IconAndText;},formatDraftLineItemVisible:function(i,Z,$){if(i&&i.DraftUUID){if($==="0"&&Z){return false;}return true;}return false;},formatDraftOwner:function(i,Z){var $="";if(i&&i.DraftUUID&&Z){var _=i.InProcessByUserDescription||i.InProcessByUser||i.LastChangedByUserDescription||i.LastChangedByUser;if(_){$=t.oCommonUtils.getText("ST_DRAFT_OWNER",[_]);}else{$=t.oCommonUtils.getText("ST_DRAFT_ANOTHER_USER");}}return $;},formatItemTextForMultipleView:function(i){return s.oMultipleViewsHandler?s.oMultipleViewsHandler.formatItemTextForMultipleView(i):"";},formatMessageStrip:function(i,Z){return s.oMultipleViewsHandler?s.oMultipleViewsHandler.formatMessageStrip(i,Z):"";}},extensionAPI:new E(t,o,s)};}};return m;});
