sap.ui.define(["sap/ui/base/Object","sap/base/util/extend","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartmultiedit/Field","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartmultiedit/Container","sap/suite/ui/generic/template/genericUtilities/testableHelper"],function(B,e,G,a,F,S,C,t){"use strict";function g(s,c,T){var u;function o(){var d=s.oSmartTable.getTable().getSelectedContexts();u=T.oCommonUtils.filterUpdatableContexts(d,s.oSmartTable);if(d.length===u.length){O(u);}else{T.oCommonUtils.getDialogFragmentAsync("sap.suite.ui.generic.template.ListReport.view.fragments.MultiEditConfirmation",{onCancel:function(E){var D=E.getSource().getParent();D.close();},onContinue:function(E){var D=E.getSource().getParent();O(u);D.close();}},"multiEditConfirmation").then(function(m){var M=m.getModel("multiEditConfirmation");var w=u.length===1?"EDIT_REMAINING":"EDIT_REMAINING_PLURAL";var W=T.oCommonUtils.getText(w,[d.length-u.length,d.length,u.length]);M.setProperty("/warningText",W);m.open();});}}function O(u){var m=T.oCommonUtils.getDialogFragmentAsync("sap.suite.ui.generic.template.ListReport.view.fragments.MultiEditDialog",{onAfterClose:function(E){var M=E.getSource();M.destroyContent();},onCancel:function(E){var M=E.getSource().getParent();M.close();},onSave:b},"multiEdit");m.then(function(M){var d=M.getModel("multiEdit");var E=s.oSmartTable.getEntitySet();var D=u.length===1?T.oCommonUtils.getText("MULTI_EDIT_DIALOG_TITLE_SINGULAR"):T.oCommonUtils.getText("MULTI_EDIT_DIALOG_TITLE_PLURAL",u.length);d.setProperty("/multiEditDialogTitle",D);var h=f();var i=new G();h.forEach(function(l){var n=new a();var p=new F({propertyName:l.data("p13nData").leadingProperty,useApplyToEmptyOnly:false});n.addElement(p);i.addGroupElement(n);});var j=new S();var k=new C();k.setEntitySet(E);j.addGroup(i);k.setContexts(u);k.setLayout(j);M.addContent(k);M.open();});}function f(){var d=s.oSmartTable;var E=d.getEntitySet();var h=d.getTable().getColumns();var m=d.getModel().getMetaModel();var i=m.getODataEntityType(m.getODataEntitySet(E).entityType);return h.filter(function(j){var k=j.data("p13nData")&&j.data("p13nData").columnKey;var p=m.getODataProperty(i,j.data("p13nData").leadingProperty);if(p){return j.getVisible()&&(k.indexOf("DataFieldForAnnotation")<0)&&!j.data("p13nData").actionButton&&!!j.data("p13nData").leadingProperty&&p["sap:updatable"]!=="false"&&(!p["Org.OData.Core.V1.Immutable"]||p["Org.OData.Core.V1.Immutable"].Bool==="false");}});}function b(E){var m=E.getSource().getParent();var M=m.getContent()[0];var v=M.getErroneousFieldsAndTokens();v.then(function(d){if(d.length===0){m.close();var U;var p=function(D,h){var P=h.getPropertyName(),i=h.getUnitOfMeasurePropertyName();U[P]=D[P];if(h.isComposite()){U[i]=D[i];}};M.getAllUpdatedContexts(true).then(function(h){var i=[];var j=M.getFields().filter(function(l){return!l.isKeepExistingSelected();});h.forEach(function(l){U={};j.forEach(p.bind(null,l.data));i.push({sContextPath:l.context.getPath(),oUpdateData:U});});m.destroyContent();var k=T.oServices.oCRUDManager.updateMultipleEntities(i);k.then(function(){T.oCommonUtils.refreshSmartTable(s.oSmartTable);});});}});}var b=t.testable(b,"fnStartMultiSave");return{onMultiEditButtonPress:o};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.MultiEditHandler",{constructor:function(s,c,T){e(this,g(s,c,T));}});});
