sap.ui.define(["sap/ui/base/EventProvider","sap/ui/comp/personalization/Util","sap/ui/table/AnalyticalTable","sap/ui/core/mvc/Controller","sap/m/Table","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/table/RowSettings","sap/ui/model/FilterOperator","sap/ui/table/library","sap/suite/ui/generic/template/listTemplates/listUtils","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/isEmptyObject"],function(E,P,A,C,R,J,F,a,b,S,l,c,d){"use strict";var e=new E();var L=new c("AnalyticalListPage.controller.DetailController").getLogger();var t=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.DetailController",{setState:function(s){this.oState=s;this._enableExpandByFilter=true;this._enableUpdateExpandLevelInfo=false;var f=this.oState.oSmartTable;var o=this.oState.oController.getOwnerComponent();var T=this.oState.oController.getOwnerComponent().getModel("_templPriv");T.setProperty('/alp/autoHide',o.getAutoHide()?"filter":"highlight");f.attachInitialise(this._onSmartTableInit,this);f.attachBeforeRebindTable(this._onBeforeRebindTable,this);},_onSmartTableInit:function(){var s=this.oState.oSmartTable,f=s.getCustomToolbar(),T=f.getContent(),n;s.setHeight("100%");this.oState.oTemplateUtils.oCommonUtils.checkToolbarIntentsSupported(s);if(this.oState._pendingTableToolbarInit){if(!this.oState.oSmartFilterableKPI){f.insertContent(this.oState.alr_viewSwitchButtonOnTable,T.length);}}if(this.oState._pendingTableToolbarInit){for(var i=0;i<T.length;i++){if(T[i].mProperties.text==="Settings"){n=i;}}f.insertContent(this.oState._autoHideToggleBtn,n);}delete this.oState._pendingTableToolbarInit;this.oState.oSmartTable.attachShowOverlay(function(o){this.oState.oSmartTable.getCustomToolbar().setEnabled(!o.getParameter("overlay").show);},this);var g=new J({"highlightMode":"rebindTable"});this.oState.oSmartTable.setModel(g,"_tableHighlight");},_onBindingDataReceived:function(){var f=this.oState.oSmartTable.getTable();if(f instanceof A){this._expandByFilter("bindingDataReceived");}},_onBeforeRebindTable:function(o){var v=this.oState.oSmartTable.fetchVariant(),B=o.getParameter("bindingParams");B.parameters=B.parameters||{};if(this.oState.chartController&&this.oState.chartController.oChart){var f=this.oState.chartController.oChart,g=this.oState.chartController._chartInfo,h=(g.drillStack&&g.drillStack.length>0)?g.drillStack[g.drillStack.length-1]:undefined;}if(!v){return;}var T=this.oState.oController.getOwnerComponent().getModel("_templPriv");var _=T.getProperty('/alp/_ignoreChartSelections');if(this.isFilter()&&this.oState.oSmartChart&&!_){this._applyChartSelectionOnTableAsFilter(o,f);}if(this.isFilter()&&h&&h.filter){o.getParameter("bindingParams").filters.push(h.filter);}var j=[];var k=this.oState.oSmartTable.getTable().getColumns();for(var i=0;i<k.length;i++){var m=k[i];if(m.getGrouped&&m.getGrouped()){j.push(m.getLeadingProperty?m.getLeadingProperty():P.getColumnKey(m));}}this._updateExpandLevelInfo(j);if(this.oState.oController.getOwnerComponent().getModel().getDefaultCountMode()==="None"&&this.oState.oSmartTable._isAnalyticalTable){o.mParameters.bindingParams.parameters.provideTotalResultSize=false;this.oState.oSmartTable.setShowRowCount(false);}this.oState.oController.onBeforeRebindTableExtension(o);this.oState.oTemplateUtils.oCommonEventHandlers.onBeforeRebindTable(o,{ensureExtensionFields:this.oState.oController.templateBaseExtension.ensureFieldsForSelect,addExtensionFilters:this.oState.oController.templateBaseExtension.addFilters,isMandatoryFiltersRequired:false,isFieldControlRequired:false,isPopinWithoutHeader:false,isDataFieldForActionRequired:false,isFieldControlsPathRequired:false});this.oState.oSmartTable.getModel("_tableHighlight").setProperty("/highlightMode","rebindTable");this._applyCriticalityInfo(o,this.oState.oSmartTable);l.handleErrorsOnTableOrChart(this.oState.oTemplateUtils,o);},attachTableChange:function(D,f,o){return e.attachEvent("TableChange",D,f,o);},detachTableChange:function(f,o){return e.detachEvent("TableChange",f,o);},isFilter:function(){var T=this.oState.oController.getOwnerComponent().getModel("_templPriv");return T.getProperty("/alp/autoHide")==="filter";},applyParamsToTable:function(){var s=this.oState.chartController,o=s.oChart,v=s._chartInfo.vizSelection;if(o&&v){var f=this.oState.oSmartTable.getModel("_tableHighlight"),g=s._chartInfo.chartSelection,i=s._chartInfo.drillStack.length>0;if(this.isFilter()||(g&&g.count)||f.getProperty("/highlightMode")==="eyeModeSwitch"||i){this.oState.oSmartTable.rebindTable(true);}else{this._applyCriticalityInfo(undefined,this.oState.oSmartTable);f.refresh(true);}}},_getValueFromCustomData:function(s,p){var _=s.getCustomData();for(var i=0;i<_.length;i++){if(_[i].mProperties.key===p){if(p==="lineItemCriticality"){return _[i].mProperties.value&&JSON.parse(_[i].mProperties.value);}else{return _[i].mProperties.value;}}}return"";},_applyCriticalityInfo:function(o,s){var T=s.getTable(),B=[],r=[],m=this,f=this._getValueFromCustomData(s,"lineItemCriticality");var g=this.oState.chartController&&this.oState.chartController.oChart;if(g){var p=this._getSelParamsFromChart(g);if(p&&p.length>0){p.forEach(function(i){if(i){var k=Object.keys(i);if(k){k.forEach(function(n){if(n!=="__metadata"&&r.indexOf(n)<0){B.push({path:n});r.push(n);}});}}});}this._setParamMap(g);}var h=f&&f.Path;if(h){B.push({path:h});if(o&&o.mParameters){o.mParameters.bindingParams.parameters.select.indexOf(h)===-1?o.mParameters.bindingParams.parameters.select+=","+h:"";}}else if(f&&f.EnumMember){B.push({path:"EnumMember"});}m.isFilterMode=this.isFilter();m.isResponsive=T instanceof R;if(!m.isFilterMode&&s.getModel("_tableHighlight").getProperty("/highlightMode")!=="eyeModeSwitch"){B.push({path:"_tableHighlight>/highlightMode"});}if(B&&B.length>0){var j=function(){var k=m._paramMap,_=m.isFilterMode;var n=m.isResponsive?this:this._getRow();if(!n){return;}if(n.getBindingContext()){var q;var u=this.getBindingContext();if(k&&!d(k)){for(var v in k){if(!u.getObject(v)){continue;}for(var i=0;i<k[v].length;i++){if(k[v][i]===u.getObject(v)){q=true;break;}else{q=false;}}}}else{q=false;}m._applyCSSHighlight(n,_,q);if(h){var w=u.getObject(h);switch(w&&w.toString()){case"0":return"None";case"1":return"Error";case"2":return"Warning";case"3":return"Success";default:return"None";}}else if(f&&f.EnumMember){switch(f.EnumMember){case"com.sap.vocabularies.UI.v1.CriticalityType/Neutral":return"None";case"com.sap.vocabularies.UI.v1.CriticalityType/Negative":return"Error";case"com.sap.vocabularies.UI.v1.CriticalityType/Critical":return"Warning";case"com.sap.vocabularies.UI.v1.CriticalityType/Positive":return"Success";default:return"None";}}else{return"None";}}else{m._applyCSSHighlight(n,_,false);return"None";}};if(m.isResponsive){this.oState.alp_ColumnListItem.bindProperty("highlight",{parts:B,formatter:j});}else{T.getRowSettingsTemplate().bindProperty("highlight",{parts:B,formatter:j});}}else{if(m.isResponsive){this.oState.alp_ColumnListItem.bindProperty("highlight",{path:"{_tableHighlight>/highlightMode}",formatter:function(){var _=m.isResponsive?this:this._getRow();if(!_){return;}m._applyCSSHighlight(_,false,false);return"None";}});}else{T.getRowSettingsTemplate().bindProperty("highlight",{path:"{_tableHighlight>/highlightMode}",formatter:function(){return"None";}});}}},_applyCSSHighlight:function(r,i,f){if(f===undefined){return;}var g=r.getDomRefs?r.getDomRefs(true):r.getDomRef();if(g&&g.row){g.row.toggleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(i&&f)?i:f);}else{r.toggleStyleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(i&&f)?i:f);}},_getBindingProperty:function(f,n){if(f.getProperty){return f.getProperty(n);}else{var p=f.oEntityType.property;for(var i=0;i<p.length;i++){if(p[i].name==n){return p[i];}}return null;}},_getPageFilters:function(B){var p=this.oState.oSmartFilterbar.getFilters();for(var i=0;i<p.length;i++){if(p[i].aFilters!==undefined){var f=p[i].aFilters;for(var j=0;j<f.length;j++){var g=f[j];var n=g.sPath;if(!B.getProperty(n)){L.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}g.sPath=n;}}else{var g=p[i];var n=g.sPath;if(!B.getProperty(n)){L.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}g.sPath=n;}}return p;},_applyParamsToTableAsHighlight:function(u){if(!this.oState){return;}var f=this.oState.chartController.oChart;if(!f){return;}var p=this._getSelParamsFromChart(f);var g=f.getVisibleDimensions();var h=this.oState.oSmartChart._lastSelected;var j=this.oState.oSmartTable.getTable();var k=this._getTableBinding(j);var m=this.oState.chartController._chartInfo.drillStack;if(!k){L.error("No table binding to apply the selection(s) to");return;}var n=[];for(var i=0;i<p.length;i++){var o=p[i];var q={};for(var r in o){if(g.indexOf(r)==-1||!this._getBindingProperty(k,r)){continue;}q[r]=o[r];}n.push(q);}m.forEach(function(s){var r=s.sPath,v={};v[r]=s.oValue1;n.push(v);});var q={};n.forEach(function(s){for(var v in s){if(!q.hasOwnProperty(v)){q[v]=[s[v]];}else{q[v].push(s[v]);}}});this._paramListFiltered=n;this._lastSelected=h;this._paramMap=q;this._updateRows(u);},_setParamMap:function(f){var p=this._getSelParamsFromChart(f);var g=f.getVisibleDimensions();var h=this.oState.chartController._chartInfo.drillStack;var i={};if(!this.oState.oController.getOwnerComponent().getModel("_templPriv").getProperty('/alp/_ignoreChartSelections')){p.forEach(function(o){for(var k in o){if(g.indexOf(k)==-1){continue;}if(!i.hasOwnProperty(k)){i[k]=[o[k]];}else{i[k].push(o[k]);}}});}h.forEach(function(o){if(!i.hasOwnProperty(o.sPath)){i[o.sPath]=[o.oValue1];}else{i[o.sPath].indexOf(o.oValue1)===-1?i[o.sPath].push(o.oValue1):"";}});this._paramMap=i;},_expandByFilter:function(u){if(!this._enableExpandByFilter){return;}var f=this.oState.oSmartTable.getTable();var g=this._getTableBinding(f);if(g&&this._lastBinding!=g){var m=this;g.attachDataReceived(this._onBindingDataReceived,this);g.attachEvent("change",function(n){if(m._expandingProgrammatically){return;}var o=n.getParameter("reason");if(o=="expand"||o=="collapse"){m._inUserChartSelectMode=false;}});this._lastBinding=g;}if(u=="selection"||u=="bindingDataReceived"){this._firstVisibleRelevantEventTS=new Date().getTime();}if(u=="selection"){this._inUserChartSelectMode=true;}if(!this._inUserChartSelectMode){return;}var r=this._getTableRows();for(var i=0;i<r.length;i++){var h=r[i];var j=h.getBindingContext();if(!j){continue;}var k=f.getFirstVisibleRow()+i;if(this._isRowHighlighted(j.getObject())){if(f.isExpanded(k)){continue;}if(!h._bHasChildren){continue;}if(!g.findNode(k)){continue;}this._expandingProgrammatically=true;f.expand(k);this._expandingProgrammatically=false;}else{if(!f.isExpanded(k)){continue;}if(!h._bHasChildren){continue;}if(!g.findNode(k)){continue;}this._expandingProgrammatically=true;f.collapse(k);this._expandingProgrammatically=false;}}this._updateFirstVisibleRow(u);},_updateFirstVisibleRow:function(u){var f=this.oState.oSmartTable.getTable();var g=this._getTableBinding(f);var h=g.getTotalSize();if(h==0||(new Date().getTime()-this._firstVisibleRelevantEventTS)>250){return;}var f=this.oState.oSmartTable.getTable();if(u=="selection"&&(!this._paramListFiltered||this._paramListFiltered.length==0)){f.setFirstVisibleRow(0);return;}var j=g.getContexts(0,h);for(var i=0;i<j.length;i++){var r=j[i].getObject();if(!this._isRowHighlighted(r)){continue;}if(this._lastSelected&&!this._rowMatch(this._lastSelected,r)){continue;}var k=f.getFirstVisibleRow();if(u=="selection"||this.isFilter()){f.setFirstVisibleRow(i);}else{if(i>k){f.setFirstVisibleRow(i);}}break;}},_rowMatch:function(s,r){for(var n in s){if(n.indexOf("__")!=-1){continue;}if(!r.hasOwnProperty(n)){continue;}if(s[n]!=r[n]){return false;}}return true;},_updateExpandLevelInfo:function(g){if(!this._enableUpdateExpandLevelInfo){return false;}var T=this.oState.oSmartTable.getTable();if(!T.getNumberOfExpandedLevels){return false;}var B=T.getBinding();if(!B){return false;}var f=g.length;var h=false;if(f>=B.aMaxAggregationLevel.length){h=true;f=B.aMaxAggregationLevel.length-1;this.wasAtMaxLevel=true;}else{h=T.getNumberOfExpandedLevels()!=f||this.wasAtMaxLevel;this.wasAtMaxLevel=false;}if(h){if(f>=0){T.setNumberOfExpandedLevels(f);T.bindRows(T.getBindingInfo("rows"));}var i=T.getGroupedColumns();T.fireGroup({column:i[0],groupedColumns:i,type:S.GroupEventType.group});}return h;},_updateRows:function(u){var f=this.oState.oSmartTable.getTable();if(f instanceof A){this._expandByFilter(u);}},_getTableRows:function(){var f=this.oState.oSmartTable.getTable();if(f.getRows){return f.getRows();}else{return f.getItems();}},_isRowHighlighted:function(r){var p=this._paramMap;if(!p||d(p)){return false;}var m=true;for(var n in p){if(!r.hasOwnProperty(n)){continue;}if(p[n].indexOf(r[n])==-1){m=false;}}return m;},_getTableBinding:function(f){return f.getBinding()?f.getBinding():f.getBinding("items");},_applyChartSelectionOnTableAsFilter:function(o,f){var g=[];if(!f){return;}var p=this._getSelParamsFromChart(f);if(p.length>0){var h=f.getVisibleDimensions();for(var i=0;i<p.length;i++){var k=p[i],m=[];for(var n in k){if(h.indexOf(n)==-1){L.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}var q=false;var r=o.mParameters.bindingParams.filters;if(r.length>0){var r=r[0].aFilters?r[0].aFilters:r;for(var j=0;j<r.length;j++){var D=r[j].aFilters?r[j].aFilters:r;if(D.length==1){if(D[0].sPath===n&&D[0].sOperator==="EQ"&&D[0].oValue1===k[n]){q=true;}}}}if(!q){m.push(new F({path:n,operator:b.EQ,value1:k[n]}));}}if(m.length>0){g.push(new F(m,true));}}if(g.length>0){o.mParameters.bindingParams.filters.push(new F(g,false));}}},_latestUpdateRow:function(p){var f=this.isFilter();var r=this._getTableRows();var g=false;for(var i=0;i<r.length;i++){var h=r[i];if(!f){if(h.getBindingContext()){var j=h.getBindingContext().getObject();g=this._isRowHighlighted(j);}}var k=h.getDomRefs?h.getDomRefs(true):h.getDomRef();if(!k){continue;}if(k.row){k.row.toggleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(f&&p)?f:g);}else{$(k).toggleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(f&&p)?f:g);}}},_getSelParamsFromChart:function(f){var g=[];var o=this.oState.chartController._chartInfo;if(o.vizSelection){g=o.chartSelection.dataPoints;}return this._getSelParamsFromDPList(g);},_getSelParamsFromDPList:function(f){if(!f){return[];}var p=[];for(var i=0;i<f.length;i++){var g=f[i];var h=g.context;if(!h){if(g.dimensions){p.push(g.dimensions);}continue;}var k=h.getProperty(h.sPath);var m={};if(this._selectFilterByMeasure){for(var j=0;j<g.measures.length;j++){var n=g.measures[j];var v=k[n];m[n]=v;}}else{for(var n in k){m[n]=k[n];}}p.push(m);}return p;}});return t;});
