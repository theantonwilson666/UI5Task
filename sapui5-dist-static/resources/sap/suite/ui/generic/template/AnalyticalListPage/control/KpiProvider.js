sap.ui.define(["sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/CriticalityUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/genericUtilities/FeLogger"],function(K,C,F,a){"use strict";var l=new a("AnalyticalListPage.controller.KpiProvider").getLogger();var b=function(k){this._getDataFromAnnotations(k);};b.prototype._getDataFromAnnotations=function(c){var m=this;var M=c._oModel;var o=M.getMetaModel();var e=o.getODataEntitySet(c.getEntitySet());if(!e){l.error("KPI error details - Incorrect entity set");return;}var E=o.getODataEntityType(e.entityType);var q=c.getQualifier();var s,d,S,D;var p={};var k="com.sap.vocabularies.UI.v1.KPI#"+q;var f=E[k];if(f){if(f["DataPoint"]){D=this.getPathOrAnnotationPath(f["DataPoint"],true);}if(f["SelectionVariant"]){S=this.getPathOrAnnotationPath(f["SelectionVariant"],true);}if(f["ShortDescription"]){var g=K.getPrimitiveValue(f["ShortDescription"]);}var h=f.ID;var i=f.Detail&&f.Detail.SemanticObject;var j=f.Detail&&f.Detail.DefaultPresentationVariant;var A=f.Detail&&f.Detail.Action;p.kpiAnnotationPath=k;}else{var n="com.sap.vocabularies.UI.v1.SelectionPresentationVariant#"+q;p.selectionPresentationVariantPath=n;var r=E[n];if(!r){l.error("KPI error details - SelectionPresentationVariant does not have Path.");return;}if(r.SelectionVariant){S=this.getPathOrAnnotationPath(r.SelectionVariant);}if(r.PresentationVariant){var P=this.getPathOrAnnotationPath(r.PresentationVariant);}if(!P){l.error("KPI error details - PresentationVariant does not have Path.");return;}var t=E[P];var v=t&&t.Visualizations;if(v){v.forEach(function(Q){if(Q.AnnotationPath.indexOf("DataPoint")>0){D=m.getPathOrAnnotationPath(Q);}});}}if(!D){l.error("KPI error details - DataPoint does not have Path.");return;}d=E[D];if(!S){l.error("KPI error details - SelectionVariant does not have a path");}s=E[S];p.dataPointPath=D;p.selectionVariantPath=S;var u=d.Value.Path;var w=s&&s.SelectOptions,x=s&&s.Parameters;var y=o.getODataProperty(E,d.Value.Path);var U=K.getUnitofMeasure(M,y);var z=d.Title,B=K.getPrimitiveValue(z);if(B===undefined){B="";}this.kpiConfig={entityTypeProperty:y,props:{title:B,value:u,unitOfMeasure:U},entitySet:e,dataPoint:d,selectionVariant:s,selectOptions:w,parameters:x,kpiPropertyPath:p};if(f){this.kpiConfig.bIsKpiAnnotaion=true;}if(i&&A&&h){this.kpiConfig.navigation={semanticObject:i.String,action:A.String,kpiId:h.String};}if(f&&!j){this.kpiConfig.oDefaultPV=false;}if(g){this.kpiConfig.props.shortDescription=g;}var G=F.readProperty(d,"Criticality"),H=G&&(G.EnumMember)?K.getPrimitiveValue(G):undefined,I=(G&&G.Path)?this._getCriticalityParameters(G):undefined;if(H){this.kpiConfig.criticality={criticalityType:H};}else if(I){this.kpiConfig.criticality={criticalityPath:I};}else{var J=(!H&&F.readProperty(d,"CriticalityCalculation.ImprovementDirection.EnumMember"))?K.getPrimitiveValue(d.CriticalityCalculation.ImprovementDirection):undefined;if(J){var T=this._getCriticalityParameters(d.CriticalityCalculation.ToleranceRangeLowValue),L=this._getCriticalityParameters(d.CriticalityCalculation.ToleranceRangeHighValue),N=this._getCriticalityParameters(d.CriticalityCalculation.DeviationRangeLowValue),O=this._getCriticalityParameters(d.CriticalityCalculation.DeviationRangeHighValue);this.kpiConfig.criticalityCalculation={improveDirection:J,toleranceLow:T,toleranceHigh:L,deviationLow:N,deviationHigh:O};}}};b.prototype._getCriticalityParameters=function(c){if(c){if(c.Path){return{path:"/"+c.Path};}else{return K.getPrimitiveValue(c);}}};b.prototype.getCriticalityFromEnum=function(c){return C.getCriticalityIndicatorFromEnum(c);};b.prototype.getConfig=function(){return this.kpiConfig;};b.prototype.getImproveDirection=function(d,D,s,c,v){C.setVals(d,D,s,c,v);return(C[this.kpiConfig.criticalityCalculation.improveDirection]());};b.prototype.getPathOrAnnotationPath=function(e,i){var p=i?e.Path:(e.Path||e.AnnotationPath);if(/^@/.test(p)){p=p.slice(1);}return p;};return b;},true);
