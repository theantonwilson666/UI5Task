sap.ui.define(["sap/ui/core/Control","sap/ui/model/Sorter","sap/ui/model/analytics/odata4analytics","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/ui/core/format/NumberFormat","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/ui/core/format/DateFormat","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/AnalyticalListPage/util/CriticalityUtil","sap/suite/ui/generic/template/listTemplates/listUtils","sap/base/util/extend","sap/base/util/deepExtend"],function(C,S,d,F,N,v,D,c,f,L,g,h){"use strict";var l=new c("AnalyticalListPage.control.visualfilterbar.FilterItemMicroChart").getLogger();var j="Donut";var k="Line";var m="Bar";var I="__IS_OTHER__";var n=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroChart",{metadata:{properties:{selectFilters:{type:"any",group:"Misc",defaultValue:null},filterRestriction:{type:"string",group:"Misc",defaultValue:null},entitySet:{type:"string",group:"Misc",defaultValue:null},lazyLoadVisualFilter:{type:"boolean",group:"Misc",defaultValue:true},dimensionField:{type:"string",group:"Misc",defaultValue:null},dimensionFieldIsDateTime:{type:"boolean",group:"Misc",defaultValue:false},dimensionFieldIsDateTimeOffset:{type:"boolean",group:"Misc",defaultValue:false},dimensionFieldDisplay:{type:"string",group:"Misc",defaultValue:null},dimensionFilter:{type:"any",group:"Misc",defaultValue:null},dimensionFilterExternal:{type:"sap.ui.model.Filter",group:"Misc",defaultValue:null},measureField:{type:"string",group:"Misc",defaultValue:null},unitField:{type:"string",group:"Misc",defaultValue:null},isCurrency:{type:"boolean",group:"Misc",defaultValue:false},isMandatory:{type:"boolean",group:"Misc",defaultValue:false},isDropDown:{type:"boolean",group:"Misc",defaultValue:false},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},title:{type:"string",group:"Misc",defaultValue:""},outParameter:{type:"string",group:"Misc",defaultValue:null},inParameters:{type:"object[]",group:"Misc",defaultValue:null},parentProperty:{type:"string",group:"Misc",defaultValue:null},sortOrder:{type:"object[]",group:"Misc",defaultValue:null},scaleFactor:{type:"string",group:"Misc",defaultValue:null},numberOfFractionalDigits:{type:"string",group:"Misc",defaultValue:null},textArrangement:{type:"string",group:"Misc",defaultValue:sap.ui.comp.smartfilterbar.DisplayBehaviour.descriptionAndId},chartQualifier:{type:"string",group:"Misc",defaultValue:null},smartFilterId:{type:"string",group:"Misc",defaultValue:null},isParameter:{type:"boolean",group:"Misc",defaultValue:false},stringdate:{type:"string",group:"Misc",defaultValue:""}},aggregations:{control:{type:"sap.ui5.controls.microchart",multiple:false}},events:{filterChange:{},titleChange:{},beforeRebindVisualFilter:{}}},renderer:function(r,o){r.write("<div");r.writeControlData(o);r.writeClasses();r.addStyle("width","100%");document.body.classList.contains("sapUiSizeCozy")?r.addStyle("height","9.9rem"):r.addStyle("height","7.9rem");r.writeStyles();r.write(">");r.renderControl(o.getAggregation("control"));r.write("</div>");}});n.prototype._formattingId="__UI5__ShortIntegerMaxFraction2";n.prototype._maxFractionalDigits=2;n.prototype._maxFractionalDigitsValsLessThanZero=7;n.prototype._minFractionalDigits=0;n.prototype._shortRefNumber;n.prototype._isTriggeredBySync=false;n.prototype._multiUnit=false;n.prototype.technicalIssueMessage="TECHNICAL_ISSUES_OVERLAY_MESSAGE";n.prototype.noDataIssueMessage="NO_DATA_FOUND_OVERLAY_MESSAGE";n.prototype.requiredFilterMessage="REQUIRED_FIELDS_OVERLAY_MESSAGE";n.prototype.multipleCurrencyMessage="MULTIPLE_CURRENCY_OVERLAY_MESSAGE";n.prototype.multipleUnitMessage="MULTIPLE_UNIT_OVERLAY_MESSAGE";n.prototype.hiddenMeasureMessage="HIDDEN_MEASURE_OVERLAY_MESSAGE";n.prototype.invalidMeasureForDonutMessage="INVALID_MEASURE_DONUT_MESSAGE";n.prototype.valuehelpAllMandatoryFilters={};n.prototype.oDataQueryOptions=["$select","$top","$expand","$inlinecount","$orderby","$filter","$skip","$format"];n.prototype.init=function(){this._bAllowBindingUpdateOnPropertyChange=false;this._attachChartEvents();};n.prototype._attachChartEvents=function(){var a=this;this._chart.addEventDelegate({onAfterRendering:function(){if(a._getChartAggregations().length){if(a._multiUnit){a.applyOverlay(a.getIsCurrency()?a.multipleCurrencyMessage:a.multipleUnitMessage);if(a.data("isDialogFilterItem")==="true"){F._updateVisualFilterAria(a.getParent().getParent());}}}}});this._chart.attachSelectionChanged(this._onSelectionChanged,this);};n.prototype._getCurrentSelectedChart=function(r){if(this._chart.getPoints){return r?k:"point";}else if(this._chart.getSegments){return r?j:"segment";}else if(this._chart.getBars){return r?m:"bar";}};n.prototype._getCustomData=function(e){var s=this._getCurrentSelectedChart();var a=(s)?e.getParameter(s):undefined;if(s&&a){var b=a.getCustomData(),V=b[0].getValue(),i;if(V instanceof Date){V=(this.getDimensionFieldIsDateTimeOffset())?V:F.convertLocalDatetoUTCDate(V);}else if(this.getDimensionFieldIsDateTime()&&this._isStringDateType()=="yearmonth"){i=V;}else if(a.getLabel()===this._getI18nText("NOT_ASSIGNED")){i="";}else{i=a&&a.getLabel();}var o={dimValue:V,dimValueDisplay:i};return o;}};n.prototype._getEntityParameters=function(M,e){var a={};if(this.getSmartFilterId()){var s=sap.ui.getCore().byId(this.getSmartFilterId());var b=L.getSelectionVariantParameterNamesWithoutNavigation(this.getSelectFilters()&&this.getSelectFilters().Parameters);var o=s.getEntitySet()===e?s.getAnalyticalParameters():[];var i=this.getSelectFilters()&&this.getSelectFilters().SelectOptions;var p=this.checkSearchable(M,e,s,b,i);if(!p){this.applyOverlay(this.requiredFilterMessage);return;}if(b){b.forEach(function(P){a[P.PropertyName.PropertyPath]=P.PropertyValue.String;});}if(o){var q=s.getFilterData(true);var r=JSON.parse(s.data('dateFormatSettings'));o.forEach(function(t){var V=q["$Parameter."+t.name];if(V){if(t.type==="Edm.Time"&&V instanceof Date){if(r&&!r.UTC){V=new Date(V.valueOf()+V.getTimezoneOffset()*60*1000);}V={__edmType:"Edm.Time",ms:(((V.getHours()*60)+V.getMinutes())*60+V.getSeconds())*1000+V.getMilliseconds()};}else if(r&&r.UTC&&V instanceof Date){V=this._getDateInUTCOffset(V);}a[t.name]=V;}}.bind(this));}return a;}return;};n.prototype._executeRebindVisualFilterExtension=function(e,a,b,i,E){var o={sEntityType:e,sDimension:a,sMeasure:b,oContext:{filters:i,queryParameters:{},sorters:this._sorters,entityParameters:E,groupId:undefined}};this.fireBeforeRebindVisualFilter(o);return o.oContext;};n.prototype._onSelectionChanged=function(e){var s=this.getFilterRestriction(),o=this._getCustomData(e),b=e.getParameter("selected"),a=(s==="single"&&o.dimValue===I&&b);if(o.dimValue===I&&b&&this.getIsDropDown()){e.getParameter("segment").setSelected(false);return;}if(a){e.getParameter("segment").setSelected(false);}if(b&&o.dimValue===I&&s==="multiple"||(b&&o.dimValue!==I)){this._onChartSelectData(e);}else if(!b){this._onChartDeselectData(e);}};n.prototype._onChartSelectData=function(e){var o,s=this.getFilterRestriction();if(s==="multiple"){o=h({items:[],ranges:[],value:null},this.getDimensionFilter());var a=this._getCustomData(e),b=this._getCurrentSelectedChart(true);if(b===j){o=this._applyDonutChartSelections(a,o);}else if(a.dimValue instanceof Date){o.ranges.push({exclude:false,keyField:this.getDimensionField(),operation:"EQ",value1:a.dimValue,value2:null});}else if(a.dimValue===""){o.ranges.push({exclude:false,keyField:this.getDimensionField(),operation:"Empty",value1:a.dimValue,value2:null});}else{o.items.push({key:a.dimValue,text:a.dimValueDisplay});}}else{o=this.getDimensionFilter();if(o){o=null;var i=e.getParameter("bar")||e.getParameter("point")||e.getParameter("segment");this._setSelectedAggregation(i);i.setSelected(true);}var a=this._getCustomData(e);o=a.dimValue;}this.setDimensionFilter(o);this.fireFilterChange();};n.prototype._setSelectedAggregation=function(s){var a=this._chart.setSelectedBars||this._chart.setSelectedPoints||this._chart.setSelectedSegments;a.call(this._chart,s);};n.prototype._getChartAggregations=function(){var a=this._chart.getPoints||this._chart.getSegments||this._chart.getBars;return a.call(this._chart);};n.prototype._onChartDeselectData=function(e){var a=this;var o,s=this.getFilterRestriction(),b=this._getCustomData(e),u=[],U=[];if(s==="single"){o=null;}else{o=h({},this.getDimensionFilter());var i=(o&&o.items)?o.items:undefined,p=(o&&o.ranges)?o.ranges:undefined,q=(o&&o.value)?o.value:null;if(i){i.forEach(function(r){var E=F.getResolvedDimensionValue(r.key),t=F.getResolvedDimensionValue(b.dimValue);if(E!==t){u.push(r);}});}o.items=u;if(q){if(b.dimValue===q){o.value=null;}}if(p){p.forEach(function(r){if(r.operation==="EQ"&&b.dimValue!==I&&r.exclude){U.push(r);}else if(r.operation==="EQ"&&!r.exclude){if(r.value1 instanceof Date&&b.dimValue instanceof Date){if(a.getDimensionFieldIsDateTimeOffset()){if(F.getDateTimeInMedium(r.value1)!==F.getDateTimeInMedium(b.dimValue)){U.push(r);}}else if(F.getDateInMedium(r.value1)!==F.getDateInMedium(b.dimValue)){U.push(r);}}else if(typeof r.value1==="string"&&b.dimValue instanceof Date){if(F.getDateTimeInMedium(new Date(r.value1))!==F.getDateTimeInMedium(b.dimValue)){U.push(r);}}else if(r.value1!==b.dimValue){U.push(r);}}else if(r.operation!=="EQ"&&!r.exclude&&r.value1!==b.dimValue){U.push(r);}});}o.ranges=U;}this.setDimensionFilter(o);this.fireFilterChange();};n.prototype._updateBinding=function(){if(F.isVisualFilterLazyLoaded(this)){return;}this.applyOverlay();this._chart.setBusy(true);var s=this._getCurrentSelectedChart(true);var i=s===j;if(s===k){this._chart.unbindPoints();}else if(s===m){this._chart.unbindBars();}else if(i){this._chart.unbindSegments();}var e=this.getEntitySet(),a=this.getDimensionField(),b=this.getDimensionFieldDisplay(),o=this.getMeasureField(),u=this.getUnitField(),p=this.getDimensionFilterExternal(),q=[],r=this.getSortOrder(),M=this.getModel(),t=M.getMetaModel(),w=this._getSorter(r);this._sorters=w.sorter;q=w.sortFields;if(!e||!o||!a||!b){return;}if(this._determineHiddenVisualFilter(t,e,o)){this.applyOverlay(this.hiddenMeasureMessage);return;}if(i){if(this._determineIfInvalidMeasure(t,e,o)){this.applyOverlay(this.invalidMeasureForDonutMessage);return;}}var x=[o,a],y=F.IsNavigationProperty(this.getModel(),e,b)?b.split("/")[0]:null,z=F.getKeysForNavigationEntitySet(t,this.getEntitySet(),y),x=F.getVisualFilterSelectFields(o,a,b,u,q,z);var A=(i&&this._inParameterFilterList&&this._inParameterFilterList.aFilters&&this._inParameterFilterList.aFilters.length)?[this._inParameterFilterList]:[];var B=[];if(p&&p.aFilters&&p.aFilters.length>0){B=[p];}var E=this;var G=(!i)&&this.getFixedCount();var M=this.getModel(),V=this.getModel("visualFilter")||M;var H=this._getEntityParameters(M,e);if(!(H instanceof Object)){return;}var J=this._executeRebindVisualFilterExtension(e,a,o,B,H),K=J.groupId,O="/"+e;if(M){var P=f.getDataPoint(M,this);this.setNumberOfFractionalDigits(null);if(P){(P.ValueFormat&&P.ValueFormat.ScaleFactor)?this.setScaleFactor(F.getPrimitiveValue(P.ValueFormat.ScaleFactor)):this.setScaleFactor(null);(P.ValueFormat&&P.ValueFormat.NumberOfFractionalDigits)?this.setNumberOfFractionalDigits(F.getPrimitiveValue(P.ValueFormat.NumberOfFractionalDigits)):this.setNumberOfFractionalDigits(null);var R=f.getCriticalityRefProperties(P);}O=this._getBindingPathforVisualFilter(M,e,H);if(!O){return;}if(this._oObject){this._oObject.abort();}if(this._oTop4ReadObject){this._oTop4ReadObject.abort();}if(this._oTotalReadObject){this._oTotalReadObject.abort();}if(this._determineInteger(t,e,o)){this.setNumberOfFractionalDigits(0);}var U={};var Q={async:true,filters:B,urlParameters:U};if(K){Q.groupId=K;}if(!i){g(Q,{sorters:this._sorters,success:function(X,Y){E._oObject=null;if(P&&(P.Criticality||P.CriticalityCalculation)){X=f.CalculateCriticality(P,X,E.getMeasureField());}else{X=f.CalculateDimensionCriticality(M,E.getDimensionField(),E.getEntitySet(),X);}E._onDataReceived(X);},error:function(X){l.error("Error reading URL:"+X);if(X&&X.statusCode!==0&&X.statusText!=="abort"){E.applyOverlay(E.technicalIssueMessage);E._oObject=null;}}});this._updateBindingInfo(Q,x,R,G,J,y,i);this._fetchData(V,O,Q,i);}else{this._updateBindingInfo(Q,[o],R,1,J,y,i,true,A);var T=this._fetchData(V,O,Q,i,true,P);Q.filters=B;this._updateBindingInfo(Q,x,R,4,J,y,i,false);var W=this._fetchData(V,O,Q,i,false,P);Promise.all([W,T]).then(function(X){var Y=X[0].data;var Z=X[0].iDataLength;var $=X[1].data;var _=X[1].iDataLength;if(!Z){E.applyOverlay(E.noDataIssueMessage);}else if(Z<=3){E._onDataReceived(Y);}else if(Z>3){if(_){E._onDataReceived(Y,$);}else{E.applyOverlay(E.noDataIssueMessage);}}},function(X){var Y=X.error;var Z=X.bToFetchTotalData;if(!Y||(Y.statusCode!==0&&Y.statusText!=="abort")){if(Z===true){E._oTotalReadObject=null;}else{E._oTop4ReadObject=null;}E.applyOverlay(E.technicalIssueMessage);}});}}};n.prototype._updateBindingInfo=function(o,s,r,a,e,b,i,t,p){o.urlParameters={"$select":r?[r].concat(s).join(","):s.join(","),"$top":a};if(Object.keys(e.queryParameters).length>0){Object.keys(e.queryParameters).forEach(function(K){if(this.oDataQueryOptions.indexOf(K)<0){o.urlParameters[K]=e.queryParameters[K];}}.bind(this));}if(i?(b&&!t):b){g(o.urlParameters,{"$expand":b});}if(i&&(!t)){o.sorters=this._sorters;}else if(i&&t){o.filters=p;}};n.prototype._fetchData=function(V,b,o,i,t,a){var e=this;if(i){return new Promise(function(p,q){if(!V){q({error:null,bToFetchTotalData:t});}o.success=function(r,s){if(t===true){e._oTotalReadObject=null;}else{e._oTop4ReadObject=null;}if(a&&(a.Criticality||a.CriticalityCalculation)){r=f.CalculateCriticality(a,r,e.getMeasureField());}else if(!t){r=f.CalculateDimensionCriticality(e.getModel(),e.getDimensionField(),e.getEntitySet(),r);}var u=(r&&r.results&&r.results.length)?r.results.length:0;p({data:r,iDataLength:u});};o.error=function(r,t){q({error:r,bToFetchTotalData:t});};if(t){e._oTotalReadObject=V.read(b,o);}else{e._oTop4ReadObject=V.read(b,o);}});}this._oObject=V.read(b,o);};n.prototype._getSorter=function(s){var a=[],b=[],e=[];for(var i=0;i<s.length;i++){a[i]=s[i].Field.String;b[i]=s[i].Descending.Boolean;e.push(new S(a[i],b[i]));}var o={sorter:e,sortFields:a};return o;};n.prototype._getNumberFormatter=function(s){var a=N.getIntegerInstance({style:"short",showScale:false,shortRefNumber:s});return a;};n.prototype.setWidth=function(w){this.setProperty("width",w);};n.prototype.setHeight=function(a){this.setProperty("height",a);};n.prototype.setEntitySet=function(e){this.setProperty("entitySet",e);};n.prototype.setDimensionField=function(a){this.setProperty("dimensionField",a);};n.prototype.setDimensionFieldIsDateTime=function(a){this.setProperty("dimensionFieldIsDateTime",a);};n.prototype.setDimensionFieldDisplay=function(a){this.setProperty("dimensionFieldDisplay",a);};n.prototype.setMeasureField=function(a){if(a&&a.constructor===Object){if(a.value){this.setProperty("measureField",a.value);}if(a.bUpdateBinding){this._updateBinding();}}else if(a&&a.constructor===Array){this.setProperty("measureField",a);}else{this.setProperty("measureField",a);}};n.prototype.setUnitField=function(u){this.setProperty("unitField",u);};n.prototype.setSortOrder=function(s){if(s&&s.constructor===Object){if(s.value){this.setProperty("sortOrder",s.value);}if(s.bUpdateBinding){this._updateBinding();}}else if(s&&s.constructor===Array){this.setProperty("sortOrder",s);}else{this.setProperty("sortOrder",s);}};n.prototype.setDimensionFilterExternal=function(a){this.setProperty("dimensionFilterExternal",a);if(this._bAllowBindingUpdateOnPropertyChange){this._updateBinding();}};n.prototype.getP13NConfig=function(){var p=["width","height","filterRestriction","isDropDown","sortOrder","measureField","scaleFactor","numberOfFractionalDigits","chartQualifier","entitySet","dimensionField","dimensionFieldDisplay","dimensionFieldIsDateTime","dimensionFilter","unitField","isCurrency","isMandatory","outParameter","inParameters","parentProperty"];var o={};for(var i=0;i<p.length;i++){var a=p[i];o[a]=this.getProperty(a);if((a=="outParameter"||a=="inParameters")&&o[a]==""){o[a]=undefined;}}return o;};n.prototype.setDimensionFilter=function(a,i){this.setProperty("dimensionFilter",a);};n.prototype._onDataReceived=function(a){if(!a){return;}this.data("sOverlay","none");if(!this.getParent()){this.data("needsToUpdateAria","true");}else{this.data("needsToUpdateAria","false");if(this.data("isDialogFilterItem")==="true"){F._updateVisualFilterAria(this.getParent().getParent());}}this._determineUnit(a);this._getShortRefNumber(a.slice(0));};n.prototype._determineUnit=function(a){this._multiUnit=false;var u=this.getUnitField();if(u){var p=a[0][u];for(var i=1;i<a.length;i++){if(a[i].dimensionValue!==I){var b=a[i][u];}if(b!=p){if(a.length>1){this._multiUnit=true;}break;}p=b;}this._applyUnitValue(this._multiUnit?"":p);}else{this._applyUnitValue("");}};n.prototype._applyUnitValue=function(a){if(this._lastUnitValue!=a){this._lastUnitValue=a;this.fireTitleChange();}};n.prototype._getShortRefNumber=function(o){this._scaleValue="";this._shortRefNumber=undefined;var s=this.getScaleFactor(),a;if(!s){var b=this._getScaleFactorFromMedian(o);s=b.iShortRefNumber;a=b.scale;}else{var e=this._getNumberFormatter(s);a=e.getScale()?e.getScale():"";}this._shortRefNumber=s;this._scaleValue=a;this.fireTitleChange();};n.prototype._getScaleFactorFromMedian=function(o){var M=this.getMeasureField();o.sort(function(a,b){if(Number(a[M])<Number(b[M])){return-1;}if(Number(a[M])>Number(b[M])){return 1;}return 0;});var e=o.length/2,p=e%1===0?(parseFloat(o[e-1][M])+parseFloat(o[e][M]))/2:parseFloat(o[Math.floor(e)][M]),q=p,s;for(var i=0;i<14;i++){s=Math.pow(10,i);if(Math.round(Math.abs(q)/s)<10){break;}}var r=this._getNumberFormatter(s);for(var i=0;i<o.length;i++){var t=o[i],u=r.format(t[M]),w=u.split(".");if((!w[1]&&parseInt(w[0],10)===0)||(w[1]&&parseInt(w[0],10)===0&&w[1].indexOf('0')===0)||(u/1000)>=1000){s=undefined;break;}}return{iShortRefNumber:s,scale:s?r.getScale():""};};n.prototype._getScaleFactor=function(a){var a=parseFloat(a);var p=this._minFractionalDigits;for(var i=0;i<14;i++){var s=Math.pow(10,i);if(Math.round(Math.abs(a)/s,p-1)<10){return s;}}return undefined;};n.prototype.getTitle=function(a){var b=this.getModel();if(!b){return"";}var e=F.getPropertyNameDisplay(b,this.getEntitySet(),this.getMeasureField(),a);var i=F.getPropertyNameDisplay(b,this.getEntitySet(),this.getDimensionField(),a);var u=this._lastUnitValue?this._lastUnitValue:"";var s=this._scaleValue?this._scaleValue:"";var o=this.getModel("i18n");if(!o){return"";}var r=o.getResourceBundle();var t=r.getText("VIS_FILTER_TITLE_MD",[e,i]);var p=s+" "+u;p=p.trim();p=p.indexOf("%")>-1?"":p;var q=F.getPropertyNameDisplay(b,this.getEntitySet(),this.getMeasureField(),a,true);var w=F.getPropertyNameDisplay(b,this.getEntitySet(),this.getDimensionField(),a,true);var x=r.getText("VIS_FILTER_TITLE_MD",[q,w]);var y={titleMD:t,titleUnitCurr:p,titleQuickInfo:x};return y;};n.prototype.getFormattedNumber=function(a,s){var b=this.getNumberOfFractionalDigits();if(b===""||b===undefined){b="1";}else{if(Number(b)>1){b="1";}}var e=N.getFloatInstance({style:"short",decimals:Number(b),showScale:s,shortRefNumber:this._shortRefNumber,minFractionDigits:this._minFractionalDigits,maxFractionDigits:this._maxFractionalDigits});return e.format(parseFloat(a));};n.prototype._getFormattedNumberWithUoM=function(a,U){U=(U)?U:"";var o=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var b=N.getFloatInstance({maxFractionDigits:2,groupingEnabled:true},o).format(a);return(U==="%")?b+"%":b+" "+U;};n.prototype._getDisplayedValue=function(a,u){var s=(this._scaleValue===""),b=this.getFormattedNumber(a,s),i=(u==="%");return(i)?b+"%":""+b;};n.prototype._getToolTip=function(a,b,u,e){var i=this.getModel("i18n");if(!i){return"";}var r=i.getResourceBundle();var o=this._getFormattedNumberWithUoM(b,u);var p;switch(e){case"Good":p=r.getText("VIS_FILTER_TOOLTIP_STATUS_GOOD");break;case"Error":p=r.getText("VIS_FILTER_TOOLTIP_STATUS_ERROR");break;case"Critical":p=r.getText("VIS_FILTER_TOOLTIP_STATUS_CRITICAL");break;default:p="Neutral";}if(p==="Neutral"){return a+" "+o;}else{return a+" "+o+"\n"+p;}};n.prototype._getSelected=function(o,s){var b=false,a=this.getFilterRestriction(),e=[];if(o){if(a==='multiple'){if(o.items){o.items.forEach(function(q){var t=F.getResolvedDimensionValue(q.key),u=F.getResolvedDimensionValue(s);if(t===u){b=true;}});}if(o.value&&o.value===s){b=true;return b;}if(o.ranges){var e=o.ranges.filter(function(r){if(r.exclude&&(r.operation==='EQ'||r.operation==='Empty')){return r;}});for(var i=0;i<o.ranges.length;i++){var r=o.ranges[i];if((r.operation==="EQ"||r.operation==='Empty')&&(r.value1||r.value1==="")&&!r.exclude){if(r.value1 instanceof Date&&s instanceof Date){if(this.getDimensionFieldIsDateTimeOffset()){if(F.getDateTimeInMedium(r.value1)===F.getDateTimeInMedium(s)){b=true;break;}}else if(F.getDateInMedium(r.value1)===F.getDateInMedium(s)){b=true;break;}}else if(r.value1===s||this._isDateTimeFieldSelected(r.value1,s)){b=true;break;}}}if(b){for(var i=0;i<e.length;i++){if(e[i].value1===s&&e[i].operation==='EQ'){b=false;break;}}}if(e.length===2&&s===I){var V=0,p=this._chart.getSegments();p.forEach(function(q){var t=q.getCustomData()[0].getValue();e.forEach(function(E){if(E.value1.indexOf(t)>-1){V++;}});});if(V===2){b=true;}}}}else if(o instanceof Date&&s instanceof Date){if(this.getDimensionFieldIsDateTimeOffset()){if(F.getDateTimeInMedium(o)===F.getDateTimeInMedium(s)){b=true;}}else if(F.getDateInMedium(o)===F.getDateInMedium(s)){b=true;}}else if(o&&o===s){b=true;}else if(this._isDateTimeFieldSelected(o,s)){b=true;}}return b;};n.prototype._isDateTimeFieldSelected=function(o,s){if(this.getDimensionFieldIsDateTime()){if(typeof o==="string"&&s instanceof Date){if(F.getDateInMedium(new Date(o))===F.getDateInMedium(s)){return true;}}else if(o instanceof Date&&typeof s==="string"){var a=D.getDateInstance({pattern:"yyyyMMdd"});var b=a.parse(s);if(F.getDateInMedium(b)===F.getDateInMedium(o)){return true;}}}else if(this.getDimensionFieldIsDateTimeOffset()){if(typeof o==="string"&&s instanceof Date){if(F.getDateTimeInMedium(new Date(o))===F.getDateTimeInMedium(s)){return true;}}}return false;};n.prototype._getLabel=function(o,s){if(this.getDimensionFieldIsDateTime()){if(o instanceof Date){return F.getDateInMedium(F.convertLocalDatetoUTCDate(o));}else if(this._isStringDateType()=="yearmonthday"){return F.formatStringDate(o,s||"");}else if(this._isStringDateType()=="yearmonth"){return s===I?o:F.formatStringDateYearMonth(o);}else if(this._isStringDateType()=="yearweek"){return s===I?o:F.formatStringDateYearWeek(o);}else if(this._isStringDateType()=="yearquarter"){return s===I?o:F.formatStringDateYearQuarter(o);}else if(this._isStringDateType()=="fiscalyearperiod"){return s===I?o:F.formatStringFiscalYearPeriod(o);}else{return o;}}else if(this.getDimensionFieldIsDateTimeOffset()){return F.getDateTimeInMedium(o);}else{var t=this.getTextArrangement();return F.getTextArrangement(o,s,t);}};n.prototype._getChartAggregationSettings=function(i){var s=sap.ui.getCore().byId(this.getSmartFilterId());var a=i?'dimensionValue':this.getDimensionField(),b=this.getDimensionFieldDisplay(),M=this.getMeasureField(),u=this.getUnitField(),e=(a===b)?[b]:[b,a],t=(a===b)?[b,M,""]:[b,M,a],U=u?t.push(u):t,o=this,p={label:{parts:e,formatter:function(q,a){return o._getLabel(q,a)||o._getI18nText("NOT_ASSIGNED");}},value:{path:M,formatter:function(q){return parseFloat(q);}},color:"{color}",displayedValue:{parts:[M,u],formatter:function(q,r){return o._getDisplayedValue(q,r);}},tooltip:{parts:U.constructor===Array?U:t,formatter:function(q,r,a,w){q=q||q===""||q===0?q:"";a=a||a===""||a===0?a:"";a=a.constructor===Object?"":a;q=o._getLabel(q,a)||o._getI18nText("NOT_ASSIGNED");return o._getToolTip(q,r,w,this.getColor());}},selected:{parts:s.isDialogOpen()?["_dialogFilter>/"+o.getParentProperty(),a]:["_filter>/"+o.getParentProperty(),a],formatter:function(q,r){if(r instanceof Date){r=o.getDimensionFieldIsDateTimeOffset()?r:F.convertLocalDatetoUTCDate(r);}return o._getSelected(q,r);}},customData:{Type:"sap.ui.core.CustomData",key:a,value:"{"+a+"}"}};return p;};n.prototype.applyOverlay=function(i){var p=this.data("sPath");if(p){var s=p+"/showChartOverlay";var a=this.getModel('_visualFilterDialogModel')?this.getModel('_visualFilterDialogModel'):this.getModel('_visualFilterConfigModel');a.setProperty(s,(i?true:false));if(i){var o=p+"/overlayMessage";a.setProperty(o,i);this.data("sOverlay","true");if(this.data("isDialogFilterItem")==="true"){this.data("needsToUpdateAria","true");}this.fireTitleChange();}}};n.prototype.considerAnalyticBinding=function(b,s){if(s&&s.getAnalyticBindingPath&&s.getConsiderAnalyticalParameters()){try{var a=s.getAnalyticBindingPath();if(a){return a;}}catch(e){l.warning("Mandatory parameters have no values");}}return b;};n.prototype._getBindingPathforVisualFilter=function(o,e,E){var p="";var a=new d.Model(d.Model.ReferenceByModel(o));var q=a.findQueryResultByName(e);var b=new d.QueryResultRequest(q);var i=q&&q.getParameterization();if(i){b.setParameterizationRequest(new d.ParameterizationRequest(i));if(E){Object.keys(E).forEach(function(K){b.getParameterizationRequest().setParameterValue(K,E[K]);});}}try{p=b.getURIToQueryResultEntitySet();}catch(r){q=b.getQueryResult();p="/"+q.getEntitySet().getQName();l.error("getEntitySetPathWithParameters","binding path with parameters failed - "+r||r.message);}return p;};n.prototype.checkSearchable=function(o,e,s,p,a){var b=new d.Model(d.Model.ReferenceByModel(o));var q=b.findQueryResultByName(e);var i=q&&q.getParameterization(),r=[],t=true;t=F.checkManditoryFieldsFilled(s);if(!t){n.prototype.requiredFilterMessage="REQUIRED_FIELDS_OVERLAY_MESSAGE";return t;}if(i){var u=[];var w=i.getAllParameters();for(var x in w){if(!w[x].isOptional()){u.push(w[x].getName());}}u.forEach(function(P){p&&p.forEach(function(B){if(B.PropertyName.PropertyPath===P&&B.PropertyValue.String){r.push("$Parameter."+B.PropertyName.PropertyPath);}});});n.prototype.requiredFilterMessage="REQUIRED_VH_FIELDS_OVERLAY_MESSAGE";if(s.getEntitySet()===e){n.prototype.requiredFilterMessage="REQUIRED_FIELDS_OVERLAY_MESSAGE";var A=s.getFilterData(true);u.forEach(function(P){if(A["$Parameter."+P]&&r.indexOf("$Parameter."+P)<0){r.push("$Parameter."+P);}});}if(u.length!==r.length){t=false;return t;}}if(s.getEntitySet()===e){n.prototype.requiredFilterMessage="REQUIRED_FIELDS_OVERLAY_MESSAGE";var y=s.determineMandatoryFilterItems();var y=y.filter(function(B){return!B._bIsParameter;});t=y.every(function(B){return F.checkFilterHasValueFromSelectionVariantOrSmartFilterBar(B.getName(),B.getName(),a,s);});}else{n.prototype.requiredFilterMessage="REQUIRED_VH_FIELDS_OVERLAY_MESSAGE";var z;if(!n.prototype.valuehelpAllMandatoryFilters[e]){n.prototype.valuehelpAllMandatoryFilters[e]=F.getAllMandatoryFilters(o,e);}z=F.getAllMandatoryFiltersMapping(n.prototype.valuehelpAllMandatoryFilters[e],this.getInParameters());t=z.aMappedFilterList.every(function(B){return F.checkFilterHasValueFromSelectionVariantOrSmartFilterBar(B.valueListProperty,B.localDataProperty,a,s);});if(!t){return t;}t=z.aMappingMissingFilterList.every(function(B){var H=a&&F.checkFilterHasValueFromSelectionVariant(a,B);return H;});}return t;};n.prototype._getDateInUTCOffset=function(o){return new Date(o.valueOf()-o.getTimezoneOffset()*60*1000);};n.prototype._isStringDateType=function(){var o=this.getCustomData();var s;o.forEach(function(a){if(a.getKey()=='stringdate'){s=a.getValue();}});return s;};n.prototype._determineHiddenVisualFilter=function(M,e,a){var o=this._getMeasureProperty(M,e,a);if(o[v.Hidden]&&o[v.Hidden].Bool==="true"){return true;}};n.prototype._determineIfInvalidMeasure=function(M,e,a){var o=this._getMeasureProperty(M,e,a);if(o["com.sap.vocabularies.Analytics.v1.AccumulativeMeasure"]&&o["com.sap.vocabularies.Analytics.v1.AccumulativeMeasure"].Bool==="false"){return true;}return false;};n.prototype._getMeasureProperty=function(M,e,a){var E=M.getODataEntityType(M.getODataEntitySet(e).entityType);var p=M.getODataProperty(E,a);return p;};n.prototype._determineInteger=function(M,e,a){var i=false;var p=this._getMeasureProperty(M,e,a);if(p.type&&F.isInteger(p.type)){i=true;}return i;};n.prototype._getI18nText=function(i){var a=this.getModel("i18n");if(!a){return"";}var r=a.getResourceBundle();return r.getText(i);};return n;},true);
