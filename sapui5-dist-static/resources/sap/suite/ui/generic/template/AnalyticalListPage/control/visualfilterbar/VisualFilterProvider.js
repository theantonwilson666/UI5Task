sap.ui.define(["sap/ui/comp/odata/MetadataAnalyser","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/suite/ui/generic/template/genericUtilities/FeLogger"],function(M,F,V,a){"use strict";var f=new a("AnalyticalListPage.control.visualfilterbar.VisualFilterProvider");var l=f.getLogger();var L=f.Level;var b=function(c){l.setLevel(L.WARNING,"VisualFilter");this._filter=c;this._oMetadataAnalyser=new M(c.getModel());this._groupList=[];this._groupListByName={};this._groupMap={};this._measureList=[];this._measureMap={};this._dimensionMap={};this._selectionFieldsLength=0;this._selectionFieldsParsed=0;this._annotationData={Filters:[]};this._allSelectionFields;this._initMetadata();};b.prototype._initMetadata=function(){var e=this._filter.getEntitySet();var c=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);this._getFieldAnnotations(e,c);this._getVisualFilterAnnotation(c);};b.prototype.getVisualFilterConfig=function(){return JSON.parse(JSON.stringify(this._filterConfig));};b.prototype.getMetadataAnalyser=function(){return this._oMetadataAnalyser;};b.prototype._getFieldAnnotations=function(e,c){if(!e){return;}var d=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);if(!d){return;}var m=this._filter.getModel();var g=m.getMetaModel();if(!c||!g){return;}var h={};var k={};var n=this._oMetadataAnalyser.getFieldGroupAnnotation(d);for(var i=0;i<n.length;i++){var o=n[i];var p={name:o.groupName,label:o.groupLabel,fieldList:o.fields};k[p.name]=p;for(var j=0;j<o.fields.length;j++){h[o.fields[j]]=p;}}var q=g.getODataEntityType(c);var s=q[V.SelectionFields];var r={};if(s){for(var i=0;i<s.length;i++){var t=s[i];r[t.PropertyPath]=t;}}var u={};var v=this._oMetadataAnalyser.getFieldsByEntityTypeName(d);for(var i=0;i<v.length;i++){var w=v[i];var x=w.name;var y=g.getODataProperty(q,x);var z=y["sap:aggregation-role"];if(z=="dimension"){var A={name:x,fieldInfo:w,propInfo:y};var p=h[x];if(p){for(var j=0;j<p.fieldList.length;j++){if(p.fieldList[j]==x){p.fieldList[j]=A;break;}}}else{var B=q[V.Label]?q[V.Label].String:undefined;var C=r[x]?"_BASIC":(q[B]||q.name);var p=k[C];if(!p){p={name:C,label:C=="_BASIC"?this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE"):C,fieldList:[]};k[C]=p;}p.fieldList.push(A);h[x]=p;}u[p.name]=true;}}var D=[];if(u["_BASIC"]){D.push(k["_BASIC"]);delete k["_BASIC"];}for(var i=0;i<n.length;i++){var C=n[i].groupName;if(C=="_BASIC"){continue;}if(u[C]){D.push(k[C]);}delete k[C];}for(var C in k){if(u[C]){D.push(k[C]);}delete k[C];}k={};for(var i=0;i<D.length;i++){var p=D[i];k[p.name]=p;}};b.prototype.getGroupList=function(){return this._groupList?this._groupList:[];};b.prototype.getGroupMap=function(){return this._groupMap?this._groupMap:{};};b.prototype.getMeasureMap=function(){return this._measureMap;};b.prototype.getDimensionMap=function(){return this._dimensionMap;};b.prototype.getEntityType=function(e){return this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);};b.prototype._updateGroupList=function(e,c,p,d){var i=function(j){return j.PropertyPath===p;};var g;if(this._allSelectionFields){g=this._allSelectionFields.filter(i);}g=(g&&g.length)?true:false;var m=this._filter.getModel().getMetaModel();var h=m.getODataEntityType(e);h=h[V.Label]?h[V.Label].String:h.name;var u=function(j,k){for(var n in k._groupList){var o=k._groupList[n],q=false;if(o.name===j){var r=o.fieldList;for(var s in r){if(r[s].name===d){q=true;}else{continue;}}if(!q){var t=m.getODataEntityType(c);var v=k._oMetadataAnalyser.getFieldsByEntityTypeName(c);for(var n in v){if(v[n].name===d){var w=m.getODataProperty(t,v[n].name);r.push({name:v[n].name,fieldInfo:v[n],propInfo:w});}}}}else{continue;}}};if(g){u('_BASIC',this);}else{u(h,this);}};b.prototype._createDimensionMap=function(e,c){var d,m=this._filter.getModel(),g=m.getMetaModel(),h,i={},p,j,k,n={};if(!g){return false;}h=g.getODataEntityType(c);d=this._oMetadataAnalyser.getFieldsByEntityTypeName(c);if(!this._dimensionMap[e]||!this._measureMap[e]){for(var o in d){var D=d[o];p=g.getODataProperty(h,D.name);if(D['aggregationRole']==='dimension'){j={name:D.name,fieldInfo:D,propInfo:p};i[D.name]=j;}else if(D['aggregationRole']==='measure'){k={name:D.name,label:D.fieldLabel,fieldInfo:D,propInfo:p};n[D.name]=k;}}if(Object.keys(i).length){this._dimensionMap[e]=i;}if(Object.keys(n).length){this._measureMap[e]=n;}}};b.prototype._createGroupList=function(c,p,i,g){var d;if(i){d=this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE");this._addToGroupListByName('_BASIC',d,c,p);}else{d=c.groupTitle;this._addToGroupListByName(g,d,c,p);}};b.prototype._addToGroupListByName=function(g,c,d,p){if(this._groupListByName[g]===undefined){this._groupListByName[g]=[];this._groupListByName[g].push({name:g,label:c,fieldList:[]});var n=d.name;if(d.isParameter){n="$Parameter."+n;}this._groupListByName[g][0].fieldList.push({name:n,fieldInfo:d,propInfo:p});}else{this._groupListByName[g][0].fieldList.push({name:d.name,fieldInfo:d,propInfo:p});}};b.prototype._setGroupListForDialog=function(){if(Object.keys(this._groupListByName).length){for(var k in this._groupListByName){this._groupList.push(this._groupListByName[k][0]);}}var g={};for(var i=0;i<this._groupList.length;i++){var c=this._groupList[i];g[c.name]=c;}this._groupMap=g;};b.prototype._getScaleFactor=function(e,A){if(!A){return"";}if(A.indexOf("com.sap.vocabularies.UI.v1.DataPoint")>-1){A=A.toString();if(A.charAt(0)==="@"){A=A.slice(1);}var E=e[A];if(E&&E.ValueFormat&&E.ValueFormat.ScaleFactor){return F.getPathOrPrimitiveValue(E.ValueFormat.ScaleFactor);}else{return"";}}};b.prototype._getNumberOfFractionalDigits=function(e,A){if(!A){return"";}if(A.indexOf("com.sap.vocabularies.UI.v1.DataPoint")>-1){A=A.toString();if(A.charAt(0)==="@"){A=A.slice(1);}var E=e[A];if(E&&E.ValueFormat&&E.ValueFormat.NumberOfFractionalDigits){return F.getPathOrPrimitiveValue(E.ValueFormat.NumberOfFractionalDigits);}else{return"";}}};b.prototype._getVisualFilterAnnotation=function(e){var m=this._filter.getModel();var c=m.getMetaModel();if(!e||!c){return null;}var d=c.getODataEntityType(e);if(!d){return null;}this._allSelectionFields=d[V.SelectionFields];var g=this._filter._smartFilterContext.getFilterBarViewMetadata(),h,j,k,G,n,v,o,p,q,r=[],s,t,u,w;var P=this._filter._smartFilterContext.getAnalyticalParameters();var x=P.length;for(var i=0;i<x;i++){var y=P[i];var z={};z.fields=[];z.fields.push(y);g.unshift(z);}for(var z in g){r=g[z].fields;G=g[z].groupName;for(var A in r){h=r[A].filterable;j=r[A].filterRestriction;q=r[A].hasFixedValues===true;u=r[A].displayBehaviour;if(j==="auto"){j="multiple";}if(j!=="interval"&&h!=="false"){s=r[A];var I=(s[V.Hidden]&&s[V.Hidden].Bool==="true")||(s[V.HiddenFilter]&&s[V.HiddenFilter].Bool==="true");w=r[A].isParameter;o=r[A].fieldName;k=r[A].isMandatory;n=r[A].requiredFilterField;for(var B in r[A]){if(B.indexOf(V.ValueList)>-1&&r[A][B].PresentationVariantQualifier){if(I){l.warning("The dimension "+o+" is set to UI.Hidden in the collection "+s.groupEntitySet+". Corresponding chart cannot be displayed as VisualFilter.");break;}p=(G==="_BASIC")||k||n;t=c.getODataProperty(d,o);v=r[A][B];this._createGroupList(s,t,p,G);this._getAnnotationFromValueList(e,p,v,o,j,q,k,u,w);}}}}}this._setGroupListForDialog();this._filterConfig=this._getConfig(this._annotationData);};b.prototype._getAnnotationFromValueList=function(e,i,v,p,c,d,I,g,h){var P=e;if(v!==undefined){var j={Filters:[]},s,k=F.readProperty(v,"PresentationVariantQualifier.String"),m=F.readProperty(v,"SelectionVariantQualifier.String"),n=F.readProperty(v,"CollectionPath"),o=F.readProperty(v,"Parameters"),q=F.readProperty(n,"String"),P=this.getEntityType(q),r=this._filter.getModel(),t=r.getMetaModel(),u=t.getODataEntityType(P);if(m){var w=this._oMetadataAnalyser.getSelectionVariantAnnotationList(P);s=this._getFiltersAndParamsFromSV(w,m);}if(k){var Q=k,x=this._oMetadataAnalyser.getPresentationVariantAnnotation(P,Q),y={},z=F.readProperty(x,"chartAnnotation.annotation.Dimensions.0.PropertyPath");if(z){this._createDimensionMap(n.String,P);this._updateGroupList(e,P,p,z);if(!g){var E=this._oMetadataAnalyser.getTextArrangementValue(e);if(d){g=E?E:sap.ui.comp.smartfilterbar.DisplayBehaviour.descriptionOnly;}else{g=E?E:sap.ui.comp.smartfilterbar.DisplayBehaviour.descriptionAndId;}}y=this._createConsumeableObjectFromAnnotation(x,n,i,o,p,c,d,I,g,u,s,h);if(y){j.Filters.push(y);this._annotationData.Filters.push(y);}}}}};b.prototype._createSortObject=function(c,m,d,D){var s=m,S=true;if(c==="Line"){s=d;if(!D){S=false;}}var o={};o.Field={"String":s};o.Descending={"Boolean":S};return o;};b.prototype._createSortOrderFromAnnotation=function(p,m,d,c,A,D){A.SortOrder=[];var s=p.annotation.SortOrder,S,e;if(s!==undefined&&s.length){for(var i=0;i<s.length;i++){var g=F.readProperty(s,i+".Property.PropertyPath"),I=F.readProperty(s,i+".Descending.Bool");if(g&&I){if(c==="Line"){if(!D){if(g===d){e=d;S=!(I==="false");break;}}}else if(g===m){e=m;S=!(I==="false");break;}}}if(e){var o={};o.Field={"String":e};o.Descending={"Boolean":S};A.SortOrder.push(o);}}if(!A.SortOrder.length){A.SortOrder.push(this._createSortObject(c,m,d,D));}return A;};b.prototype._getChartQualifier=function(p){var v=p.annotation.Visualizations,A;A=v?(v[0].AnnotationPath).substring(1):undefined;return A;};b.prototype._IsDimensionDateTime=function(e,d){var D=this.getDimensionMap(),o=F.readProperty(D,e+"."+d+".fieldInfo"),c=false,s;if(o.type==="Edm.DateTime"||o.type==="Edm.Time"){c=true;}else{s=o[V.CalendarYear]||o[V.CalendarYearMonth]||o[V.CalendarYearMonthDay]||o[V.CalendarYearWeek]||o[V.CalendarYearQuarter]||o[V.FiscalYear]||o[V.FiscalYearPeriod];if(s&&s.Bool&&s.Bool==="true"){c=true;}}return c;};b.prototype._IsDimensionDateTimeOffset=function(e,d){var D=this.getDimensionMap(),o=F.readProperty(D,e+"."+d+".fieldInfo"),c=false;if(o.type==="Edm.DateTimeOffset"){c=true;}return c;};b.prototype._isDimensionDateFilterStringType=function(e,d){var D=this.getDimensionMap(),o=D&&F.readProperty(D,e+"."+d+".fieldInfo"),s="";if(o&&o.type==="Edm.String"){var c=o&&o[V.CalendarYearMonthDay];if(c&&c.Bool&&c.Bool==="true"){s="yearmonthday";return s;}c=o&&o[V.CalendarYearMonth];if(c&&c.Bool&&c.Bool==="true"){s="yearmonth";return s;}c=o&&o[V.CalendarYearWeek];if(c&&c.Bool&&c.Bool==="true"){s="yearweek";return s;}c=o&&o[V.CalendarYearQuarter];if(c&&c.Bool&&c.Bool==="true"){s="yearquarter";return s;}c=o&&o[V.CalendarYear]||o[V.FiscalYear];if(c&&c.Bool&&c.Bool==="true"){s="year";return s;}c=o&&o[V.FiscalYearPeriod];if(c&&c.Bool&&c.Bool==="true"){s="fiscalyearperiod";return s;}}return s;};b.prototype._createConsumeableObjectFromAnnotation=function(p,c,i,d,e,g,h,I,j,k,s,m){var n={},E=this._oMetadataAnalyser.getEntitySetNameFromEntityTypeName(this.getEntityType(c.String)),o=p.chartAnnotation.annotation.ChartType.EnumMember.split("/"),q=o[o.length-1],D,r,t=false;if(q){n.Type={"String":q};}var u=F.readProperty(p,"chartAnnotation.annotation.Dimensions.0.PropertyPath");var v=F.readProperty(p,"chartAnnotation.annotation.Measures.0.PropertyPath");var w=this._isValidDimensionandMeasure(E,u,v);if(!w){return w;}D=this._IsDimensionDateTime(E,u);if(D){r=this._isDimensionDateFilterStringType(E,u);n.stringdate=r;}else{t=this._IsDimensionDateTimeOffset(E,u);}n.dimensionFieldIsDateTime=D;n.dimensionFieldIsDateTimeOffset=t;n=this._createSortOrderFromAnnotation(p,v,u,q,n,D);var x="";if(p.chartAnnotation.measureAttributes[v]){x=p.chartAnnotation.measureAttributes[v].dataPoint;}var y=this._getScaleFactor(k,x);var z=this._getNumberOfFractionalDigits(k,x);var A=this._getChartQualifier(p);n.scaleFactor={"String":y};n.numberOfFractionalDigits={"String":z};n.chartQualifier=A;if(g){n.filterRestriction={"String":g};}else{n.filterRestriction={"String":undefined};}n.isDropDown=h;n.Dimensions=[];var B={};B.Field={"String":u};n.Dimensions.push(B);n.Measures=[];var C={};C.Field={"String":v};n.Measures.push(C);if(i){n.Selected={"Boolean":"true"};}else{n.Selected={"Boolean":"false"};}if(c){n.CollectionPath=c;}if(d&&d.length){n.InParameters=[];for(var G in d){var H=d[G]?d[G]:undefined,J=(H&&H.RecordType)?H.RecordType:undefined,K=(H.ValueListProperty&&H.ValueListProperty.String)?H.ValueListProperty.String:undefined,N=(H.LocalDataProperty&&H.LocalDataProperty.PropertyPath)?H.LocalDataProperty.PropertyPath:undefined;if(H&&J&&K&&N){if(n.OutParameter===undefined&&(J===V.ValueListParameterOut||J===V.ValueListParameterInOut)&&K===u&&N===e){n.OutParameter=N;}if(N!==e&&(J===V.ValueListParameterIn||J===V.ValueListParameterInOut)){var O=this._filter.getModel().getMetaModel(),P=this.getEntityType(c.String),Q=O.getODataEntityType(P),R=O.getODataEntitySet(E),S=O.getODataProperty(Q,K);var T=F.isPropertyNonFilterable(R,S.name);if(T){l.error('IN Parameter valueListProperty: '+K+' is non filterable');}else{if(!F.isPropertyHidden(S)){n.InParameters.push({localDataProperty:N,valueListProperty:K});}}}}}}if(e){n.ParentProperty=e;}if(!m){this._addAllFiltersAsInParameters(E,n);}else{n.isParameter=m;}n.isMandatoryProperty=I;n.displayBehaviour=j;if(s){n.selectionVariant=s;}return n;};b.prototype._getConfig=function(c){var d={filterList:[]};if(!c){return d;}var e={};var g={};var h=c.Filters;for(var i=0;i<h.length;i++){var m=h[i];var p=m.ParentProperty;var n=m.Dimensions[0].Field.String;var o=m.CollectionPath.String;var q=this._dimensionMap[o][n];if(!q){l.error("Unknown Dimension :"+n);continue;}var r=m.Measures[0].Field.String;var s=this._measureMap[o][r];if(!s){l.error("Unknown Measure :"+r);continue;}var t=q.fieldInfo.description;if(!t){t=n;}if(!e[n]){e[n]=[];}if(!g[p]){g[p]=[];}var u={type:m.Type.String,selected:m.Selected.Boolean=="true",dimension:{field:n,fieldDisplay:t},measure:{field:m.Measures[0].Field.String},sortOrder:m.SortOrder,scaleFactor:m.scaleFactor.String,numberOfFractionalDigits:m.numberOfFractionalDigits.String,chartQualifier:m.chartQualifier,dimensionFieldIsDateTime:m.dimensionFieldIsDateTime,dimensionFieldIsDateTimeOffset:m.dimensionFieldIsDateTimeOffset,stringdate:m.stringdate,selectionVariant:m.selectionVariant};u.collectionPath=m.CollectionPath.String;u.outParameter=m.OutParameter;u.inParameters=m.InParameters;u.parentProperty=m.ParentProperty;u.filterRestriction=m.filterRestriction.String;u.isMandatory=m.isMandatoryProperty;u.isDropDown=m.isDropDown;u.displayBehaviour=m.displayBehaviour;u.isParameter=m.isParameter;g[p].push(u);e[n].push(u);}var v={};for(var i=0;i<this._groupList.length;i++){var w=this._groupList[i];for(var j=0;j<w.fieldList.length;j++){var x=w.fieldList[j];var h=g[x.name];if(!h){continue;}v[w.name]=true;for(var k=0;k<h.length;k++){d.filterList.push(h[k]);}}}for(var i=this._groupList.length-1;i>=0;i--){var w=this._groupList[i];if(v[w.name]){continue;}this._groupList.splice(i,1);delete this._groupMap[w.name];}return d;};b.prototype._isValidDimensionandMeasure=function(e,d,m){if(!(d&&m)){return false;}var D=this.getDimensionMap(),o=F.readProperty(D,e+"."+d+".fieldInfo","","VisualFilter");var c=this.getMeasureMap(),g=F.readProperty(c,e+"."+m+".fieldInfo","","VisualFilter"),h=c[e],i=0;if(!(o&&g)){l.error("The dimension "+d+" or the measure "+m+" or both are either NOT given in the chart, or IS given but undefined in metadata. Corresponding chart cannot be displayed as VisualFilter.");return false;}for(var j in h){var k=h[j].fieldInfo;if(k[V.Hidden]&&k[V.Hidden].Bool==="true"){l.warning("The measure "+k.name+" is set to UI.Hidden in the collection "+e+". Chart configured with this measure cannot be rendered.");i++;}}var I=o[V.Hidden]&&o[V.Hidden].Bool==="true";if(o&&I){l.warning("The dimension "+d+" is set to UI.Hidden in the collection "+e+". Corresponding chart cannot be displayed as VisualFilter.");return false;}if(!(o['aggregationRole']==="dimension"&&g['aggregationRole']==="measure")){l.error("The dimension "+d+" or the measure "+m+" or both have NO 'sap:aggregation-role' defined in metadata. Corresponding chart cannot be displayed as VisualFilter.");return false;}if(Object.keys(h).length===i){l.warning("All the measures in the collection "+e+" are set to UI.Hidden. Corresponding chart cannot be displayed as VisualFilter.");return false;}return true;};b.prototype._getFiltersAndParamsFromSV=function(s,c){for(var i in s){if(s[i].qualifier===c){return s[i].annotation;}}};b.prototype._addAllFiltersAsInParameters=function(v,c){if(!this._filter.getAllFiltersAsInParameters()){return;}var d=this.getDimensionMap(),s=this._filter.getEntitySet(),S=this.getEntityType(s),i=c.InParameters||[],p=c.ParentProperty;if(s!==v){this._createDimensionMap(s,S);}if(Object.keys(d).length){d=d[s];}if(s!==v){var m=this._filter.getModel().getMetaModel(),e=m.getODataEntitySet(v),g=m.getODataEntityType(e.entityType),P,h,I,j,k,n,o;for(var P in d){if(d.hasOwnProperty(P)){j=p===P;h=m.getODataProperty(g,P);k=n=o=true;if(h){k=F.isPropertyNonFilterable(e,h.name);n=F.isPropertyHidden(h);}o=F.isAlreadyInParameter(i,P);I=!j&&!o&&!k&&!n;if(I){i.push({localDataProperty:P,valueListProperty:P});}}}}else{for(var P in d){if(d.hasOwnProperty(P)){var o=F.isAlreadyInParameter(i,P);if(!o&&p!==P){i.push({localDataProperty:P,valueListProperty:P});}}}}};return b;},true);
