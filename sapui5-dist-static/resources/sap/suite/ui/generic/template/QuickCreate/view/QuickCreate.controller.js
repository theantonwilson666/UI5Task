sap.ui.define(["../../js/QuickTemplates/QuickActionBaseController","../../js/QuickTemplates/QuickCreateAPI","sap/m/MessageToast","../../js/QuickTemplates/AnnotationHelper","sap/ui/model/odata/AnnotationHelper","../../js/QuickTemplates/ODataModelHelper","sap/ui/model/json/JSONModel","sap/ui/model/Context","sap/base/util/each","sap/suite/ui/generic/template/genericUtilities/polyFill"],function(B,Q,M,a,b,O,J,C,e){"use strict";var c=B.extend("sap.suite.ui.generic.template.QuickCreate.view.QuickCreate",{onInit:function(){if(!this._bIsInitialized){B.prototype.onInit.apply(this);this._focusableElement='';this.oQuickCreateAPI=this.oComponent.oQuickCreateAPI;this.oTransactionController=this.oComponent.getTransactionController();if(this.oQuickCreateAPI){this.oQuickCreateAPI.setRootView(this.getView());}this.sDraftEntityPath=this.oQuickCreateAPI?this.oQuickCreateAPI.getQuickCreateItem().draftid:undefined;this.bIsCreator=this.oQuickCreateAPI?this.oQuickCreateAPI.isCurrentUserCreator():true;this.sQuickCreateUserName=this.oQuickCreateAPI?this.oQuickCreateAPI.getQuickCreateItem().createdByName:"";this.bFormEnabled=this.bIsCreator;this._sDeferredGroupId="QuickCreateChanges";var q=new J({});this._sQuickCreateUIModelName="quickCreate";this.getView().setModel(q,this._sQuickCreateUIModelName);this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/draftExists",true);this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/quickCreateUser",this.sQuickCreateUserName);if(!this.bDraftEnabled){this.getView().getModel().setDeferredGroups([this._sDeferredGroupId]);}if(this.oQuickCreateAPI){this.oQuickCreateAPI.attachAutofillLineItems(this._onLineItemsFound,this);}if(typeof this.oComponent.onQCViewInit==="function"){this.oComponent.onQCViewInit(this);}}},onExit:function(){if(this._bIsBeingDestroyed||this._bDestroyed){return;}this._bIsBeingDestroyed=true;if(this.oQuickCreateAPI){this.oQuickCreateAPI.destroy();}if(B.prototype.onExit){B.prototype.onExit.apply(this);}this._bDestroyed=true;delete this._bIsBeingDestroyed;},onBeforeRendering:function(){B.prototype.onBeforeRendering.apply(this);if(!this.getView().getModel("ui")){var u=new J({});this.getView().setModel(u,"ui");}this.getView().getModel("ui").setProperty("/enabled",this.bFormEnabled);this.getView().getModel("ui").setProperty("/editable",true);if(typeof this.oComponent.onQCBeforeRendering==="function"){this.oComponent.onQCBeforeRendering(this.getView());}},onAfterRendering:function(){this.getView().getModel("ui").setProperty("/createenabled",true);this._checkForMandatoryFields(true);if(this._focusableElement){this._focusableElement.focus();this._clearFocusableElement();}},_clearFocusableElement:function(){this._focusableElement='';},_onMetaModelLoaded:function(){var t=this;this.setBusy(true);if(this.sDraftEntityPath){var o=new C(this.getView().getModel(),this.sDraftEntityPath);if(this.bDraftEnabled&&!this.bIsCreator){o._bLocalBinding=true;}else if(!this.bDraftEnabled){o._bLocalBinding=true;}if(o._bLocalBinding){if(this.oQuickCreateAPI){this.oQuickCreateAPI.loadQuickCreateModelFromJSON().then(function(){if(o.getObject()){this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/draftExists",true);}else{this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/draftExists",false);}this.bindView(o);}.bind(this));}}else{this.getView().getModel().read(this.sDraftEntityPath,{success:function(D,r){this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/draftExists",true);this.bindView(o);}.bind(this),error:function(E){this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/draftExists",false);this.bindView(o);}.bind(this)});}}else if(this.bDraftEnabled){this.oDraftController.createNewDraftEntity(this.sEntitySet,"/"+this.sEntitySet).then(function(r){if(t.oQuickCreateAPI){t.oQuickCreateAPI.updateDraftID(r.context.getPath());}t.bindView(r.context);},this.onError.bind(this));}else{var d=this.getView().getModel().createEntry("/"+this.sEntitySet,{groupId:this._sDeferredGroupId});d._bLocalBinding=true;if(this.oQuickCreateAPI){this.oQuickCreateAPI.updateDraftID(d.getPath());}this._initializeObject(d,"FieldGroup");this.bindView(d);}},_checkForMandatoryFields:function(d){var v=true;var s=this.getView().byId('QuickCreateSmartForm').getSmartFields();for(var i=0;i<s.length;i++){if(s[i].getMandatory()&&s[i].getValue()===""){v=false;break;}}if(v&&d){var E=this.getView().byId('QuickCreateSmartForm').check();if(E.length>0){v=false;}}this.getView().getModel("ui").setProperty("/createenabled",v);},onChange:function(E){this._checkForMandatoryFields(false);if(this.bDraftEnabled){var o=this.getView().getElementBinding();var s=this;this.getView().getModel("ui").setProperty("/createenabled",false);var m=new Promise(function(r,d){var f=this.oComponent.getEntitySet();var v=E.getSource().getBindingPath("value");var g=E.getSource();var S=null;if(g){S=this.oComponent.getApplicationController();}else{S=this.oComponent.getTransactionController();}S.propertyChanged(f,v,o,g).then(function(){if(r){r();}},function(){if(d){d();}});}.bind(this));m.then(function(){s._checkForMandatoryFields(true);o.refresh();});}else{this._checkForMandatoryFields(true);}},onCreatePress:function(d){var t=this;this._createButton=d.getSource();this._createButton.setEnabled(false);this.setBusy(true);var r=function(R){t.setBusy(false);var h=null;var k=[];var p={key:"__metadata",matchCallback:function(i,n,q){k.push(n);return false;}};O.findObjects(R,p);var l=t.oEntityTypeMeta.namespace+"."+t.oEntityTypeMeta.name;e(k,function(i,n){if(!h&&n.__metadata&&n.__metadata.type===l){var q=t.getView().getModel().getKey(n);h=new C(t.getView().getModel(),"/"+q);}});if(h){M.show(t.formatI18NMessage("QuickCreate_Success_CreateObject"));if(t.oQuickCreateAPI){t.oQuickCreateAPI.objectCreated(h);}}else{this._showErrorMessage({message:t.formatI18NMessage("QuickCreate_No_Created_Object")});}};var f=function(E){t.setBusy(false);if(t._createButton){t._createButton.setEnabled(true);}t.onError(E);};var o;if(this.bDraftEnabled){var g=function(){t.oDraftController.activateDraftEntity(t.getView().getBindingContext()).then(r,f);};if(typeof this.oComponent.onQCBeforeCreate==="function"){o=this.oComponent.onQCBeforeCreate(this.getView().getBindingContext(),this.getView().getBindingContext().getObject());}if(o&&o instanceof Promise){o.then(g,f);}else{g();}}else{var h=this.getView().getBindingContext();var m=this.getView().getModel().getProperty(h.getPath(),h,true);var p={key:"results",matchCallback:function(i,k,l){if(k.__nestedKey&&Array.isArray(l)){i[k.__nestedKey]=l;}return true;},maxNestedLevel:5};O.findObjects(m,p);p={key:"__metadata",matchCallback:function(i,k,l){delete k["__metadata"];return true;},maxNestedLevel:5};O.findObjects(m,p);var j=function(){t.getView().getModel().create("/"+t.sEntitySet,m,{success:r,error:f});};if(typeof this.oComponent.onQCBeforeCreate==="function"){o=this.oComponent.onQCBeforeCreate(h,m);}if(o&&o instanceof Promise){o.then(j,f);}else{j();}}},onAddLineItemPress:function(E){this._getLineItemsTableFromEvent(E);var t=this;this._focusableElement=E.oSource;this.setBusy(true);var d=this.getView().getBindingContext();var f=function(s){t._createLineItem(d).then(function(o){t._refreshLineItems();if(t.oQuickCreateAPI){t.oQuickCreateAPI.calculateViewHeight(t.getView(),true);}t.setBusy(false);},t.onError.bind(t));};if(this.bDraftEnabled){this.oTransactionController.triggerSubmitChanges().then(function(s){f(s);},this.onError.bind(this));}else{f();}},onRemoveLineItemPress:function(E){var t=this;this.setBusy(true);var d=E.getSource().getBindingContext();if(this.bDraftEnabled){this.oTransactionController.triggerSubmitChanges().then(function(r){t._deleteLineItem(d);},function(o){this.setBusy(false);this.onError(o);}.bind(this));}else{this.getView().getModel().deleteCreatedEntry(d);this.setBusy(false);if(this.oQuickCreateAPI){this.oQuickCreateAPI.calculateViewHeight(this.getView(),false);}this._refreshLineItems();}},bindView:function(o){this.setBusy(false);if(this.getView().getModel(this._sQuickCreateUIModelName).getProperty("/draftExists")===false){return;}if(o._bLocalBinding){this._setBindingContext(o);this._refreshLineItems();}else{B.prototype.bindView.apply(this,arguments);}this._updateFieldControl(o);},hasLineItemAnnotation:function(){var i=this._getFormatterInterface();var m=a.getMetaModelContextForFacetType(i,this.oEntityTypeMeta.namespace+"."+this.oEntityTypeMeta.name,"LineItem");return m!==null;},_onLineItemsFound:function(E){if(!this.hasLineItemAnnotation()){return;}var n=E.getParameter("numberOfLineItems");if(n<=0){return;}this.setBusy(true);var m=this.getView().getBindingContext();var p=[];for(var i=0;i<n;i++){p.push(this._createLineItem(m));}Promise.all(p).then(function(r){this._refreshLineItems();this.setBusy(false);}.bind(this));},_createLineItem:function(m){var t=this;var i=this._getFormatterInterface(m);var o=this.getView().getModel().getMetaModel();var d=a.getMetaModelContextForFacetType(i,this.oEntityTypeMeta.namespace+"."+this.oEntityTypeMeta.name,"LineItem");var s=b.getNavigationPath(d);s=s.replace(/[{}]/g,'');var l=o.getODataAssociationEnd(this.oEntityTypeMeta,s);var L=o.getODataEntityType(l.type);if(this.bDraftEnabled){return this.oDraftController.createNewDraftEntity(L.name,m.sPath+"/"+s);}else{return new Promise(function(r,f){var g=t.getView().getModel().createEntry(m.sPath+"/"+s,{groupId:t._sDeferredGroupId});t._initializeObject(g,"LineItem");r(g);});}},_deleteLineItem:function(o){this.oTransactionController.deleteEntity(o).then(function(r){this._refreshLineItems();this.setBusy(false);if(this.oQuickCreateAPI){this.oQuickCreateAPI.calculateViewHeight(this.getView(),false);}}.bind(this),function(E){this.setBusy(false);this.onError(E);}.bind(this));},_onSmartFieldAfterRendering:function(E){if(typeof E.srcControl.setEnabled=='function'){E.srcControl.setEnabled(this.bFormEnabled);}if(this.oQuickCreateAPI){this.oQuickCreateAPI.calculateViewHeight(this.getView(),true);}document.querySelectorAll(".copilotQuickCreateContainerBox .sapQuickCreateFieldGroup label").forEach(function(d){d.style.textAlign="";});document.querySelectorAll(".sapQuickActionCreateButtonContainer > div").forEach(function(d){d.classList.add("sapUiSmallMarginEnd");});document.querySelectorAll(".sapQuickActionCreateButtonContainer .sapMBtnInner").forEach(function(d){d.style.padding="0";});},_refreshLineItems:function(){if(this._lineItemsTable){var d=this.getView().getBindingContext();if(d&&d._bLocalBinding){O.restoreLineItemReferences(this.oEntityTypeMeta.namespace+"."+this.oEntityTypeMeta.name,d);this._lineItemsTable.getModel().updateBindings();}else{this._lineItemsTable.getModel().refresh();}}},onTableUpdateStarted:function(E){this._getLineItemsTableFromEvent(E);},_getLineItemsTableFromEvent:function(E){if(!this._lineItemsTable&&E&&E.getSource){var d=E.getSource();while(d){if(d instanceof sap.m.Table){this._lineItemsTable=d;return;}if(typeof d.getParent==='function'){d=d.getParent();}else{return;}}}},onTableUpdateFinished:function(E){this._updateFieldControl();},_initializeObject:function(o,f){var m=this.getView().getBindingContext()?this.getView().getBindingContext():o;var p=a.getAllPropertyPathsFromFacet(m,f);if(p&&p.length>0){O.initializeObjectProperties(o,p,{groupId:this._sDeferredGroupId});}},_updateFieldControl:function(o){var d=o?o:this.getView().getBindingContext();if(d&&this.getView().getModel().getProperty(d.getPath()+"/Update_mc")!==undefined){this.getView().getModel().setProperty(d.getPath()+"/Update_mc",true);}}});return c;},true);
