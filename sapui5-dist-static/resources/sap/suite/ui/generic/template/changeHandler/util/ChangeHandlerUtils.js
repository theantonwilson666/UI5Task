sap.ui.define(["sap/suite/ui/generic/template/js/AnnotationHelper","sap/suite/ui/generic/template/changeHandler/js/AnnotationHelperForDesignTime","sap/base/util/deepExtend","sap/suite/ui/generic/template/genericUtilities/FeError"],function(A,a,d,F){"use strict";var O="sap.suite.ui.generic.template.ObjectPage.view.Details";var L="com.sap.vocabularies.UI.v1.LineItem";var D="com.sap.vocabularies.UI.v1.DataFieldForAnnotation";var b="com.sap.vocabularies.UI.v1.DataFieldForAction";var I="com.sap.vocabularies.UI.v1.DataFieldWithIntentBasedNavigation";var c="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";var e="com.sap.vocabularies.UI.v1.FieldGroup";var f="com.sap.vocabularies.UI.v1.Identification";var S="com.sap.vocabularies.UI.v1.SelectionFields";var R="com.sap.vocabularies.UI.v1.ReferenceFacet";var C="com.sap.vocabularies.UI.v1.CollectionFacet";var g={};var m;g.isReveal=false;g.isRevert=false;g.getMetaModel=function(s,p){if(m){return m;}m={};var i=(s.source&&s.source.id)||s.parentId||(s.removedElement&&s.removedElement.id)||(s.selector&&s.selector.id);d(m,p.modifier.bySelector(i,p.appComponent).getModel().getMetaModel());return m;};g.getComponent=function(M){var o;while(M){if(M instanceof sap.ui.core.mvc.View){o=M.getController().getOwnerComponent();break;}else if(M instanceof sap.ui.core.UIComponent){o=M;break;}if(M.getParent){M=M.getParent();}else{break;}}return o;};g.getODataEntitySet=function(o){var M=o.getModel();var E=M&&o.getEntitySet&&o.getEntitySet();var m=M&&M.getMetaModel();return E&&m.getODataEntitySet(E);};g.getEntityType=function(E){var s;if(E){if(E.getEntityType){s=E.getEntityType();}else{var o=g.getComponent(E);var h=o&&o.getEntitySet();var m=E.getModel().getMetaModel();var i=h&&m&&m.getODataEntitySet(h);s=i&&i.entityType;}}return s;};g.getODataEntityType=function(M){var o;if(M){var h=g.getComponent(M);var E=h&&h.getEntitySet&&h.getEntitySet();var i=M.getModel();var j=i&&i.getMetaModel();if(j){var k=j.getODataEntitySet(E);var s=k&&k.entityType;o=j.getODataEntityType(s);if(M.getId().indexOf(O)>-1){var l=M.getMetadata&&M.getMetadata().getElementName&&M.getMetadata().getElementName();switch(l){case"sap.ui.comp.smarttable.SmartTable":case"sap.m.Table":case"sap.m.Column":var n=A.getSmartTableControl(M);var N=n&&n.getTableBindingPath();if(N){o=A.getRelevantDataForAnnotationRecord(j,N+'/',o).entityType;}break;case"sap.ui.comp.smartform.GroupElement":var p=M.getBindingContext().sDeepPath.split('/');var q=p[p.length-1];if(i.getMetaModel().getODataAssociationEnd(o,q)){o=A.getRelevantDataForAnnotationRecord(j,q+'/',o).entityType;}break;default:break;}}}}return o;};g.getSmartFormGroupInfo=function(G,h){var o,j,s;for(var i=0;i<h.length;i++){o=h[i];if(o&&o.Facets){j=g.getSmartFormGroupInfo(G,o.Facets);if(j){return j;}}else if(o&&o.Target&&o.Target.AnnotationPath&&(o.Target.AnnotationPath.indexOf(e)>=0)||(o.Target.AnnotationPath.indexOf(f)>=0)){s=(o.ID&&o.ID.String)||o.Target.AnnotationPath;if(s===G){return{aForm:h,oGroup:o};}}}};g.getCollectionFacet=function(s,h){var o;for(var i=0;i<h.length;i++){o=h[i];if(o&&o.ID&&o.ID.String===s){return o;}else if(o&&o.Facets){var j=g.getCollectionFacet(s,o.Facets);if(j){return j;}}}};g.createCollectionFacets=function(n,l){var N={"Label":{"String":l},"ID":{"String":"com.sap.vocabularies.UI.v1.CollectionFacet_"+a.getNextIdSuffix(true)},"Facets":n,"RecordType":"com.sap.vocabularies.UI.v1.CollectionFacet"};return N;};g.createNewFieldGroup=function(l){return{"Data":[{"Value":{"Path":l.Value?l.Value.Path:""},"RecordType":"com.sap.vocabularies.UI.v1.DataField"}],"RecordType":"com.sap.vocabularies.UI.v1.FieldGroupType"};};g.createFieldGroupTerm=function(E){var s="com.sap.vocabularies.UI.v1.FieldGroup#RTAGroup";var M=-1;for(var i in E){if(i.indexOf(s)>-1&&i.indexOf("RTAGroup")>-1){var h=i.substring(s.length);var j=parseInt(h,10);M=Math.max(j,M);}}M++;return s+M;};g.getSmartFilterBarControlConfiguration=function(v){var i=v.getContent()[0].getId();var s=i.substring(i.lastIndexOf("-")+1);var o=g.findSmartFilterBar(v);var h=o.getControlConfiguration().filter(function(j){return j.getKey()===s;})[0];return h;};g.findSmartFilterBar=function(E){if(!E){return;}if(E.getMetadata().getName()==="sap.ui.comp.smartfilterbar.SmartFilterBar"){return E;}else{return g.findSmartFilterBar(E.getParent());}};g.getIndexFromInstanceMetadataPath=function(o){var r=-1;var t=g.getTemplatingInfo(o);if(t&&t.path){r=parseInt(t.path.substring(t.path.lastIndexOf("/")+1),10);}return r;};g.fnIsSubsectionsPresent=function(o){return(o.RecordType===C&&o.Facets[0].RecordType===C&&o.Facets.length);};g.fnAddSubSection=function(p,h,t){var s="com.sap.vocabularies.UI.v1.FieldGroup#RTAGroup"+a.getNextIdSuffix(true);var n={"Label":{"String":"New Group"},"Target":{"AnnotationPath":"@"+s},"RecordType":R};var i=[];var j=g.getIndexFromInstanceMetadataPath(p);if(!g.fnIsSubsectionsPresent(h[j])){if(h[j].RecordType===R){i.push(h[j]);var E=g.createCollectionFacets(i,"New SubSection");}else{var E=h[j];}var N=g.createCollectionFacets([n],"New Subsection");var k=[E,N];var o=g.createCollectionFacets(k,h[j].Label.String);h.splice(j,1,o);}else{var k=[n];var o=g.createCollectionFacets(k,"New SubSection");h[j].Facets.splice(t,0,o);}return s;};g.fnMoveSubSection=function(u,U,i,h,j){var s=g.getIndexFromInstanceMetadataPath(u);var t=g.getIndexFromInstanceMetadataPath(U);var k=[];if(!g.fnIsSubsectionsPresent(j[t])){if(j[t].RecordType===R){k.push(j[t]);}else{for(var o in j[t].Facets){k.push(j[t].Facets[o]);}}if(k[0].RecordType===R){var T=g.createCollectionFacets(k,j[t].Label.String);if(j[s].Facets){var l=j[s].Facets[i];}else{var l=g.createCollectionFacets([j[s]],j[s].Label.String);}var r=[T];r.splice(h,0,l);}else{var l=j[s].Facets[i];var r=[l];for(var o in k){r.push(k[o]);}}var n=g.createCollectionFacets(r,j[t].Label.String);j.splice(t,1,n);if(!j[s].Facets||!j[s].Facets.length){j.splice(s,1);}else{j[s].Facets.splice(i,1);if(j[s].Facets&&!j[s].Facets.length){j.splice(s,1);}}}else if(j[s].RecordType===R){var p=j[s];var q=g.createCollectionFacets([p],j[s].Label.String);j[t].Facets.splice(h,0,q);j.splice(s,1);}else{if(j[s].Facets[0].RecordType===R){j[t].Facets.splice(h,0,j.splice(s,1)[0]);}else{j[t].Facets.splice(h,0,j[s].Facets.splice(i,1)[0]);if(j[s].Facets&&!j[s].Facets.length){j.splice(s,1);}}}};g.fnRemoveSubSection=function(r,h){var p=r.getParent();var i=g.getIndexFromInstanceMetadataPath(r);if(i>=0){var s=g.getIndexFromInstanceMetadataPath(p);h[s].Facets.splice(i,1);}};g.getUIHeaderFacets=function(o){var u=[];switch(o.getMetadata().getElementName()){case"sap.uxap.ObjectPageHeaderContent":u=o.getContent();break;case"sap.m.FlexBox":u=o.getItems();break;}return u;};g.getHeaderFacetIndex=function(h,j,u,k){if(h&&h.getMetadata().getElementName()==="sap.m.VBox"){if(g.getTemplatingInfo(h)){return g.getIndexFromInstanceMetadataPath(h);}else{if(h.getId().indexOf("AfterImageExtension")>-1){return 0;}if(!u){u=g.getUIHeaderFacets(h.getParent());}if(!k){for(var i=0;i<u.length;i++){if(u[i].getId()===h.getId()){k=i;break;}}}if(h.getId().indexOf("BeforeReferenceExtension")>-1){return g.getHeaderFacetIndex(u[k+1],j,u,k+1);}else if(h.getId().indexOf("AfterReferenceExtension")>-1){return g.getHeaderFacetIndex(u[k-1],j,u,k-1);}else{var o,l=j.length-1;for(var i=k;i<u.length;i++){o=u[i+1];if(o&&g.getTemplatingInfo(o)){l=g.getIndexFromInstanceMetadataPath(o)-1;break;}}return l;}}}else{return-1;}};g.getCustomDataObject=function(E){var h=E.getCustomData(),o={};if(!h){return;}for(var i=0;i<h.length;i++){o[h[i].getKey()]=h[i].getValue();}return o;};g.getGroupElements=function(E,t){var G=t.annotation;var o=g.getODataEntityType(E);var h=o&&o[G];return h['Data']||h;};g.getGroupElementRecordIndex=function(E,G){if(!E||!G){return;}var t=g.getTemplatingInfo(E);var h=t.annotationContext;var r=-1;if(h&&G&&G.length>0){for(var i=0;i<G.length;i++){if(h.RecordType&&(!G[i].RecordType||(G[i].RecordType!==h.RecordType))){continue;}if(h.Action&&h.Action.String&&(!G[i].Action||G[i].Action.String!==h.Action.String)){continue;}if(h.Action&&h.Action.Path&&(!G[i].Action||G[i].Action.Path!==h.Action.Path)){continue;}if(h.SemanticObject&&h.SemanticObject.String&&(!G[i].SemanticObject||(G[i].SemanticObject.String!==h.SemanticObject.String))){continue;}if(h.SemanticObject&&h.SemanticObject.Path&&(!G[i].SemanticObject||(G[i].SemanticObject.Path!==h.SemanticObject.Path))){continue;}if(h.Target&&h.Target.AnnotationPath&&(!G[i].Target||(G[i].Target.AnnotationPath!==h.Target.AnnotationPath))){continue;}if(h.Value&&h.Value.Path&&(!G[i].Value||(G[i].Value.Path!==h.Value.Path))){continue;}r=i;break;}}return r;};g.getLineItems=function(E){var o;var l=L;if(E.getId().indexOf(O)>-1){E=A.getSmartTableControl(E);var s=A.getLineItemQualifier(E.getCustomData());l=s?l+"#"+s:l;}o=g.getODataEntityType(E);return o&&o[l];};g.getLineItemRecordIndex=function(o,l){if(!o){return;}if(!l){l=g.getLineItems(o);}if(!l){return;}var r=-1,i,p=o.data("p13nData");if(!p||!l||l.length===0){return r;}if(!p.columnKey||p.columnKey.search("template::")===-1){for(i=0;i<l.length;i++){if(l[i].Value&&l[i].Value.Path===p.leadingProperty){return i;}}return r;}var t=p.columnKey.split("::");switch(t[1]){case"DataFieldForAction":for(i=0;i<l.length;i++){if(l[i].RecordType===b&&l[i].Action.String===t[2]){return i;}}break;case"DataFieldForAnnotation":for(i=0;i<l.length;i++){if(l[i].RecordType===D&&l[i].Target&&l[i].Target.AnnotationPath&&l[i].Target.AnnotationPath.replace("@","")===t[2]){return i;}}break;case"DataFieldWithIntentBasedNavigation":for(i=0;i<l.length;i++){if(l[i].RecordType===I&&l[i].SemanticObject.String===t[2]&&l[i].Action.String===t[3]){return i;}}break;case"DataFieldForIntentBasedNavigation":for(i=0;i<l.length;i++){if(l[i].RecordType===c&&l[i].SemanticObject.String===t[2]&&l[i].Action.String===t[3]&&l[i].Inline&&l[i].Inline.Bool==="true"){return i;}}break;default:for(i=0;i<l.length;i++){if(l[i].Value&&l[i].Value.Path===p.leadingProperty){return i;}}break;}return r;};g.getLineItemRecordIndexForButton=function(B,l){if(!l){l=g.getLineItems(B);}if(!l){return;}var o=g.getCustomDataObject(B),h=-1,E;for(var i=0;i<l.length;++i){E=l[i];if(E.RecordType===b&&E.Action&&E.Action.String===o.Action||E.RecordType===c&&E.Action&&E.Action.String===o.Action&&E.SemanticObject&&E.SemanticObject.String===o.SemanticObject){h=i;break;}}return h;};g.getRemoveElementSelector=function(r,p){var s=p.modifier.bySelector(r,p.appComponent).getContent()[1].sId;return p.modifier.getSelector(s,p.appComponent);};g.getRecordIndexForSelectionFieldFromAnnotation=function(v,h){var t=0;var E=sap.ui.getCore().byId(v.sId).getContent()[0].getHeader().getContent()[0].getContent()[0].getContent();var o=this.index>=E.length?1:0;var j=E[this.index-o];var T=g.getTemplatingInfo(g.getSmartFilterBarControlConfiguration(j));if(T&&T.annotation===S){h.some(function(k,i){if(k.PropertyPath===T.value){t=i+o;return true;}});}return t;};g.getRecordIndexForSelectionField=function(v){var t=-1,E=v.getParent().getParent().getEntityType(),m=v.getModel().getMetaModel(),o=m.getODataEntityType(E),s=o&&o[S];var T=g.getTemplatingInfo(g.getSmartFilterBarControlConfiguration(v));if(T&&T.annotation===S){s.some(function(h,i){if(h.PropertyPath===T.value){t=i;return true;}});}return t;};g.getLineItemRecordForButton=function(B){var l=g.getLineItems(B);if(!l){return;}var i=g.getLineItemRecordIndexForButton(B,l);return l[i];};g.getLineItemRecordForColumn=function(o){var l=g.getLineItems(o);if(!l){return;}var i=g.getLineItemRecordIndex(o,l);return l[i];};g.getTemplatingInfo=function(E){var t,T;if(E){T=E.data("sap-ui-custom-settings")&&E.data("sap-ui-custom-settings")["sap.ui.dt"]&&E.data("sap-ui-custom-settings")["sap.ui.dt"].annotation;if(T&&typeof(T)==="string"){t=JSON.parse(T);}}return t||T;};g.getPropertyOfColumn=function(o){var p=o.data("p13nData"),P=p&&p.leadingProperty;return P;};g.getODataPath=function(o,h){var s,t=-1,j,E=o.getElement(),m=E.getModel().getMetaModel(),k=o.getDesignTimeMetadata()&&o.getDesignTimeMetadata().getData();if(k&&typeof k.getCommonInstanceData==="function"){j=k.getCommonInstanceData(E);}if(!j){if(!h||!h.target){return;}for(var i=0;i<h.target.length;i++){if(h.target[i]==="EntityType"){t=i;break;}else if(h.target[i]==="EntitySet"){t=i;}}if(t>-1){var l=g.getEntityType(E);if(!m.getODataEntityType){return;}var n=m.getODataEntityType(l);switch(h.target[t]){case"EntityType":s=n&&n.namespace+"."+n.name;break;case"EntitySet":var p=g.getComponent(E);var q=g.getODataEntitySet(p);var r=q&&q.name;s=n&&n.namespace+"."+r;break;default:return;}}}else{s=j.target;}if(s&&h&&h.target){s+="/"+h.namespace+"."+h.annotation;}return s;};g.getEntityTypeFromAnnotationPath=function(E,s){var o;if(!E||!s){return o;}var m=E.getModel()&&E.getModel().getMetaModel();if(!m){return o;}o=g.getODataEntityType(E);if(s.search("/")>-1){o=A.getRelevantDataForAnnotationRecord(m,s,o).entityType;}return o;};g.fnAdaptTableStructures=function(t){var B=t.getBindingInfo("items");var o=t.getColumns(true);if(B&&B.template){var T=B.template;var h=T.getCells();if(h.length===o.length){var j=[];for(var i=0;i<o.length;i++){j.push(h[t.indexOfColumn(o[i])]);}B.template=null;t.unbindItems();t.removeAllColumns();T.removeAllCells();for(var i=0;i<o.length;i++){if(o[i].getVisible()){t.addColumn(o[i]);T.addCell(j[i]);}}B.template=T;t.bindItems(B,B.model);return;}}throw new F("Unsupported Operation");};g.getPropertiesForCustomPopUp=function(o,t){if(!o||!t){return[];}var h=g.getComponent(o);var E=g.getODataEntityType(h);var p=E.property;var P=[];switch(t){case'table':o=o.getParent();p.map(function(i){if(!i["com.sap.vocabularies.UI.v1.Hidden"]||i["com.sap.vocabularies.UI.v1.Hidden"].Bool==='false'){var v=o.getUiState().getPresentationVariant().Visualizations;var s=v[0].Content;var j=i.name;var k=s.some(function(l){return l.Value===j;});if(!k){P.push(i);}}});break;case'filter':p.map(function(i){if((!i["com.sap.vocabularies.UI.v1.Hidden"]||i["com.sap.vocabularies.UI.v1.Hidden"].Bool==='false')&&(!i["sap:filterable"]||!(i["sap:filterable"]==='false'))){P.push(i);}});break;}return P;};return g;});
