sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/multipleViews/MultipleTablesModeHelper","sap/suite/ui/generic/template/lib/multipleViews/SingleTableModeHelper","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/security/encodeURL","sap/ui/comp/util/DateTimeUtil","sap/base/util/isEmptyObject"],function(B,F,M,S,a,c,m,b,t,e,d,D,f){"use strict";var l=new b("lib.multipleViews.MultipleViewsHandler").getLogger();function g(C,T,o){var s=Object.create(null);var h=T.oComponentUtils.getTemplatePrivateModel();var p=o.pathInTemplatePrivateModel+"/items";var P=o.pathInTemplatePrivateModel+"/selectedKey";h.setProperty(o.pathInTemplatePrivateModel,Object.create(null));h.setProperty(p,Object.create(null));var I=new(o.smartControl?S:M)(C,T,o);h.setProperty(o.pathInTemplatePrivateModel+"/mode",I.getMode());var k=T.oServices.oApplication.getBusyHelper().getBusyDelay();var n=C.getOwnerComponent().getModel();var q;var r;var u;function U(){if(r){var i=o.getSearchValue&&o.getSearchValue();var j=i?{search:i}:{};for(var b1 in s){var c1=s[b1];var d1=c1.getPath();c1.numberOfUpdates++;c1.updateStartFunction(c1.numberOfUpdates);n.read(d1+"/$count",{urlParameters:j,filters:c1.getFiltersForCount(),groupId:"updateMultipleViewsItemsCounts",success:c1.updateSuccessFunction.bind(null,c1.numberOfUpdates),error:c1.errorFunction.bind(null,c1.numberOfUpdates)});}}}function R(i,j){var b1="";var c1=j["parameters"];if(!j||!j.entitySetName||!j.navPropertyName||c1.length<1){b1="/"+i.name;return b1;}var d1=o.smartFilterBar&&o.smartFilterBar.getAnalyticalParameters();if(d1&&d1.length>0){var e1=o.smartFilterBar&&o.smartFilterBar.getUiState({allFilters:false});var f1=e1?JSON.stringify(e1.getSelectionVariant()):"{}";var g1=new a(f1);var h1=[];c1.forEach(function(i1){d1.forEach(function(j1){if(j1&&(j1.name===i1)){var k1=j1.name;var l1=g1.getParameter(k1);if(j1.type==='Edm.DateTime'){l1=new Date(l1);l1=D.localToUtc(l1);l1=d(j1.control.getModel().formatValue(l1,j1.type));h1.push(k1+'='+l1);}else{h1.push(k1+'='+"'"+l1+"'");}}});});b1='/'+j.entitySetName+'('+h1.join(',')+')/'+j.navPropertyName;}else{b1="/"+i.name;l.error("SelectionParameters","There are no parameters to resolve");return b1;}return b1;}function G(i){var j;var b1=i.getEntitySet();var c1=C.getOwnerComponent();if(o.smartFilterBar&&o.smartFilterBar.getConsiderAnalyticalParameters&&o.smartFilterBar.getConsiderAnalyticalParameters()){var d1=n.getMetaModel();var e1=d1.getODataEntitySet(b1);var f1=c1.getAppComponent();var g1=m.getParametersByEntitySet(f1.getModel(),b1);j=R(e1,g1);return j;}var h1=i.getTableBindingPath?i.getTableBindingPath():i.getChartBindingPath();j=h1?h1:"/"+b1;var i1=c1.getComponentContainer();var j1=i1.getElementBinding();return j1?j1.getPath()+'/'+j:j;}function v(b1,c1){var d1=n.getMetaModel();var e1=b1.getEntitySet();var f1=d1.getODataEntitySet(e1);var g1=d1.getODataEntityType(f1.entityType);var h1=[],i1;var j1=c1.variantAnnotationPath;if(j1){var k1=g1[j1];if(!k1){return[];}if(!k1.SelectOptions&&k1.SelectionVariant){k1=k1.SelectionVariant;if(k1.Path){j1=k1.Path.split("@")[1];k1=j1&&g1[j1];}}if(k1.AnnotationPath){i1=k1.AnnotationPath.split("@")[1];k1=g1[i1];}for(var i in k1.SelectOptions){if(k1.SelectOptions[i].PropertyName){var l1=k1.SelectOptions[i].PropertyName.PropertyPath;for(var j in k1.SelectOptions[i].Ranges){var m1=k1.SelectOptions[i].Ranges[j].Sign;var n1=k1.SelectOptions[i].Ranges[j].Option;if(m1){n1.EnumMember=w(m1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeSignType/",""),n1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/",""));}else{n1.EnumMember=n1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");}var o1=k1.SelectOptions[i].Ranges[j].Low;var p1=k1.SelectOptions[i].Ranges[j].High;var q1=Object.keys(o1)[0];if(p1){var r1=Object.keys(p1)[0];h1.push(new F(l1,n1.EnumMember,o1[q1],p1[r1]));}else{h1.push(new F(l1,n1.EnumMember,o1[q1]));}}}}}return h1;}function w(i,j){var b1;var c1=new Map([["EQ","NE"],["BT","NB"],["CP","NP"],["LE","GT"],["GE","LT"],["NE","EQ"],["NB","BT"],["NP","CP"],["GT","LE"],["LT","GE"]]);if(i==="I"){b1=j;}else if(i==="E"){if(c1.has(j)){b1=c1.get(j);}else{b1=j;}}return b1;}function H(i){for(var j in s){var b1=s[j];if(b1.smartControl.getEntitySet()===i){return true;}}return false;}function O(i,j){var b1=i.filters.slice(0);var c1=y();i.filters=A(i.filters,c1,j,false);if(r){for(var d1 in s){var e1=s[d1];x(b1,e1,j);}}}function x(i,j,b1){j.getFiltersForCount=function(){return A(i,j,b1,true);};}function A(i,j,b1,c1){if(I.getFiltersAdaptedFromItem){i=I.getFiltersAdaptedFromItem(i,j,b1,c1);}return i.concat(j.selectionVariantFilters);}function y(){return s[u];}function z(i,u){return I.formatMessageStrip(i,u);}function E(){return u;}function J(u){h.setProperty(P,u||q);}function K(){return I.getContentForIappState(u);}function L(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var b1=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=b1.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function N(i){u=I.getSelectedKeyAndRestoreFromIappState(i);if(s[u]){h.setProperty(P,u);}}function Q(){return s[u].templateSortOrder;}function V(i){var j=y();var b1=c.isSmartTable(j.smartControl);if(i!==2){j.smartControl[b1?"rebindTable":"rebindChart"]();}if(i>1){if(b1){if(o.refreshModelOnTableRefresh){var c1=T.oCommonUtils.refreshModel(j.smartControl);if(c1){a1(j.smartControl);}}T.oCommonUtils.refreshSmartTable(j.smartControl);}else{}}}function W(i,j,b1){var c1=Array.isArray(j);var d1=T.oComponentUtils.isComponentActive();if((c1&&j.length===0)||(b1&&f(b1))){return;}I.refreshOperation(i,j,b1,u,c1,d1,V);}function X(){var i=y();return I.setActiveButtonState(i);}function Y(){var i=y();return I.restoreActiveButtonState&&I.restoreActiveButtonState(i);}function Z(i,j,b1){if(I.setControlVariant){I.setControlVariant(i,j,b1);}}function $(i,j,b1,c1){return T.oCommonUtils.getCustomDataText(i).then(function(d1){b1.text=d1;c1.text=d1;return{modelEntry:b1,pathToTheItem:j};});}function _(i){h.setProperty(i.pathToTheItem,i.modelEntry);}function a1(i){if(I.refreshSiblingControls){I.refreshSiblingControls(i);}}(function(){t.testable(function(){return I;},"getImplementingHelper");t.testable(function(){return r;},"getShowCounts");t.testable(function(){return s[u];},"getCurrentViewMeta");var j=function(e1,k1,l1,m1){if(e1.numberOfUpdates!==l1){return;}var h1=p+"/"+e1.switchingKey;var i1=e({},h.getProperty(h1));if(!i1.state&&k1=="busy"){setTimeout(function(){if(h.getProperty(h1).state==="busy"){i1=e({},h.getProperty(h1));i1.state="busyLong";h.setProperty(h1,i1);}},k);}i1.state=k1;if(!k1){i1.count=m1;}h.setProperty(h1,i1);};var b1=o.switchingControl.getItems();for(var i=0;i<b1.length;i++){var c1=b1[i];var d1=c1.getKey();if(i===0){q=d1;}var e1={smartControl:o.smartControl||o.getSmartControl(d1),switchingKey:d1};var f1=I.getCustomDataHost(e1.smartControl,c1);var g1=T.oCommonUtils.getElementCustomData(f1);var h1=p+"/"+e1.switchingKey;var i1=Object.create(null);i1.text=g1.text;i1.count=0;i1.state="";i1.facetId=o.sectionKey;$(f1,h1,i1,e1).then(_);e1.templateSortOrder=g1.TemplateSortOrder;e1.getPath=G.bind(null,e1.smartControl);e1.selectionVariantFilters=v(e1.smartControl,g1);e1.numberOfUpdates=0;e1.updateStartFunction=j.bind(null,e1,"busy");e1.updateSuccessFunction=j.bind(null,e1,"");e1.errorFunction=j.bind(null,e1,"error");s[d1]=e1;}if(I.init){I.init(s,W,y);}if(o.manifestSettings.showCounts===undefined){r=I.getDefaultShowCounts();}else{r=o.manifestSettings.showCounts;}J();u=h.getProperty(P);var j1=h.bindProperty(P);j1.attachChange(function(k1){var l1=k1.getSource().getValue();if(l1===u){return;}u=l1;if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(l1);}var m1=o.isDataToBeShown();var n1=I.getRefreshMode(u);if(o.adaptRefreshRequestMode){n1=o.adaptRefreshRequestMode(n1);if(m1&&n1>0){V(n1);}else{var o1=y().smartControl;T.oCommonUtils.setEnabledToolbarButtons(o1);}}o.appStateChange();});})();return{updateCounts:U,refreshOperation:W,onRebindContentControl:O,formatMessageStrip:z,getSelectedKey:E,setSelectedKey:J,getContentForIappState:K,restoreFromIappState:N,formatItemTextForMultipleView:L,determineSortOrder:Q,setActiveButtonState:X,restoreActiveButtonState:Y,setControlVariant:Z,hasEntitySet:H,refreshSiblingControls:a1};}return B.extend("sap.suite.ui.generic.template.lib.multipleViews.MultipleViewsHandler",{constructor:function(C,T,o){e(this,g(C,T,o));}});});
