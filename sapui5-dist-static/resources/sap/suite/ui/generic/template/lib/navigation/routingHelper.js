sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/mvc/XMLView","sap/suite/ui/generic/template/lib/FlexibleColumnLayoutHandler","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/FeError"],function(C,X,F,t,S,a,e,b){"use strict";var c="lib.navigation.routingHelper";var l=new a(c).getLogger();var f=Object.create(null);var s={getPlaceholderInfo:Function.prototype};var o=(sap&&sap.ushell&&sap.ushell.Container)?sap.ushell.Container.getService("CrossApplicationNavigation"):(function(){var i=0;var R={done:function(G){G({getData:function(){return Object.create(null);}});},fail:function(){}};return{createEmptyAppState:function(){return{getKey:function(){i++;return""+i;},setData:Function.prototype,save:function(){return Promise.resolve();}};},getAppState:function(){return R;},isInitialNavigation:function(){return true;}};})();function d(R,T,i,G,I){var J=e({controlId:i,controlAggregation:G},I);var K=R.getTargets();K.addTarget(T,J);return K.getTarget(T);}function g(R,i,V,T,G){return d(R,T,i,G,{viewName:V});}function h(N,T){if(N.oTemplateContract.oFlexibleColumnLayoutHandler){N.oTemplateContract.oFlexibleColumnLayoutHandler.createMessagePageTargets(g.bind(null,N.oRouter,T,"sap.suite.ui.generic.template.fragments.MessagePage"));}else{g(N.oRouter,T,"sap.suite.ui.generic.template.fragments.MessagePage","messagePage","pages");}}function j(N,T,i,G){var I=g(N.oRouter,i,T.sRouteName,T.sRouteName,G);var R=function(){N.treeNodeFirstDisplay(T);I.detachDisplay(R);};I.attachDisplay(R);}function D(N,T,P){var i=T.page.routingSpec?T.page.routingSpec.draftSpec:"OData";if(i===undefined){i="parent";}switch(i){case"parent":T.isDraft=P.isDraft;return;case"OData":var G=N.oAppComponent.getTransactionController().getDraftController();var I=G.getDraftContext();try{T.isDraft=I.isDraftEnabled(T.entitySet);}catch(J){l.warning("Could not determine draft info for entity set "+T.entitySet);T.isDraft=P&&P.isDraft;}finally{return;}}T.isDraft=i;}function k(T){var i=T.page.component.name;var P=f[i];if(!P){P=new Promise(function(R){var G=i.replace(/\./g,"/")+"/behaviour";sap.ui.require([G],function(I){var M=e({},s);e(M,I);R(M);},function(){R(s);});});f[i]=P;}return P.then(function(G){T.behaviour=G;});}function m(R){var i=[];for(var G in R){var T=R[G];i.push(k(T));}return i;}function A(T){T.children=[];T.text="";T.willBeDisplayed=new Promise(function(R){T.display=function(){R();T.display=Function.prototype;};});return T;}function n(T){var i=T.oAppComponent.getFlexibleColumnLayout();if(i){T.oFlexibleColumnLayoutHandler=new F(T.oNavigationHost,T.oNavigationControllerProxy);}var G=X.create({viewName:"sap.suite.ui.generic.template.fragments.TemplateHost"}).then(function(I){T.oNavigationControllerProxy.createHostView=function(){return I.clone();};});var M=T.oAppComponent.getModel();var P=Promise.all([G,M.getMetaModel().loaded()]);return P.then(function(){var I=T.oNavigationHost.getId();var J=T.oAppComponent.getConfig();if(!J.pages||!J.pages.length){throw new b(c,"Route Configuration missing");}if(J.pages.length>1){throw new b(c,"Currently only one Top route supported");}var K=J.pages[0];T.mEntityTree=Object.create(null);T.mRoutingTree=Object.create(null);var L=A({sRouteName:"root",entitySet:K.entitySet,page:K,getPath:function(){return"";},level:0,fCLLevel:0,headerTitle:T.oAppComponent.getManifestEntry("sap.app").title});D(T.oNavigationControllerProxy,L,null);B([],K,L,null,T.oNavigationControllerProxy,I);p("root",K,0,L,T.oNavigationControllerProxy,I,L.children);h(T.oNavigationControllerProxy,I);var N=m(T.mRoutingTree);return Promise.all(N);});}function p(P,G,L,I,N,T,J,K,M){var i,O;if(G.pages){O=G.pages.length;for(i=0;i<O;i++){v(P,G.pages[i],L+1,I,N,T,J,K,M||0);}}}function q(){return"---";}function H(P,i,G,L,I,N,T,J,K,M){P=I.target||P;var O={pages:G.pages};var Q={entitySet:I.entitySet,sRouteName:I.sRouteName,isDraft:I.isDraft,embeddedComponent:i,getPath:function(R){if(R===1){return I.getPath(1)+"/"+i;}return I.getPath(R);},patternDelimiter:q()};p(P,O,L,Q,N,T,J,K,M);}function r(P,T,L,N,i,G,I,J,K,M,O){var Q={};var R={key:I,definition:J,componentName:J.componentName,componentUsage:J.componentUsage,hiddenByDefault:J.hiddenByDefault,containerId:K,sectionId:M,subSectionId:O,pages:J.pages||[],children:[],communicationObject:Q};T.embeddedComponents[I]=R;if(J.pages){H(P,I,J,L,T,N,i,R.children,Q,G);}}function u(P,T,G,L,N,I,J){T.embeddedComponents=Object.create(null);T.leadingComponents=Object.create(null);T.facetsWithEmbeddedComponents=Object.create(null);if(G.implementingComponent){r(P,T,L,N,I,J,"implementation",G.implementingComponent,"template::ImplementingComponent");}else if(G.embeddedComponents){var K=Object.create(null);var M=Object.create(null);var O;var Q;var R;for(O in G.embeddedComponents){Q=G.embeddedComponents[O];if(!Q.leadingSectionIdOrPath||Q.leadingSectionIdOrPath===O){K[O]=[O];}else if(G.embeddedComponents[Q.leadingSectionIdOrPath]){M[O]=Q.leadingSectionIdOrPath;}else{R=T.facetsWithEmbeddedComponents[Q.leadingSectionIdOrPath];if(R){R.push(O);}else{T.facetsWithEmbeddedComponents[Q.leadingSectionIdOrPath]=[O];}}}var U=[];for(O in M){var V=M[O];R=K[V];if(R){R.push(O);}else{U.push(O);delete M[O];}}for(var i=0;i<U.length;i++){K[U[i]]=[U[i]];}for(O in G.embeddedComponents){Q=G.embeddedComponents[O];var W=K[O]&&S.getStableId({type:"ObjectPageSection",subType:"ReuseComponentSection",sReuseComponentName:Q.componentName,sReuseComponentUsage:Q.componentUsage,sReuseComponentId:O});var Y=S.getStableId({type:"ObjectPageSection",subType:"ReuseComponentSubSection",sReuseComponentName:Q.componentName,sReuseComponentUsage:Q.componentUsage,sReuseComponentId:O});var Z=S.getStableId({type:"ObjectPageSection",subType:"ReuseComponentContainer",sReuseComponentName:Q.componentName,sReuseComponentUsage:Q.componentUsage,sReuseComponentId:O});r(P,T,L,N,I,J,O,Q,Z,W,Y);}Object.keys(K).forEach(function(V){var $=T.embeddedComponents[V];T.leadingComponents[V]={sectionId:$.sectionId,title:$.definition.groupTitle||$.definition.title,followingComponents:K[V].map(function(_){var a1=T.embeddedComponents[_];a1.sectionId=$.sectionId;return a1;})};});}}function v(P,i,L,G,N,T,I,J,K){var M=i.routingSpec&&i.routingSpec.noOData;var O=N.oAppComponent.getModel();var Q=O.getMetaModel();var R=Q.getODataEntitySet(i.entitySet);if(i.component&&(M||R)){var U=N.oTemplateContract.oFlexibleColumnLayoutHandler?N.oTemplateContract.oFlexibleColumnLayoutHandler.getMaxColumnCountInFCL():1;var V=(U===1)||(i.defaultLayoutType==="OneColumn")?0:K+1;var W=A({parent:G&&G.entitySet,parentRoute:G?G.sRouteName:"root",parentEmbeddedComponent:G&&G.embeddedComponent,entitySet:i.entitySet,navigationProperty:i.navigationProperty,level:L,fCLLevel:V>=U?3:V,communicationObject:J,page:i,defaultLayoutType:i.defaultLayoutType,noKey:i.routingSpec&&i.routingSpec.noKey,noOData:M});D(N,W,G);y(W,G,N.oTemplateContract.bCreateRequestsCanonical);z(W,N.oTemplateContract);var Y=B(P,i,W,G,N,T);var O=N.oAppComponent.getModel();var Z=O.getMetaModel().getODataEntitySet(i.entitySet);W.semanticObject=Z&&Z["com.sap.vocabularies.Common.v1.SemanticObject"]&&Z["com.sap.vocabularies.Common.v1.SemanticObject"].String;if(I){I.push(i.entitySet);}var $=N.oTemplateContract.mEntityTree[i.entitySet];if(!$||$.level>W.level){N.oTemplateContract.mEntityTree[i.entitySet]=W;}x(N,W,i);p(Y.target,i,L,W,N,T,W.children,J,V);u(Y.target,W,i,L,N,T,V);}}function w(R,N){var Q=e({},R);Q.name=R.name+"query";Q.pattern=R.pattern+"{?query}";N.oRouter.addRoute(Q);}function x(N,T,P){if(T.noOData){T.headerTitle=P.routingSpec.headerTitle;T.titleIconUrl=P.routingSpec.titleIconUrl;}else{var M=N.oAppComponent.getModel();var i=M.getMetaModel();i.loaded().then(function(){var G=i.getODataEntitySet(T.entitySet);var I=i.getODataEntityType(G.entityType);var J=I["com.sap.vocabularies.UI.v1.HeaderInfo"];var K=(J&&J.TypeName&&J.TypeName.String)||"";if(K.substr(0,7)==="{@i18n>"){var L=K.substring(1,K.length-1);var O=L.split(">");K=N.oAppComponent.getModel(O[0]).getResourceBundle().getText(O[1]);}T.headerTitle=K;var Q=(J&&J.Title&&J.Title.IconUrl&&J.Title.IconUrl.String)||"";T.titleIconUrl=Q;});}}function y(T,P,G){var I=(T.level===1||!T.page.navigationProperty)?T.page.entitySet:T.page.navigationProperty;var K=T.noKey?"":"({keys"+T.level+"})";var R=I+K;var J=P&&P.getPath(1);if(J){R=J+(P.patternDelimiter||"/")+R;}var L;var M;if(T.noOData){var N=T.page.routingSpec.binding?("/"+T.page.routingSpec.binding):"";L=P.getPath(3)+N;M=P.getPath(2)+N;}else{L="/"+T.entitySet+K;M=G||(!T.page.navigationProperty||T.level===1)?L:P.getPath(2)+"/"+T.page.navigationProperty+K;}T.getPath=function(O,Q){var U;switch(O){case 1:U=R;break;case 2:U=M;break;case 3:U=L;break;default:}if(Q){for(var i=1;i<=T.level;i++){U=U.replace("{keys"+i+"}",Q[i]);}}return U;};}function z(T,i){T.specificModelName="_templPrivGlobaleODESM_"+T.entitySet;i.oAppComponent.setModel(i.oAppComponent.getModel(),T.specificModelName);T.bindElement=function(G,I,J,K){var L=T.componentId&&i.componentRegistry[T.componentId];var N=L&&!I&&L.nonDraftCreateContext;if(N){G.setBindingContext(N,J?T.specificModelName:undefined);return;}var P={createPreliminaryContext:true,canonicalRequest:!i.bCreateRequestsCanonical};var R=L&&L.utils.getRootExpand();if(R){P.expand=R;}var M={path:I||T.getPath(2,i.oNavigationControllerProxy.getCurrentKeys(T.level)),events:K||{},parameters:P,batchGroupId:"Changes",changeSetId:"Changes"};if(J){M.model=T.specificModelName;}G.bindElement(M);};}function B(P,i,T,G,N,I){T.componentCreated=new Promise(function(R){T.componentCreatedResolve=R;});var L=T.level;var J=Array.isArray(P)?P:[P];var K={};switch(L){case 0:T.sRouteName="root";break;case 1:T.sRouteName=i.entitySet;break;default:T.sRouteName=G.sRouteName+"/"+(G.embeddedComponent?G.embeddedComponent+"/":"")+(i.navigationProperty||i.entitySet);}N.oTemplateContract.mRoutingTree[T.sRouteName]=T;K.name=T.sRouteName;var M;if(N.oTemplateContract.oFlexibleColumnLayoutHandler){M=N.oTemplateContract.oFlexibleColumnLayoutHandler.adaptRoutingInfo(K,T.sRouteName,J,T);}else{M="pages";K.target=T.sRouteName;}j(N,T,I,M);K.pattern=T.getPath(1);N.oRouter.addRoute(K);w(K,N);return K;}function E(){return o;}return{generateRoutingStructure:n,getCrossAppNavService:E,getEmbeddedComponentsPatternDelimiter:q};});
