sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/lib/navigation/routingHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/extend","sap/base/util/deepExtend","sap/base/util/isEmptyObject"],function(B,r,t,F,e,d,a){"use strict";var l=new F("lib.StatePreserver").getLogger();var c=r.getCrossAppNavService();t.testableStatic(function b(s){c=s;},"StatePreserver_setCrossAppNavService");function g(T,s){var R=T.componentRegistry[s.oComponent.getId()];var b="";var A=Promise.resolve();var n=null;var o=Promise.resolve();var f=null;var S=null;var h=null;var L,j;var C=Object.create(null);var k={};var m={};function I(){C.permanentEntries=Object.create(null);C.sessionEntries=Object.create(null);C.pageEntries=Object.create(null);C.allEntries=Object.create(null);}I();function p(i){I();for(var U in i){var V=d({},i[U]);C.allEntries[U]=V;var W=V.lifecycle||Object.create(null);if(W.permanent){C.permanentEntries[U]=V;}else if(W.session){C.sessionEntries[U]=V;}if(W.page||W.pagination){C.pageEntries[U]=V;}}return C;}function M(i,U){if(U===i){return;}var V=U.next.next;U.next.next=i.next;i.next=U.next;U.next=V;}function q(i,U,V){if(a(U)){return{appStateKey:""};}var W=JSON.stringify(U);var X=0;var Y;for(Y=i;Y.next&&X<10;X++){if(Y.next.serialize===W){M(i,Y);return{appStateKey:i.next.appStateKey};}Y=Y.next;}Y.next=null;var Z=c.createEmptyAppState(s.oComponent.getAppComponent(),!V);var $={next:i.next,serialize:W,appStateKey:Z.getKey()};Z.setData(U);Z.save();i.next=$;return{appStateKey:$.appStateKey};}function u(){var i=q(m,C.sessionEntries,false);var U=Object.create(null);if(i.appStateKey){U.sessionAppStateKey=i.appStateKey;}if(!a(C.permanentEntries)){U.permanentEntries=C.permanentEntries;}S=q(k,U,true);if(h===S.appStateKey){S=null;}else if(R.utils.isComponentActive()){T.oNavigationControllerProxy.navigateByExchangingQueryParam(s.appStateName,S.appStateKey);}else{b=S.appStateKey;S=null;}if(f){f(T.oBusyHelper.getUnbusy());f=null;}}function v(){if(!f||b!==h){return;}var i=s.getCurrentState()||Object.create(null);p(i);u();}function w(){var U=R.aKeys;var V="";var W=R.route;for(var i=U.length-1;i>0;i--){var X=T.mRoutingTree[W];var Y=i===1?X.entitySet:X.navigationProperty;V="/"+Y+(U[i]?"("+U[i]+")":"")+V;W=X.parentRoute;}return V;}function x(i,U){return A.then(function(){var V=Object.create(null);var W=(!i||w()===i)&&L;if(W){V[s.appStateName]=W;}return V;});}function y(){if(!f){o=new Promise(function(i){f=i;setTimeout(v,0);});}return o;}function z(){b=h;S=null;L=h;}function D(i,U,V){if(!U){return;}for(var W in U){var X=U[W];if(V||X.lifecycle.page){i[W]=X;}}}function E(i,U){p(U);var V=Object.create(null);for(var W in U){V[W]=U[W].data;}s.applyState(V,i);if(n){n();n=null;}z();u();v();}function G(i,U,V){for(var W=i;W.next;W=W.next){if(W.next.appStateKey===V){M(i,W);return;}}var X={next:i.next,serialize:JSON.stringify(U),appStateKey:V};i.next=X;}function H(i,U,V,W,X,Y,Z,$){if(h===null){h=V;}else if(V!==h){U();return;}if($){var _=$.getData();G(m,_,Z);D(X,_,true);}D(X,Y,true);E(W,X);i();}function J(i,U,V,W,X,Y){var Z=Y&&Y.getData()||Object.create(null);G(k,Z,V);if(!Z.permanentEntries){Z={permanentEntries:{permanentState:{data:Z,lifecycle:{permanent:true}}}};}if(Z.sessionAppStateKey){var $=c.getAppState(s.oComponent.getAppComponent(),Z.sessionAppStateKey);$.done(H.bind(null,i,U,V,W,X,Z.permanentEntries,Z.sessionAppStateKey));$.fail(H.bind(null,U,U,V,W,X,Z.permanentEntries,"",null));}else{H(i,U,V,W,X,Z.permanentEntries,"",null);}}function K(i){var R=T.componentRegistry[s.oComponent.getId()];var U=R.utils.getHeaderDataAvailablePromise()||Promise.resolve();return U.then(function(){return T.oApplicationProxy.areTwoKnownPathesIdentical(j,i,R.viewLevel===1);});}function N(i,U){if(i===j){U(true);return;}if(!i||!j){U(false);return;}K(i).then(U);}function O(i,U){var V=new Promise(function(W,X){N(i,function(Y){if(!s.callAlways&&Y&&h===b){W();return;}j=i;var Z=Object.create(null);D(Z,C[Y?"allEntries":"pageEntries"],Y||U);if(!h){if(Y){D(Z,C.sessionEntries,true);D(Z,C.permanentEntries,true);}E(Y,Z);W();return;}if(!n){A=new Promise(function(_){n=_;});}var $=c.getAppState(s.oComponent.getAppComponent(),h);$.done(J.bind(null,W,X,h,Y,Z));$.fail(J.bind(null,X,X,h,Y,Z,null));},X);});return V;}function P(i){h=i[s.appStateName]||"";if(Array.isArray(h)){h=h.sort()[0]||"";}if(S){if(S.appStateKey!==h){l.error("StatePreserver: Got AppstateKey "+h+" expected "+S.appStateKey);return false;}z();return true;}return false;}function Q(){return{isStateChange:P};}return{getUrlParameterInfo:x,stateChanged:y,applyAppState:O,getAsStateChanger:Q};}return B.extend("sap.suite.ui.generic.template.lib.StatePreserver",{constructor:function(T,s){e(this,g(T,s));}});});
