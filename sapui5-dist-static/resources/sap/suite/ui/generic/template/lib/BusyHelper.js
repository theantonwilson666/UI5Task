sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/suite/ui/generic/template/js/placeholderHelper"],function(B,M,t,F,a,i,b,p){"use strict";var c="lib.BusyHelper";var f=new F(c);var l=f.getLogger();var L=f.Level;function g(T){var C=0;var m={};var I=false;var d=false;var h=0;T.oNavigationHost.setBusyIndicatorDelay(0);var u=Promise.resolve();var U=Function.prototype;var o={};function j(){return h!==0||!i(m);}var A;function k(e){var y=p.isPlaceHolderInactive(T.oTemplatePrivateGlobalModel);if(y){var z=j();if(z||e){d=false;T.oNavigationHost.setBusy(z);l.info("Physical busy state has been changed to "+z);if(z!==I){I=z;if(!I){var D=T&&T.oNavigationControllerProxy&&T.oNavigationControllerProxy.getActiveComponents();if(D){for(var G=0;G<D.length;G++){var H=D[G];if(!H){continue;}var J=T.componentRegistry&&T.componentRegistry[H]&&T.componentRegistry[H].oController;J&&J.adaptTransientMessageExtension&&J.adaptTransientMessageExtension();}}u=Promise.resolve();var K=M.getTransientMessages();var N=q(K);var R=N?{action:T.oViewDependencyHelper.setActivePagesToDirty,actionLabel:T.getText("ETAG_REFRESH_BUTTON")}:null;u=M.handleTransientMessages(T.oApplicationProxy.getDialogFragment,o.actionLabel,R);o={};u.then(U);}}}else{var O=T.oNavigationObserver.getProcessFinished(true);O.then(A,A);}}}A=k.bind(null,true);T.oTemplatePrivateGlobalModel.bindProperty("/generic/placeholdersShown").attachChange(A);function E(e){if(e){k();}else if(!d){d=true;setTimeout(k,0);}}function n(){h--;if(!h){E(false);}}function q(e){var y=T.getText("ETAG_MESSAGE");var z=false;e.forEach(function(D){if(M.isMessageETagMessage(D)){z=true;D.setMessage(y);D.setDescription(undefined);D.setDescriptionUrl(undefined);}});return z;}function r(){if(I){return;}I=true;u=new Promise(function(R){U=R;});M.removeTransientMessages();}function s(y,z,D){var S=[],G="",H=T.oNavigationHost.getId(),J="sap.suite.ui.generic.template.busyHandling";try{throw new b(c,"Get the stack");}catch(e){S=e.stack.split(y,2);if(S.length>=2){S=S[1].split("\n");S.shift();}if(S.length){G=S[0].trim();}}if(l.getLevel(J)<L.INFO){l.setLevel(L.INFO,J);}l.info("busyHandling: "+y,D+" called (count: "+C+")",J,function(){var K={method:y,reason:D,promise:z,promisePending:true,caller:G,callStack:S,elementId:H,type:J};function P(){K.promisePending=false;}K.promise.then(P,P);return K;});}function v(R,e,y,S){var z;if(e){a(o,S);r();if(!m[R]){C++;z=new Promise(function(D){m[R]=D;});if(sap.ui.support){s("setBusyReason",z,R);}}}else{if(m[R]){m[R]();}delete m[R];}E(e&&y);}function w(e,y,S){C++;a(o,S);h++;r();e.then(n,n);E(y);if(sap.ui.support){s("setBusy",e,"");}}function x(){return 0;}return{setBusyReason:v,setBusy:w,isBusy:j,getUnbusy:function(){return u;},getBusyDelay:x};}return B.extend("sap.suite.ui.generic.template.lib.BusyHelper",{constructor:function(T){a(this,(t.testableStatic(g,"BusyHelper"))(T));}});});
