sap.ui.define(["sap/ui/base/Object","sap/base/util/each","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper"],function(B,e,a,d){"use strict";function g(t){var p={};var P=[];var A=Object.create(null);function c(i){var E=t.oAppComponent.getTransactionController().getDraftController();var F=E.getDraftContext();var G=i.getObject();var I=F.hasDraft(i);var H=I&&!G.IsActiveEntity;var J=H&&!G.HasActiveEntity;var K=false;var O=G.HasDraftEntity?i.getObject("DraftAdministrativeData/DraftIsCreatedByMe"):false;if(G.DraftEntityCreationDateTime&&G.DraftEntityLastChangeDateTime){K=G.DraftEntityCreationDateTime.getTime()!==G.DraftEntityLastChangeDateTime.getTime();}return{bIsDraft:H,bIsDraftSupported:I,bIsCreate:J,bIsDraftModified:K,bOwnDraftExists:O};}function r(E,V,F,K){var G=E.getPath();var H=c(E);if(V===1&&!H.bIsCreate){P.push(G);}var I=a(p[G]||{},{oContextInfo:H,oContext:E});p[G]=I;if(H.bIsDraft&&!H.bIsCreate){I.bReplaceByActive=false;}else if(H.bOwnDraftExists&&!H.bIsCreate){if(I.oEditingPromise){I.oEditingPromise.then(function(_){var a1=_.context.getPath();p[a1].bReplaceByActive=true;});}else{u(E).then(function(_){var a1=_.getPath();var b1=p[a1];if(b1){p[a1].bReplaceByActive=true;}});}}var S=null;var R;if(H.bIsDraftSupported&&!H.bIsCreate&&F){var T=t.mEntityTree[F];if(T&&!T.noOData){if(K){if(H.bIsDraft){var J=[];var L=t.oApplicationProxy.fillSiblingKeyPromise(T,K,J);L.then(function(_){var a1=_.getPath(3,J);if(!p[a1]){p[a1]={oContextInfo:{bIsDraft:false,bIsDraftSupported:true,bIsCreate:false,bIsDraftModified:false,bOwnDraftExists:true},aKeysFromIdentity:J};}});}if(T&&!T.noOData){var M=t.oApplicationProxy.getAncestralNode(T,1);var N=A[M.entitySet];if(!N){N={treeNode:M,draftRoots:Object.create(null)};A[M.entitySet]=N;}var O=K[1];R=N[O];if(!R){R={treeNode:M,key:O,childContexts:Object.create(null)};N[O]=R;}}}var Q=E.getModel();var U=Q.getMetaModel();var W=U.getODataEntitySet(F);var X=U.getODataEntityType(W.entityType);var Y=X["com.sap.vocabularies.Common.v1.SemanticKey"];if(Y){S=[];for(var i=0;i<Y.length;i++){S.push(E.getProperty(Y[i].PropertyPath));}}}}if(S){I.aSemanticKeysValues=S;}if(K){I.aKeysFromIdentity=K;}if(R){I.oRootContextInfo=R;R.childContexts[G]=I;}if(H.bIsDraftSupported&&I.oRootContextInfo){for(var Z in I.oRootContextInfo.childContexts){var $=I.oRootContextInfo.childContexts[Z];delete $.oRemovalPromise;}}return H;}function b(){for(var i=P.length-1;i>=0;i--){var E=p[P[i]].oContext;if(E){return P[i];}}}function f(i){var E=i.getPath();var R=p[E];return R;}function h(i){var R=f(i);return!!(R&&(R.oContext||R.oRemovalPromise));}function s(i,R,I,E){if(!i.oContextInfo.bIsCreate||!I){if(E){i.oRemovalPromise=R.then(function(F){return F.context;});}else{i.oRemovalPromise=i.oSiblingPromise||(i.oContext&&u(i.oContext));}}R.then(function(){i.oContext=null;},function(){delete i.oRemovalPromise;});}function j(i,R,I,E){var F=f(i);if(E==="deleteAction"&&!F.oContextInfo.bIsCreate){F.oRemovalPromise=R.then(function(J){F.oContext=null;return J.context;},function(){delete F.oRemovalPromise;});}else if(F.oRootContextInfo){for(var G in F.oRootContextInfo.childContexts){var H=F.oRootContextInfo.childContexts[G];if(H.oContextInfo.bIsDraftSupported){s(H,R,I,F===H);}}}else{s(F,R,I,true);}if(!F.oContextInfo.bIsCreate||!I){R.then(function(J){var K=J.context.getPath();var L=p[K];if(L){delete L.oEditingPromise;m(L,false);}});}}function k(i,E){j(i,E,false);}function l(i,E,F){j(i,E,true,F);}function m(i,E){if(i.oRootContextInfo){e(i.oRootContextInfo.childContexts,function(){this.oContextInfo.bOwnDraftExists=E;});}else{i.oContextInfo.bOwnDraftExists=E;}}function n(i,E){var F=f(i);F.oEditingPromise=new Promise(function(R,G){var N=function(){delete F.oEditingPromise;m(F,false);G();};E.then(function(H){if(H.draftAdministrativeData){N();}else{m(F,true);var I=H.context.getPath();p[I]={sActiveContextPath:i.getPath(),oContext:H.context,oContextInfo:{bIsDraft:true,bIsDraftSupported:true,bIsCreate:false,bIsDraftModified:false,bOwnDraftExists:false}};R(H);}},N);});F.oEditingPromise.catch(Function.prototype);}function o(i){var E=p[i];if(E){E.oContext=null;}}function q(M,i,E){return new Promise(function(R,F){M.read(i+"/SiblingEntity",{success:function(G){if(G){var S="/"+M.getKey(G);var H=M.getContext(S);R(H);}else{F();}},error:function(G){F(G);},groupId:E});});}function u(i,E){var F=f(i);if(F.oContextInfo.bIsCreate){return Promise.resolve();}else if(F.sActiveContextPath){var G=p[F.sActiveContextPath];return Promise.resolve(G.oContext);}var S=F.oSiblingPromise;if(!S){if(F.oContextInfo.bIsDraftSupported&&F.oEditingPromise){S=F.oEditingPromise.then(function(H){var I=H.context.getPath();var J=I&&p[I];if(J&&!J.oRemovalPromise){return Promise.resolve(H.context);}else{return q(i.getModel(),i.getPath());}});}else{S=F.oContextInfo.bIsDraftSupported?q(i.getModel(),i.getPath(),E):Promise.resolve(i);if(F.oContextInfo.bIsDraft||!F.oContextInfo.bIsDraftSupported){F.oSiblingPromise=S;}}}return S;}function v(i,E){var F=p[i];if(F&&F.oSiblingPromise){return F.oSiblingPromise;}else if(F&&F.sActiveContextPath){var G=p[F.sActiveContextPath];return Promise.resolve(G.oContext);}else{var S=F&&F.oContext?u(F.oContext,E):q(t.oAppComponent.getModel(),i,E);S.then(function(H){if(H){var I=d.analyseContext(H).canonicalPath;if(!p[I]){p[I]={oContextInfo:c(H),oContext:H};}}var J=F&&F.oContext;if(!J){var M=t.oAppComponent.getModel();J=M.createBindingContext(i);if(J){F=F||{};F.oContext=J;F.oContextInfo=c(J);p[i]=F;}}if(J&&H&&F.oContextInfo.bIsDraftSupported){var K=F.oContextInfo.bIsDraft?i:I;var L=F.oContextInfo.bIsDraft?I:i;p[K].sActiveContextPath=L;}});return S;}}function w(i){if(i.treeNode.level===0){return Promise.resolve();}var M=t.oApplicationProxy.getAncestralNode(i.treeNode,1);if(M.noOData||!M.isDraft){return Promise.resolve();}var E=M.getPath(3,i.keys.slice(0,2));return x(E).then(function(F){if(!F){return null;}var G=F.iDisplayMode;var H=false;var T=["",d.analyseContext(F.context).key];var I=function(K){if(!H&&G===2){G=K.isDraft?6:1;}var L={treeNode:K,keys:T};var R={identity:L,displayMode:G};return t.oNavigationControllerProxy.adaptAppStates(i,L).then(function(){return R;});};var J=function(K){if(K===i.treeNode){return I(K);}var L=t.oApplicationProxy.getAncestralNode(i.treeNode,K.level+1);var N=i.keys.slice(0,L.level+1);var O=L.getPath(3,N);return x(O).then(function(Q){if(!Q){return I(K);}T.push(d.analyseContext(Q.context).key);G=Q.iDisplayMode;H=true;return J(L);});};return t.oApplicationProxy.fillSiblingKeyPromise(i.treeNode,i.keys,T).then(J);});}function x(i){var E=p[i];if(!E){return Promise.resolve();}return new Promise(function(R){var F=null;var G=function(){R(F);};var H=function(I){I.then(function(J){var K=J.context.getPath();var L=p[K];if(L&&L.oContext&&!L.bReplaceByActive){F={context:J.context,iDisplayMode:2};}G();},G);};if(E.oRemovalPromise){E.oRemovalPromise.then(function(I){F={context:I,iDisplayMode:1};var J=I.getPath();var K=p[J];var L=K&&K.oEditingPromise;if(L){H(L);}else{G();}},G);}else if(E.bReplaceByActive){u(E.oContext).then(function(I){F={context:I,iDisplayMode:1};G();});}else if(!E.oContextInfo.bIsDraft&&E.oContextInfo.bOwnDraftExists){if(E.oEditingPromise){H(E.oEditingPromise);}else if(E.oContext){u(E.oContext).then(function(I){var J=I.getPath();var K=p[J];if(!K||!K.bReplaceByActive){F={context:I,iDisplayMode:2};}G();});}else{G();}}else{G();}});}function y(i){var E=f(i);return E&&E.aKeysFromIdentity;}function z(E,F,I,H,N){return new Promise(function(R,G){var M=t.oAppComponent.getModel();var J=E&&d.analyseContextPath(E,M).canonicalPath;var K=F&&d.analyseContextPath(F,M).canonicalPath;if(J===K){R(true);return;}if(!J||!K){R(false);return;}var L=p[J];if(!L||!L.oContextInfo.bIsDraftSupported){R(false);return;}var O=p[K];var Q,S;if((!L||!L.oContext)&&(O&&!O.oContextInfo.bIsDraft)){var T=function(i){return i;};L=T(O,O=L);J=T(K,K=J);H=T(N,N=H);}function U(L,O){if(!L||!O){R(false);return;}if(!L.oContextInfo.bIsDraft&&!O.oContextInfo.bIsDraft){R(false);return;}if(L.oContextInfo.bIsCreate&&O.oContextInfo.bIsCreate){R(false);return;}if(I){x(J).then(function(Z){R(!!Z&&Z.context.getPath()===K);},G);return;}if(L.aSemanticKeysValues){var Y=!!O.aSemanticKeysValues;for(var i=0;Y&&i<L.aSemanticKeysValues.length;i++){Y=L.aSemanticKeysValues[i]===O.aSemanticKeysValues[i];}R(Y);return;}R(false);}if(L.oContext&&!L.oContextInfo.bIsDraft&&(!O||!O.oContext)){if(H&&N&&H.treeNode.entitySet===N.treeNode.entitySet){S=N&&N.keys;var V=M.getContext(K)||M.createBindingContext(K);var W=V&&c(V);if(V&&!W.bIsDraft){R(false);}else{var X=u(L.oContext);X.then(function(i){if(i.sPath&&K===i.sPath){Q=i;O=p[K];if(!O||!O.oContext){r(Q,N.treeNode.level,N.treeNode.entitySet,S);p[K].sActiveContextPath=L.oContext.getPath();}U(L,p[K]);}else{R(false);}},function(){R(false);});}}else{R(false);return;}}else{U(L,O);}});}function C(i){return p[i].oContextInfo.bIsDraftModified;}function D(i){if(p[i]){p[i].oContextInfo.bIsDraftModified=true;}}return{registerContext:r,adaptAfterObjectDeleted:o,activationStarted:k,cancellationStarted:l,editingStarted:n,getDraftSiblingPromise:u,getSiblingPromise:v,getAlternativeIdentityPromise:w,getPathOfLastShownDraftRoot:b,areTwoKnownPathesIdentical:z,markDraftAsModified:D,getIsDraftModified:C,getIdentityKeyForContext:y,checkmPath2ContextData:h};}return B.extend("sap.suite.ui.generic.template.lib.ContextBookkeeping",{constructor:function(t){a(this,g(t));}});});
