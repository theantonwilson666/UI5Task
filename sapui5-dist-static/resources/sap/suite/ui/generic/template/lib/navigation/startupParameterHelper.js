sap.ui.define(["sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/each","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/analytics/odata4analytics","sap/ui/generic/app/util/ModelUtil","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/lib/CRUDHelper","sap/ui/core/format/DateFormat"],function(e,a,b,M,F,c,o,d,f,D,t,C,g){"use strict";var s="lib.navigation.startupParameterHelper";var l=new f(s).getLogger();function h(i,L){return{mode:i&&L&&(L!==i)?"inconsistent":L||i||"display",force:!!L};}function p(i){var L=i.oAppComponent.getModel("_templPrivGlobal");L.setProperty("/generic/forceFullscreenCreate",true);}function T(i,L){i.forEach(function(O){var Q=L[O];if(Q){var R=Q[0];R=R.toLowerCase().replace(/(guid')([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(')/,"$2");if(!R.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/)){R=R.replace(/([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})/,"$1-$2-$3-$4-$5");}Q[0]=R;}});}function j(i,L){i.forEach(function(O){var Q=L[O.name];if(Q){if(O["type"]==="Edm.DateTime"&&O["sap:display-format"]==="Date"){var R=g.getDateTimeInstance({pattern:"yyyy-MM-ddTHH:mm:ss.SSSZ"});var S=g.getDateInstance({pattern:"yyyy-MM-ddT00:00:00"});var U=R.parse(Q[0]);Q[0]=S.format(U);}}});}function k(i,L,O){if(a(O)){return;}var Q=i.getMetaModel();var R=Q.getODataEntitySet(L);var S=R&&R.entityType;var U=Q.getODataEntityType(S);var V=(U&&U.property)||[];var W=[],X=[];V.forEach(function(Y){if(Y.type==="Edm.Guid"){W.push(Y.name);}else if(Y.type==="Edm.DateTime"||Y.type==="Edm.DateTimeOffset"){X.push(Y);}});T(W,O);j(X,O);}function m(i){var L=i.oAppComponent.getInboundParameters();return L?Object.keys(L).filter(function(O){return L[O].useForCreate;}):[];}function P(L,O){var R;var Q=m(L);for(var i=0;i<Q.length;i++){var S=Q[i];var V=O[S];if(V&&V.length===1){R=R||Object.create(null);R[S]=V[0];}}return R;}function n(i,L,O){var Q=i.getODataEntityType(i.getODataEntitySet(L).entityType);Q.property.forEach(function(R){if(R["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var S=R["com.sap.vocabularies.Common.v1.EditableFieldFor"].PropertyPath||R["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var U=R.name;if(O[S]&&!O[U]){O[U]=O[S];}if(O[U]&&!O[S]){O[S]=O[U];}}});}function q(i,L){return!(i.page.navigation&&i.page.navigation[L.mode]);}function r(i,L){return!!i&&i.every(function(O){var Q=O.name||O.PropertyPath;var R=L[Q]||[];return R.length===1;});}function u(i){var S=D.splitCanonicalPath(i);return S.key;}function v(i,L,O,Q,R){if(O.noKey){return{treeNode:O,navigationPossible:true,keyValue:""};}var S=L.getODataEntitySet(O.entitySet);if(!S){return null;}var U=L.getODataEntityType(S.entityType);var V=U["com.sap.vocabularies.Common.v1.SemanticKey"];if(r(V,Q)){return{treeNode:O,key:V,isSemantic:true};}return R&&U.key.propertyRef&&r(U.key.propertyRef,Q)&&{treeNode:O,navigationPossible:true,keyValue:u(i.createKey(O.entitySet,Q))};}function w(i,L,O,Q,R,S,U){Q.children.forEach(function(V){var W=O.mEntityTree[V];if(W.page.component.settings&&W.page.component.settings.allowDeepLinking&&q(W,S)){var X=v(i,L,W,R,false);if(X){U[W.sRouteName]=X;w(i,L,O,W,R,S,U);}}});}function x(i,L,O,Q,R){var S=Object.create(null);S.root={treeNode:L.mRoutingTree.root,navigationPossible:true,keyValue:""};var U=L.mEntityTree[O];if(U&&!(U.page.component.settings&&U.page.component.settings.allowDeepLinking===false)&&q(U,R)){var V=i.getMetaModel();var W=v(i,V,U,Q,true);if(W){S[U.sRouteName]=W;if(R.mode==="display"){w(i,V,L,U,Q,R,S);}}}return S;}function y(i,L){var O=L.key.map(function(R){var S=R.PropertyPath;var V=i[S][0];return new F(S,c.EQ,V);});if(L.treeNode.isDraft){var Q=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});O.push(Q);}return new F(O,true);}function z(L,O,Q){var R=Q.treeNode.entitySet;var S="/"+R;try{var U=new o.Model(o.Model.ReferenceByModel(L));var V=U.findQueryResultByName(R);var W=new o.QueryResultRequest(V);var X=V&&V.getParameterization();var Y=false;if(X){W.setParameterizationRequest(new o.ParameterizationRequest(X));var Z=X.getAllParameterNames();b(Z,function(){if(O.hasOwnProperty(this)){Y=true;W.getParameterizationRequest().setParameterValue(this,O[this][0]);}});for(var i=0;i<Z.length;i++){if(Z[i].startsWith("P_")){var $=Z[i].substr(2);if(O.hasOwnProperty($)){Y=true;W.getParameterizationRequest().setParameterValue(Z[i],O[$][0]);}}}if(Y){S=W.getURIToQueryResultEntitySet();}}}catch(_){l.info(_.name+":"+_.message);}return S;}function A(R){if(!(R&&R.results)){return null;}var i;R.results.some(function(L){i=L;return L.IsActiveEntity;});return i;}function B(i,L,O){var Q=y(L,O);var R=z(i,L,O);return new Promise(function(S){i.read(R,{filters:[Q],success:function(U){var V=A(U);var W=V&&i.getKey(V);var X=W&&u(W);S(X);},error:function(){S();}});});}function N(L,O,Q,R){var S=Object.keys(Q).filter(function(i){return!Q[i].navigationPossible;});var U=S.map(function(i){var V=Q[i];return B(O,R,V);});return Promise.all(U).then(function(V){for(var i=0;i<S.length;i++){var W=Q[S[i]];W.keyValue=V[i];}var X=function(b1){var W=Q[b1];if(W.navigationPossible===undefined){W.navigationPossible=!!W.keyValue&&X(W.treeNode.parentRoute);}return W.navigationPossible;};var Y;b(Q,function(b1){if(X(b1)){var c1=Q[b1].treeNode;Y=(!Y||Y.level<c1.level)?c1:Y;}});var Z=[];for(var $=Y;$;$=$.level&&L.mRoutingTree[$.parentRoute]){Z[$.level]=Q[$.sRouteName].keyValue;}var _=Object.create(null);if(L.oFlexibleColumnLayoutHandler){L.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(Y,_);}var a1={treeNode:Y,keys:Z,appStates:_};return L.oNavigationControllerProxy.navigateToIdentity(a1,true,1).then(Function.prototype);});}function E(L,O){if(O==="create"&&L.mRoutingTree.root.page.component.settings&&L.mRoutingTree.root.page.component.settings.creationEntitySet){return Promise.resolve(L.mRoutingTree.root.page.component.settings.creationEntitySet);}return L.myIntentPromise?L.myIntentPromise.then(function(Q){var R=L.mRoutingTree.root.children;for(var i=0;i<R.length;i++){var S=R[i];if(L.mEntityTree[S].semanticObject===Q.semanticObject){return S;}}return L.mRoutingTree.root.entitySet;}):Promise.resolve(L.mRoutingTree.root.entitySet);}function G(i,L,O,Q){p(i);var R=P(i,L);var S=i.oAppComponent.getTransactionController().getDraftController();var U=S.getDraftContext().isDraftEnabled(Q);if(U){var V=i.mEntityTree[Q]||i.mRoutingTree.root;i.oNavigationControllerProxy.prepareHostView(V);var W=i.oNavigationControllerProxy.oRouter.getTargets();W.display(V.sRouteName);return V.componentCreated.then(function(Y){var Z=i.componentRegistry[Y.getId()];return Z.viewRegistered.then(function(){var $=null;var _=Z.oController;var a1=i.oAppComponent.getApplicationController();var b1=!!(i.mRoutingTree.root.page.component.settings&&i.mRoutingTree.root.page.component.settings.useNewActionForCreate);var c1={sRootExpand:$,oController:_,oApplicationController:a1,bUseNewActionForCreate:b1};var d1=C.create(S,Q,"/"+Q,O,i.oApplicationProxy,R,c1);return d1.then(function(e1){var X=Object.create(null);if(i.oFlexibleColumnLayoutHandler){var V=i.mEntityTree[Q];i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(V,X);}return i.oNavigationControllerProxy.navigateToSubContext(e1,true,4,null,X).then(Function.prototype);},function(e1){return{title:i.getText("ST_GENERIC_ERROR_TITLE"),text:e1.messageText,description:"",icon:"sap-icon://message-error"};});});});}var X=Object.create(null);if(i.oFlexibleColumnLayoutHandler){i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(i.mEntityTree[Q],X);}return i.oNavigationControllerProxy.navigateForNonDraftCreate(Q,R,null,X).then(Function.prototype);}function H(L,O,Q,R){p(L);return new Promise(function(S){var U=function(a1){S({title:L.getText("ST_ERROR"),text:(a1&&a1.messageText)||L.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),icon:"sap-icon://message-error",description:""});};var V=Q.getMetaModel().getODataEntitySet(R);var W=V["com.sap.vocabularies.Common.v1.DraftRoot"];if(W&&W.NewAction){var X=Q.getMetaModel().getODataFunctionImport(W.NewAction.String.split("/")[1]);var Y={};if(X){var Z=X.parameter?X.parameter.length:0;for(var i=0;i<Z;i++){var $=X.parameter[i];var _=$.mode==="In"&&O[$.name]&&O[$.name][0];if(_){Y[$.name]=_;}}Q.callFunction("/"+X.name,{success:function(a1,b1){var c1=new d(Q);var d1=c1.getContextFromResponse(a1);if(d1){L.oNavigationControllerProxy.navigateToSubContext(d1,true,4).then(S.bind(null,null));}else{U();}},error:U,method:"POST",urlParameters:Y});return;}}U();});}function I(i,L,O,Q,R){var S=e({},L);n(Q.getMetaModel(),O,S);var U=x(Q,i,O,S,R);var V;for(var W in U){if(W!=="root"){V=U[W];break;}}if(V){var X=i.oAppComponent.getTransactionController();var Y=V.isSemantic?"":"/"+Q.createKey(O,S);var Z=V.isSemantic&&V.key;var $=C.edit(X,O,Y,Q,i,i.oNavigationControllerProxy.fnInitializationResolve,Z,S);return $.then(function(_){var a1=Object.create(null);if(i.oFlexibleColumnLayoutHandler){var b1=i.mEntityTree[O];i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(b1,a1);}return i.oNavigationControllerProxy.navigateToSubContext(_.context,true,2,null,a1).then(Function.prototype);},function(_){if(_.lockedByUser){if(R.force){return{title:i.getText("LOCKED_OBJECT_POPOVER_TITLE"),text:i.getText("LOCKED_OBJECT_POPOVER_TITLE"),description:i.getText("ST_GENERIC_LOCKED_OBJECT_POPOVER_TEXT",[_.lockedByUser]),icon:"sap-icon://message-error"};}return N(i,Q,U,S);}if(_.draftAdminReadResponse){return null;}return new Promise(function(a1){var b1=i.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_EDIT");M.warning(b1,{onClose:function(){N(i,Q,U,S).then(a1);}});});});}return Promise.resolve();}function J(i,L,O,Q,R){var S=e({},L);n(Q.getMetaModel(),O,S);var U=x(Q,i,O,S,R);return N(i,Q,U,S);}function K(i,L){var R=L&&L.route&&L.route.length===1&&L.route[0];if(R){i.oNavigationControllerProxy.navigate(R,true);return Promise.resolve();}var O=L&&L.preferredMode&&L.preferredMode[0];var Q=L&&L.mode&&L.mode[0];var S=h(O,Q);var U=E(i,S.mode);return U.then(function(V){var W=i.oAppComponent.getModel();k(W,V,L);switch(S.mode){case"create":return G(i,L,W,V);case"createWithContext":return H(i,L,W,V);case"edit":return I(i,L,V,W,S);case"display":return J(i,L,V,W,S);}return{title:i.getText("ST_GENERIC_ERROR_TITLE"),text:i.getText("ST_GENERIC_ERROR_TITLE"),description:i.getText("PARAMETER_COMBINATION_NOT_SUPPORTED",[Q,O]),icon:"sap-icon://message-error",replaceURL:true};});}var k=t.testableStatic(k,"startupParameterHelper_fnTransformStartupParameters");return{parametersToNavigation:K};});
