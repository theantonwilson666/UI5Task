sap.ui.define(["sap/ui/thirdparty/jquery","sap/suite/ui/commons/library","sap/ui/core/Control","sap/ui/core/theming/Parameters","sap/m/Panel","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/FlexBox","sap/m/Label","sap/ui/model/Filter","sap/m/SearchField","sap/m/List","sap/m/StandardListItem","sap/m/CheckBox","sap/m/Title","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/Text","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/ui/model/FilterOperator","sap/base/security/encodeXML","sap/ui/core/format/NumberFormat","sap/ui/core/Core","sap/ui/core/Configuration","./TAccountUtils","./TAccountPanelRenderer","sap/m/library","sap/ui/thirdparty/bignumber"],function(q,l,C,P,a,J,D,B,F,L,b,S,c,d,e,T,f,g,h,j,k,m,n,N,o,p,r,s,M,t){"use strict";var u=M.ButtonType;var R=o.getLibraryResourceBundle("sap.suite.ui.commons");var v=l.taccount.TAccountPanelState;var w=a.extend("sap.suite.ui.commons.taccount.TAccountPanel",{metadata:{library:"sap.suite.ui.commons",properties:{title:{type:"string",group:"Misc",defaultValue:null},state:{type:"sap.suite.ui.commons.taccount.TAccountPanelState",group:"Misc",defaultValue:"Default"},showOverlay:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{properties:{type:"sap.suite.ui.commons.taccount.TAccountItemProperty",multiple:true,singularName:"property"},table:{type:"sap.ui.core.Control",multiple:false}},events:{stateChanged:{parameters:{state:"sap.suite.ui.commons.taccount.TAccountPanelState"}},settingsApplied:{parameters:{properties:"object"}}}}});w.prototype.init=function(){this._bDisplayLabels=true;};w.prototype.onBeforeRendering=function(){this._oSum=null;this._bRendered=false;this._prepareProperties();this._createToolbar();};w.prototype.onAfterRendering=function(){var $=this.$();this._switchContent(this.getState()===v.Table);this._bRendered=true;$.attr("aria-label",this._getAriaLabelText());$.addClass("sapSuiteUiCommonsAccountPanel");this._setTotalBalanceTitle();};w.prototype.getSum=function(){var x=new t("0"),y="",z=true,A=this.getContent();if(!this._oSum){for(var i=0;i<A.length;i++){var G=A[i];if(G instanceof sap.suite.ui.commons.taccount.TAccountGroup){var E=G._getSum();if((y&&y!==E.measure)||!E.correct){z=false;break;}y=E.measure;x=x.plus(E.sum);}}this._oSum={measure:y,sum:x||0,correct:z};}return this._oSum;};w.prototype.switchContent=function(i){var x=i?v.Table:v.Default;this._switchContent(i);this.setProperty("state",x,true);};w.prototype.getSettingsDialog=function(){return this._getPopover();};w.prototype.getToolbar=function(){return this._getToolbar();};w.prototype.openSettings=function(){this._oSelectAllCheckBox&&this._oSelectAllCheckBox.setText(this._getSelectAllText());this._getPopover().open();};w.prototype.reset=function(){this._oSum=null;if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}};w.prototype.setState=function(V){var i=V===v.Table;this._switchContent(i);this.setProperty("state",V,true);return this;};w.prototype.updateBindingContext=function(){this.reset();return C.prototype.updateBindingContext.apply(this,arguments);};w.prototype._switchContent=function(i){var x=i?v.Table:v.Default;this.$("table")[i?"show":"hide"]();this.$("datacontent")[i?"hide":"show"]();if(this._oDisplaySwitcher){this._oDisplaySwitcher.setSelectedKey(x);}};w.prototype._prepareProperties=function(){this._mProperties={};this.getProperties().forEach(function(i){var K=i.getKey();if(K){this._mProperties[K]=i;}}.bind(this));};w.prototype._setPropertiesVisibility=function(x){var $=this.$();Object.keys(x).forEach(function(K){var y=x[K],I=$.find(".sapSuiteUiCommonsAccountPropertyWrapper[key="+K+"]");I.each(function(i,z){var V=y.getVisible(),A=o.byId(z.id);if(A){A.setProperty("visible",V,true);A.getParent()._refreshAriaLabel();}q(z)[V?"show":"hide"]();});});$.find(".sapSuiteUiCommonsAccountItemLabel")[this._bDisplayLabels?"show":"hide"]();};w.prototype._getPopover=function(){if(!this._oPopover){this._createPopover();}return this._oPopover;};w.prototype._getSelectAllText=function(i){var x=this.getProperties();if(!i&&i!==0){i=x.reduce(function(y,z){return y+(z.getVisible()?1:0);},0);}this._iSelectedCount=i;return R.getText("TACCOUNT_SELECTALL")+" ("+i+"/"+x.length+")";};w.prototype._createPopover=function(){var i=this,x=false;if(!this._oPopover){this._oPopover=new D({contentWidth:"450px",title:R.getText("TACCOUNT_DISPLAYOPTIONS"),afterOpen:function(){if(!x){var Q=i._oPopover.$().height();i._oPopover.setProperty("contentHeight",Q+"px",true);x=true;}}});}this._oPopover.setEndButton(new B({text:R.getText("TACCOUNT_CANCEL"),press:function(Q){i._oPopover.close();}}));this._oPopover.setBeginButton(new B({text:R.getText("TACCOUNT_OK"),type:u.Emphasized,press:function(Q){var U=G.getSelectedContexts(true),V=G.getModel();var X={},Y={};U.forEach(function(Z){var $=V.getProperty(Z.sPath);if($){var _=i._mProperties[$.key];X[$.key]=1;if(_&&!_.getVisible()){_.setProperty("visible",true,true);Y[$.key]=_;}}});Object.keys(i._mProperties).forEach(function(Z){var $=i._mProperties[Z];if($.getVisible()&&!X[Z]){$.setProperty("visible",false,true);Y[Z]=$;}});i._bDisplayLabels=y.getSelected();if(i.fireEvent("settingsApplied",{properties:Y},true)){i._setPropertiesVisibility(Y);}i._oPopover.close();}}));this._oPopover.removeAllContent();var W=new F({width:"100%",renderType:"Bare",direction:"Column"});this._oPopover.addContent(W);var y=new e({selected:this._bDisplayLabels}).addStyleClass("sapUiTinyMarginBegin");var z=new F({renderType:"Bare",alignItems:"Center",items:[y,new L({text:"Show labels"}).addStyleClass("sapUiTinyMarginBegin")]}).addStyleClass("sapUiTinyMarginBottom sapUiTinyMarginTop");W.addItem(z);var A=function(Q){var U=[],V=Q.getSource().getValue();if(V&&V.length>0){U.push(new b("title",m.Contains,V));}var X=G.getBinding("items");X.filter(U,"Application");};var E=new S({width:"100%",liveChange:A}).addStyleClass("sapSuiteUiCommonsAccountsPopupSearch");W.addItem(E);var G=new c({width:"100%",mode:"MultiSelect",includeItemInSelection:true,selectionChange:function(Q){var U=Q.getParameter("listItem").getSelected();i._oSelectAllCheckBox.setText(i._getSelectAllText(i._iSelectedCount+(U?1:-1)));i._oSelectAllCheckBox.setSelected(H.length===i._iSelectedCount);}}).addStyleClass("sapSuiteUiCommonsAccountsPopupList");G.bindAggregation("items",{path:"/items",template:new d({title:"{title}",selected:"{selected}"})});var H=this.getProperties(),I=this._getSelectAllText();this._oSelectAllCheckBox=new e({selected:H.length===i._iSelectedCount,text:I,select:function(Q){var U=Q.getSource().getSelected();i._oSelectAllCheckBox.setText(i._getSelectAllText(U?H.length:0));G.getItems().forEach(function(V){V.setSelected(U);});}}).addStyleClass("sapUiTinyMarginBegin sapUiTinyMarginEnd sapSuiteUiCommonsAccountsPopupSelectAll");var K=new F({renderType:"Bare",alignItems:"Center"}).addStyleClass("sapSuiteUiCommonsAccountsPopupSelectAllWrapper");K.addItem(this._oSelectAllCheckBox);W.addItem(K);W.addItem(G);var O=[];H.forEach(function(Q){O.push({title:Q._getLabel(),key:Q.getKey(),selected:Q.getVisible()});});G.setModel(new J({items:O}));return this._oPopover;};w.prototype._getToolbar=function(){if(!this._oToolbar){this._createToolbar();}return this._oToolbar;};w.prototype._createToolbar=function(){var i=this;if(this._oToolbar){return;}this._oToolbar=new f();this._oToolbar.addContent(new T(this.getId()+"-toolbartitle",{text:this.getTitle()}));this._oToolbar.addContent(new g(this.getId()+"-toolbarspacer"));this._oToolbar.addContent(new h(this.getId()+"-toolbarbalancelabel",{wrapping:false,text:R.getText("TACCOUNT_TOTALBALANCE")+":"}).addStyleClass("sapSuiteUiCommonsAccountPanelLabel"));this._oToolbar.addContent(new h(this.getId()+"-toolbarsumtitle",{wrapping:false}).addStyleClass("sapSuiteUiCommonsAccountPanelSum"));this._oDisplaySwitcher=new j(this.getId()+"-toolbarswitcher",{selectionChange:function(E){var I=o.byId(i._oDisplaySwitcher.getSelectedItem());if(I){i.switchContent(I.getKey()===v.Table);i.fireStateChanged({state:I.getKey()});}},items:[new k({key:v.Default,tooltip:R.getText("TACCOUNT_DEFAULT"),icon:"sap-icon://screen-split-two"}),new k({key:v.Table,tooltip:R.getText("TACCOUNT_TABLE"),icon:"sap-icon://table-chart"})]});this._oToolbar.addContent(this._oDisplaySwitcher);this._oToolbar.addContent(new B(this.getId()+"-toolbarsettings",{icon:"sap-icon://action-settings",press:this.openSettings.bind(this)}));this.setHeaderToolbar(this._oToolbar);};w.prototype._getSumText=function(){var i=this.getSum();if(!i.correct){return" - ";}return r.formatCurrency(Math.abs(i.sum),i.measure)+" "+n(i.measure);};w.prototype._setTotalBalanceTitle=function(){var i=this.getSum(),x="";if(!i.correct||i.sum.isEqualTo(0)){x=R.getText("TACCOUNT_TOTALBALANCE");}else{x=i.sum.isGreaterThan(0)?R.getText("TACCOUNT_TOTALCREDIT"):R.getText("TACCOUNT_TOTALDEBIT");}this.$("toolbarbalancelabel").text(x+":");this.$("toolbarsumtitle").text(this._getSumText());};w.prototype._getAriaLabelText=function(){return"T account panel "+this.getTitle()+" "+this._getSumText();};w.prototype._recalculate=function(){this._oSum=null;this._oSum=this.getSum();this._setTotalBalanceTitle();};w.prototype._valueChanged=function(i,I){var x=this.getSum();if(x.correct){if(I){this._oSum.sum=this._oSum.sum.minus(i);}else{this._oSum.sum=this._oSum.sum.plus(i);}}this._setTotalBalanceTitle();};w.prototype.setShowOverlay=function(V){this.setProperty("showOverlay",V,true);this.$("overlay")[V?"addClass":"removeClass"]("sapSuiteUiCommonsAccountPanelOverlayVisible");};w.prototype._setInvalid=function(){if(this._oSum){this._oSum.correct=false;this._setTotalBalanceTitle();}};w.prototype.invalidate=function(){this._bRendered=false;C.prototype.invalidate.apply(this,arguments);};return w;});
