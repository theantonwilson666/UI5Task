sap.ui.define(["sap/ui/thirdparty/jquery","./library","./CalculationBuilderItem","sap/ui/core/Control","sap/ui/core/Popup","sap/ui/core/delegate/ItemNavigation","sap/m/MessageBox","sap/m/OverflowToolbar","sap/m/OverflowToolbarToggleButton","sap/m/OverflowToolbarButton","sap/m/ToolbarSpacer","sap/m/Title","sap/m/Button","sap/m/FlexBox","sap/m/HBox","sap/m/VBox","sap/m/library","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/m/StepInput","sap/m/Input","sap/m/Page","sap/m/List","sap/m/StandardListItem","sap/m/NavContainer","sap/m/SearchField","sap/m/Label","sap/m/Panel","sap/m/ResponsivePopover","sap/m/Toolbar","sap/m/MessageStrip","./CalculationBuilderValidationResult","sap/suite/ui/commons/ControlProxy","sap/ui/core/Icon","sap/ui/core/library","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable","sap/ui/thirdparty/jqueryui/jquery-ui-droppable","sap/ui/thirdparty/jqueryui/jquery-ui-selectable"],function(q,l,C,a,P,I,M,O,b,c,T,d,B,F,H,V,e,S,f,g,h,j,L,m,N,n,o,p,R,r,s,t,u,v,w){"use strict";var x=e.PlacementType;var y=e.ListType;var z=e.ListMode;var A=e.InputType;var D=e.FlexAlignItems;var E=e.FlexRendertype;var G=e.ButtonType;var J=w.TextAlign;var K=w.ValueState;var Q=l.CalculationBuilderItemType,U=l.CalculationBuilderOperatorType,W=l.CalculationBuilderComparisonOperatorType,X=l.CalculationBuilderLogicalOperatorType,Y=l.CalculationBuilderLayoutType,Z=e.FlexDirection;var $=Object.freeze({PAGE_MAIN:"-pagemain",PAGE_OPERATORS:"-pageoperators",PAGE_VARIABLE:"-pagevariable",PAGE_FUNCTIONS:"-pagefunctions",LABEL_LITERALS:"-literalInput-label",INPUT_LITERALS:"-literalInput-field"});var _=Object.freeze({OPERATORS_CATEGORY:"sap-icon://attachment-html",LITERALS_CATEGORY:"sap-icon://grid",VARIABLES_CATEGORY:"sap-icon://notes",FUNCTIONS_CATEGORY:"sap-icon://chalkboard",DELETE:"sap-icon://delete"});var a1=Object.freeze({KEY_PREVIOUS:"previous",KEY_NEXT:"next",MOUSE:"mouse"});var b1="##DEFAULT##";var c1=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var d1=a.extend("sap.suite.ui.commons.CalculationBuilderExpression",{metadata:{library:"sap.suite.ui.commons",defaultAggregation:"items",aggregations:{items:{type:"sap.suite.ui.commons.CalculationBuilderItem",multiple:true,singularName:"item",bindable:"bindable"},variables:{type:"sap.suite.ui.commons.CalculationBuilderVariable",multiple:true,singularName:"Variable"},functions:{type:"sap.suite.ui.commons.CalculationBuilderFunction",multiple:true,singularName:"Function"},operators:{type:"sap.ui.core.Item",multiple:true,singularName:"operator"},groups:{type:"sap.suite.ui.commons.CalculationBuilderGroup",multiple:true,singularName:"Group"}},events:{change:{}}},renderer:function(k,e1){k.write("<div");k.writeControlData(e1);k.addClass("sapCalculationBuilderInner");k.writeClasses(e1);k.write(">");k.write(e1._renderDelimiter(0));e1.getItems().forEach(function(f1,i){f1._iIndex=i;f1._bReadOnly=e1._bReadOnly;k.renderControl(f1);k.write(e1._renderDelimiter(i+1));},this);if(!e1._bReadOnly){k.renderControl(e1._getNewItem());}k.write("<div class=\"sapCalculationBuilderSelected\"></div>");k.write("</div>");k.write("<div id=\""+e1.getId()+"-erroricon\"  class=\"sapCalculationBuilderExpressionErrorIcon\">");k.renderControl(e1._getErrorIcon());k.write("</div>");}});d1.prototype.init=function(){this._aErrors=[];this._bAreSelectedItemsDeleting=false;this._bDragging=false;this._bIsCalculationBuilderRendering=false;};d1.prototype._renderDelimiter=function(i){var k="";k+="<div class=\"sapCalculationBuilderDelimiter sapCalculationBuilderDroppable\" index=\""+i+"\">";k+="<div class=\"sapCalculationBuilderDroppableLine\"></div>";k+="<div class=\"sapCalculationBuilderDroppableCircle\"></div>";k+="<div class=\"sapCalculationBuilderDelimiterNewButton\">";k+="<span role=\"presentation\" aria-hidden=\"true\" data-sap-ui-icon-content=\"î€¸\""+"class=\"sapUiIcon sapUiIconMirrorInRTL sapCalculationBuilderDelimiterNewButtonIcon\" style=\"font-family:'SAP-icons'\"></span>";k+="</div>";k+="</div>";return k;};d1.prototype.onBeforeRendering=function(){this._reset();this._createPopup();this.getParent()._enableOrDisableExpandAllButton();this._aErrors=this._validateSyntax();this._fireAfterValidation();this._bIsCalculationBuilderRendering=true;this._bRendered=false;};d1.prototype.onAfterRendering=function(){this._bIsCalculationBuilderRendering=false;if(!this._bReadOnly){this._setupDroppable();this._setupSelectable();this._setupNewButtonEvents();}this._setupKeyboard();this._bRendered=true;var i=this.getParent();if(i._bRendered){i._setExpression(i._oInput._itemsToString({items:this.getItems(),errors:this._aErrors}));i._oInput._displayError(this._aErrors.length!==0);}};d1.prototype.onsapfocusleave=function(){if(!this._bAreSelectedItemsDeleting){this._deselect();}};d1.prototype.onsapenter=function(i){this._handleEnter(i);};d1.prototype.onsapspace=function(i){if(q(i.target).hasClass("sapCalculationBuilderItem")){this._handleSpace(i);}};d1.prototype.onsappreviousmodifiers=function(i){if(i.ctrlKey){this._handleCtrlPrevious(i);}};d1.prototype.onsapnextmodifiers=function(i){if(i.ctrlKey){this._handleCtrlNext(i);}};d1.prototype.onsapdelete=function(i){this._handleDelete(i);};d1.prototype.exit=function(){if(this._oPopover){this._oPopover.destroy();}if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();}if(this._oErrorIcon){this._oErrorIcon.destroy();this._oErrorIcon=null;}};d1.prototype._getErrorIcon=function(){if(!this._oErrorIcon){this._oErrorIcon=new v({src:"sap-icon://message-error",useIconTooltip:false,size:"20px"});}return this._oErrorIcon;};d1.prototype._createPopup=function(){var i={footerButtons:[]};this._createPopoverLayout(i);this._createPopoverFunctionsItems(i);this._createPopoverOperatorsItems(i);this._createPopoverNavContainer(i);this._createPopover(i);};d1.prototype._reset=function(){this.getItems().forEach(function(i){i._reset();});if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}};d1.prototype._createPopoverLayout=function(i){var k=function(h1){return new B({text:h1,press:this._updateOrCreateItem.bind(this,{type:Q.Operator,key:h1})}).addStyleClass("sapUiTinyMarginEnd");}.bind(this);var e1=new H({renderType:E.Div,width:"100%"});e1.addStyleClass("sapCalculationBuilderItemPopupOperators");e1.addStyleClass("sapCalculationBuilderItemPopupOptionItem");Object.keys(U).forEach(function(h1){if(this.getParent()._isTokenAllowed(h1)){var i1=k(U[h1]);if(h1===U[","]){this._attachAriaLabelToButton(i1,c1.getText("CALCULATION_BUILDER_COMMA_ARIA_LABEL"));}else if(h1===U["-"]){this._attachAriaLabelToButton(i1,c1.getText("CALCULATION_BUILDER_MINUS_ARIA_LABEL"));}e1.addItem(i1);}}.bind(this));var f1=this._createPopoverLiteralLabelAndInput(i);var g1=new V({items:[e1,f1],alignItems:"Start"});g1.addStyleClass("sapCalculationBuilderItemPopupOperatorsAndInputWrapper");i.layout=g1.getItems().length>0?g1:null;};d1.prototype._createPopoverLiteralLabelAndInput=function(i){var k=new o({id:this.getId()+$.LABEL_LITERALS,text:c1.getText("CALCULATION_BUILDER_LITERAL_INPUT_LABEL")});var e1;if(this.getParent().getAllowStringLiterals()){e1=new h({id:this.getId()+$.INPUT_LITERALS,width:"100%",placeholder:c1.getText("CALCULATION_BUILDER_ADD_LITERAL_FIELD_PLACEHOLDER_ANY_STRING"),valueStateText:c1.getText("CALCULATION_BUILDER_ADD_LITERAL_FIELD_PLACEHOLDER_ERROR"),liveChange:function(h1){var i1=h1.getSource(),j1=h1.getParameter("value"),k1=j1.indexOf("\"")===-1;i1.setValueState(k1?K.None:K.Error);i.footerButtons.okButton.setEnabled(k1);},submit:function(h1){this._submitLiteralInput(e1);}.bind(this)});}else{e1=new g({width:"100%",placeholder:c1.getText("CALCULATION_BUILDER_ADD_LITERAL_FIELD_PLACEHOLDER"),textAlign:J.Right,valueStateText:c1.getText("CALCULATION_BUILDER_ADD_LITERAL_FIELD_ERROR_TEXT"),displayValuePrecision:3,change:function(){i.footerButtons.okButton.setEnabled(true);}});if(e1._getInput){var f1=e1._getInput();if(f1){f1.attachSubmit(function(h1){this._submitLiteralInput(e1);},this);}}}e1.addAriaLabelledBy(k);i.literalInput=e1;var g1=new V({renderType:E.Div,items:[k,e1],width:"100%"});g1.addStyleClass("sapCalculationBuilderItemPopupOptionItem");g1.addStyleClass("sapCalculationBuilderItemPopupLiteralLabelAndInput");return g1;};d1.prototype._createPopoverVariablesItems=function(i){if(!i){return[];}var k=[];i.forEach(function(f1){var g1=new m({title:f1._getLabel()});g1._calculationBuilderKey=f1.getKey();k.push(g1);},this);k=k.sort(function(o1,o2){return o1.getTitle().localeCompare(o2.getTitle());});var e1=new L({mode:z.SingleSelectMaster,selectionChange:function(f1){this._updateOrCreateItem({type:Q.Variable,key:f1.getParameter("listItem")._calculationBuilderKey});}.bind(this),items:k});this._oSearchField=new n({placeholder:c1.getText("CALCULATION_BUILDER_SEARCH_VARIABLE"),liveChange:function(f1){var g1=f1.getSource().getValue();if(g1||g1===""){e1.removeAllItems();k.forEach(function(h1){if(h1.getTitle().toLowerCase().indexOf(g1.toLowerCase())!==-1){e1.addItem(h1);}});}}});this._aVariableLists.push(e1);return[this._oSearchField,e1];};d1.prototype._createPopoverFunctionsItems=function(i){var k=this,e1=this.getParent();var f1=function(g1){return new m({title:g1.title,description:g1.description,type:y.Active,customData:[{key:"functionKey",value:g1.key}],press:g1.press});};i.functionList=new L({mode:z.SingleSelectMaster,itemPress:function(){this.getSelectedItem().firePress();}});e1._getAllFunctions().forEach(function(g1){i.functionList.addItem(f1({key:g1.key,title:g1.title,description:g1.description,press:k._updateOrCreateItem.bind(k,{key:g1.key,type:g1.type,functionObject:g1.functionObject})}));});};d1.prototype._createPopoverOperatorsItems=function(i){var k=this.getParent();var e1=function(j1,k1){var l1=[];Object.keys(j1).forEach(function(m1){var n1,o1,p1=j1[m1];if(k._isTokenAllowed(m1)){if(typeof p1==="object"){o1=p1.getText();n1=p1.getKey();}else{n1=o1=p1;}var q1=new B({text:o1,press:this._updateOrCreateItem.bind(this,{type:k1,key:n1})}).addStyleClass("sapCalculationBuilderPopoverOperatorsButton").addStyleClass("sapUiTinyMarginEnd");if(m1===W["!="]){this._attachAriaLabelToButton(q1,c1.getText("CALCULATION_BUILDER_NOT_EQUAL_ARIA_LABEL"));}l1.push(q1);}}.bind(this));return l1;}.bind(this);var f1=function(j1,k1,l1){var m1=e1(k1,l1);if(m1.length>0){return new p({content:[new o({width:"100%",text:j1}).addStyleClass("sapUiTinyMarginBottom"),m1]});}return null;};i.operatorsItems=[];if(this.getParent().getAllowComparisonOperators()){var g1=f1(c1.getText("CALCULATION_BUILDER_COMPARISON_TITLE_SELECT"),W,Q.Operator);g1&&i.operatorsItems.push(g1);}if(this.getParent().getAllowLogicalOperators()){var h1=f1(c1.getText("CALCULATION_BUILDER_LOGICAL_TITLE_SELECT"),X,Q.Operator);h1&&i.operatorsItems.push(h1);}var i1=this.getParent().getOperators();if(i1.length>0){i.operatorsItems.push(f1(c1.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),i1,Q.CustomOperator));}};d1.prototype._createPopoverNavContainer=function(i){var k=function(k1){var l1=j1.getPage(k1);j1.to(l1);};var e1=function(){var k1=new s({type:"Error",showIcon:true}).addStyleClass("sapUiTinyMarginBegin sapUiTinyMarginEnd sapUiTinyMarginTop");this._aStrips.push(k1);return k1;}.bind(this);this._aStrips=[];var f1=[];var g1=this._createPopoverVariablesItems(this._mGroups[b1]);if(g1.length>0){f1.push(new m({title:c1.getText("CALCULATION_BUILDER_VARIABLES_TITLE"),description:c1.getText("CALCULATION_BUILDER_VARIABLES_CATEGORY_DESCRIPTION"),wrapping:true,icon:_.VARIABLES_CATEGORY,press:k.bind(this,this.getId()+$.PAGE_VARIABLE),type:y.Active}));}var h1=i.functionList.getItems();if(h1.length>0){f1.push(new m({title:c1.getText("CALCULATION_BUILDER_FUNCTIONS_TITLE"),type:y.Active,description:c1.getText("CALCULATION_BUILDER_FUNCTIONS_CATEGORY_DESCRIPTION"),wrapping:true,icon:_.FUNCTIONS_CATEGORY,press:k.bind(this,this.getId()+$.PAGE_FUNCTIONS)}));}if(i.operatorsItems.length>0){f1.unshift(new m({title:c1.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),type:y.Active,description:c1.getText("CALCULATION_BUILDER_OPERATORS_CATEGORY_DESCRIPTION"),wrapping:true,icon:_.OPERATORS_CATEGORY,press:k.bind(this,this.getId()+$.PAGE_OPERATORS)}));}this.getGroups().forEach(function(k1){f1.push(new m({title:k1._getTitle(),type:y.Active,description:k1.getDescription(),icon:k1.getIcon(),press:k.bind(this,this.getId()+k1.getKey())}));}.bind(this));var i1=new j({id:this.getId()+$.PAGE_MAIN,title:c1.getText("CALCULATION_BUILDER_DIALOG_TITLE"),content:[e1(),i.layout,new F({direction:Z.Column,items:[new L({items:f1})]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop").addStyleClass("sapCalculationBuilderNavMainPage")]});i1.setFooter(this._getPageFooter(i1.getId(),i));var j1=new N({defaultTransitionName:"show",navigate:function(k1){var l1=k1.getParameters().to;l1.setFooter(this._getPageFooter(l1.getId(),i));}.bind(this),pages:[i1]});if(i.operatorsItems.length>0){j1.addPage(new j({id:this.getId()+$.PAGE_OPERATORS,content:[e1(),new F({direction:Z.Column,items:[i.operatorsItems]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:c1.getText("CALCULATION_BUILDER_OPERATORS_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+$.PAGE_MAIN)}));}if(g1.length>0){j1.addPage(new j({id:this.getId()+$.PAGE_VARIABLE,content:[e1(),new F({direction:Z.Column,items:g1}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:c1.getText("CALCULATION_BUILDER_VARIABLES_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+$.PAGE_MAIN)}));}if(h1.length>0){j1.addPage(new j({id:this.getId()+$.PAGE_FUNCTIONS,content:[e1(),new F({direction:Z.Column,items:[i.functionList]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:c1.getText("CALCULATION_BUILDER_FUNCTIONS_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+$.PAGE_MAIN)}));}this.getGroups().forEach(function(k1){var l1=new j({id:this.getId()+k1.getKey(),showNavButton:true,title:k1._getTitle(),navButtonPress:k.bind(this,this.getId()+$.PAGE_MAIN),content:e1()});var m1=k1.getCustomView();if(m1){var n1=new u();n1.setAssociation("control",m1);l1.addContent(n1);}else{l1.addContent(new F({direction:Z.Column,items:this._createPopoverVariablesItems(this._mGroups[k1.getKey()])}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop"));}j1.addPage(l1);}.bind(this));i.navContainer=j1;};d1.prototype._callFunctionFireSelection=function(k){this.getGroups().forEach(function(i){if(i.getCustomView()){i.fireSetSelection({key:k});}});};d1.prototype._clearVariableLists=function(){this._aVariableLists.forEach(function(i){var k=i.getSelectedItem();if(k){i.setSelectedItem(k,false);}});this._callFunctionFireSelection();};d1.prototype._setVariableListSelection=function(e1){for(var i=0;i<this._aVariableLists.length;i++){var f1=this._aVariableLists[i],g1=this._aVariableLists[i].getItems();for(var k=0;k<g1.length;k++){if(g1[k]._calculationBuilderKey===e1){f1.setSelectedItem(g1[k],true);return;}}}this._callFunctionFireSelection(e1);};d1.prototype._sanitizeStringLiteral=function(i){if(this.getParent()._isStringLiteral(i)){i=i.substring(1,i.length-1);}return i;};d1.prototype._clearSearchField=function(){if(this._oSearchField){this._oSearchField.setValue("");this._oSearchField.fireLiveChange();}};d1.prototype._createPopover=function(k){var e1=function(){var f1=this._oCurrentItem,g1=k.navContainer.getCurrentPage().getId(),h1=k.functionList.getSelectedItem(),i1,j1,k1;var l1=this.getParent().getAllowStringLiterals()?"":0;k.literalInput.setValue(l1);this._clearVariableLists();this._clearSearchField();if(h1){k.functionList.setSelectedItem(h1,false);}if(!f1){i1=this.getId()+$.PAGE_MAIN;}else{if(f1._isFunction()){k1=f1.getKey();i1=this.getId()+$.PAGE_FUNCTIONS;j1=k.functionList.getItems();for(var i=0;i<j1.length;i++){var m1=j1[i].data("functionKey");if((m1&&m1.toLowerCase())===k1.toLowerCase()){k.functionList.setSelectedItem(j1[i],true);break;}}}else if(f1._isLiteral()){var n1=this._sanitizeStringLiteral(f1.getKey());k.literalInput.setValue(n1);k.literalInput.setValueState(K.None);i1=this.getId()+$.PAGE_MAIN;}else if(f1._isVariable()){this._setVariableListSelection(f1.getKey());var o1=f1._oVariable||f1.getVariable(),p1=(o1&&o1.getGroup())||$.PAGE_VARIABLE;i1=this.getId()+p1;}else if(f1._isSecondaryOperator()){i1=this.getId()+$.PAGE_OPERATORS;}else{i1=this.getId()+$.PAGE_MAIN;}}if(i1!==g1){if(i1!==this.getId()+$.PAGE_MAIN){k.navContainer.backToPage(this.getId()+$.PAGE_MAIN);}k.navContainer.to(k.navContainer.getPage(i1),"show");}else{k.navContainer.getCurrentPage().setFooter(this._getPageFooter(g1,k));}var q1=this._oCurrentItem&&this._oCurrentItem._getItemError(),r1=q1&&(" "+q1.title);this._aStrips.forEach(function(s1){s1.setVisible(!!q1);s1.setText(r1?c1.getText("CALCULATION_BUILDER_INCORRECT_SYNTAX")+r1:"");});}.bind(this);this._oPopover=new R({showHeader:false,resizable:true,placement:x.PreferredBottomOrFlip,contentWidth:"400px",contentHeight:"450px",content:[k.navContainer],beforeOpen:e1,afterClose:function(){this._bDragging=false;this._clearNewButtonPositions();}.bind(this)});};d1.prototype._submitLiteralInput=function(i){var k=i.getValue();if(this.getParent()&&this.getParent().getAllowStringLiterals()&&!q.isNumeric(k)){k="\""+k+"\"";}this._updateOrCreateItem({type:Q.Literal,key:k});i.setValueState(K.None);};d1.prototype._getPageFooter=function(i,k){var e1=false,f1=false,g1=false;if(this._oCurrentItem&&!this._oCurrentItem._bIsNew){f1=true;g1=this._oCurrentItem._isLiteral();}e1=k.literalInput.getValueState()===K.None&&i===this.getId()+$.PAGE_MAIN&&g1;k.footerButtons.okButton=new B({enabled:e1,text:c1.getText("CALCULATION_BUILDER_CONFIRM_BUTTON"),press:function(h1){this._submitLiteralInput(k.literalInput);}.bind(this)});k.footerButtons.deleteButton=new B({enabled:f1,text:c1.getText("CALCULATION_BUILDER_DELETE_BUTTON"),press:this._deleteItem.bind(this)});k.footerButtons.closeButton=new B({text:c1.getText("CALCULATION_BUILDER_CLOSE_BUTTON"),press:this._instantClose.bind(this)});return new r({content:[new T(),k.footerButtons.okButton,k.footerButtons.deleteButton,k.footerButtons.closeButton]});};d1.prototype._insertFunctionItems=function(i,k){var e1=function(f1){i.push(f1);};if(k&&k.length>0){k.forEach(function(f1){e1(f1);});}else{e1("");}e1(")");};d1.prototype._updateOrCreateItem=function(k){var e1=!this._oCurrentItem||this._oCurrentItem._bIsNew,f1=this._oCurrentItem&&!this._oCurrentItem.getKey(),g1=this.getParent(),h1=k.functionObject,i1=this.getItems();var j1=function(){var i1=k.type===Q.Function?h1.template:g1._convertToTemplate(h1.getItems());this._insertFunctionItems(m1,i1);}.bind(this);var k1=function(){var i=isNaN(this._iCurrentIndex)?this.getItems().length:this._iCurrentIndex,n1=this._getKeys();this._smartRender(n1.slice(0,i).concat(m1,n1.slice(i)));}.bind(this);var l1=function(){for(var i=0;i<i1.length;i++){if(i1[i]===this._oCurrentItem){return i+1;}}return null;}.bind(this);if(e1){var m1=[k.key];if(h1){j1();}k1();}else{this._oCurrentItem.setKey(k.key);if(k.type){this._oCurrentItem._sType=k.type;}if(f1&&h1){var m1=[];this._iCurrentIndex=l1();j1();k1();}}this._instantClose();this._fireChange();};d1.prototype._expandAllVariables=function(){this.getItems().forEach(function(i){if(i.isExpandable()){i._expandVariable(false);}});this._fireChange();};d1.prototype._handleDelete=function(i){if(this._isEmptySelected()){return;}this._bAreSelectedItemsDeleting=true;M.show(c1.getText("CALCULATION_BUILDER_DELETE_MESSAGE_TEXT"),{icon:M.Icon.WARNING,title:c1.getText("CALCULATION_BUILDER_DELETE_MESSAGE_TITLE"),actions:[M.Action.YES,M.Action.CANCEL],onClose:function(k){if(k===M.Action.YES){var e1=this.$().find(".sapCalculationBuilderSelected .sapCalculationBuilderItem"),f1=e1.length,g1=e1.first(),h1=sap.ui.getCore().byId(g1.attr("id"));if(h1){var i1=this._getKeys();i1.splice(h1._iIndex,f1);this._smartRender(i1);this._fireChange();}}this._bAreSelectedItemsDeleting=false;}.bind(this)});};d1.prototype._handleEnter=function(i){var k=q(i.target),e1;if(this._oItemNavigation&&!this._bReadOnly){if(k.hasClass("sapCalculationBuilderNewItem")){e1=this._getNewItem();if(e1){e1._buttonPress(i);}}else if(k.hasClass("sapCalculationBuilderItem")){e1=this._getItemById(k[0].id);if(e1){e1._buttonPress(i);}}else if(k.hasClass("sapCalculationBuilderItemExpandButton")){e1=this._getItemById(k.closest(".sapCalculationBuilderItem")[0].id);if(e1){e1._expandButtonPress(i);}}}};d1.prototype._createVariablesMap=function(){this._mGroups={};this._aVariableLists=[];this.getVariables().forEach(function(i){var k=i.getGroup()||b1;if(!this._mGroups[k]){this._mGroups[k]=[];}this._mGroups[k].push(i);}.bind(this));};d1.prototype._handleSpace=function(i){this._selectItem(i.target);};d1.prototype._handleCtrlNext=function(i){this._moveItems(a1.KEY_NEXT);};d1.prototype._handleCtrlPrevious=function(i){this._moveItems(a1.KEY_PREVIOUS);};d1.prototype._getVariableByKey=function(k){var e1=this.getVariables();if(!k){return null;}k=k.toLowerCase();for(var i=0;i<e1.length;i++){if(e1[i].getKey().toLowerCase()===k){return e1[i];}}return null;};d1.prototype.setTitle=function(i){var k=this._oToolbarTitle;if(k){k.setText(i);k.setVisible(!!i);}this.setProperty("title",i);};d1.prototype._getKeys=function(){return this.getItems().map(function(i){return i.getKey();});};d1.prototype._deleteItem=function(){var k=this._getKeys();k.splice(this._oCurrentItem._iIndex,1);this._smartRender(k);this._instantClose();this._fireChange();};d1.prototype._openDialog=function(i){this._oCurrentItem=i.currentItem;this._iCurrentIndex=i.index;this._oPopover.openBy(i.opener);};d1.prototype._setupDroppable=function(i){var k=this;i=i||this.$().find(".sapCalculationBuilderDroppable");i.droppable({scope:k.getId()+"-scope",tolerance:"pointer",activeClass:"sapCalculationBuilderDroppableActive",hoverClass:"sapCalculationBuilderDroppableActive",drop:function(e1,ui){if(!ui.draggable.hasClass("sapCalculationBuilderSelected")){k._selectItem(ui.draggable[0]);}k._moveItems(a1.MOUSE,parseInt(q(this).attr("index"),10));k._bDragging=false;},over:function(e1,ui){k._bDragging=true;}});};d1.prototype._clearNewButtonPositions=function(){var i=this.$();i.find(".sapCalculationBuilderDelimiterNewButton").hide(200);i.find(".sapCalculationBuilderItem").animate({"left":0},300);};d1.prototype._setupNewButtonEvents=function(){var i=13,k=300;var e1=this.$().find(".sapCalculationBuilderDelimiter[data-events!='bound']"),f1=this.$().find(".sapCalculationBuilderDelimiterNewButton[data-events!='bound']"),g1=this,h1,i1;var j1=function(k1,l1){k1.prev().animate({"left":-l1},k);k1.next().animate({"left":l1},k);};f1.click(function(ev){var k1=q(this),l1=parseInt(k1.parent().attr("index"),10);k1.css("opacity",1);g1._oCurrentItem=null;g1._iCurrentIndex=l1;g1._openDialog({opener:this,index:l1});});f1.attr("data-events","bound");e1.mouseover(function(ev){var k1=q(this);if(!g1._bDragging&&!g1._oPopover.isOpen()){h1=true;i1=setTimeout(function(){if(h1){h1=false;j1(k1,i);k1.find(".sapCalculationBuilderDelimiterNewButton").show(200);}},400);}});e1.mouseout(function(ev){var k1=q(this).find(".sapCalculationBuilderDelimiterNewButton"),l1=q(this);if(ev.target===k1[0]&&ev.relatedTarget===l1[0]){return;}h1=false;clearTimeout(i1);if(g1._bDragging||g1._oPopover.isOpen()){return;}if(!k1.is(':hover')){j1(l1,0);k1.hide(200);}});e1.attr("data-events","bound");};d1.prototype._setupSelectable=function(){this.$().selectable({cancel:".sapCalculationBuilderCancelSelectable",distance:5,start:function(){this._deselect();this._instantClose();}.bind(this),stop:function(){this._selectItems(this.$().find(".sapCalculationBuilderItem.ui-selected"));}.bind(this)});};d1.prototype._selectItemsTo=function(i){var k=q(i.next(".sapCalculationBuilderDelimiter")[0]),e1=k.attr("index")-1,f1=this.$(),g1,h1,i1,j1,k1;if(i.parent().hasClass("sapCalculationBuilderSelected")||this._isEmptySelected()){this._selectItem(i);return;}if(e1>this._iLastSelectedIndex){g1=this._iFirstSelectedIndex;h1=e1+1;}else{g1=e1;h1=this._iLastSelectedIndex+1;}this._deselect();j1=f1.find(".sapCalculationBuilderDelimiter[index=\""+g1+"\"]");k1=f1.find(".sapCalculationBuilderDelimiter[index=\""+h1+"\"]");i1=j1.nextUntil(k1,".sapCalculationBuilderItem");this._selectItems(i1);};d1.prototype._selectItems=function(k){for(var i=0;i<k.length;i++){this._selectItem(k[i]);}};d1.prototype._selectItem=function(i){var k=this.$().find(".sapCalculationBuilderSelected"),e1=q(i),f1=q(e1.next(".sapCalculationBuilderDelimiter")[0]),g1=k[0].children.length,h1=f1.attr("index")-1,i1=true;if(!this._oItemNavigation||!this._getItemById(e1[0].id)||this._bReadOnly){return;}if(g1===0){this._iFirstSelectedIndex=h1;this._iLastSelectedIndex=h1;}else{if(e1.parent().hasClass("sapCalculationBuilderSelected")){if(this._iFirstSelectedIndex===h1){this._iFirstSelectedIndex++;this._deselectItem(e1,false);}else if(this._iLastSelectedIndex===h1){this._iLastSelectedIndex--;this._deselectItem(e1,true);}else{this._deselect();}this._setCorrectFocus();return;}if((this._iFirstSelectedIndex-h1)===1){this._iFirstSelectedIndex=h1;i1=false;}else if((h1-this._iLastSelectedIndex)===1){this._iLastSelectedIndex=h1;i1=true;}else{this._iFirstSelectedIndex=h1;this._iLastSelectedIndex=h1;this._deselect();}}var j1=this.$();if(this._isEmptySelected()){k.detach().insertBefore(e1);k.draggable({revert:"invalid",cursor:"move",axis:"x",scope:this.getId()+"-scope",helper:function(k1){var l1=k.clone();l1.removeClass("sapCalculationBuilderSelected");l1.addClass("sapCalculationBuilderDraggingSelectedClone");return l1;},start:function(){k.addClass("sapCalculationBuilderDragging");j1.find(".sapCalculationBuilderItemContent").css("cursor","move");},stop:function(){k.removeClass("sapCalculationBuilderDragging");j1.find(".sapCalculationBuilderItemContent").css("cursor","pointer");}});}if(i1){e1.detach().appendTo(k);f1.detach().appendTo(k);}else{f1.detach().prependTo(k);e1.detach().prependTo(k);}if(e1.hasClass("sapCalculationBuilderItem")){e1.draggable("disable");e1.addClass("ui-selected");}this._setCorrectFocus();};d1.prototype._isEmptySelected=function(){var i=this.$().find(".sapCalculationBuilderSelected");if(i){return i.is(":empty");}return true;};d1.prototype._deselectItem=function(i,k){var e1=this.$().find(".sapCalculationBuilderSelected"),f1=q(i.next(".sapCalculationBuilderDelimiter")[0]);if(!i.hasClass("ui-selected")){return;}if(k){f1.detach().insertAfter(e1);i.detach().insertAfter(e1);}else{i.detach().insertBefore(e1);f1.detach().insertBefore(e1);}i.draggable("enable");i.removeClass("ui-selected");};d1.prototype._deselect=function(){var i=this.$().find(".sapCalculationBuilderSelected");if(this._isEmptySelected()){return;}this.$().find(".sapCalculationBuilderSelected .ui-selected").removeClass("ui-selected");i.children().each(function(){var k=q(this);if(k.hasClass("sapCalculationBuilderItem")){k.draggable("enable");}k.detach().insertBefore(i);});};d1.prototype._setupKeyboard=function(){var i=this.getDomRef(),k=[];this.getItems().forEach(function(e1){k.push(e1.getFocusDomRef());if(e1.isExpandable()){k.push(e1.$("expandbutton"));}});k.push(this._getNewItem().getFocusDomRef());if(!this._oItemNavigation){this._oItemNavigation=new I();this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(i);this._oItemNavigation.setItemDomRefs(k);this._oItemNavigation.setCycling(true);this._oItemNavigation.setPageSize(250);};d1.prototype._setCorrectFocus=function(){q(this._oItemNavigation.getFocusedDomRef()).focus();};d1.prototype._getItemById=function(i){return this.getItems().filter(function(k){return k.getId()===i;})[0];};d1.prototype._getNewItem=function(){if(!this._oNewItem){this._oNewItem=new C();this._oNewItem._bIsNew=true;this._oNewItem.setParent(this,null,true);}return this._oNewItem;};d1.prototype._instantClose=function(){var i=this._oPopover.getAggregation("_popup");if(i&&i.oPopup&&i.oPopup.close){i.oPopup.close(0);this._setCorrectFocus();}};d1.prototype._attachAriaLabelToButton=function(i,k){i.addEventDelegate({onAfterRendering:function(e1){e1.srcControl.$("content").attr("aria-label",k);}});};d1.prototype._printErrors=function(){this.getItems().forEach(function(i){var k=i._getItemError(),e1=i.$(),f1=!!k?"addClass":"removeClass";e1[f1]("sapCalculationBuilderItemErrorSyntax");});if(this.getParent().getLayoutType()===Y.VisualOnly){this._showErrorIcon();}};d1.prototype._validateSyntax=function(k){var e1=function(){var D1=this.getItems()[t1],E1=D1.getKey();return!D1._isOperator()||E1==="("||E1==="+"||E1==="-"||E1.toLowerCase()==="not";}.bind(this);var f1=function(){var n1=this.getItems(),D1=n1[u1-1];return!D1._isOperator()||D1.getKey()===")";}.bind(this);var g1=function(q1){var D1=q1.getKey().toLowerCase();if(q1._isOperator()){return D1==="not"||D1==="("||D1===")"?D1:"#op#";}return q1._isFunction()?"#fun#":"#col#";};var h1=function(q1){return{index:i,item:q1,items:[],text:q1.getKey()+(q1._isFunction()?"(":"")};};var i1=function(z1){var D1=1,E1=i;i++;for(;i<n1.length;i++){var q1=n1[i],F1=q1.getKey(),G1=h1(q1);z1.items.push(G1);switch(F1){case")":D1--;break;case"(":D1++;break;case",":D1=1;break;}if(q1._isFunction()){i1(G1);z1.text+=G1.text;}else{z1.text+=F1;}if(D1===0){return z1;}}x1.push({index:E1,title:c1.getText("CALCULATION_BUILDER_CLOSING_BRACKET_ERROR_TEXT")});return z1;};var j1=function(z1){var D1=this.getParent()._getFunctionAllowParametersCount(z1.item.getKey()),E1=[],F1=[];z1.items.forEach(function(q1){if(q1.item._isComma()){E1.push(F1);F1=[];}else{F1.push(q1);}});if(F1.length>0&&F1[F1.length-1].text===")"){F1.pop();}E1.push(F1);if(E1.length!==D1){x1.push({index:z1.index,title:c1.getText(E1.length<D1?"CALCULATION_BUILDER_TOO_LITTLE_PARAMETERS":"CALCULATION_BUILDER_TOO_MANY_PARAMETERS")});}if(E1.length>0){E1.forEach(function(G1){if(G1.length>0){q.merge(x1,this._validateSyntax({from:G1[0].index,to:G1[G1.length-1].index+1}));}else{x1.push({index:z1.index,title:c1.getText("CALCULATION_BUILDER_EMPTY_PARAMETER")});}}.bind(this));}}.bind(this);var k1=0;var l1=function(){var D1=q1.getKey()==="+"||q1.getKey()==="-";if(D1){k1++;if(k1>2){x1.push({index:i,title:c1.getText("CALCULATION_BUILDER_SYNTAX_ERROR_TEXT")});}}else{k1=0;}};var m1={"#op#":["(","#col#","#fun#","not","+","-"],"(":["(","+","-","#col#","#fun#","not"],")":["#op#",")"],"#col#":["#op#",")"],"#fun#":["(","+","-","#col#","#fun#"],"not":["#col#","#fun#","not","("]};k=k||{};var n1=k.items||this.getItems(),o1,p1,q1,r1,s1,t1=k.from||0,u1=k.to||n1.length,v1=(t1===0&&u1===n1.length),w1=[],x1=[];if(n1.length>0){if(!e1()){x1.push({index:t1,title:c1.getText("CALCULATION_BUILDER_FIRST_CHAR_ERROR_TEXT")});}if(!f1()){x1.push({index:u1-1,title:c1.getText("CALCULATION_BUILDER_LAST_CHAR_ERROR_TEXT")});}}for(var i=t1;i<u1;i++){q1=n1[i];if(q1._getType()===Q.Error){x1.push({index:i,title:c1.getText("CALCULATION_BUILDER_SYNTAX_ERROR_TEXT")});continue;}l1();if(!k.skipCustomValidation&&q1._isFunction()){var y1=q1._getCustomFunction(),z1=i1(h1(q1));if(y1&&!y1.getUseDefaultValidation()){var A1=new t();this.getParent().fireValidateFunction({definition:z1,customFunction:y1,result:A1});q.merge(x1,A1.getErrors());}else{j1(z1);}}if(i<u1-1){r1=n1[i+1];o1=g1(n1[i]);p1=g1(r1);s1=r1?r1.getKey().toLowerCase():"";var B1=r1._isCustomOperator()||q1._isCustomOperator();if(m1[o1].indexOf(p1)===-1&&m1[o1].indexOf(s1)===-1&&!B1){var C1={index:i+1};if(q1._isOperator()&&r1._isOperator()){C1.title=c1.getText("CALCULATION_BUILDER_BEFORE_OPERATOR_ERROR_TEXT",r1.getKey());}else if(!q1._isOperator()&&!r1._isOperator()){C1.title=c1.getText("CALCULATION_BUILDER_BETWEEN_NOT_OPERATORS_ERROR_TEXT",[q1.getKey(),r1.getKey()]);}else if(q1.getKey()===")"&&!r1._isOperator()){C1.title=c1.getText("CALCULATION_BUILDER_AFTER_CLOSING_BRACKET_ERROR_TEXT");}else if(!q1._isOperator()&&(r1.getKey()==="(")){C1.title=c1.getText("CALCULATION_BUILDER_BEFORE_OPENING_BRACKET_ERROR_TEXT");}else{C1.title=c1.getText("CALCULATION_BUILDER_CHAR_ERROR_TEXT");}x1.push(C1);}}if(q1._isFunction()){continue;}if(v1&&q1.getKey()===","){x1.push({index:i,title:c1.getText("CALCULATION_BUILDER_WRONG_PARAMETER_MARK")});}if((q1._isOperator()&&q1.getKey()==="(")||q1._isFunction()){w1.push(i);}if(q1._isOperator()&&q1.getKey()===")"){if(w1.length===0){x1.push({index:i,title:c1.getText("CALCULATION_BUILDER_OPENING_BRACKET_ERROR_TEXT")});}else{w1.pop();}}}for(i=0;i<w1.length;i++){x1.push({index:w1[i],title:c1.getText("CALCULATION_BUILDER_CLOSING_BRACKET_ERROR_TEXT")});}return x1;};d1.prototype._getType=function(k){return this.getParent()&&this.getParent()._getType(k);};d1.prototype._moveItems=function(k,e1){var f1=[],g1=this.$(),h1=this.getItems(),i1=g1.find(".sapCalculationBuilderSelected"),j1,k1,l1,m1;if(this._isEmptySelected()){return;}m1=(i1.length>1)?q(i1[0]).children():i1.children();if(k===a1.KEY_PREVIOUS){k1=this._iFirstSelectedIndex-1;}else if(k===a1.KEY_NEXT){k1=this._iLastSelectedIndex+2;}else if(k===a1.MOUSE){k1=e1;}if(k1<0||k1===(h1.length+1)){return;}j1=this.$().find(".sapCalculationBuilderDelimiter[index=\""+k1+"\"]");for(var i=0;i<h1.length+1;i++){l1=h1[i];if(k1===i){m1.each(function(){var g1=q(this),l1;if(g1.hasClass("sapCalculationBuilderItem")){l1=sap.ui.getCore().byId(q(this)[0].id);f1.push(l1);l1._bMovingItem=true;g1.draggable("enable");}g1.css("left",0);g1.detach().insertAfter(j1).removeClass("");j1=g1;});}if(l1&&!l1.$().parent().hasClass("sapCalculationBuilderSelected")&&!l1._bMovingItem){f1.push(l1);}}i1.css("left","");g1.find(".sapCalculationBuilderDelimiter").each(function(i){q(this).attr("index",i);});this.removeAllAggregation("items",true);f1.forEach(function(l1,i){l1._bMovingItem=false;l1._iIndex=i;this.addAggregation("items",l1,true);}.bind(this));this._setupKeyboard();this._selectItems(m1.filter(function(i,el){return q(el).hasClass("sapCalculationBuilderItem");}));this._fireChange();};d1.prototype._fireAfterValidation=function(){this.getParent().fireAfterValidation();};d1.prototype._setItems=function(i){this.removeAllAggregation("items",true);(i||[]).forEach(function(k){this.addAggregation("items",this._convertFromNewItem(k),true);}.bind(this));};d1.prototype._getKeyFromCreatedItem=function(i){return typeof i==="object"?i.getKey():i;};d1.prototype._convertFromNewItem=function(i){return typeof i==="object"?i:new C({key:i});};d1.prototype._showErrorIcon=function(){var i=this.$("erroricon"),k=this.getParent(),e1=k._createErrorText(null,true);if(e1){i.show();i.attr("title",k._createErrorText(null,true));}else{i.hide();}};d1.prototype._smartRender=function(k){var e1="",f1=this.$(),g1=[],h1=this.getItems(),i1=h1.length;var j1=function(l1){l1=this._convertFromNewItem(l1);this.addAggregation("items",l1,true);l1._iIndex=i;if(f1[0]){e1+=l1._render();e1+=this._renderDelimiter(i+1);}l1.bOutput=true;g1.push(l1);}.bind(this);if(!this.getParent()._isExpressionVisible()){this._setItems(k);return;}this._bRendered=false;this._bIsCalculationBuilderRendering=true;this._deselect();for(var i=0;i<k.length;i++){var k1=h1[i],l1=k[i],m1=typeof l1==="object"&&l1.getKey?l1.getKey():l1,n1=l1._sType?l1._sType:"";if(!k1){j1(k[i]);}else if(k1.getKey()!==m1||k1._sType!==n1){k1.setKey(m1,true);k1._sType=n1;var o1=k1.$();o1[0].innerHTML=k1._innerRender();o1.attr("class",k1._getClass());o1.attr("title",k1._getTooltip());k1._setEvents();}}if(k.length<i1){for(var i=k.length;i<h1.length;i++){var o1=h1[i].$();o1.next().remove();o1.remove();this.removeAggregation("items",h1[i],true);}}if(f1[0]&&g1.length>0){f1.find(".sapCalculationBuilderDelimiter").last().after(e1);g1.forEach(function(k1){k1._afterRendering();});this._setupDroppable(f1.find(".sapCalculationBuilderDroppable").filter(function(){return parseInt(q(this).attr("index"),10)>i1;}));}this._bRendered=true;this._setupKeyboard();this._setupNewButtonEvents();this._bIsCalculationBuilderRendering=false;};d1.prototype._fireChange=function(){this.fireEvent("change");};return d1;});
