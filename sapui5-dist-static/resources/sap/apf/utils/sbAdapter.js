sap.ui.define(["sap/apf/abap/LrepConnector","sap/base/Log","sap/ui/thirdparty/datajs"],function(L,a){'use strict';var s={semanticObject:"FioriApplication",action:"executeAPFConfiguration"};var b={semanticObject:"FioriApplication",action:"editAPFConfiguration"};var c={semanticObject:"FioriApplication",action:"executeAPFConfigurationS4HANA"};var d={semanticObject:"FioriApplication",action:"editAPFConfigurationS4HANA"};var h="/sap/hba/r/apf/core/odata/modeler/AnalyticalConfiguration.xsodata/AnalyticalConfigurationQueryResults";var C=undefined;var e={};e._hanaConfigurations=undefined;e._lrepConfigurations=undefined;e.getConfigurations=function(p,q){var t=jQuery.Deferred();var u=[];jQuery.when(f(),r()).then(function(v,w){u=w.concat(v);var x=o(p,q);if(x&&!n(x,s)&&!n(x,c)){u.forEach(function(y){y.runtimeIntent=x;});}t.resolve(u);});return t.promise();};e.getTargetMappingInstaceIDsWithConfigurations=function(p,q,u,w){var x=jQuery.Deferred();var y=[];var z=[];jQuery.when(f(),r()).then(function(t,v){i(u,w).then(function(B){return A(1000).then(function(){y=v.concat(t);var D=o(p,q);B.forEach(function(E){if(E.semanticParameters["sap-apf-configuration-id"]){var F=E.semanticParameters["sap-apf-configuration-id"].defaultValue;y.forEach(function(G){if(F.value===G.id){G.targetMappingInstanceId=E;if(D&&!n(D,s)&&!n(D,c)){G.runtimeIntent=D;}z.push(G);}});}});x.resolve(z);});});});return x.promise();function A(t,v){return new Promise(function(B){setTimeout(B.bind(null,v),t)});}};e.getConfigurationNameById=function(p){var q=jQuery.Deferred();if(!p){return q.resolve("");}if(p.indexOf(".")>-1){f().done(t);}else{r().done(t);}return q.promise();function t(u){u.forEach(function(v){if(v.id===p){q.resolve(v.title);}});if(q.state!=="resolved"){q.resolve("");}}};function r(){var p=jQuery.Deferred();if(!e._hanaConfigurations){var q={requestUri:h+"?$select=AnalyticalConfiguration,AnalyticalConfigurationName,Application",async:true,method:"GET"};OData.request(q,t,u);}else{p.resolve(jQuery.extend(true,[],e._hanaConfigurations));}return p.promise();function t(v){var w=[];v.results.forEach(function(x){w.push({title:x.AnalyticalConfigurationName,id:x.AnalyticalConfiguration,runtimeIntent:s,modelerIntent:b,configurationId:x.AnalyticalConfiguration,applicationId:x.Application});});e._hanaConfigurations=jQuery.extend(true,[],w);p.resolve(w);}function u(){e._hanaConfigurations=[];p.resolve([]);}}function f(){var p=jQuery.Deferred();if(!e._lrepConfigurations){j().then(function(q){var t=[];q.response.forEach(function(u){var v;var w;if(u.fileType&&u.fileType==="apfconfiguration"){v=l(u);w=u.name;t.push({title:m(u,'apfdt-configname'),id:v+"."+w,runtimeIntent:c,modelerIntent:d,configurationId:w,applicationId:v});}});e._lrepConfigurations=jQuery.extend(true,[],t);p.resolve(t);},function(){p.resolve([]);e._lrepConfigurations=[];});}else{p.resolve(jQuery.extend(true,[],e._lrepConfigurations));}return p.promise();}function g(p){var P;if(sap.ushell.Container&&sap.ushell.Container.getService){if(p=="S")P=sap.ushell.Container.getService("PageBuilding","CONF").getFactory();else if(p=="C")P=sap.ushell.Container.getService("PageBuilding","CUST").getFactory();else P=sap.ushell.Container.getService("PageBuilding","PERS").getFactory();return P;}}function i(p,q){var D=jQuery.Deferred();var t=q;var T=[];var P=g(p);var u=P.getPageBuildingService();u.readCatalog(t,jQuery.proxy(function(v){if(v&&v.Chips&&v.Chips.results instanceof Array){jQuery.each(v.Chips.results,jQuery.proxy(function(w,x){try{if(x&&x.baseChipId==="X-SAP-UI2-CHIP:/UI2/ACTION"){C=x;var y=JSON.parse(C.configuration);var z=JSON.parse(y.tileConfiguration);var A=z.ui5_component;var S="smartbusiness";var B="sap.apf";if(A&&A.indexOf(S)===-1){k(A).then(function(F){jQuery.each(F.response.results,jQuery.proxy(function(G,H){if(H&&H["sap.ui5/dependencies/libs"]){if(H["sap.ui5/dependencies/libs"].indexOf(B)!==-1){var I;var y=JSON.parse(C.configuration);var z=JSON.parse(y.tileConfiguration);var J=z.signature&&z.signature.parameters;if(C.ChipBags&&C.ChipBags.results instanceof Array){jQuery.each(C.ChipBags.results,jQuery.proxy(function(K,M){if(M&&M.id==="tileProperties"){if(M.ChipProperties&&M.ChipProperties.results instanceof Array){jQuery.each(M.ChipProperties.results,jQuery.proxy(function(N,O){if(O&&O.name==="display_title_text"){I=O.value;return false;}},this));}else{a.error("sbAdapter/getTargetMappingInstanceIDsFromCatalogID","Unable to read the properties inside the chip bag 'tileProperties' for "+C.catalogPageChipInstanceId);}return false;}},this));}else{a.error("sbAdapter/getTargetMappingInstanceIDsFromCatalogID","Unable to read the chip bags for "+C.catalogPageChipInstanceId);}T.push({instanceID:C.catalogPageChipInstanceId||"",title:I||"",semanticObject:z.semantic_object||"",semanticAction:z.semantic_action||"",ui5Component:z.ui5_component||"",semanticParameters:J||{}});window.TargetMapping=T;}}},this));},function(){D.resolve([]);});}}}catch(E){a.error("sbAdapter/getTargetMappingInstanceIDsFromCatalogID",E&&E.message);}},this));D.resolve(T);}else{a.error("sbAdapter/getTargetMappingInstanceIDsFromCatalogID","Invalid catalog object");D.reject();}},this),jQuery.proxy(function(R,v){D.reject(v);},this));return D.promise();}function j(){var p=L.createConnector();var O={async:true,contentType:'application/json'};var P=[];P.push({name:"deep-read",value:true});P.push({name:"metadata",value:true});P.push({name:"layer",value:"CUSTOMER"});var R="/sap/bc/lrep/content/sap/apf/dt/";R+=p._buildParams(P);return p.send(R,'GET',{},O);}function k(u){var p=L.createConnector();var O={async:true,contentType:'application/json'};var P=[];P.push({name:"sap.app/id",value:u});P.push({name:"fields",value:"sap.ui5/dependencies/libs"});var R="/sap/bc/ui2/app_index";R+=p._buildParams(P);return p.send(R,'GET',{},O);}function l(p){var q=p.ns.split('/');return q[q.length-2];}function m(p,q){var v;p.metadata.forEach(function(t){if(t.name===q){v=t.value;}});return v;}function n(p,q){if(p.semanticObject===q.semanticObject&&p.action===q.action){return true;}return false;}function o(p,q){if(p&&q){return{semanticObject:p,action:q};}}return e;},true);
