/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2019 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils",'sap/apf/ui/utils/wrappedChartWithCornerTexts','sap/apf/utils/trace','sap/base/Log'],function(U,W,t,L){'use strict';var a=0;var l=" ************************************** ";var b=" -------------------------------------- ";function c(f,n,h,s,i){if(jQuery.sap.log.apfTrace===undefined){return;}var j=g(f,n,h,s,i);t.log("Carousel."+n,j);}function r(f){var h="";f.forEach(function(i,j){var k=i.oChart;if(k){h+="'"+k.sId+"',";}else{h+="'"+k+"',";}});h=(f.length===0)?"[]":"["+h.slice(0,h.length-1)+"]";return h;}function d(f){var h="";var i=f.getView().getCustomItemList();i.forEach(function(j,k){h+="'"+j.sId+"',";});h=(i.length===0)?"[]":"["+h.slice(0,h.length-1)+"]";return h;}function e(f){return", relation="+r(f._relateChartsToItems)+" // "+d(f)+" #path="+f.oCoreApi.getSteps().length;}function g(f,n,h,s,i){i=i||"";var j="";var k="-";var R;var m="-";if(s){R=s.getSelectedRepresentation();m=R.type;}var o="";if(h===-1){return j+i;}o+=": inx="+h;o+=k==="-"||k===false?"":", is iconic";o+=m==="-"?"":", repr.type="+m;o+=e(f);o+=i===""?"":"\n --- "+i+"---";return j+o;}var C=sap.ui.controller("sap.apf.ui.reuse.controller.carousel",{cloneCnt:0,paddingLeft:10,paddingRight:10,paddingBottom:15,paddingTop:15,_relateChartsToItems:[],onAfterRendering:function(){},onInit:function(){if(sap.ui.Device.system.desktop){this.getView().addStyleClass("sapUiSizeCompact");}var v=this.getView().getViewData().oInject;this.oCoreApi=v.oCoreApi;this.oUiApi=v.uiApi;this._relateChartsToItems=[];},showStepGallery:function(){this.getView().getStepGallery().getController().openHierarchicalSelectDialog();},onBeforeRendering:function(){if(!sap.ui.Device.system.desktop){this.oUiApi.getLayoutView().getController().showMasterFooter(this.getView().addStepButton,this.getView().moveUpButton,this.getView().moveDownButton);}else{this.oUiApi.getLayoutView().getController().addMasterFooterContentLeft(this.getView().addStepButton);this.oUiApi.getLayoutView().getController().addMasterFooterContentLeft(this.getView().moveUpButton);this.oUiApi.getLayoutView().getController().addMasterFooterContentLeft(this.getView().moveDownButton);}},getStepData:function(s){var S={};S.index=this.oCoreApi.getSteps().indexOf(s);S.title=this.oCoreApi.getTextNotHtmlEncoded(s.title);S.oStepTexts=this.getTextsForCustomListItem(s);return S;},update1CustomItemChartWhenChange:function(s,n){t.logCall("update1CustomItemChartWhenChange",n,s);var R=s.getSelectedRepresentation();var o=this._relateChartsToItems[n].oChart;if(!o){t.logReturn("update1CustomItemChartWhenChange: chart reference is undefined");return;}t.log("...",", #oClonedChart.oModel before update:",o.getModel().getData().data.length);R.createDataset();o.setModel(R.oModel);this._setSelectionsOnThumbnailAndEnforceRendering(s,n);t.logReturn("update1CustomItemChartWhenChange",", #oClonedChart.oModel:",o.getModel().getData().data.length);},_setSelectionsOnThumbnailAndEnforceRendering:function(s,n){var f=this;var h=a++;t.emphasize("_setSelectionsOnThumbnailAndEnforceRendering, nIndex="+n," set timeout, tick=",h);setTimeout(function(){t.emphasize("_setSelectionsOnThumbnailAndEnforceRendering, nIndex="+n," resolved timeout, tick=",h);f.setSelectionsOnThumbnail(s,n);},1);},getActiveStepIndex:function(){if(this.oCoreApi.getSteps().length>1){this.getView().moveDownButton.setEnabled(true);this.getView().moveUpButton.setEnabled(true);}return this.oCoreApi.getSteps().indexOf(this.oCoreApi.getActiveStep());},deleteFromBookkeeping:function(f){if(f>=0){this._relateChartsToItems.splice(f,1);}},setSelectionsOnThumbnail:function(s,n){var R=s.getSelectedRepresentation();if(W.isIconDisplayed(R)){t.log("setSelectionsOnThumbnail","iconic, no selections applied, return");return;}var o=this._relateChartsToItems[n].oChart;t.logCall("setSelectionsOnThumbnail",", nIndex",n);if(!o){L.error("***** setSelectionsOnThumbnail: chart reference is undefined");return;}var f=R.oRepresentationFilterHandler.getFilterValues();var S=R.oVizFrameSelectionHandler.getSelectionInfoFromFilter(f,R.aDataResponse);t.log("setSelectionsOnThumbnail",", call oClonedChart.vizSelection"," apfId="+R.apfId,"  chart.id="+o.sId," selections&filters:",S,f);o.vizSelection(S,{clearSelection:true});var h=" #filters:"+f.length;h+=" #vizSelection="+(o.vizSelection()?o.vizSelection().length:"undefined");t.logReturn('setSelectionsOnThumbnail',h);},_createWrappedChartClone:function(s){var o=W.getClonedChart(s);var w=new W.constructor(this,s,o);return{oChart:o,oWrappedView:w.getContent(),wrappedChartWithCornerTexts:w};},_createRelation:function(s){var w=this._createWrappedChartClone(s);var f=this.getView().createCustomListItem(w.oWrappedView);var R=s.getSelectedRepresentation();var h=w.oChart;if(W.isIconDisplayed(R)){h=null;}var i={oChart:h,oTable:R.toggleInstance,typeOfChart:R.type,bIsAlternateView:R.bIsAlternateView,customListItem:f,wrappedChartWithCornerTexts:w.wrappedChartWithCornerTexts};t.log("_createRelation"," return=",i);return i},_addStepAsCustomItem:function(s){var R=this._createRelation(s);this.getView().addCustomListItem(R.customListItem);R.wrappedChartWithCornerTexts.setHighlighted();this._relateChartsToItems.push(R);c(this,'_addStepAsCustomItem <<',this._relateChartsToItems.length,s);},_replaceChangedRepresentation:function(s,n){c(this,'_replaceChangedRepresentation',n,s);var R=this._createRelation(s);t.log("",", relation=",R);this._relateChartsToItems[n]=R;this.getView().removeCustomItem(n);this.getView().insertCustomItem(R.customListItem,n);this._setSelectionsOnThumbnailAndEnforceRendering(s,n);c(this,'_replaceChangedRepresentation',n,s);},isChangeOfRepresentation:function(n,R){var f=R.type!==this._relateChartsToItems[n].typeOfChart||R.bIsAlternateView!==this._relateChartsToItems[n].bIsAlternateView;t.log("isChangeOfRepresentation"," return=",f);return f;},updateCustomListView:function(s,n,S){var R;try{R=s.getSelectedRepresentation();t.logCall(' --API-- Carousel.updateCustomListView',", nIndex="+n," bStepChanged="+S,"apfId=",R.apfId,e(this),b);if(n>=this._relateChartsToItems.length){this._addCustomItemAndSetHighlighting(s,n);}else if(this.isChangeOfRepresentation(n,R)){this._replaceChangedRepresentation(s,n);}else if(!S){this._setSelectionsOnThumbnailAndEnforceRendering(s,n);}else{this.update1CustomItemChartWhenChange(s,n);}this._pruneRelateChartsToItems();this._setBusyOnCustomListItem(this._relateChartsToItems[n],false);}catch(f){window.console.error("sap.apf .. carousel.controller catch exception: ",f);window.console.trace("trace ");}t.logReturn('updateCustomListView',e(this),b);},_pruneRelateChartsToItems:function(){if(this.oCoreApi.getSteps().length<this._relateChartsToItems.length){this._relateChartsToItems.splice(this.oCoreApi.getSteps().length);t.emphasize("updateCustomListView"," deletion of superfluous custom items");}},_addCustomItemAndSetHighlighting:function(s,n){var f;this._addStepAsCustomItem(s);this._setSelectionsOnThumbnailAndEnforceRendering(s,n);f=this.getActiveStepIndex();this._removeHighlightingOfAnyStep(f);if(f<=n){this._setHighlightingOfActiveStep(f);}},_setBusyOnCustomListItem:function(f,i){setTimeout(function(){f.customListItem.setBusy(i);},1);},setBusyFromIndex:function(s){var f=this;s=s||0;this._relateChartsToItems.forEach(function(h,i){if(i>=s){f._setBusyOnCustomListItem(h,true);}});},showStepChartChartAfterUpdate:function(){var s=this.oCoreApi.getSteps();if(s.length>this.getView().getCustomItemList().length){this.oUiApi.getLayoutView().setBusy(true);jQuery(this.oUiApi.getStepContainer().getDomRef()).show();}},handleMove:function(p){var f=this.oCoreApi.getSteps().indexOf(this.oCoreApi.getActiveStep());var n=f+1;var h=f-1;t.log("Carousel.handleMove",", parameter",p,", activeStepIndex="+f,l);if(p.down&&n<this.oCoreApi.getSteps().length){this._moveStep(f,n,f);}else{if(p.down!==true&&h>=0&&h<this.oCoreApi.getSteps().length){this._moveStep(f,h,h);}}},_moveInBookkeeping:function(f){t.logCall("_moveInBookkeeping",e(this));var h;h=this._relateChartsToItems[f+1];this._relateChartsToItems[f+1]=this._relateChartsToItems[f];this._relateChartsToItems[f]=h;h=this.getView().getCustomItemList()[f+1];this.getView().removeCustomItem(f+1);this.getView().insertCustomItem(h,f);t.logReturn("_moveInBookkeeping",e(this));},_moveStep:function(f,h,i){t.logCall("Carousel._moveStep"," from "+f+" to "+h,"relation=",this._relateChartsToItems);if(f!==h){this.setBusyFromIndex(i);this._moveInBookkeeping(i);var j=this.oCoreApi.getSteps()[f];var k=this.oUiApi.getAnalysisPath().getController();t.log("Carousel._moveStep"," move step in core and update path");this.oCoreApi.moveStepToPosition(j,h,k.callBackForUpdatePath.bind(k));}t.logReturn("_moveStep","relation=",this._relateChartsToItems);},setActiveStepAfterRemove:function(I){var f=this.getActiveStepIndex();if(I===f){var i;if(f===0){i=1;this._setHighlightingOfActiveStep(0);}else if(f===this.oCoreApi.getSteps().length-1){i=f-1;this._setHighlightingOfActiveStep(i);}else{i=f+1;this._setHighlightingOfActiveStep(f);}this.oCoreApi.setActiveStep(this.oCoreApi.getSteps()[i]);}},removeStep:function(i){var A=this.oUiApi.getAnalysisPath().getController();var f=this.getActiveStepIndex();if(f===i&&this.oCoreApi.getSteps().length>1){this.setActiveStepAfterRemove(i);}var s=this.oCoreApi.getSteps()[i];this.oCoreApi.removeStep(s,A.callBackForUpdatePath.bind(A));this.oCoreApi.setDirtyState(true);this.oUiApi.getLayoutView().getController().setPathTitle();if(this.oCoreApi.getSteps().length>=1){this.getView().moveDownButton.setEnabled(false);this.getView().moveUpButton.setEnabled(false);}this.oUiApi.getLayoutView().getController().enableDisableOpenIn();},removeAllThumbnails:function(){this._removeItemsAndBookkeepingRelations();},_removeItemsAndBookkeepingRelations:function(){var f=this;f.getView().oCustomItemList.removeAllItems();f._relateChartsToItems.forEach(function(h){f._destroyItemAndChart(h);});f._relateChartsToItems=[];},getTextsForCustomListItem:function(s){var S=this;var T=["leftUpper","rightUpper","leftLower","rightLower"];var o=s.thumbnail;var f=s.getSelectedRepresentationInfo().thumbnail;var R={};T.forEach(function(h){var H=f&&f[h];H=H&&!S.oCoreApi.isInitialTextKey(f[h]);var i=o&&o[h];i=i&&!S.oCoreApi.isInitialTextKey(o[h]);if(H){R[h]=S.oCoreApi.getTextNotHtmlEncoded(f[h]);return;}else if(i){R[h]=S.oCoreApi.getTextNotHtmlEncoded(o[h]);return;}});return R;},_getIndexOfCustomItem:function(i){return this.getView().getCustomItemList().findIndex(function(f){return f.sId===i;});},deleteCustomListItem:function(i){var f=this._getIndexOfCustomItem(i);t.log("deleteCustomListItem",", indexOfItem=",f,l);var h=null;if(f>=0){h=this._relateChartsToItems[f];this.getView().removeCustomItem(f);this.deleteFromBookkeeping(f);this.setBusyFromIndex(f);this.removeStep(f);this._destroyItemAndChart(h);}c(this,"deleteCustomListItem",f,null)},_destroyItemAndChart:function(f){if(f.oChart){f.oChart.destroy();}if(f.oTable){f.oTable.tableControl.destroy();f.oTable.destroy();}f.customListItem.destroy();f.customListItem=null;f.oChart=null;},listItemPressed:function(f){var n=this._getIndexOfCustomItem(f.getParameters().id);this.changeActiveStep(n);},changeActiveStep:function(n){t.logCall("changeActiveStep -- changes the active step, index=",n,l);if(n===this.getActiveStepIndex()){t.logReturn("changeActiveStep",", index=",n,"******");return;}var s=this.oCoreApi.getSteps()[n];this._removeHighlightingOfActiveStep();this.oCoreApi.setActiveStep(s);this.oUiApi.selectionChanged(false);this._setHighlightingOfActiveStep(n);t.logReturn("changeActiveStep",", index=",n,"******");},apfDestroy:function(){var s=this.getView().getStepGallery().getController();U.checkAndCloseDialog(s.oHierchicalSelectDialog);},_removeHighlightingOfActiveStep:function(){var n=this.getActiveStepIndex();var A=this._relateChartsToItems[n];A.wrappedChartWithCornerTexts.setNonHighlighted();},_removeHighlightingOfAnyStep:function(n){t.log("_removeHighlightingOfAnyStep",", nExclude",n);this._relateChartsToItems.forEach(function(f,i){if(i!==n){f.wrappedChartWithCornerTexts.setNonHighlighted();}})},_setHighlightingOfActiveStep:function(n){t.log("_setHighlightingOfActiveStep",", nActive",n);var A=this._relateChartsToItems[n];A.wrappedChartWithCornerTexts.setHighlighted();}});return C;});
