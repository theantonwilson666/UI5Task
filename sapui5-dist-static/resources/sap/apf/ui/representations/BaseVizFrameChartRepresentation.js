/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
sap.ui.define(['sap/viz/ui5/controls/VizFrame','sap/viz/ui5/controls/common/feeds/FeedItem','sap/apf/ui/representations/BaseUI5ChartRepresentation','sap/apf/ui/representations/utils/vizFrameSelectionHandler','sap/apf/ui/utils/representationTypesHandler','sap/apf/ui/utils/constants','sap/apf/core/constants','sap/apf/utils/trace'],function(V,F,B,a,R,U,C,t){'use strict';var l=" ************************************** ";var b=function(A,p){B.apply(this,[A,p]);this.oApi=A;};b.prototype=Object.create(B.prototype);b.prototype.constructor=b;b.prototype.destroy=function(){if(this.chart){this.chart.destroyDataset();this.chart.destroyFeeds();this.chart.detachRenderComplete(this.fnDrawSelectionOnMainChart);this.fnDrawSelectionOnMainChart=null;}if(this.thumbnailChart){this.thumbnailChart.destroyDataset();this.thumbnailChart.destroyFeeds();this.thumbnailChart.detachRenderComplete(this.fnDrawSelectionOnThumbnailChart);this.fnDrawSelectionOnThumbnailChart=null;}B.prototype.destroy.call(this);};b.prototype.getMeasures=function(){return this.measures;};b.prototype.getChartForCustomListItem=function(){t.logCall("getChartForCustomListItem");if(!this.chart4CustomItemList){var c=this.getMainContent("#chartForCustomListItem#",null,null,"isCreate4CIL");this.chart=undefined;this.title=undefined;this.chart4CustomItemList=c;}t.logReturn("getChartForCustomListItem"," return=",this.chart4CustomItemList);return this.chart4CustomItemList;};b.prototype.getMainContent=function(s,w,h,c){t.logCall("BaseVizFrame.getMainContent"," apfId=",this.apfId,", creationMode"+c);var i=(c==="isCreate4CIL");var d=this;var e=this;var f=(h||725)+"px";var g=w||1000;g=g+"px";this.title=s;this.createDataset();if(!this.chart){this.chart=new V({vizType:this.chartType,dataset:this.dataset,width:g,height:f,uiConfig:{applicationSet:"fiori"}});t.log(""," *** new VizFrame ***",s,", chartType="+this.chartType,", chart=",this.chart);this.setVizPropertiesOnChart(this.metadata);if(this.metadata){this._createAndAddFeedItemBasedOnId(this.chart);if(this.measures.length!==0){var m={};var j;this.measures.forEach(function(k){var n=e.getFormatStringForMeasure(k);j=e.getFormatStringForMeasureTooltip(k);m.measure=k;m.formatString=n;d.setFormatStringOnChart(m);});this.setFormatString("tooltip",j);if(this.handleCustomFormattingOnChart){this.handleCustomFormattingOnChart();}}}if(!i){this.fnDrawSelectionOnMainChart=this.drawSelectionOnMainChart.bind(d);this.chart.attachRenderComplete(this.fnDrawSelectionOnMainChart);e.attachSelectionAndFormatValue.call(this,s);}}else{if(w){this.chart.setWidth(g);}if(h){this.chart.setHeight(f);}this.chart.destroyDataset();this.chart.removeAllFeeds();this.chart.destroyFeeds();this.chart.vizUpdate({'data':this.dataset});this._createAndAddFeedItemBasedOnId(this.chart);}this.chart.setModel(this.oModel);t.logReturn("BaseVizFrame.getMainContent");return this.chart;};b.prototype.setVizPropertiesOnChart=function(m){var i={behaviorType:null};if(this.parameter.requiredFilters.length===0){i={selectability:{axisLabelSelection:false,legendSelection:false,plotLassoSelection:false,plotStdSelection:false},enableHover:false,noninteractiveMode:false,behaviorType:null};}this.chart.setVizProperties({title:{visible:true,text:this.title},interaction:i,categoryAxis:{visible:true,title:{visible:true},label:{visible:true}},valueAxis:{visible:true,title:{visible:true},label:{visible:true}},legend:{visible:true,title:{visible:true},isScrollable:true},plotArea:{window:{start:null},dataLabel:{visible:false,unitFormatType:"measureFormatter",hideWhenOverlap:true}},tooltip:{visible:true,label:{visible:true}},general:{groupData:false}});this.setVizPropsForSpecificRepresentation();var r=new R();if(r.isCombinationChart(this.type)){this.chart.setVizProperties(this.getVizPropertiesForCombinationCharts(r));}};b.prototype.getVizPropertiesForCombinationCharts=function(r){var p=[];var s=[];this.measures.forEach(function(m){if(!m.measureDisplayOption){return;}if(m.kind===r.getKindsForMeasurePropertyType(this.type)[0]){p.push(m.measureDisplayOption);}if(m.kind===r.getKindsForMeasurePropertyType(this.type)[1]){s.push(m.measureDisplayOption);}}.bind(this));var v={plotArea:{dataShape:{}}};if(p.length>0){v.plotArea.dataShape.primaryAxis=p;}if(s.length>0){v.plotArea.dataShape.secondaryAxis=s;}return v;};b.prototype.setVizPropsForSpecificRepresentation=function(){};b._setVizPropsForBubbleAndScatter=function(d,i){t.log("_setVizPropsForBubbleAndScatter",", dimensions",d);var c={valueAxis2:{visible:i,title:{visible:i}},sizeLegend:{visible:i},plotArea:{adjustScale:true}};if(!i){c.plotArea.markerSize=4;c.plotArea.marker={visible:true,size:4};}else{c.valueAxis2.label={visible:true};}var e=0;var s=0;d.forEach(function(f){if(f.kind===C.representationMetadata.kind.REGIONCOLOR){e++;}else if(f.kind===C.representationMetadata.kind.REGIONSHAPE){s++;}});if(e>0){c.plotArea.colorDepth=e;}if(s>0){c.plotArea.shapeDepth=s;}return c;};b.prototype.setFormatStringOnChart=function(m){var f=m.formatString;var c=m.measure.axisfeedItemId;this.setFormatString(c,f);};b.prototype.setFormatString=function(c,f){var s=this;var i=s.getIsAllMeasureSameUnit();switch(c){case C.vizFrame.feedItemTypes.VALUEAXIS:if(i){this.chart.setVizProperties({valueAxis:{label:{formatString:f}}});}break;case C.vizFrame.feedItemTypes.VALUEAXIS2:if(i){this.chart.setVizProperties({valueAxis2:{label:{formatString:f}}});}break;case C.vizFrame.feedItemTypes.CATEGORYAXIS:this.chart.setVizProperties({categoryAxis:{label:{formatString:f}}});break;case C.vizFrame.feedItemTypes.BUBBLEWIDTH:this.chart.setVizProperties({sizeLegend:{formatString:f}});break;case"tooltip":this.chart.setVizProperties({tooltip:{formatString:f}});break;default:break;}};b.prototype._createAndAddFeedItemBasedOnId=function(c){var s=this._createFeedItemGroup(this.parameter.measures);this._addFeedItemsToChart(c,s,"Measure");var d=this._createFeedItemGroup(this.parameter.dimensions);this._addFeedItemsToChart(c,d,"Dimension");};b.prototype._createFeedItemGroup=function(d){var s=this;var c={};d.forEach(function(e){e.axisfeedItemId=s.getAxisFeedItemId(e.kind);var f=c[e.axisfeedItemId];if(f){var g=f.some(function(D){return D.identity===e.identity;});if(!g){f.push(e);}}else{c[e.axisfeedItemId]=[e];}});return c;};b.prototype.manageSelectionsOnChart=function(e,i,p){t.logCall("BaseVizFrame.manageSelectionsOnChart",l,", is deselection",i,", oParameter: ",p);var v=new a.constructor(p,this.oApi);var s=this.chart.vizSelection();var S=v.getSelectionInfoFromEvent(e,i,s);this.setSelectionOnMainChart(S.dataPointsFromSelection,i);this.setSelectionOnThumbnailChart(S.dataPointsFromSelection,i);if(this.oRepresentationFilterHandler.getIfSelectedFilterChanged(S.aUniqueFilterValueFromChart)){t.logCall("...manageSelectionsOnChart, selected filter changed",", aUniqueFilterValueFromChart: ",S.aUniqueFilterValueFromChart);this.oRepresentationFilterHandler.updateFilterFromSelection(S.aUniqueFilterValueFromChart);this.oApi.selectionChanged(false);}t.logReturn("BaseVizFrame.manageSelectionsOnChart");};b.prototype._addFeedItemsToChart=function(c,g,f){for(var k in g){var o={};var d=[];var i=0;for(i in g[k]){d.push(g[k][i].identity);o.feedItemId=g[k][0].axisfeedItemId;}o.value=d;var e=new F({uid:o.feedItemId,type:f,values:o.value});c.addFeed(e);}};b.prototype.setVizPropertiesOnThumbnailChart=function(){if(!this.thumbnailChart){return;}this.thumbnailChart.setVizProperties({title:{visible:false},categoryAxis:{visible:false,title:{visible:false}},valueAxis:{visible:false,title:{visible:false}},legend:{visible:false,title:{visible:false}},tooltip:{visible:false},interaction:{selectability:{axisLabelSelection:false,legendSelection:false,plotLassoSelection:false,plotStdSelection:false},enableHover:false,noninteractiveMode:true},background:{visible:false},general:{layout:{padding:0},groupData:false},plotArea:{window:{start:null},gridline:{visible:false},dataLabel:{visible:false},seriesStyle:{rules:[{properties:{width:1}}]}}});this.setVizPropsOfThumbnailForSpecificRepresentation();var r=new R();if(r.isCombinationChart(this.type)){this.thumbnailChart.setVizProperties(this.getVizPropertiesForCombinationCharts(r));}};b.prototype.setVizPropsOfThumbnailForSpecificRepresentation=function(){};b.prototype.setSelectionOnMainChart=function(s,i){t.log("BaseVizFrame.setSelectionOnMainChart",", aSelection=",s," apfId=",this.apfId,", bIsDeselection="+i,"chart.sId"+this.chart.sId);this.chart.vizSelection(s,{clearSelection:i});};b.prototype.setSelectionOnThumbnailChart=function(s,i){t.log("BaseVizFrame.setSelectionOnThumbnailChart",", aSelection=",s," apfId=",this.apfId,", bIsDeselection="+i,"thumbnailChart.sId"+(!this.thumbnailChart)?"-":this.thumbnailChart.sId);if(this.thumbnailChart){this.thumbnailChart.vizSelection(s,{clearSelection:i});}};b.prototype.getAxisFeedItemId=function(k){};b.prototype.getPrintContent=function(s){var r,v=this.chartType,c={},S,p;var o=this.getMainContent(s);c=o.getVizProperties();r=o.clone();r.setVizType(v);r.setVizProperties(c);r.setWidth("1000px");r.setHeight("600px");this.createDataset();r.setDataset(this.dataset);r.setModel(this.oModel);S=this.chart.vizSelection();r.attachRenderComplete(function(){r.vizSelection(S);});p={oRepresentation:r};return p;};return b;},true);
