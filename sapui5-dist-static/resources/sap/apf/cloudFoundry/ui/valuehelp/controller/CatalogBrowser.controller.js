sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/IconPool","sap/ui/core/library","sap/ui/core/ValueState","sap/ui/core/Item","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/m/MessageToast","sap/apf/cloudFoundry/ui/utils/ODataServiceUtils"],function(C,I,L,V,a,J,O,F,b,S,M,c){"use strict";V=L.ValueState;var P="sap.apf.cloudFoundry.ui.valuehelp";var D={BACK:-1,DESTINATIONS:0,CATALOG:1,URL:2,OVERVIEW:3,OVERVIEW_REDUCED:4,OVERVIEW_SERVICEONLY:5};function r(o,u){return o.getManifestObject().resolveUri(u).toString();}return C.extend(P+".controller.CatalogBrowser",{onInit:function(){var o=this.getOwnerComponent();var d=r(o,o.getManifestEntry("/sap.app/dataSources/apf.destinationCatalog.destinations").uri);this.sDestination=undefined;this.sService=undefined;this.oCoreApi=o.oCoreApi;var e=this.getDialog();var v=this.getView();e.removeStyleClass("sapUiPopupWithPadding");e.addStyleClass("sapMSelectDialog");var u=new J({Title:this.translate("selectDestination"),Destination:"",Service:"",ServiceUrlValueState:V.None,SearchEnabled:true,ButtonOkEnabled:false,ButtonSelectEnabled:false,ButtonBackEnabled:false});v.setModel(u,"ui");var m=new J(d);v.setModel(m,"destinations");m.attachRequestCompleted(function(){this.oDestinationStatusPromises=c.pingDestinations(m.getData().destinations);}.bind(this));this.addCustomEventDelegates();e.open();},addCustomEventDelegates:function(){var v=this.getView();v.byId("urlInput").addEventDelegate({onkeypress:function(e){if(e.key==="Enter"){this.onSelectServiceUrl();}}.bind(this)});},onSelectDestination:function(e){this.destinationPath=e.getSource().getBindingContext("destinations").getPath();var v=this.getView();var d=v.getModel("destinations");var o=d.getObject(this.destinationPath);this.destinationSearch=v.byId("searchField").getValue();v.byId("searchField").setValue("");this.oDestinationStatusPromises[o.name].then(function(s){switch(s){case c.DESTINATION_TYPE.SERVICE:this.navigate(D.OVERVIEW_SERVICEONLY,{destination:o.name});this.setIsAnalyticalService();v.byId("serviceOnlyOverview").bindElement({path:this.destinationPath,model:"destinations"});break;case c.DESTINATION_TYPE.CATALOG:this.navigate(D.CATALOG,{destination:o.name});this.attachCatalogModel(o.name);break;default:var u=v.byId("urlInput");u.setValue("");u.removeAllItems();u.setShowButton(false);this.navigate(D.URL,{destination:o.name});c.discoverServices(o.name).then(function(E){if(E.length>0){E.forEach(function(f){u.addItem(new a({text:f.Url}));});u.setShowButton(true);}}).catch(function(){});break;}}.bind(this));},attachCatalogModel:function(d){var v=this.getView();var l=v.byId("navContainer").getCurrentPage().getContent()[0];l.bindItems({path:"catalog>/ServiceCollection",sorter:new S("TechnicalServiceName",false),parameters:{custom:{search:""}},template:l.getBindingInfo("items").template});var m=new O(c.getCatalogURL(d));v.setModel(m,"catalog");var o=v.byId("selectService");o.setBusy(true);m.attachMetadataLoaded(function(){o.setBusy(false);});m.attachMetadataFailed(function(e){this.onBack();M.show(this.translate("destinationError",e.getParameter("responseText")));o.setBusy(false);}.bind(this));},onSelectService:function(e){var v=this.getView();var B=e.getSource().getBindingContext("catalog");var s=c.getRelativeServiceURL(B.getProperty("ServiceUrl"));this.navigate(D.OVERVIEW,{service:s});this.setIsAnalyticalService();var p=B.getPath();v.byId("destinationOverview").bindElement({path:this.destinationPath,model:"destinations"});v.byId("serviceOverview").bindElement({path:p,model:"catalog"});},onSelectServiceUrl:function(){var v=this.getView();var u=v.getModel("ui");var s=v.byId("urlInput").getValue();if(!s.startsWith("/")){u.setProperty("/ServiceUrlValueState",V.Error);return;}u.setProperty("/ServiceUrlValueState",V.None);this.navigate(D.OVERVIEW_REDUCED,{service:s});this.setIsAnalyticalService();v.byId("reducedDestinationOverview").bindElement({path:this.destinationPath,model:"destinations"});},onCancel:function(){this.getDialog().close();this.getDialog().destroy();this.getView().destroy();this.destroy();},onBack:function(){var v=this.getView();var p=this.navigate(D.BACK);switch(p){case D.DESTINATIONS:v.byId("searchField").setValue(this.destinationSearch);break;default:break;}},onOk:function(){var v=this.getView();var u=v.getModel("ui");var U=c.getFullServiceURL(u.getProperty("/Destination"),u.getProperty("/Service"));var o=this.getView().getViewData();o.parentControl.fireEvent("selectService",{"sSelectedService":U});this.getDialog().close();this.getDialog().destroy();this.getView().destroy();this.destroy();},onLiveChangeSearch:function(e){var s=e.getParameter("newValue");var d=(s?300:0);var t=this;clearTimeout(this.iLiveChangeTimer);if(d){this.iLiveChangeTimer=setTimeout(function(){t.executeSearch(s);},d);}else{this.executeSearch(s);}},onSearch:function(e){this.executeSearch(e.getSource().getValue());},executeSearch:function(s){var v=this.getView();var l=v.byId("navContainer").getCurrentPage().getContent()[0];var f=v.getModel("ui").getProperty("/Destination")!=="";if(f){l.bindItems({path:"catalog>/ServiceCollection",sorter:new S("TechnicalServiceName",false),parameters:{custom:{search:s}},template:l.getBindingInfo("items").template});}else{l.getBinding("items").filter(new F({filters:[new F({path:'name',operator:b.Contains,value1:s}),new F({path:'description',operator:b.Contains,value1:s})],and:false}));}},setIsAnalyticalService:function(){var u=this.getView().getModel("ui");var d=u.getProperty("/Destination");var s=u.getProperty("/Service");u.setProperty("/ServiceStatus",c.SERVICE_STATUS.PENDING);return c.isAnalyticalService(d,s).then(function(e){u.setProperty("/ServiceStatus",e);}).catch(function(e){u.setProperty("/ServiceStatus",e);});},serviceStatusIcon:function(s){switch(s){case c.SERVICE_STATUS.ANALYTICAL_SERVICE:return I.getIconURI("status-positive");case c.SERVICE_STATUS.NOT_ANALYTICAL_SERVICE:return I.getIconURI("status-critical");case c.SERVICE_STATUS.WRONG_ODATA_VERSION:return I.getIconURI("status-error");case c.SERVICE_STATUS.NOT_ACCESSIBLE:return I.getIconURI("status-error");default:return I.getIconURI("status-inactive");}},serviceStatusState:function(s){switch(s){case c.SERVICE_STATUS.ANALYTICAL_SERVICE:return V.Success;case c.SERVICE_STATUS.NOT_ANALYTICAL_SERVICE:return V.Warning;case c.SERVICE_STATUS.WRONG_ODATA_VERSION:return V.Error;case c.SERVICE_STATUS.NOT_ACCESSIBLE:return V.Error;default:return V.None;}},serviceStatusText:function(s){switch(s){case c.SERVICE_STATUS.ANALYTICAL_SERVICE:return this.translate("analyticalService");case c.SERVICE_STATUS.NOT_ANALYTICAL_SERVICE:return this.translate("nonAnalyticalService");case c.SERVICE_STATUS.WRONG_ODATA_VERSION:return this.translate("wrongOdataVersion");case c.SERVICE_STATUS.NOT_ACCESSIBLE:return this.translate("serviceNotAccessible");default:return this.translate("pending");}},proxyTypeIcon:function(p){switch(p){case"OnPremise":return I.getIconURI("it-host");default:return I.getIconURI("cloud");}},proxyTypeText:function(p){switch(p){case"OnPremise":return this.translate("onPremise");default:return this.translate("cloud");}},translate:function(k){return this.oCoreApi.getText(k,Array.prototype.slice.call(arguments,1));},getRelativeServiceURL:c.getRelativeServiceURL,navigate:function(p,o){var v=this.getView();var u=v.getModel("ui");var n=v.byId("navContainer");o=o||{};o.destination=o.destination||u.getProperty("/Destination");o.service=o.service||u.getProperty("/Service");var _;if(p<0){var d=n.getPreviousPage();_=n.indexOfPage(d);}else{_=p;}switch(_){case D.DESTINATIONS:u.setProperty("/Title",this.translate("selectDestination"));u.setProperty("/Destination","");u.setProperty("/Service","");u.setProperty("/ServiceUrlValueState",V.None);u.setProperty("/SearchEnabled",true);u.setProperty("/ButtonOkEnabled",false);u.setProperty("/ButtonSelectEnabled",false);u.setProperty("/ButtonBackEnabled",false);break;case D.CATALOG:u.setProperty("/Title",this.translate("selectService",o.destination));u.setProperty("/Destination",o.destination);u.setProperty("/Service","");u.setProperty("/ServiceUrlValueState",V.None);u.setProperty("/SearchEnabled",true);u.setProperty("/ButtonOkEnabled",false);u.setProperty("/ButtonSelectEnabled",false);u.setProperty("/ButtonBackEnabled",true);break;case D.URL:u.setProperty("/Title",this.translate("enterService",o.destination));u.setProperty("/Destination",o.destination);u.setProperty("/Service","");u.setProperty("/ServiceUrlValueState",V.None);u.setProperty("/SearchEnabled",false);u.setProperty("/ButtonOkEnabled",false);u.setProperty("/ButtonSelectEnabled",true);u.setProperty("/ButtonBackEnabled",true);break;case D.OVERVIEW:u.setProperty("/Title",this.translate("overview"));u.setProperty("/Destination",o.destination);u.setProperty("/Service",o.service);u.setProperty("/ServiceUrlValueState",V.None);u.setProperty("/SearchEnabled",false);u.setProperty("/ButtonOkEnabled",true);u.setProperty("/ButtonSelectEnabled",false);u.setProperty("/ButtonBackEnabled",true);break;case D.OVERVIEW_REDUCED:u.setProperty("/Title",this.translate("overview"));u.setProperty("/Destination",o.destination);u.setProperty("/Service",o.service);u.setProperty("/ServiceUrlValueState",V.None);u.setProperty("/SearchEnabled",false);u.setProperty("/ButtonOkEnabled",true);u.setProperty("/ButtonSelectEnabled",false);u.setProperty("/ButtonBackEnabled",true);break;case D.OVERVIEW_SERVICEONLY:u.setProperty("/Title",this.translate("overview"));u.setProperty("/Destination",o.destination);u.setProperty("/Service","");u.setProperty("/ServiceUrlValueState",V.None);u.setProperty("/SearchEnabled",false);u.setProperty("/ButtonOkEnabled",true);u.setProperty("/ButtonSelectEnabled",false);u.setProperty("/ButtonBackEnabled",true);break;default:u.setProperty("/Title",this.translate("selectDestination"));u.setProperty("/Destination","");u.setProperty("/Service","");u.setProperty("/ServiceUrlValueState",V.None);u.setProperty("/SearchEnabled",true);u.setProperty("/ButtonOkEnabled",false);u.setProperty("/ButtonSelectEnabled",false);u.setProperty("/ButtonBackEnabled",false);_=D.DESTINATIONS;break;}if(p<0){n.back();}else{var e=n.getPages()[_];n.to(e);}return _;},getDialog:function(){var d=this.getView().byId("catalogBrowser");var v=this.getView();if(!d){d=sap.ui.xmlfragment(v.getId(),P+".fragment.CatalogBrowser",this);v.addDependent(d);}return d;}});});
