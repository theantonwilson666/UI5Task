/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");jQuery.sap.require("sap.apf.modeler.ui.utils.textManipulator");jQuery.sap.require('sap.apf.utils.utils');sap.ui.define(['sap/apf/modeler/ui/utils/constants','sap/apf/modeler/ui/utils/optionsValueModelBuilder','sap/apf/modeler/ui/utils/nullObjectChecker'],function(M,o,n){"use strict";var t=sap.apf.modeler.ui.utils.textManipulator;var c=M.events;var T=sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_LABEL;function _(C){var r=C.oRepresentation.getRepresentationType();var K=C.getView().getViewData().oPropertyTypeData.sContext;var p=C.getView().getViewData().oRepresentationTypeHandler.getLabelsForChartType(C.oTextReader,r,K);C.byId("idPropertyTypeLabel").setText(p);C.byId("idPropertyTypeLabel").setTooltip(p);}function a(C){if(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version>=11){C.byId("idAriaPropertyForBasicDataGroup").setText(C.oTextReader("basicData"));}C.byId("idAriaPropertyForAdd").setText(C.oTextReader("ariaTextForAddIcon"));C.byId("idAriaPropertyForDelete").setText(C.oTextReader("ariaTextForDeleteIcon"));}function b(C){var m;var l=jQuery.Deferred();var v=C.byId("idPropertyType");C.getAllPropertiesAsPromise().then(function(r){m=o.convert(r.aAllProperties);v.setModel(m);v.setSelectedKey(r.sSelectedKey);l.resolve();});return l.promise();}function d(C){var p=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));var s=C.getPropertyTextLabelKey(p)?C.oTextReader("label"):C.oTextReader("label")+" ("+C.oTextReader("default")+")";C.byId("idPropertyLabel").setText(s);C.byId("idPropertyLabel").setTooltip(s);}function e(C){var p;var P=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));var s=C.getPropertyTextLabelKey(P);if(n.checkIsNotUndefined(s)){p=C.getView().getViewData().oConfigurationHandler.getTextPool().get(s).TextElementDescription;C.byId("idPropertyLabelText").setValue(p);}else{C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().then(function(l){var m=C.oStepPropertyMetadataHandler.getDefaultLabel(l,P);C.byId("idPropertyLabelText").setValue(m);});}}function f(C){C.byId("idAddPropertyIcon").setTooltip(C.oTextReader("addButton"));C.byId("idRemovePropertyIcon").setTooltip(C.oTextReader("deleteButton"));}function g(C){var p=C.getView().getViewData().sPropertyType;var K=C.getView().getViewData().oPropertyTypeData.sContext;var s=C.oRepresentationTypeHandler.isAdditionToBeEnabled(C.oRepresentation.getRepresentationType(),p,K);var S=s;var P=C.getView().getViewData().oPropertyTypeState;var l=P.indexOfPropertyTypeViewId(C.getView().getId());if(l===0){S=false;}else if(l>0){var m=P.getViewAt(l-1);var q=m.getViewData().oPropertyTypeData.sContext;if(K!==q){S=false;}}C.byId("idAddPropertyIcon").setVisible(s);C.byId("idRemovePropertyIcon").setVisible(S);if(l>0){m.oController.byId("idAddPropertyIcon").setVisible(false);}}function h(C){var p=C.getView().getViewData().oPropertyTypeState;var l=p.indexOfPropertyTypeViewId(C.getView().getId());if(l>0){var m=p.aProperties.length-1;var P=p.getViewAt(l-1);var q=p.getViewAt(l);var r=C.oConfigurationEditor.isSaved();}if(l>0&&l==m&&r==false){P.oController.byId("idAddPropertyIcon").setVisible(false);q.oController.byId("idAddPropertyIcon").setVisible(true);q.oController.byId("idRemovePropertyIcon").setVisible(true);}}function i(C,l){var p=C.getView().getViewData().oPropertyTypeState;var m=p.aProperties.length;var P=p.getViewAt(l-1);var q=C.oConfigurationEditor.isSaved();if(l>1&&l==m&&q==false){P.oController.byId("idAddPropertyIcon").setVisible(true);P.oController.byId("idRemovePropertyIcon").setVisible(true);}if(l===1&&l==m&&q==false){P.oController.byId("idAddPropertyIcon").setVisible(true);}}function j(C){C.byId("idAddPropertyIcon").attachEvent(c.SETFOCUSONADDICON,C.setFocusOnAddRemoveIcons.bind(C));}var k=sap.ui.core.mvc.Controller.extend("sap.apf.modeler.ui.controller.propertyType",{_apfName:"propertyType",oConfigurationEditor:{},oRepresentation:{},oStepPropertyMetadataHandler:{},oRepresentationTypeHandler:{},oTextReader:{},oTextPool:{},initPromise:null,onInit:function(){var C=this;C.initPromise=new jQuery.Deferred();C.oConfigurationEditor=C.getView().getViewData().oConfigurationEditor;C.oRepresentation=C.getView().getViewData().oParentObject;C.oStepPropertyMetadataHandler=C.getView().getViewData().oStepPropertyMetadataHandler;C.oRepresentationTypeHandler=C.getView().getViewData().oRepresentationTypeHandler;C.oTextReader=C.getView().getViewData().oCoreApi.getText;C.oTextPool=C.getView().getViewData().oTextPool;if(C.getView().getViewData().oPropertyTypeData.bMandatory){C.getView().getViewData().oViewValidator.addField(C.byId("idPropertyType").getId());C.byId("idPropertyTypeLabel").setRequired(true);}b(C).then(function(){C.setDetailData().then(function(){C.initPromise.resolve();});g(C);});},onAfterRendering:function(){var C=this;C.initPromise.then(function(){C.enableDisableLabelDisplayOptionTypeAsPromise().then(function(){C.byId("idAddPropertyIcon").fireEvent(c.SETFOCUSONADDICON);});});},setDetailData:function(){var l=jQuery.Deferred();var C=this;C.setLabelDisplayOptionTypeAsPromise(o).then(function(){if(!C.byId("idPropertyType")){l.resolve();return;}e(C);a(C);d(C);_(C);f(C);l.resolve();});return l.promise();},handleChangeForPropertyTypeAsPromise:function(l){var C=this;var m=jQuery.Deferred();var s=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));var p=C.getView().getViewData().oPropertyOrchestration;var v=C.getView().getId();var q;var r=null;if(p){q=p.isSwapCase(v,s);r=p.getPropertyTypeRowByPropertyName(s);p.updateAllSelectControlsForPropertyType(v,s).then(function(){var u;C.updateRepresentationAndView().then(function(){if(q){u=r.oView.getController();u.updateRepresentationAndView().then(function(){C.oConfigurationEditor.setIsUnsaved();m.resolve();});}else{C.oConfigurationEditor.setIsUnsaved();m.resolve();}});});}else{C.forceFailSinceOrchestrationIsMissing();m.resolve()}return m.promise();},updateRepresentationAndView:function(){var C=this;return new Promise(function(r){C.updateOfConfigurationObjectAsPromise().then(function(){C.setDetailData();C.enableDisableLabelDisplayOptionTypeAsPromise().then(function(){r();});});});},handleChangeForLabelDisplayOptionType:function(){var C=this;var l=C.byId("idLabelDisplayOptionType").getSelectedKey();C.changeLabelDisplayOption(l);C.oConfigurationEditor.setIsUnsaved();},handleChangeForLabelText:function(){var C=this,l;var L=C.byId("idPropertyLabelText").getValue();var p=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));if(L.trim().length===0){l=undefined;C.setPropertyTextLabelKey(p,l);d(C);e(C);C.oConfigurationEditor.setIsUnsaved();}else{C.getView().getViewData().oConfigurationHandler.getTextPool().setTextAsPromise(L,T).then(function(l){C.setPropertyTextLabelKey(p,l);d(C);e(C);C.oConfigurationEditor.setIsUnsaved();});}},setFocusOnAddRemoveIcons:function(){var C=this;C.byId("idAddPropertyIcon").focus();},handlePressOfAddPropertyIcon:function(){var C=this;var v=C.getView();var p=v.getViewData().oPropertyOrchestration;var l=C.byId("idPropertyType").getItems();var s=C.byId("idPropertyType").getSelectedKey();var m=C.oTextReader("none");if(this._shallAddPropertyBeHandled(l,s,m,p)){j(C);C.getView().fireEvent(M.events.ADDPROPERTY,{"oSourceView":v});C.oConfigurationEditor.setIsUnsaved();h(C);}},handlePressOfRemovePropertyIcon:function(){var C=this;var v=C.getView().getViewData();var p=v.oPropertyTypeState;var l=p.indexOfPropertyTypeViewId(C.getView().getId());if(l>0){var P=p.getViewAt(l-1);j(P.getController());}var m=v.oPropertyOrchestration;m.removePropertyTypeReference(C.getView().getId());return C.updateRepresentationAndView().then(function(){m.updateAllSelectControlsForPropertyType();v.oPropertyTypeHandlerBackLink.handlePressOfRemove({oSourceView:C.getView()});C.oConfigurationEditor.setIsUnsaved();if(l!==0){i(C,l);}C.getView().destroy();});},updateOfConfigurationObjectAsPromise:function(){var C=this;return new Promise(function(r){var p=[];if(C.getView().getViewData().oPropertyOrchestration){p=C.getView().getViewData().oPropertyOrchestration.getPropertyInformationList();C.updatePropertiesInConfiguration(p);}else{C.forceFailSinceOrchestrationIsMissing();}r();});},handleSuggestions:function(E){var C=this;var s=new sap.apf.modeler.ui.utils.SuggestionTextHandler(C.oTextPool);s.manageSuggestionTexts(E,T);},getSelectedProperty:function(){var C=this;var p=C.getView().getViewData().oPropertyTypeState;var l=p.getPropertyValueState();var m=p.indexOfPropertyTypeViewId(C.getView().getId());return l[m];},removeAllItemsFromDropDownList:function(){var C=this;var v=C.byId("idPropertyType");v.getItems().forEach(function(I){v.removeItem(I);});},setItemsOfDropDownList:function(C,A,s,m,l){function p(w,x){return w.indexOf(x)!==-1;}var q=this;var v=q.byId("idPropertyType");var r=[];var u=(s===q.oTextReader("none"));if(!m&&l===M.aggregationRoles.DIMENSION){v.addItem(new sap.ui.core.Item({key:q.oTextReader("none"),text:q.oTextReader("none")}));}if(l===M.aggregationRoles.MEASURE){r=JSON.parse(JSON.stringify(A));}else{r=JSON.parse(JSON.stringify(C));}if(!p(r,s)&&!u){r.unshift(s);}r.forEach(function(V){var w=V;if(!p(A,V)&&!u&&V!==""){V=t.addPrefixText([V],q.oTextReader)[0];}var I=new sap.ui.core.Item({key:V,text:V});v.addItem(I);if(w===s){s=V;}});v.setSelectedKey(s);},updatePropertiesInConfiguration:function(p){},createNewPropertyInfoAsPromise:function(s){return sap.apf.utils.createPromise();},setPropertyInParentObject:function(){},setLabelDisplayOptionTypeAsPromise:function(o){return sap.apf.utils.createPromise();},getAllPropertiesAsPromise:function(){return sap.apf.utils.createPromise();},getPropertyTextLabelKey:function(p){},setPropertyTextLabelKey:function(p,l){},enableDisableLabelDisplayOptionTypeAsPromise:function(){return sap.apf.utils.createPromise();},removePropertyFromParentObject:function(){},addPropertyAsPromise:function(){return sap.apf.utils.createPromise();},changeLabelDisplayOption:function(l){},_shallAddPropertyBeHandled:function(l,s,m,p){var q=l.filter(function(w){return w.mProperties.key!==m;});if(p&&p.getAggregationRole()===M.aggregationRoles.MEASURE){var r=p._getPropertyTypeRows().length;return(r<q.length);}if(l.length===0||!s){return false;}var u=q.filter(function(w){return w.mProperties.key!==s;});var v=(s===m);if(u.length<2&&v){return false;}else if(u.length<1&&!v){return false;}return true;}});return k;},true);
