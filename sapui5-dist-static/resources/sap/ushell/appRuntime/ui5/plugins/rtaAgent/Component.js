// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/Component","sap/ui/fl/write/api/FeaturesAPI","sap/ushell/appRuntime/ui5/plugins/baseRta/CheckConditions","sap/ushell/appRuntime/ui5/plugins/baseRta/AppLifeCycleUtils","sap/ushell/appRuntime/ui5/plugins/baseRta/Trigger","sap/base/Log"],function(C,F,a,A,T,L){"use strict";var p;function g(){return{sComponentName:"sap.ushell.appRuntime.ui5.plugins.rtaAgent",layer:"CUSTOMER",developerMode:false};}function b(v){return new Promise(function(r,e){p.postMessageToFlp("user.postapi.rtaPlugin","switchToolbarVisibility",{visible:v}).done(r).fail(e);});}function c(){return new Promise(function(r,e){p.postMessageToFlp("user.postapi.rtaPlugin","activatePlugin").done(r).fail(e);});}function d(){if(a.checkUI5App()){p.postMessageToFlp("user.postapi.rtaPlugin","showAdaptUI").fail(function(e){throw new Error(e);});}}return C.extend("sap.ushell.appRuntime.ui5.plugins.rtaAgent.Component",{metadata:{manifest:"json"},init:function(){this.mConfig=g();p=this.getComponentData().oPostMessageInterface;return F.isKeyUser().then(function(i){if(i){return c();}return Promise.reject();}).then(function(){this.mConfig.i18n=this.getModel("i18n").getResourceBundle();this.mConfig.onStartHandler=this._onStartHandler.bind(this);this.mConfig.onErrorHandler=this._onErrorHandler.bind(this);this.mConfig.onStopHandler=this._onStopHandler.bind(this);this.oTrigger=new T(this.mConfig);this._registerPostMessages();this._restartRtaIfRequired();var o=A.getAppLifeCycleService();o.attachAppLoaded(this._onAppLoaded,this);}.bind(this)).then(d).catch(function(e){if(e){L.error(e);}});},_registerPostMessages:function(){p.registerPostMessageAPIs({"user.postapi.rtaPlugin":{inCalls:{startUIAdaptation:{executeServiceCallFn:function(){this.oTrigger.triggerStartRta(this);return p.createPostMessageResult();}.bind(this)}},outCalls:{activatePlugin:{},showAdaptUI:{}}}});},_restartRtaIfRequired:function(){if(a.checkUI5App()){if(a.checkRestartRTA(this.mConfig.layer)){return b(false).then(function(){return this.oTrigger.triggerStartRta(this);}.bind(this));}}return Promise.resolve();},_onAppLoaded:function(){if(a.checkUI5App()){this._restartRtaIfRequired();d();}},_onStopHandler:function(){this._exitAdaptation();},_onStartHandler:function(){},_onErrorHandler:function(e){this.oTrigger.errorHandler(e);if(e!=="Reload triggered"){this._exitAdaptation();var E;var m;if(e instanceof Error){E=e.stack;m=this.mConfig.i18n.getText("TECHNICAL_ERROR");}else if(typeof e==="string"){E=m=e;}L.error("Cannot start UI Adaptation: ",E);sap.ui.require(["sap/ui/rta/Utils","sap/m/MessageBox"],function(U,M){M.error(m,{title:this.mConfig.i18n.getText("ERROR_TITLE"),onClose:null,styleClass:U.getRtaStyleClassName()});}.bind(this));}},_exitAdaptation:function(){b(true);this.oTrigger.exitRta();},exit:function(){b(true);var o=A.getAppLifeCycleService();o.detachAppLoaded(this._onAppLoaded,this);}});});
