// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sinaDefine(['../../core/core','../../sina/sinaFactory','./ProviderHelper','./FederationMethod','./FederationType','./FacetMode'],function(c,s,P,F,a,b){"use strict";return c.defineClass({id:'multi',_initAsync:function(p){this.sina=p.sina;this.facetMode=b[p.facetMode]||b.flat;this.federationType=a[p.federationType]||a.advanced_round_robin;this.multiSina=[];this.multiDataSourceMap={};this.sina.dataSourceMap[this.sina.allDataSource.id]=this.sina.allDataSource;this.providerHelper=new P(this);this.federationMethod=F;var d=function(e){if(e>=p.subProviders.length){if(this.multiSina.length<1){return c.Promise.reject(new c.Exception('sina creation by trial failed'));}return undefined;}var f=p.subProviders[e];return s.createAsync(f).then(function(g){this.providerHelper.updateProviderId(g);for(var i=0;i<g.dataSources.length;i++){var h=g.dataSources[i];var m=this.providerHelper.calculateMultiDataSourceId(h.id,g.provider.id);this.providerHelper.createMultiDataSource(m,h);this.multiDataSourceMap[m]=h;}this.multiSina.push(g);return d(e+1);}.bind(this),function(){return d(e+1);});}.bind(this);return d(0);},executeSearchQuery:function(q){var t=this;var d;t.searchResultSet=t.sina._createSearchResultSet({title:'Search Multi Result List',query:q,items:[],totalCount:0,facets:[]});t.searchResultSetItemList=[];if(q.filter.dataSource===t.sina.allDataSource){t.searchResultSet.facets.push(t.sina._createDataSourceResultSet({title:q.filter.dataSource.label,items:[],query:q}));var e=[];for(var i=0;i<t.multiSina.length;i++){d=t.multiSina[i].createSearchQuery({calculateFacets:q.calculateFacets,multiSelectFacets:q.multiSelectFacets,dataSource:t.multiSina[i].allDataSource,searchTerm:q.getSearchTerm(),top:q.top,skip:q.skip,sortOrder:q.sortOrder});e.push(d.getResultSetAsync());}return c.Promise.all(e).then(function(g){for(var j=0;j<g.length;j++){var h=g[j];for(var k=0;k<h.items.length;k++){var l=h.items[k];var m=t.providerHelper.calculateMultiDataSourceId(l.dataSource.id,l.sina.provider.id);var n=t.sina.dataSourceMap[m];l.dataSource=n;l.sina=t.sina;}t.searchResultSet.totalCount+=h.totalCount;t.searchResultSetItemList.push(h.items);if(h.facets[0]){if(t.facetMode===b.tree){var f=t.sina.getDataSource(t.providerHelper.calculateMultiDataSourceId(h.query.filter.dataSource.id,h.sina.provider.id));t.searchResultSet.facets[0].items.push(t.sina._createDataSourceResultSetItem({dataSource:f,dimensionValueFormatted:t.providerHelper.calculateMultiDataSourceLabel(h.query.filter.dataSource.label,h.sina.provider),measureValue:h.totalCount,measureValueFormatted:h.totalCount}));}else{var o=t.providerHelper.updateDataSourceFacets(h.facets);o[0].items.forEach(function(p){t.searchResultSet.facets[0].items.push(p);});}}}t.searchResultSet.items=t.federationMethod[t.federationType].sort(t.searchResultSetItemList);t.searchResultSet.items=t.searchResultSet.items.slice(q.skip,q.top);return t.searchResultSet;});}var f=t.multiDataSourceMap[q.filter.dataSource.id];var r=q.getRootCondition().clone();t.providerHelper.updateRootCondition(r,f.sina);d=f.sina.createSearchQuery({calculateFacets:q.calculateFacets,multiSelectFacets:q.multiSelectFacets,dataSource:f,searchTerm:q.getSearchTerm(),rootCondition:r,top:q.top,skip:q.skip,sortOrder:q.sortOrder});return d.getResultSetAsync().then(function(g){t.searchResultSet.items=g.items;t.searchResultSet.totalCount=g.totalCount;for(var i=0;i<t.searchResultSet.items.length;i++){var h=t.searchResultSet.items[i];var j=t.providerHelper.calculateMultiDataSourceId(h.dataSource.id,h.sina.provider.id);t.providerHelper.updateAttributesMetadata(h.dataSource,t.sina.dataSourceMap[j]);h.dataSource=t.sina.dataSourceMap[j];h.sina=t.sina;}var m;if(g.facets.length===1&&g.facets[0].items[0].dataSource){m=g.facets;m[0].title=t.providerHelper.calculateMultiDataSourceLabel(g.facets[0].title,g.facets[0].sina.provider);t.providerHelper.updateDataSourceFacets(m);}else{m=[];for(var k=0;k<g.facets.length;k++){var l=g.facets[k];m.push(t.providerHelper.createMultiChartResultSet(l));}}t.searchResultSet.facets=m;return t.searchResultSet;});},executeChartQuery:function(q){var t=this;var d=t.multiDataSourceMap[q.filter.dataSource.id];var r=q.getRootCondition().clone();t.providerHelper.updateRootCondition(r,d.sina);var e=d.sina.createChartQuery({dimension:q.dimension,dataSource:d,searchTerm:q.getSearchTerm(),rootCondition:r,top:q.top,skip:q.skip,sortOrder:q.sortOrder});return e.getResultSetAsync().then(function(f){return t.providerHelper.createMultiChartResultSet(f);});},executeSuggestionQuery:function(q){var t=this;var d;if(q.filter.dataSource===t.sina.allDataSource){var e=[];for(var i=0;i<t.multiSina.length;i++){d=t.multiSina[i].createSuggestionQuery({types:q.types,calculationModes:q.calculationModes,dataSource:t.multiSina[i].allDataSource,searchTerm:q.getSearchTerm(),top:q.top,skip:q.skip,sortOrder:q.sortOrder});e.push(d.getResultSetAsync());}return c.Promise.all(e).then(function(r){var m=t.sina._createSuggestionResultSet({title:'Multi Suggestions',query:q,items:[]});for(var j=0;j<r.length;j++){var g=t.providerHelper.updateSuggestionDataSource(r[j]);m.items=t.federationMethod.roundRobin.mergeMultiResults(m.items,g.items,j+1);}return m;});}var f=t.multiDataSourceMap[q.filter.dataSource.id];d=f.sina.createSuggestionQuery({types:q.types,calculationModes:q.calculationModes,dataSource:f,searchTerm:q.getSearchTerm(),top:q.top,skip:q.skip,sortOrder:q.sortOrder});return d.getResultSetAsync().then(function(r){return t.providerHelper.updateSuggestionDataSource(r);});}});});
