// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/ushell/renderers/fiori2/search/SearchConfiguration","sap/base/Log"],function(u,S,L){"use strict";return sap.ui.core.Control.extend("sap.ushell.renderers.fiori2.search.controls.SearchResultMap",{teststring:"",ContainerContent:null,MapContainer:null,minLat:0,minLon:0,maxLat:0,maxLon:0,centerLat:0,centerLon:0,iNrLocations:0,myMap:null,myMapContainer:null,metadata:{aggregations:{_map:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}}},init:function(){var t=this;var m={MapProvider:[{name:"OPENSTREETMAP",type:"",description:"",tileX:"256",tileY:"256",maxLOD:"19",copyright:"Â© openstreetmap",Source:[{id:"s1",url:"http://a.tile.openstreetmap.org/{LOD}/{X}/{Y}.png"},{id:"s2",url:"http://b.tile.openstreetmap.org/{LOD}/{X}/{Y}.png"},{id:"s3",url:"http://c.tile.openstreetmap.org/{LOD}/{X}/{Y}.png"}]}],MapLayerStacks:[{name:"DEFAULT",MapLayer:{name:"Open Street Map Layer",refMapProvider:"OPENSTREETMAP",opacity:"1",colBkgnd:"RGB(255,255,255)"}}]};try{jQuery.sap.require("sap.ui.vk.MapContainer","sap.ui.vk.ContainerContent");t.MapContainer=sap.ui.vk.MapContainer;t.ContainerContent=sap.ui.vk.ContainerContent;}catch(e){}var a=S.getInstance().mapProvider;if(a!==undefined&&typeof(a)==="object"&&a.name&&a.name.length>0){m.MapProvider.push(a);m.MapLayerStacks[0].MapLayer.refMapProvider=a.name;}t.geoMap=new sap.ui.vbm.GeoMap("sapUshellSearchGeoMap",{legendVisible:false,scaleVisible:false,refMapLayerStack:"DEFAULT",mapConfiguration:m});if(t.MapContainer&&t.ContainerContent){var c=new t.ContainerContent({content:t.geoMap});this.myMapContainer=new t.MapContainer({content:[c],showRectangularZoom:true,showHome:true,showFullScreen:false,showSettings:false,showSelection:false});t.myMap=t.myMapContainer.getContent()[0].getAggregation("content");t.setAggregation("_map",this.myMapContainer);}else{t.setAggregation("_map",t.geoMap);t.myMap=t.getAggregation("_map");}},renderer:function(r,c){c.loadObjects(c);r.write("<div ");r.writeControlData(c);r.addClass("sapUshellSearchResultMap");r.writeClasses();r.write(">");if(c.MapContainer){r.renderControl(c.myMapContainer);}else{r.renderControl(c.myMap);}r.write("</div>");},deg2rad:function(d){return Math.PI*d/180;},getSpotList:function(){var t=this;var s=new sap.ui.vbm.Containers();var r=t.getModel().oData.boResults;var n=0;var R,l,T,c,a,b,d,m,e,f,g,i;for(i=0;i<r.length;i++){R=r[i];l={};if(!R.geoJson){continue;}if(typeof R.geoJson.value==="string"){l=JSON.parse(R.geoJson.value);}else{l.coordinates=R.geoJson.value.coordinates;}T=R.geoJson.label;if(T==="LOC_4326"||T==="LOCATION"||T===undefined){T=R.title;}if(T==="LOC_4326"||T==="LOCATION"||T===undefined){for(var j=0;j<R.itemattributes.length;j++){if(R.itemattributes[j].isTitle===true){T=R.itemattributes[j].value;break;}}}if(T===undefined||typeof T!=="string"){T="unlabeled location";}else{T=T.replace(/<[^>]*>/g,"");}c=l.coordinates;if(!c||c.length===0){continue;}a=c[0];b=c[1];if(isNaN(b)||isNaN(a)){continue;}n++;if(n===1){m=a;e=a;f=b;g=b;}else{if(a<m){m=a;}if(a>e){e=a;}if(b<f){f=b;}if(b>g){g=b;}}t.minLon=m;t.maxLon=e;t.minLat=f;t.maxLat=g;var o=new sap.m.Button({text:T});var B=new sap.m.Button({icon:"sap-icon://map",type:sap.m.ButtonType.Emphasized});var h=new sap.ui.layout.HorizontalLayout({content:[B,o]});d=new sap.ui.vbm.Container({position:a+";"+b+";0",item:h,alignment:6});s.addItem(d);}t.iNrLocations=n;if(n===0){s=t.getSpotList2();}return s;},getSpotList2:function(c){var t=this;var r=t.getModel().oData.origBoResults.elements;var R,l,T,C,a,b,s;var d=new sap.ui.vbm.Containers();var n=0;var m,f,g,h;var i=0;for(var k in r){if(!r.hasOwnProperty(k)){continue;}R=r[k];if(!R.LOC_4326){continue;}l=R.LOC_4326;for(var o in R){if(!R.hasOwnProperty(o)){continue;}var A=R[o];T="";var p=false;if(A.$$MetaData$$){var q=A.$$MetaData$$.presentationUsage;if(q&&typeof q.length!=="undefined"){for(var j=0;j<q.length;j++){if(q[j]=="Title"){T=A.value;T=T.replace(/<[^>]*>/g,"");p=true;break;}}}}if(p){break;}}C=null;try{C=JSON.parse(l.value).coordinates;}catch(e){}if(!C||C.length===0){continue;}n++;a=C[0];b=C[1];if(isNaN(b)||isNaN(a)){continue;}i++;if(i===1){m=a;f=a;g=b;h=b;}else{if(a<m){m=a;}if(a>f){f=a;}if(b<g){g=b;}if(b>h){h=b;}}t.minLon=m;t.maxLon=f;t.minLat=g;t.maxLat=h;var v=new sap.m.Button({text:T});var B=new sap.m.Button({icon:"sap-icon://map",type:sap.m.ButtonType.Emphasized});var w=new sap.ui.layout.HorizontalLayout({content:[B,v]});s=new sap.ui.vbm.Container({position:a+";"+b+";0",item:w,alignment:6});d.addItem(s);}t.iNrLocations=n;return d;},loadObjects:function(c){var t=this;var s=t.getSpotList();L.debug("++++++");L.debug("number of locations: "+t.iNrLocations);t.myMap.removeAllVos();t.myMap.addVo(s);var p=S.prototype.parseUrlParameters();for(var a in p){if(a==="box"&&p[a]!=="false"){t.showBoundariesAndCenter();}}},setVisualFrame:function(){var t=this;var v={};v.minLon=t.minLon*0.5;v.maxLon=t.maxLon*1.2;v.minLat=t.minLat*0.8;v.maxLat=t.maxLat*1.2;t.myMap.setVisualFrame(v);},showBoundariesAndCenter:function(){var t=this;var c=new sap.ui.vbm.Spots({items:[new sap.ui.vbm.Spot({type:"Error",text:"center",position:(t.centerLon+" ;  "+t.centerLat+";0")}),new sap.ui.vbm.Spot({type:"Error",text:"TLeft",position:(t.minLon+" ;  "+t.maxLat+";0")}),new sap.ui.vbm.Spot({type:"Error",text:"TRight",position:(t.maxLon+" ;  "+t.maxLat+";0")}),new sap.ui.vbm.Spot({type:"Error",text:"BLeft",position:(t.minLon+" ;  "+t.minLat+";0")}),new sap.ui.vbm.Spot({type:"Error",text:"BRight",position:(t.maxLon+" ;  "+t.minLat+";0")})]});t.myMap.addVo(c);},resizeMap:function(e){var h=$(".sapUshellSearchResultListsContainer").parent().parent().height();h=0.85*h;h=""+h+"px";sap.ui.getCore().byId("sapUshellSearchGeoMap").setHeight(h);var w=$(".sapUshellSearchResultListsContainer").parent().parent().width();w=""+w+"px";sap.ui.getCore().byId("sapUshellSearchGeoMap").setWidth(w);},onAfterRendering:function(e){var t=this;t.resizeMap();window.onresize=t.resizeMap;}});});
