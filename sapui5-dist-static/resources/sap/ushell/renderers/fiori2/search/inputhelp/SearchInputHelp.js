// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/ushell/renderers/fiori2/search/SearchHelper","sap/ushell/renderers/fiori2/search/inputhelp/SearchInputHelpDialog","sap/ushell/renderers/fiori2/search/suggestions/SuggestionType","sap/ushell/renderers/fiori2/search/controls/SearchObjectSuggestionImage"],function(u,S,a,b,c){"use strict";sap.m.MultiInput.extend("sap.ushell.renderers.fiori2.search.inputhelp.SearchInputHelp",{metadata:{properties:{dataSource:"string",displayAttribute:"string"}},constructor:function(o){var t=this;o=jQuery.extend({},{liveChange:t.handleLiveChange,showSuggestion:true,filterSuggests:false,suggestionColumns:[new sap.m.Column({})],suggestionItemSelected:t.handleSuggestionItemSelected,showValueHelp:true},o);sap.m.MultiInput.prototype.constructor.apply(this,[o]);t.addStyleClass("sapUshellSearchInputHelp");t.bindAggregation("suggestionRows","/suggestions",function(i,C){return t.suggestionItemFactory(i,C);});t.attachValueHelpRequest(function(){t.dialog=new a({inputHelp:t,displayAttribute:t.getDisplayAttribute()});t.oModel=sap.ushell.renderers.fiori2.search.getModelSingleton();t.dialog.setModel(t.oModel);t.dialog.setModel(sap.ushell.resources.i18nModel,"i18n");t.dialog.open();var s="";if(s.trim()===""){s="*";}t.oModel.setSearchBoxTerm(s,false);t.dialog.oSearchFieldGroup.input.setValue(s);t.oModel._firePerspectiveQuery();});},handleLiveChange:function(e){var s=this.getValue();var m=this.getModel();m.setSearchBoxTerm(s,false);if(m.getSearchBoxTerm().length>0){m.doSuggestion();}else{this.destroySuggestionRows();m.abortSuggestions();}},suggestionItemFactory:function(i,C){var s=C.getObject();switch(s.uiSuggestionType){case b.Object:return this.objectSuggestionItemFactory(i,C);case b.BusyIndicator:return this.busyIndicatorItemFactory(i,C);default:}},objectSuggestionItemFactory:function(i,C){var s=C.getObject();var d=[];if(s.imageExists){d.push(new c({src:"{imageUrl}",isCircular:"{imageIsCircular}"}));}d.push(this.assembleObjectSuggestionLabels(s));var e=new sap.ui.layout.HorizontalLayout({content:d});e.addStyleClass("sapUshellSearchObjectSuggestion-Container");e.getText=function(){return this.getValue();}.bind(this);var l=new sap.m.ColumnListItem({cells:[e],type:"Active"});l.addStyleClass("searchSuggestion");l.addStyleClass("searchObjectSuggestion");return l;},busyIndicatorItemFactory:function(i,C){var d=new sap.ui.layout.VerticalLayout({content:[new sap.m.BusyIndicator({size:"0.6rem"})]});d.getText=function(){return this.getValue();}.bind(this);var l=new sap.m.ColumnListItem({cells:[d],type:"Active"});l.addStyleClass("searchSuggestion");l.addStyleClass("searchBusyIndicatorSuggestion");return l;},assembleObjectSuggestionLabels:function(s){var l=[];if(!s.label1){var d=this.getDisplayAttribute();if(d){for(var i=0;i<s.object.detailAttributes.length;i++){var e=s.object.detailAttributes[i];if(e.id===d){s.label1=e.value;}}}}var f=new sap.m.Label({text:"{label1}"});f.addEventDelegate({onAfterRendering:function(){S.boldTagUnescaper(this.getDomRef());}},f);f.addStyleClass("sapUshellSearchObjectSuggestion-Label1");l.push(f);if(s.label2){var g=new sap.m.Label({text:"{label2}"});g.addEventDelegate({onAfterRendering:function(){S.boldTagUnescaper(this.getDomRef());}},g);g.addStyleClass("sapUshellSearchObjectSuggestion-Label2");l.push(g);}var L=new sap.ui.layout.VerticalLayout({content:l});L.addStyleClass("sapUshellSearchObjectSuggestion-Labels");return L;},handleSuggestionItemSelected:function(e){var m=this.getModel();var s=m.getSearchBoxTerm();var d;if(e.getId()==="AutoSelectAppSuggestion"){d=e.getParameter("suggestion");}else{d=e.getParameter("selectedRow").getBindingContext().getObject();}var f=d.searchTerm||"";var g=d.dataSource||m.getDataSource();var t=d.url;var h=d.uiSuggestionType;m.eventLogger.logEvent({type:m.eventLogger.SUGGESTION_SELECT,suggestionType:h,suggestionTerm:f,searchTerm:s,targetUrl:t,dataSourceKey:g?g.id:""});this.selectText(0,0);d.value=d.label;var j=this.getDisplayAttribute();if(j){for(var i=0;i<d.object.detailAttributes.length;i++){var k=d.object.detailAttributes[i];if(k.id===j){d.value=k.value;}}}this.addAggregation("tokens",new sap.m.Token({text:d.value,key:d.value}));m.setProperty("/inputHelpSelectedItems",[d]);this.fireChange();},selectDataSource:function(){var m=this.getModel();var d=this.getDataSource();var e=m.getProperty("/dataSources");if(m.getDataSource().id!==d){for(var i=0;i<e.length;i++){var f=e[i];if(d===f.id){m.setDataSource(f,false);break;}}}},renderer:"sap.m.MultiInputRenderer"});});
