// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/m/library","sap/m/Page","sap/ui/core/AccessibleLandmarkRole","sap/ui/core/mvc/View","sap/ui/Device","sap/ui/model/Filter","sap/ushell/components/homepage/DashboardGroupsBox","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/ui/launchpad/AnchorItem","sap/ushell/ui/launchpad/AnchorNavigationBar","sap/ushell/utils","sap/ui/core/Component","sap/ui/model/FilterOperator","sap/ushell/renderers/fiori2/AccessKeysHandler","sap/m/MessageStrip"],function(q,m,P,A,V,D,F,a,C,E,r,b,c,u,d,e,f,M){"use strict";sap.ui.jsview("sap.ushell.components.homepage.DashboardContent",{createContent:function(o){this.oModel=this.getModel();var g=this.oModel.getProperty("/personalization"),h=this.oModel.getProperty("/enableTileActionsIcon"),H=sap.ushell.components.getHomepageManager?sap.ushell.components.getHomepageManager():undefined;this.isCombi=D.system.combi;this.isTouch=this.isCombi?false:(D.system.phone||D.system.tablet);this.parentComponent=d.getOwnerComponentFor(this);this.addStyleClass("sapUshellDashboardView");this.ieHtml5DnD=g&&H&&H.isIeHtml5DnD();this.oRenderer=sap.ushell.Container.getRenderer("fiori2");this.bIsHomeIntentRootIntent=u.isFlpHomeIntent(this.oRenderer.getShellConfig().rootIntent);sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeInactive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeActive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().subscribe("launchpad","contentRefresh",this._onDashboardShown,this);sap.ui.getCore().getEventBus().subscribe("launchpad","dashboardModelContentLoaded",this._onDashboardShown,this);this.oDoable=E.once("CoreResourcesComplementLoaded").do(function(){this.oAnchorNavigationBar.setOverflowEnabled(true);if(g||h){sap.ui.require(["sap/ushell/components/homepage/ActionMode"],function(k){k.init(this.oModel);}.bind(this));}if(g){this._createFooter();this._createActionModeButton();}}.bind(this));this.oFilterSelectedGroup=new F("isGroupSelected",e.EQ,true);this.oRenderer.getRouter().getRoute("home").attachMatched(this._onHomeNavigation,this);this.oAnchorNavigationBar=this._getAnchorNavigationBar(o);var p=[];if(C.last("/core/home/gridContainer")){var i=new M({type:"Warning",text:r.i18n.getText("gridModeWarning"),showIcon:true,showCloseButton:true});i.addStyleClass("sapUiMediumMarginBeginEnd");i.addStyleClass("sapUiMediumMarginTopBottom");p.push(i);}var j=new a();this.oDashboardGroupsBox=j.createGroupsBox(o,this.oModel);p.push(this.oDashboardGroupsBox);this.oPage=new P("sapUshellDashboardPage",{customHeader:this.oAnchorNavigationBar,landmarkInfo:{headerRole:A.Navigation,headerLabel:r.i18n.getText("Dashboard.Page.Header.AriaLabel"),contentRole:sap.ui.core.AccessibleLandmarkRole.Region,contentLabel:r.i18n.getText("Dashboard.Page.Content.AriaLabel"),rootRole:A.None},floatingFooter:true,content:p});this.oPage.addEventDelegate({onAfterRendering:function(){var k=this.getDomRef(),s=k.getElementsByTagName("section");q(s[0]).off("scrollstop",o.handleDashboardScroll);q(s[0]).on("scrollstop",o.handleDashboardScroll);}.bind(this)});return this.oPage;},getAnchorItemTemplate:function(){var t=this;var o=new b({index:"{index}",title:"{title}",groupId:"{groupId}",defaultGroup:"{isDefaultGroup}",helpId:"{helpId}",selected:false,isGroupRendered:"{isRendered}",visible:{parts:["/tileActionModeActive","isGroupVisible","visibilityModes"],formatter:function(g,i,v){if(!v[g?1:0]){return false;}return i||g;}},locked:"{isGroupLocked}",isGroupDisabled:{parts:["isGroupLocked","/isInDrag","/homePageGroupDisplay"],formatter:function(i,I,s){return i&&I&&s==="tabs";}},press:function(g){t.oAnchorNavigationBar.handleAnchorItemPress(g);}});o.attachBrowserEvent("focus",function(){this.setNavigationBarItemsVisibility();}.bind(this.oAnchorNavigationBar));return o;},_getAnchorNavigationBar:function(o){var g=new c("anchorNavigationBar",{selectedItemIndex:"{/topGroupInViewPortIndex}",itemPress:[function(h){this._handleAnchorItemPress(h);},o],overflowEnabled:false});if(D.system.desktop){g.addEventDelegate({onBeforeFastNavigationFocus:this._handleBeforeFastNavigationFocus,onsapenter:function(h){h.srcControl.getDomRef().click();},onsapspace:function(h){h.srcControl.getDomRef().click();}});}g.addStyleClass("sapContrastPlus");return g;},_handleBeforeFastNavigationFocus:function(o){if(q(".sapUshellAnchorItem").is(":visible")){o.preventDefault();sap.ushell.components.ComponentKeysHandler.goToSelectedAnchorNavigationItem();}},_actionModeButtonPress:function(){this.oDashboardGroupsBox.getBinding("groups").filter([]);var g=this.oDashboardGroupsBox.getGroups();sap.ushell.components.homepage.ActionMode.toggleActionMode(this.oModel,"Menu Item",g);this._updateAnchorNavigationBarVisibility();if(this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){if(this.oModel.getProperty("/tileActionModeActive")){var G=this.oModel.getProperty("/groups"),s;for(var i=0;i<G.length;i++){if(G[i].isGroupSelected){s=i;break;}}this.getController()._scrollToGroup("launchpad","scrollToGroup",{group:{getGroupId:function(){return G[s].groupId;}},groupChanged:false,focus:true});}else{this.getController()._deactivateActionModeInTabsState();}}},_createActionModeButton:function(){var o={id:"ActionModeBtn",text:r.i18n.getText("activateEditMode"),tooltip:r.i18n.getText("activateEditMode"),icon:"sap-icon://edit",press:this._actionModeButtonPress.bind(this)};var g=this.oRenderer.getShellConfig().moveEditHomePageActionToShellHeader;if(g){this._createActionModeButtonInHeader(o);}else{this._createActionModeButtonInUserMenu(o);}},_createActionModeButtonInHeader:function(o){sap.ui.require(["sap/ushell/ui/shell/ShellHeadItem"],function(S){this.oTileActionsButton=new S(o);if(C.last("/core/extension/enableHelp")){this.oTileActionsButton.addStyleClass("help-id-ActionModeBtn");}if(!this.bIsHomeIntentRootIntent){this.oRenderer.showHeaderEndItem(this.oTileActionsButton.getId(),true);}else{this.oRenderer.showHeaderEndItem(this.oTileActionsButton.getId(),false,["home"]);}}.bind(this));},_createActionModeButtonInUserMenu:function(o){var g={controlType:"sap.ushell.ui.launchpad.ActionItem",oControlProperties:o,bIsVisible:true,aStates:["home"]};if(!this.bIsHomeIntentRootIntent){g.aStates=null;g.bCurrentState=true;}this.oRenderer.addUserAction(g).done(function(h){this.oTileActionsButton=h;if(C.last("/core/extension/enableHelp")){this.oTileActionsButton.addStyleClass("help-id-ActionModeBtn");}}.bind(this));},_handleEditModeChange:function(){if(this.oTileActionsButton){this.oTileActionsButton.toggleStyleClass("sapUshellAcionItemActive");}},_createFooter:function(){sap.ui.require(["sap/m/Bar","sap/m/Button","sap/m/ToolbarSpacer"],function(B,g,T){var o=new B("sapUshellDashboardFooter",{visible:"{/tileActionModeActive}",contentRight:[new T()]});var h=new g("sapUshellDashboardFooterDoneBtn",{type:m.ButtonType.Emphasized,text:r.i18n.getText("closeEditMode"),tooltip:r.i18n.getText("exitEditMode"),press:this._actionModeButtonPress.bind(this)});if(D.system.desktop){h.addEventDelegate({onsapskipforward:function(i){i.preventDefault();f.setIsFocusHandledByAnotherHandler(true);f.sendFocusBackToShell(i);},onsapskipback:function(i){i.preventDefault();f.setIsFocusHandledByAnotherHandler(true);sap.ushell.components.ComponentKeysHandler.goToFirstVisibleTileContainer();},onsaptabprevious:function(i){i.preventDefault();f.setIsFocusHandledByAnotherHandler(true);sap.ushell.components.ComponentKeysHandler.goToFirstVisibleTileContainer();},onsaptabnext:function(i){i.preventDefault();f.setIsFocusHandledByAnotherHandler(true);f.sendFocusBackToShell(i);}});}o.addContentRight(h);this.oPage.setFooter(o);}.bind(this));},_onDashboardShown:function(){var i=this.oRenderer&&this.oRenderer.getCurrentCoreView()==="home";if(i){if(!D.system.phone){this.oRenderer.showRightFloatingContainer(false);}this._updateAnchorNavigationBarVisibility();this.getController().resizeHandler();u.refreshTiles();if(D.system.desktop&&sap.ushell.components.ComponentKeysHandler){sap.ushell.components.ComponentKeysHandler.goToTileContainer();}if(E.last("firstSegmentCompleteLoaded")){E.emit("CloseFesrRecord",Date.now());}}},_onHomeNavigation:function(){this._onDashboardShown();if(!this.bIsHomeIntentRootIntent){if(this.oRenderer.getShellConfig().moveEditHomePageActionToShellHeader){this.oRenderer.showHeaderEndItem(this.oTileActionsButton.getId(),true);}else{this.oRenderer.showActionButton(this.oTileActionsButton.getId(),true);}}},_updateAnchorNavigationBarVisibility:function(){var o=this.oPage.getShowHeader(),g=this.getModel().getObject("/tileActionModeActive"),v=this.getModel().getProperty("/groups").filter(function(j){if(g){return j.isGroupVisible&&j.visibilityModes[1];}else{return j.isGroupVisible&&j.visibilityModes[0];}}),h=v.length>1;this.oPage.setShowHeader(h);if(h&&!o){var G=this.getModel().getProperty("/groups"),s=this.getModel().getProperty("/iSelectedGroup");for(var i=0;i<v.length;i++){if(v[i].getGroupId&&v[i].getGroupId()===G[s].groupId){this.oAnchorNavigationBar.setSelectedItemIndex(i);break;}}}},getControllerName:function(){return"sap.ushell.components.homepage.DashboardContent";},exit:function(){V.prototype.exit.apply(this,arguments);if(this.oAnchorNavigationBar){this.oAnchorNavigationBar.handleExit();this.oAnchorNavigationBar.destroy();}if(this.oTileActionsButton){this.oTileActionsButton.destroy();}if(this.oDoable){this.oDoable.off();}if(this.oDoneBtnLabel){this.oDoneBtnLabel.destroy();}sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeInactive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeActive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","contentRefresh",this._onDashboardShown,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","dashboardModelContentLoaded",this._onDashboardShown,this);}});},false);
