// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/Object","sap/ushell/Layout","sap/ui/Device","sap/ui/thirdparty/jquery","sap/base/Log"],function(b,L,D,q,a){"use strict";var c=b.extend("sap.ushell.components.homepage.DashboardUIActions",{metadata:{publicMethods:["initializeUIActions"]},constructor:function(){this.aTabBarItemsLocation=[];if(sap.ushell.components.homepage.getDashboardUIActions&&sap.ushell.components.homepage.getDashboardUIActions()){return sap.ushell.components.homepage.getDashboardUIActions();}sap.ushell.components.homepage.getDashboardUIActions=(function(v){return function(){return v;};}(this.getInterface()));this.oTileUIActions=undefined;this.oLinkUIActions=undefined;this.oGroupUIActions=undefined;this.oController=undefined;this.UIActionsInitialized=false;sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeActive",this._enableGroupUIActions,this);sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeInactive",this._disableGroupUIActions,this);},destroy:function(){sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeActive",this._enableGroupUIActions,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeInactive",this._disableGroupUIActions,this);sap.ushell.components.homepage.getDashboardUIActions=undefined;this.oGroupUIActions=null;this.oTileUIActions=null;this.oLinkUIActions=null;},initializeUIActions:function(C){this.oController=C;if(C.getView().getModel().getProperty("/homePageGroupDisplay")==="tabs"){this._fillTabBarItemsArray();}var i=sap.ushell.Container?sap.ushell.Container.getService("LaunchPage").isLinkPersonalizationSupported():null;var p=q("#sapUshellDashboardPage").width();var d=C.getView().sDashboardGroupsWrapperId,A,r=sap.ui.getCore().getConfiguration().getRTL(),o={containerSelector:"#dashboardGroups",wrapperSelector:d?"#"+d:undefined,rootSelector:"#shell"},e=q.extend(true,{},o,{switchModeDelay:1000,isTouch:C.getView().isTouch,isCombi:C.getView().isCombi,debug:false}),l={draggableSelector:".sapUshellLinkTile",placeHolderClass:"sapUshellLinkTile-placeholder",cloneClass:"sapUshellLinkTile-clone",startCallback:this._handleTileUIStart.bind(this),endCallback:this._handleLinkDrop.bind(this),dragCallback:this._handleStartDragTile.bind(this),onBeforeCreateClone:this._onBeforeCreateLinkClone.bind(this),dragAndScrollCallback:this._handleTileDragMove.bind(this),endDragAndScrollCallback:this._handleTileDragAndScrollContinuation.bind(this),moveTolerance:C.getView().isTouch||C.getView().isCombi?10:3,isLayoutEngine:true,disabledDraggableSelector:"sapUshellLockedTile",onDragStartUIHandler:this._markDisableGroups.bind(this),onDragEndUIHandler:this._endUIHandler.bind(this),offsetLeft:r?p:-p,defaultMouseMoveHandler:function(){}},t={draggableSelector:".sapUshellTile",draggableSelectorExclude:".sapUshellPlusTile",placeHolderClass:"sapUshellTile-placeholder",cloneClass:"sapUshellTile-clone",deltaTop:-44,scrollContainerSelector:undefined,startCallback:this._handleTileUIStart.bind(this),endCallback:this._handleTileDrop.bind(this),dragCallback:this._handleStartDragTile.bind(this),dragAndScrollCallback:this._handleTileDragMove.bind(this),endDragAndScrollCallback:this._handleTileDragAndScrollContinuation.bind(this),moveTolerance:C.getView().isTouch||C.getView().isCombi?10:3,isLayoutEngine:true,disabledDraggableSelector:"sapUshellLockedTile",onDragStartUIHandler:this._markDisableGroups.bind(this),onDragEndUIHandler:this._endUIHandler.bind(this),offsetLeft:r?p:-p,defaultMouseMoveHandler:function(){}},g={draggableSelector:".sapUshellDashboardGroupsContainerItem:not(.sapUshellDisableDragAndDrop)",draggableSelectorBlocker:".sapUshellTilesContainer-sortable, .sapUshellTileContainerBeforeContent, .sapUshellTileContainerAfterContent",draggableSelectorExclude:".sapUshellHeaderActionButton",placeHolderClass:"sapUshellDashboardGroupsContainerItem-placeholder",cloneClass:"sapUshellDashboardGroupsContainerItem-clone",startCallback:this._handleGroupsUIStart.bind(this),endCallback:this._handleGroupDrop.bind(this),dragCallback:this._handleGroupStartDrag.bind(this),moveTolerance:C.getView().isTouch||C.getView().isCombi?10:0.1,isLayoutEngine:false,isVerticalDragOnly:true,draggableElement:".sapUshellTileContainerHeader"},w={type:"tiles",draggableSelector:".sapUshellTile",placeHolderClass:"sapUshellTile-placeholder",cloneClass:"sapUshellTile-clone",startCallback:this._handleTileUIStart.bind(this),endCallback:this._handleTileDrop.bind(this),dragCallback:this._handleStartDragTile.bind(this),dragAndScrollCallback:this._handleTileDragMove.bind(this),onDragStartUIHandler:this._markDisableGroups.bind(this),onDragEndUIHandler:this._endUIHandler.bind(this),offsetLeft:r?p:-p},W={type:"links",draggableSelector:".sapUshellLinkTile",placeHolderClass:"sapUshellLinkTile-placeholder",startCallback:this._handleTileUIStart.bind(this),endCallback:this._handleLinkDrop.bind(this),dragCallback:this._handleStartDragTile.bind(this),dragAndScrollCallback:this._handleTileDragMove.bind(this),onBeforeCreateClone:this._onBeforeCreateLinkClone.bind(this),onDragStartUIHandler:this._markDisableGroups.bind(this),onDragEndUIHandler:this._endUIHandler.bind(this),offsetLeft:r?p:-p},f={type:"groups",draggableSelector:".sapUshellTileContainerHeader",placeHolderClass:"sapUshellDashboardGroupsContainerItem-placeholder",_publishAsync:C._publishAsync};if(C.getView().oDashboardGroupsBox.getGroups().length){if(C.getView().getModel().getProperty("/personalization")){if(!C.getView().ieHtml5DnD){sap.ui.require(["sap/ushell/UIActions"],function(U){this._disableTileUIActions();this._disableGroupUIActions();this._disableLinkUIActions();this.oTileUIActions=new U(q.extend(true,{},e,t)).enable();this.oGroupUIActions=new U(q.extend(true,{},e,g));if(i){this.oLinkUIActions=new U(q.extend(true,{},e,l)).enable();}A=C.getView().getModel().getProperty("/tileActionModeActive");if(A){this.oGroupUIActions.enable();}}.bind(this));}else{sap.ui.require(["sap/ushell/UIActionsWin8"],function(U){this._disableTileUIActions();this._disableGroupUIActions();this._disableLinkUIActions();this.oTileUIActions=U.getInstance(q.extend(true,{},o,w)).enable();this.oLinkUIActions=U.getInstance(q.extend(true,{},o,W)).enable();this.oGroupUIActions=U.getInstance(q.extend(true,{},o,f)).enable();}.bind(this));}}}},_enableGroupUIActions:function(){if(this.oGroupUIActions){this.oGroupUIActions.enable();}},disableAllDashboardUiAction:function(){this._disableTileUIActions();this._disableLinkUIActions();this._disableGroupUIActions();},_disableTileUIActions:function(){if(this.oTileUIActions){this.oTileUIActions.disable();}},_disableLinkUIActions:function(){if(this.oLinkUIActions){this.oLinkUIActions.disable();}},_disableGroupUIActions:function(){if(this.oGroupUIActions){this.oGroupUIActions.disable();}},_handleTileDragMove:function(d){if(!d.isScrolling){L.getLayoutEngine().moveDraggable(d.moveX,d.moveY,this.aTabBarItemsLocation);}},_handleTileDragAndScrollContinuation:function(m){var A=q("#anchorNavigationBar").offset(),i=A?A.top:0;if(m<i){L.getLayoutEngine()._cancelLongDropTimmer();}return L.getLayoutEngine()._isTabBarCollision(m);},_fillTabBarItemsArray:function(){var i=q(".sapUshellAnchorItem"),l=i.length,d,B=10,t=0,T,e=[],I,o,f,n;for(d=0;d<l;d++){I=i[d];o=I.getBoundingClientRect();e[d]=o.width;}for(d=0;d<l;d++){f=e[d];if(f===0){continue;}n=Math.round(f/B);for(T=t;T<t+n;T++){this.aTabBarItemsLocation[T]=d;}t=T;}},_handleTileUIStart:function(e,u){if((D.browser.msie)&&((navigator.msMaxTouchPoints>0)||(navigator.maxTouchPoints>0))){this.titleElement=u.querySelector("[title]");if(this.titleElement){this.titleElement.setAttribute("data-title",this.titleElement.getAttribute("title"));this.titleElement.removeAttribute("title");}}},_preventTextSelection:function(){if(window.getSelection){var s=window.getSelection();try{s.removeAllRanges();}catch(e){}}},_handleStartDragTile:function(e,t){this._preventTextSelection();L.getLayoutEngine().layoutStartCallback(t);L.initDragMode();q(t).find("a").removeAttr("href");this.oController._handleDrag.call(this.oController,e,t);sap.ui.getCore().getEventBus().publish("launchpad","sortableStart");},_onBeforeCreateLinkClone:function(e,d){L.getLayoutEngine().saveLinkBoundingRects(d);},_handleLinkDrop:function(e,t,A){var d=q.Deferred(),p;if(L.isTabBarActive()){L.tabBarTileDropped();}if(A&&A.clone){q(A.clone).css({opacity:0});}if((D.browser.msie)&&((navigator.msMaxTouchPoints>0)||(navigator.maxTouchPoints>0))&&this.titleElement){this.titleElement.setAttribute("title",this.titleElement.getAttribute("data-title"));}if(D.desktop){q("body").removeClass("sapUshellDisableUserSelect");}if(L.getLayoutEngine().isLinkIntersected()||L.getLayoutEngine().isOriginalAreaChanged()){p=this.oController._handleDrop.call(this.oController,e,t);}if(p){p.then(function(){q("#dashboardGroups .sapUshellHidePlusTile").removeClass("sapUshellHidePlusTile");setTimeout(function(){d.resolve();},300);});}else{setTimeout(function(){d.resolve();},0);}return d.promise();},_handleTileDrop:function(e,t,A){if(L.getLayoutEngine().isOriginalAreaChanged()){return this._handleTileToLinkDrop(e,t,A);}return this._handleTileToTileDrop(e,t,A);},_handleTileToLinkDrop:function(e,t,A){return this._handleLinkDrop(e,t,A);},_handleTileToTileDrop:function(e,t,A){var C,h,T,d=function(e,t){L.endDragMode();q("#dashboardGroups .sapUshellHidePlusTile").removeClass("sapUshellHidePlusTile");if((D.browser.msie)&&((navigator.msMaxTouchPoints>0)||(navigator.maxTouchPoints>0))&&this.titleElement){this.titleElement.setAttribute("title",this.titleElement.getAttribute("data-title"));}this.oController._handleDrop.call(this.oController,e,t);if(D.desktop){q("body").removeClass("sapUshellDisableUserSelect");}};h=q(".sapUshellTabBarHoverOn");h.removeClass("sapUshellTabBarHoverOn");T=q(".sapUshellTileDragOpacity");T.removeClass("sapUshellTileDragOpacity");if(L.isTabBarActive()){L.tabBarTileDropped();}var o;if(L.isTabBarActive()&&L.isOnTabBarElement()){if(A&&A.clone){o=q.Deferred();C=q(A.clone);C.css("display","none");setTimeout(function(){o.resolve();d.call(this,e,t);}.bind(this),300);return o.promise();}d.apply(this,arguments);}if(A&&A.clone){o=q.Deferred();C=q(A.clone);var f=A.clone.getBoundingClientRect();var p=t.getBoundingClientRect();var s=C.css("transform").split(",");var g=p.top-f.top;var i=p.left-f.left;var j=parseInt(s[4],10)+i;var k=parseInt(s[5],10)+g;C.css({transform:"translate3d("+j+"px, "+k+"px, 0px)",transition:"transform 300ms cubic-bezier(0.46, 0, 0.44, 1)"});setTimeout(function(){o.resolve();d.call(this,e,t);}.bind(this),300);return o.promise();}setTimeout(function(){d.call(this,e,t);}.bind(this),300);},_getTileTopOffset:function(t,p,d){var i=0,T=i+d;T+=t.closest(".sapUshellDashboardGroupsContainerItem").position().top;T+=p.top;return T;},_markDisableGroups:function(){if(this.oController.getView().getModel()){this.oController.getView().getModel().setProperty("/isInDrag",true);}},_endUIHandler:function(){L.endDragMode();if(this.oController.getView().getModel()){this.oController.getView().getModel().setProperty("/isInDrag",false);}},_handleGroupStartDrag:function(e,u){this.oTileUIActions.disable();if(this.oLinkUIActions){this.oLinkUIActions.disable();}var g=q(".sapUshellDashboardGroupsContainerItem-clone"),d=g.find(".sapUshellContainerTitle"),t=d.height(),f=d.width(),h,i,j,s,r=sap.ui.getCore().getConfiguration().getRTL();if(!D.system.phone){g.find(".sapUshellTileContainerEditMode").offset({top:this.oGroupUIActions.getMove().y-t,left:r?q("#sapUshellDashboardPage").width()+this.oGroupUIActions.getMove().x+f:this.oGroupUIActions.getMove().x-(f/2)});q(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerHidden");}else{q(".sapUshellTilesContainer-sortable").addClass("sapUshellTileContainerRemoveContent");q(".sapUshellLineModeContainer, .sapUshellLinksContainer").addClass("sapUshellTileContainerRemoveContent");q(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerRemoveContent");q(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden");}q(".sapUshellTileContainerAfterContent").addClass("sapUshellTileContainerRemoveContent");q(u).find(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden");this.oController.getView().getModel().setProperty("/isInDrag",true);q(u).attr("startPos",q(u).index());a.info("startPos - "+q(u).index());setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","sortableStart");},0);h=q("#dashboardGroups").offset().top;i=q(".sapUshellDashboardGroupsContainerItem-placeholder").offset().top;j=q(".sapUshellDashboardGroupsContainerItem-clone").offset().top;s=i-h-j;q(".sapUshellDashboardView section").css({scrollTop:s});},_handleGroupsUIStart:function(e,u){q(u).find(".sapUshellTileContainerContent").css("outline-color","transparent");},_handleGroupDrop:function(e,u){var B=sap.ui.getCore().getEventBus(),Q=q(u),f=q(Q.children()[0]).attr("id"),g=sap.ui.getCore().byId(f),d=sap.ui.getCore().byId("dashboardGroups"),o={group:g,groupChanged:false,focus:false},n=Q.index();Q.startPos=window.parseInt(Q.attr("startPos"),10);d.removeAggregation("groups",g,true);d.insertAggregation("groups",g,n,true);this._handleGroupMoved(e,{item:Q});Q.removeAttr("startPos");sap.ui.getCore().getEventBus().publish("launchpad","sortableStop");setTimeout(function(){q(".sapUshellContainerHeaderActions").removeClass("sapUshellTileContainerHidden");q(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerHidden");q(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerRemoveContent");q(".sapUshellTileContainerAfterContent").removeClass("sapUshellTileContainerRemoveContent");q(".sapUshellTilesContainer-sortable").removeClass("sapUshellTileContainerRemoveContent");q(".sapUshellLineModeContainer, .sapUshellLinksContainer").removeClass("sapUshellTileContainerRemoveContent");},0);window.setTimeout(q.proxy(B.publish,B,"launchpad","scrollToGroup",o),1);this.oTileUIActions.enable();if(this.oLinkUIActions){this.oLinkUIActions.enable();}},_handleGroupMoved:function(e,u){var f=u.item.startPos,t=u.item.index(),m=this.oController.getView().getModel();if(t!==-1){this.oController._publishAsync("launchpad","moveGroup",{fromIndex:f,toIndex:t});setTimeout(function(){m.setProperty("/isInDrag",false);},100);}},_setController:function(C){this.oController=C;}});return c;});
