// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/library","sap/m/MessageToast","sap/ushell/resources"],function(q,c,M,r){"use strict";var V=c.mvc.ViewType;sap.ui.controller("sap.ushell.components.appfinder.HierarchyApps",{onInit:function(){var e=this.getView().getViewData().easyAccessSystemsModel;if(e){this.getView().setModel(e,"easyAccessSystems");}},getCrumbsData:function(p,m){var a=p.split("/");a.splice(a.length-2,2);var n=[];while(a.length){var P=a.join("/");var t=m.getProperty(P+"/text");n.unshift({text:t,path:P});a.splice(a.length-2,2);}return n;},_updateAppBoxedWithPinStatuses:function(p){var v=this.getView();if(!p){p=v.layout.getBinding("items").getPath();}var e=v.getModel("easyAccess");var a=e.getProperty(p)?e.getProperty(p):[];this.getView().oVisualizationOrganizerHelper.updateBookmarkCount.call(this,a).then(function(u){e.setProperty(p,u);});},updateBookmarkCount:function(a){return sap.ushell.Container.getServiceAsync("Bookmark").then(function(B){var b=a.map(function(d){return B.countBookmarks(d.url).then(function(e){d.bookmarkCount=e;return d;});});return new Promise(function(R){q.when.apply(q,b).then(function(){var u=Array.prototype.slice.call(arguments);R(u);});});});},updatePageBindings:function(p){this.getView().layout.bindAggregation("items","easyAccess>"+p+"/apps",this.getView().oItemTemplate);this._updateAppBoxedWithPinStatuses(p+"/apps");this.getView().breadcrumbs.bindProperty("currentLocationText","easyAccess>"+p+"/text");var a=this.getCrumbsData(p,this.getView().getModel("easyAccess"));this.getView().crumbsModel.setProperty("/crumbs",a);var n=this.getView().getModel("easyAccess").getProperty(p+"/apps");this.getView().updateResultSetMessage(n.length,false);},onAppBoxPressed:function(e){if(e.mParameters.srcControl.$().closest(".sapUshellPinButton").length){return;}var u=e.getSource().getProperty("url");if(u&&u.indexOf("#")===0){hasher.setHash(u);}},_handleSuccessMessage:function(a,p){var m;var n=p.addToGroups?p.addToGroups.length:0;var b=p.newGroups?p.newGroups.length:0;var t=n+b;if(t===1){var g;if(n===1){g=p.addToGroups[0].title;}else{g=p.newGroups[0];}m=r.i18n.getText("appAddedToSingleGroup",[a.text,g]);}else{m=r.i18n.getText("appAddedToSeveralGroups",[a.text,t]);}if(t>0){M.show(m,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});}return m;},_prepareErrorMessage:function(e,a){var g,A,f,n=0,C=false,m;for(var i in e){g=e[i].group;A=e[i].action;if(A==="addBookmark_ToExistingGroup"){n++;if(n===1){f=g.title;}}else if(A==="addBookmark_ToNewGroup"){n++;if(n===1){f=g;}}else{C=true;}}if(C){if(e.length===1){m=r.i18n.getText({messageId:"fail_tile_operation_create_new_group"});}else{m=r.i18n.getText({messageId:"fail_tile_operation_some_actions"});}}else if(e.length===1){m=r.i18n.getText({messageId:"fail_app_operation_add_to_group",parameters:[a,f]});}else{m=r.i18n.getText({messageId:"fail_app_operation_add_to_several_groups",parameters:[a]});}return m;},_handleBookmarkAppPopoverResponse:function(a,p){var b=[];p.newGroups.forEach(function(g){b.push(this._createGroupAndAddBookmark(g,a));}.bind(this));p.addToGroups.forEach(function(g){b.push(this._addBookmark(g,a));}.bind(this));q.when.apply(q,b).then(function(){var d=Array.prototype.slice.call(arguments);this._handlePopoverGroupsActionPromises(a,p,d);}.bind(this));},_handlePopoverGroupsActionPromises:function(a,p,b){var e=b.filter(function(f,i,b){return!f.status;});if(e.length){var E=this._prepareErrorMessage(e,a.text);var d=sap.ushell.components.getCatalogsManager();d.notifyOnActionFailure(E.messageId,E.parameters);return;}this._updateAppBoxedWithPinStatuses();this._handleSuccessMessage(a,p);},_createGroupAndAddBookmark:function(n,a){var b=sap.ushell.components.getCatalogsManager();var d=q.Deferred(),R={};var e=b.createGroup(n);e.done(function(f){var g=this._addBookmark(f.getObject(),a,true);g.done(function(h){d.resolve(h);}).fail(function(){R={group:n,status:0,action:"addBookmark_ToNewGroup"};d.resolve(R);});}.bind(this)).fail(function(){R={group:n,status:0,action:"addBookmark_NewGroupCreation"};d.resolve(R);});return d.promise();},_addBookmark:function(g,a,i){var b=sap.ushell.Container.getService("Bookmark");var d=q.Deferred(),R={};var e=b.addBookmark({url:a.url,title:a.text,subtitle:a.subtitle,icon:a.icon},g.object);var f=i?"addBookmark_ToNewGroup":"addBookmark_ToExistingGroup";e.done(function(){R={group:g,status:1,action:f};d.resolve(R);}).fail(function(){R={group:g,status:0,action:f};d.resolve(R);});return d.promise();},showSaveAppPopover:function(e){this.getView().oVisualizationOrganizerHelper.onHierarchyAppsPinButtonClick.call(this,e).then(function(u){if(u){this._updateAppBoxedWithPinStatuses();}}.bind(this));},showGroupListPopover:function(e){var m=this.getView().getModel();var a=e.oSource.getParent().getBinding("title").getContext().getObject();if(m.getProperty("/groupContext").path){var g=m.getProperty("/groupContext").path;var G=m.getProperty(g);var b={newGroups:[],addToGroups:[G]};this._handleBookmarkAppPopoverResponse(a,b);return;}var d=m.getProperty("/groups").map(function(h){return{selected:false,initiallySelected:false,oGroup:h};});var p=new sap.ui.view({type:V.JS,viewName:"sap.ushell.components.appfinder.GroupListPopover",viewData:{groupData:d,enableHideGroups:m.getProperty("/enableHideGroups"),enableHelp:m.getProperty("/enableHelp"),singleGroupSelection:true}});var f=p.open(e.oSource);f.then(this._handleBookmarkAppPopoverResponse.bind(this,a));},resultTextFormatter:function(s,t){var R=r.i18n;if(s){var S=s.systemName?s.systemName:s.systemId;var a="";if(t){a=R.getText("search_easy_access_results",[t,S]);}return a;}return"";},showMoreResultsVisibilityFormatter:function(a,t){if(a&&a.length<t){return true;}return false;},showMoreResultsTextFormatter:function(a,t){if(!a||!t){return"";}var b=a.length;return r.i18n.getText("EasyAccessSearchResults_ShowMoreResults",[b,t]);}});},true);
