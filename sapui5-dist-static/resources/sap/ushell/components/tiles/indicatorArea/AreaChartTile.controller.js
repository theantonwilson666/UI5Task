// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/generic","sap/m/library","sap/suite/ui/microchart/AreaMicroChartItem","sap/suite/ui/microchart/AreaMicroChartPoint","sap/ui/thirdparty/jquery"],function(g,m,A,d,q){"use strict";var F=m.FrameType;var L=m.LoadState;var f=g.extend("sap.ushell.components.tiles.indicatorArea.AreaChartTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false;},doProcess:function(r,i){this.onAfterFinalEvaluation(r,i);},doDummyProcess:function(){var t=this;this.setTextInTile();t._updateTileModel({footer:"",description:"",width:"100%",height:"100%",chart:{color:"Good",data:[{day:0,balance:0},{day:30,balance:20},{day:60,balance:20},{day:100,balance:80}]},target:{color:"Error",data:[{day:0,balance:0},{day:30,balance:30},{day:60,balance:40},{day:100,balance:90}]},maxThreshold:{color:"Good",data:[{day:0,balance:0},{day:30,balance:40},{day:60,balance:50},{day:100,balance:100}]},innerMaxThreshold:{color:"Error",data:[]},innerMinThreshold:{color:"Neutral",data:[]},minThreshold:{color:"Error",data:[{day:0,balance:0},{day:30,balance:20},{day:60,balance:30},{day:100,balance:70}]},minXValue:0,maxXValue:100,minYValue:0,maxYValue:100,firstXLabel:{label:"June 123",color:"Error"},lastXLabel:{label:"June 30",color:"Error"},firstYLabel:{label:"0M",color:"Good"},lastYLabel:{label:"80M",color:"Critical"},minLabel:{},maxLabel:{}});this.oKpiTileView.oGenericTile.setState(L.Loaded);},scheduleJob:function(a){if(this.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(this.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(this,this.oTileApi.visible.isVisible());}},onAfterFinalEvaluation:function(r,h){var t=this;var E=this.DEFINITION_DATA.EVALUATION.ODATA_ENTITYSET;var M=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.DEFINITION_DATA.EVALUATION_FILTERS,this.DEFINITION_DATA.ADDITIONAL_FILTERS);var j=this.DEFINITION_DATA.TILE_PROPERTIES.dimension;if(j==undefined){this.logError();return;}var k=this.DEFINITION_DATA.EVALUATION.GOAL_TYPE;var l=this.DEFINITION_DATA.EVALUATION_VALUES;var n=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){if(n){var o=n.Data&&JSON.parse(n.Data);}}var p=t.oTileApi.configuration.getParameterValueAsString("timeStamp");var s=sap.ushell.components.tiles.indicatorTileUtils.util.isCacheValid(t.oConfig.TILE_PROPERTIES.id,p,t.chipCacheTime,t.chipCacheTimeUnit,t.tilePressed);var u=M;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(k){case"MI":t.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");t.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");t.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");t.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");if(t.sWarningHigh&&t.sCriticalHigh&&t.sTarget){u+=","+t.sWarningHigh+","+t.sCriticalHigh+","+t.sTarget;}break;case"MA":t.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");t.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");t.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");t.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");if(t.sWarningLow&&t.sCriticalLow&&t.sTarget){u+=","+t.sWarningLow+","+t.sCriticalLow+","+t.sTarget;}break;case"RA":t.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");t.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");t.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");t.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");t.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");t.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");if(t.sWarningLow&&t.sCriticalLow&&t.sTarget&&t.sWarningHigh&&t.sCriticalHigh){u+=","+t.sWarningLow+","+t.sCriticalLow+","+t.sTarget+","+t.sWarningHigh+","+t.sCriticalHigh;}break;}}var w=sap.ushell.components.tiles.indicatorTileUtils.util.getBoolValue(r);if((o&&!o.rightData)||!n||(!s&&t.oTileApi.visible.isVisible())||w||(h&&t.oTileApi.visible.isVisible())||t.getView().getViewData().refresh){if(t.kpiValueFetchDeferred){t.kpiValueFetchDeferred=false;var Q=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oRunTimeODataModel,E,u,j,v);if(Q){this.queryUriForTrendChart=Q.uri;var x={};try{this.trendChartODataReadRef=Q.model.read(Q.uri,null,null,true,function(a){t.kpiValueFetchDeferred=true;if(a&&a.results&&a.results.length){if(Q.unit[0]){t.unit=a.results[0][Q.unit[0].name];t.CURRENCY_CODE=t.unit;x.unit=Q.unit[0];x.unit.name=Q.unit[0].name;}t.queryUriResponseForTrendChart=a;j=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(t.oRunTimeODataModel,E,j);a.results.splice(10);a.firstXlabel=a.results[0][j];a.lastXlabel=a.results[a.results.length-1][j];x.data=a;if(x&&x.data&&x.data.results&&x.data.results.length){for(var i=0;i<x.data.results.length;i++){delete x.data.results[i].__metadata;}}x.isCurM=t.isCurrencyMeasure(t.oConfig.EVALUATION.COLUMN_NAME);x.dimensionName=j;_(a,t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE);var c={};t.cacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();c.ChipId=t.oConfig.TILE_PROPERTIES.id;c.Data=JSON.stringify(x);c.CacheMaxAge=Number(t.chipCacheTime);c.CacheMaxAgeUnit=t.chipCacheTimeUnit;c.CacheType=1;var b=t.getLocalCache(c);if(t.DEFINITION_DATA.TILE_PROPERTIES.frameType==F.TwoByOne){var B=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id),C;if(B){if(!B.CachedTime){B.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();}C=B.Data;if(C){C=JSON.parse(C);C.rightData=x;}B.Data=JSON.stringify(C);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,B);}else{C={};C.rightData=x;b.Data=JSON.stringify(C);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,b);}t.cacheWriteData=x;t.getView().getViewData().deferredObj.resolve();}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,b);var U=false;if(n){U=true;}if(t.chipCacheTime){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(t.oTileApi,t.oConfig.TILE_PROPERTIES.id,c,U,function(a){if(a){t.cacheTime=a&&a.CachedTime;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,a);t.setTimeStamp();}if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){q.proxy(t.setTimeStamp(t.cacheTime),t);}});}t.oKpiTileView.oGenericTile.setState(L.Loaded);t.updateDatajobScheduled=false;var D=t.oConfig.TILE_PROPERTIES.id+"data";var G=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(D);if(G){clearTimeout(G);G=undefined;}q.proxy(t.scheduleJob(t.cacheTime),t);}}else{t.setNoData();}},function(a){t.kpiValueFetchDeferred=true;if(a&&a.response){t.logError("Data call failed");}});}catch(e){t.kpiValueFetchDeferred=true;t.logError(e);}}else{t.kpiValueFetchDeferred=true;t.logError();}}}else if(n&&n.Data){try{var y;var z=t.oConfig&&t.oConfig.TILE_PROPERTIES&&t.oConfig.TILE_PROPERTIES.tileType;if(z.indexOf("DT-")==-1){y=n.Data&&JSON.parse(n.Data);}else{y=n.Data&&JSON.parse(n.Data);y=y.rightData;}if(y.unit){t.unit=y.data.results[0][y.unit.name];t.CURRENCY_CODE=t.unit;}t.cacheTime=n.CachedTime;if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){q.proxy(t.setTimeStamp(t.cacheTime),t);}t.queryUriResponseForTrendChart=y.data;j=y.dimensionName;_(y.data,t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE);if(t.oConfig.TILE_PROPERTIES.frameType==F.OneByOne){t.oKpiTileView.oGenericTile.setState(L.Loaded);}else{t.getView().getViewData().deferredObj.resolve();}q.proxy(t.scheduleJob(t.cacheTime),t);}catch(e){t.logError(e);}}else{t.setNoData();}function _(B,C){var D=[];var G=[];var H=[];var I=[];var J=[];var K=[];var N=B.firstXlabel;var O,P,R,S,T;var U=B.lastXlabel;var V=Number(B.results[0][M]);var W=Number(B.results[B.results.length-1][M]);var i;for(i in B.results){B.results[i][j]=Number(i);B.results[i][M]=Number(B.results[i][M]);if(t.sWarningHigh){B.results[i][t.sWarningHigh]=Number(B.results[i][t.sWarningHigh]);}if(t.sCriticalHigh){B.results[i][t.sCriticalHigh]=Number(B.results[i][t.sCriticalHigh]);}if(t.sCriticalLow){B.results[i][t.sCriticalLow]=Number(B.results[i][t.sCriticalLow]);}if(t.sWarningLow){B.results[i][t.sWarningLow]=Number(B.results[i][t.sWarningLow]);}if(t.sTarget){B.results[i][t.sTarget]=Number(B.results[i][t.sTarget]);}if(t.sWarningHigh){H.push(B.results[i][t.sWarningHigh]);}if(t.sCriticalHigh){I.push(B.results[i][t.sCriticalHigh]);}if(t.sCriticalLow){J.push(B.results[i][t.sCriticalLow]);}if(t.sWarningLow){K.push(B.results[i][t.sWarningLow]);}D.push(B.results[i][j]);G.push(B.results[i][M]);}try{N=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(N);U=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(U);}catch(e){t.logError(e);}var X=Number(V);if(t.oConfig.EVALUATION.SCALING==-2){X*=100;}var Y=Math.min.apply(Math,G);var c=t.isCurrencyMeasure(t.oConfig.EVALUATION.COLUMN_NAME);var Z=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(X,t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION,c,t.CURRENCY_CODE);if(t.oConfig.EVALUATION.SCALING==-2){Z+=" %";}var $=Z.toString();var a1=Number(W);if(t.oConfig.EVALUATION.SCALING==-2){a1*=100;}var b1=Math.max.apply(Math,G);c=t.isCurrencyMeasure(t.oConfig.EVALUATION.COLUMN_NAME);var c1=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(a1,t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION,c,t.CURRENCY_CODE);if(t.oConfig.EVALUATION.SCALING==-2){c1+=" %";}var d1=c1.toString();try{var e1=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(Math.min.apply(Math,D));var f1=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(Math.max.apply(Math,D));}catch(e){t.logError(e);}if(C=="MEASURE"){if(H.length!=0){t.firstwH=H[e1];t.lastwH=H[f1];}if(I.length!=0){t.firstcH=I[e1];t.lastcH=I[f1];}if(J.length!=0){t.firstcL=J[e1];t.lastcL=J[f1];}if(K.length!=0){t.firstwL=K[e1];t.lastwL=K[f1];}}var g1={width:"100%",height:"100%",unit:t.unit||"",chart:{color:"Neutral",data:B.results},size:"Auto",minXValue:e1,maxXValue:f1,minYValue:Y,maxYValue:b1,firstXLabel:{label:N+"",color:"Neutral"},lastXLabel:{label:U+"",color:"Neutral"},firstYLabel:{label:$+"",color:"Neutral"},lastYLabel:{label:d1+"",color:"Neutral"},minLabel:{},maxLabel:{}};var h1;switch(k){case"MA":for(i in l){if(l[i].TYPE=="CL"){g1.minThreshold={color:"Error"};h1={};h1[j]="";h1[M]=Number(l[i].FIXED);t.cl=Number(l[i].FIXED);g1.minThreshold.data=(C=="MEASURE")?B.results:[h1];O=(C=="MEASURE")?t.sCriticalLow:M;}else if(l[i].TYPE=="WL"){g1.maxThreshold={color:"Good"};h1={};h1[j]="";h1[M]=Number(l[i].FIXED);g1.maxThreshold.data=(C=="MEASURE")?B.results:[h1];P=(C=="MEASURE")?t.sWarningLow:M;t.wl=Number(l[i].FIXED);}else if(l[i].TYPE=="TA"){h1={};h1[j]="";h1[M]=Number(l[i].FIXED);g1.target={color:"Neutral"};g1.target.data=(C=="MEASURE")?B.results:[h1];T=(C=="MEASURE")?t.sTarget:M;}}g1.innerMinThreshold={data:[]};g1.innerMaxThreshold={data:[]};if(C=="FIXED"){g1.firstYLabel.color=V<t.cl?"Error":((t.cl<=V)&&(V<=t.wl))?"Critical":(V>t.wl)?"Good":"Neutral";g1.lastYLabel.color=W<t.cl?"Error":((t.cl<=W)&&(W<=t.wl))?"Critical":(W>t.wl)?"Good":"Neutral";}else if(C=="MEASURE"&&t.firstwL&&t.lastwL&&t.firstcL&&t.lastcL){g1.firstYLabel.color=V<t.firstcL?"Error":((t.firstcL<=V)&&(V<=t.firstwL))?"Critical":(V>t.firstwL)?"Good":"Neutral";g1.lastYLabel.color=W<t.lastcL?"Error":((t.lastcL<=W)&&(W<=t.lastwL))?"Critical":(W>t.lastwL)?"Good":"Neutral";}break;case"MI":for(i in l){if(l[i].TYPE=="CH"){h1={};h1[j]="";h1[M]=Number(l[i].FIXED);t.ch=Number(l[i].FIXED);g1.maxThreshold={color:"Error"};g1.maxThreshold.data=(C=="MEASURE")?B.results:[h1];P=(C=="MEASURE")?t.sCriticalHigh:M;}else if(l[i].TYPE=="WH"){h1={};h1[j]="";h1[M]=Number(l[i].FIXED);t.wh=Number(l[i].FIXED);g1.minThreshold={color:"Good"};g1.minThreshold.data=(C=="MEASURE")?B.results:[h1];O=(C=="MEASURE")?t.sWarningHigh:M;}else if(l[i].TYPE=="TA"){h1={};h1[j]="";h1[M]=Number(l[i].FIXED);g1.target={color:"Neutral"};g1.target.data=(C=="MEASURE")?B.results:[h1];T=(C=="MEASURE")?t.sTarget:M;}}if(C=="FIXED"){g1.firstYLabel.color=V>t.ch?"Error":((t.wh<=V)&&(V<=t.ch))?"Critical":(V<t.wh)?"Good":"Neutral";g1.lastYLabel.color=W>t.ch?"Error":((t.wh<=W)&&(W<=t.ch))?"Critical":(W<t.wh)?"Good":"Neutral";}else if(C=="MEASURE"&&t.firstwH&&t.lastwH&&t.firstcH&&t.lastcH){g1.firstYLabel.color=V>t.firstcH?"Error":((t.firstwH<=V)&&(V<=t.firstcH))?"Critical":(V<t.firstwH)?"Good":"Neutral";g1.lastYLabel.color=W>t.lastcH?"Error":((t.lastwH<=W)&&(W<=t.lastcH))?"Critical":(W<t.lastwH)?"Good":"Neutral";}g1.innerMaxThreshold={data:[]};g1.innerMinThreshold={data:[]};break;case"RA":for(i in l){if(l[i].TYPE=="CH"){h1={};h1[j]="";h1[M]=Number(l[i].FIXED);t.ch=Number(l[i].FIXED);g1.maxThreshold={color:"Error"};g1.maxThreshold.data=(C=="MEASURE")?B.results:[h1];P=(C=="MEASURE")?t.sCriticalHigh:M;}else if(l[i].TYPE=="WH"){h1={};h1[j]="";h1[M]=Number(l[i].FIXED);t.wh=Number(l[i].FIXED);g1.innerMaxThreshold={color:"Good"};g1.innerMaxThreshold.data=(C=="MEASURE")?B.results:[h1];S=(C=="MEASURE")?t.sWarningHigh:M;}else if(l[i].TYPE=="WL"){h1={};h1[j]="";h1[M]=Number(l[i].FIXED);t.wl=Number(l[i].FIXED);g1.innerMinThreshold={color:"Good"};g1.innerMinThreshold.data=(C=="MEASURE")?B.results:[h1];R=(C=="MEASURE")?t.sWarningLow:M;}else if(l[i].TYPE=="CL"){h1={};h1[j]="";h1[M]=Number(l[i].FIXED);t.cl=Number(l[i].FIXED);g1.minThreshold={color:"Error"};g1.minThreshold.data=(C=="MEASURE")?B.results:[h1];O=(C=="MEASURE")?t.sCriticalLow:M;}else if(l[i].TYPE=="TA"){h1={};h1[j]="";h1[M]=Number(l[i].FIXED);g1.target={color:"Neutral"};g1.target.data=(C=="MEASURE")?B.results:[h1];T=(C=="MEASURE")?t.sTarget:M;}}if(C=="FIXED"){g1.firstYLabel.color=(V>t.ch||V<t.cl)?"Error":((t.wh<=V)&&(V<=t.ch))||((t.cl<=V)&&(V<=t.wl))?"Critical":((V>=t.wl)&&(V<=t.wh))?"Good":"Neutral";g1.lastYLabel.color=(W>t.ch||W<t.cl)?"Error":((t.wh<=W)&&(W<=t.ch))||((t.cl<=W)&&(W<=t.wl))?"Critical":((W>=t.wl)&&(W<=t.wh))?"Good":"Neutral";}else if(C=="MEASURE"&&t.firstwL&&t.lastwL&&t.firstcL&&t.lastcL&&t.firstwH&&t.lastwH&&t.firstcH&&t.lastcH){g1.firstYLabel.color=(V>t.firstcH||V<t.firstcL)?"Error":((t.firstwH<=V)&&(V<=t.firstcH))||((t.firstcL<=V)&&(V<=t.firstwL))?"Critical":((V>=t.firstwL)&&(V<=t.firstwH))?"Good":"Neutral";g1.lastYLabel.color=(W>t.lastcH||W<t.lastcL)?"Error":((t.lastwH<=W)&&(W<=t.lastcH))||((t.lastcL<=W)&&(W<=t.lastwL))?"Critical":((W>=t.lastwL)&&(W<=t.lastwH))?"Good":"Neutral";}break;}var i1=function(k1,a,b,C){return new A({color:"{/"+k1+"/color}",points:{path:"/"+k1+"/data",template:new d({x:"{"+a+"}",y:"{"+b+"}"})}});};var j1=t.getView().oNVConfContS;j1.setTarget(i1("target",j,T));j1.setInnerMinThreshold(i1("innerMinThreshold",j,R));j1.setInnerMaxThreshold(i1("innerMaxThreshold",j,S));j1.setMinThreshold(i1("minThreshold",j,O));j1.setMaxThreshold(i1("maxThreshold",j,P));j1.setChart(i1("chart",j,M));t.setTextInTile();if(t.getView().getViewData().parentController){t.getView().getViewData().parentController._updateTileModel(g1);}else{t._updateTileModel(g1);}}}});return f;});
