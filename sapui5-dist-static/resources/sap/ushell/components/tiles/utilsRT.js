// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/utils","sap/ui/core/format/NumberFormat","sap/ui/core/library","sap/m/library","sap/base/Log","sap/ui/model/json/JSONModel"],function(u,N,c,m,L,J){"use strict";var V=c.mvc.ViewType;var B=m.ButtonType;var a={};a.getConfiguration=function(t,A,E){var r;var C=t.configuration.getParameterValueAsString("tileConfiguration");try{var o=JSON.parse(C||"{}");}catch(e){L.error("Error while trying to parse tile configuration",e,"sap.ushell.components.tiles.utilsRT");return{};}var U=sap.ui.require("sap/ushell/components/tiles/utils");o.editable=true;if(t.configurationUi&&t.configurationUi.isReadOnly){if(t.configurationUi.isReadOnly()){o.editable=false;}}var T=U.getTranslatedTitle(t);var s=U.getTranslatedSubtitle(t,o);var i=U.getTranslatedProperty(t,o,"display_info_text");var k=U.getTranslatedProperty(t,o,"display_search_keywords");if(A){r=U.getResourceBundleModel().getResourceBundle();if(E&&t.bag){var b=t.bag.getOriginalLanguage();var l=sap.ui.getCore().getConfiguration().getLocale().getSAPLogonLanguage();var d=sap.ui.getCore().getConfiguration().getLanguage();o.isLocaleSuitable=b===""||b.toLowerCase()===l.toLowerCase()||b.toLowerCase()===d.toLowerCase();o.orgLocale=b;o.userLocale=l;}}o.display_icon_url=o.display_icon_url||"";if(i!==undefined){o.display_info_text=i;}else if(o.display_info_text===undefined){if(A&&!E){o.display_info_text="["+r.getText("configuration.display_info_text")+"]";}else{o.display_info_text="";}}o.navigation_semantic_object=o.navigation_semantic_object||"";o.navigation_semantic_action=o.navigation_semantic_action||"";o.navigation_semantic_parameters=o.navigation_semantic_parameters||"";o.display_number_unit=o.display_number_unit||"";o.display_number_factor=o.display_number_factor||"";o.service_refresh_interval=o.service_refresh_interval?parseInt(o.service_refresh_interval,10):0;o.service_url=o.service_url||"";o.navigation_target_url=o.navigation_target_url||"";if(A&&U.isInitial(T)){o.display_title_text=E?"":"["+r.getText("configuration.display_title_text")+"]";o.display_subtitle_text=E?"":"["+r.getText("configuration.display_subtitle_text")+"]";}else{o.display_title_text=T||o.display_title_text||"";if(s!==undefined){o.display_subtitle_text=s;}else if(o.display_subtitle_text===undefined){o.display_subtitle_text="";}}o.navigation_use_semantic_object=(o.navigation_use_semantic_object!==false);o.display_search_keywords=k||o.display_search_keywords||"";if(A){o.display_number_value=o.display_number_value||1234;}o.form_factors=o.form_factors?o.form_factors:U.getDefaultFormFactors();o.desktopChecked=o.form_factors.manual.desktop;o.tabletChecked=o.form_factors.manual.tablet;o.phoneChecked=o.form_factors.manual.phone;o.manualFormFactor=!(o.form_factors.appDefault)&&o.editable;o.appFormFactor=o.form_factors.appDefault;o.formFactorConfigDefault=!!o.form_factors.defaultParam;if(o.signature){o.rows=U.getSignatureTableData(o.signature,E&&o.editable);}else{o.rows=(o.mapping_signature&&o.mapping_signature!=="*=*")?U.getMappingSignatureTableData(o.mapping_signature,E&&o.editable):[U.getEmptyRowObj(o.editable)];}if(o.signature){o.isUnknownAllowed=(o.signature.additional_parameters==="allowed"||o.signature.additionalParameters==="allowed");}else{o.isUnknownAllowed=(o.mapping_signature!==undefined)?U.getAllowUnknownParametersValue(o.mapping_signature):true;}if(A){o.tile_actions_rows=U.getTileNavigationActionsRows(t,o.editable);}else if(!o.actions){o.actions=U.getTileNavigationActions(t);}if(A){var D=t.bag.getBag("deprecationProperties"),f=D.getProperty("deprecation"),g=null;if(f){g=r.getText(f==="D"?"configuration.app_deprecated":"configuration.app_archived",[D.getProperty("successor")]);}o.deprecation_text=g;}return o;};a.getDataToDisplay=function(C,d){var b=0,i,n,o,s,D={display_icon_url:d.icon||C.display_icon_url||"",display_title_text:d.title||C.display_title_text||"",display_number_value:!isNaN(d.number)?d.number:"...",display_number_unit:d.numberUnit||C.display_number_unit||"",display_info_text:d.info||C.display_info_text||"",display_info_state:d.infoState||"Neutral",display_subtitle_text:d.subtitle||C.display_subtitle_text||"",display_state_arrow:d.stateArrow||"None",display_number_state:d.numberState||"None",display_number_digits:d.numberDigits>=0?d.numberDigits:4,display_number_factor:d.numberFactor||"",display_search_keyword:d.keywords||C.display_search_keyword||"",targetParams:[]};if(d.infoStatus){D.display_info_state=d.infoStatus;}if(d.targetParams){D.targetParams.push(d.targetParams);}if(d.results){for(i=0,n=d.results.length;i<n;i=i+1){o=d.results[i].number||0;if(typeof o==="string"){o=parseFloat(o,10);}b=b+o;s=d.results[i].targetParams;if(s){D.targetParams.push(s);}}D.display_number_value=b;}if(!isNaN(d.number)){if(typeof d.number==="string"){d.number=d.number.trim();}if(d.number===""){D.display_number_value="...";}else{var S=this._shouldProcessDigits(d.number,d.numberDigits),e=D.display_icon_url?4:5;if(d.number&&d.number.length>=e||S){var f=this._normalizeNumber(d.number,e,d.numberFactor,d.numberDigits);D.display_number_factor=f.numberFactor;D.display_number_value=f.displayNumber;}else{var g=N.getFloatInstance({maxFractionDigits:e});D.display_number_value=g.format(d.number);}}}if(D&&D.display_number_state){switch(D.display_number_state){case"Positive":D.display_number_state="Good";break;case"Negative":D.display_number_state="Error";break;}}return D;};a.getTileSettingsAction=function(M,s,t){var U=sap.ui.require("sap/ushell/components/tiles/utils");var r=U.getResourceBundleModel().getResourceBundle();return{text:(!t||t==="tile")?r.getText("tileSettingsBtn"):r.getText("linkSettingsBtn"),press:function(){sap.ui.require(["sap/ui/layout/form/SimpleForm","sap/ui/layout/form/SimpleFormLayout","sap/m/Button","sap/m/Dialog"],function(S,b,d,D){var A={showGroupSelection:false,title:M.getProperty("/config/display_title_text"),subtitle:M.getProperty("/config/display_subtitle_text")};if(!t||t==="tile"){A.info=M.getProperty("/config/display_info_text");A.icon=M.getProperty("/config/display_icon_url");A.keywords=M.getProperty("/config/display_search_keywords");}else if(t==="link"){A.showInfo=false;A.showIcon=false;A.showPreview=false;}var o=sap.ui.view({type:V.JS,viewName:"sap.ushell.ui.footerbar.SaveAsTile"});var e=new J(A);o.setModel(e);var f=new S({id:"tileSettings",layout:b.GridLayout,content:[o]}).addStyleClass("sapUshellAddBookmarkForm");var g=new d("bookmarkOkBtn",{text:r.getText("okBtn"),type:B.Emphasized,press:function(){s(o);j.close();},enabled:true}),h=new d("bookmarkCancelBtn",{text:r.getText("cancelBtn"),press:function(){j.close();}});var i=function(k){g.setEnabled(!!k.trim());};o.getTitleInput().attachLiveChange(function(){i(this.getValue());});var j=new D({id:"settingsDialog",title:(!t||t==="tile")?r.getText("tileSettingsDialogTitle"):r.getText("linkSettingsDialogTitle"),contentWidth:"400px",content:f,beginButton:g,endButton:h,horizontalScrolling:false,afterClose:function(){j.destroy();}}).addStyleClass("sapContrastPlus");j.open();});}};};a.getSemanticNavigationUrl=function(C){var U="#"+jQuery.trim(C.navigation_semantic_object);U+="-"+jQuery.trim(C.navigation_semantic_action);if(C.navigation_semantic_parameters&&jQuery.trim(C.navigation_semantic_parameters).length>0){U+="?"+jQuery.trim(C.navigation_semantic_parameters);}return U;};a.addParamsToUrl=function(U,d){var p="",b=U.indexOf("?")!==-1,t=d.targetParams,i;if(t&&t.length>0){for(i=0;i<t.length;i=i+1){p+=t[i];if(i<t.length-1){p+="&";}}}if(p.length>0){if(!b){U+="?";}else{U+="&";}U+=p;}return U;};a._normalizeNumber=function(n,b,d,i){var e;if(isNaN(n)){e=n;}else{var o=N.getFloatInstance({maxFractionDigits:i});if(!d){var f=Math.abs(n);if(f>=1000000000){d="B";n/=1000000000;}else if(f>=1000000){d="M";n/=1000000;}else if(f>=1000){d="K";n/=1000;}}e=o.format(n);}var g=e;var h=g[b-1];b-=(h==="."||h===",")?1:0;g=g.substring(0,b);return{displayNumber:g,numberFactor:d};};a._shouldProcessDigits=function(d,D){var n;d=typeof(d)!=="string"?d.toString():d;if(d.indexOf(".")!==-1){n=d.split(".")[1].length;if(n>D){return true;}}return false;};return a;},true);
