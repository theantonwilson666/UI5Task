// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/generic","sap/m/library","sap/ui/thirdparty/jquery","sap/base/Log"],function(g,m,q,L){"use strict";var D=m.DeviationIndicator;var V=m.ValueColor;var S=m.Size;var a=m.LoadState;var F=m.FrameType;var C=g.extend("sap.ushell.components.tiles.indicatorcomparison.ComparisonTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false;},_processDataForComparisonChart:function(d,b,u){var f=[],e={},i,t,l;var h;var T=[];var j=this;var k=null;for(i=0;i<d.results.length;i++){var n=d.results[i];}T=sap.ushell.components.tiles.indicatorTileUtils.util.getAllMeasuresWithLabelText(this.oTileApi.url.addSystemToServiceUrl(this.oConfig.EVALUATION.ODATA_URL),this.oConfig.EVALUATION.ODATA_ENTITYSET);for(i=0,l=T.length;i<l;i++){t=T[i];e[t.key]=t.value;}var o=j.oConfig.TILE_PROPERTIES.COLUMN_NAMES||j.oConfig.EVALUATION.COLUMN_NAMES;for(i=0;i<o.length;i++){var p={};var r=o[i];p.value=Number(n[r.COLUMN_NAME]);var s=Number(n[r.COLUMN_NAME]);var v=false;var w=0;var x=j._getEvaluationThresholdMeasures();var I=x?Array.prototype.indexOf.call(x,r.COLUMN_NAME):-1;if(I>-1){v=true;w=j.oConfig.EVALUATION.SCALING;}if(j.oConfig.EVALUATION.SCALING==-2&&v){s*=100;}var c=j.isCurrencyMeasure(r.COLUMN_NAME);if(u&&u[i]&&n[u[i].name]){k=n[u[i].name];}h=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(s,w,j.oConfig.EVALUATION.SCALING,j.oConfig.EVALUATION.DECIMAL_PRECISION,c,k);if(j.oConfig.EVALUATION.SCALING==-2&&v){h+=" %";}p.displayValue=h.toString();if(u){if(u[i]&&n[u[i].name]){p.displayValue+=" "+n[u[i].name];}}p.color=r.semanticColor;p.title=e[r.COLUMN_NAME]||r.COLUMN_NAME;p.measure=r.COLUMN_NAME;p.isCurM=c;f.push(p);}return f;},fetchChartData:function(r,b,s,E){function c(z,A){var B=false;if(z&&z.results&&z.results.length){for(var i=0,l=A.length;i<l&&!B;i++){B=z.results[0][A[i].COLUMN_NAME]!==null;}}return B;}var t=this;try{var d=this.oConfig.EVALUATION.ODATA_ENTITYSET;var f=this.oConfig.EVALUATION.COLUMN_NAME;var h=f,j;if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES){for(j=0;j<this.oConfig.TILE_PROPERTIES.COLUMN_NAMES.length;j++){if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[j].COLUMN_NAME!=this.oConfig.EVALUATION.COLUMN_NAME){h=h+","+this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[j].COLUMN_NAME;}}}else{for(j=0;j<this.oConfig.EVALUATION.COLUMN_NAMES.length;j++){if(this.oConfig.EVALUATION.COLUMN_NAMES[j].COLUMN_NAME!=this.oConfig.EVALUATION.COLUMN_NAME){h=h+","+this.oConfig.EVALUATION.COLUMN_NAMES[j].COLUMN_NAME;}}}var k=sap.ushell.components.tiles.indicatorTileUtils.util.getBoolValue(r);var n=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){if(n){var o=n.Data&&JSON.parse(n.Data);}}var p=t.oTileApi.configuration.getParameterValueAsString("timeStamp");var u=sap.ushell.components.tiles.indicatorTileUtils.util.isCacheValid(t.oConfig.TILE_PROPERTIES.id,p,t.chipCacheTime,t.chipCacheTimeUnit,t.tilePressed);if((o&&!o.rightData)||!n||(!u&&t.oTileApi.visible.isVisible())||k||(b&&t.oTileApi.visible.isVisible())||t.getView().getViewData().refresh){if(t.kpiValueFetchDeferred){t.kpiValueFetchDeferred=false;var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var w=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oRunTimeODataModel,d,h,null,v,3);this.comparisionChartODataRef=w.model.read(w.uri,null,null,true,function(i){t.kpiValueFetchDeferred=true;var l={};if(w.unit){l.unit=w.unit;}if(c(i,t.oConfig.TILE_PROPERTIES.COLUMN_NAMES||t.oConfig.EVALUATION.COLUMN_NAMES)){t.oConfig.TILE_PROPERTIES.FINALVALUE=i;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,h.split(",")[0],w.unit);l.data=t.oConfig.TILE_PROPERTIES.FINALVALUE;var z={};t.cacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();z.ChipId=t.oConfig.TILE_PROPERTIES.id;z.Data=JSON.stringify(l);z.CacheMaxAge=Number(t.chipCacheTime);z.CacheMaxAgeUnit=t.chipCacheTimeUnit;z.CacheType=1;var A=t.getLocalCache(z);t.updateDatajobScheduled=false;var B=t.oConfig.TILE_PROPERTIES.id+"data";var G=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(B);if(G){clearTimeout(G);G=undefined;}if(!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,A);var U=false;if(n){U=true;}if(t.chipCacheTime){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(t.oTileApi,t.oConfig.TILE_PROPERTIES.id,z,U,function(i){if(i){t.cacheTime=i&&i.CachedTime;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,i);t.setTimeStamp();}if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){q.proxy(t.setTimeStamp(t.cacheTime),t);}});}}else{var H=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id),I;if(H){if(!H.CachedTime){H.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();}I=H.Data;if(I){I=JSON.parse(I);I.rightData=l;}H.Data=JSON.stringify(I);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,H);}else{I={};I.rightData=l;A.Data=JSON.stringify(I);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,A);}t.cacheWriteData=l;}s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(i.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=i;if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id)){l=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);l.data=i;}else{l.data=i;}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,l);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);t.setNoData();}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,{empty:"empty"});t.setNoData();}},function(i){t.kpiValueFetchDeferred=true;if(i&&i.response){L.error(i.message+" : "+i.request.requestUri);E.call(t,i);}});}}else if(n&&n.Data){var x;var y=t.oConfig&&t.oConfig.TILE_PROPERTIES&&t.oConfig.TILE_PROPERTIES.tileType;if(y.indexOf("DT-")==-1){x=n.Data&&JSON.parse(n.Data);}else{x=n.Data&&JSON.parse(n.Data);x=x.rightData;}t.cacheTime=n.CachedTime;if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){q.proxy(t.setTimeStamp(t.cacheTime),t);}if(x.data&&x.data.length){t.oConfig.TILE_PROPERTIES.FINALVALUE=x.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else{t.oConfig.TILE_PROPERTIES.FINALVALUE=x.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);t.setNoData();}}else{t.setNoData();}}catch(e){t.kpiValueFetchDeferred=true;E.call(t,e);}},doProcess:function(r,i){var t=this;this.setTextInTile();this.fetchChartData(r,i,function(k){this.CALCULATED_KPI_VALUE=k;this._updateTileModel({data:this.CALCULATED_KPI_VALUE});if(t.oConfig.TILE_PROPERTIES.frameType==F.TwoByOne){t.oKpiTileView.oGenericTile.setFrameType(F.TwoByOne);t.getView().getViewData().parentController._updateTileModel(this.getTile().getModel().getData());var c={};c.data=this.CALCULATED_KPI_VALUE;t.getView().getViewData().deferredObj.resolve();}else{t.oKpiTileView.oGenericTile.setFrameType(F.OneByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.oKpiTileView.oGenericTile.addTileContent(t.oKpiTileView.oNVConfS);this.oKpiTileView.oGenericTile.setState(a.Loaded);}this.setToolTip(null,this.CALCULATED_KPI_VALUE,"COMP");if(this.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(this.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(this,this.oTileApi.visible.isVisible());}},this.logError);},doDummyProcess:function(){var t=this;this.setTextInTile();t._updateTileModel({value:8888,size:S.Auto,frameType:F.OneByOne,state:a.Loading,valueColor:V.Error,indicator:D.None,title:"Liquidity Structure",footer:"Current Quarter",description:"Apr 1st 2013 (B$)",data:[{title:"Measure 1",value:1.2,color:"Good"},{title:"Measure 2",value:0.78,color:"Good"},{title:"Measure 3",value:1.4,color:"Error"}]});this.oKpiTileView.oGenericTile.setState(a.Loaded);}});return C;});
