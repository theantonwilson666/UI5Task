// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/indicatorTileUtils/smartBusinessUtil","sap/m/library","sap/ui/thirdparty/jquery","sap/base/Log"],function(u,m,q,L){"use strict";var S=m.Size;var D=m.DeviationIndicator;var V=m.ValueColor;var a=m.LoadState;sap.ui.controller("tiles.indicatorDualComparison.DualComparison",{getTile:function(){return this.oDualComparisonView.oGenericTile;},_updateTileModel:function(n){var b=this.getTile().getModel().getData();q.extend(b,n);this.getTile().getModel().setData(b);},setTitle:function(){var t=this;var b=sap.ushell.components.tiles.indicatorTileUtils.util.getTileTitleSubtitle(this.oChip);this._updateTileModel({header:b.title||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(t.oConfig),subheader:b.subTitle||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(t.oConfig)});},logError:function(e){this.oDualComparisonView.oGenericTile.setState(a.Failed);this.oDualComparisonView.oGenericTile.setState(a.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e);},formSelectStatement:function(o){var t=Object.keys(o);var f="";for(var i=0;i<t.length;i++){if((o[t[i]]!==undefined)&&(o.fullyFormedMeasure)){f+=","+o[t[i]];}}return f;},setThresholdValues:function(){var t=this;try{var T={};T.fullyFormedMeasure=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(this.DEFINITION_DATA.EVALUATION.GOAL_TYPE){case"MI":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"MA":T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"RA":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;}}else{T.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","FIXED");T.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","FIXED");T.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","FIXED");T.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","FIXED");T.targetValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","FIXED");T.trendValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","FIXED");}return T;}catch(e){t.logError(e);}},getTrendColor:function(t){var b=this;var c,w,d,f;try{var i=this.DEFINITION_DATA.EVALUATION.GOAL_TYPE;var r=V.Neutral;if(i==="MI"){if(t.criticalHighValue&&t.warningHighValue){c=Number(t.criticalHighValue);w=Number(t.warningHighValue);if(this.CALCULATED_KPI_VALUE<w){r=V.Good;}else if(this.CALCULATED_KPI_VALUE<=c){r=V.Critical;}else{r=V.Error;}}}else if(i==="MA"){if(t.criticalLowValue&&t.warningLowValue){d=Number(t.criticalLowValue);f=Number(t.warningLowValue);if(this.CALCULATED_KPI_VALUE<d){r=V.Error;}else if(this.CALCULATED_KPI_VALUE<=f){r=V.Critical;}else{r=V.Good;}}}else if(t.warningLowValue&&t.warningHighValue&&t.criticalLowValue&&t.criticalHighValue){c=Number(t.criticalHighValue);w=Number(t.warningHighValue);f=Number(t.warningLowValue);d=Number(t.criticalLowValue);if(this.CALCULATED_KPI_VALUE<d||this.CALCULATED_KPI_VALUE>c){r=V.Error;}else if((this.CALCULATED_KPI_VALUE>=d&&this.CALCULATED_KPI_VALUE<=f)||(this.CALCULATED_KPI_VALUE>=w&&this.CALCULATED_KPI_VALUE<=c)){r=V.Critical;}else{r=V.Good;}}return r;}catch(e){b.logError(e);}},_processDataForComparisonChart:function(d,b,c){var f=[],e={},i,t,l;var g;var T=[];var h=this;for(i=0;i<d.results.length;i++){var j=d.results[i];}T=sap.ushell.components.tiles.indicatorTileUtils.util.getAllMeasuresWithLabelText(this.oConfig.EVALUATION.ODATA_URL,this.oConfig.EVALUATION.ODATA_ENTITYSET);for(i=0,l=T.length;i<l;i++){t=T[i];e[t.key]=t.value;}var k=h.oConfig.TILE_PROPERTIES.COLUMN_NAMES||h.oConfig.EVALUATION.COLUMN_NAMES;for(i=0;i<k.length;i++){var n={};var o=k[i];n.value=Number(j[o.COLUMN_NAME]);var p=Number(j[o.COLUMN_NAME]);if(h.oConfig.EVALUATION.SCALING==-2){p*=100;}g=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(p,h.oConfig.EVALUATION.SCALING,h.oConfig.EVALUATION.DECIMAL_PRECISION);if(h.oConfig.EVALUATION.SCALING==-2){g+=" %";}n.displayValue=g.toString();if(c[i]&&j[c[i].name]){n.displayValue+=" "+j[c[i].name];}n.color=o.semanticColor;n.title=e[o.COLUMN_NAME]||o.COLUMN_NAME;f.push(n);}return f;},getTrendIndicator:function(t,v){var b=this;t=Number(t);try{var c=D.None;if(t>v){c=D.Down;}else if(t<v){c=D.Up;}return c;}catch(e){b.logError(e);}},fetchKpiValue:function(s,E){var t=this;try{var U=this.oConfig.EVALUATION.ODATA_URL,b=this.oConfig.EVALUATION.ODATA_ENTITYSET,c;if(this.oConfig.TILE_PROPERTIES.semanticMeasure){c=this.oConfig.EVALUATION.COLUMN_NAME+","+this.oConfig.TILE_PROPERTIES.semanticMeasure;}else{c=this.oConfig.EVALUATION.COLUMN_NAME;var d=c;if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES){for(var j=0;j<this.oConfig.TILE_PROPERTIES.COLUMN_NAMES.length;j++){if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[j].COLUMN_NAME!=this.oConfig.EVALUATION.COLUMN_NAME){d=d+","+this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[j].COLUMN_NAME;}}}}var f=this.oConfig.EVALUATION_VALUES;var g=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!g){var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var o={};o["0"]=c+",asc";o["1"]=c+",desc";var h=o[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");var k=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oChip.url.addSystemToServiceUrl(U),b,d,null,v,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure){k.uri+="&$orderby="+h[0]+" "+h[2];}else{k.uri+="&$orderby="+h[0]+" "+h[1];}this.writeData={};this.comparisionChartODataRef=k.model.read(k.uri,null,null,true,function(f){if(f&&f.results&&f.results.length){if(k.unit){t.writeData.unit=k.unit;}t.oConfig.TILE_PROPERTIES.FINALVALUE=f;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,d.split(",")[0],k.unit);t.writeData.data=f;var n;for(var i=0;i<t.oConfig.TILE_PROPERTIES.FINALVALUE.length;i++){if(t.oConfig.TILE_PROPERTIES.FINALVALUE[i].title==t.DEFINITION_DATA.EVALUATION.COLUMN_NAME){t.writeData.numericData=t.oConfig.TILE_PROPERTIES.FINALVALUE[i];calculatedValueforScaling=t.oConfig.TILE_PROPERTIES.FINALVALUE[i].value;t.getTrendIndicator(t.setThresholdValues().trendValue,calculatedValueforScaling);t._updateTileModel({valueColor:t.oConfig.TILE_PROPERTIES.FINALVALUE[i].color,value:sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(n),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION).toString()});break;}}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,t.writeData);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(f.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=f;t.writeData.data=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,t.writeData);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else{E.call(t,"no Response from QueryServiceUri");}},function(i){if(i&&i.response){L.error(i.message+" : "+i.request.requestUri);E.call(t,i);}});if(!t.writeData.numericData){var l=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(t.DEFINITION_DATA.EVALUATION_FILTERS,t.DEFINITION_DATA.ADDITIONAL_FILTERS);var Q=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oChip.url.addSystemToServiceUrl(U),b,c,null,l);if(Q){t.QUERY_SERVICE_MODEL=Q.model;t.queryUriForKpiValue=Q.uri;t.numericODataReadRef=t.QUERY_SERVICE_MODEL.read(Q.uri,null,null,true,function(f){if(f&&f.results&&f.results.length){if(Q.unit){t._updateTileModel({unitNumeric:f.results[0][Q.unit.name]});t.writeData.unitNumeric=Q.unit;t.writeData.unitNumeric.name=Q.unit.name;}t.writeData.numericData=f.results[0];t.DEFINITION_DATA.value=t.writeData.numericData[t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];t.writeData.numericData.color=t.getTrendColor(t.setThresholdValues());t.DEFINITION_DATA.valueColor=t.writeData.numericData.color;var i="";var n=f.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];var p=t.getTrendIndicator(t.setThresholdValues().trendValue,n);if(t.oConfig.EVALUATION.SCALING==-2){n*=100;t.getView().oNumericContent.setFormatterValue(false);}i=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(n),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);if(t.oConfig.EVALUATION.SCALING==-2){t._updateTileModel({scale:"%"});}t._updateTileModel({value:i.toString(),valueColor:t.writeData.numericData.color,indicator:p});}else{E.call(t,"no Response from QueryServiceUri");}});}}}else{if(g.unit){t._updateTileModel({unit:g.data.results[0][g.unit.name]});}if(g.data&&g.data.results&&g.data.results.length){t.oConfig.TILE_PROPERTIES.FINALVALUE=g.data;t._updateTileModel({value:g.data.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME]});t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,d,t.writeData.unit);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(f.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=g.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else{E.call(t,"no Response from QueryServiceUri");}}}catch(e){E.call(t,e);}},flowWithoutDesignTimeCall:function(){var t=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oChip.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(k){this.CALCULATED_KPI_VALUE=k;t.oDualComparisonView.oGenericTile.setFrameType("TwoByOne");t.oDualComparisonView.oGenericTile.removeAllTileContent();t.oDualComparisonView.oGenericTile.addTileContent(t.oDualComparisonView.oNumericTile);t.oDualComparisonView.oGenericTile.addTileContent(t.oDualComparisonView.oComparisonTile);var c=this.CALCULATED_KPI_VALUE;var b,d;for(var i=0;i<c.length;i++){if(c[i].title==t.DEFINITION_DATA.EVALUATION.COLUMN_NAME){d=c[i].value;b=c[i].color||"Neutral";t._updateTileModel({value:sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(d),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION).toString(),valueColor:b});break;}}if(!b&&!d){b=t.DEFINITION_DATA.valueColor;d=t.DEFINITION_DATA.value;}this._updateTileModel({value:sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(d),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION).toString(),data:this.CALCULATED_KPI_VALUE});var n=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);t.oDualComparisonView.oGenericTile.$().wrap("<a href ='"+n+"'></a>");this.oDualComparisonView.oGenericTile.setState(a.Loaded);var s="";if(b=="Error"){s="sb.error";}if(b=="Neutral"){s="sb.neutral";}if(b=="Critical"){s="sb.critical";}if(b=="Good"){s="sb.good";}var T=t.setThresholdValues();var e,f,g,v,h,j,l,o,p;if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[0]){e=this.CALCULATED_KPI_VALUE[0].title;v=this.CALCULATED_KPI_VALUE[0].value;l=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[0].color);}if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[1]){f=this.CALCULATED_KPI_VALUE[1].title;h=this.CALCULATED_KPI_VALUE[1].value;o=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[1].color);}if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[2]){g=this.CALCULATED_KPI_VALUE[2].title;j=this.CALCULATED_KPI_VALUE[2].value;p=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[2].color);}var r={status:s,actual:d,target:T.targetValue,cH:T.criticalHighValue,wH:T.warningHighValue,wL:T.warningLowValue,cL:T.criticalLowValue};var w={m1:e,v1:v,c1:l,m2:f,v2:h,c2:o,m3:g,v3:j,c3:p};var C=t.oDualComparisonView.oGenericTile.getTileContent()[0].getContent();var x=t.oDualComparisonView.oGenericTile.getTileContent()[1].getContent();sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(C,"NT",r);sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(x,"COMP",w);},this.logError);}},flowWithDesignTimeCall:function(){var t=this;try{var b=sap.ushell.components.tiles.indicatorTileUtils.cache.getEvaluationById(this.oConfig.EVALUATION.ID);if(b){t.oConfig.EVALUATION_FILTERS=b.EVALUATION_FILTERS;t.flowWithoutDesignTimeCall();}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,function(f){t.oConfig.EVALUATION_FILTERS=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall();});}}catch(e){this.logError(e);}},refreshHandler:function(c){if(!c.firstTimeVisible){if(Number(this.oChip.configuration.getParameterValueAsString("isSufficient"))){c.flowWithoutDesignTimeCall();}else{c.flowWithDesignTimeCall();}}},visibleHandler:function(i){if(!i){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef);}if(i){this.refreshHandler(this);}},onInit:function(){var t=this;this.firstTimeVisible=false;this.oDualComparisonView=this.getView();this.oChip=this.oDualComparisonView.getViewData().chip;if(this.oChip.visible){this.oChip.visible.attachVisible(this.visibleHandler.bind(this));}this.system=this.oChip.url.getApplicationSystem();this.oDualComparisonView.oGenericTile.setState(a.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(this.oChip.configuration.getParameterValueAsString("tileConfiguration"),this.oChip.preview.isEnabled(),function(c){t.oConfig=c;if(t.oChip.preview){t.oChip.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system));}if(t.oChip.preview.isEnabled()){t.setTitle();t._updateTileModel({value:1,size:S.Auto,frameType:"TwoByOne",state:a.Loading,valueColor:V.Good,indicator:D.None,title:"Liquidity Structure",footer:"Current Quarter",description:"Apr 1st 2013 (B$)",data:[{title:"Measure 1",value:1,color:"Good"},{title:"Measure 2",value:2,color:"Good"},{title:"Measure 3",value:3,color:"Good"}]});t.oDualComparisonView.oGenericTile.setState(a.Loaded);}else{t.setTitle();t.oDualComparisonView.oGenericTile.attachPress(function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(t.comparisionChartODataRef);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);});if(Number(t.oChip.configuration.getParameterValueAsString("isSufficient"))){sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall();}else{t.flowWithDesignTimeCall();}}});}catch(e){this.logError(e);}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef);}});return{};},true);
