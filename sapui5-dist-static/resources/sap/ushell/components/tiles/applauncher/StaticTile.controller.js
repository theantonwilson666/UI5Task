// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ushell/components/tiles/utils","sap/ushell/components/tiles/utilsRT","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/Config","sap/ushell/services/AppType","sap/ushell/utils/WindowUtils","sap/m/library","sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/thirdparty/jquery"],function(C,u,a,A,b,c,W,l,J,L,q){"use strict";var G=l.GenericTileScope;var d=l.GenericTileMode;C.extend("sap.ushell.components.tiles.applauncher.StaticTile",{_aDoableObject:{},onInit:function(){var s=this.getView(),v=s.getViewData(),t=v.chip,o=a.getConfiguration(t,t.configurationUi.isEnabled(),false),m,k,K,e=this,N=o.navigation_target_url,S,U,h;this.oShellModel=A.getElementsModel();S=t.url.getApplicationSystem();if(S){U=sap.ushell.Container.getService("URLParsing");if(U.isIntentUrl(N)){h=U.parseShellHash(N);if(!h.params){h.params={};}h.params["sap-system"]=S;N="#"+U.constructShellHash(h);}else{N+=((N.indexOf("?")<0)?"?":"&")+"sap-system="+S;}}this.navigationTargetUrl=N;m=new J({sizeBehavior:b.last("/core/home/sizeBehavior"),wrappingType:b.last("/core/home/wrappingType"),mode:o.display_mode,config:o,nav:{navigation_target_url:(t.configurationUi&&t.configurationUi.isEnabled()?"":N)},search:{display_highlight_terms:[]}});s.setModel(m);this._aDoableObject=b.on("/core/home/sizeBehavior").do(function(i){m.setProperty("/sizeBehavior",i);});if(t.types){t.types.attachSetType(function(T){if(e.tileType!==T){if(T==="link"){m.setProperty("/mode",d.LineMode);}else{m.setProperty("/mode",m.getProperty("/config/display_mode"));}e.tileType=T;}});}if(!this.tileType){this.tileType="tile";}if(t.search){k=s.getModel().getProperty("/config/display_search_keywords");K=k.split(/[, ]+/).filter(function(n){return n&&n!=="";});if(o.display_title_text&&o.display_title_text!==""&&K.indexOf(o.display_title_text)===-1){K.push(o.display_title_text);}if(o.display_subtitle_text&&o.display_subtitle_text!==""&&K.indexOf(o.display_subtitle_text)===-1){K.push(o.display_subtitle_text);}if(o.display_info_text&&o.display_info_text!==""&&K.indexOf(o.display_info_text)===-1){K.push(o.display_info_text);}t.search.setKeywords(K);t.search.attachHighlight(function(H){s.getModel().setProperty("/search/display_highlight_terms",H);});}if(t.bag&&t.bag.attachBagsUpdated){t.bag.attachBagsUpdated(function(i){if(i.indexOf("tileProperties")>-1){u._updateTilePropertiesTexts(s,t.bag.getBag("tileProperties"));}});}if(t.configuration&&t.configuration.attachConfigurationUpdated){t.configuration.attachConfigurationUpdated(function(i){if(i.indexOf("tileConfiguration")>-1){u._updateTileConfiguration(s,t.configuration.getParameterValueAsString("tileConfiguration"));}});}if(t.preview){t.preview.setTargetUrl(N);t.preview.setPreviewIcon(o.display_icon_url);t.preview.setPreviewTitle(o.display_title_text);if(t.preview.setPreviewSubtitle&&typeof t.preview.setPreviewSubtitle==="function"){t.preview.setPreviewSubtitle(o.display_subtitle_text);}}if(t.configurationUi.isEnabled()){t.configurationUi.setUiProvider(function(){var i=u.getConfigurationUi(s,"sap.ushell.components.tiles.applauncher.Configuration");t.configurationUi.attachCancel(e.onCancelConfiguration.bind(null,i));t.configurationUi.attachSave(e.onSaveConfiguration.bind(null,i));return i;});this.getView().getContent()[0].setTooltip(u.getResourceBundleModel().getResourceBundle().getText("edit_configuration.tooltip"));}if(t.actions){var f=o.actions,E;if(f){E=f.slice();}else{E=[];}if(b.last("/core/shell/enablePersonalization")){var T=m.getProperty("/mode")===d.LineMode?"link":"tile",g=a.getTileSettingsAction(m,this.onSaveRuntimeSettings.bind(this),T);E.push(g);}t.actions.setActionsProvider(function(){return E;});}},onExit:function(){this._aDoableObject.off();},onPress:function(e){var s=this.getView(),v=s.getViewData(),t=v.chip,T=s.getModel().getProperty("/config");if(e.getSource().getScope&&e.getSource().getScope()===G.Display){if(t.configurationUi.isEnabled()){t.configurationUi.display();}else if(this.navigationTargetUrl){if(this.navigationTargetUrl[0]==="#"){hasher.setHash(this.navigationTargetUrl);}else{var f=b.last("/core/shell/enableRecentActivity")&&b.last("/core/shell/enableRecentActivityLogging");if(f){var r={title:T.display_title_text,appType:c.URL,url:T.navigation_target_url,appId:T.navigation_target_url};sap.ushell.Container.getRenderer("fiori2").logRecentActivity(r);}W.openURL(this.navigationTargetUrl,"_blank");}}}},onSaveRuntimeSettings:function(s){var v=s.getModel(),t=this.getView().getViewData().chip,o=this.getView().getModel().getProperty("/config");o.display_title_text=v.getProperty("/title")||"";o.display_subtitle_text=v.getProperty("/subtitle")||"";o.display_info_text=v.getProperty("/info")||"";o.display_search_keywords=v.getProperty("/keywords")||"";var e=t.bag.getBag("tileProperties");e.setText("display_title_text",o.display_title_text);e.setText("display_subtitle_text",o.display_subtitle_text);e.setText("display_info_text",o.display_info_text);e.setText("display_search_keywords",o.display_search_keywords);function f(E){L.error(E,null,"sap.ushell.components.tiles.applauncher.StaticTile.controller");}e.save(function(){L.debug("property bag 'tileProperties' saved successfully");this.getView().getModel().setProperty("/config/display_title_text",o.display_title_text);this.getView().getModel().setProperty("/config/display_subtitle_text",o.display_subtitle_text);this.getView().getModel().setProperty("/config/display_info_text",o.display_info_text);this.getView().getModel().setProperty("/config/display_search_keywords",o.display_search_keywords);this.getView().getModel().refresh();}.bind(this),f);},onSaveConfiguration:function(o){var D=new q.Deferred();var m=o.getModel();var t=m.getProperty("/tileModel");var T=o.getViewData().chip;var e=u.tileActionsRows2TileActionsArray(m.getProperty("/config/tile_actions_rows"));var f={display_icon_url:m.getProperty("/config/display_icon_url"),navigation_use_semantic_object:m.getProperty("/config/navigation_use_semantic_object"),navigation_target_url:m.getProperty("/config/navigation_target_url"),navigation_semantic_object:q.trim(m.getProperty("/config/navigation_semantic_object"))||"",navigation_semantic_action:q.trim(m.getProperty("/config/navigation_semantic_action"))||"",navigation_semantic_parameters:q.trim(m.getProperty("/config/navigation_semantic_parameters")),display_search_keywords:m.getProperty("/config/display_search_keywords")};var r=u.checkInputOnSaveConfig(o);if(!r){r=u.checkTileActions(o);}if(r){D.reject("mandatory_fields_missing");return D.promise();}if(f.navigation_use_semantic_object){f.navigation_target_url=a.getSemanticNavigationUrl(f);m.setProperty("/config/navigation_target_url",f.navigation_target_url);}var g=T.bag.getBag("tileProperties");g.setText("display_title_text",m.getProperty("/config/display_title_text"));g.setText("display_subtitle_text",m.getProperty("/config/display_subtitle_text"));g.setText("display_info_text",m.getProperty("/config/display_info_text"));g.setText("display_search_keywords",f.display_search_keywords);var h=T.bag.getBag("tileNavigationActions");u.populateTileNavigationActionsBag(h,e);function i(E,j){L.error(E,null,"sap.ushell.components.tiles.applauncher.StaticTile.controller");D.reject(E,j);}T.writeConfiguration.setParameterValues({tileConfiguration:JSON.stringify(f)},function(){var j=a.getConfiguration(T,false,false),k=a.getConfiguration(T,true,false),m=new J({config:j,nav:{navigation_target_url:""},tileModel:t});o.setModel(m);t.setData({config:k,nav:{navigation_target_url:""}},false);if(T.preview){T.preview.setTargetUrl(j.navigation_target_url);T.preview.setPreviewIcon(j.display_icon_url);T.preview.setPreviewTitle(j.display_title_text);if(T.preview.setPreviewSubtitle&&typeof T.preview.setPreviewSubtitle==="function"){T.preview.setPreviewSubtitle(j.display_subtitle_text);}}g.save(function(){L.debug("property bag 'tileProperties' saved successfully");if(T.title){T.title.setTitle(j.display_title_text,function(){D.resolve();},i);}else{D.resolve();}},i);h.save(function(){L.debug("property bag 'navigationProperties' saved successfully");},i);},i);return D.promise();},onCancelConfiguration:function(o){var v=o.getViewData(),m=o.getModel(),t=m.getProperty("/tileModel"),T=v.chip,e=a.getConfiguration(T,T.configurationUi.isEnabled(),false);o.getModel().setData({config:e,nav:{navigation_target_url:""},tileModel:t},false);},formatters:{leanURL:W.getLeanURL}});},false);
