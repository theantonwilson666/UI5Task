// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/generic","sap/m/library","sap/ui/thirdparty/jquery","sap/base/Log"],function(g,m,q,L){"use strict";var D=m.DeviationIndicator;var V=m.ValueColor;var S=m.Size;var a=m.LoadState;var F=m.FrameType;var C=g.extend("sap.ushell.components.tiles.indicatorcontribution.ContributionTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false;},_processDataForComparisonChart:function(d,b,f,u){var s=this.oConfig.TILE_PROPERTIES.semanticColorContribution;var h=[];var t;var j;for(var i=0;i<d.results.length;i++){var k=d.results[i];var l={};try{l.title=k[f].toString();}catch(e){l.title="";}l.value=Number(k[b]);var n=Number(k[b]);if(this.oConfig.EVALUATION.SCALING==-2){n*=100;}var c=this.isCurrencyMeasure(b);j=k[u];t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(n,this.oConfig.EVALUATION.SCALING,this.oConfig.EVALUATION.DECIMAL_PRECISION,c,j);l.displayValue=t.toString();if(typeof s==="undefined"){l.color="Neutral";}else{l.color=s;}if(l&&u){l[u]=j;}h.push(l);}return h;},fetchChartData:function(r,i,s,E){var t=this;try{var b=this.oConfig.EVALUATION.ODATA_ENTITYSET,c;t.setThresholdValues();if(this.oConfig.TILE_PROPERTIES.semanticMeasure){c=this.oConfig.EVALUATION.COLUMN_NAME+","+this.oConfig.TILE_PROPERTIES.semanticMeasure;}else{c=this.oConfig.EVALUATION.COLUMN_NAME;}var u=null;var d=this.oConfig.TILE_PROPERTIES.dimension;var f=sap.ushell.components.tiles.indicatorTileUtils.util.getBoolValue(r);var h=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){if(h){var j=h.Data&&JSON.parse(h.Data);}}var k=t.oTileApi.configuration.getParameterValueAsString("timeStamp");var l=sap.ushell.components.tiles.indicatorTileUtils.util.isCacheValid(t.oConfig.TILE_PROPERTIES.id,k,t.chipCacheTime,t.chipCacheTimeUnit,t.tilePressed);if((j&&!j.rightData)||!h||(!l&&t.oTileApi.visible.isVisible())||f||(i&&t.oTileApi.visible.isVisible())||t.getView().getViewData().refresh){if(t.kpiValueFetchDeferred){t.kpiValueFetchDeferred=false;var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var o={};o["0"]=c+",asc";o["1"]=c+",desc";o["2"]=d+",asc";o["3"]=d+",desc";var n=o[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");var p=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oRunTimeODataModel,b,c,d,v,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure){p.uri+="&$top=3&$orderby="+n[0]+" "+n[2];}else{p.uri+="&$top=3&$orderby="+n[0]+" "+n[1];}this.comparisionChartODataRef=p.model.read(p.uri,null,null,true,function(y){t.kpiValueFetchDeferred=true;var z={};if(y&&y.results&&y.results.length){if(p.unit[0]){t._updateTileModel({unit:y.results[0][p.unit[0].name]});u=p.unit[0].name;z.unit=p.unit[0];z.unit.name=p.unit[0].name;}d=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(t.oRunTimeODataModel,b,d);z.dimension=d;t.oConfig.TILE_PROPERTIES.FINALVALUE=y;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,c.split(",")[0],d,u);z.data=t.oConfig.TILE_PROPERTIES.FINALVALUE;z.isCurM=t.isACurrencyMeasure(t.oConfig.EVALUATION.COLUMN_NAME);var A={};t.cacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();A.ChipId=t.oConfig.TILE_PROPERTIES.id;A.Data=JSON.stringify(z);A.CacheMaxAge=Number(t.chipCacheTime);A.CacheMaxAgeUnit=t.chipCacheTimeUnit;A.CacheType=1;var B=t.getLocalCache(A);t.updateDatajobScheduled=false;var G=t.oConfig.TILE_PROPERTIES.id+"data";var H=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(G);if(H){clearTimeout(H);H=undefined;}if(!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,B);var U=false;if(h){U=true;}if(t.chipCacheTime){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(t.oTileApi,t.oConfig.TILE_PROPERTIES.id,A,U,function(y){if(y){t.cacheTime=y&&y.CachedTime;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,y);}if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){q.proxy(t.setTimeStamp(t.cacheTime),t);}});}}else{var I=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id),J;if(I){if(!I.CachedTime){I.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();}J=I.Data;if(J){J=JSON.parse(J);if(t.oKpiTileView.getViewName()=="tiles.indicatornumeric.NumericTile"){J.leftData=z;}else{J.rightData=z;}}I.Data=JSON.stringify(J);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,I);}else{J={};J.rightData=z;B.Data=JSON.stringify(J);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,B);}t.cacheWriteData=z;}s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(y.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=y;if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id)){z=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);z.data=y;}else{z.data=y;}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,z);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);t.setNoData();}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,{empty:"empty"});t.setNoData();}},function(y){t.kpiValueFetchDeferred=true;if(y&&y.response){L.error(y.message+" : "+y.request.requestUri);E.call(t,y);}});}}else if(h&&h.Data){var w;var x=t.oConfig&&t.oConfig.TILE_PROPERTIES&&t.oConfig.TILE_PROPERTIES.tileType;if(x.indexOf("DT-")==-1){w=h.Data&&JSON.parse(h.Data);}else{w=h.Data&&JSON.parse(h.Data);w=w.rightData;}t.cacheTime=h.CachedTime;if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){q.proxy(t.setTimeStamp(t.cacheTime),t);}if(w.data&&w.data.length){if(w.unit){t._updateTileModel({unit:w.data[0][w.unit.name]});}d=w.dimension;t.oConfig.TILE_PROPERTIES.FINALVALUE=w.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(w&&w.data&&w.data instanceof Array&&w.data.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=w.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);t.setNoData();}else{t.setNoData();}}else{t.setNoData();}}catch(e){t.kpiValueFetchDeferred=true;E.call(t,e);}},doProcess:function(r,i){var t=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);this.setTextInTile();this.fetchChartData(r,i,function(k){this.CALCULATED_KPI_VALUE=k;this._updateTileModel({data:this.CALCULATED_KPI_VALUE});if(t.oConfig.TILE_PROPERTIES.frameType==F.TwoByOne){t.oKpiTileView.oGenericTile.setFrameType(F.TwoByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.getView().getViewData().parentController._updateTileModel(this.getTile().getModel().getData());t.getView().getViewData().deferredObj.resolve();}else{t.oKpiTileView.oGenericTile.setFrameType(F.OneByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.oKpiTileView.oGenericTile.addTileContent(t.oKpiTileView.oNVConfS);this.oKpiTileView.oGenericTile.setState(a.Loaded);}this.setToolTip(null,this.CALCULATED_KPI_VALUE,"CONT");if(this.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(this.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(this,this.oTileApi.visible.isVisible());}},this.logError);},doDummyProcess:function(){var t=this;t.setTextInTile();t._updateTileModel({value:8888,size:S.Auto,frameType:F.OneByOne,state:a.Loading,valueColor:V.Error,indicator:D.None,title:"US Profit Margin",footer:"Current Quarter",description:"Maximum deviation",data:[{title:"Americas",value:10,color:"Neutral"},{title:"EMEA",value:50,color:"Neutral"},{title:"APAC",value:-20,color:"Neutral"}]});this.oKpiTileView.oGenericTile.setState(a.Loaded);}});return C;});
