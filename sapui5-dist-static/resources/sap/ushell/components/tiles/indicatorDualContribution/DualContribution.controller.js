// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/ui/thirdparty/jquery","sap/base/Log"],function(m,q,L){"use strict";var V=m.ValueColor;var S=m.Size;var D=m.DeviationIndicator;var a=m.LoadState;sap.ui.controller("tiles.indicatorDualContribution.DualContribution",{getTile:function(){return this.oDualContributionView.oGenericTile;},_updateTileModel:function(n){var b=this.getTile().getModel().getData();q.extend(b,n);this.getTile().getModel().setData(b);this.getTile().getModel().updateBindings();},setTitle:function(){var t=this;var b=sap.ushell.components.tiles.indicatorTileUtils.util.getTileTitleSubtitle(this.oChip);this._updateTileModel({header:b.title||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(t.oConfig),subheader:b.subTitle||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(t.oConfig)});},formSelectStatement:function(o){var t=Object.keys(o);var f="";for(var i=0;i<t.length;i++){if((o[t[i]]!==undefined)&&(o.fullyFormedMeasure)){f+=","+o[t[i]];}}return f;},logError:function(e){this.oDualContributionView.oGenericTile.setState(a.Failed);this.oDualContributionView.oGenericTile.setState(a.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e);},setThresholdValues:function(){var t=this;try{var T={};T.fullyFormedMeasure=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(this.DEFINITION_DATA.EVALUATION.GOAL_TYPE){case"MI":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"MA":T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"RA":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;}}else{T.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","FIXED");T.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","FIXED");T.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","FIXED");T.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","FIXED");T.targetValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","FIXED");T.trendValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","FIXED");}return T;}catch(e){t.logError(e);}},getTrendIndicator:function(t,v){var b=this;t=Number(t);try{var c=D.None;if(t>v){c=D.Down;}else if(t<v){c=D.Up;}return c;}catch(e){b.logError(e);}},_processDataForComparisonChart:function(d,b,c){var s=this.oConfig.TILE_PROPERTIES.semanticMeasure;var f=[];var t;for(var i=0;i<d.results.length;i++){var g=d.results[i];var h={};try{h.title=g[c].toString();}catch(e){h.title="";}h.value=Number(g[b]);var j=Number(g[b]);if(this.oConfig.EVALUATION.SCALING==-2){j*=100;}t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(j,this.oConfig.EVALUATION.SCALING,this.oConfig.EVALUATION.DECIMAL_PRECISION);h.displayValue=t.toString();if(typeof s==="undefined"){h.color="Neutral";}else if(this.oConfig.EVALUATION.GOAL_TYPE==="MA"){if(h.value>g[s]){h.color="Good";}else{h.color="Error";}}else if(this.oConfig.EVALUATION.GOAL_TYPE==="MI"){if(h.value<g[s]){h.color="Good";}else{h.color="Error";}}else{h.color="Neutral";}f.push(h);}return f;},fetchKpiValue:function(s,E){var t=this;try{var u=this.oConfig.EVALUATION.ODATA_URL,b=this.oConfig.EVALUATION.ODATA_ENTITYSET,c;if(this.oConfig.TILE_PROPERTIES.semanticMeasure){c=this.oConfig.EVALUATION.COLUMN_NAME+","+this.oConfig.TILE_PROPERTIES.semanticMeasure;}else{c=this.oConfig.EVALUATION.COLUMN_NAME;}var d=this.oConfig.TILE_PROPERTIES.dimension;var f=this.oConfig.EVALUATION_VALUES;var g=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!g){var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var o={};o["0"]=c+",asc";o["1"]=c+",desc";o["2"]=d+",asc";o["3"]=d+",desc";var h=o[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");var i=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oChip.url.addSystemToServiceUrl(u),b,c,d,v,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure){i.uri+="&$top=3&$orderby="+h[0]+" "+h[2];}else{i.uri+="&$top=3&$orderby="+h[0]+" "+h[1];}this.comparisionChartODataRef=i.model.read(i.uri,null,null,true,function(f){if(i.unit[0]){t._updateTileModel({unitContribution:f.results[0][i.unit[0].name]});t.writeData.unitContribution=i.unit[0];t.writeData.unitContribution.name=i.unit[0].name;}if(f&&f.results&&f.results.length){d=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(t.oChip.url.addSystemToServiceUrl(u),b,d);t.writeData.dimension=d;t.oConfig.TILE_PROPERTIES.FINALVALUE=f;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,c.split(",")[0],d);t.writeData.data=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,t.writeData);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(f.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=f;t.writeData.data=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,t.writeData);}else{E.call(t,"no Response from QueryServiceUri");}},function(p){if(p&&p.response){L.error(p.message+" : "+p.request.requestUri);E.call(t,p);}});var j=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(t.DEFINITION_DATA.EVALUATION_FILTERS,t.DEFINITION_DATA.ADDITIONAL_FILTERS);var Q=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oChip.url.addSystemToServiceUrl(u),b,c,null,j);if(Q){t.QUERY_SERVICE_MODEL=Q.model;t.queryUriForKpiValue=Q.uri;t.numericODataReadRef=t.QUERY_SERVICE_MODEL.read(Q.uri,null,null,true,function(f){if(f&&f.results&&f.results.length){if(Q.unit){t._updateTileModel({unitNumeric:f.results[0][Q.unit.name]});t.writeData.unitNumeric=Q.unit;t.writeData.unitNumeric.name=Q.unit.name;}t.writeData.numericData=f;var l="";var k=f.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];var n=t.getTrendIndicator(t.setThresholdValues().trendValue,k);if(t.oConfig.EVALUATION.SCALING==-2){k*=100;t.getView().oNumericContent.setFormatterValue(false);}t.DEFINITION_DATA.value=k;l=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(k),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);if(t.oConfig.EVALUATION.SCALING==-2){t._updateTileModel({scale:"%"});}t._updateTileModel({value:l.toString(),valueColor:t.DEFINITION_DATA.TILE_PROPERTIES.semanticColorContribution,indicator:n});s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE,k);}else{E.call(t,"no Response from QueryServiceUri");}});}}else{var T=t.setThresholdValues();var k;if(g.unitContribution){t._updateTileModel({unitContribution:g.data.results[0][g.unitContribution.name]});}if(g.unitNumeric){t._updateTileModel({unitNumeric:g.numericData.results[0][g.unitNumeric.name]});}if(g.data&&g.data.results&&g.data.results.length){d=g.dimension;t.oConfig.TILE_PROPERTIES.FINALVALUE=g.data;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,c.split(",")[0],d);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(f.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=g.data;}else{E.call(t,"no Response from QueryServiceUri");}if(g.numericData&&g.numericData.results&&g.numericData.results.length){k=g.numericData.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(t.oConfig.EVALUATION.SCALING==-2){k*=100;t.getView().oNumericContent.setFormatterValue(false);}var l=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(k),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);if(t.oConfig.EVALUATION.SCALING==-2){t._updateTileModel({scale:"%"});}var n=t.getTrendIndicator(T.trendValue,k);t._updateTileModel({value:l.toString(),indicator:n,valueColor:t.DEFINITION_DATA.TILE_PROPERTIES.semanticColorContribution});s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE,k);}else{E.call(t,"no Response from QueryServiceUri");}}}catch(e){E.call(t,e);}},flowWithoutDesignTimeCall:function(){var t=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oChip.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(k,c){this.CALCULATED_KPI_VALUE=k;if(t.oConfig.TILE_PROPERTIES.frameType=="TwoByOne"){t.oDualContributionView.oGenericTile.setFrameType("TwoByOne");t.oDualContributionView.oGenericTile.removeAllTileContent();t.oDualContributionView.oGenericTile.addTileContent(t.oDualContributionView.oNumericTile);t.oDualContributionView.oGenericTile.addTileContent(t.oDualContributionView.oComparisonTile);}else{t.oDualContributionView.oGenericTile.setFrameType("OneByOne");t.oDualContributionView.oGenericTile.removeAllTileContent();t.oDualContributionView.oGenericTile.addTileContent(t.oDualContributionView.oComparisonTile);}var d=this.CALCULATED_KPI_VALUE;var b=this.DEFINITION_DATA.TILE_PROPERTIES.semanticColorContribution;for(var i=0;i<this.CALCULATED_KPI_VALUE.length;i++){d[i].color=b;}this._updateTileModel({data:d});var T=t.setThresholdValues();var n=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);t.oDualContributionView.oGenericTile.$().wrap("<a href ='"+n+"'></a>");this.oDualContributionView.oGenericTile.setState(a.Loaded);var s="";if(b=="Error"){s="sb.error";}if(b=="Neutral"){s="sb.neutral";}if(b=="Critical"){s="sb.critical";}if(b=="Good"){s="sb.good";}T=t.setThresholdValues();var e,f,g,v,h,j,l,o,p;if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[0]){e=this.CALCULATED_KPI_VALUE[0].title;v=this.CALCULATED_KPI_VALUE[0].value;l=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[0].color);}if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[1]){f=this.CALCULATED_KPI_VALUE[1].title;h=this.CALCULATED_KPI_VALUE[1].value;o=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[1].color);}if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[2]){g=this.CALCULATED_KPI_VALUE[2].title;j=this.CALCULATED_KPI_VALUE[2].value;p=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[2].color);}var r={status:s,actual:c,target:T.targetValue,cH:T.criticalHighValue,wH:T.warningHighValue,wL:T.warningLowValue,cL:T.criticalLowValue};var u={m1:e,v1:v,c1:l,m2:f,v2:h,c2:o,m3:g,v3:j,c3:p};var C=t.oDualContributionView.oGenericTile.getTileContent()[0].getContent();var w=t.oDualContributionView.oGenericTile.getTileContent()[1].getContent();sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(C,"NT",r);sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(w,"CONT",u);},this.logError);}},flowWithDesignTimeCall:function(){var t=this;try{var b=sap.ushell.components.tiles.indicatorTileUtils.cache.getEvaluationById(this.oConfig.EVALUATION.ID);if(b){t.oConfig.EVALUATION_FILTERS=b.EVALUATION_FILTERS;t.flowWithoutDesignTimeCall();}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,function(f){t.oConfig.EVALUATION_FILTERS=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall();});}}catch(e){this.logError(e);}},refreshHandler:function(c){if(!c.firstTimeVisible){if(Number(this.oChip.configuration.getParameterValueAsString("isSufficient"))){c.flowWithoutDesignTimeCall();}else{c.flowWithDesignTimeCall();}}},visibleHandler:function(i){if(!i){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef);}if(i){this.refreshHandler(this);}},onInit:function(){var t=this;t.writeData={};this.firstTimeVisible=false;this.oDualContributionView=this.getView();this.oChip=this.oDualContributionView.getViewData().chip;if(this.oChip.visible){this.oChip.visible.attachVisible(this.visibleHandler.bind(this));}this.system=this.oChip.url.getApplicationSystem();this.oDualContributionView.oGenericTile.setState(a.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(this.oChip.configuration.getParameterValueAsString("tileConfiguration"),this.oChip.preview.isEnabled(),function(c){t.oConfig=c;if(t.oChip.preview){t.oChip.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system));}if(t.oChip.preview.isEnabled()){t.setTitle();t._updateTileModel({value:8888,size:S.Auto,frameType:"TwoByOne",state:a.Loading,valueColor:V.Error,indicator:D.None,title:"US Profit Margin",footer:"Current Quarter",description:"Maximum deviation",data:[{title:"Americas",value:10,color:"Neutral",displayValue:""},{title:"EMEA",value:50,color:"Neutral",displayValue:""},{title:"APAC",value:-20,color:"Neutral",displayValue:""}]});t.oDualContributionView.oGenericTile.setState(a.Loaded);}else{t.setTitle();t.oDualContributionView.oGenericTile.attachPress(function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(t.comparisionChartODataRef);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);});if(Number(t.oChip.configuration.getParameterValueAsString("isSufficient"))){sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall();}else{t.flowWithDesignTimeCall();}}});}catch(e){this.logError(e);}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef);}});},true);
