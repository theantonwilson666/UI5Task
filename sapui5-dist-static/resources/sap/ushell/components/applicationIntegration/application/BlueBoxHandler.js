// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/applicationIntegration/application/Application","sap/ushell/components/container/ApplicationContainer","sap/ushell/EventHub","sap/ui/thirdparty/URI","sap/ushell/components/applicationIntegration/application/PostMessageAPI","sap/ui/thirdparty/jquery","sap/base/Log","sap/base/util/UriParameters","sap/base/security/encodeXML"],function(A,a,E,U,P,q,L,b,e){"use strict";function B(){var c,m={},t=this,d,C={"isStateful":{handler:function(i,j){if(i&&(i.enabled===true||i===true)){return true;}return false;}},"isGUI":{handler:function(i,j){if(i&&i.protocol==="GUI"){return true;}return false;}},"isGUIStateful":{handler:function(i,j){return t.isCapUT(j,"isGUI")&&t.isCapUT(j,"isStateful");}},"isFLP":{handler:function(i,j){return!t.isCapUT(j,"isGUI")&&t.isCapUT(j,"isStateful");}}},o={},s={},S={},h={setup:function(T,i){},create:function(i,u,j,T){var D=new q.Deferred(),F,p;function k(){if(F){F["sap-flp-url"]=sap.ushell.Container.getFLPUrl(true);p["sap-flp-params"]=e(JSON.stringify(F));}o[i].lastAction=g.APP_OPENED;sap.ui.getCore().getEventBus().publish("launchpad","appOpening",T);A.postMessageToIframeApp(i,"sap.ushell.services.appLifeCycle","create",p,true).then(function(){o[i].currentAppTarget=T;sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",T);D.resolve();});}u=a.prototype._checkNwbcUrlAdjustment(i,T.applicationType,u);u=a.prototype._adjustURLForIsolationOpeningWithoutURLTemplate(u);p={sCacheId:j,sUrl:u,sHash:window.hasher.getHash()};if(t._isOpenWithPost()===true){var I=[];var K=a.prototype._getParamKeys(u,I);if(K.length>0){var l=sap.ushell.Container.getService("CrossApplicationNavigation");l.getAppStateData(K).then(function(n){F={};I.forEach(function(r,v){if(n[v][0]){F[r]=n[v][0];}});k();},function(n){k();});}else{F={};k();}}else{k();}return D.promise();},destroy:function(i,j){var p;if(o[i].lastAction===g.APP_CLOSED){return Promise.resolve();}o[i].lastAction=g.APP_CLOSED;p=A.postMessageToIframeApp(i,"sap.ushell.services.appLifeCycle","destroy",{sCacheId:j},true);p.then(function(){sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",o[i].currentAppTarget);o[i].currentAppTarget=undefined;});return p;},store:function(i,j){var p;if(o[i].lastAction===g.APP_CLOSED){return Promise.resolve();}o[i].lastAction=g.APP_CLOSED;p=A.postMessageToIframeApp(i,"sap.ushell.services.appLifeCycle","store",{sCacheId:j},true);p.then(function(){sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",o[i].currentAppTarget);o[i].currentAppTarget=undefined;});return p;},restore:function(i,j,T){var p;o[i].lastAction=g.APP_OPENED;sap.ui.getCore().getEventBus().publish("launchpad","appOpening",T);p=A.postMessageToIframeApp(i,"sap.ushell.services.appLifeCycle","restore",{sCacheId:j,sUrl:T.url,sHash:window.hasher.getHash()},true);p.then(function(){o[i].currentAppTarget=T;sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",T);});return p;}},f=[{service:"sap.ushell.services.appLifeCycle",action:"create"},{service:"sap.ushell.services.appLifeCycle",action:"destroy"}],g={APP_OPENED:"app_opened",APP_CLOSED:"app_closed"};this._isOpenWithPost=function(){return((new b(window.location.href)).get("sap-post")==="true");};this.subscribePluginAgents=function(i,j){Object.keys(i).map(function(k){if(!m[k]){m[k]=[];}m[k].push(j);});};this._managePluginAgents=function(i){var t=this;var H=function(j,I,k,p){var l={"loading":{sInterface:"agentLoading"},"started":{sInterface:"agentStart"},"exit":{sInterface:"agentExit"}},n=l[k.status];if(n){if(I[n.sInterface]){I[n.sInterface](j,p,k);}}};i.forEach(function(M){var I=M.pluginComp.componentHandle.getInstance();Object.keys(o).map(function(j){Object.keys(M.agents).map(function(p){if(o[j].PlugIns&&o[j].PlugIns[p]){var k=o[j].PlugIns[p];H(o[j].BlueBox,I,k,p);}});});t.subscribePluginAgents(M.agents,function(j,p,k){H(j,I,k,p);});});};this.startPluginAgentsLifeCycle=function(){var t=this;sap.ushell.Container.getServiceAsync("PluginManager").then(function(p){p.registerAgentLifeCycleManager(t._managePluginAgents.bind(t));});};this.init=function(i,j,k){var t=this;c={};A.init(this);d=k;E.once("StepDone").do(function(){t.startPluginAgentsLifeCycle();});E.once("pluginConfiguration").do(function(l){var s={};Object.keys(l).forEach(function(K){if(l[K].config&&l[K].config["sap-component-agents"]){s=q.extend(true,s,l[K].config["sap-component-agents"]);}});t.setStartupPlugins(s);});if(j){S=q.extend(true,S,j.supportedTypes);}P.registerShellCommunicationHandler({"sap.ushell.appRuntime":{oServiceCalls:{"startupPlugins":{executeServiceCallFn:function(l){return new q.Deferred().resolve(s).promise();}},"shellCheck":{executeServiceCallFn:function(l){return new q.Deferred().resolve({InShell:true}).promise();}}}},"sap.ushell.services.pluginManager":{oServiceCalls:{"status":{executeServiceCallFn:function(l){var n=l.oMessageData.body,p;if(l.oContainer&&o[l.oContainer]&&n&&n.name&&o[l.oContainer].PlugIns[n.name]){o[l.oContainer].PlugIns[n.name].status=n.status;p=m[n.name];if(p){p.map(function(r){r(l.oContainer,n.name,n);});}return new q.Deferred().resolve(o[l.oContainer].PlugIns).promise();}return new q.Deferred().resolve({}).promise();}}}}});};this.setStartupPlugins=function(i){s=JSON.parse(JSON.stringify(i));Object.keys(s).forEach(function(k){s[k].status="unknown";});};this.getPluginAgentStatus=function(i,j){return JSON.parse(JSON.stringify(o[i].PlugIns[j]));};this.isStatefulContainerSupported=function(i){var I=this.isCapabilitySupported(i,"sap.ushell.services.appLifeCycle","create")&&this.isCapabilitySupported(i,"sap.ushell.services.appLifeCycle","destroy");return I;};this.isKeepAliveSupported=function(i){var I=this.isCapabilitySupported(i,"sap.ushell.services.appLifeCycle","store")&&this.isCapabilitySupported(i,"sap.ushell.services.appLifeCycle","restore");return I;};this.mapCapabilities=function(i,j){this.setCapabilities(i,j);};this.getCapabilities=function(i){return o[i].oCapMap;};this.isCapabilitySupported=function(i,j,I){if(o[i]&&o[i].oCapMap&&o[i].oCapMap[j]){return!!o[i].oCapMap[j][I];}return false;};this.setCapabilities=function(i,j){var k;if(!o[i]){this.InitBlueBoxBD(i);}if(!o[i].oCapMap){o[i].oCapMap={};}k=o[i].oCapMap;Object.keys(j).forEach(function(l){var n=j[l],p;if(!k[n.service]){k[n.service]={};}p=k[n.service];p[n.action]=true;});if(!i.getIsStateful()&&this.isStatefulContainerSupported(i)){i.setIsStateful(true);}};this.removeCapabilities=function(i){if(o[i]){o[i].oCapMap={};i.setIsStateful(false);}};this.hasIFrame=function(i){if(i&&i._getIFrame){return true;}return false;};this.getStorageKey=function(i){return o[i].sStorageKey;};this.InitBlueBoxBD=function(i){o[i]={BlueBox:i,PlugIns:JSON.parse(JSON.stringify(s)),lastAction:undefined};};this.setAppCapabilities=function(i,T){if(!o[i]){this.InitBlueBoxBD(i);}o[i].currentAppTarget=T;o[i].appCapabilities=T.appCapabilities;if(T.appCapabilities&&T.appCapabilities.statefulContainer===true){this.setCapabilities(i,f);}};this.forEach=function(i){var k;for(k in o){if(o.hasOwnProperty(k)){i(o[k].BlueBox);}}};this.isCapByTarget=function(T,i){if(T.appCapabilities===undefined){return false;}if(C[i]&&T&&T.appCapabilities){return C[i].handler(T.appCapabilities);}return T.appCapabilities[i]||false;};this.isCapUT=function(i,j){var k=o[i];if(k===undefined||k.appCapabilities===undefined){return false;}if(C[j]&&k){return C[j].handler(k.appCapabilities,i);}return k.appCapabilities[j]||false;};this.setStorageKey=function(i,j){if(!o[i]){this.InitBlueBoxBD(i);}o[i].sStorageKey=j;};this.getStorageKey=function(i){if(!o[i]){return undefined;}return o[i].sStorageKey;};this.getHandler=function(){return h;};this._getBlueBoxCacheKey=function(u){var i,H,p,I="",j;if(u===undefined||u===""||u==="../"){return u;}try{i=new U(u);H=i.hostname();if(H===undefined||H===""){H=i.path();if(H===undefined||H===""){H=u;}}p=i.query(true);if(p["sap-iframe-hint"]){I="@"+p["sap-iframe-hint"];}}catch(k){L.error("URL '"+u+"' can not be parsed: "+k,"sap.ushell.components.applicationIntegration.application.BlueBoxHandler");H=u;}j=H+I;return j;};this.deleteStateFul=function(u){var i=this._getBlueBoxCacheKey(u);return this.delete(i);};this.getStateFul=function(u){if(u===undefined||Object.keys(c).length===0){return undefined;}var i=this._getBlueBoxCacheKey(u);if(i!==undefined){return this.get(i);}else{return undefined;}};this.destroyApp=function(i){d.postMessageToIframeApp("sap.ushell.services.appLifeCycle","destroy",{appId:i});};this.openApp=function(i){d.postMessageToIframeApp("sap.ushell.services.appLifeCycle","create",{appId:i,sHash:window.hasher.getHash()});};this.storeApp=function(i){d.postMessageToIframeApp("sap.ushell.services.appLifeCycle","store",{appId:i,sHash:window.hasher.getHash()});};this.restoreApp=function(i){d.postMessageToIframeApp("sap.ushell.services.appLifeCycle","restore",{appId:i,sHash:window.hasher.getHash()});};this.delete=function(u){if(c[u]){delete c[u];}};this.get=function(u){return c[u];};this.getById=function(i){for(var k in c){if(c.hasOwnProperty(k)){var j=c[k];if(j.sId===i){return j;}}}};this.set=function(u,i){var j=this._getBlueBoxCacheKey(u);c[j]=i;};}return new B();},true);
