// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/mvc/Controller","sap/ushell/EventHub","sap/ushell/Config","sap/ui/core/Component","sap/ui/thirdparty/jquery","sap/ui/model/json/JSONModel","sap/ui/core/theming/Parameters","sap/ui/Device","sap/ushell/resources","sap/ui/core/message/Message","sap/ui/core/MessageType"],function(L,C,E,a,b,q,J,P,D,r,M,c){"use strict";function g(n,d){var l=Math.min(n.length,(d||"").length);var i=0;while(i<l&&n[i]===d[i]){i++;}return i?n.slice(0,i).trim():n;}var S={"base":"sapUshellBaseIconStyle","sap_bluecrystal":"sapUshellBlueCrystalIconStyle","sap_belize_hcb":"sapUshellHCBIconStyle sapUshellHCBIconStyleOnHCB","sap_belize_hcw":"sapUshellHCWIconStyle sapUshellHCWIconStyleOnHCW","sap_belize":"sapUshellBelizeIconStyle","sap_belize_plus":"sapUshellPlusIconStyle","sap_fiori_3_hcb":"sapUshellHCBIconStyle sapUshellHCBIconStyleOnHCB","sap_fiori_3_hcw":"sapUshellHCWIconStyle sapUshellHCWIconStyleOnHCW","sap_fiori_3":"sapUshellQuartzLightIconStyle","sap_fiori_3_dark":"sapUshellQuartzDarkIconStyle"};return C.extend("sap.ushell.components.shell.Settings.appearance.Appearance",{TILE_SIZE:{Small:0,Responsive:1,getName:function(v){return Object.keys(this)[v];}},onInit:function(){this.userInfoService=sap.ushell.Container.getService("UserInfo");this.oUser=sap.ushell.Container.getUser();this.aThemeListFromServer=this.getView().getViewData().themeList||[];this.oPersonalizers={};var R=r.getTranslationModel();this.getView().setModel(R,"i18n");this.getView().setModel(this.getConfigurationModel(),"config");this._oDarkModeModel=this.getDarkModeModel(this.aThemeListFromServer);this.getView().setModel(this._oDarkModeModel,"darkMode");var u=this.oUser.getTheme();this.getView().setModel(new J({"options":this._getThemeListData(this.aThemeListFromServer,u)}));sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this);},onExit:function(){sap.ui.getCore().detachThemeChanged(this._handleThemeApplied,this);},_getThemeListData:function(t,s){if(this.oUser.isSetThemePermitted()===false){var n=s;for(var i=0;i<t.length;i++){if(t[i].id===s){n=t[i].name||s;break;}}return[{id:s,name:n}];}var d=this.getView().getModel("darkMode").getData(),e=this._isDarkModeActive();return t.reduce(function(l,T){var o={id:T.id,name:T.name||T.id||"",isVisible:true,isSelected:T.id===s,isSapTheme:!!S[T.id]};if(e&&d.supportedThemes[T.id]){var f=d.supportedThemes[T.id];if(f.complementaryTheme===s||T.id===s){o.isVisible=T.id===s;}else{o.isVisible=f.mode===sap.ushell.services.DarkModeSupport.Mode.LIGHT;}o.combineName=f.combineName;}l.push(o);return l;},[]).sort(function(f,h){var o=f.name.localeCompare(h.name);if(o===0){o=f.id.localeCompare(h.id);}return o;});},getConfigurationModel:function(){var o=new J({});o.setData({themeConfigurable:a.last("/core/shell/model/setTheme"),sizeBehaviorConfigurable:a.last("/core/home/sizeBehaviorConfigurable"),tileSize:this.TILE_SIZE[a.last("/core/home/sizeBehavior")],contentDensityConfigurable:a.last("/core/shell/model/contentDensity")&&!D.system.phone,isCozyContentMode:this.oUser.getContentDensity()==="cozy",sapUiContentIconColor:P.get("sapUiContentIconColor"),textAlign:D.system.phone?"Left":"Right"});return o;},getDarkModeModel:function(t){var d=new J({}),o={enabled:false,detectionSupported:false,detectionEnabled:true,isDarkThemeApplied:false,supportedThemes:{}};if(a.last("/core/darkMode/enabled")){o.enabled=true;var e=sap.ushell.Container.getService("DarkModeSupport");o.detectionSupported=e.canAutomaticallyToggleDarkMode();e.attachModeChanged(function(m){d.setProperty("/isDarkThemeApplied",m===sap.ushell.services.DarkModeSupport.Mode.DARK);});o.supportedThemes=this._getSupportedDarkModeThemes(t,a.last("/core/darkMode/supportedThemes")||[]);}d.setData(o);return d;},_getSupportedDarkModeThemes:function(t,s){var T=t.reduce(function(R,o){R[o.id]=o.name;return R;},{});return s.reduce(function(R,p){var l=p.light,d=p.dark,e=T[l],f=T[d];if(e&&f&&!R[l]&&!R[d]){var h=g(e,f);R[l]={mode:sap.ushell.services.DarkModeSupport.Mode.LIGHT,complementaryTheme:d,combineName:h};R[d]={mode:sap.ushell.services.DarkModeSupport.Mode.DARK,complementaryTheme:l,combineName:h};}return R;},{});},onAfterRendering:function(){var d=this._isDarkModeActive(),i=this.getView().getModel("config").getProperty("/themeConfigurable");var l=this.getView().byId("themeList"),e=l.getItems(),I,t;l.toggleStyleClass("sapUshellThemeListDisabled",!i);e.forEach(function(o,f){t=o.getCustomData()[0].getValue();I=o.getContent()[0].getItems()[0].getItems()[0];if(S[t]){I.addStyleClass(S[t]);}I.toggleStyleClass("sapUshellDarkMode",d);});},_handleThemeApplied:function(){var o=this.getView().getModel("config");if(o){o.setProperty("/sapUiContentIconColor",P.get("sapUiContentIconColor"));}},onCancel:function(){var o=this.getView().getModel("config");if(o.getProperty("/themeConfigurable")){var u=this.oUser.getTheme(),t=this.getView().getModel().getProperty("/options");t.forEach(function(T){T.isSelected=u===T.id;});this.getView().getModel().setProperty("/options",t);}if(o.getProperty("/contentDensityConfigurable")){o.setProperty("/isCozyContentMode",this.oUser.getContentDensity()==="cozy");}if(o.getProperty("/sizeBehaviorConfigurable")){o.setProperty("/tileSize",this.TILE_SIZE[a.last("/core/home/sizeBehavior")]);}},onSave:function(){var o=this.getView().getModel("config"),s=[];if(o.getProperty("/themeConfigurable")){s.push(this.onSaveThemes());}if(o.getProperty("/contentDensityConfigurable")){s.push(this.onSaveContentDensity());}if(o.getProperty("/sizeBehaviorConfigurable")){s.push(this.onSaveTileSize());}return Promise.all(s).then(function(R){var m=[];R.forEach(function(d){if(d&&d instanceof sap.ui.core.message.Message){m.push(d);}});return m.length>0?Promise.reject(m):Promise.resolve();});},onSaveThemes:function(){var o=this.getView().getModel("config"),t=this.getView().byId("themeList"),s=t.getSelectedItem(),n=s?s.getBindingContext().getProperty("id"):null,u=this.oUser,O=u.getTheme(sap.ushell.User.prototype.constants.themeFormat.ORIGINAL_THEME);if(n&&n!==O&&o.getProperty("/themeConfigurable")){return new Promise(function(d){u.setTheme(n);this.userInfoService.updateUserPreferences(u).done(function(){u.resetChangedProperty("theme");this._applyDarkMode();d();}.bind(this)).fail(function(e,p){u.setTheme(this.origThemeId);u.resetChangedProperty("theme");L.error("Can not save selected theme",e);d(new M({type:c.Error,description:e,message:p.message.value,date:p.innererror.timestamp,httpStatus:p.httpStatus}));});}.bind(this));}return Promise.resolve();},onSaveContentDensity:function(){var o=this.getView().getModel("config"),u=this.oUser,n=o.getProperty("/isCozyContentMode")?"cozy":"compact",U=u.getContentDensity();if(n!==U&&o.getProperty("/contentDensityConfigurable")){return new Promise(function(d){u.setContentDensity(n);this.userInfoService.updateUserPreferences(this.oUser).done(function(){u.resetChangedProperty("contentDensity");sap.ui.getCore().getEventBus().publish("launchpad","toggleContentDensity",{contentDensity:n});E.emit("toggleContentDensity",{contentDensity:n});E.once("toggleContentDensity").do(function(){d();});}).fail(function(e,p){u.setContentDensity(U);u.resetChangedProperty("contentDensity");L.error("Can not save content density configuration",e);d(new M({type:c.Error,description:e,message:p.message.value,date:p.innererror.timestamp,httpStatus:p.httpStatus}));});}.bind(this));}return Promise.resolve();},onSaveTileSize:function(){var o=this.getView().getModel("config"),n=this.TILE_SIZE.getName(o.getProperty("/tileSize")),s=a.last("/core/home/sizeBehavior");if(n&&n!==s&&o.getProperty("/sizeBehaviorConfigurable")){return new Promise(function(d){this.writeToPersonalization("flp.settings.FlpSettings","sizeBehavior",n).done(function(){a.emit("/core/home/sizeBehavior",n);if(n==="Responsive"){q(".sapUshellTile").removeClass("sapUshellSmall");q(".sapUshellPlusTile").removeClass("sapUshellPlusTileSmall");}else{q(".sapUshellTile").addClass("sapUshellSmall");q(".sapUshellPlusTile").addClass("sapUshellPlusTileSmall");}d();}).fail(function(e,p){L.error("Can not save tile size configuration",e);d(new M({type:c.Error,description:e,message:p.message.value,date:p.innererror.timestamp,httpStatus:p.httpStatus}));});}.bind(this));}return Promise.resolve();},writeToPersonalization:function(s,i,v){var p;try{p=this.getPersonalizer(s,i).setPersData(v);}catch(e){L.error("Personalization service does not work:");L.error(e.name+": "+e.message);p=q.when(Promise.reject(e));}return p;},getPersonalizer:function(s,i){var k=s+"-"+i;if(this.oPersonalizers[k]){return this.oPersonalizers[k];}var p=sap.ushell.Container.getService("Personalization");var o=b.getOwnerComponentFor(this);var d={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true};if(!this.oPersonalizers[k]){this.oPersonalizers[k]=p.getPersonalizer({container:s,item:i},d,o);}return this.oPersonalizers[k];},_applyDarkMode:function(){var m=this._oDarkModeModel;if(m.getProperty("/enabled")&&m.getProperty("/detectionSupported")&&m.getProperty("/detectionEnabled")){sap.ushell.Container.getService("DarkModeSupport")._toggleDarkModeBasedOnSystemColorScheme();}},_isDarkModeActive:function(){var m=this._oDarkModeModel;if(m.getProperty("/enabled")){return m.getProperty("/detectionSupported")?m.getProperty("/detectionEnabled"):true;}return false;},changeThemeMode:function(e){sap.ushell.Container.getService("DarkModeSupport").toggleModeChange();},changeSystemModeDetection:function(e){var s=e.getSource().getState();if(s){sap.ushell.Container.getService("DarkModeSupport").enableDarkModeBasedOnSystem();}else{sap.ushell.Container.getService("DarkModeSupport").disableDarkModeBasedOnSystem();}var u=this.oUser.getTheme();this.getView().getModel().setProperty("/options",this._getThemeListData(this.aThemeListFromServer,u));this.getView().invalidate();}});});
