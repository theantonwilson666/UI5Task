// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/performance/Measurement","sap/base/util/UriParameters","sap/base/Log","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/model/json/JSONModel","sap/ui/core/message/Message","sap/ui/core/MessageType"],function(C,M,U,L,a,b,J,c,d){"use strict";return C.extend("sap.ushell.components.shell.Settings.userLanguageRegion.LanguageRegionSelector",{onInit:function(){this.userInfoService=sap.ushell.Container.getService("UserInfo");this.oUser=sap.ushell.Container.getUser();var l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var o=b.getInstance(l);var D,t,T,n;var i=sap.ushell.Container.getRenderer("fiori2").getShellConfig().enableSetLanguage||false;var I=this.oUser.isLanguagePersonalized();var e=this.userInfoService.getUserSettingListEditSupported();var u=[];if(e){var f=sap.ui.getCore().getConfiguration().getFormatSettings();D=f.getLegacyDateFormat();T=f.getLegacyTimeFormat();n=f.getLegacyNumberFormat();u.push(this._loadUserSettingList());}else{D=o.getDatePattern("medium");t=o.getTimePattern("medium");T=(t.indexOf("H")===-1)?"12h":"24h";}var m=new J({languageList:null,DateFormatList:null,TimeFormatList:null,NumberFormatList:null,TimeZoneList:null,selectedLanguage:this.oUser.getLanguage(),selectedLanguageText:this.oUser.getLanguageText(),selectedDatePattern:D,selectedTimeFormat:T,selectedNumberformat:n,selectedTimeZone:this.oUser.getTimeZone(),isSettingsLoaded:true,isLanguagePersonalized:I,isEnableSetLanguage:i,isEnableUserProfileSetting:e});if(i){u.push(this._loadLanguagesList());}if(u.length>0){this.getView().setBusy(true);Promise.all(u).then(function(r){var g=e?r[0]:null;var h=null;if(i){h=r.length===1?r[0]:r[1];}if(h&&h.length>1){m.setProperty("/languageList",h);var H=h.some(function(j){return j.key==="default";});if(!I&&H){m.setProperty("/selectedLanguage","default");}}if(g&&g.TIME_FORMAT&&g.TIME_FORMAT.length>0){m.setProperty("/TimeFormatList",g.TIME_FORMAT);}if(g&&g.DATE_FORMAT&&g.DATE_FORMAT.length>0){m.setProperty("/DateFormatList",g.DATE_FORMAT);}if(g&&g.TIME_ZONE&&g.TIME_ZONE.length>0){m.setProperty("/TimeZoneList",g.TIME_ZONE);}if(g&&g.NUMBER_FORMAT&&g.NUMBER_FORMAT.length>0){m.setProperty("/NumberFormatList",g.NUMBER_FORMAT);}this.oView.setModel(m);this.getView().setBusy(false);}.bind(this));}else{this.oView.setModel(m);}},_loadLanguagesList:function(){M.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");return new Promise(function(r){M.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");this.userInfoService.getLanguageList().done(function(D){M.end("FLP:LanguageRegionSelector._getLanguagesList");r(D);}).fail(function(e){M.end("FLP:LanguageRegionSelector._getLanguagesList");L.error("Failed to load language list.",e,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");r(null);});}.bind(this));},_loadUserSettingList:function(){M.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");return new Promise(function(r){M.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");this.userInfoService.getUserSettingList().then(function(D){M.end("FLP:LanguageRegionSelector._loadUserSettingList");r(D);});}.bind(this));},onCancel:function(){var m=this.getView().getModel(),o=m.getData(),l=o.languageList,i=o.isEnableSetLanguage;if(i&&l){var u=this.oUser.getLanguage();var s=o.isLanguagePersonalized?u:"default";m.setProperty("/selectedLanguage",s);this._updateTextFields(u);}if(o.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues();}},onSave:function(){var u=this.oUser,m=this.getView().getModel().getData(),s=m.selectedLanguage,o=u.getLanguage(),l=s!==(m.isLanguagePersonalized?o:"default"),i=m.isEnableUserProfileSetting,e=m.isEnableSetLanguage&&m.languageList&&l;if(e||i){return new Promise(function(r,f){if(e){u.setLanguage(s);}if(i){var F=sap.ui.getCore().getConfiguration().getFormatSettings();if(F.getLegacyDateFormat()!==m.selectedDatePattern){u.setChangedProperties({propertyName:"dateFormat",name:"DATE_FORMAT"},F.getLegacyDateFormat(),m.selectedDatePattern);}if(F.getLegacyTimeFormat()!==m.selectedTimeFormat){u.setChangedProperties({propertyName:"timeFormat",name:"TIME_FORMAT"},F.getLegacyTimeFormat(),m.selectedTimeFormat);}if(F.getLegacyNumberFormat()!==m.selectedNumberformat){u.setChangedProperties({propertyName:"numberFormat",name:"NUMBER_FORMAT"},F.getLegacyNumberFormat(),m.selectedNumberformat);}if(this.oUser.getTimeZone()!==m.selectedTimeZone){u.setChangedProperties({propertyName:"timeZone",name:"TIME_ZONE"},this.oUser.getTimeZone(),m.selectedTimeZone);}}this.userInfoService.updateUserPreferences(u).done(function(){var R={refresh:true};if(e){u.resetChangedProperty("language");var g=U.fromQuery(window.location.search).get("sap-language");if(g&&s!=="default"){R.urlParams=[{"sap-language":s}];}this._removeLanguageFromUserContextCookie();}r(R);}.bind(this)).fail(function(g,p){if(e){u.setLanguage(o);u.resetChangedProperty("language");this._updateTextFields(o);}if(m.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues();}L.error("Failed to save Language and Region Settings",g,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");f(new c({type:d.Error,description:g,message:p.message.value,date:p.innererror.timestamp,httpStatus:p.httpStatus}));}.bind(this));}.bind(this));}return Promise.resolve();},_restoreUserSettingPreferenceValues:function(){var m=this.getView().getModel();var f=sap.ui.getCore().getConfiguration().getFormatSettings();m.setProperty("/selectedDatePattern",f.getLegacyDateFormat());m.setProperty("/selectedTimeFormat",f.getLegacyTimeFormat());m.setProperty("/selectedNumberformat",f.getLegacyNumberFormat());m.setProperty("/selectedTimeZone",this.oUser.getTimeZone());},_removeLanguageFromUserContextCookie:function(){var u=document.cookie.split(";").find(function(f){return f.indexOf("sap-usercontext")!==-1;});if(!u){return;}var e=u.replace("sap-usercontext=","").split("&");e=e.filter(function(v){return v.indexOf("sap-language")===-1;});document.cookie="sap-usercontext="+e.join("&")+";path=/";},_handleSelectChange:function(e){var s=e.getParameters().selectedItem.getKey();this._updateTextFields(s);},_updateTextFields:function(l){var o;if(l===this.oUser.getLanguage()){o=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();}else{o=new a(l);}var m=this.getView().getModel(),e=b.getInstance(o),D=e.getDatePattern("medium"),t=e.getTimePattern("medium"),T=(t.indexOf("H")===-1)?"12h":"24h";if(!m.getData().isEnableUserProfileSetting){m.setProperty("/selectedDatePattern",D);m.setProperty("/selectedTimeFormat",T);}}});});
