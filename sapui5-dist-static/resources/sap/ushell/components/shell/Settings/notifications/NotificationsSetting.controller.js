// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/base/Log","sap/ushell/resources","sap/base/util/deepClone"],function(C,J,a,L,r,d){"use strict";return C.extend("sap.ushell.components.shell.Settings.notifications.NotificationsSetting",{onInit:function(){this._oModel=new J({"rows":[],"originalRows":[]});var v=this.getView(),R;v.setBusy(true);v.setModel(r.getTranslationModel(),"i18n");sap.ushell.Container.getServiceAsync("Notifications").then(function(S){this._oNotificationService=S;this._initializeFlags();S.readSettings().done(function(o){R=JSON.parse(o);this._oModel.setProperty("/rows",R.value);this._oModel.setProperty("/originalRows",d(R.value));}.bind(this)).always(function(){v.setBusy(false);v.setModel(this._oModel);}.bind(this));}.bind(this));},onAfterRendering:function(){var f=this._oModel.getProperty("/flags"),R=this._oModel.getProperty("/rows");if(R!==undefined){this._oModel.setProperty("/originalRows",d(R));}if(f!==undefined){this._oModel.setProperty("/originalFlags/highPriorityBannerEnabled",f.highPriorityBannerEnabled);}},onCancel:function(){var o=this._oModel.getProperty("/originalFlags"),O=this._oModel.getProperty("/originalRows");this._oModel.setProperty("/flags/highPriorityBannerEnabled",o.highPriorityBannerEnabled);this._oModel.setProperty("/rows",d(O));this._oModel.setProperty("/originalFlags",{});this._oModel.setProperty("/originalRows",[]);},onSave:function(){var R=this._oModel.getProperty("/rows"),o=this._oModel.getProperty("/originalRows"),b,O,s=[],S=[];for(var i=0;i<R.length;i++){b=R[i];O=o[i];if(this._notficationSettingsDiffer(b,O)){s.push(b);}}if(this._flagsHaveChanged()){this._handleFlagsSave();}if(s.length){s.forEach(function(c){S.push(this._oNotificationService.saveSettingsEntry(c));}.bind(this));return new Promise(function(c,e){jQuery.when.apply(jQuery,S).done(function(){c();}).fail(function(f){L.error("Failed to save the notification settings in the notifivation service.",f,"sap.ushell.components.ushell.settings.notifications.NotificationsSetting");e(f);});});}return Promise.resolve();},_flagsHaveChanged:function(){return this._oModel.getProperty("/flags/highPriorityBannerEnabled")!==this._oModel.getProperty("/originalFlags/highPriorityBannerEnabled");},_handleFlagsSave:function(){var h=this._oModel.getProperty("/flags/highPriorityBannerEnabled");this._oModel.setProperty("/originalFlags/highPriorityBannerEnabled",h);this._oNotificationService.setUserSettingsFlags({highPriorityBannerEnabled:h});},_notficationSettingsDiffer:function(s,b){return(s.NotificationTypeId!==b.NotificationTypeId)||(s.PriorityDefault!==b.PriorityDefault)||(s.DoNotDeliver!==b.DoNotDeliver)||(s.DoNotDeliverMob!==b.DoNotDeliverMob)||(s.DoNotDeliverEmail!==b.DoNotDeliverEmail);},onSelectMobile:function(e){var p=e.getSource().getBindingContext().getPath();this._oModel.setProperty(p+"/DoNotDeliverMob",!e.getParameter("selected"));},onSelectEmail:function(e){var p=e.getSource().getBindingContext().getPath();this._oModel.setProperty(p+"/DoNotDeliverEmail",!e.getParameter("selected"));},onSelectHighPriority:function(e){var p=e.getSource().getBindingContext().getPath();if(e.getParameter("selected")){this._oModel.setProperty(p+"/PriorityDefault","HIGH");}else{this._oModel.setProperty(p+"/PriorityDefault","");}},onEnableSwitchChange:function(e){var n=e.getParameter("state"),p=e.getSource().getBindingContext().getPath();this._oModel.setProperty(p+"/DoNotDeliver",!n);},_initializeFlags:function(){var s=this._oNotificationService.getUserSettingsFlags(),m=this._oNotificationService._getNotificationSettingsMobileSupport(),e=this._oNotificationService._getNotificationSettingsEmailSupport();s.done(function(S){this._oModel.setProperty("/flags",{});this._oModel.setProperty("/flags/highPriorityBannerEnabled",S.highPriorityBannerEnabled);this._oModel.setProperty("/flags/mobileNotificationsEnabled",m);this._oModel.setProperty("/flags/emailNotificationsEnabled",e);this._oModel.setProperty("/originalFlags",{});this._oModel.setProperty("/originalFlags/highPriorityBannerEnabled",S.highPriorityBannerEnabled);}.bind(this));}});});
