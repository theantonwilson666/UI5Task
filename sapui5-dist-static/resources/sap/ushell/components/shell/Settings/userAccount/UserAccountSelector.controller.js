// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/base/Log","sap/ushell/Config","sap/ushell/resources","sap/m/MessageBox","sap/m/MessageToast","sap/ushell/utils","sap/ushell/utils/WindowUtils"],function(C,J,L,a,r,M,b,u,w){"use strict";return C.extend("sap.ushell.components.shell.Settings.userAccount.UserAccountSelector",{onInit:function(){var s=sap.ushell.Container.getRenderer("fiori2").getShellConfig(),e=s.enableUserImgConsent;this.imgConsentEnabled=e||false;this.oUser=sap.ushell.Container.getUser();var R=r.getTranslationModel();var c=this.getConfigurationModel();this.getView().setModel(R,"i18n");this.getView().setModel(c,"config");this.oUser.attachOnSetImage(function(){c.setProperty("/icon",a.last("/core/shell/model/userImage/personPlaceHolder"));});sap.ushell.Container.getServiceAsync("Personalization").then(function(p){return p.isResetEntirePersonalizationSupported().then(function(i){if(!i){c.setProperty("/isResetPersonalizationVisible",false);}});}.bind(this)).catch(function(E){L.error("The personalization service could not be loaded because of: ."+E.toString());});},getConfigurationModel:function(){var m=new J({}),U=sap.ushell.Container.getUser(),i=a.last("/core/shell/model/userImage/personPlaceHolder")||"sap-icon://person-placeholder";m.setData({icon:i,name:U.getFullName(),mail:U.getEmail(),server:window.location.host,imgConsentEnabled:this.imgConsentEnabled,isImageConsentForUser:U.getImageConsent(),isResetPersonalizationVisible:this.isResetPersonalizationVisible||true});return m;},onCancel:function(){if(this.imgConsentEnabled){this.getView().getModel("config").setProperty("/isImageConsentForUser",this.oUser.getImageConsent());}},onSave:function(){if(this.imgConsentEnabled){return this.onSaveUserImgConsent();}return Promise.resolve();},onSaveUserImgConsent:function(){var U=this.oUser,o=U.getImageConsent(),m=this.getView().getModel("config"),c=m.getProperty("/isImageConsentForUser"),d;if(o!==c){U.setImageConsent(c);return new Promise(function(e,f){d=sap.ushell.Container.getService("UserInfo").updateUserPreferences(U);d.done(function(){U.resetChangedProperty("isImageConsent");e();});d.fail(function(E){U.setImageConsent(o);U.resetChangedProperty("isImageConsent");m.setProperty("/isImageConsentForUser",o);L.error(E);f(E);});});}return Promise.resolve();},termsOfUserPress:function(){var t=this.getView().byId("termsOfUseTextFlexBox"),c=this.getView().byId("termsOfUseLink"),i=t.getVisible();t.setVisible(!i);c.setText(r.i18n.getText(i?"userImageConsentDialogShowTermsOfUse":"userImageConsentDialogHideTermsOfUse"));},showMessageBoxWarningDeletePersonalization:function(){M.warning(r.i18n.getText("userAccountResetPersonalizationWarningDialogDescription"),{onClose:this.resetEntirePersonalization.bind(this),actions:[M.Action.OK,M.Action.CANCEL],contentWidth:"600px"});},resetEntirePersonalization:function(A){if(A===M.Action.OK){this.getView().setBusy(true);sap.ushell.Container.getServiceAsync("Personalization").then(function(p){return p.resetEntirePersonalization().then(function(){b.show(r.i18n.getText("userAccountResetPersonalizationWarningDialogSuccessToast"),{onClose:w.refreshBrowser});}).catch(this.showErrorMessageBox.bind(this));}.bind(this)).catch(this.showErrorMessageBox.bind(this)).finally(function(){this.getView().setBusy(false);}.bind(this));}},showErrorMessageBox:function(){M.error(r.i18n.getText("userAccountResetPersonalizationWarningDialogErrorDialog"),{actions:M.Action.CLOSE,contentWidth:"600px"});}});});
