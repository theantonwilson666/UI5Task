// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/UriParameters","sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/Device","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/utils","sap/ushell/utils/WindowUtils","sap/ushell/components/shell/Settings/ErrorMessageHelper","sap/ui/core/message/Message","sap/ushell/components/shell/Settings/UserSettingsErrorMessagePopover","sap/ui/core/MessageType"],function(L,U,C,F,J,D,E,r,u,w,a,M,b,c){"use strict";return C.extend("sap.ushell.components.shell.Settings.UserSettings",{onInit:function(){this.getView().byId("userSettingEntryList").addEventDelegate({onAfterRendering:this._listAfterRendering.bind(this)});this.getView().byId("userSettingsDialog").addEventDelegate({onkeydown:this._keyDown.bind(this)});D.orientation.attachHandler(function(){var s=this.getView().byId("settingsApp");this._updateHeaderButtonVisibility(s.isMasterShown());}.bind(this));},_afterClose:function(){if(window.document.activeElement&&window.document.activeElement.tagName==="BODY"){window.document.getElementById("meAreaHeaderButton").focus();}},_keyDown:function(e){if(e.keyCode===27){this._handleCancelButtonPress();}},_listAfterRendering:function(){var m=this.getView().byId("userSettingEntryList");var e=m.getItems();for(var i=0;i<e.length;i++){var p=e[i].getBindingContextPath();this._setEntryValueResult(p);}if(!D.system.phone){var f=m.getItems()[0];if(f){m.setSelectedItem(f);this._toDetail(f);f.getDomRef().focus();}}},_setEntryValueResult:function(e){var m=this.getView().getModel(),v=m.getProperty(e+"/valueArgument"),V=m.getProperty(e+"/valueResult");if(typeof v==="function"){m.setProperty(e+"/valueResult",r.i18n.getText("genericLoading"));try{v().then(function(f){if(f&&f.value!==undefined){m.setProperty(e+"/visible",!!f.value);}var s;if(typeof(f)==="object"){s=f.displayText||"";}else{s=f||"";}m.setProperty(e+"/valueResult",s);},function(){m.setProperty(e+"/valueResult",r.i18n.getText("loadingErrorMessage"));});}catch(d){L.error("Can not load value for "+m.getProperty(e+"/title")+" entry",d);m.setProperty(e+"/valueResult",r.i18n.getText("loadingErrorMessage"));}}else if(V===null||V===undefined){m.setProperty(e+"/valueResult",v||"");}},_navBackButtonPressHandler:function(){var s=this.getView().byId("settingsApp");s.backDetail();this._updateHeaderButtonVisibility(true);},_navToggleButtonPressHandler:function(){var s=this.getView().byId("settingsApp"),i=s.isMasterShown();if(i){s.hideMaster();}else{s.showMaster();}this._updateHeaderButtonVisibility(!i);},_updateHeaderButtonVisibility:function(i){if(D.system.phone){var B=this.getView().byId("userSettingsNavBackButton");B.setVisible(!i);}else{var m=this.getView().byId("userSettingsMenuButton");if(D.orientation.portrait){m.setVisible(true);m.setPressed(i);m.setTooltip(r.i18n.getText(i?"ToggleButtonHide":"ToggleButtonShow"));}else{m.setVisible(false);}}},_itemPress:function(e){this._toDetail(e.getSource().getSelectedItem());},_toDetail:function(s){var m=this.getView().getModel(),e=s.getBindingContextPath(),d=m.getProperty(e+"/contentResult");if(D.system.phone){s.setSelected(false);}if(d){this._navToDetail(d,e);return Promise.resolve();}var o=m.getProperty(e);return this._createEntryContent(o).then(function(n){m.setProperty(e+"/contentResult",n);this._navToDetail(n,e);}.bind(this));},_createEntryContent:function(e){var t=this;var o=this._addContentWrapper(e);if(typeof e.contentFunc==="function"){e.contentFunc().then(function(d){if(d instanceof sap.ui.core.Control){o=o.then(function(p){p.addContent(d);p.setBusy(false);return p;});}else{o=o.then(t._addErrorContentToWrapper.bind(null,r.i18n.getText("loadingErrorMessage")));}},function(d){L.error("Can not load content for "+e.title+" entry",d);o=o.then(t._addErrorContentToWrapper.bind(null,r.i18n.getText("loadingErrorMessage")));});}else{o=o.then(this._addErrorContentToWrapper.bind(null,r.i18n.getText("userSettings.noContent")));}return o.then(function(p){return p.getId();});},_addContentWrapper:function(e){var t=this;return F.load({name:"sap.ushell.components.shell.Settings.ContentWrapper"}).then(function(p){var m=new J({title:e.title,showHeader:!e.provideEmptyWrapper});p.setModel(m,"entryInfo");t.getView().byId("settingsApp").addDetailPage(p);return p;});},_addErrorContentToWrapper:function(m,p){return F.load({name:"sap.ushell.components.shell.Settings.ErrorContent"}).then(function(e){p.setBusy(false);p.getModel("entryInfo").setProperty("/errorMessage",m);p.addContent(e);return p;});},_navToDetail:function(i,e){var s=this.getView().byId("settingsApp");s.toDetail(i);if(s.getMode()==="ShowHideMode"){s.hideMaster();this._updateHeaderButtonVisibility(false);}this._emitEntryOpened(e);},_emitEntryOpened:function(e){var d=E.last("UserSettingsOpened")||{},o=this.getView().getModel().getProperty(e),i=o.id;if(!i){i=u._getUid();this.getView().getModel().setProperty(e+"/id",i);}d[i]=true;E.emit("UserSettingsOpened",d);},_createMessagePopover:function(){if(!this.oMessagePopover){return b.create().then(function(m){m.setModel(this.getView().getModel("i18n"),"i18n");this.oMessagePopover=m;}.bind(this));}return Promise.resolve();},_handleMessagePopoverPress:function(e){this.oMessagePopover.toggle(e.getSource());},_handleSaveButtonPress:function(){a.removeErrorMessages();var t=this,d=this.getView().byId("userSettingsDialog"),e=this.getView().getModel().getProperty("/entries"),o=E.last("UserSettingsOpened")||{},s;if(Object.keys(o).length===0){this._handleSettingsDialogClose();this._showSuccessMessageToast();return Promise.resolve();}d.setBusy(true);s=e.reduce(function(R,f){if(o[f.id]){R.push(this._executeEntrySave(f));}return R;}.bind(this),[]);return Promise.all(s).then(function(R){var f=a.filterMessagesToDisplay();d.setBusy(false);if(f.length>0){var m=t.getView().byId("userSettingsMessagePopoverBtn");m.setText(f.length);m.setVisible(true);var O=new Promise(function(j){var k={onAfterRendering:function(){m.removeEventDelegate(k);j();}};m.invalidate();m.addEventDelegate(k);});var g="";f.forEach(function(j){g+="Entry: "+j.getAdditionalText()+" - Error message: "+j.getDescription()+"\n";});L.error("Failed to save the following entries",g);return Promise.all([O,t._createMessagePopover()]).then(function(){t.oMessagePopover.setModel(new J(f),"errorMessages");t.oMessagePopover.openBy(m);});}t._handleSettingsDialogClose();t._showSuccessMessageToast();E.emit("UserSettingsOpened",null);var h=false;var i=[];R.forEach(function(j){if(j&&j.refresh){h=true;}if(j&&j.urlParams&&j.urlParams.length>0){i=i.concat(j.urlParams);}});if(h){w.refreshBrowser(i);}return Promise.resolve();});},_executeEntrySave:function(e){var o,R;function d(p){var h={};if(p&&p.refresh===true){h.refresh=true;}if(p&&p.urlParams){h.urlParams=p.urlParams;}return h;}function f(h){var m;var s=e.id;var i=e.title;if(!h){m=r.i18n.getText("userSettings.SavingError.Undefined");}else if(typeof(h)==="string"){m=h;}else if(Array.isArray(h)){h.forEach(function(j){j.setAdditionalText(i);j.setTechnicalDetails({pluginId:s});a.addMessage(j);});return;}else if(h instanceof sap.ui.core.message.Message){h.setAdditionalText(i);h.setTechnicalDetails({pluginId:s});a.addMessage(h);return;}else{m=r.i18n.getText("userSettings.SavingError.WithMessage",h.message);}a.addMessage(new M({type:c.Error,additionalText:i,technicalDetails:{pluginId:s},description:m,message:m}));}try{sap.ushell.Container.getUser().resetChangedProperties();o=e.onSave();}catch(g){return f(g);}if(o&&o.promise){L.warning("jQuery.promise is used to save "+e.title+" settings entry.\n"+"The using of jQuery.promise for onSave is deprecated. Please use the native promise instead.");R=new Promise(function(h){o.done(function(p){h(d(p));}).fail(function(s){h(f(s));});});}else{R=o.then(d,f);}return R;},_showSuccessMessageToast:function(){sap.ui.require(["sap/m/MessageToast"],function(d){var m=r.i18n.getText("savedChanges");d.show(m,{offset:"0 -50"});});},_handleCancelButtonPress:function(){var e=this.getView().getModel().getProperty("/entries");var i=E.last("UserSettingsOpened")||{};if(i){e.forEach(function(o){if(i[o.id]&&o.onCancel){try{o.onCancel();}catch(d){L.error("Failed to cancel the following entries",d);}}});}E.emit("UserSettingsOpened",null);this._handleSettingsDialogClose();},_handleSettingsDialogClose:function(){sap.ushell.Container.getUser().resetChangedProperties();if(D.system.phone){this.getView().byId("settingsApp").toMaster("settingsView--userSettingMaster");}this.getView().byId("userSettingsMessagePopoverBtn").setVisible(false);this.getView().byId("userSettingsDialog").close();}});});
