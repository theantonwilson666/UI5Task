// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/base/util/extend","sap/base/util/deepEqual","sap/m/Button","sap/m/FlexBox","sap/m/FlexItemData","sap/m/Input","sap/m/library","sap/ui/core/mvc/Controller","sap/ui/comp/smartfield/SmartField","sap/ui/comp/smartfield/SmartLabel","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/Device","sap/ui/layout/GridData","sap/ui/model/json/JSONModel","sap/ui/model/odata/ODataModel","sap/ushell/resources","sap/m/MessageBox","./ExtendedValueDialog.controller"],function(L,d,e,D,B,F,a,I,m,C,S,b,G,c,P,f,g,J,O,r,M,E){"use strict";var h=m.ButtonType;function j(o,i){if(!(i.editorMetadata&&i.editorMetadata.groupId)){return-1;}if(!(o.editorMetadata&&o.editorMetadata.groupId)){return 1;}if(o.editorMetadata.groupId<i.editorMetadata.groupId){return-1;}if(o.editorMetadata.groupId>i.editorMetadata.groupId){return 1;}return 0;}function k(o,i){if(!(i.editorMetadata&&i.editorMetadata.parameterIndex)){return-1;}if(!(o.editorMetadata&&o.editorMetadata.parameterIndex)){return 1;}return o.editorMetadata.parameterIndex-i.editorMetadata.parameterIndex;}function l(o,i){var n=j(o,i);if(n===0){return k(o,i);}return n;}return C.extend("sap.ushell.components.shell.Settings.userDefaults.controller.UserDefaultsSetting",{onInit:function(){this.oModelRecords={};this.oChangedParameters={};this.oBlockedParameters={};this.aDisplayedUserDefaults=[];this.oDirtyStateModel=new J({isDirty:false,selectedVariant:null});this.getView().setModel(this.oDirtyStateModel,"DirtyState");this.oOriginalParameters={};this.oCurrentParameters={};var v=this.getView();v.setBusy(true);v.setModel(r.getTranslationModel(),"i18n");this.getSystemContextsModel().then(function(s){v.setModel(s,"systemContexts");return this._fillGroups();}.bind(this)).then(this._saveIsSupportedPlatform.bind(this)).then(this._initializeSmartVariantManagement.bind(this)).then(function(){v.setBusy(false);}).catch(function(i){L.error("Error during UserDefaultsSetting controller initialization",i,"sap.ushell.components.shell.Settings.userDefaults.UserDefaultsSetting");v.setBusy(false);});},getSystemContextsModel:function(){var s=new J({systemContexts:[],selectedKey:""});var o=this._getContentProviderIds();var i=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution");var u=sap.ushell.Container.getServiceAsync("UserDefaultParameters");return Promise.all([o,i,u]).then(function(R){var n=R[0];var p=R[1];var U=R[2];if(n.length===0){n.push("");}return Promise.all(n.map(function(q){return p.getSystemContext(q).then(function(t){var v=s.getProperty("/systemContexts");return U.hasRelevantMaintainableParameters(t).then(function(w){if(w){v.push(t);}});});})).then(function(){var q=s.getProperty("/systemContexts");if(q.length>0){s.setProperty("/selectedKey",q[0].id);}return s;});});},_getContentProviderIds:function(){return sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(o){return o.getContentProviderIds();}).catch(function(){return[""];});},handleSystemContextChanged:function(){if(this.oDirtyStateModel.getProperty("/isDirty")){var u=r.i18n.getText("userDefaultsSave");var U=r.i18n.getText("userDefaultsDiscard");M.show(r.i18n.getText("userDefaultsUnsavedChangesMessage"),{title:r.i18n.getText("userDefaultsUnsavedChangesTitle"),actions:[u,U,M.Action.CANCEL],emphasizedAction:u,icon:M.Icon.QUESTION,onClose:function(A){if(A===U){this._fillGroups();this._setDirtyState(false);}else if(A===u){this.onSave();this._fillGroups();this._setDirtyState(false);}else{this.getView().getModel("systemContexts").setProperty("/selectedKey",this.sLastSelectedKey);}}.bind(this)});}else{this._fillGroups();}},_fillGroups:function(){var u=this.getView().byId("userDefaultsForm");u.removeAllGroups();var K=this.getView().getModel("systemContexts").getProperty("/selectedKey");var s=this.getView().getModel("systemContexts").getProperty("/systemContexts").find(function(o){return o.id===K;});return new Promise(function(i,n){sap.ushell.Container.getServiceAsync("UserDefaultParameters").then(function(U){U.editorGetParameters(s).done(function(p){this.oOriginalParameters=d({},p);this.oCurrentParameters=d({},p);this.oModel=new J(p);this.oModel.setDefaultBindingMode("TwoWay");this.getView().setModel(this.oModel,"MdlParameter");return this._getFormattedParameters(p,this.oModel).then(function(o){var q=this._getContent(o);q.forEach(function(t){u.addGroup(t);});}.bind(this)).then(i);}.bind(this));}.bind(this));}.bind(this));},_getFormattedParameters:function(o,i){var p=Object.keys(o).map(function(s,n){var q=d({},o[s]);q.parameterName=s;q.editorMetadata=q.editorMetadata||{};q.valueObject=d({value:""},q.valueObject);if(q.editorMetadata.editorInfo&&q.editorMetadata.editorInfo.propertyName){return this._createOdataModelBinding(q,i).then(function(t){q.modelBind=t;return q;}).catch(function(){L.error("Metadata loading for parameter "+q.parameterName+" failed"+JSON.stringify(q.editorMetadata));q.modelBind=this._createPlainModelBinding(q,i);this.oBlockedParameters[q.parameterName]=false;return Promise.resolve(q);}.bind(this));}q.modelBind=this._createPlainModelBinding(q,i);return Promise.resolve(q);}.bind(this));return Promise.all(p).then(function(n){n.sort(l);this.aDisplayedUserDefaults=n;n.forEach(function(q){q.modelBind.model.setProperty(q.modelBind.sFullPropertyPath,q.valueObject.value);q.modelBind.model.bindTree(q.modelBind.sFullPropertyPath).attachChange(this.storeChangedData.bind(this));}.bind(this));return n;}.bind(this));},_createPlainModelBinding:function(p,o){var s="/"+p.parameterName+"/valueObject/value";if(!o.getProperty("/"+p.parameterName+"/valueObject")){o.setProperty("/"+p.parameterName+"/valueObject",{});}var i={isOdata:false,model:o,extendedModel:o,sFullPropertyPath:s,sPropertyName:"{"+s+"}"};return i;},_createOdataModelBinding:function(p,o){var i=p.editorMetadata.editorInfo,n=this._getODataServiceData(i.odataURL,p);return n.metadata.then(function(){var q={isOdata:true,model:n.model,extendedModel:o,sPropertyName:"{"+i.propertyName+"}",sFullPropertyPath:i.bindingPath+"/"+i.propertyName};return q;});},_getODataServiceData:function(u,o){if(!this.oModelRecords[u]){var i=new O(u,{metadataUrlParams:{"sap-documentation":"heading,quickinfo","sap-value-list":"none"},json:true});i.setDefaultCountMode("None");i.setDefaultBindingMode("TwoWay");this.oModelRecords[u]={attachedListeners:[],model:i,metadata:new Promise(function(n,p){i.attachMetadataLoaded(n);i.attachMetadataFailed(p);})};}if(this.oModelRecords[u].attachedListeners.indexOf(o.parameterName)===-1){this.oModelRecords[u].attachedListeners.push(o.parameterName);this.oModelRecords[u].model.attachRequestCompleted(this._overrideOdataModelValue.bind(this,o));this.oBlockedParameters[o.parameterName]=true;}return this.oModelRecords[u];},_overrideOdataModelValue:function(p,o){var i=o.getSource(),u=o.getParameter("url").replace(/\?.*/,""),s=p.editorMetadata.editorInfo.bindingPath+"/"+p.editorMetadata.editorInfo.propertyName,n=p.editorMetadata.editorInfo.odataURL+p.editorMetadata.editorInfo.bindingPath;if(n!==u){return;}if(i.getProperty(s)!==p.valueObject.value){i.setProperty(s,p.valueObject.value);}this.oBlockedParameters[p.parameterName]=false;},_getContent:function(n){var s="nevermore";var o;var p={};var q=[];for(var i=0;i<n.length;++i){var t=n[i],u=t.modelBind;if(s!==t.editorMetadata.groupId){o=new G({label:t.editorMetadata.groupTitle||undefined,layoutData:new g({linebreak:false})});s=t.editorMetadata.groupId;q.push(o);}var v=new c({});v.setModel(u.model);if(u.isOdata){var U=t.editorMetadata.editorInfo.odataURL;if(!p[U]){var w=t.editorMetadata.editorInfo.bindingPath;v.bindElement(w);p[U]=t.modelBind.model.getContext(w);}else{v.setBindingContext(p[U]);}}v.addElement(this._createControl(t));o.addGroupElement(v);}return q;},_createControl:function(o){var i,n,p;if(o.editorMetadata.extendedUsage){p=new B({text:r.i18n.getText("userDefaultsExtendedParametersTitle"),tooltip:r.i18n.getText("userDefaultsExtendedParametersTooltip"),type:{parts:["MdlParameter>/"+o.parameterName+"/valueObject/extendedValue/Ranges"],formatter:function(R){return R&&R.length?h.Emphasized:h.Transparent;}},press:function(s){E.openDialog(o,this.saveExtendedValue.bind(this));}.bind(this)}).addStyleClass("sapUshellExtendedDefaultParamsButton");}n=new b({width:f.system.phone?"auto":"12rem",textAlign:f.system.phone?"Left":"Right"});if(o.modelBind.isOdata&&o.editorMetadata.editorInfo){i=new S({value:o.modelBind.sPropertyName,name:o.parameterName,fieldGroupIds:["UserDefaults"]});n.setLabelFor(i);}else{i=new I({name:o.parameterName,value:o.modelBind.sPropertyName,fieldGroupIds:["UserDefaults"],type:"Text"});i.addAriaLabelledBy(n);n.setText((o.editorMetadata.displayText||o.parameterName)+":");n.setTooltip(o.editorMetadata.description||o.parameterName);}i.attachChange(this.storeChangedData.bind(this));i.attachChange(this._setDirtyState.bind(this,true),this);i.addStyleClass("sapUshellDefaultValuesSmartField");i.setLayoutData(new a({shrinkFactor:0}));var q=new F({width:f.system.phone?"100%":"auto",alignItems:f.system.phone?"Start":"Center",direction:(f.system.phone&&!p)?"Column":"Row",items:[n,i,p],wrap:"Wrap"});return q;},saveExtendedValue:function(o){var p=o.getSource().getModel().getProperty("/parameterName"),i=this.oModel,t=o.getParameters().tokens||[],s="/"+p+"/valueObject/extendedValue/Ranges",n,v={extendedValue:{Ranges:[]}};d(this.oCurrentParameters[p].valueObject,v);n=t.map(function(T){var q=T.data("range");return{Sign:q.exclude?"E":"I",Option:q.operation!=="Contains"?q.operation:"CP",Low:q.value1,High:q.value2||null};});if(!i.getProperty("/"+p+"/valueObject/extendedValue")){i.setProperty("/"+p+"/valueObject/extendedValue",{});}i.setProperty(s,n);this.oChangedParameters[p]=true;if(o.getParameter("_tokensHaveChanged")){this._setDirtyState(true);}},_setDirtyState:function(i){this.oDirtyStateModel.setProperty("/isDirty",i);this._setSmartVariantModified(i);if(i){this.sLastSelectedKey=this.getView().getModel("systemContexts").getProperty("/selectedKey");}},_setSelectedVariant:function(s){this.oDirtyStateModel.setProperty("/selectedVariant",s);this.storeChangedData();},storeChangedData:function(){var n=this.aDisplayedUserDefaults,p,v,o;for(var i=0;i<n.length;++i){p=n[i].parameterName;v=this.oCurrentParameters[p].valueObject;o=n[i].modelBind;if(!this.oBlockedParameters[p]){var q={value:v&&v.value,extendedValue:v&&v.extendedValue};if(o&&o.model){var s=o.model;var t=o.extendedModel;var u=o.sFullPropertyPath;var A=s.getProperty(u)!==""?s.getProperty(u):undefined;var N={value:A,extendedValue:t.getProperty("/"+p+"/valueObject/extendedValue")};if(!D(N,q)){v.value=A;if(N.extendedValue){v.extendedValue={};d(v.extendedValue,N.extendedValue);}this.oChangedParameters[p]=true;}}}}},onCancel:function(){this._setDirtyState(false);var n=Object.keys(this.oChangedParameters),o=this.aDisplayedUserDefaults,p,q,s;if(n.length>0){for(var i=0;i<o.length&&n.length>0;i++){p=o[i].parameterName;if(n.indexOf(p)>-1){s=this.oOriginalParameters[p];q=o[i].modelBind;q.model.setProperty(q.sFullPropertyPath,s.valueObject.value||"");if(s.editorMetadata&&s.editorMetadata.extendedUsage){q.extendedModel.setProperty("/"+p+"/valueObject/extendedValue",s.valueObject.extendedValue||{});}}}this.oCurrentParameters=d({},this.oOriginalParameters);this.oChangedParameters={};}this._setDefaultVariant();},onSave:function(){this._setDirtyState(false);var i=Object.keys(this.oChangedParameters||{}).sort();var p;if(i.length===0){p=Promise.resolve();}else{p=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(o){return o.getSystemContext(this.sLastSelectedKey);}.bind(this)).then(function(s){this.oChangedParameters={};return this._saveParameterValues(i,s);}.bind(this));}return p.then(this._resetSmartVariantManagement.bind(this)).then(this._setDefaultVariant.bind(this));},_saveParameterValues:function(n,s){var p=[];var o;var q;var v;var t;for(var i=0;i<n.length;i++){o=n[i];v=this.oCurrentParameters[o].valueObject;t=this.oOriginalParameters[o].valueObject;if(!D(t,v)){if(v&&v.value===null||v&&v.value===""){v.value=undefined;}if(v&&v.extendedValue&&Array.isArray(v.extendedValue.Ranges)&&v.extendedValue.Ranges.length===0){v.extendedValue=undefined;}q=this._saveParameterValue(o,v,t,s);p.push(q);}}return Promise.all(p);},_saveParameterValue:function(n,v,o,s){return sap.ushell.Container.getServiceAsync("UserDefaultParameters").then(function(u){return new Promise(function(i,p){u.editorSetValue(n,v,s).done(function(){o.value=v.value;i();}).fail(p);});});},_setSmartVariantModified:function(i){if(!this._bIsSupportedPlatform){return;}this.getView().byId("defaultSettingsVariantManagement").currentVariantSetModified(i);},_setDefaultVariant:function(){if(!this._bIsSupportedPlatform){return;}var s=this.getView().byId("defaultSettingsVariantManagement");s.setCurrentVariantId(s.getDefaultVariantKey());this._setSelectedVariant(s.getDefaultVariantKey());},_resetSmartVariantManagement:function(){if(!this._bIsSupportedPlatform){return Promise.resolve();}this.getView().byId("defaultSettingsVariantManagement").removeAllPersonalizableControls();return this._initializeSmartVariantManagement();},_initializeSmartVariantManagement:function(){if(!this._bIsSupportedPlatform){return Promise.resolve();}var s=this.getView().byId("defaultSettingsVariantManagement"),i=function(){this._setSelectedVariant(s.getSelectionKey());}.bind(this);return new Promise(function(n){var u=this.getView().byId("userDefaultsForm"),p=new P({type:"wrapper",keyName:"persistencyKey",dataSource:"none",control:u});s.detachSelect(i).detachAfterSave(i).addPersonalizableControl(p).attachSelect(i).attachAfterSave(i).initialise(function(){s.setVisible(true);n();},u);}.bind(this)).then(i);},_saveIsSupportedPlatform:function(){var p=sap.ushell.Container.getLogonSystem().getPlatform();this._bIsSupportedPlatform=(p!=="cdm");return Promise.resolve(this._bIsSupportedPlatform);},displayDiffText:function(){if(!this._bIsSupportedPlatform){return false;}var s=this.getView().byId("defaultSettingsVariantManagement"),u=this.getView().byId("userDefaultsForm"),i=s.getStandardVariantKey(),n=s.getSelectionKey(),o,v;if(n===i){return false;}o=s.getVariantContent(u,i);v=s.getVariantContent(u,n);delete v.executeOnSelection;return!D(o,v);}});});
