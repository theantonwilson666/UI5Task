// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/CustomData","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/base/util/ObjectPath","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/utils/WindowUtils","sap/m/IconTabFilter","sap/ushell/utils"],function(C,a,J,O,E,r,W,I,S){"use strict";return a.extend("sap.ushell.components.shell.MenuBar.controller.MenuBar",{onInit:function(){this.oContainerRouter=sap.ushell.Container.getRenderer().getRouter();this.oContainerRouter.getRoute("home").attachMatched(this._selectIndexAfterRouteChange,this);this.oContainerRouter.getRoute("openFLPPage").attachMatched(this._selectIndexAfterRouteChange,this);this.oEventHubListener=E.on("enableMenuBarNavigation").do(function(e){this.getView().getModel("viewConfiguration").setProperty("/enableMenuBarNavigation",e);}.bind(this));var v=new J({selectedKey:"None Existing Key",enableMenuBarNavigation:true,ariaTexts:{headerLabel:r.i18n.getText("SpacePageNavgiationRegion")}});this.getView().setModel(v,"viewConfiguration");this.oURLParsingService=sap.ushell.Container.getServiceAsync("URLParsing");this.oSpacesPagesHierarchy=sap.ushell.Container.getServiceAsync("Menu").then(function(m){return m.getSpacesPagesHierarchy();});this._selectIndexAfterRouteChange();},onMenuItemSelection:function(e){var s=e.getParameter("key");var m=this.getView().getModel("menu");var M=m.getProperty("/");var d=this._getNestedMenuEntryByUid(M,s);if(d.type==="IBN"){this._performCrossApplicationNavigation(d.target);}if(d.type==="URL"){this._openURL(d.target);}},_getNestedMenuEntry:function(m,c){return m.reduce(function(s,M){if(s){return s;}if(c(M)){return M;}if(M.menuEntries){return this._getNestedMenuEntry(M.menuEntries,c);}}.bind(this),undefined);},_getNestedMenuEntryByUid:function(m,u){function c(M){return M.uid===u;}return this._getNestedMenuEntry(m,c);},_performCrossApplicationNavigation:function(d){return sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(c){var p={};d.parameters.forEach(function(P){if(P.name&&P.value){p[P.name]=[P.value];}});c.toExternal({target:{semanticObject:d.semanticObject,action:d.action},params:p});});},_openURL:function(d){W.openURL(d.url,"_blank");},_selectIndexAfterRouteChange:function(){var v=this.getView().getModel("viewConfiguration");return Promise.all([this.oURLParsingService,this.oSpacesPagesHierarchy]).then(function(R){var u=R[0];var s=R[1];var b;var h=window.hasher.getHash();var H=u.parseShellHash(h);var m=this.getView().getModel("menu").getProperty("/");if(H.semanticObject==="Shell"&&H.action==="home"){var o=s.spaces.find(function(e){return(!!(e.id&&e.pages&&e.pages[0]&&e.pages[0].id));});b=(o)?this._getMenuUID(m,o.id,o.pages[0].id)||"":"";v.setProperty("/selectedKey",b);}else{var c=O.get("params.spaceId.0",H);var p=O.get("params.pageId.0",H);var d=v.getProperty("/selectedKey");var M=this._getNestedMenuEntryByUid(m,d);if(this._hasSpaceIdAndPageId(M,c,p)){b=M.uid;}else{b=this._getMenuUID(m,c,p);}if(b){v.setProperty("/selectedKey",b);}else{v.setProperty("/selectedKey","None Existing Key");}}}.bind(this));},_getMenuUID:function(m,s,p){function c(o){return this._hasSpaceIdAndPageId(o,s,p);}var M=this._getNestedMenuEntry(m,c.bind(this));return M&&M.uid;},_hasSpaceIdAndPageId:function(m,s,p){var P=O.get("target.parameters",m)||[];var o=P.find(function(c){return c.name==="spaceId"&&c.value===s;});var b=P.find(function(c){return c.name==="pageId"&&c.value===p;});return o!==undefined&&b!==undefined;},_menuFactory:function(i,c){return new I(i,{key:"{menu>uid}",text:"{menu>title}",enabled:"{viewConfiguration>/enableMenuBarNavigation}",items:{path:"menu>menuEntries",factory:this._menuFactory.bind(this)}}).addCustomData(new C({key:"help-id",value:"{= 'MenuEntry-' + ${menu>help-id}}",writeToDom:"{= !!${menu>help-id}}"}));},onExit:function(){this.oEventHubListener.off();}});});
