// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/model/json/JSONModel","sap/m/StandardListItem","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/Config","sap/ushell/resources","sap/ushell/ui/footerbar/AboutButton","sap/ushell/ui/footerbar/ContactSupportButton","sap/ushell/ui/footerbar/EndUserFeedback","sap/ushell/ui/launchpad/ActionItem","sap/ushell/ui/QuickAccess","sap/ushell/EventHub","sap/m/library","sap/base/Log","sap/ui/performance/Measurement","sap/ui/core/ElementMetadata"],function(C,D,J,S,A,a,r,b,c,E,d,Q,f,l,L,M,g){"use strict";var h=l.ListType;var B=l.ButtonType;function _(){return A.getElementsModel().getModel();}function i(s){if(!sap.ui.getCore().byId(s)){L.debug("Could not render ActionItem because it was not created: "+s);return false;}return true;}return C.extend("sap.ushell.components.shell.MeArea.MeArea",{_aDanglingControl:[],_aDoables:[],onInit:function(){var o=this.getShellConfig();this._createActionButtons(o);var u=sap.ushell.Container.getUser();var e=a.last("/core/shell/model/currentState/actions").filter(i);this.oModel=new J({actions:e,userName:u.getFullName()||u.getId()});this._aDoables.push(a.on("/core/shell/model/currentState/actions").do(function(j){var F=j.filter(i);this.getModel().setProperty("/actions",F);}.bind(this)));this._aDoables.push(f.on("showMeArea").do(function(s){var p=sap.ui.getCore().byId("sapUshellMeAreaPopover");if(p&&p.isOpen()||!s){this._toggleMeAreaPopover(false);}else{this._toggleMeAreaPopover(true);}}.bind(this)));},onExit:function(){this._destroyDanglingControls();this._aDoables.forEach(function(o){o.off();});this._aDanglingControl=[];this._aDoables=[];var p=sap.ui.getCore().byId("sapUshellMeAreaPopover");if(p){p.destroy();}},getModel:function(){return this.oModel;},_createActionButtons:function(o){var e=a.last("/core/extension/enableHelp");var j=a.last("/core/shell/enableAbout");if(j){this._createAboutButton(e);}if(!o.moveAppFinderActionToShellHeader&&a.last("/core/catalog/enabled")){this._createAppFinderButton(o,e);}if(!o.moveUserSettingsActionToShellHeader){this._createSettingsButton(e);}if(!o.moveContactSupportActionToShellHeader){this._createSupportTicketButton(e);}this._createEndUserFeedbackButton(o,e);if(o.enableRecentActivity&&a.last("/core/shell/model/currentState/showRecentActivity")){this._createRecentActivitiesButton();this._createFrequentActivitiesButton();}if(!o.disableSignOut){this._createLogoutButton();}},_createAppFinderButton:function(o,e){if(sap.ui.getCore().byId("openCatalogBtn")){return;}var O=new d("openCatalogBtn",{text:r.i18n.getText("open_appFinderBtn"),icon:"sap-icon://sys-find",visible:!o.disableAppFinder,actionType:"action",press:function(){M.start("FLP:AppFinderLoadingStartToEnd","AppFinderLoadingStartToEnd","FLP");sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(j){j.toExternal({target:{semanticObject:"Shell",action:"appfinder"}});});}});if(e){O.addStyleClass("help-id-openCatalogActionItem");}this._addDanglingControl(O);},_createAboutButton:function(e){var I="aboutBtn";if(!sap.ui.getCore().byId(I)){var o=new b(I);if(e){o.addStyleClass("help-id-aboutBtn");}this._addDanglingControl(o);this.getRenderer().showActionButton(I,false);}},_createSettingsButton:function(e){var I="userSettingsBtn";if(!sap.ui.getCore().byId(I)){var u=new d(I,{text:r.i18n.getText("userSettings"),icon:"sap-icon://action-settings",press:function(){f.emit("openUserSettings",Date.now());}});if(e){u.addStyleClass("help-id-loginDetails");}this._addDanglingControl(u);}},_createSupportTicketButton:function(e){a.on("/core/extension/SupportTicket").do(function(j){var I="ContactSupportBtn";var o=sap.ui.getCore().byId(I);if(j&&!o){o=new c(I);this._addDanglingControl(o);if(e){o.addStyleClass("help-id-contactSupportBtn");}}if(j){this.getRenderer().showActionButton(I);}else{this.getRenderer().hideActionButton(I);}}.bind(this));},_createEndUserFeedbackButton:function(o,e){a.on("/core/extension/EndUserFeedback").do(function(j){if(j){var I="EndUserFeedbackBtn";var k=sap.ui.getCore().byId(I);if(!k){var m=this.getRenderer().getEndUserFeedbackConfiguration();k=new E(I,{showAnonymous:m.showAnonymous,anonymousByDefault:m.anonymousByDefault,showLegalAgreement:m.showLegalAgreement,showCustomUIContent:m.showCustomUIContent,feedbackDialogTitle:m.feedbackDialogTitle,textAreaPlaceholder:m.textAreaPlaceholder,customUIContent:m.customUIContent,visible:false});if(e){k.addStyleClass("help-id-EndUserFeedbackBtn");}k.setModel(_());this._addDanglingControl(k);}sap.ushell.Container.getServiceAsync("EndUserFeedback").then(function(n){a.emit("/core/shell/model/showEndUserFeedback",true);this._setupEndUserFeedbackButton(n,k,o);}.bind(this));}else{a.emit("/core/shell/model/showEndUserFeedback",false);}}.bind(this));},_setupEndUserFeedbackButton:function(o,j,k){try{o.isEnabled().done(function(){var m=this.getRenderer().getEndUserFeedbackConfiguration();if(k.moveGiveFeedbackActionToShellHeader){M.start("FLP:Shell.controller._createActionButtons","create give feedback as shell head end item","FLP");var t=sap.ui.getCore().byId("EndUserFeedbackHandlerBtn");if(t){t.setModel(_());t.setShowAnonymous(m.showAnonymous);t.setAnonymousByDefault(m.anonymousByDefault);t.setShowLegalAgreement(m.showLegalAgreement);t.setShowCustomUIContent(m.showCustomUIContent);t.setFeedbackDialogTitle(m.feedbackDialogTitle);t.setTextAreaPlaceholder(m.textAreaPlaceholder);t.setAggregation("customUIContent",m.customUIContent,false);j.attachPress(function(){t.firePress();});}M.end("FLP:Shell.controller._createActionButtons");}j.setVisible(true);this.getRenderer().showActionButton(j.getId());}.bind(this)).fail(function(){if(k.moveGiveFeedbackActionToShellHeader){this.getRenderer().hideHeaderEndItem(j.getId());}else{this.getRenderer().hideActionButton(j.getId());}}.bind(this));}catch(e){L.error("EndUserFeedback adapter is not found",e.message||e);}},_createRecentActivitiesButton:function(){var I="recentActivitiesBtn";a.on("/core/shell/model/enableTrackingActivity").do(function(e){if(e){var R=sap.ui.getCore().byId(I);if(!R){R=new d(I,{text:r.i18n.getText("recentActivities"),icon:"sap-icon://customer-history",press:function(){Q.openQuickAccessDialog("recentActivityFilter","meAreaHeaderButton");}});this._addDanglingControl(R);}this.getRenderer().showActionButton(I,false);}else{this.getRenderer().hideActionButton(I,false);}}.bind(this));},_createFrequentActivitiesButton:function(){var I="frequentActivitiesBtn";a.on("/core/shell/model/enableTrackingActivity").do(function(e){if(e){var F=sap.ui.getCore().byId(I);if(!F){F=new d(I,{text:r.i18n.getText("frequentActivities"),icon:"sap-icon://activity-individual",tooltip:r.i18n.getText("frequentActivitiesTooltip"),press:function(){Q.openQuickAccessDialog("frequentlyUsedFilter","meAreaHeaderButton");}});this._addDanglingControl(F);}this.getRenderer().showActionButton(I,false);}else{this.getRenderer().hideActionButton(I,false);}}.bind(this));},_createLogoutButton:function(){var I="logoutBtn";if(sap.ui.getCore().byId(I)){return;}var o=new d(I,{visible:true,type:B.Transparent,icon:"sap-icon://log",text:r.i18n.getText("signoutBtn_title"),press:this.logout});this._addDanglingControl(o);this.getRenderer().showActionButton(I,false);},logout:function(){sap.ui.require(["sap/m/MessageBox","sap/ushell/ui/launchpad/LoadingDialog"],function(e,j){var o=new j({text:""}),s=true,I=false,k={};sap.ushell.Container.getGlobalDirty().done(function(m){s=false;if(I===true){o.exit();o=new j({text:""});}var n=function(){var R=r.i18n;if(m===sap.ushell.Container.DirtyState.DIRTY){k.message=R.getText("unsaved_data_warning_popup_message");k.icon=e.Icon.WARNING;k.messageTitle=R.getText("unsaved_data_warning_popup_title");}else{k.message=R.getText("signoutConfirmationMsg");k.icon=e.Icon.QUESTION;k.messageTitle=R.getText("signoutMsgTitle");}return k;};k=n(m);e.show(k.message,k.icon,k.messageTitle,[e.Action.OK,e.Action.CANCEL],function(p){if(p===e.Action.OK){o.openLoadingScreen();o.showAppInfo(r.i18n.getText("beforeLogoutMsg"),null);sap.ushell.Container.logout();}else if(window.document.activeElement&&window.document.activeElement.tagName==="BODY"){window.document.getElementById("meAreaHeaderButton").focus();}},g.uid("confirm"));});if(s===true){o.openLoadingScreen();I=true;}});},_addDanglingControl:function(o){this._aDanglingControl.push(o);},_destroyDanglingControls:function(){if(this._aDanglingControl){this._aDanglingControl.forEach(function(o){if(o.destroyContent){o.destroyContent();}o.destroy();});}},_toggleMeAreaPopover:function(s){var p=sap.ui.getCore().byId("sapUshellMeAreaPopover");if(!p){p=sap.ui.xmlfragment("sap.ushell.components.shell.MeArea.MeAreaPopover",this);p.setModel(this.getModel());}else if(s){p.getModel().refresh(true);}if(s){p.openBy(sap.ui.getCore().byId("meAreaHeaderButton"));}else{p.close();}},meAreaPopoverItemFactory:function(I,o){var e=sap.ui.getCore().byId(o.getObject()),j;var k=function(){if(e){e.firePress();f.emit("showMeArea",false);}};j=new S({id:I+"-"+e.getId(),icon:e.getIcon(),iconInset:true,title:e.getText(),visible:e.getVisible(),type:h.Active,customData:[{key:"actionItemId",value:e.getId()}],press:k});j.addStyleClass("sapUshellMeAreaActionItem");j.addEventDelegate({onkeydown:function(m){if(m.keyCode===32){k();}}});return j;},getRenderer:function(){if(!this._oRenderer){this._oRenderer=sap.ushell.Container.getRenderer("fiori2");}return this._oRenderer;},getShellConfig:function(){return this.getRenderer().getShellConfig();}});});
