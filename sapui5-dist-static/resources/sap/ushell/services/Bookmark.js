// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/Config","sap/ushell/library","sap/base/util/deepClone","sap/base/util/deepExtend"],function(q,C,l,d,a){"use strict";function B(){var L=sap.ushell.Container.getService("LaunchPage");if(C.last("/core/spaces/enabled")){this._oPagesServicePromise=sap.ushell.Container.getServiceAsync("Pages");}else{this._oPagesServicePromise=Promise.reject("Pages service is not available in classic homepage mode.");}this._isMatchingRemoteCatalog=function(c,r){var o=L.getCatalogData(c);return o.remoteId===r.remoteId&&o.baseUrl.replace(/\/$/,"")===r.baseUrl.replace(/\/$/,"");};this._addBookmarkToContentNodes=function(b,c,e){var f=l.ContentNodeType;var p=c.map(function(o){if(o&&o.hasOwnProperty("type")&&o.isContainer){switch(o.type){case f.Page:return this.addBookmarkToPage(b,o.id);case f.HomepageGroup:return new Promise(function(r,g){L.getGroupById(o.id).done(r).fail(g);}).then(function(g){return this.addBookmarkToHomepageGroup(b,g,e);}.bind(this));default:return Promise.reject("Bookmark Service: The API needs to be called with a valid content node type. '"+o.type+"' is not supported.");}}return Promise.reject("Bookmark Service: Not a valid content node.");}.bind(this));return Promise.all(p);};this.addBookmark=function(p,c){var D=new q.Deferred();if(!C.last("/core/shell/enablePersonalization")){return D.resolve().promise();}if(typeof c==="undefined"&&C.last("/core/spaces/enabled")){sap.ushell.Container.getServiceAsync("Menu").then(function(m){return m.getDefaultPage();}).then(function(P){return{id:P.id,label:P.title,type:l.ContentNodeType.Page,isContainer:true};}).then(function(o){this._addBookmarkToContentNodes(p,[o]).then(D.resolve).catch(D.reject);}.bind(this));return D.promise();}if((typeof c==="undefined"||!c.hasOwnProperty("type"))&&!Array.isArray(c)){this.addBookmarkToHomepageGroup(p,c).then(D.resolve).catch(D.reject);return D.promise();}var b=[].concat(c);this._addBookmarkToContentNodes(p,b).then(D.resolve).catch(D.reject);return D.promise();};this.addCustomBookmark=function(v,c,b){var o=d(c);var e=a(o,{vizType:v,vizConfig:{"sap.flp":{chipConfig:o.chipConfig},"sap.platform.runtime":{includeManifest:!o.loadManifest}}});delete e.chipConfig;delete e.loadManifest;var f=[].concat(b);return this._addBookmarkToContentNodes(e,f,true);};this.addBookmarkToHomepageGroup=function(p,g,c){if(C.last("/core/spaces/enabled")){var e="Bookmark Service: The API is not available in spaces mode.";return Promise.reject(e);}return new Promise(function(r,b){var D=c?L.addCustomBookmark(p,g):L.addBookmark(p,g);D.done(function(t){var o={tile:t,group:g};sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileAdded",o);r();}).fail(b);});};this.addBookmarkToPage=function(p,P){if(!C.last("/core/spaces/enabled")){return Promise.reject("Bookmark Service: 'addBookmarkToPage' is not valid in launchpad homepage mode, use 'addBookmark' instead.");}if(!C.last("/core/shell/enablePersonalization")){return Promise.reject("Bookmark Service: Add bookmark is not allowed as the personalization functionality is not enabled.");}if(p&&(typeof p.title!=="string"||typeof p.url!=="string")){return Promise.reject("Bookmark Service - Invalid bookmark data.");}return this._oPagesServicePromise.then(function(o){return o.addBookmarkToPage(P,p);});};this.addBookmarkByGroupId=function(p,g){if(C.last("/core/spaces/enabled")){var e="Bookmark Service: The API 'addBookmarkByGroupId' is not supported in launchpad spaces mode.";return q.Deferred().reject(e).promise();}return L.getGroups().then(function(G){G=q.grep(G,function(b){return b.id===g;});var o=null;if(G.length>0){o=G[0];}return this.addBookmark(p,o);}.bind(this));};this.getShellGroupIDs=function(g){if(C.last("/core/spaces/enabled")){var e="Bookmark Service: The API 'getShellGroupIDs' is not supported in launchpad spaces mode.";return q.Deferred().reject(e).promise();}var D=new q.Deferred();L.getGroupsForBookmarks(g).done(function(G){G=G.map(function(b){var n={id:L.getGroupId(b.object),title:b.title};return n;});D.resolve(G);});return D;};this._doAddCatalogTileToGroup=function(D,c,o,g){var e,f=D.reject.bind(D);function i(c,h){var I=L.getCatalogTileId(h);if(I===undefined){return false;}return I.indexOf(c)===0;}function b(G){L.getCatalogTiles(o).fail(f).done(function(h){var g=L.getGroupId(G),t=h.some(function(j){if(i(c,j)){L.addTile(j,G).fail(f).done(function(){D.resolve();sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","catalogTileAdded",g);});return true;}});if(!t){e="No tile '"+c+"' in catalog '"+L.getCatalogId(o)+"'";q.sap.log.error(e,null,"sap.ushell.services.Bookmark");f(e);}});}if(g){L.getGroups().fail(f).done(function(G){var h=G.some(function(j){if(L.getGroupId(j)===g){b(j);return true;}});if(!h){e="Group '"+g+"' is unknown";q.sap.log.error(e,null,"sap.ushell.services.Bookmark");f(e);}});}else{L.getDefaultGroup().fail(f).done(b);}return D.promise();};this.addCatalogTileToGroup=function(c,g,o){var D=new q.Deferred(),e,f=D.reject.bind(D),m,s="X-SAP-UI2-HANA:hana?remoteId=HANA_CATALOG",t=this;if(C.last("/core/spaces/enabled")){e="Bookmark Service: The API 'addCatalogTileToGroup' is not supported in launchpad spaces mode.";return D.reject(e).promise();}function i(b){return L.getCatalogId(b)===s;}m=o?this._isMatchingRemoteCatalog:i;o=o||{id:s};L.onCatalogTileAdded(c);L.getCatalogs().fail(f).done(function(b){var S;b.forEach(function(h){if(m(h,o)){if(!S){S=h;}else{q.sap.log.warning("More than one matching catalog: "+JSON.stringify(o),null,"sap.ushell.services.Bookmark");}}});if(S){t._doAddCatalogTileToGroup(D,c,S,g);}else{e="No matching catalog found: "+JSON.stringify(o);q.sap.log.error(e,null,"sap.ushell.services.Bookmark");D.reject(e);}});return D.promise();};this.countBookmarks=function(u){if(C.last("/core/spaces/enabled")){var D=q.Deferred();this._oPagesServicePromise.then(function(p){return p.countBookmarks({url:u});}).then(D.resolve,D.reject);return D.promise();}return L.countBookmarks(u);};this.countCustomBookmarks=function(i){if(!i||!i.url||!i.vizType){return Promise.reject("countCustomBookmarks: Some required parameters are missing.");}if(C.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(p){return p.countBookmarks(i);});}return L.countCustomBookmarks(i);};this.deleteBookmarks=function(u){if(C.last("/core/spaces/enabled")){var D=q.Deferred();this._oPagesServicePromise.then(function(P){return P.deleteBookmarks({url:u});}).then(D.resolve,D.reject);return D.promise();}var p=L.deleteBookmarks(u);p.done(function(){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",u);});return p;};this.deleteCustomBookmarks=function(i){if(!i||!i.url||!i.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.");}if(C.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(p){return p.deleteBookmarks(i);});}return L.deleteCustomBookmarks(i).then(function(){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",i.url);});};this.updateBookmarks=function(u,p){if(C.last("/core/spaces/enabled")){var D=q.Deferred();this._oPagesServicePromise.then(function(P){return P.updateBookmarks({url:u},p);}).then(D.resolve,D.reject);return D.promise();}return L.updateBookmarks(u,p);};this.updateCustomBookmarks=function(i,c){if(!i||!i.url||!i.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.");}var b=a({},c,{vizConfig:{"sap.flp":{chipConfig:c.chipConfig},"sap.platform.runtime":{includeManifest:!c.loadManifest}}});delete b.chipConfig;delete b.loadManifest;if(C.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(p){return p.updateBookmarks(i,b);});}return L.updateCustomBookmarks(i,b);};this.getContentNodes=function(){var b=l.ContentNodeType;if(C.last("/core/spaces/enabled")){return sap.ushell.Container.getServiceAsync("Menu").then(function(m){return m.getSpacesPagesHierarchy();}).then(function(s){return s.spaces.map(function(S){return{id:S.id,label:S.title,type:b.Space,isContainer:false,children:S.pages.map(function(p){return{id:p.id,label:p.title,type:b.Page,isContainer:true};})};});});}return new Promise(function(r,c){L.getGroups().done(r).fail(c);}).then(function(h){return h.map(function(g){return{id:L.getGroupId(g),label:L.getGroupTitle(g),type:b.HomepageGroup,isContainer:true};});});};}B.hasNoAdapter=true;return B;},true);
