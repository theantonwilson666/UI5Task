// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/services/_ClientSideTargetResolution/Utils","sap/ushell/services/_ClientSideTargetResolution/VirtualInbounds","sap/ushell/services/_ClientSideTargetResolution/Formatter","sap/ushell/TechnicalParameters","sap/base/Log","sap/ui/thirdparty/jquery"],function(u,U,v,f,t,L,q){"use strict";var A=[undefined,"GUI","WDA","UI5"];function a(M,I){var R=M.inbound.resolutionResult;if(!R){return"";}return["applicationType","ui5ComponentName","url","additionalInformation","text"].map(function(K){if(I){return R.hasOwnProperty(K)?K+":"+R[K]:"";}return R.hasOwnProperty(K)?R[K]:"";}).join("");}function b(M){return M.sort(function(s,y){if((s["sap-priority"]||0)-(y["sap-priority"]||0)!==0){return-((s["sap-priority"]||0)-(y["sap-priority"]||0));}if(s.priorityString<y.priorityString){return 1;}if(s.priorityString>y.priorityString){return-1;}var S=a(s);var z=a(y);if(S<z){return 1;}else if(S>z){return-1;}return 0;});}function e(I,M){var s;if(I&&I["sap-priority"]&&I["sap-priority"][0]){s=parseInt(I["sap-priority"][0],10);if(!isNaN(s)){M["sap-priority"]=s;}}return;}function m(V,F,K,M){var s;if(!F){return true;}if(!V&&V!==""){return false;}s=F.value;if(F.format==="reference"){if(/UserDefault\.extended\./.test(s)){L.error("Illegal inbound: extended user default '"+s+"' used as filter");return false;}if(K.hasOwnProperty(s)){return V===K[s];}M[s]=true;return true;}if(F.format==="value"||F.format==="plain"||F.format===undefined){return V===F.value;}else if(F.format==="regexp"){return!!V.match("^"+F.value+"$");}L.error("Illegal oFilter format");return false;}function g(M){return M.inbound&&M.inbound.resolutionResult&&M.inbound.resolutionResult["sap.ui"]&&M.inbound.resolutionResult["sap.ui"].technology;}function c(M){return M.inbound&&M.inbound.resolutionResult&&M.inbound.resolutionResult.appId;}function d(I,s,K,M,D){var y={},z={};Object.keys(I).forEach(function(P){if(P!=="sap-ushell-defaultedParameterNames"){y[P]=I[P];}});if(!s){return y;}Object.keys(s).forEach(function(P){var T=s[P],B,V=false;if(!y[P]&&T.hasOwnProperty("defaultValue")){if(T.defaultValue.format&&T.defaultValue.format==="reference"){B=T.defaultValue.value;if(K.hasOwnProperty(B)){if(typeof K[B]==="string"){y[P]=[K[B]];V=true;}else if(typeof K[B]==="object"){y[P]=K[B];V=true;}}else{y[P]=[T.defaultValue];M.push(T.defaultValue.value);}}else{y[P]=[T.defaultValue.value];V=true;}if(V){z[P]=true;}}});Object.keys(z).sort().forEach(function(P){D.push(P);});return y;}function h(M,I){M.resolutionResult={contentProviderId:I.contentProviderId};if(I&&I.resolutionResult&&I.resolutionResult.hasOwnProperty("sap.platform.runtime")){M.resolutionResult["sap.platform.runtime"]=I.resolutionResult["sap.platform.runtime"];}Object.keys(M.intentParamsPlusAllDefaults).slice(0).forEach(function(N){if(!Array.isArray(M.intentParamsPlusAllDefaults[N])){if(!M.resolutionResult.oNewAppStateMembers){M.resolutionResult.oNewAppStateMembers={};}M.resolutionResult.oNewAppStateMembers[N]=M.intentParamsPlusAllDefaults[N];}});}function i(R,M){R.forEach(function(s){M[s]=true;});}function j(M){var T=M.intentParamsPlusAllDefaults["sap-ui-tech-hint"]&&M.intentParamsPlusAllDefaults["sap-ui-tech-hint"][0];var I=M.defaultedParamNames&&(M.defaultedParamNames.indexOf("sap-ui-tech-hint")>=0);if(T&&g(M)===T){return I?1:2;}return 0;}function k(M){var s=M.intentParamsPlusAllDefaults["sap-ui-app-id-hint"]&&M.intentParamsPlusAllDefaults["sap-ui-app-id-hint"][0];if(s&&(s===c(M))){return 1;}return 0;}function l(M,y){function z(N){var s="000"+N;return s.substr(s.length-3);}return["AIDM="+k(M),"CURCP="+(y.isCurrentContentProvider?"1":"0"),M.genericSO?"g":"x","TECM="+j(M),"MTCH="+z(y.countMatchingParams),"MREQ="+z(y.countMatchingRequiredParams),"NFIL="+z(y.countMatchingFilterParams),"NDEF="+z(y.countDefaultedParams),"POT="+z(y.countPotentiallyMatchingParams),"RFRE="+z(999-y.countFreeInboundParams),"TECP="+n(M)].join(" ");}function n(M){var T=g(M);var P=A.indexOf(T);return Math.max(0,P);}function o(I,s){var y=false;if(I.signature.additionalParameters==="allowed"||I.signature.additionalParameters==="ignored"){return true;}if(I.signature.additionalParameters==="notallowed"||I.signature.additionalParameters===undefined){y=Object.keys(s).every(function(P){return!((!I.signature.parameters[P]&&P.indexOf("sap-")!==0));});}else{L.error("Unexpected value of inbound for signature.additionalParameters");}return y;}function p(I,s,K,C,D){function y(N,M,B){var E=f.formatInbound(B);N[E]=M.noMatchReason+(M.noMatchDebug?"| DEBUG: "+M.noMatchDebug:"");}var z=C?C():new q.Deferred().resolve(null).promise();return z.then(function(B){var M=s.reduce(function(R,E){var F=E.contentProviderId||"";var G=K[F]||{};if(!R.missingReferences[F]){R.missingReferences[F]={};}var H=x(I,E,G,R.missingReferences[F],B?B[F]:null);if(H.matches){R.matchResults.push(H);}else if(D){y(R.noMatchReasons,H,E);}return R;},{matchResults:[],noMatchReasons:{},missingReferences:{}});return q.when(M);});}function r(I,s,y,D,K,M){var S=Object.keys(I).every(function(P){var V=s[P],z=V&&V[0],B=I[P];if(B.required&&(z===null||z===undefined)){return false;}if(B.filter){if(!m(z,B.filter,K,M)){return false;}}return true;});return S;}function w(I,s,y,D,z){var B=I.signature.parameters,C=0,E=0,F=0,G=0,H=false,S={};function J(P){return!t.isTechnicalParameter(P);}var K=Object.keys(y).filter(J);var M=D.filter(J);Object.keys(B).filter(J).forEach(function(P){var V=s[P],O=V&&V[0],Q=B[P],R=y.hasOwnProperty(P);if(R){++C;if(Q.filter){++F;}if(Q.required){++E;}}else if(O===null||O===undefined){++G;}});if(z){S.countPotentiallyMatchingParams=K.filter(function(O){return B.hasOwnProperty(O);}).length;}else{S.countPotentiallyMatchingParams=K.length;}if(y&&y["sap-app-origin-hint"]&&(y["sap-app-origin-hint"][0]||y["sap-app-origin-hint"][0]==="")){var N=y["sap-app-origin-hint"][0];H=N===I.contentProviderId;}S.countDefaultedParams=M.length;S.countMatchingParams=C;S.countMatchingRequiredParams=E;S.countMatchingFilterParams=F;S.countFreeInboundParams=G;S.isCurrentContentProvider=H;return S;}function x(I,s,K,M,S){var y={inbound:s};function N(_,a1,b1){_.matches=false;_.noMatchReason=a1;_.noMatchDebug=b1;return _;}function z(_){_.matches=true;_.matchesVirtualInbound=v.isVirtualInbound(s);_.parsedIntent=I;return _;}var B=s.semanticObject==="*";y.genericSO=B;var C=I.semanticObject===undefined||I.semanticObject===s.semanticObject||B;if(!C){return N(y,"Semantic object \""+I.semanticObject+"\" did not match");}var D=I.action===undefined||I.action===s.action;if(!D){return N(y,"Action \""+I.action+"\" did not match");}var F=!s.deviceTypes||I.formFactor===undefined||s.deviceTypes[I.formFactor];if(!F){return N(y,"Form factor \""+I.formFactor+"\" did not match","Inbound: ["+Object.keys(s.deviceTypes).filter(function(_){return!!s.deviceTypes[_];}).join(", ")+"]");}var T=I.params&&I.params["sap-ui-tech-hint"]&&I.params["sap-ui-tech-hint"][0];if(I.treatTechHintAsFilter&&T){var E=g({inbound:s});if(E!==T){return N(y,"Tech Hint as filter \""+T+"\" did not match","Inbound: ["+E+"]");}}var R=[],G=[],H=I.params||{};var J=d(H,s.signature&&s.signature.parameters,K,R,G);var O=J["sap-system"]&&J["sap-system"][0],P=s.contentProviderId;if(O&&typeof P==="string"&&S&&!S[O]){return N(y,"Data origin \""+O+"\" is not compatible with the content provider \""+P+"\"","Inbound: ["+Object.keys(S).join(", ")+"]");}y.intentParamsPlusAllDefaults=J;y.defaultedParamNames=G;e(J,y);var Q=r(s.signature.parameters,J,H,G,K,M);if(!Q){return N(y,"Inbound parameter signature did not match",f.formatInboundSignature(s.signature));}var V=U.constructParameterDominatorMap(s.signature.parameters);var W=U.findDominatedDefaultParameters(J,G,V);var X=G.filter(function(_){return!W[_];});var Y=U.filterObjectKeys(J,function(_){return!W[_];});if(!o(s,Y)){return N(y,"Additional parameters not allowed",f.formatInboundSignature(s.signature));}var Z=s.signature.additionalParameters==="ignored";if(Z){U.filterObjectKeys(Y,function(_){if(_.indexOf("sap-")===0){return true;}if(s.signature.parameters.hasOwnProperty(_)){return true;}return false;},true);}var $=w(s,J,H,G,Z);h(y,s);y.intentParamsPlusAllDefaults=Y;y.defaultedParamNames=X;y.priorityString=l(y,$);i(R,M);return z(y);}return{match:p,matchOne:x,sortMatchingResultsDeterministic:b,matchesFilter:m,checkAdditionalParameters:o,addDefaultParameterValues:d,extractSapPriority:e,serializeMatchingResult:a};});
