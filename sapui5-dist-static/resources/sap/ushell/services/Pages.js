// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ushell/utils/RestrictedJSONModel","sap/base/util/deepClone","sap/base/util/extend","sap/base/util/deepExtend","sap/ushell/resources","sap/ushell/utils","sap/ushell/Config","sap/ushell/adapters/cdm/v3/utilsCdm","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations"],function(L,R,d,e,a,r,u,C,b,c,f){"use strict";var P=function(){this.COMPONENT_NAME="sap/ushell/services/Pages";this._oCdmServicePromise=sap.ushell.Container.getServiceAsync("CommonDataModel");this._oURLParsingServicePromise=sap.ushell.Container.getServiceAsync("URLParsing");this._oPagesModel=new R({pages:[]});this._bImplicitSaveEnabled=true;this._aPagesToBeSaved=[];};P.prototype._generateId=function(p){var i=[];var o=this.getModel().getProperty(this.getPagePath(p));o.sections.forEach(function(s){i.push(s.id);s.visualizations.forEach(function(v){i.push(v.id);});});return u.generateUniqueId(i);};P.prototype.getModel=function(){return this._oPagesModel;};P.prototype.enableImplicitSave=function(E){this._bImplicitSaveEnabled=E;};P.prototype.getPageIndex=function(p){var g=this._oPagesModel.getProperty("/pages");for(var i=0;i<g.length;++i){if(g[i].id===p){return i;}}return undefined;};P.prototype.getPagePath=function(p){var i=this.getPageIndex(p);if(typeof i==="undefined"){return"";}return"/pages/"+i;};P.prototype.loadPage=function(p){var s=this.getPagePath(p);if(s){return Promise.resolve(s);}return this._oCdmServicePromise.catch(function(E){L.error("Pages - loadPage: Couldn't resolve CDM Service.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(o){return Promise.all([o.getPage(p),o.getVisualizations(),o.getApplications(),o.getVizTypes()]);}).then(function(g){var o=g[0];var v=g[1];var A=g[2];var V=g[3];this._oPagesModel._setProperty("/vizTypes",V);return this._getModelForPage(o,v,A,V);}.bind(this)).then(function(m){var i=this._oPagesModel.getProperty("/pages/").length;var n="/pages/"+i;this._oPagesModel._setProperty(n,m);return n;}.bind(this)).catch(function(E){L.error("Pages - loadPage: Failed to gather site data.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this));};P.prototype.findVisualization=function(p,s,v,V){return this._oCdmServicePromise.catch(function(E){L.error("Pages - findVisualization: Personalization cannot be saved: CDM Service cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(o){return Promise.all([this.loadPage(p),o.getVisualizations(),o.getApplications()]).then(function(g){var h=g[0];var i=this.getModel().getProperty(h+"/sections")||[];return i.reduce(function(j,k,l){if(s&&k.id!==s){return j;}var m=k.visualizations.reduce(function(n,q,t){if(v&&q.vizId===v||V&&q.id===V){n.push(t);}return n;},[]);if(m.length){j.push({pageId:p,sectionIndex:l,vizIndexes:m});}return j;},[]);}.bind(this)).catch(function(E){L.error("Pages - findVisualization: Couldn't load page, get visualizations or applications.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this));}.bind(this));};P.prototype.moveVisualization=function(p,s,S,t,T){if(s===t&&S===T){return Promise.resolve({visualizationIndex:T});}this.setPersonalizationActive(true);var o=this._oPagesModel.getProperty("/pages/"+p);var g=o.id;var h=o.sections[s];var i=o.sections[t];var j=h.id;var k=i.id;var m=h.visualizations[S];var M=m.id;h.visualizations.splice(S,1);if(T===-1){T=i.visualizations.length;}i.visualizations.splice(T,0,m);if(h.default&&!h.visualizations.length){o.sections.splice(s,1);}this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(l){return l.getPage(g);}).catch(function(E){L.error("Pages - moveVisualization: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(l){var n=l.payload.sections[j];var q=n.layout.vizOrder;var v=n.viz;var w=l.payload.sections[k];var x=w.layout.vizOrder;var y=w.viz;var z=d(v[M]);q.splice(q.indexOf(M),1);x.splice(T,0,M);if(j!==k){delete v[M];y[M]=z;}if(n.default&&!Object.keys(v).length){delete l.payload.sections[j];l.payload.layout.sectionOrder.splice(s,1);}return this._conditionalSavePersonalization(g);}.bind(this)).then(function(){return{visualizationIndex:T};}).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.deleteVisualization=function(p,s,S){var o=this._oPagesModel.getProperty("/pages/"+p);var g=o.sections[s];if(g.default&&g.visualizations.length<2){return this.deleteSection(p,s);}this.setPersonalizationActive(true);var h=g.visualizations;var i=h[S];h.splice(S,1);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(j){return j.getPage(o.id);}).catch(function(E){L.error("Pages - deleteVisualization: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(j){var k=j.payload.sections[g.id].layout.vizOrder;var v=j.payload.sections[g.id].viz;delete v[i.id];k.splice(S,1);return this._conditionalSavePersonalization(j.identification.id);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype._getSectionIndex=function(p,s){var S=this.getModel().getProperty(p+"/sections")||[],i=0;for(;i<S.length;i+=1){if(S[i].id===s){return i;}}};P.prototype._getVisualizationData=function(p,v,V,A,o,g,U){var h=A||{vizId:v};var s={applications:o,visualizations:V,vizTypes:g};var i=c.getVizData(s,h,U);if(!i.id){i.id=this._generateId(p);}return i;};P.prototype.addVisualization=function(p,s,v){return this._oCdmServicePromise.catch(function(E){L.error("Pages - addVisualization: Personalization cannot be saved: CDM Service cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(o){return Promise.all([this.loadPage(p),o.getVisualizations(),o.getApplications(),o.getVizTypes(),this._oURLParsingServicePromise]).catch(function(E){L.error("Pages - addVisualization: Personalization cannot be saved: Failed to load page, get visualizations or get applications.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(g){var h=g[0],U=g[4],S=this._getSectionIndex(h,s),j=this.getModel().getProperty(h+"/sections")||[],V=this._getVisualizationData(p,v,g[1],null,g[2],g[3],U);var D;for(var i=0;i<j.length;i++){if(j[i].default){D=i;}}if(S!==undefined||D!==undefined){this.setPersonalizationActive(true);var k=S!==undefined?S:D||0,l=h+"/sections/"+k+"/visualizations";this.getModel().getProperty(l).push(V);this.getModel().refresh();return o.getPage(p).catch(function(E){L.error("Pages - addVisualization: Personalization cannot be saved: Failed to get page.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(n){var q=n.payload.sections[s||n.payload.layout.sectionOrder[0]];q.layout.vizOrder.push(V.id);q.viz[V.id]={id:V.id,vizId:v};return this._conditionalSavePersonalization(p);}.bind(this));}var m=parseInt(h.split("/")[2],10);return this.addSection(m,0,{title:r.i18n.getText("DefaultSection.Title"),default:true,visualizations:[V]});}.bind(this));}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.moveSection=function(p,s,t){if(s===t){return Promise.resolve();}this.setPersonalizationActive(true);var g=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections");var m=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s);var M=m.id;S.splice(s,1);if(s<t){t--;}S.splice(t,0,m);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(o){return o.getPage(g);}).catch(function(E){L.error("Pages - moveSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(o){var h=o.payload.layout.sectionOrder;h.splice(h.indexOf(M),1);h.splice(t,0,M);return this._conditionalSavePersonalization(g);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.addSection=function(p,s,S){this.setPersonalizationActive(true);var o=S||{},g=this._oPagesModel.getProperty("/pages/"+p+"/sections"),h=this._oPagesModel.getProperty("/pages/"+p+"/id");var n={id:o.id!==undefined?o.id:this._generateId(h),title:o.title!==undefined?o.title:"",visible:o.visible!==undefined?o.visible:true,preset:o.preset!==undefined?o.preset:false,locked:o.locked!==undefined?o.locked:false,default:o.default!==undefined?o.default:false,visualizations:o.visualizations!==undefined?o.visualizations:[]};g.splice(s,0,n);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(i){return i.getPage(h);}).catch(function(E){L.error("Pages - addSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(j){var k={id:n.id,title:n.title,visible:n.visible,preset:n.preset,locked:n.locked,default:n.default,layout:{vizOrder:[]},viz:{}};if(n.visualizations){var i=0,v;for(;i<n.visualizations.length;i++){v=n.visualizations[i];k.layout.vizOrder.push(v.id);if(v.isBookmark){k.viz[v.id]=c.getVizRef(v);}else{k.viz[v.id]={id:v.id,vizId:v.vizId};}}}j.payload.layout.sectionOrder.splice(s,0,n.id);j.payload.sections[n.id]=k;return this._conditionalSavePersonalization(h);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.deleteSection=function(p,s){this.setPersonalizationActive(true);var g=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections");var h=S[s].id;S.splice(s,1);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(o){return o.getPage(g);}).catch(function(E){L.error("Pages - deleteSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(o){delete o.payload.sections[h];o.payload.layout.sectionOrder.splice(s,1);return this._conditionalSavePersonalization(g);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.setSectionVisibility=function(p,s,v){this.setPersonalizationActive(true);var g=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s+"/id");var o=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s);if(o.visible===v){return Promise.resolve();}o.visible=v;this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(h){return h.getPage(g);}).catch(function(E){L.error("Pages - setSectionVisibility: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(h){h.payload.sections[S].visible=v;return this._conditionalSavePersonalization(g);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.renameSection=function(p,s,n){this.setPersonalizationActive(true);var o=this._oPagesModel.getProperty("/pages/"+p);var S=o.sections[s];S.title=n;this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(g){return g.getPage(o.id);}).catch(function(E){L.error("Pages - renameSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(g){g.payload.sections[S.id].title=n;return this._conditionalSavePersonalization(g.identification.id);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.resetSection=function(p,s){this.setPersonalizationActive(true);var g=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s+"/id");return this._oCdmServicePromise.then(function(o){return Promise.all([o.getVisualizations(),o.getApplications(),o.getPage(g),o.getOriginalPage(g),o.getVizTypes()]);}).catch(function(E){L.error("Pages - resetSection: Personalization cannot be saved: Failed to gather data from CDM Service.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(h){var v=h[0];var A=h[1];var o=h[2];var O=h[3];var V=h[4];return Promise.all([this._getModelForPage(O,v,A,V),o,O]);}.bind(this)).then(function(h){var o=h[0];var i=h[1];var O=h[2];var j=d(o.sections.find(function(m){return m.id===S;}),20);var k=j.visualizations.map(function(v){return v.id;});var l=this._oPagesModel.getProperty("/pages/"+p);l.sections.forEach(function(m){if(j.id!==m.id){m.visualizations.forEach(function(v){if(k.indexOf(v.id)!==-1){var n=this._generateId(g);var V=d(i.payload.sections[m.id].viz[v.id]);delete i.payload.sections[m.id].viz[v.id];var q=i.payload.sections[m.id].layout.vizOrder.indexOf(V.id);V.id=n;i.payload.sections[m.id].viz[n]=V;i.payload.sections[m.id].layout.vizOrder[q]=n;v.id=n;}}.bind(this));}}.bind(this));this._oPagesModel._setProperty("/pages/"+p+"/sections/"+s,j);i.payload.sections[j.id]=O.payload.sections[j.id];return this._conditionalSavePersonalization(i.identification.id);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.resetPage=function(p){this.setPersonalizationActive(true);var s=this._oPagesModel.getProperty("/pages/"+p+"/id");return this._oCdmServicePromise.then(function(o){return Promise.all([o.getVisualizations(),o.getApplications(),o.getPage(s),o.getOriginalPage(s),o.getVizTypes()]);}).catch(function(E){L.error("Pages - resetPage: Personalization cannot be saved: Failed to gather data from CDM Service.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(g){var v=g[0];var A=g[1];var o=g[2];var O=g[3];var V=g[4];return Promise.all([this._getModelForPage(O,v,A,V),o,O]);}.bind(this)).then(function(g){var o=g[0];var h=g[1];var O=g[2];this._oPagesModel._setProperty("/pages/"+p,o);h.payload=d(O.payload);return this._conditionalSavePersonalization(h.identification.id);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.setPersonalizationActive=function(s){if(!this._bDirtyState&&s===true){this._bDirtyState=true;this._oCopiedModelData=d(this._oPagesModel.getProperty("/"),20);}else if(this._bDirtyState&&s===false){this._oPagesModel._setData(this._oCopiedModelData);this._bDirtyState=false;}};P.prototype.savePersonalization=function(p){var g;if(!p){g=d(this._aPagesToBeSaved);}else{g=[p];}return this._oCdmServicePromise.then(function(o){return Promise.all(g.map(function(s){var i=this._aPagesToBeSaved.indexOf(s);this._aPagesToBeSaved.splice(i,1);return new Promise(function(h,j){o.save(s).then(h,j);}).catch(function(E){if(this._aPagesToBeSaved.indexOf(s)===-1){this._aPagesToBeSaved.push(s);}return Promise.reject(E);}.bind(this));}.bind(this)));}.bind(this)).then(function(){this._bDirtyState=false;}.bind(this)).catch(function(E){L.error("Pages - savePersonalization: Personalization cannot be saved: CDM Service cannot be retrieved or the save process encountered an error.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this));};P.prototype._conditionalSavePersonalization=function(p){if(this._bImplicitSaveEnabled){return this.savePersonalization(p);}if(this._aPagesToBeSaved.indexOf(p)===-1){this._aPagesToBeSaved.push(p);}return Promise.resolve();};P.prototype._getModelForPage=function(p,v,g,h){return Promise.all([sap.ushell.Container.getServiceAsync("ClientSideTargetResolution"),this._oURLParsingServicePromise]).catch(function(E){return Promise.reject(E);}).then(function(i){var o=i[0];var U=i[1];var j={id:p.identification.id||"",title:p.identification.title||"",description:"",sections:[]};var E=C.last("/core/catalog/enableHideGroups");return Promise.all(p.payload.layout.sectionOrder.map(function(s){var k=p.payload.sections[s];var S={id:k.id||"",title:k.default?r.i18n.getText("DefaultSection.Title"):k.title||"",visualizations:[],visible:!E||(k.visible!==undefined?k.visible:true),locked:k.locked!==undefined?k.locked:false,preset:k.preset!==undefined?k.preset:true,default:k.default!==undefined?k.default:false};j.sections.push(S);return Promise.all(k.layout.vizOrder.map(function(l){var V=k.viz[l],m=V.vizId,n=this._getVisualizationData(p.identification.id,m,v,V,g,h,U);S.visualizations.push(n);return this._isIntentSupported(n,o).then(function(I){if(!I){var q=S.visualizations.findIndex(function(t){return t.id===n.id;});S.visualizations.splice(q,1);L.warning("The visualization "+n.vizId+" is filtered out, because it does not have a supported intent.");}});}.bind(this)));}.bind(this))).then(function(){return j;});}.bind(this));};P.prototype._isIntentSupported=function(v,o){if(v.target===undefined){return Promise.resolve(false);}if(v.target.type==="URL"){if(f.isStandardVizType(v.vizType)){return Promise.resolve(!!v.target.url);}return Promise.resolve(true);}return new Promise(function(g,h){o.isIntentSupported([v.targetURL]).then(function(s){g(s[v.targetURL].supported);}).fail(function(){g(false);});});};P.prototype.addBookmarkToPage=function(p,g,s){if(!p){return Promise.reject("Pages - addBookmarkToPage: Adding bookmark tile failed: No page id is provided.");}this.setPersonalizationActive(true);return this._oCdmServicePromise.then(function(o){return Promise.all([this.loadPage(p),this._oURLParsingServicePromise,o.getVizTypes()]);}.bind(this)).catch(function(E){L.error("Pages - addBookmarkToPage: Personalization cannot be saved: Could not load page.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(h){var i=h[0];var U=h[1];var v=h[2];var V={id:this._generateId(p),vizType:g.vizType,title:g.title,subTitle:g.subtitle,icon:g.icon,info:g.info,numberUnit:g.numberUnit,target:b.toTargetFromHash(g.url,U),indicatorDataSource:{path:g.serviceUrl,refresh:g.serviceRefreshInterval},vizConfig:g.vizConfig,isBookmark:true};var o=this._getVisualizationData(p,undefined,{},V,{},v,U);var j=parseInt(/pages\/(\d+)/.exec(i)[1],10);var k=this._oPagesModel.getProperty(i);var S;if(s){S=k.sections.find(function(l){return l.id===s;});if(!S){L.error("Pages - addBookmarkToPage: Adding bookmark tile failed: specified section was not found in the page.");return Promise.reject("Pages - addBookmarkToPage: Adding bookmark tile failed: specified section was not found in the page.");}}else{S=k.sections.find(function(l){return l.default;});if(!S){return this.addSection(j,0,{title:r.i18n.getText("DefaultSection.Title"),default:true,visualizations:[o]});}}S.visualizations.push(o);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(l){return l.getPage(p);}).catch(function(E){L.error("Pages - addBookmarkToPage: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(l){var m=l.payload.sections[S.id];m.layout.vizOrder.push(o.id);m.viz[o.id]=c.getVizRef(o);return this._conditionalSavePersonalization(p);}.bind(this));}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype._visitPages=function(v){return this._oCdmServicePromise.then(function(o){return o.getAllPages();}).then(function(p){p=p||[];p.forEach(function(o){v(o);});});};P.prototype._visitSections=function(v){return this._visitPages(function(p){var s=p.payload&&p.payload.sections||{};Object.keys(s).forEach(function(k){v(s[k],p);});});};P.prototype._visitVizReferences=function(v){return this._visitSections(function(s,p){var V=s.viz||{};Object.keys(V).forEach(function(k){v(V[k],s,p);});});};P.prototype._findBookmarks=function(i){var v=[];return this._oURLParsingServicePromise.then(function(U){var t=b.toTargetFromHash(i.url,U);t=c.harmonizeTarget(t);return this._visitVizReferences(function(V,s,p){if(V.isBookmark&&i.vizType===V.vizType&&b.isSameTarget(t,V.target)){v.push({vizRefId:V.id,sectionId:s.id,pageId:p.identification.id});}}).then(function(){return v;});}.bind(this));};P.prototype.countBookmarks=function(i){return this._findBookmarks(i).then(function(F){return F.length;});};P.prototype.deleteBookmarks=function(i,p,s){var D=0;return this._findBookmarks(i).then(function(v){return v.reduce(function(o,I){if(p&&I.pageId!==p){return o;}if(s&&I.sectionId!==s){return o;}return o.then(function(){return this.findVisualization(I.pageId,I.sectionId,null,I.vizRefId);}.bind(this)).then(function(l){var g=l[0];var h=this.getPageIndex(g.pageId);return this.deleteVisualization(h,g.sectionIndex,g.vizIndexes[0]);}.bind(this)).then(function(){D=D+1;}).catch(function(){});}.bind(this),Promise.resolve());}.bind(this)).then(function(){return D;});};P.prototype.updateBookmarks=function(i,p){if(!i||!i.url||typeof i.url!=="string"){L.error("Fail to update bookmark. No valid URL");return Promise.reject("Invalid URL provided");}if(!p||typeof p!=="object"){L.error("Fail to update bookmark. No valid parameters, URL is: "+i.url);return Promise.reject("Missing parameters");}var U=0;return Promise.all([this._oURLParsingServicePromise,this._findBookmarks(i)]).then(function(g){var o=g[0];var v=g[1];return v.reduce(function(h,I){return h.then(function(){return this.findVisualization(I.pageId,I.sectionId,null,I.vizRefId);}.bind(this)).then(function(l){var j=l[0];var k=this.getPageIndex(j.pageId);var V={subtitle:p.subtitle,icon:p.icon,info:p.info,numberUnit:p.numberUnit,indicatorDataSource:{path:p.serviceUrl,refresh:p.serviceRefreshInterval},vizConfig:p.vizConfig};if(p.title){V.title=p.title;}if(p.url){V.target=c.harmonizeTarget(b.toTargetFromHash(p.url,o));}return this.updateVisualization(k,j.sectionIndex,j.vizIndexes[0],V);}.bind(this)).then(function(){U=U+1;}).catch(function(){});}.bind(this),Promise.resolve());}.bind(this)).then(function(){return U;});};P.prototype.updateVisualization=function(p,s,S,v){var o=this._oPagesModel.getProperty("/pages/"+p);var g=o.sections[s];var h=g.visualizations;var U=h[S];var i={};this.setPersonalizationActive(true);return this._oCdmServicePromise.then(function(j){return Promise.all([j.getVisualizations(),j.getApplications(),j.getVizTypes(),this._oURLParsingServicePromise]);}.bind(this)).then(function(j){var V=j[0];var A=j[1];var k=j[2];var l=j[3];if(this._isPropertyChanged(U.title,v.title)){i.title=v.title;}if(v.target&&!b.isSameTarget(U.target,v.target)){i.target=v.target;}if(this._isPropertyChanged(U.subtitle,v.subtitle)){i.subtitle=v.subtitle;}if(this._isPropertyChanged(U.icon,v.icon)){i.icon=v.icon;}if(this._isPropertyChanged(U.info,v.info)){i.info=v.info;}if(this._isPropertyChanged(U.numberUnit,v.numberUnit)){i.numberUnit=v.numberUnit;}if(this._isPropertyChanged(U.displayFormatHint,v.displayFormatHint)){i.displayFormatHint=v.displayFormatHint;}if(v.indicatorDataSource&&(this._isPropertyChanged(U.indicatorDataSource.path,v.indicatorDataSource.path)||this._isPropertyChanged(U.indicatorDataSource.refresh,v.indicatorDataSource.refresh))){i.indicatorDataSource=d(U.indicatorDataSource);e(i.indicatorDataSource,v.indicatorDataSource);}if(v.vizConfig){U.vizConfig=a({},U.vizConfig,v.vizConfig);i.vizConfig=U.vizConfig;}e(U,i);var m=c.getVizRef(U);U=this._getVisualizationData(o.id,m.vizId,V,m,A,k,l);h[S]=U;this._oPagesModel.refresh();return this._updateVisualizationCDMData(o.id,g.id,U.id,i);}.bind(this));};P.prototype._updateVisualizationCDMData=function(p,s,v,U){return this._oCdmServicePromise.then(function(o){return o.getPage(p);}).catch(function(E){L.error("Pages - updateVisualization: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(o){var V=o.payload.sections[s].viz[v];var g=c.getVizRef(U);g.vizConfig=U.vizConfig;e(V,g);return this._conditionalSavePersonalization(o.identification.id);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype._isPropertyChanged=function(o,n){if((n||n==="")&&o!==n){return true;}return false;};P.hasNoAdapter=true;return P;},true);
