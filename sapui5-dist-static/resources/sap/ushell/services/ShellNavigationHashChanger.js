// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/ui/core/routing/HashChanger","sap/ui/thirdparty/hasher","sap/ushell/TechnicalParameters","sap/base/util/UriParameters","sap/base/util/isEmptyObject","sap/ui/thirdparty/jquery","sap/base/Log","sap/base/util/deepEqual"],function(l,H,h,T,U,a,q,L,d){"use strict";var N=l.NavigationState;var O={HASH_SET:{name:"hashSet",historyEntry:true},HASH_REPLACED:{name:"hashReplaced",historyEntry:false},SHELL_HASH_CHANGED:{name:"shellHashChanged",historyEntry:true,usedByUi5HistoryDetection:true,ui5EventParameterNames:{oldHash:"oldAppSpecificRouteNoSeparator",newHash:"newAppSpecificRouteNoSeparator"},updateHashOnly:true},SHELL_HASH_PARAMETER_CHANGED:{name:"shellHashParameterChanged",historyEntry:null},HASH_CHANGED:{name:"hashChanged",historyEntry:false,usedByUi5HistoryDetection:true,ui5EventParameterNames:{newHash:"newHash",fullHash:"fullHash"}}};var S=H.extend("sap.ushell.services.ShellNavigatonHashChanger",{constructor:function(c){var u;this.oServiceConfig=c;this._oNavigationState={};if(new U(window.location.href).get("sap-ushell-reload")){if(new U(window.location.href).get("sap-ushell-reload")==="X"||new U(window.location.href).get("sap-ushell-reload")==="true"){u=true;}else{u=false;}}if(u!==undefined){if(typeof this.oServiceConfig!=="object"){this.oServiceConfig={};}this.oServiceConfig.reload=u;}H.apply(this);this._initializedByShellNav=false;this.oURLShortening=sap.ushell.Container.getService("URLShortening");this.oURLParsing=sap.ushell.Container.getService("URLParsing");this.privfnShellCallback=null;this.privappHashPrefix="&/";this.privhashPrefix="#";this.aNavigationFilters=[];this.NavigationFilterStatus={Continue:"Continue",Custom:"Custom",Abandon:"Abandon",Keep:"Keep"};this.getRelevantEventsInfo=function(){return this._getAllEvents().filter(function(e){return e.usedByUi5HistoryDetection;}).map(function(e){var E={name:e.name,paramMapping:e.ui5EventParameterNames};if(e.updateHashOnly!==undefined){E.updateHashOnly=e.updateHashOnly;}return E;});};}});S.prototype.privgetCurrentShellHash=function(){var r=this.privsplitHash(h.getHash());return{hash:"#"+((r&&r.shellPart)?r.shellPart:"")};};S.prototype.privconstructHash=function(A){var o=this.privgetCurrentShellHash();o.hash+=A;return o;};S.prototype.privconstructShellHash=function(s){return this.oURLParsing.constructShellHash(s);};S.prototype.privsplitHash=function(s){var o,c,A;if(s===undefined||s===null||s===""){return{shellPart:null,appSpecificRoute:null,intent:null,params:null};}o=this.oURLParsing.parseShellHash(s);if(o===undefined||o===null){return null;}c=(o.params&&!a(o.params))?o.params:null;A=o.appSpecificRoute;o.appSpecificRoute=undefined;return{shellPart:this.privstripLeadingHash(this.privconstructShellHash(o))||null,appSpecificRoute:A||null,intent:(o.semanticObject&&o.action&&(o.semanticObject+"-"+o.action+(o.contextRaw||"")))||null,params:c};};S.prototype.privsetHash=function(f,A,w){h.prependHash="";f=this.privstripLeadingHash(f);A=A||"";if(w===undefined){w=true;}if(w){this.fireEvent(O.HASH_SET.name,{sHash:A});h.setHash(f);}else{this.fireEvent(O.HASH_REPLACED.name,{sHash:A});h.replaceHash(f);}};S.prototype.privstripLeadingHash=function(s){if(s[0]==="#"){return s.substring(1);}return s;};S.prototype.registerNavigationFilter=function(f){if(typeof f!=="function"){throw new Error("fnFilter must be a function");}this.aNavigationFilters.push(f);};S.prototype.unregisterNavigationFilter=function(f){if(typeof f!=="function"){throw new Error("fnFilter must be a function");}this.aNavigationFilters=this.aNavigationFilters.filter(function(r){return r!==f;});};function b(c,t){this.oAppState=undefined;this.oPromise=(new q.Deferred()).resolve();this.getNextKey=function(){this.oAppState=sap.ushell.Container.getService("AppState").createEmptyAppState(c,t);return this.oAppState.getKey();};this.store=function(v){var n;this.oAppState.setData(v);n=this.oAppState.save();this.oPromise=q.when(this.oPromise,n);};this.getPromise=function(){return this.oPromise;};}S.prototype.compactParams=function(p,r,c,t){var s,C,R,P,D=new q.Deferred(),e=this.oURLParsing.constructShellHash({target:{semanticObject:"SO",action:"action"},params:p},s);if(p===undefined||Object.keys(p).length===0){return D.resolve(p).promise();}s=new b(c,t);R=this.oURLShortening.compactHash(e,r,s);C=this.oURLParsing.parseParameters(R.hash.match(/\?.*/)[0]);P=s.getPromise();P.done(function(){D.resolve(C);}).fail(function(m){D.reject(m);});return D;};S.prototype.hrefForExternal=function(A,v,c,e){var r=this.hrefForExternalNoEnc(A,v,c,e);function f(R,v){if(v===true){R.hash=encodeURI(R.hash);}else{R=encodeURI(R);}return R;}if(!e){return f(r,v);}var D=new q.Deferred();r.done(function(R){D.resolve(f(R,v));}).fail(D.reject.bind(D));return D;};S.prototype.hrefForExternalNoEnc=function(A,v,c,e){var t,p,D,s=new b(c),r;t=this.privhrefForExternalNoEnc(A,s);if(v===true){r={hash:t.hash,params:t.params,skippedParams:t.skippedParams};}else{r=t.hash;}if(!e){return r;}p=s.getPromise();D=new q.Deferred();p.done(function(){D.resolve(r);}).fail(function(m){D.reject(m);});return D;};S.prototype.privhrefForExternalNoEnc=function(A,s){var r;if(A===undefined){return this.privgetCurrentShellHash();}if(A&&A.target&&(typeof A.target.semanticObject==="string"||typeof A.target.shellHash==="string")){r="#"+this.privconstructShellHash(A);return this.oURLShortening.compactHash(r,undefined,s);}return this.privgetCurrentShellHash();};S.prototype.privgetAppHash=function(A){var s,o;if(A&&A.target&&(typeof A.target.shellHash==="string")){o=this.oURLParsing.parseShellHash(A.target.shellHash);s=o&&o.appSpecificRoute;s=s&&s.substring(2);}return s;};S.prototype.hrefForAppSpecificHash=function(A){return encodeURI(this.privconstructHash(this.privappHashPrefix+A).hash);};S.prototype.toExternal=function(A,c,w){var s,o=new b(c),e;s=this.privhrefForExternalNoEnc(A,o).hash;e=this.privgetAppHash(A);this.privsetHash(s,e,w);};S.prototype.toAppHash=function(A,w){var s=this.privconstructHash(this.privappHashPrefix+A).hash;this.privsetHash(s,A,w);};S.prototype.initShellNavigation=function(s){if(this._initializedByShellNav){L.info("initShellNavigation already called on this ShellNavigationHashChanger instance.");return false;}this.privfnShellCallback=s;h.changed.add(this.treatHashChanged,this);if(!h.isActive()){h.initialized.addOnce(this.treatHashChanged,this);h.init();}else{this.treatHashChanged(h.getHash());}this._initializedByShellNav=true;return true;};S.prototype.init=function(){if(this._initialized){L.info("init already called on this ShellNavigationHashChanger instance.");return false;}var n=this.privsplitHash(h.getHash()),A=((n&&n.appSpecificRoute)||"  ").substring(2),D=A?"&/":"",s=(n&&n.shellPart)||"";this.fireEvent(O.HASH_CHANGED.name,{newHash:A,fullHash:s+D+A});this._initialized=true;return true;};S.prototype._removeInnerAppSeparator=function(i){return(i||"").replace("&/","");};S.prototype._setNavigationStatus=function(n){this._oNavigationState.status=n;};S.prototype._trackNavigation=function(o,n){this._oNavigationState.oldHash=o;this._oNavigationState.newHash=n;};S.prototype.getCurrentNavigationState=function(){return this._oNavigationState;};S.prototype.treatHashChanged=function(n,o){this._trackNavigation(o,n);this._setNavigationStatus(N.InProgress);if(this.inAbandonFlow){this._setNavigationStatus(N.Finished);return;}var A,s,c,f,g,j,E,i,F,k,m,p;n=this.oURLShortening.expandHash(n);o=this.oURLShortening.expandHash(o);c=this.privsplitHash(n);f=this.privsplitHash(o);if(!c){E=new Error("Illegal new hash - cannot be parsed: '"+n+"'");this.fireEvent(O.SHELL_HASH_CHANGED.name,{newShellHash:n,newAppSpecificRoute:null,fullHash:n,oldShellHash:(f?f.shellPart:o),error:E});this.privfnShellCallback(n,null,(f?f.shellPart:o),(f?f.appSpecificRoute:null),E);this._setNavigationStatus(N.Finished);return;}if(!f){f={shellPart:o,appSpecificRoute:null};}for(i=0;i<this.aNavigationFilters.length;i++){try{F=this.aNavigationFilters[i].call(undefined,n,o);k=F;if(typeof F!=="string"){k=F.status;m=F.hash;}if(k===this.NavigationFilterStatus.Custom){if(m&&m.length>0){this.inAbandonFlow=true;h.replaceHash(m);this.inAbandonFlow=false;}this._setNavigationStatus(N.Finished);return;}if(k===this.NavigationFilterStatus.Abandon){this.inAbandonFlow=true;h.replaceHash(o);this.inAbandonFlow=false;this._setNavigationStatus(N.Finished);return;}if(k===this.NavigationFilterStatus.Keep){p=true;}}catch(e){L.error("Error while calling Navigation filter! ignoring filter...",e.message,"sap.ushell.services.ShellNavigation");}}if(p){this.fireEvent(O.HASH_CHANGED.name,{newHash:n,oldHash:o,fullHash:n});this._setNavigationStatus(N.Finished);return;}var r=this.isInnerAppNavigation(n,o);if(r){A=this._removeInnerAppSeparator(c.appSpecificRoute);s=this._removeInnerAppSeparator(f.appSpecificRoute);L.info("Inner App Hash changed from '"+s+"' to '"+A+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent(O.HASH_CHANGED.name,{newHash:A,oldHash:s,fullHash:n});this._setNavigationStatus(N.Finished);return;}var t=this._haveSameIntent(n,o);if(t&&this.hasListeners(O.SHELL_HASH_PARAMETER_CHANGED.name)){g=this.oURLParsing.paramsToString(c.params);j=this.oURLParsing.paramsToString(f.params);L.info("Shell hash parameters changed from '"+j+"' to '"+g+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent(O.SHELL_HASH_PARAMETER_CHANGED.name,{oNewParameters:c.params,oOldParameters:f.params});this._setNavigationStatus(N.Finished);return;}if(o!==undefined&&this.oServiceConfig&&this.oServiceConfig.reload){window.location.hash="#"+encodeURI(n);window.location.reload();}L.info("Outer shell hash changed from '"+o+"' to '"+n+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent(O.SHELL_HASH_CHANGED.name,{newShellHash:c.shellPart,newAppSpecificRoute:c.appSpecificRoute,fullHash:n,oldShellHash:f.shellPart,oldAppSpecificRoute:f.appSpecificRoute,error:"",oldAppSpecificRouteNoSeparator:this._removeInnerAppSeparator(f.appSpecificRoute),newAppSpecificRouteNoSeparator:this._removeInnerAppSeparator(c.appSpecificRoute)});this.privfnShellCallback(c.shellPart,c.appSpecificRoute,f.shellPart,f.appSpecificRoute);this._setNavigationStatus(N.Finished);};S.prototype._parametersChanged=function(n,o){return!d(n,o);};S.prototype.setHash=function(s){this.toAppHash(s,true);};S.prototype.replaceHash=function(s){this.toAppHash(s,false);};S.prototype.getHash=function(){return this.getAppHash();};S.prototype.getAppHash=function(){var n=this.privsplitHash(h.getHash()),A=((n&&n.appSpecificRoute)||"  ").substring(2);return A;};S.prototype.destroy=function(){h.changed.remove(this.treatHashChanged,this);H.prototype.destroy.apply(this,arguments);};S.prototype._getAllEvents=function(){return Object.keys(O).map(function(e){return O[e];});};S.prototype.getReplaceHashEvents=function(){return this._getAllEvents().filter(function(e){return e.historyEntry===false;}).map(function(e){return e.name;});};S.prototype.getSetHashEvents=function(){return this._getAllEvents().filter(function(e){return e.historyEntry===true;}).map(function(e){return e.name;});};S.prototype.isInnerAppNavigation=function(n,o){var c=this.privsplitHash(n)||{};var e=this.privsplitHash(o)||{};var f=this._haveSameIntent(n,o);c.params=this._removeNonIntentParameters(c.params);e.params=this._removeNonIntentParameters(e.params);var g=!this._parametersChanged(c.params,e.params);return f&&g;};S.prototype._haveSameIntent=function(n,o){var c=this.privsplitHash(n)||{};var e=this.privsplitHash(o)||{};var s=c.intent;var f=e.intent;return s===f&&o!==undefined;};S.prototype._removeNonIntentParameters=function(o){var t=T.getParameters({isIntentParameter:false}),c;if(o){for(var i=0;i<t.length;i++){c=t[i];if(o[c.name]){delete o[c.name];}}}return o||{};};return S;},true);
