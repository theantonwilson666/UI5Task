// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/EventProvider","sap/base/Log","sap/ushell/utils","sap/ui/thirdparty/jquery","sap/base/util/deepEqual","sap/base/util/isEmptyObject"],function(E,L,u,q,d,a){"use strict";var e="valueStored";var s=["value","noEdit","noStore","extendedValue","alwaysAskPlugin"];function U(A,c,p,C){this._aPlugins=[];this._oUserDefaultParametersNames={};this._oWasParameterPersisted={};var t=this;var S=new E();function g(P){var v=(typeof P.getComponentData==="function"&&P.getComponentData()&&P.getComponentData().config&&P.getComponentData().config["sap-priority"])||0;if(typeof v!=="number"||isNaN(v)){return 0;}return v;}this._insertPluginOrdered=function(P,o){var b=g(o),i,f;for(i=0;(i<P.length)&&o;++i){f=g(P[i]);if(o&&(b>f)){P.splice(i,0,o);o=undefined;}}if(o){P.push(o);}return P;};this.registerPlugin=function(P){this._aPlugins=this._insertPluginOrdered(this._aPlugins,P);};this._getUserDefaultValueFromPlugin=function(P,b,o,v){var r;if(typeof P.getUserDefault==="function"){r=new Promise(function(f,h){P.getUserDefault(b,v,o).done(function(n){var R=n||v;f(R);}).fail(function(){L.error("invocation of getUserDefault(\""+b+"\") for plugin "+t._getComponentNameOfPlugin(P)+" rejected.",null,"sap.ushell.services.UserDefaultParameters");f(v);});});}else{r=Promise.resolve(v);}return r;};this._iterateOverPluginsToGetDefaultValue=function(P,o,b){var f=sap.ushell.Container.getService("PluginManager");return new Promise(function(r,h){f.loadPlugins("UserDefaults").done(function(){var i=this._aPlugins.reduce(function(j,k){var l=j.then(this._getUserDefaultValueFromPlugin.bind(null,k,P,b));return l;}.bind(this),Promise.resolve(o));i.then(r);}.bind(this)).fail(function(){L.error("Cannot get value for "+P+". One or more plugins could not be loaded.");h("Initialization of plugins failed");});}.bind(this));};this._getStoreDate=function(){return new Date().toString();};this._storeValue=function(P,v,f,o){if(f&&v.extendedValue){return sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(b){return new Promise(function(r){b.getUserDefaultParameterNames(o).done(function(h){var i=this._extractKeyArrays(h);var R=i.extended.indexOf(P)<0;this._saveParameterValue(P,v,f,R,o).then(r);}.bind(this)).fail(function(){this._saveParameterValue(P,v,f,false,o).then(r);}.bind(this));}.bind(this));}.bind(this));}return this._saveParameterValue(P,v,f,false,o);};this._saveParameterValue=function(P,v,f,r,o){if(r){v.extendedValue=undefined;}if(f&&this._valueIsEmpty(v)){v=undefined;this._oWasParameterPersisted[P]=false;}else{v._shellData=q.extend(true,{storeDate:this._getStoreDate()},v._shellData);}return sap.ushell.Container.getServiceAsync("UserDefaultParameterPersistence").then(function(b){return new Promise(function(h){b.saveParameterValue(P,v,o).always(function(){var i={parameterName:P,parameterValue:u.clone(v||{}),systemContext:o};S.fireEvent(e,i);h(P);});});});};this._getPersistedValue=function(P,o){return new Promise(function(r,b){sap.ushell.Container.getServiceAsync("UserDefaultParameterPersistence").then(function(f){f.loadParameterValue(P,o).done(r).fail(b);});});};this._valueIsEmpty=function(v){return!v||(!v.value&&!v.extendedValue);};this._haveSameMembersValue=function(o,O,m){return m.every(function(r){return o[r]===O[r]||d(o[r],O[r]);});};this._getUserDefaultParameterNames=function(b){if(!this._oUserDefaultParametersNames[b.id]){this._oUserDefaultParametersNames[b.id]=new q.Deferred();sap.ushell.Container.getService("ClientSideTargetResolution").getUserDefaultParameterNames(b).done(function(P){var o=this._extractKeyArrays(P);var f=o.extended;var h=o.allParameters;var m=this._arrayToObject(h);this._oUserDefaultParametersNames[b.id].resolve({aAllParameterNames:h,aExtendedParameterNames:f,oMetadataObject:m});}.bind(this));}return this._oUserDefaultParametersNames[b.id].promise();};this._isRelevantParameter=function(P,o){return new Promise(function(r,b){this._getUserDefaultParameterNames(o).done(function(R){if(R.aAllParameterNames&&R.aAllParameterNames.indexOf(P)!==-1){r();}else{b();}});}.bind(this));};this.hasRelevantMaintainableParameters=function(b){var h=false;var G=[];return new Promise(function(r){this._getUserDefaultParameterNames(b).done(function(P){if(!a(P)&&P.aAllParameterNames){P.aAllParameterNames.forEach(function(f){var o=this.getValue(f,b);G.push(o);o.done(function(v){if(v&&!v.hasOwnProperty("noEdit")){h=true;}});}.bind(this));q.when.apply(undefined,G).done(function(){r(h);}).fail(function(){r();});}else{r();}}.bind(this));}.bind(this));};this.getValue=function(P,o){var D=new q.Deferred();this._isRelevantParameter(P,o).then(function(){return this._getPersistedValue(P,o).then(function(b){this._oWasParameterPersisted[P]=true;return b||{};}.bind(this)).catch(function(){return{value:undefined};});}.bind(this)).then(function(b){var v=u.clone(b);var f=(!b._shellData&&this._valueIsEmpty(b))||b.noStore||b.alwaysAskPlugin;if(!f){D.resolve(b);return;}this._iterateOverPluginsToGetDefaultValue(P,b,o).then(function(n){if(!this._oWasParameterPersisted[P]||!this._haveSameMembersValue(v,n,s)){this._oWasParameterPersisted[P]=true;this._storeValue(P,n,false,o).then(function(){D.resolve(n);});}else{D.resolve(n);}}.bind(this)).catch(D.reject);}.bind(this)).catch(function(b){D.resolve({value:undefined});});return D.promise();};this._addParameterValuesToParameters=function(P,b,o){var D=new q.Deferred();var f=[];b.forEach(function(h){var G=this.getValue(h,o);f.push(G);G.done(function(v){P[h].valueObject=v;});}.bind(this));q.when.apply(q,f).done(D.resolve.bind(D,P)).fail(D.reject.bind(D,P));return D.promise();};this._arrayToObject=function(P){var r={};P.forEach(function(b){r[b]={};});return r;};this._getComponentNameOfPlugin=function(P){try{return P.getMetadata().getComponentName()||"";}catch(b){return"'name of plugin could not be determined'";}};this._getEditorDataAndValue=function(D,b,f,m,o){var t=this;var h=[];var r=[];this._aPlugins.forEach(function(P){if(typeof P.getEditorMetadata==="function"){var i=new q.Deferred();h.push(i);try{var j=h.length-1;P.getEditorMetadata(m,o).done(function(R){r[j]=R;}).always(i.resolve).fail(function(){L.error("EditorMetadata for plugin "+t._getComponentNameOfPlugin(P)+"cannot be invoked.",null,"sap.ushell.services.UserDefaultParameters");i.resolve();});}catch(k){L.error("Error invoking getEditorMetaData on plugin: "+k+k.stack,null,"sap.ushell.services.UserDefaultParameters");i.resolve();}}});q.when.apply(q,h).done(function(){var P=[];var i=r.reverse().reduce(function(j,n){b.forEach(function(k){if(n[k]&&n[k].editorMetadata){j[k].editorMetadata=n[k].editorMetadata;}});return j;},m);b.forEach(function(j){if(!(i[j]&&i[j].editorMetadata)){P.push(j);}});t._addParameterValuesToParameters(i,b,o).done(function(j){var k=q.extend(true,{},j),K;f.forEach(function(l){if(k[l]){k[l].editorMetadata=k[l].editorMetadata||{};k[l].editorMetadata.extendedUsage=true;}});K=Object.keys(k).splice(0);K.forEach(function(l){var n;if(k[l].valueObject&&k[l].valueObject.noEdit===true){delete k[l];n=P.indexOf(l);if(n>=0){P.splice(n,1);}}});if(P.length>0){L.error("The following parameter names have no editor metadata and thus likely no configured plugin:\n\""+P.join("\",\n\"")+"\".");}D.resolve(k);}).fail(D.reject.bind(D));});};this.editorGetParameters=function(o){var D=new q.Deferred();this._getUserDefaultParameterNames(o).done(function(P){if(P.oMetadataObject.length===0){D.resolve({});}else{sap.ushell.Container.getService("PluginManager").loadPlugins("UserDefaults").done(function(){this._getEditorDataAndValue(D,P.aAllParameterNames,P.aExtendedParameterNames,P.oMetadataObject,o);}.bind(this)).fail(function(){L.error("One or more plugins could not be loaded");D.reject("Initialization of plugins failed");});}}.bind(this));return D.promise();};this._extractKeyArrays=function(P){var r={simple:P&&P.simple&&Object.keys(P.simple).sort()||[],extended:P&&P.extended&&Object.keys(P.extended).sort()||[]};var o=r.extended.filter(function(b){return r.simple.indexOf(b)<0;});r.allParameters=r.simple.concat(o).sort();return r;};this.editorSetValue=function(P,v,o){var D=new q.Deferred();this._storeValue(P,v,true,o).then(D.resolve);return D.promise();};this.attachValueStored=function(f){S.attachEvent(e,f);};this.detachValueStored=function(f){S.detachEvent(e,f);};}U.hasNoAdapter=true;return U;},true);
