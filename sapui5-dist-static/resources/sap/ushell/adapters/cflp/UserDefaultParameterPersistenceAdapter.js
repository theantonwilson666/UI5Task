// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils/HttpClient","sap/ui/thirdparty/jquery","sap/base/Log","sap/base/util/ObjectPath"],function(H,q,L,O){"use strict";var U=function(s,p,c){this.sBaseServicePath="/sap/opu/odata/UI2/INTEROP/";this.oConfig={};if(c&&c.userBaseServicePath!==undefined){this.oConfig.sBaseServicePath=c.userBaseServicePath;}else{this.oConfig.sBaseServicePath=this.sBaseServicePath;}this.oConfig.oHttpClientConfig={"sap-language":sap.ushell.Container.getUser().getLanguage(),"sap-client":sap.ushell.Container.getLogonSystem().getClient(),"sap-statistics":true,headers:{Accept:"application/json"},data:{}};this._mSystems={};};U.prototype.loadParameterValue=function(p,s){var d=new q.Deferred();var i=this._isValidParameterName(p);if(i){this._getUserDefaultParameterContainer(s).done(function(c){var I=c.find(function(I){return I.id===p;});if(I!==undefined){var r=JSON.parse(I.value);d.resolve(r);}else{d.reject("Parameter does not exist: "+p);}}).fail(function(r){d.reject(r);});}else{d.reject("Illegal Parameter Key. Parameter must be less than 40 characters and [A-Za-z0-9.-_]+ :\""+p+"\"");}return d.promise();};U.prototype._createRequest=function(c){return{data:{PersContainerItems:c,appName:"",category:"P",component:"",id:"sap.ushell.UserDefaultParameter"},headers:{"content-type":"application/json",accept:"application/json"}};};U.prototype.saveParameterValue=function(p,v,s){var d=new q.Deferred();var i=this._isValidParameterName(p);if(i){var h=this._getXHttpWrapper(s);this._getUserDefaultParameterContainer(s).done(function(c){var I=c.findIndex(function(e){return e.id===p;});if(I>-1){c[I].value=JSON.stringify(v);}else{var u={category:"I",containerCategory:"P",containerId:"sap.ushell.UserDefaultParameter",id:p,value:JSON.stringify(v)};c.push(u);}h.post("PersContainers",this._createRequest(c)).then(d.resolve).catch(d.reject);}.bind(this)).fail(d.reject);}else{d.reject("Illegal Parameter Key. Parameter must be less than 40 characters and [A-Za-z0-9.-_]+ :\""+p+"\"");}return d.promise();};U.prototype.deleteParameter=function(p,s){var d=new q.Deferred();var i=this._isValidParameterName(p);if(i){var h=this._getXHttpWrapper(s);this._getUserDefaultParameterContainer(s).done(function(c){var I=c.findIndex(function(e){return e.id===p;});if(I>-1){c.splice(I,1);h.post("PersContainers",this._createRequest(c)).then(d.resolve).catch(d.reject);}else{d.resolve();}}.bind(this)).fail(d.reject);}else{d.reject("Illegal Parameter Key. Parameter must be less than 40 characters and [A-Za-z0-9.-_]+ :\""+p+"\"");}return d.promise();};U.prototype.getStoredParameterNames=function(s){var d=new q.Deferred();this._getUserDefaultParameterContainer(s).done(function(c){var k=c.map(function(i){return i.id;});k.sort();d.resolve(k);}).fail(function(e){d.reject(e);});return d.promise();};U.prototype._getXHttpWrapper=function(s){if(!this._mSystems[s.id]){this._mSystems[s.id]={};}if(!this._mSystems[s.id].oHttpWrapper){var b=s.getFullyQualifiedXhrUrl(this.oConfig.sBaseServicePath);this._mSystems[s.id].oHttpWrapper=new H(b,this.oConfig.oHttpClientConfig);}return this._mSystems[s.id].oHttpWrapper;};U.prototype._isValidParameterName=function(p){var i=!!(typeof p==="string"&&p.length<=40&&/^[A-Za-z0-9.-_]+$/.exec(p));if(!i){L.error("Illegal Parameter Key. Parameter must be less than 40 characters and [A-Za-z0-9.-_]+ :\""+p+"\"");}return i;};U.prototype._getUserDefaultParameterContainer=function(s){var d=new q.Deferred();var h;try{h=this._getXHttpWrapper(s);}catch(e){d.reject(e.message);return d.promise();}var S=this._mSystems[s.id];if(!S.oContainerCache){S.oContainerCache=d;var r=h.get("PersContainers(category='P',id='sap.ushell.UserDefaultParameter')?$expand=PersContainerItems");r.then(function(R){S.bDataReceived=true;var o=R.responseText?JSON.parse(R.responseText):{};var c=O.get("d.PersContainerItems.results",o)||[];S.oContainerCache.resolve(c);}).catch(function(R){if(R.status===404){S.oContainerCache.resolve([]);}else{var E="Server error: "+R.statusText;S.oContainerCache.reject(E);}});}return S.oContainerCache.promise();};return U;},true);
