// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_Personalization/constants","sap/ui/fl/apply/api/UI2PersonalizationApplyAPI","sap/base/Log","sap/ui/thirdparty/jquery"],function(c,U,L,q){"use strict";function r(C){var s="sap.ushell.personalization#";if(C.substring(0,s.length)!==s){L.error("Unexpected ContainerKey "+C);return C;}var k=C.substring(s.length);k=k.split("#")[0];return k;}A.prototype._determineCategory=function(s){if(!s){return"U";}if(s.keyCategory&&s.keyCategory===c.keyCategory.FIXED_KEY&&s.writeFrequency&&s.writeFrequency===c.writeFrequency.LOW&&s.clientStorageAllowed&&s.clientStorageAllowed===true){return"P";}return"U";};A.prototype.getMap=function(){return{category:this._category,service:this._oService,changedKeys:this._oChangedKeys,component:this._oComponent,deletedKeys:this._oDeletedKeys,container:this._aJSONContainer,scope:this._oScope,appName:this._sAppName,appVarId:this._sAppVarId,appVersion:this._sAppVersion,containerKey:this._sContainerKey};};function A(C,s,S,b){this._oService=s;this._oScope=S;this._sAppVarId=S.appVarId;this._sAppVersion=S.appVersion;this._oComponent=S.component;this._sContainerKey=r(C);this._sAppName=b||"";this._category=this._determineCategory(S);this._aJSONContainer=[];this._oChangedKeys={};this._oDeletedKeys={};}A.prototype._reset=function(){this._aJSONContainer=[];};A.prototype.load=function(){var d=new q.Deferred();sap.ui.getCore().loadLibraries(["sap/ui/fl"]).then(function(){return U.load({selector:this._oComponent,containerKey:this._sContainerKey});}.bind(this)).then(function(C){this._aJSONContainer=C||[];d.resolve(C);}.bind(this)).catch(function(e){L.warning(e);this._reset();d.reject(e);}.bind(this));return d.promise();};A.prototype.save=function(){var p=[];var d=new q.Deferred();sap.ui.require(["sap/ui/fl/write/api/UI2PersonalizationWriteAPI"],function(b){Object.keys(this._oChangedKeys).forEach(function(i){var I=this._oChangedKeys[i];var P=Object.assign({selector:this._oComponent},I);p.push(b.create(P));},this);Object.keys(this._oDeletedKeys).forEach(function(i){p.push(b.deletePersonalization({selector:this._oComponent,containerKey:this._sContainerKey,itemName:i}));},this);Promise.all(p).then(function(R){this._oChangedKeys={};this._oDeletedKeys={};d.resolve();}.bind(this),function(e){d.reject(e);});}.bind(this));return d.promise();};A.prototype.del=function(){var d=new q.Deferred();sap.ui.require(["sap/ui/fl/write/api/UI2PersonalizationWriteAPI"],function(b){this.load().then(function(){var p=[];this._aJSONContainer.forEach(function(i){p.push(b.deletePersonalization({selector:this._oComponent,containerKey:this._sContainerKey,itemName:i.itemName}));},this);Promise.all(p).then(function(R){d.resolve();},function(e){d.reject(e);});}.bind(this));}.bind(this));return d.promise();};A.prototype.getItemKeys=function(){var b=[];this._aJSONContainer.forEach(function(m){if(m.category==="V"){b.push("VARIANTSET#"+m.itemName);}else if(m.category==="I"){b.push("ITEM#"+m.itemName);}});return b;};A.prototype.containsItem=function(i){return this.getItemKeys().indexOf(i)>=0;};A.prototype._findItemIndex=function(I,C){var i;for(i=0;i<this._aJSONContainer.length;i=i+1){if(this._aJSONContainer[i].itemName===I&&this._aJSONContainer[i].category===C){return i;}}return undefined;};A.prototype._locateItem=function(i){var b={index:-1};if(i.indexOf("ITEM#")===0){b.trueItemKey=i.substring("ITEM#".length,"ITEM#".length+40);b.category="I";}else if(i.indexOf("VARIANTSET#")===0){b.trueItemKey=i.substring("VARIANTSET#".length,"VARIANTSET#".length+40);b.category="V";}else if(i.indexOf("ADMIN#")!==0){L.error("Unknown itemkey prefix"+i);}b.index=this._findItemIndex(b.trueItemKey,b.category);return b;};A.prototype.getItemValue=function(i){var I="",o,b=this._locateItem(i);if(b.index>=0){I=this._aJSONContainer[b.index].content;o=I;}return o;};A.prototype.setItemValue=function(i,I){var o=this._locateItem(i);var b;if(o.index>=0){b=this._aJSONContainer[o.index];b.content=I;}else{b={reference:this._sAppVarId,content:I,itemName:o.trueItemKey,category:o.category,containerKey:this._sContainerKey,containerCategory:this._category};this._aJSONContainer.push(b);}this._oChangedKeys[o.trueItemKey]=b;delete this._oDeletedKeys[o.trueItemKey];};A.prototype.delItem=function(i){var I=this._locateItem(i);if(I.index>=0){this._aJSONContainer.splice(I.index,1);this._oDeletedKeys[I.trueItemKey]=true;return;}};var a=function(){};a.prototype.getAdapterContainer=function(C,s,b){return new A(C,this,s,b);};a.prototype.delAdapterContainer=function(C,s){return this.getAdapterContainer(C,s).del();};return a;});
