// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_Personalization/constants","sap/ushell/services/_Personalization/constants.private","sap/ui/thirdparty/jquery","sap/base/Log"],function(s,i,q,L){"use strict";return{PersonalizationAdapter:P,getStorageResourceRoot:g,getContainerPath:c,delAdapterContainer:e,createContainerData:f,getAdapterContainer:A,getContainerCategory:h,isCategoryPContainer:k,trimContainerKey:t,save:l,load:m,del:n,clearContainerData:o,getItemKeys:u,containsItem:v,setItemValue:w,getItemValue:x,delItem:y,addPrefixToItemKey:p,stripPrefixFromItemKey:r,getHttpHeaderValue:z};function P(H,C,S,B,D){var E,F;var G={cache:{},headers:{"sap-client":S.getClient()}};D=D&&D.config;if(!D){throw new Error("PersonalizationAdapter: missing configuration.");}if(!C){C={};}E=g(D);F=new H(E,G);return{getAdapterContainer:A.bind(null,D,C,F),delAdapterContainer:e.bind(null,D,C,F)};}function g(C){var I=!C||!C.storageResourceRoot;if(I){throw new Error("Configuration error: storage resource root is not defined.");}return C.storageResourceRoot;}function a(C){var I=!C||!C.relativeUrlReadOptimized;if(I){throw new Error("Configuration error: relative URL for read optimization is not defined.");}return C.relativeUrlReadOptimized;}function b(C){var I=!C||!C.relativeUrlWriteOptimized;if(I){throw new Error("Configuration error: relative URL for write optimization is not defined.");}return C.relativeUrlWriteOptimized;}function c(C,S,B){return j(C,S)+"/"+encodeURIComponent(t(B))+".json";}function t(C){var B=i.S_CONTAINER_PREFIX,D,R;if(q.type(C)!=="string"||C.length===0){throw new Error("Personalization container key must be a non-empty string");}if(C.substring(0,B.length)===B){D=C.substring(B.length);}else{L.error("Unexpected personalization container key: "+C,"should always be prefixed with "+B,"sap.ushell.adapters.cdm.PersonalizationAdapter");D=C;}if(D.length<=40){R=D;}else{R=D.substring(0,40);L.error("Invalid personalization container key: '"+D+"'"+" exceeds maximum key length (40 characters) and is shortened to '"+R+"'",undefined,"sap.ushell.adapters.cdm.PersonalizationAdapter");}return R;}function d(){return{validity:Infinity,keyCategory:s.keyCategory.GENERATED_KEY,writeFrequency:s.writeFrequency.HIGH,clientStorageAllowed:false};}function e(C,B,H,D,S){var E=c(C,S,D);var F=B&&B[E];if(F){delete B[E];}return n(H,E);}function f(S,B){var C;if((!B&&B!=="")||B.constructor!==String){L.warning("Personalization container has an invalid app name; must be a non-empty string",null,"sap.ushell.adapters.cdm.PersonalizationAdapter");}if(!S){S=d();}C={items:{},__metadata:{appName:B,expiry:Date.now()+S.validity*60*1000,validity:S.validity,category:h(S)}};return C;}function A(C,B,H,D,S,E){var F,G,I=c(C,S,D);if(B&&B[I]){return B[I];}G=f(S,E);F=G.items;return{save:l.bind(null,H,G,I),load:m.bind(null,H,G,I),del:n.bind(null,H,G,I),setItemValue:w.bind(null,F),getItemValue:x.bind(null,F),getItemKeys:u.bind(null,F),containsItem:v.bind(null,F),delItem:y.bind(null,F)};}function h(S){return k(S)?"p":"u";}function j(C,S){return k(S)?a(C):b(C);}function k(S){return S&&S.keyCategory===s.keyCategory.FIXED_KEY&&S.writeFrequency===s.writeFrequency.LOW&&S.clientStorageAllowed;}function l(H,C,B){return new q.Deferred(function(D){H.put(B,{data:C}).then(function(R){D.resolve();}).catch(function(R){L.error("Failed to save personalization container; response: "+(typeof R==="object"?JSON.stringify(R):R),R.stack?R.stack:null,"sap.ushell.adapters.cdm.PersonalizationAdapter");D.reject(R);});}).promise();}function m(H,C,B){function D(C){o(C.items);}return new q.Deferred(function(E){H.get(B).then(function(R){var F,G;if(R.status===200&&z(R.responseHeaders,"content-length")==="0"&&z(R.responseHeaders,"content-type").indexOf("text/plain")===0){D(C);}else{F=JSON.parse(R.responseText);if(F.data){F.items=F.data;delete F.data;F.__metadata=C.__metadata;}G=F.items;o(C.items);Object.keys(G).forEach(function(I){C.items[I]=G[I];});C.__metadata=F.__metadata;}E.resolve();}).catch(function(R){if(R.status===404){D(C);E.resolve();}else{o(C.items);E.reject(R);}});}).promise();}function n(H,B){return new q.Deferred(function(D){H.delete(B).then(function(){D.resolve();}).catch(function(R){D.reject(R);});}).promise();}function o(C){Object.keys(C).forEach(function(K){delete C[K];});}function p(K){if(K==="__metadata"){return undefined;}else if(K.indexOf(i.S_VARIANT_PREFIX)===0||K.indexOf(i.S_ADMIN_PREFIX)===0){return K;}return i.S_ITEM_PREFIX+K;}function r(K){if(K.indexOf(i.S_ITEM_PREFIX)===0){return K.substring(i.S_ITEM_PREFIX.length);}else if(K.indexOf(i.S_VARIANT_PREFIX)===0||K.indexOf(i.S_ADMIN_PREFIX)===0){return K;}throw new Error("Illegal item key for personalization container: '"+K+"'; must be prefixed with one of the following: ["+i.S_ITEM_PREFIX+", "+i.S_VARIANT_PREFIX+", "+i.S_ADMIN_PREFIX+"] ");}function u(C){return Object.keys(C).map(p).filter(function(K){return!!K;});}function v(C,K){return C.hasOwnProperty(r(K));}function w(C,K,V){C[r(K)]=V;}function x(C,K){return C[r(K)];}function y(C,K){delete C[r(K)];}function z(H,N){var M=H&&H.filter(function(B){return B.name.toLowerCase()===N;});return M&&M[0]&&M[0].value;}});
