// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/v3/_LaunchPage/readHome","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/m/GenericTile","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/adapters/cdm/v3/utilsCdm","sap/base/util/Version","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/util/deepExtend","sap/base/util/deepClone","sap/base/Log"],function(r,R,a,G,C,u,b,e,n,o,U,c,V,q,i,d,O,f,g,L){"use strict";var l=L.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter");var h=L.Level;var S="sap.ushell.components.tiles.cdm.applauncher";var D="sap.ushell.components.tiles.cdm.applauncherdynamic";function A(j,p,k){this.oAdapterConfiguration=k;this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};this.TileType={Tile:"tile",Link:"link",Card:"card"};}A.prototype.getGroups=function(){var j=new q.Deferred();this._ensureLoaded().done(function(k){U.setPerformanceMark("FLP - homepage groups processed");j.resolve(k);}).fail(function(){j.resolve([]);});return j.promise();};A.prototype._ensureLoaded=function(){var t=this,j;if(this._ensureLoadedDeferred){return this._ensureLoadedDeferred.promise();}j=new q.Deferred();this._ensureLoadedDeferred=j;this._getSiteData().done(function(s){if(!t.isSiteSupported(s)){throw new Error("Invalid CDM site version: Check the configuration of the launchpage adapter and the version of the FLP site");}var I=[];var k=r.getGroupsArrayFromSite(s);k=t._addDefaultGroup(k,s);k.forEach(function(m){I=t._ensureGroupItemsResolved(m,s).concat(I);});t._allPromisesDone(I).done(function(){t._ensureLoadedDeferred.resolve(k);delete t._ensureLoadedDeferred;t._logTileResolutionFailures(t._mFailedResolvedTiles);});}).fail(function(E){l.error("Delivering hompage groups failed - "+E);t._ensureLoadedDeferred.resolve([]);delete t._ensureLoadedDeferred;});return j.promise();};A.prototype._ensureGroupItemsResolved=function(j,s){var p=[],k,m;if(j.payload&&j.payload.tiles){k=this._ensureGroupTilesResolved(j.payload.tiles,s);Array.prototype.push.apply(p,k);}if(j.payload&&j.payload.links){m=this._ensureGroupLinksResolved(j.payload.links,s);Array.prototype.push.apply(p,m);}return p;};A.prototype._ensureGroupTilesResolved=function(j,s){return(j||[]).map(function(t,I){return this._resolveGroupTile(t,s).then(function(k){k.isLink=false;return k;});},this);};A.prototype._ensureGroupLinksResolved=function(j,s){return(j||[]).map(function(k){return this._resolveGroupTile(k,s).then(function(m){m.isLink=true;return m;});},this);};A.prototype._resolveGroupTile=function(t,s){var m=this._mResolvedTiles;var F=this._mFailedResolvedTiles;var j;function k(w){m[t.id]=w;if(F[t.id]){delete F[t.id];}return w;}function p(t){var T=t.target;return T&&T.semanticObject==="Shell"&&T.action==="launchURL";}if(m[t.id]){return(new q.Deferred()).resolve(m[t.id]).promise();}if(t.target&&t.target.url){j=q.when(this._getTileForUrl(t));}else if(t.isBookmark&&t.vizType===undefined){j=this._resolveTileByIntent(t,s);}else if(p(t)){j=this._resolveTileByIntent(t,s);}else{j=this._resolveTileByVizId(t,s);}var v=new q.Deferred();j.done(function(w){v.resolve(k(w));}).fail(function(w){F[t.id]=w;v.reject(w);});return v.promise();};A.prototype._resolveTileByVizId=function(t,s){var v,j,k,m,p,w,I,M,N,x,H,y,E;function z(Q,T){return new q.Deferred().reject({logLevel:Q,message:T}).promise();}var B=new q.Deferred();if(!i(s)){return z(h.ERROR,"Cannot resolve tile: oSite must be an object");}if(!i(t)){return z(h.ERROR,"Cannot resolve tile: oTile must be an object");}j=t.vizId;v=g(R.get(s,j||"")||{});m=t.vizType||R.getTypeId(v);k=R.getType(s,m);if(!k){return z(h.ERROR,"Cannot resolve tile '"+t.id+"': no visualization type found for vizTypeId '"+m+"'");}p=R.getAppId(v);if(p){w=R.getAppDescriptor(s,p);if(!w){return z(h.INFO,"Tile '"+t.id+"' filtered from result: no app descriptor found for appId '"+p+"' (dangling app reference)");}I=r.getInbound(w,R.getTarget(v).inboundId);if(!I){return z(h.ERROR,"Cannot resolve tile '"+t.id+"': app '"+p+"' has no navigation inbound");}M=c.mapOne(I.key,I.inbound,w,v,k,s);var F=M.resolutionResult.applicationType,J=M.resolutionResult.additionalInformation,K=b.last("/core/navigation/enableInPlaceForClassicUIs"),P=K?K[F]:false;N=n.computeNavigationModeForHomepageTiles(F,J,P);y=R.getOutbound(v,I.inbound);H=this._toHashFromOutbound(y);}else{v.vizConfig=f({},v.vizConfig,t.vizConfig);M=c.mapOne(undefined,undefined,undefined,v,k,s);if(R.startsExternalUrl(v)){E=U.getMember(v.vizConfig,"sap|flp.target.url");}}x=M.tileResolutionResult;x.navigationMode=N;x.isLink=false;if(!this._isFormFactorSupported(x)){return z(h.INFO,"Tile '"+t.id+"' filtered from result: form factor not supported");}if(E||H){B.resolve({tileResolutionResult:x,tileIntent:E||H});}else{if(!this._oUrlParsingPromise){this._oUrlParsingPromise=sap.ushell.Container.getServiceAsync("URLParsing");}this._oUrlParsingPromise.then(function(Q){if(t.target){var T=g(t.target);H=c.toHashFromTarget(a.harmonizeTarget(T),Q);}B.resolve({tileResolutionResult:x,tileIntent:H});});}return B.promise();};A.prototype._isFormFactorSupported=function(j){var s=U.getFormFactor();return r.supportsFormFactor(j,s);};A.prototype._getFirstInbound=function(j){var F=Object.keys(j["sap.app"].crossNavigation.inbounds).shift(),I=j["sap.app"].crossNavigation.inbounds[F];return{key:F,inbound:I};};A.prototype._resolveTileByIntent=function(t){var H=this._prepareTileHash(t);return this._getTileFromHash(H);};A.prototype._allPromisesDone=function(p){var j=new q.Deferred(),k;if(p.length===0){j.resolve([]);}else{var N=p.map(function(P){k=new q.Deferred();P.always(k.resolve.bind(k));return k.promise();});q.when.apply(this,N).done(function(){var m=Array.prototype.slice.call(arguments);j.resolve(m);});}return j.promise();};A.prototype._logTileResolutionFailures=function(F){var m={};if(!F){return;}Object.keys(h).filter(function(s){var j=h[s];return j>=h.FATAL&&j<=h.ALL;}).forEach(function(s){m[h[s]]="";});Object.keys(F).forEach(function(s){var j=F[s];if(j.logLevel){m[j.logLevel]=m[j.logLevel].concat(j.message).concat("\n");}});if(m[h.FATAL]){l.fatal(m[h.FATAL]);}if(m[h.ERROR]){l.error(m[h.ERROR]);}if(m[h.WARNING]){l.warning(m[h.WARNING]);}if(m[h.INFO]){l.info(m[h.INFO]);}if(m[h.DEBUG]){l.debug(m[h.DEBUG]);}if(m[h.TRACE]){l.trace(m[h.TRACE]);}};A.prototype._isValidTitle=function(t){return typeof t==="string"&&t;};A.prototype._isGroupPreset=function(j){return r.isGroupPreset(j);};A.prototype._isGroupLocked=function(j){return r.isGroupLocked(j);};A.prototype.getGroupTitle=function(j){return r.getGroupTitle(j);};A.prototype.getGroupId=function(j){return r.getGroupId(j);};A.prototype.isGroupVisible=function(j){return r.isGroupVisible(j);};A.prototype.getTileTitle=function(t){return r.getTileTitle(this._mResolvedTiles,t);};A.prototype.getTileSubtitle=function(t){return r.getTileSubtitle(this._mResolvedTiles,t);};A.prototype.getTileIcon=function(t){return r.getTileIcon(this._mResolvedTiles,t);};A.prototype.getTileInfo=function(t){return r.getTileInfo(this._mResolvedTiles,t);};A.prototype.getTileIndicatorDataSource=function(t){var j=this._mResolvedTiles[t.id],k={},m;if(t.indicatorDataSource){k.indicatorDataSource=U.clone(t.indicatorDataSource);if(t.dataSource){k.dataSource=U.clone(t.dataSource);}return k;}if(!j){return k;}m=j.tileResolutionResult;if(m.indicatorDataSource){k.indicatorDataSource=U.clone(m.indicatorDataSource);if(m.indicatorDataSource.hasOwnProperty("dataSource")){var s=m.indicatorDataSource.dataSource,p=m.dataSources;if(p&&p.hasOwnProperty(s)){k.dataSource=U.clone(p[s]);}else{L.warning("datasource referenced but not found for tile: "+j.tileIntent);}}if(U.getMember(m,"runtimeInformation.componentProperties.url")){var P=U.getMember(k,"indicatorDataSource.path");var v=U.getMember(k,"dataSource.uri");var w=U.getMember(m,"runtimeInformation.componentProperties.url");var T=u(P,v,w,this.getWindowLocationHref());if(!T.error){if(P){k.indicatorDataSource.path=T.uri;}if(v){k.dataSource.uri=T.uriParent;}}}}return k;};A.prototype.getWindowLocationHref=function(){return window.location.href;};A.prototype.isGroupRemovable=function(j){return!this._isGroupPreset(j);};A.prototype.isGroupLocked=function(j){return this._isGroupLocked(j);};A.prototype.getGroupTiles=function(j){return r.getGroupTiles(j).concat(r.getGroupLinks(j));};A.prototype.getTileType=function(I){if(r.isLink(this._mResolvedTiles,I)){return this.TileType.Link;}if(r.isCard(this._mResolvedTiles,I)){return this.TileType.Card;}return this.TileType.Tile;};A.prototype.getTileId=function(t){return r.getTileId(t);};A.prototype.getTileSize=function(t){return r.getTileSize(this._mResolvedTiles,t)||"1x1";};A.prototype.getTileTarget=function(t){var T=r.getTileId(t),j=this._mResolvedTiles[T];if(t.target&&t.target.url){return t.target.url;}if(j){return j.tileIntent;}L.warning("Could not find a target for Tile with id '"+T+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return"";};A.prototype.isTileIntentSupported=function(t){return(this._mFailedResolvedTiles[t.id]===undefined);};A.prototype.setTileVisible=function(t,N){var j=this._mResolvedTiles[t.id];if(j){if(j.tileComponent){this._notifyTileAboutVisibility(j.tileComponent,N,j.visibility);}j.visibility=N;}};A.prototype.getCardManifest=function(j){var k,m=this._mResolvedTiles[j.id];k=m.tileResolutionResult;return k.tileComponentLoadInfo;};A.prototype._getTileUiComponentContainerSync=function(t,j,I){var k=this,m,T,N,p,s={};if(I===true){T=k._createTileComponentData(t,true,j);}else{T=k._createTileComponentData(t,false,j);}m=j.tileResolutionResult;if(j.isLink){N=m.navigationMode;return k._createLinkInstance(t,I,N,G,o);}if(typeof m.tileComponentLoadInfo==="object"&&m.tileComponentLoadInfo!==null){s=m.tileComponentLoadInfo.componentProperties||{};s.name=m.tileComponentLoadInfo.componentName;}s.componentData=T;if(s.manifest){s.componentData.properties=s.componentData.properties||{};s.componentData.properties.manifest=s.manifest;}if(s.name){s.async=false;var v;try{p=sap.ui.component(s);}catch(E){L.error(E.message+"\n-- An error occurred while instantiating "+"the tile component for "+s.name,E.stack?E.stack:"","sap.ushell.adapters.cdm.LaunchPageAdapter");return null;}v=new sap.ui.core.ComponentContainer({component:p,height:"100%"});if(!I){k._mResolvedTiles[t.id].tileComponent=p;}return v;}return null;};A.prototype._getTileUiComponentContainer=function(t,j,I){var k=this,m,T,N,p,s,v,w=new q.Deferred();var x=sap.ushell.Container.getService("Ui5ComponentLoader");if(I===true){T=k._createTileComponentData(t,true,j);}else{T=k._createTileComponentData(t,false,j);}m=j.tileResolutionResult;if(j.isLink){N=m.navigationMode;w.resolve(k._createLinkInstance(t,I,N,G,o));return w.promise();}var y=this._createTileComponentProperties(T,m.tileComponentLoadInfo);if(!y.name){return w.reject("Cannot find name of tile component for tile with id: '"+t.id+"'").promise();}if(y.manifest){T.properties=T.properties||{};T.properties.manifest=y.manifest;}v=this._isCustomTileComponent(y.name);var z=function(B){var j;p=B.componentHandle.getInstance();s=new C({component:p,height:"100%"});if(!I){j=k._mResolvedTiles[t.id];j.tileComponent=p;if(typeof j.visibility==="boolean"){k._notifyTileAboutVisibility(p,j.visibility);}}return s;};var _=function(){return x.createComponent({loadCoreExt:v,loadDefaultDependencies:false,componentData:T,url:y.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:y,ui5ComponentName:y.name},{},[]).then(z);};if(v){e.once("CoreResourcesComplementLoaded").do(function(){_().then(function(s){w.resolve(s);}).fail(function(E){w.reject(E);});});}else{_().then(function(s){w.resolve(s);}).fail(function(E){w.reject(E);});}return w.promise();};A.prototype._createTileComponentProperties=function(t,T){var j={};if(!T||d(T)){if(t.properties.indicatorDataSource&&t.properties.indicatorDataSource.path){j.name=D;}else{j.name=S;}}else{j=T.componentProperties||{};j.name=T.componentName;}return j;};A.prototype.getTileView=function(j){var t=this;return new q.Deferred(function(k){return t._getTileView(j,false).then(function(T){k.resolve(T);},function(s){var E="Tile with ID '"+j.id+"' could not be initialized"+(s?":\n"+s:".");L.error(E,null,j.tileType);k.reject(E);});}).promise();};A.prototype._getTileView=function(j){var k,E,m=new q.Deferred();if(typeof j!=="object"||!j.id){E="Invalid input parameter passed to _getTileView: "+j;L.error(E);return m.reject(E).promise();}k=this._mResolvedTiles[j.id];if(!k){E="No resolved tile found for tile ID: "+j.id;L.error(E);return m.reject(E).promise();}return this._getTileUiComponentContainer(j,k,false);};A.prototype._createTileComponentData=function(t,I,j){var T=I?this.getCatalogTileTitle(t):this.getTileTitle(t),s=I?this.getCatalogTilePreviewSubtitle(t):this.getTileSubtitle(t),k=I?this.getCatalogTilePreviewIcon(t):this.getTileIcon(t),m=I?this.getCatalogTilePreviewInfo(t):this.getTileInfo(t),p=I?this.getCatalogTileTargetURL(t):this.getTileTarget(t),v=this.getTileIndicatorDataSource(t),N=t.numberUnit||j.tileResolutionResult.numberUnit,w={properties:{},startupParameters:{}};if(j.tileResolutionResult.isCustomTile===true&&j.tileResolutionResult.startupParameters){w.startupParameters=j.tileResolutionResult.startupParameters;}if(T){w.properties.title=T;}if(m){w.properties.info=m;}if(s){w.properties.subtitle=s;}if(k){w.properties.icon=k;}if(p){w.properties.targetURL=p;}if(N){w.properties.numberUnit=N;}if(v.indicatorDataSource){w.properties.indicatorDataSource=v.indicatorDataSource;if(v.dataSource){w.properties.dataSource=v.dataSource;}}if(j.tileResolutionResult){w.properties.navigationMode=j.tileResolutionResult.navigationMode;w.properties.contentProviderId=j.tileResolutionResult.contentProviderId||"";}return w;};A.prototype._isGroupTile=function(t){return r.isGroupTile(t);};A.prototype._isCatalogTile=function(t){return!!(t&&t.isCatalogTile);};A.prototype._isFailedGroupTile=function(t){return!!(t&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[r.getTileId(t)]);};A.prototype.getCatalogTileId=function(j){if(this._isGroupTile(j)){if(this._isFailedGroupTile(j)){return undefined;}if(j.isBookmark&&O.get("target.url",j)){return j.target.url;}return j.vizId||(j.target&&j.target.url);}if(this._isCatalogTile(j)){return j.id;}return undefined;};A.prototype.getCatalogTilePreviewTitle=function(j){if(this._isGroupTile(j)){return this.getTileTitle(j);}return(j.tileResolutionResult&&j.tileResolutionResult.title)||"";};A.prototype.getCatalogTileTargetURL=function(j){if(!j){throw new Error("The given tile is falsy");}if(this._isCatalogTile(j)){if(j.tileResolutionResult&&j.tileResolutionResult.isCustomTile){if(!j.tileResolutionResult.targetOutbound){return"";}return this._toHashFromOutbound(j.tileResolutionResult.targetOutbound);}return j.tileIntent||"";}return this.getTileTarget(j);};A.prototype.isGroupFeatured=function(j){return!!j.isFeatured;};A.prototype._getMember=function(j,s){return U.getMember(j,s);};A.prototype.getCdmVersionsSupported=function(){return{min:V("3.0.0"),max:V("3.1.0")};};A.prototype.isSiteSupported=function(s){if(!s._version||V(s._version).compareTo(this.getCdmVersionsSupported().min)<0||V(s._version).compareTo(this.getCdmVersionsSupported().max)>0){L.fatal("Invalid CDM site version: Only version 3.0.0 is supported");return false;}return true;};A.prototype._isCustomTileComponent=function(s){return!(s===S||s===D);};return A;},true);
