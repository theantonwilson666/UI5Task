// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/_LaunchPage/readHome","sap/ushell/adapters/cdm/_LaunchPage/modifyHome","sap/ushell/adapters/cdm/_LaunchPage/readCatalogs","sap/m/GenericTile","sap/m/library","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/utils/utilsCdm","sap/ushell/utils/WindowUtils","sap/ushell/components/tiles/utilsRT","sap/base/util/Version","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/Log"],function(r,m,R,G,M,C,u,a,E,n,o,U,b,W,c,V,J,q,i,d,O,L){"use strict";var l=L.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter"),f=L.Level;var g=M.GenericTileMode;function h(j,p,A){var _,s="sap.ushell.components.tiles.cdm.applauncher",D="sap.ushell.components.tiles.cdm.applauncherdynamic";this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};this.getCdmVersionsSupported=function(){return{min:V("0"),max:V("2.0.0")};};this.isSiteSupported=function(S){if(!!S._version&&V(S._version).compareTo(this.getCdmVersionsSupported().max)>0){L.fatal("Invalid CDM site version: Only sites up to version 2.0.0 are supported");return false;}return true;};this.TileType={Tile:"tile",Link:"link"};this.getGroups=function(){var e=new q.Deferred();this._assureLoaded().done(function(I){U.setPerformanceMark("FLP - homepage groups processed");e.resolve(I);}).fail(function(){e.resolve([]);});return e.promise();};this._getTileFromHashInContextOfSite=function(e,I,K){var N=new q.Deferred(),P=I[K];if(!P){P=e(K);I[K]=P;}P.done(function(T){var Q={tileIntent:K,tileResolutionResult:T};N.resolve(Q);}).fail(function(Q){N.reject("Hash '"+K+"' could not be resolved to a tile. "+Q);});return N.promise();};this._getTileFromHash=function(I){var e=sap.ushell.Container.getService("ClientSideTargetResolution");var K=e.resolveTileIntent.bind(e);return this._getTileFromHashInContextOfSite(K,this._mCatalogTilePromises,I);};this._getTileFromHashFromSite=function(S,I){var e=sap.ushell.Container.getService("ClientSideTargetResolution");var K=b.formatSite(S);var N=e.resolveTileIntentInContext.bind(e,K);var P={};return this._getTileFromHashInContextOfSite(N,P,I);};this._getTileForUrl=function(T){var e=T.indicatorDataSource?"#Shell-dynamicTile":"#Shell-staticTile";return{tileIntent:"#",tileResolutionResult:{tileComponentLoadInfo:e,isCustomTile:false}};};this._assureGroupItemsResolved=function(e,S){var P=[],I,K;if(e.payload&&e.payload.tiles){I=this._assureGroupTilesResolved(e.payload.tiles,S);Array.prototype.push.apply(P,I);}if(e.payload&&e.payload.links){K=this._assureGroupLinksResolved(e.payload.links,S);Array.prototype.push.apply(P,K);}return P;};this._assureGroupTilesResolved=function(e,S){return(e||[]).map(function(T,I){return this._resolveGroupTile(T,S).then(function(K){K.isLink=false;return K;});},this);};this._assureGroupLinksResolved=function(e,S){return(e||[]).map(function(I){return this._resolveGroupTile(I,S).then(function(K){K.isLink=true;return K;});},this);};this._resolveGroupTile=function(T,S){var e=this._mResolvedTiles;var I=this._mFailedResolvedTiles;var K;function N(Q){e[T.id]=Q;if(I[T.id]){delete I[T.id];}return Q;}function P(T){var Q=T.target;return Q&&Q.semanticObject==="Shell"&&Q.action==="launchURL";}if(e[T.id]){return(new q.Deferred()).resolve(e[T.id]).promise();}if(T.target&&T.target.url){K=q.when(this._getTileForUrl(T));}else if(T.isBookmark){K=this._resolveTileByIntent(T,S);}else if(P(T)){K=this._resolveTileByIntent(T,S);}else{K=this._resolveTileByAppId(T,S);}K.done(function(Q){N(Q);}).fail(function(Q){I[T.id]=Q;});return K;};this._resolveTileByAppId=function(T,S){var e,I,K,N,P;function Q(b1,c1){return new q.Deferred().reject({logLevel:b1,message:c1}).promise();}if(!i(T)){return Q(f.ERROR,"Cannot resolve tile: oTile must be an object");}if(!i(S)){return Q(f.ERROR,"Cannot resolve tile: oSite must be an object");}e=T.appId||T.appIDHint;if(!e){return Q(f.ERROR,["Cannot resolve tile '",T.id,"': either appId or appIDHint must be specified"].join(""));}I=S.applications&&S.applications[e];if(!I){return Q(f.INFO,["Tile '",T.id,"' filtered from result: no app found for appId '",e,"' (dangling app reference)"].join(""));}K=this._getFirstInbound(I);if(!K){return Q(f.ERROR,["Cannot resolve tile '",T.id,"': app '",e,"' has no navigation inbound"].join(""));}var X=b.mapOne(K.key,K.inbound,I),Y=X.resolutionResult.applicationType,Z=X.resolutionResult.additionalInformation,$=a.last("/core/navigation/enableInPlaceForClassicUIs"),a1=$?$[Y]:false;N=X.tileResolutionResult;N.navigationMode=n.computeNavigationModeForHomepageTiles(Y,Z,a1);N.isLink=false;if(!this._isFormFactorSupported(N)){return Q(f.INFO,["Tile '",T.id,"' filtered from result: form factor not supported"].join(""));}P=this._toHashFromInbound(K.inbound);return q.when({tileResolutionResult:N,tileIntent:P});};this._isFormFactorSupported=function(e){var I=U.getFormFactor();return r.supportsFormFactor(e,I);};this._getFirstInbound=function(e){var I=Object.keys(e["sap.app"].crossNavigation.inbounds).shift(),K=e["sap.app"].crossNavigation.inbounds[I];return{key:I,inbound:K};};this._resolveTileByIntent=function(T,S){var e=this._prepareTileHash(T);return this._getTileFromHash(e);};this._prepareTileHash=function(T){var e=sap.ushell.Container.getService("URLParsing"),P={},I,K;if(this._isCatalogTile(T)){return T.tileIntent;}if(this._isGroupTile(T)&&T.target){K=T.target.parameters||[];K.forEach(function(N){if(N.name&&N.value){P[N.name]=[N.value];}});I={target:{semanticObject:T.target.semanticObject,action:T.target.action},params:P,appSpecificRoute:T.target.appSpecificRoute};return"#"+e.constructShellHash(I);}return undefined;};this._allPromisesDone=function(P){var e=new q.Deferred(),I;if(P.length===0){e.resolve([]);}else{var N=P.map(function(K){I=new q.Deferred();K.always(I.resolve.bind(I));return I.promise();});q.when.apply(this,N).done(function(){var K=Array.prototype.slice.call(arguments);e.resolve(K);});}return e.promise();};this._assureLoaded=function(){var e=this,I=sap.ushell.Container.getService("CommonDataModel"),K;if(this._assureLoadedDeferred){return this._assureLoadedDeferred.promise();}K=new q.Deferred();this._assureLoadedDeferred=K;I.getSite().done(function(S){if(!e.isSiteSupported(S)){throw new Error("Invalid CDM site version: Check configuration of launchpage adapter and version of FLP site");}var N=[];var P=r.getGroupsArrayFromSite(S);var Q=r.getDefaultGroup(P);if(!Q){Q=m.createDefaultGroup(U.generateUniqueId(r.getGroupIdsFromSite(S)));S=m.addGroupToSite(S,Q,0);P=r.getGroupsArrayFromSite(S);}_=Q;P.forEach(function(T){N=e._assureGroupItemsResolved(T,S).concat(N);});e._allPromisesDone(N).done(function(){e._assureLoadedDeferred.resolve(P);delete e._assureLoadedDeferred;e._logTileResolutionFailures(e._mFailedResolvedTiles);});}).fail(function(N){L.error("Delivering hompage groups failed - "+N);e._assureLoadedDeferred.resolve([]);delete e._assureLoadedDeferred;});return K.promise();};this._logTileResolutionFailures=function(e){var I={};if(!e){return;}Object.keys(f).filter(function(K){var N=f[K];return N>=f.FATAL&&N<=f.ALL;}).forEach(function(K){I[f[K]]="";});Object.keys(e).forEach(function(K){var N=e[K];if(N.logLevel){I[N.logLevel]=I[N.logLevel].concat(N.message).concat("\n");}});if(I[f.FATAL]){l.fatal(I[f.FATAL]);}if(I[f.ERROR]){l.error(I[f.ERROR]);}if(I[f.WARNING]){l.warning(I[f.WARNING]);}if(I[f.INFO]){l.info(I[f.INFO]);}if(I[f.DEBUG]){l.debug(I[f.DEBUG]);}if(I[f.TRACE]){l.trace(I[f.TRACE]);}};this.getDefaultGroup=function(){var e=new q.Deferred(),I;if(!_){I=this._assureLoaded();}if(I){I.done(function(){e.resolve(_);}).fail(function(K){e.reject("Failed to access default group. "+K);});}else{e.resolve(_);}return e.promise();};this._isValidTitle=function(T){if(typeof T!=="string"||!T){return false;}return true;};this._isGroupPreset=function(e){return r.isGroupPreset(e);};this._isGroupLocked=function(e){return r.isGroupLocked(e);};this.addGroup=function(T){var e=new q.Deferred(),I=sap.ushell.Container.getService("CommonDataModel"),K,N,P=this;if(!this._isValidTitle(T)){return e.reject("No valid group title").promise();}N="Failed to add the group with title '"+T+"' to the homepage. ";I.getSite().done(function(S){K=U.generateUniqueId(r.getGroupIdsFromSite(S));m.addGroupToSite(S,m.createEmptyGroup(K,T));I.save().done(function(){delete P._assureLoadedDeferred;e.resolve(S.groups[K],K);}).fail(function(Q){e.reject(Q);});}).fail(function(Q){e.reject(N+Q);});return e.promise();};this.getGroupTitle=function(e){return r.getGroupTitle(e);};this.setGroupTitle=function(e,N){var I=this,K=new q.Deferred(),P=sap.ushell.Container.getService("CommonDataModel"),Q,S;if(typeof e!=="object"||!r.getGroupId(e)){return K.reject("Unexpected group value").promise();}if(!I._isValidTitle(N)){return K.reject("Unexpected oGroup title value").promise();}S="Failed to set new title for group with id '"+r.getGroupId(e)+"'. ";Q=r.getGroupTitle(e);P.getSite().done(function(T){if(e){m.setGroupTitle(e,N);}P.save().done(function(){K.resolve();}).fail(function(X){L.error(X);K.reject(Q);});}).fail(function(T){K.reject(Q,S+T);});return K.promise();};this.getGroupId=function(e){return r.getGroupId(e);};this.hideGroups=function(e){var I=new q.Deferred(),K=sap.ushell.Container.getService("CommonDataModel"),N;if(e&&Array.isArray(e)){N="Failed to hide group. ";K.getSite().done(function(S){r.getGroupsArrayFromSite(S).forEach(function(P){m.setGroupVisibility(P,e&&Array.prototype.indexOf.call(e,r.getGroupId(P))===-1);});K.save().done(function(){I.resolve();}).fail(function(P){I.reject("Hiding of groups did not work as expected - "+P);});}).fail(function(P){I.reject(N+P);});}else{I.reject("Invalid input parameter aHiddenGroupIds. Please pass a valid input parameter.");}return I.promise();};this.isGroupVisible=function(e){return r.isGroupVisible(e);};this.moveGroup=function(e,I){var K=new q.Deferred(),N=sap.ushell.Container.getService("CommonDataModel"),P,Q;if(!e||!r.getGroupId(e)||I<0){return K.reject("Unable to move groups - invalid parameters").promise();}Q="Failed to move group with id '"+e.identification.id+"'. ";N.getSite().done(function(S){var T=r.getGroupIdsFromSite(S),X=r.getGroupId(e);if(!T){return K.reject("groupsOrder not found - abort operation of adding a group.");}else if(T.indexOf(X)===I){return K.resolve();}P=U.moveElementInsideOfArray(T,T.indexOf(X),I);if(!P){return K.reject("invalid move group operation - abort.");}m.setGroupsOrder(S,P);N.save().done(function(){K.resolve();}).fail(function(Y){K.reject(Y);});return undefined;}).fail(function(S){K.reject(Q+S);});return K.promise();};this.removeGroup=function(e){var I=new q.Deferred(),K=sap.ushell.Container.getService("CommonDataModel"),N,P;if(typeof e!=="object"){return I.reject("invalid group parameter").promise();}P=r.getGroupId(e);if(!P){return I.reject("group without id given").promise();}N="Failed to remove group with id '"+P+"'. ";K.getSite().done(function(S){m.removeGroupFromSite(S,e);K.save().done(function(){I.resolve();}).fail(function(Q){I.reject(Q);});}).fail(function(Q){I.reject(N+Q);});return I.promise();};this.resetGroup=function(e){var I=new q.Deferred(),K=sap.ushell.Container.getService("CommonDataModel"),S=[],N=this,P,Q;if(typeof e==="object"&&r.getGroupId(e)){Q=r.getGroupId(e);P="Failed to reset group with id '"+Q+"'. ";K.getSite().done(function(T){q.extend(true,S,r.getGroupsArrayFromSite(T));if(N.isGroupRemovable(e)===false){K.getGroupFromOriginalSite(Q).done(function(X){if(typeof T==="object"&&r.getGroupFromSite(T,Q)){m.overwriteGroup(T,X,Q);}K.save().done(function(){I.resolve(X);}).fail(function(Y){I.reject("Group could not be reset - "+Y,S);});}).fail(function(X){I.reject("Group could not be reset - "+X,S);});}else{I.reject("Group could not be reset as it was created by the user",S);}}).fail(function(T){I.reject(P+T,[]);});}return I.promise();};this.getTileTitle=function(T){return r.getTileTitle(this._mResolvedTiles,T);};this.getTileSubtitle=function(T){return r.getTileSubtitle(this._mResolvedTiles,T);};this.getTileIcon=function(T){return r.getTileIcon(this._mResolvedTiles,T);};this.getTileInfo=function(T){return r.getTileInfo(this._mResolvedTiles,T);};this.getTileIndicatorDataSource=function(T){var e=this._mResolvedTiles[T.id],I={},K;if(T.indicatorDataSource){I.indicatorDataSource=U.clone(T.indicatorDataSource);if(T.dataSource){I.dataSource=U.clone(T.dataSource);}return I;}if(!e){return I;}K=e.tileResolutionResult;if(K.indicatorDataSource){I.indicatorDataSource=U.clone(K.indicatorDataSource);if(K.indicatorDataSource.hasOwnProperty("dataSource")){var N=K.indicatorDataSource.dataSource,P=K.dataSources;if(P&&P.hasOwnProperty(N)){I.dataSource=U.clone(P[N]);}else{L.warning("datasource referenced but not found for tile: "+e.tileIntent);}}if(U.getMember(K,"runtimeInformation.componentProperties.url")){var Q=U.getMember(I,"indicatorDataSource.path");var S=U.getMember(I,"dataSource.uri");var X=U.getMember(K,"runtimeInformation.componentProperties.url");var Y=u(Q,S,X,this.getWindowLocationHref());if(!Y.error){if(Q){I.indicatorDataSource.path=Y.uri;}if(S){I.dataSource.uri=Y.uriParent;}}}}return I;};this.getWindowLocationHref=function(){return window.location.href;};this.isGroupRemovable=function(e){return!this._isGroupPreset(e);};this.isGroupLocked=function(e){return this._isGroupLocked(e);};this.getGroupTiles=function(e){return r.getGroupTiles(e).concat(r.getGroupLinks(e));};this.getLinkTiles=function(e){return r.getGroupLinks(e);};this.getTileType=function(T){if(r.isLink(this._mResolvedTiles,T)){return this.TileType.Link;}return this.TileType.Tile;};this.getTileId=function(T){return r.getTileId(T);};this.getTileSize=function(T){return r.getTileSize(this._mResolvedTiles,T)||"1x1";};this.getTileTarget=function(T){var e,I=r.getTileId(T),K=this._mResolvedTiles[I],N;if(T.target&&T.target.url){return T.target.url;}if(K&&K.tileResolutionResult){e=K.tileResolutionResult;if(e.isCustomTile!==true){return K.tileIntent;}if(e&&typeof e.targetOutbound==="object"){N=this._toHashFromOutbound(e.targetOutbound);if(N){return N;}}}L.warning("Could not find a target for Tile with id '"+I+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return"";};this.isLinkPersonalizationSupported=function(T){return true;};this.isTileIntentSupported=function(T){return(this._mFailedResolvedTiles[T.id]===undefined);};this._notifyTileAboutRefresh=function(T){if(typeof T.tileRefresh==="function"){T.tileRefresh();}};this.refreshTile=function(T){var e=this._mResolvedTiles[T.id];if(e){if(e.tileComponent){this._notifyTileAboutRefresh(e.tileComponent);}}};this._notifyTileAboutVisibility=function(T,N,e){if(typeof T.tileSetVisible==="function"&&e!==N){T.tileSetVisible(N);}};this.setTileVisible=function(T,N){var e=this._mResolvedTiles[T.id];if(e){if(e.tileComponent){this._notifyTileAboutVisibility(e.tileComponent,N,e.visibility);}e.visibility=N;}};this.getTileView=function(e){var I=this;return new q.Deferred(function(K){return I._getTileView(e,false).then(function(T){K.resolve(T);},function(N){var P="Tile with ID '"+e.id+"' could not be initialized"+(N?":\n"+N:".");L.error(P,null,e.tileType);K.reject(P);});}).promise();};this._getTileUiComponentContainerSync=function(T,e,I){var K=this,N,P,Q,S,X={};if(I===true){P=K._createTileComponentData(T,true,e);}else{P=K._createTileComponentData(T,false,e);}N=e.tileResolutionResult;if(e.isLink){Q=N.navigationMode;return K._createLinkInstance(T,I,Q,G,o);}if(typeof N.tileComponentLoadInfo==="string"){if(P.properties.indicatorDataSource&&P.properties.indicatorDataSource.path){X.name="sap.ushell.components.tiles.cdm.applauncherdynamic";}else{X.name="sap.ushell.components.tiles.cdm.applauncher";}}else if(typeof N.tileComponentLoadInfo==="object"&&N.tileComponentLoadInfo!==null){X=N.tileComponentLoadInfo.componentProperties||{};X.name=N.tileComponentLoadInfo.componentName;}X.componentData=P;if(X.manifest){X.componentData.properties=X.componentData.properties||{};X.componentData.properties.manifest=X.manifest;}if(X.name){X.async=false;var Y;try{S=sap.ui.component(X);}catch(Z){L.error(Z.message+"\n-- An error occurred while instantiating "+"the tile component for "+X.name,Z.stack?Z.stack:"","sap.ushell.adapters.cdm.LaunchPageAdapter");return null;}Y=new C({component:S,height:"100%"});if(!I){K._mResolvedTiles[T.id].tileComponent=S;}return Y;}return null;};this._getTileUiComponentContainer=function(T,e,I){var K=this,N,P,Q,S,X,Y,Z=new q.Deferred();var $=sap.ushell.Container.getService("Ui5ComponentLoader");if(I===true){P=K._createTileComponentData(T,true,e);}else{P=K._createTileComponentData(T,false,e);}N=e.tileResolutionResult;if(e.isLink){Q=N.navigationMode;Z.resolve(K._createLinkInstance(T,I,Q,G,o));return Z.promise();}var a1=this._createTileComponentProperties(P,N.tileComponentLoadInfo);if(!a1.name){return Z.reject("Cannot find name of tile component for tile with id: '"+T.id+"'").promise();}if(a1.manifest){P.properties=P.properties||{};P.properties.manifest=a1.manifest;}Y=this.isCustomTile(a1.name);var b1=function(f1){var e;S=f1.componentHandle.getInstance();X=new C({component:S,height:"100%"});if(!I){e=K._mResolvedTiles[T.id];e.tileComponent=S;if(typeof e.visibility==="boolean"){K._notifyTileAboutVisibility(S,e.visibility);}}return X;};var c1=function(){return $.createComponent({loadCoreExt:Y,loadDefaultDependencies:false,componentData:P,url:a1.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:a1,ui5ComponentName:a1.name},{},[]).then(b1);};var d1=function(){var f1={componentData:P,url:a1.url,name:a1.name,async:false};S=sap.ui.component(f1);var g1={componentHandle:{getInstance:function(){return S;}}};return b1(g1);};if(Y){E.once("CoreResourcesComplementLoaded").do(function(){c1().then(function(X){Z.resolve(X);}).fail(function(f1){Z.reject(f1);});});}else{var e1=d1();Z.resolve(e1);}return Z.promise();};this._createTileComponentProperties=function(T,e){var I={};if(typeof e==="string"){if(T.properties.indicatorDataSource&&T.properties.indicatorDataSource.path){I.name=D;}else{I.name=s;}return I;}if(typeof e==="object"&&e!==null){I=e.componentProperties||{};I.name=e.componentName;}return I;};this._getTileView=function(e){var I,K,N=new q.Deferred();if(typeof e!=="object"||!e.id){K="Invalid input parameter passed to _getTileView: "+e;L.error(K);return N.reject(K).promise();}I=this._mResolvedTiles[e.id];if(I){return this._getTileUiComponentContainer(e,I,false);}K="No resolved tile found for tile ID: "+e.id;L.error(K);return N.reject(K).promise();};this._getCatalogTileView=function(e){if(typeof e!=="object"){throw new Error(e);}return this._getTileUiComponentContainerSync(e,e,true);};this._getCatalogTileViewControl=function(e){var I=new q.Deferred();if(typeof e!=="object"){var K="Invalid input parameter passed to _getCatalogTileView: "+e;L.error(K);return I.reject(K).promise();}return this._getTileUiComponentContainer(e,e,true);};this._createTileComponentData=function(T,I,e){var K=I?this.getCatalogTileTitle(T):this.getTileTitle(T),S=I?this.getCatalogTilePreviewSubtitle(T):this.getTileSubtitle(T),N=I?this.getCatalogTilePreviewIcon(T):this.getTileIcon(T),P=I?this.getCatalogTilePreviewInfo(T):this.getTileInfo(T),Q=I?this.getCatalogTileTargetURL(T):this.getTileTarget(T),X=this.getTileIndicatorDataSource(T),Y={properties:{},startupParameters:{}};if(e.tileResolutionResult.isCustomTile===true&&e.tileResolutionResult.startupParameters){Y.startupParameters=e.tileResolutionResult.startupParameters;}if(K){Y.properties.title=K;}if(P){Y.properties.info=P;}if(S){Y.properties.subtitle=S;}if(N){Y.properties.icon=N;}if(Q){Y.properties.targetURL=Q;}if(X.indicatorDataSource){Y.properties.indicatorDataSource=X.indicatorDataSource;if(X.dataSource){Y.properties.dataSource=X.dataSource;}}if(e.tileResolutionResult){Y.properties.navigationMode=e.tileResolutionResult.navigationMode;}return Y;};this._createLinkInstance=function(T,I,N,e,o){var K,P,Q,S=this.getTileSubtitle(T);var G=e;if(I===true){K=this.getCatalogTileTitle(T);}else{K=this.getTileTitle(T);}P=new G({mode:g.LineMode,subheader:S,header:K,url:W.getLeanURL(this.getTileTarget(T)),press:function(X){this._genericTilePressHandler(T,X);}.bind(this)});if(N){Q=o.i18n.getText(N+"NavigationMode");P.setAriaLabel(Q+" "+K+" "+S);}this._mResolvedTiles[T.id].linkTileControl=P;return P;};this._genericTilePressHandler=function(T,e){var I;if(e.getSource().getScope&&e.getSource().getScope()==="Display"){I=this.getTileTarget(T);if(I){if(I[0]==="#"){hasher.setHash(I);}else{W.openURL(I,"_blank");}}}};this._addTileToSite=function(P,e,N,I){var K=this,Q=new q.Deferred(),S=sap.ushell.Container.getService("URLParsing").parseShellHash(N.properties.targetURL),T={id:K.getTileId(N),target:{semanticObject:S.semanticObject,action:S.action,parameters:H(S.params)}};P.groups[e.identification.id].payload.tiles.push(T);I.save().done(function(){Q.resolve(T);}).fail(function(X){Q.reject(X);});return Q.promise();};this.addTile=function(e,I){var K=new q.Deferred(),N,P=sap.ushell.Container.getService("CommonDataModel"),Q;if(!I){I=_;}if(e.contentProviderId){if(e.externalUrl){return this.addBookmark(this._getBookmarkDataForExtensionCatalogTile(e),I);}return K.reject("Extension Tile without URL").promise();}Q=v();Q.appId=e.tileResolutionResult.appId;this._mResolvedTiles[Q.id]={tileIntent:e.tileIntent,tileResolutionResult:e.tileResolutionResult,isLink:false};P.getSite().done(function(S){S.groups[I.identification.id].payload.tiles.push(Q);P.save().done(function(){K.resolve(Q);}).fail(function(T){K.reject(T);});}).fail(function(S){N="Failed to add tile with id '"+Q.id+"' to group with id '"+I.identification.id+"'. ";K.reject(N+S);});return K.promise();};this._getBookmarkDataForExtensionCatalogTile=function(e){var I={title:e.tileResolutionResult.title,subtitle:e.tileResolutionResult.subTitle,icon:e.tileResolutionResult.icon,info:e.tileResolutionResult.info,url:e.externalUrl};if(e.tileResolutionResult.indicatorDataSource&&e.tileResolutionResult.indicatorDataSource.path){I.serviceUrl=e.tileResolutionResult.indicatorDataSource.path;I.serviceRefreshInterval=e.tileResolutionResult.indicatorDataSource.refresh;}return I;};this.removeTile=function(I,T,K){var N,P,Q=new q.Deferred(),S=this;if(!I||typeof I!=="object"||!I.identification||!I.identification.id||!T||typeof T!=="object"||!T.id){return Q.reject({},"Failed to remove tile. No valid input parameters passed to removeTile method.").promise();}P="Failed to remove tile with id '"+T.id+"' from group with id '"+I.identification.id+"'. ";N=sap.ushell.Container.getService("CommonDataModel");N.getSite().done(function(X){var Y,Z;K=+K;try{Y=X.groups[I.identification.id].payload;}catch(e){Q.reject(X.groups[I.identification.id],P);}Z=S.getTileType(T)===S.TileType.Link?"links":"tiles";if(S.getTileType(T)===S.TileType.Link){K-=Y.tiles.length;}if(K>=0){Y[Z].splice(K,1);}else{Y[Z]=Y[Z].filter(function($){return $.id!==T.id;});}N.save().done(function(){Q.resolve();}).fail(function($){L.error($);Q.reject(X.groups[I.identification.id],$);});}).fail(function(e){Q.reject({},P+e);});return Q.promise();};this.moveTile=function(T,S,e,I,K,N){var P=new q.Deferred(),Q=sap.ushell.Container.getService("CommonDataModel"),X=this,Y;if(!T||d(T)||S===undefined||S<0||e===undefined||e<0||!I||!I.identification||!I.identification.id||!K||!K.identification||!K.identification.id){return P.reject("Invalid input parameters").promise();}Y="Failed to move tile with id '"+T.id+"'. ";Q.getSite().done(function(Z){var $,a1,b1=X.getTileType(T)===X.TileType.Link?"links":"tiles";if(!N){N=X._mResolvedTiles[T.id].isLink?"link":"tile";}$=N==="link"?"links":"tiles";if(b1!==$&&X._mResolvedTiles[T.id]){X._mResolvedTiles[T.id].isLink=N==="link";}if($==="links"){e-=Z.groups[K.identification.id].payload.tiles.length;}if(b1==="links"){S-=Z.groups[I.identification.id].payload.tiles.length;}if(I.identification.id===K.identification.id){if(S!==e||b1!==$){a1=Z.groups[K.identification.id].payload;a1[b1].splice(S,1);a1[$].splice(e,0,T);}else{return P.resolve(T).promise();}}else{Z.groups[I.identification.id].payload[b1].splice(S,1);Z.groups[K.identification.id].payload[$].splice(e,0,T);}Q.save().done(function(){P.resolve(T);}).fail(function(c1){L.error(Y+c1);P.reject(Y+c1);});return undefined;}).fail(function(Z){L.error(Y+Z);P.reject(Y+Z);});return P.promise();};this._compareCatalogs=function(e,I){if(e.identification.id>I.identification.id){return 1;}return-1;};this.getCatalogs=function(){var e=this,I=new q.Deferred(),K=[],N=sap.ushell.Container.getService("CommonDataModel");function P(Q,S,K,T,X,Y){var Z=Q.catalogs[S];if(X&&Y){Z.contentProviderId=X;Y.catalogsMap[S]=Z;}K.push(Z);T.notify(Z);}window.setTimeout(function(){N.getSite().done(function(S){Object.keys(S.catalogs).forEach(function(Q){P(S,Q,K,I);});N.getExtensionSites().progress(function(Q){var T=Q.providerId;var X=Q.site;var Y=Promise.resolve(X);var Z={sitePromise:Y,site:X,catalogsMap:{}};Object.keys(X.catalogs).forEach(function($){e._mContentProviders[T]=Z;P(X,$,K,I,T,Z);});}).done(function(Q){Q.filter(function(T){return!T.success;}).forEach(function(T,X){K.push({identification:{id:T.providerId},contentProviderId:T.providerId,error:"The following content providers could not provide catalogs: "+T.providerId+(T.error?" -> "+T.error:"")});});I.resolve(K.sort(e._compareCatalogs));});});},0);return I.promise();};this._isStartableInbound=function(I){var N=["Shell-plugin","Shell-bootConfig"],e;if(!I.semanticObject||!I.action){return false;}if(N.indexOf(I.semanticObject+"-"+I.action)>-1){return false;}if(!O.get("signature.parameters",I)){return true;}e=Object.keys(I.signature.parameters).every(function(p){return!I.signature.parameters[p].filter||(!!I.signature.parameters[p].launcherValue||p==="sap-external-url");});return e;};this._isHiddenInbound=function(I){return!!I.hideLauncher;};this._toHashFromInbound=function(I){var e=b.toHashFromInbound(I);if(!e){return undefined;}return"#"+e;};this._getExternalUrlFromInbound=function(I){return O.get("signature.parameters.sap-external-url.launcherValue.value",I)||null;};this._toHashFromOutbound=function(e){var I=b.toHashFromOutbound(e);if(!I){return undefined;}return"#"+I;};this._isCustomTile=function(e){if(U.getMember(e,"sap|flp.type")==="tile"){return true;}return false;};this.getCatalogTiles=function(e){var I=this,K=new q.Deferred();if(typeof e!=="object"||e===null){return K.reject("Invalid input parameter '"+e+"' passed to getCatalogTiles.").promise();}if(e.contentProviderId&&this._mContentProviders[e.contentProviderId]){this._mContentProviders[e.contentProviderId].sitePromise.then(function(S){k.call(I,e,S).done(K.resolve).fail(K.reject);},function(N){K.reject("Failed to get site: "+N);});}else{sap.ushell.Container.getService("CommonDataModel").getSite().done(function(S){k.call(I,e,S).done(K.resolve).fail(K.reject);}).fail(function(N){K.reject("Failed to get site: "+N);});}return K.promise();};this.isCustomTile=function(e){return!(e===s||e===D);};function k(e,S){var I=this,K=new q.Deferred();setTimeout(function(){var N=((e.payload&&e.payload.appDescriptors)||[]).reduce(function(P,Q){var T=S.applications[Q.id],X,Y,Z,$,a1,b1,c1,d1,e1,f1,g1,h1;if(!T){return P;}X=I._getMember(T,"sap|app.crossNavigation.inbounds");if(!X||Object.keys(X).length===0){return P;}Z=Object.keys(X)[0];$=X[Z];if(I._isStartableInbound($)&&!I._isHiddenInbound($)){a1=b.mapOne(Z,$,T);if(!a1||!a1.tileResolutionResult){return P;}e1=a1.resolutionResult.applicationType;h1=a.last("/core/navigation/enableInPlaceForClassicUIs");g1=h1?h1[e1]:false;f1=a1.resolutionResult.additionalInformation;a1.tileResolutionResult.navigationMode=n.computeNavigationModeForHomepageTiles(e1,f1,g1);b1=a1.tileResolutionResult;Y=I._toHashFromInbound($);if(e.contentProviderId){d1=I._getMember(T,"sap|app.crossNavigation.inbounds.Shell-launchURL.signature.parameters.sap-external-url.launcherValue.value");}c1={id:d1||Y,tileIntent:d1||Y,tileResolutionResult:b1,isCatalogTile:true};if(e.contentProviderId&&d1){c1.contentProviderId=e.contentProviderId;c1.externalUrl=d1;}P.push(c1);}return P;},[]);K.resolve(N);},0);return K.promise();}this.getCatalogError=function(e){if(e.error){return e.error;}return undefined;};this.getCatalogId=function(e){return R.getCatalogId(e);};this.getCatalogTitle=function(e){return R.getCatalogTitle(e);};this._isGroupTile=function(T){return r.isGroupTile(T);};this._isCatalogTile=function(T){return!!(T&&T.isCatalogTile);};this._isFailedGroupTile=function(T){return!!(T&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[r.getTileId(T)]);};this._isFailedCatalogTile=function(T){return!!(T&&this._mFailedResolvedCatalogTiles&&this._mFailedResolvedCatalogTiles[r.getTileId(T)]);};this.getCatalogTileId=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return undefined;}if(e.isBookmark&&O.get("target.url",e)){return e.target.url;}return(this._mResolvedTiles[r.getTileId(e)]||{}).tileIntent;}if(this._isCatalogTile(e)){return e.id;}return undefined;};this.getCatalogTileTitle=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return"";}return this._mResolvedTiles[e.id].tileResolutionResult.title;}if(this._isCatalogTile(e)){if(this._isFailedCatalogTile(e)){return undefined;}return e.tileResolutionResult.title;}return undefined;};this.getCatalogTileSize=function(e){return e.tileResolutionResult.size||"1x1";};this.getCatalogTileView=function(e){return this._getCatalogTileView(e);};this.getCatalogTileViewControl=function(e){return this._getCatalogTileViewControl(e);};this.getCatalogTileTargetURL=function(e){if(!e){throw new Error("The given tile is falsy");}if(this._isCatalogTile(e)){if(e.tileResolutionResult&&e.tileResolutionResult.isCustomTile){if(!e.tileResolutionResult.targetOutbound){return"";}return this._toHashFromOutbound(e.tileResolutionResult.targetOutbound);}return e.tileIntent||"";}return this.getTileTarget(e);};this.getCatalogTilePreviewTitle=function(e){if(this._isGroupTile(e)){return this.getTileTitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.title)||"";};this.getCatalogTilePreviewSubtitle=function(e){if(this._isGroupTile(e)){return this.getTileSubtitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.subTitle)||"";};this.getCatalogTilePreviewIcon=function(e){if(this._isGroupTile(e)){return this.getTileIcon(e);}return(e.tileResolutionResult&&e.tileResolutionResult.icon)||"";};this.getCatalogTilePreviewInfo=function(e){if(this._isGroupTile(e)){return this.getTileInfo(e);}return(e.tileResolutionResult&&e.tileResolutionResult.info)||"";};this.getCatalogTileKeywords=function(e){var K=[],I=e;if(!I){L.error("Could not find the Tile","sap.ushell.adapters.cdm.LaunchPageAdapter");return K;}if(this._mResolvedTiles&&this._mResolvedTiles[e.id]){I=this._mResolvedTiles[e.id];}if(I&&I.tileResolutionResult&&I.tileResolutionResult.title){K.push(I.tileResolutionResult.title);}if(I&&I.tileResolutionResult&&I.tileResolutionResult.subTitle){K.push(I.tileResolutionResult.subTitle);}return K;};this._visitBookmarks=function(e,I){var K=sap.ushell.Container;var N=K.getService("URLParsing");var P=K.getService("CommonDataModel");var Q;var S=N.parseShellHash(e);if(S){Q=F(S);}else{Q=B(e);}return P.getSite().then(function(T){var X=T.groups;var Y=Object.keys(X).filter(function(Z){return!X[Z].payload.locked;}).map(function(Z){return X[Z].payload.tiles.filter(function($){return $.isBookmark&&x(Q,$.target);});}).reduce(function(Z,$){Array.prototype.push.apply(Z,$);return Z;},[]);if(!I){return Y.length;}return q.when(Y.map(I)).then(function(){return Y.length;});});};this.addBookmark=function(P,e){var I=this;return new q.Deferred(function(K){var N=sap.ushell.Container;var Q=N.getService("URLParsing");var S=N.getService("CommonDataModel");q.when(e||I.getDefaultGroup(),S.getSite()).done(function(e,T){var X,Y,Z=Q.parseShellHash(P.url),$,a1=false;if(!Z){Y=B(P.url);a1=true;}else{Y=F(Z);}X=t(P,Y);if(a1){$=new q.Deferred();$.resolve(I._getTileForUrl(X));}else{$=I._getTileFromHash(P.url);}$.done(function(b1){b1.isLink=false;I._mResolvedTiles[X.id]=b1;T.groups[e.identification.id].payload.tiles.push(X);S.save().done(function(){K.resolve(X);}).fail(function(c1){K.reject(c1);});}).fail(function(b1){K.reject("Bookmark creation failed because: "+b1);});}).fail(function(T){K.reject(T);});}).promise();};this.countBookmarks=function(e){return this._visitBookmarks(e);};this.updateBookmarks=function(e,P){var I=sap.ushell.Container;var K=I.getService("URLParsing");var N=I.getService("CommonDataModel");var Q=this._mResolvedTiles;function S(T){return new q.Deferred(function(X){var Y,Z;var $;var a1=false;var b1={};if(P.url||P.url===""){Y=K.parseShellHash(P.url);if(!Y){Z=B(P.url);}else{Z=F(Y);}}if(T.icon!==P.icon){b1.icon=P.icon;a1=true;}if(T.title!==P.title){b1.title=P.title;a1=true;}if(T.subTitle!==P.subtitle){b1.subtitle=P.subtitle;a1=true;}if(P.url&&e!==P.url){b1.targetURL=P.url;a1=true;}if(T.info!==P.info){b1.info=P.info;a1=true;}w(T,P,Z);if(a1&&Q[T.id]){$=Q[T.id].tileComponent;if($){$.tileSetVisualProperties(b1);}}X.resolve(T);}).promise();}return this._visitBookmarks(e,S).then(function(T){return N.save().then(function(){return T;});});};this.deleteBookmarks=function(e){var I=sap.ushell.Container;var K=I.getService("URLParsing");var N=I.getService("CommonDataModel");var P=K.parseShellHash(e);var Q;if(P){Q=F(P);}else{Q=B(e);}return N.getSite().then(function(S){var T=S.groups;var X=Object.keys(T).map(function(Y){var Z=T[Y].payload;var $=0;Z.tiles=Z.tiles.filter(function(a1){if(a1.isBookmark&&x(Q,a1.target)){++$;return false;}return true;});return $;}).reduce(function(Y,Z){Y+=Z;return Y;},0);return N.save().then(function(){return X;});});};this.onCatalogTileAdded=function(T){};this._onTileSettingsSave=function(T,S){var e=new q.Deferred(),I,N,K,P,Q,X,Y;if(!T||!T.id||!S){return e.reject().promise();}N=S.oTitleInput.getValue();P=S.oSubTitleInput.getValue();K=S.oInfoInput.getValue();Q=this.getTileTitle(T);X=this.getTileInfo(T);Y=this.getTileSubtitle(T);if(Q===N&&Y===P&&X===K){return e.resolve().promise();}I={};if(Q!==N){I.title=N;T.title=N;}if(Y!==P){I.subtitle=P;T.subTitle=P;}if(X!==K){I.info=K;T.info=K;}if(this._mResolvedTiles[T.id].tileComponent){this._mResolvedTiles[T.id].tileComponent.tileSetVisualProperties(I);}else if(this._mResolvedTiles[T.id].linkTileControl){if(I.title){this._mResolvedTiles[T.id].linkTileControl.setHeader(I.title);}if(I.subtitle){this._mResolvedTiles[T.id].linkTileControl.setSubheader(I.subtitle);}if((I.title)||(I.subtitle)){this._mResolvedTiles[T.id].linkTileControl.rerender();}}sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(Z){Z.save().fail(function($){L.error($);e.reject("Could not save personalization changes: "+$);}).done(function(){e.resolve();});});return e.promise();};this.getTileActions=function(T){var e=[],I,K;if(this._isGroupTile(T)&&!this._isFailedGroupTile(T)){K=new J({config:{display_title_text:this.getTileTitle(T),display_subtitle_text:this.getTileSubtitle(T),display_info_text:this.getTileInfo(T)}});I=c.getTileSettingsAction(K,this._onTileSettingsSave.bind(this,T),this.getTileType(T));e.push(I);}return e;};function t(P,T){var e=v(P,T);e.isBookmark=true;return e;}function v(P,T){var e={id:U.generateUniqueId([])};w(e,P,T);return e;}function w(T,P,e){P=q.extend(true,{},P);if(e){T.target=e;}if(P.title||P.title===""){T.title=P.title;}if(P.icon||P.icon===""){T.icon=P.icon;}if(P.subtitle||P.subtitle===""){T.subTitle=P.subtitle;}if(P.info||P.info===""){T.info=P.info;}if(P.dataSource){T.dataSource={};q.extend(true,T.dataSource,P.dataSource);delete P.serviceUrl;}else if(P.dataSource===null){delete T.dataSource;delete T.indicatorDataSource;delete P.serviceUrl;}if((P.dataSource||T.dataSource)&&P.serviceUrlPath){T.indicatorDataSource={path:P.serviceUrlPath};}if(P.serviceUrl||P.serviceUrl===""){if(T.dataSource){L.warning("`serviceUrl` is marked for deprecation in the future."+"It is not the preferred means for defining a dynamic "+"tile's data source. Please use `oParameter.dataSource`");delete T.dataSource;}T.indicatorDataSource={path:P.serviceUrl};}else if(P.serviceUrl===null&&!T.dataSource){delete T.indicatorDataSource;}if(P.serviceRefreshInterval||P.serviceRefreshInterval===0){T.indicatorDataSource.refresh=P.serviceRefreshInterval;}}function x(T,e){if(T&&e){if(T.url){return T.url===e.url;}return T.semanticObject===e.semanticObject&&T.action===e.action&&y(T.parameters,e.parameters)&&T.appSpecificRoute===e.appSpecificRoute;}return T===e;}function y(P,e){var I,K;P=P||[];e=e||[];if(P.length===e.length){I=z(P);K=z(e);return I===K;}return false;}function z(e){return e.map(function(P){return P.name+P.value;}).sort().join();}function B(e){return{url:e};}function F(I){var T={semanticObject:I.semanticObject,action:I.action,parameters:H(I.params)};if(I.appSpecificRoute){T.appSpecificRoute=I.appSpecificRoute;}return T;}function H(I){return Object.keys(I).map(function(K){var e=I[K]&&I[K][0];return{name:K,value:e||""};});}}h.prototype._getMember=function(e,A){return U.getMember(e,A);};return h;},true);
