// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/base/util/deepClone","sap/ui/core/XMLComposite","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/ui/Device","sap/m/Token","sap/ushell/resources","sap/ushell/Config"],function(l,d,X,J,F,a,b,D,T,r,C){"use strict";var c=l.ContentNodeType;var e=X.extend("sap.ushell.ui.ContentNodeSelector",{metadata:{library:"sap.ushell",associations:{labelId:{type:"sap.ui.core.Control",multiple:false}},events:{selectionChanged:{}}}});e.prototype.init=function(){this._oModel=new J({items:[],suggestions:[],isSpaces:C.last("/core/spaces/enabled")});this._oDeviceModel=new J(D);this.setModel(this._oModel,"_internal");this.setModel(this._oDeviceModel,"_device");this.setModel(r.getTranslationModel(),"_i18n");var m=this.getAggregation("_content");m.addValidator(this._validateItem.bind(this));this.setBusyIndicatorDelay(0);this._loadContentNodes().then(this._overwriteLabel.bind(this));};e.prototype._overwriteLabel=function(){var L=this.getLabelId();var o=sap.ui.getCore().byId(L);if(o&&typeof o.setText==="function"){if(this._oModel.getProperty("/isSpaces")){o.setText(r.i18n.getText("contentNodeSelectorHomepagePages"));}else{o.setText(r.i18n.getText("contentNodeSelectorHomepageGroups"));}}if(o&&typeof o.setRequired==="function"&&o.isPropertyInitial("required")){o.setRequired(true);}if(o&&typeof o.setLabelFor==="function"){o.setLabelFor(this);}};e.prototype.exit=function(){this._oModel.destroy();this._oDeviceModel.destroy();};e.prototype.getSelectedContentNodes=function(){var m=this.getAggregation("_content");var t=m.getTokens();return t.map(function(o){var f=o.getBindingContext("_internal").getObject();var g=d(f);delete g.selected;delete g.spaceTitles;return g;});};e.prototype._loadContentNodes=function(){this.setBusy(true);return sap.ushell.Container.getServiceAsync("Bookmark").then(function(B){return B.getContentNodes();}).then(function(f){f=d(f);e._normalizeContentNodes(f);this._oModel.setProperty("/items",f);var s=e._getSuggestions(f);for(var i=0;i<s.length;i++){s[i].selected=false;}this._oModel.setProperty("/suggestions",s);this.setBusy(false);}.bind(this));};e.prototype._showValueHelp=function(f){var m=f.getSource();var t=m.getValue();if(!this._oValueHelpDialog){b.load({id:this.getId()+"-ValueHelpDialog",name:"sap.ushell.ui.ContentNodeSelectorValueHelp",controller:this}).then(function(o){this.addDependent(o);this._oValueHelpDialog=o;this._openValueHelpDialog(t);}.bind(this));}else{this._openValueHelpDialog(t);}};e.prototype._openValueHelpDialog=function(f){var t=b.byId(this.getId()+"-ValueHelpDialog","ContentNodesTree");t.expandToLevel(1);this._oValueHelpDialog.open();var s=b.byId(this.getId()+"-ValueHelpDialog","ContentNodesSearch");s.setValue(f);this._onValueHelpSearch();};e.prototype._onValueHelpSearch=function(){var s=b.byId(this.getId()+"-ValueHelpDialog","ContentNodesSearch");var f=s.getValue();var t=b.byId(this.getId()+"-ValueHelpDialog","ContentNodesTree");var i=t.getBinding("items");i.filter(new F({path:"label",operator:a.Contains,value1:f}));};e.prototype._onValueHelpBeginButtonPressed=function(){var t=b.byId(this.getId()+"-ValueHelpDialog","ContentNodesTree");var s=t.getSelectedContextPaths();var m=this.getAggregation("_content");m.destroyTokens();var o;var p;for(var i=0;i<s.length;i++){p=s[i];var M=this.getModel("_internal");var f=m.getAggregation("tokens").map(function(I){return I.getProperty("key");}).indexOf(M.getProperty(p).id);if(f<0){o=this._createToken(p);m.addValidateToken({token:o});}}m.setValue("");this._oValueHelpDialog.close();};e.prototype._onValueHelpEndButtonPressed=function(){this._oValueHelpDialog.close();};e.prototype._onTokenUpdate=function(f){var A=f.getParameter("addedTokens");var R=f.getParameter("removedTokens");this._setTokensSelected(A,true);this._setTokensSelected(R,false);setTimeout(this.fireSelectionChanged.bind(this),0);};e.prototype._setTokensSelected=function(t,s){var o;for(var i=0;i<t.length;i++){o=t[i].getBindingContext("_internal");o.getModel().setProperty(o.getPath("selected"),s);}};e.prototype._validateItem=function(i){if(i.suggestedToken){return i.suggestedToken;}var I=i.suggestionObject;if(!I){return null;}var o=I.getBindingContext("_internal");return this._createToken(o.getPath());};e.prototype._createToken=function(p){var t=new T({key:"{_internal>id}",text:"{_internal>label}"});t.bindObject({path:p,model:"_internal"});return t;};e._getSuggestions=function(i){var s=[];e._getChildren(i,s);return s;};e._getChildren=function(f,g){var I;for(var i=0;i<f.length;i++){I=f[i];if(I.isContainer&&g.indexOf(I)===-1){g.push(I);}if(I.children){e._getChildren(I.children,g);}}};e._normalizeContentNodes=function(f){var p={};e._visitPages(f,function(s,P){P.spaceTitles=P.spaceTitles||[];if(p[P.id]){p[P.id].spaceTitles.push(s.label);return p[P.id];}P.spaceTitles.push(s.label);p[P.id]=P;return P;});};e._visitPages=function(f,g){var o,p;if(f===undefined||f===null){return;}for(var i=0;i<f.length;i++){o=f[i];if(o.type!==c.Space){return;}else if(o.children){for(var k=0;k<o.children.length;k++){p=o.children[k];o.children[k]=g(o,p);}}}};e.prototype.clearSelection=function(){var m=this.getAggregation("_content");var t=m.getTokens();t.forEach(function(o){var f=o.getBindingContext("_internal");this._oModel.setProperty(f.getPath("selected"),false);}.bind(this));m.destroyTokens();};e.prototype.setValueState=function(v){var m=this.getAggregation("_content");m.setValueState(v);};e.prototype.setValueStateText=function(v){var m=this.getAggregation("_content");m.setValueStateText(v);};return e;});
