// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/Bar","sap/ui/Device","sap/ui/thirdparty/jquery","sap/base/util/isEmptyObject","sap/m/Button","sap/ushell/resources","sap/ushell/library","./AnchorNavigationBarRenderer"],function(B,D,q,a,b,r){"use strict";var A=B.extend("sap.ushell.ui.launchpad.AnchorNavigationBar",{metadata:{library:"sap.ushell",properties:{accessibilityLabel:{type:"string",defaultValue:null},selectedItemIndex:{type:"int",group:"Misc",defaultValue:0},overflowEnabled:{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{groups:{type:"sap.ushell.ui.launchpad.AnchorItem",multiple:true,singularName:"group"}},events:{afterRendering:{},itemPress:{}}}});A.prototype.init=function(){D.resize.attachHandler(this.reArrangeNavigationBarElements,this);this.bGroupWasPressed=false;this.bIsRtl=sap.ui.getCore().getConfiguration().getRTL();this._bIsRenderedCompletely=false;};A.prototype.handleExit=function(){if(this.oPopover){this.oPopover.destroy();}if(this.oOverflowButton){this.oOverflowButton.destroy();}};A.prototype.onAfterRendering=function(){if(this._bIsRenderedCompletely){this.reArrangeNavigationBarElements();q(".sapUshellAnchorNavigationBarItemsScroll").scroll(this.setNavigationBarItemsVisibility.bind(this));}};A.prototype.openOverflowPopup=function(){var o=q(".sapUshellAnchorItemOverFlow").hasClass("sapUshellAnchorItemOverFlowOpen");if(this.oOverflowButton&&!o){this.oOverflowButton.firePress();}};A.prototype.closeOverflowPopup=function(){if(this.oPopover){this.oPopover.close();}};A.prototype.reArrangeNavigationBarElements=function(){this.anchorItems=this.getVisibleGroups();var s=this.getSelectedItemIndex()||0;if(this.anchorItems.length){this.adjustItemSelection(s);}if(D.system.phone&&this.anchorItems.length){this.anchorItems.forEach(function(i){i.setIsGroupVisible(false);});this.anchorItems[this.getSelectedItemIndex()].setIsGroupVisible(true);}else{setTimeout(function(){this.setNavigationBarItemsVisibility();}.bind(this),200);}this._adjustAnchorBarAriaProperties(this.anchorItems);};A.prototype._scrollToGroupByGroupIndex=function(g,s){var S=D.system.tablet?".sapUshellAnchorNavigationBarItemsScroll":".sapUshellAnchorNavigationBarItems";var c=document.documentElement.querySelector(S);var o=this.anchorItems[g].getDomRef();if(c&&o){var C=c.getBoundingClientRect();var i=o.getBoundingClientRect();var $=q(c);var d=this.bIsRtl?$.scrollLeftRTL():c.scrollLeft;var x;if(i.left<C.left){x=i.left-C.left-16;}else if(i.right>C.right){x=i.right-C.right+16;}if(x){if(this.bIsRtl){$.scrollLeftRTL(d+x);}else{c.scrollLeft=d+x;}}this.setNavigationBarItemsVisibility();}};A.prototype.setNavigationBarItemsVisibility=function(){if(!D.system.phone){this.setNavigationBarItemsVisibilityOnDesktop();}else if(this.anchorItems&&this.anchorItems.length>0){this.oOverflowButton.removeStyleClass("sapUshellShellHidden");var s=this.getSelectedItemIndex()||0;if(this.oPopover){this.oPopover.setTitle(this.anchorItems[s].getTitle());}}};A.prototype.setNavigationBarItemsVisibilityOnDesktop=function(){if(this.anchorItems.length&&(!this.isMostRightAnchorItemVisible()||!this.isMostLeftAnchorItemVisible())){this.oOverflowButton.removeStyleClass("sapUshellShellHidden");q(".sapUshellAnchorItemOverFlow").removeClass("sapUshellShellHidden");}else if(this.oOverflowButton){this.oOverflowButton.addStyleClass("sapUshellShellHidden");q(".sapUshellAnchorItemOverFlow").addClass("sapUshellShellHidden");}if(this.bIsRtl){if(this.anchorItems.length&&!this.isMostLeftAnchorItemVisible()){this.oOverflowRightButton.removeStyleClass("sapUshellShellHidden");}else if(this.oOverflowRightButton){this.oOverflowRightButton.addStyleClass("sapUshellShellHidden");}if(this.anchorItems.length&&!this.isMostRightAnchorItemVisible()){this.oOverflowLeftButton.removeStyleClass("sapUshellShellHidden");}else if(this.oOverflowLeftButton){this.oOverflowLeftButton.addStyleClass("sapUshellShellHidden");}}else{if(this.anchorItems.length&&!this.isMostLeftAnchorItemVisible()){this.oOverflowLeftButton.removeStyleClass("sapUshellShellHidden");}else if(this.oOverflowLeftButton){this.oOverflowLeftButton.addStyleClass("sapUshellShellHidden");}if(this.anchorItems.length&&!this.isMostRightAnchorItemVisible()){this.oOverflowRightButton.removeStyleClass("sapUshellShellHidden");}else if(this.oOverflowRightButton){this.oOverflowRightButton.addStyleClass("sapUshellShellHidden");}}q(".sapUshellAnchorItem.firstItem").removeClass("firstItem");var j=q(".sapUshellAnchorItem").filter(":visible").eq(0);j.addClass("firstItem");};A.prototype.adjustItemSelection=function(s){setTimeout(function(){if(this.anchorItems&&this.anchorItems.length){this.anchorItems.forEach(function(i){i.setSelected(false);});if(s>=0&&s<this.anchorItems.length){this.anchorItems[s].setSelected(true);this._scrollToGroupByGroupIndex(s);}}}.bind(this),200);};A.prototype.isMostRightAnchorItemVisible=function(){var j=q(".sapUshellAnchorNavigationBarInner"),n=!a(j)?j.width():0,c=!a(j)&&j.offset()?j.offset().left:0,l=this.bIsRtl?this.anchorItems[0].getDomRef():this.anchorItems[this.anchorItems.length-1].getDomRef(),d=!a(l)?q(l).width():0,e;if(d<0){d=80;}e=l&&q(l).offset()?q(l).offset().left:0;return Math.ceil(e)+d<=c+n;};A.prototype.isMostLeftAnchorItemVisible=function(){var j=q(".sapUshellAnchorNavigationBarInner"),n=!a(j)&&j.offset()&&j.offset().left||0,f=this.bIsRtl?this.anchorItems[this.anchorItems.length-1].getDomRef():this.anchorItems[0].getDomRef(),c=!a(f)&&q(f).offset()?q(f).offset().left:0;return Math.ceil(c)>=n;};A.prototype.setSelectedItemIndex=function(s){if(s!==undefined){this.setProperty("selectedItemIndex",s,true);}};A.prototype.setOverflowEnabled=function(e){this.setProperty("overflowEnabled",e);if(this.oOverflowButton){this.oOverflowButton.setEnabled(e);}};A.prototype._getOverflowLeftArrowButton=function(){if(!this.oOverflowLeftButton){this.oOverflowLeftButton=new b({icon:"sap-icon://slim-arrow-left",tooltip:r.i18n.getText("scrollToTop"),press:function(){this._scrollToGroupByGroupIndex(0);}.bind(this)}).addStyleClass("sapUshellShellHidden");this.oOverflowLeftButton._bExcludeFromTabChain=true;}return this.oOverflowLeftButton;};A.prototype._getOverflowRightArrowButton=function(){if(!this.oOverflowRightButton){this.oOverflowRightButton=new b({icon:"sap-icon://slim-arrow-right",tooltip:r.i18n.getText("scrollToEnd"),press:function(){this._scrollToGroupByGroupIndex(this.anchorItems.length-1);}.bind(this)}).addStyleClass("sapUshellShellHidden");this.oOverflowRightButton._bExcludeFromTabChain=true;}return this.oOverflowRightButton;};A.prototype._getOverflowButton=function(){if(!this.oOverflowButton){this.oOverflowButton=new b("sapUshellAnchorBarOverflowButton",{icon:"sap-icon://slim-arrow-down",tooltip:r.i18n.getText("more_groups"),enabled:this.getOverflowEnabled(),press:function(){this._togglePopover();}.bind(this)}).addStyleClass("sapUshellShellHidden");this.oOverflowButton._bExcludeFromTabChain=true;}return this.oOverflowButton;};A.prototype._togglePopover=function(){sap.ui.require(["sap/m/Popover","sap/ui/model/Filter","sap/ushell/ui/launchpad/GroupListItem","sap/m/List","sap/m/library"],function(P,F,G,L,m){var c=m.ListMode;if(!this.oPopover){this.oList=new L({mode:c.SingleSelectMaster,rememberSelections:false,selectionChange:function(e){this.fireItemPress({group:e.getParameter("listItem")});this.oPopover.close();}.bind(this)});this.oPopover=new P("sapUshellAnchorBarOverflowPopover",{showArrow:false,showHeader:false,placement:"Left",content:[this.oList],horizontalScrolling:false,beforeOpen:function(){var j=q(".sapUshellAnchorItemOverFlow"),i=sap.ui.getCore().getConfiguration().getRTL(),o=i?-1*j.outerWidth():j.outerWidth();this.setOffsetX(o);},afterClose:function(){q(".sapUshellAnchorItemOverFlow").removeClass("sapUshellAnchorItemOverFlowOpen");q(".sapUshellAnchorItemOverFlow").toggleClass("sapUshellAnchorItemOverFlowPressed",false);}}).addStyleClass("sapUshellAnchorItemsPopover").addStyleClass("sapContrastPlus");}if(this.oPopover.isOpen()){this.oPopover.close();}else{this.anchorItems=this.getVisibleGroups();this.oList.setModel(this.getModel());var d=this.getModel().getProperty("/tileActionModeActive");var v=new F("","EQ","a");v.fnTest=function(i){if(!i.visibilityModes[d?1:0]){return false;}return i.isGroupVisible||d;};this.oList.bindItems({path:"/groups",template:new G({title:"{title}",groupId:"{groupId}",index:"{index}"}),filters:[v]});var s=q(".sapUshellAnchorItemSelected").attr("id");var S=sap.ui.getCore().byId(s);this.oList.getItems().forEach(function(i){if(S.mProperties.groupId===i.mProperties.groupId){i.addStyleClass("sapUshellAnchorPopoverItemSelected");}else{i.addStyleClass("sapUshellAnchorPopoverItemNonSelected");}});q(".sapUshellAnchorItemOverFlow").toggleClass("sapUshellAnchorItemOverFlowPressed",true);this.oPopover.openBy(this.oOverflowButton);}}.bind(this));};A.prototype.getVisibleGroups=function(){return this.getGroups().filter(function(g){return g.getVisible();});};A.prototype._adjustAnchorBarAriaProperties=function(g){var i;for(i=0;i<g.length;i++){var j=q(g[i].getDomRef());j.attr("aria-posinset",i+1);j.attr("aria-setsize",g.length);}};A.prototype._setRenderedCompletely=function(R){this._bIsRenderedCompletely=R;};A.prototype.handleAnchorItemPress=function(e){this.bGroupWasPressed=true;this.fireItemPress({group:e.getSource(),manualPress:true});};A.prototype.exit=function(){if(this.oOverflowLeftButton){this.oOverflowLeftButton.destroy();}if(this.oOverflowRightButton){this.oOverflowRightButton.destroy();}if(this.oOverflowButton){this.oOverflowButton.destroy();}if(this.oPopover){this.oPopover.destroy();}};return A;});
