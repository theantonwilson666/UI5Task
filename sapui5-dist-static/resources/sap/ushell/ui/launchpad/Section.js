//Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/f/GridContainerItemLayoutData","sap/m/library","sap/ui/core/InvisibleMessage","sap/ui/core/library","sap/ui/core/XMLComposite","sap/ui/events/KeyCodes","sap/ui/model/Filter","sap/ui/thirdparty/jquery","sap/ushell/library","sap/ushell/resources","sap/ushell/ui/launchpad/ExtendedChangeDetection"],function(L,d,G,m,I,c,X,K,F,q,u,r,E){"use strict";var T=m.TileSizeBehavior;var a=c.InvisibleMessageMode;var D=u.DisplayFormat;function _(R,v,A){if(!Array.isArray(v)||!v.length){return null;}if(R&&R.getDomRef){R=R.getDomRef();}if(!R){return v[A?v.length-1:0];}function h(t,w){var x=t.left+t.right-w.left-w.right;var y=t.top+t.bottom-w.top-w.bottom;return x*x+y*y;}function j(t){var w=t.querySelector(".sapMGTLineStyleHelper");return(w||t).getBoundingClientRect();}var o=j(R);var n=null;var k=0;var l;var p;var s;for(var i=v.length-1;i>=0;i--){p=v[i].getDomRef();if(p){l=j(p);if(!l.width&&!l.height){continue;}if(A&&l.top>=o.top||!A&&l.bottom<=o.bottom){continue;}s=h(l,o);if(!n||s<k){n=v[i];k=s;}}}return n;}var S=X.extend("sap.ushell.ui.launchpad.Section",{metadata:{library:"sap.ushell",properties:{editable:{type:"boolean",group:"Misc",defaultValue:false},dataHelpId:{type:"string",group:"Misc",defaultValue:""},default:{type:"boolean",group:"Misc",defaultValue:false},enableAddButton:{type:"boolean",group:"Behavior",defaultValue:true},enableDeleteButton:{type:"boolean",group:"Behavior",defaultValue:true},enableGridBreakpoints:{type:"boolean",group:"Appearance",defaultValue:false},enableGridContainerQuery:{type:"boolean",group:"Appearance",defaultValue:false},enableResetButton:{type:"boolean",group:"Behavior",defaultValue:true},enableShowHideButton:{type:"boolean",group:"Behavior",defaultValue:true},enableVisualizationReordering:{type:"boolean",group:"Behavior",defaultValue:false},noVisualizationsText:{type:"string",group:"Appearance",defaultValue:r.i18n.getText("Section.NoVisualizationsText")},title:{type:"string",group:"Appearance",defaultValue:""},showNoVisualizationsText:{type:"boolean",group:"Behavior",defaultValue:false},showSection:{type:"boolean",group:"Misc",defaultValue:true},showLinks:{type:"boolean",group:"Behavior",defaultValue:true},sizeBehavior:{type:"sap.m.TileSizeBehavior",group:"Misc",defaultValue:T.Responsive},_duringDrag:{type:"boolean",group:"Behavior",defaultValue:false}},defaultAggregation:"visualizations",aggregations:{visualizations:{type:"sap.ui.core.Control",bindable:"bindable",multiple:true},defaultItems:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--defaultArea",aggregation:"items",forwardBinding:false},dnd:true},flatItems:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--flatArea",aggregation:"items",forwardBinding:false},dnd:true},compactItems:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--compactArea",aggregation:"items",forwardBinding:false},dnd:true}},events:{add:{},delete:{},reset:{},titleChange:{},visualizationDrop:{parameters:{draggedControl:{type:"sap.ui.core.Control"},droppedControl:{type:"sap.ui.core.Control"},dropPosition:{type:"string"}}},areaDragEnter:{parameters:{originalEvent:{type:"sap.ui.base.Event"},dragControl:{type:"sap.ui.core.Control"},sourceArea:{type:"string"},targetArea:{type:"string"}}},sectionVisibilityChange:{parameters:{visible:{type:"boolean"}}},borderReached:{parameters:{event:{type:"jQuery.Event"}}}}},resourceModel:r.i18nModel});function g(C){for(var s in D){if(C.displayFormatHint===D[s]){return D[s];}}if(C.displayFormatHint&&C.displayFormatHint!=="tile"){L.error("DisplayFormat '"+C.displayFormatHint+"' not valid - 'standard' is used");}return D.Standard;}function b(){return new F({path:"",caseSensitive:true,test:function(C){var s=g(C);return s===D.Standard||s===D.StandardWide;}});}function e(){return new F({path:"",caseSensitive:true,test:function(C){var s=g(C);return s===D.Flat||s===D.FlatWide;}});}function f(){return new F({path:"",caseSensitive:true,test:function(C){return g(C)===D.Compact;}});}S.prototype.bindAggregation=function(A,B){if(A==="visualizations"){if(B.filters){L.error("bind visualizations with pre-existing filters is not implemented.");}var o=d(B);o.filters=b();X.prototype.bindAggregation.call(this,"defaultItems",o);var h=d(B);h.filters=e();X.prototype.bindAggregation.call(this,"flatItems",h);var l=d(B);l.filters=f();X.prototype.bindAggregation.call(this,"compactItems",l);}else{X.prototype.bindAggregation.call(this,A,B);}return this;};S.prototype.getAllItems=function(){return this.getDefaultItems().concat(this.getFlatItems(),this.getCompactItems());};S.prototype.getVisualizations=function(){var v=this.getAllItems();v.sort(function(V,o){var p=V.getBindingContext().getPath();var i=parseInt(p.split("/").pop(),10);p=o.getBindingContext().getPath();var h=parseInt(p.split("/").pop(),10);return i<h?-1:1;});return v;};S.prototype.filterVisualizations=function(o){var h=o?new F({filters:[b(),o],and:true}):b();var i=o?new F({filters:[e(),o],and:true}):e();var C=o?new F({filters:[f(),o],and:true}):f();this.getBinding("defaultItems").filter(h);this.getBinding("flatItems").filter(i);this.getBinding("compactItems").filter(C);};S.prototype.indexOfVisualization=function(v){return this.getVisualizations().indexOf(v);};S.prototype.addVisualization=function(v,s){L.error("Section.prototype.addVisualization should not be called");return this.addAggregation("visualizations",v,s);};S.prototype.insertVisualization=function(v,i,s){L.error("Section.prototype.insertVisualization should not be called");return this.insertAggregation("visualizations",v,i,s);};S.prototype.removeVisualization=function(v,s){L.error("Section.prototype.removeVisualization should not be called");return this.removeAggregation("visualizations",v,s);};S.prototype.onBorderReached=function(o){var O=o.getParameter("event"),k=O.keyCode,t=O.type,i=q(O.target.firstElementChild).control(0),v;switch(k){case K.ARROW_UP:v=this.getClosestVizualization(i,true);break;case K.ARROW_DOWN:v=this.getClosestVizualization(i,false);break;case K.ARROW_LEFT:v=this._getPreviousViz(i);break;case K.ARROW_RIGHT:v=this._getNextViz(i);break;default:break;}if(v){this._focusItem(this.getItemPosition(v));O.preventDefault();}else{this.fireBorderReached({event:o,section:this,direction:t==="sapnext"?"down":"up"});}};S.prototype._getNextViz=function(v){var V=this.getAllItems();var i=V.indexOf(v);return i===-1?V[0]:V[i+1];};S.prototype._getPreviousViz=function(v){var V=this.getAllItems();var i=V.indexOf(v);return i===-1?V[V.length-1]:V[i-1];};S.prototype.handleEmptyContentAreas=function(){var h=!!this.getDefaultItems().length,i=!!this.getFlatItems().length,C=!!this.getCompactItems().length,s=!h&&!C&&!i;this.oVBox.toggleStyleClass("sapUshellSectionNoVisualizations",s);this.oDefaultArea.toggleStyleClass("sapUshellSectionDefaultArea",h);this.oFlatArea.toggleStyleClass("sapUshellSectionFlatArea",i);var v=this.oVBox.getDomRef&&this.oVBox.getDomRef();if(v&&this.getEditable()&&this.getShowNoVisualizationsText()&&s){v.setAttribute("aria-describedBy",this.byId("noVisualizationsText").getId());}else if(v){v.removeAttribute("aria-describedBy");}};S.prototype.init=function(){this.oVBox=this.byId("content");this.oDefaultArea=this.byId("defaultArea");this.oFlatArea=this.byId("flatArea");this.oCompactArea=this.byId("compactArea");this.oNoVisualizationsText=this.byId("noVisualizationsText");this.oCompactArea.setVisible(true);var A=function(){var v=this.oVBox.getDomRef();if(v){var s;if(this.getTitle().trim()){s=r.i18n.getText("Section.Description",this.getTitle());}else{s=r.i18n.getText("Section.Description.EmptySectionTitle");}v.setAttribute("aria-label",s);}}.bind(this);this.oVBox.addEventDelegate({onBeforeRendering:function(){this.byId("title-edit").detachChange(A);}.bind(this),onAfterRendering:function(){var v=this.oVBox.getDomRef();if(this.getEditable()){v.setAttribute("tabindex","0");}A();v.setAttribute("role","group");this.byId("title-edit").attachChange(A);}.bind(this)});this.oDefaultArea.addEventDelegate({onAfterRendering:this.handleEmptyContentAreas.bind(this)});this.oFlatArea.addEventDelegate({onAfterRendering:this.handleEmptyContentAreas.bind(this)});this.oCompactArea.addEventDelegate({onAfterRendering:this.handleEmptyContentAreas.bind(this)});this.oDefaultArea.attachBorderReached(this.onBorderReached.bind(this));this.oFlatArea.attachBorderReached(this.onBorderReached.bind(this));this.oCompactArea.attachBorderReached(this.onBorderReached.bind(this));this._oInvisibleMessageInstance=I.getInstance();this._oDefaultItemsChangeDetection=new E("defaultItems",this,["flatItems","compactItems"]);this._oFlatItemsChangeDetection=new E("flatItems",this,["defaultItems","compactItems"]);this._oCompactItemsChangeDetection=new E("compactItems",this,["defaultItems","flatItems"]);this._fnGlobalDragStart=function(){this.setProperty("_duringDrag",true);}.bind(this);this._fnGlobalDragEnd=function(){this.setProperty("_duringDrag",false);}.bind(this);document.addEventListener("dragstart",this._fnGlobalDragStart,false);document.addEventListener("dragend",this._fnGlobalDragEnd,false);};S.prototype.destroy=function(){X.prototype.destroy.apply(this,arguments);this._oDefaultItemsChangeDetection.destroy();this._oFlatItemsChangeDetection.destroy();this._oCompactItemsChangeDetection.destroy();document.removeEventListener("dragstart",this._fnGlobalDragStart,false);document.removeEventListener("dragend",this._fnGlobalDragEnd,false);if(this.oCompactItemsNavigation){this.oCompactArea.removeDelegate(this.oCompactItemsNavigation);this.oCompactItemsNavigation.destroy();this.oCompactItemsNavigation=null;}if(this._oInvisibleMessageInstance){this._oInvisibleMessageInstance.destroy();}X.prototype.destroy.apply(this,arguments);};S.prototype.setEditable=function(v){if(v===undefined||this.getEditable()===v){return this;}else{this.setProperty("editable",!!v,true);this.oVBox.toggleStyleClass("sapUshellSectionEdit",!!v);return this;}};S.prototype._showHidePressed=function(v){var M=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oInvisibleMessageInstance.announce([r.i18n.getText(v?"Section.nowBeingShown":"Section.nowBeingHidden"),r.i18n.getText("Section.ButtonLabelChanged"),r.i18n.getText(v?"Section.Button.Hide":"Section.Button.Show"),M.getText("ACC_CTR_TYPE_BUTTON")].join(" "),a.Polite);this.setShowSection(v);};S.prototype.setShowSection=function(v){if(v===undefined||this.getShowSection()===v){return this;}else{this.setProperty("showSection",v,true);this.oVBox.toggleStyleClass("sapUshellSectionHidden",!v);this.fireSectionVisibilityChange({visible:v});return this;}};S.prototype._reorderVisualizations=function(i){this.fireVisualizationDrop(i.getParameters());};S.prototype.getClosestVizualization=function(R,A){var v=this.getAllItems();return _(R,v,A);};S.prototype.getClosestVizIndex=function(o,A){var v=this.getClosestVizualization(o,A);return v?this.indexOfVisualization(v):-1;};S.prototype.getClosestCompactItemIndex=function(o,A){var n=_(o,this.getCompactItems(),A);if(n){return this.indexOfVisualization(n);}return A?this.getVisualizations().length:0;};S.prototype._onDragEnter=function(o){var h=o.getParameter("dragSession");var i=h.getDragControl();var s=i.getParent();var t=h.getDropControl&&h.getDropControl();if(!t){return;}if(!t.data("area")){t=t.getParent();}if(t.data("default")&&!s.data("default")){o.preventDefault();}this.fireAreaDragEnter({originalEvent:o,dragControl:i,sourceArea:s.data("area"),targetArea:t.data("area")});};S.prototype.addAggregation=function(A,o){if(A==="defaultItems"||A==="flatItems"){this._addVisualizationLayoutData(o);}X.prototype.addAggregation.apply(this,arguments);this.handleEmptyContentAreas();return this;};S.prototype.insertAggregation=function(A,o){if(A==="defaultItems"||A==="flatItems"){this._addVisualizationLayoutData(o,A);}X.prototype.insertAggregation.apply(this,arguments);this.handleEmptyContentAreas();return this;};S.prototype._getVisualizationLayoutData=function(v){if(v.getLayout){return v.getLayout();}return{rows:2,columns:2};};S.prototype._getFlatVisualizationLayoutData=function(v){if(v.getLayout){return v.getLayout();}return{rows:1,columns:2};};S.prototype._addVisualizationLayoutData=function(v,A){if(!v.getLayoutData()){var l=A==="defaultItems"?this._getVisualizationLayoutData(v):this._getFlatVisualizationLayoutData(v);v.setLayoutData(new G(l));}};S.prototype._getDefaultDropIndicatorSize=function(v){return this._getDropIndicatorSize(v,D.Standard);};S.prototype._getFlatDropIndicatorSize=function(v){return this._getDropIndicatorSize(v,D.Flat);};S.prototype._getDropIndicatorSize=function(v,t){var p=v.getParent();var s=p&&p.data("area");if(t===s&&v.getLayoutData){var l=v.getLayoutData();return{rows:l.getRows(),columns:l.getColumns()};}var o={};if(t===D.Flat){o.rows=1;o.columns=2;}else{o.rows=2;o.columns=2;}return o;};S.prototype.getItemPosition=function(v){if(isFinite(v)){v=this.getVisualizations()[v];}var i=this.oDefaultArea.getItems().indexOf(v);if(i>=0){return{index:i,area:D.Standard};}i=this.oFlatArea.getItems().indexOf(v);if(i>=0){return{index:i,area:D.Flat};}i=this.oCompactArea.getItems().indexOf(v);if(i>=0){return{index:i,area:D.Compact};}return{index:-1,area:D.Standard};};S.prototype._focusItem=function(p){window.setTimeout(function(){var h=p&&p.area?p.area:D.Standard;var i=p&&p.index?p.index:p;var n=this.oDefaultArea.getItems().length;var j=this.oFlatArea.getItems().length;var k=this.oCompactArea.getItems().length;if(isNaN(i)||i<0){i=0;}if(h===D.Standard&&n===0){h=D.Flat;}if(h===D.Flat&&j===0){h=D.Compact;}if(h===D.Compact&&k===0){h=D.Standard;}if(n+j+k===0){h="section";}switch(h){case"section":this.focus();break;case D.Flat:if(i>=j){i=j-1;}this.oFlatArea.focusItem(i);break;case D.Compact:this.oCompactArea.focusItem(i);break;default:if(i>=n){i=n-1;}this.oDefaultArea.focusItem(i);break;}}.bind(this),0);};S.prototype.focusVisualization=function(i){var v;if(!this.getShowSection()&&!this.getEditable()){return false;}var V=this.getAllItems();if(!V.length){return false;}if(i&&i.area){this._focusItem(i);return true;}if(i&&i.getMetadata){v=i;}if(!v&&i&&i.keycode){switch(i.keycode){case K.ARROW_UP:v=this.getClosestVizualization(i.ref,true);break;case K.ARROW_DOWN:v=this.getClosestVizualization(i.ref,false);break;case K.ARROW_LEFT:i=-1;break;default:break;}}if(!v&&i===-1){v=V[V.length-1];}if(!v){v=V[0];}this._focusItem(this.getItemPosition(v));return true;};return S;});
