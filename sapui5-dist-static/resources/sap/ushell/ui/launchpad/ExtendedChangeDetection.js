// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/ManagedObject","sap/ushell/Config"],function(M,C){"use strict";var E=M.extend("sap.ushell.ui.launchpad.ExtendedChangeDetection",{metadata:{library:"sap.ushell",events:{itemDeleted:{},itemAdded:{},itemsReordered:{}}},constructor:function(a,c,s){M.call(this);this._oAggregation=c.getMetadata().getAggregation(a);this._oControl=c;this._sAggregationName=a;this._aSiblingAggregationNames=s;var e=C.last("/core/spaces/extendedChangeDetection/enabled");if(e){this._oControl[this._oAggregation._sUpdater]=this._updateAggregation.bind(this);this._oControl.bUseExtendedChangeDetection=true;}}});E.oUpdateFromSiblingCache={};E.prototype._updateAggregation=function(){var b=this._oControl.getBindingInfo(this._sAggregationName);var B=b.binding;var u=this._isUpdateFromSibiling();var l=B.aLastContextData||[];var L=l.map(function(s){try{var h=JSON.parse(s);return h[b.key];}catch(j){return s;}});var c=B.getContexts();var a=c.map(function(h){return h.getProperty(b.key);});var d=c.diff;var D;var i;var I=[];var r=[];var R={};var e=false;var f=false;if(d){for(i=0;i<d.length;i++){D=d[i];if(D.type==="insert"){I.push({item:a[D.index],index:D.index});}if(D.type==="delete"){r.push({item:L[D.index-I.length],index:D.index-I.length});L.splice(D.index-I.length,1);}}for(i=0;i<r.length;i++){R[r[i].item]=this._oControl.removeAggregation(this._sAggregationName,r[i].index,true);}var o;var g;for(i=0;i<I.length;i++){o=I[i];g=R[o.item];if(g&&!(d.length>=2&&d[0].index===d[1].index)){this._oControl.insertAggregation(this._sAggregationName,g,o.index,true);delete R[o.item];}else{this._createAndInsertItem(c[o.index],b,o.index);f=true;}}e=!!Object.keys(R).length;for(var k in R){R[k].destroy();delete R[k];}}else if(!(u&&a.length===0&&L.length===0)){this._createAndInsertItems(c,b);f=true;}else{return;}this._updateBindingContexts(c);if(c.length===0){this._oControl.invalidate();}if(e){this.fireItemDeleted();}if(f){this.fireItemAdded();}if(!e&&!f&&d){this.fireItemsReordered();}if(d&&d.length&&!u){this._refreshSiblingBindings();}};E.prototype._isUpdateFromSibiling=function(){var i=this._oControl.getId()+":"+this._sAggregationName;if(E.oUpdateFromSiblingCache[i]){delete E.oUpdateFromSiblingCache[i];return true;}return false;};E.prototype._refreshSiblingBindings=function(){if(this._aSiblingAggregationNames){for(var i=0;i<this._aSiblingAggregationNames.length;++i){var s=this._aSiblingAggregationNames[i];var S=this._oControl.getId()+":"+s;var o=this._oControl.getBinding(s);E.oUpdateFromSiblingCache[S]=true;o.refresh(true);}}};E.prototype._createAndInsertItems=function(c,b){this._oAggregation.destroy(this._oControl);for(var i=0;i<c.length;i++){this._createAndInsertItem(c[i],b,i);}};E.prototype._createAndInsertItem=function(c,b,i){var I=b.factory(null,c);this._oControl.insertAggregation(this._sAggregationName,I,i,true);};E.prototype._updateBindingContexts=function(c){var I=this._oAggregation.get(this._oControl);for(var i=0;i<I.length;i++){I[i].setBindingContext(c[i]);}};return E;});
