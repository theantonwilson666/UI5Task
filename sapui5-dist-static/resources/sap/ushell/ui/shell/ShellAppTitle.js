// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/m/Bar","sap/m/Button","sap/m/Label","sap/m/library","sap/m/Popover","sap/m/ResponsivePopover","sap/m/ToggleButton","sap/ui/core/IconPool","sap/ui/Device","sap/ushell/Config","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/ushell/resources","sap/ui/performance/Measurement","sap/ushell/services/AllMyApps"],function(l,B,a,L,m,P,R,T,I,D,C,A,r,M){"use strict";var b=l.AppTitleState;var c=l.AllMyAppsState;var d=m.PlacementType;var S=a.extend("sap.ushell.ui.shell.ShellAppTitle",{metadata:{associations:{navigationMenu:{type:"sap.ushell.ui.shell.ShellNavigationMenu"},allMyApps:{type:"sap.ui.core.mvc.ViewType.JS"}},events:{textChanged:{deprecated:true}}},renderer:{apiVersion:2,render:function(o,e){var v=e._getControlVisibilityAndState(),t=e.getText(),f=e.getModel();o.openStart("div",e);o.class("sapUshellAppTitle");if(v||D.system.phone){o.class("sapUshellAppTitleClickable");o.attr("tabindex","0");}if(e.getTooltip_AsString()){o.attr("title",e.getTooltip_AsString());}if(v){o.attr("role","button");o.attr("aria-haspopup","dialog");if(f&&S._getCurrentState()===b.AllMyAppsOnly){o.attr("aria-label",r.i18n.getText("ShowAllMyApps_AriaLabel",[t]));}else{o.attr("aria-label",r.i18n.getText("ShellNavigationMenu_AriaLabel",[t]));}}o.openEnd();o.openStart("h1");o.class("sapUshellHeadTitle");o.attr("aria-level","1");o.openEnd();o.text(t||"");o.close("h1");if(v&&t){o.openStart("div");o.class("sapUshellShellHeadAction");o.openEnd();o.openStart("span");o.class("sapUshellShellHeadActionImg");o.openEnd();o.renderControl(e.oIcon);o.close("span");o.close("div");}o.close("div");}}});S.prototype.init=function(){a.prototype.init.apply(this,arguments);this.oIcon=I.createControlByURI(I.getIconURI("megamenu"));this.oIcon.addStyleClass("sapUshellAppTitleMenuIcon");if(D.system.desktop){this.addEventDelegate({onkeydown:function(e){if(e.altKey&&e.keyCode===40){this.onclick(e);}}.bind(this)});}};S._getCurrentState=function(){return C.last("/core/shellHeader/ShellAppTitleState");};S.prototype.onclick=function(e){e.preventDefault();this.firePress();if(!this._getControlVisibilityAndState()){if(D.system.phone){window.hasher.setHash(C.last("/core/shellHeader/rootIntent"));}return;}if(S._getCurrentState()===b.AllMyAppsOnly){M.start("FLP:ShellAppTitle.onClick","Click ShellAppTitle in HOME state, Launching AllMyApps","FLP");this._openCloseAllMyAppsPopover();return;}this._openCloseNavMenuPopover();};S.prototype._openCloseAllMyAppsPopover=function(){if(!this.oAllMyAppsPopover){this.oAllMyAppsPopover=this._createAllMyAppsPopover();}if(this.oAllMyAppsPopover){if(this.oAllMyAppsPopover.isOpen()){this.oAllMyAppsPopover.close();}else{this.oAllMyAppsPopover.openBy(this);}}};S.prototype._openCloseNavMenuPopover=function(){if(!this.oNavMenuPopover){this.oNavMenuPopover=this._createNavMenuPopover();}this.getModel().setProperty("/ShellAppTitleState",b.ShellNavMenu);if(this.oNavMenuPopover.isOpen()){this.oNavMenuPopover.close();}else{this.oNavMenuPopover.openBy(this);}if(this.oNavMenuPopover.getFooter()){var s=C.last("/core/shell/model/currentState/stateName");this.oNavMenuPopover.getFooter().setVisible(s==="home"||s==="app");}};S.prototype._getControlVisibilityAndState=function(){M.start("FLP:ShellAppTitle.getControlVisibilityAndState","Check AllMyApps and NavShellMenu visibility","FLP");var o=this.getModel(),s=C.last("/core/shell/model/currentState/stateName"),n=this._isNavMenuEnabled(),v=n;if(!o){return false;}if(s==="app"||s==="home"){var e=sap.ushell.Container.getService("AllMyApps").isEnabled();v=e||n;if(e&&n){o.setProperty("/ShellAppTitleState",b.ShellNavMenu);}else if(!e&&n){o.setProperty("/ShellAppTitleState",b.ShellNavMenuOnly);}else if(e&&!n){o.setProperty("/ShellAppTitleState",b.AllMyAppsOnly);}}else{o.setProperty("/ShellAppTitleState",b.ShellNavMenuOnly);}M.end("FLP:ShellAppTitle.getControlVisibilityAndState");return v;};S.prototype._createAllMyAppsPopover=function(){var o=sap.ui.getCore().byId(this.getAllMyApps());if(!o){return null;}var e=new R("sapUshellAllMyAppsPopover",{placement:d.Bottom,title:"",showArrow:true,customHeader:this._getPopoverHeader(),showHeader:{path:"/ShellAppTitleState",formatter:function(f){return f!==b.ShellNavMenu;}},content:[o]}).addStyleClass("sapContrastPlus");e.setModel(this.getModel());e.addStyleClass("sapUshellAppTitleAllMyAppsPopover");e.attachAfterOpen(function(){o.getController()._afterOpen();var h=e.getCustomHeader(),f=h.getContentLeft()[0],t=h.getContentLeft()[1];if(t.getVisible()){t.firePress();t.setPressed(true);}f.focus();});e.attachAfterClose(function(){this._bPressedSpace=false;}.bind(this));return e;};S.prototype._createNavMenuPopover=function(){var n=sap.ui.getCore().byId(this.getNavigationMenu());var N=new P("sapUshellAppTitlePopover",{placement:d.Bottom,title:"",showArrow:true,showHeader:{path:"/ShellAppTitleState",formatter:function(o){return o!==b.ShellNavMenu;}},contentWidth:"20rem",content:n}).addStyleClass("sapContrastPlus");if(sap.ushell.Container.getService("AllMyApps").isEnabled()){N.setFooter(this._getPopoverFooterContent());}N.addStyleClass("sapUshellAppTitleNavigationMenuPopover");N.setModel(this.getModel());C.emit("/core/shell/model/allMyAppsMasterLevel",c.FirstLevel);N.attachBeforeOpen(function(){n._beforeOpen();});N.attachAfterOpen(function(){n.$().on("touchmove.scrollFix",function(e){e.stopPropagation();});n._afterOpen();});N.attachAfterClose(function(){this._bPressedSpace=false;}.bind(this));return N;};S.prototype._getPopoverHeader=function(){var o=new L({text:r.i18n.getText("allMyApps_headerTitle")});this.addCustomData(o,"role","heading");this.addCustomData(o,"aria-level","2");var p=new B("sapUshellShellAppPopoverHeader",{contentLeft:[this._createPopoverBackButton(),this._createPopoverToggleButton()],contentMiddle:[o]});return p;};S.prototype.onAfterRendering=function(){var s=sap.ui.getCore().byId("shell-header");if(s){s.refreshLayout();}};S.prototype._createPopoverBackButton=function(){var o=new a("sapUshellAppTitleBackButton",{icon:I.getIconURI("nav-back"),press:[this._popoverBackButtonPressHandler,this],tooltip:r.i18n.getText("backBtn_tooltip"),visible:this.getAllMyAppsController().getBackButtonVisible()});o.addStyleClass("sapUshellCatalogNewGroupBackButton");return o;};S.prototype._popoverBackButtonPressHandler=function(){var o=this.getAllMyAppsController(),e=o.getCurrentState();if((e===c.FirstLevel)||(e===c.FirstLevelSpread)){if(S._getCurrentState()!==b.AllMyAppsOnly){this.getModel().setProperty("/ShellAppTitleState",b.ShellNavMenu);this.oAllMyAppsPopover.close();this.oNavMenuPopover.openBy(this);}}else if(e===c.SecondLevel){o.switchToInitialState();}else{o.handleSwitchToMasterAreaOnPhone();}o.updateHeaderButtonsState();};S.prototype._createPopoverToggleButton=function(){var o=this.getAllMyAppsController();var t=new T("sapUshellAllMyAppsToggleListButton",{icon:I.getIconURI("sap-icon://menu2"),press:function(e){o.switchToInitialState();this.setTooltip(e.getParameter("pressed")?r.i18n.getText("ToggleButtonHide"):r.i18n.getText("ToggleButtonShow"));},tooltip:r.i18n.getText("ToggleButtonShow"),visible:o.getToggleListButtonVisible()});D.media.attachHandler(function(){t.setVisible(o.getToggleListButtonVisible());},this,D.media.RANGESETS.SAP_STANDARD);t.addStyleClass("sapUshellAllMyAppsToggleListButton");return t;};S.prototype._getPopoverFooterContent=function(){var t=this,o;o=new a("allMyAppsButton",{text:r.i18n.getText("allMyApps_launchingButtonTitle"),press:function(){t._openCloseAllMyAppsPopover();if(t.oAllMyAppsPopover){M.start("FLP:ShellNavMenu.footerClick","Click the footer of ShellNavMenu, Launching AllMyApps","FLP");t.getModel().setProperty("/ShellAppTitleState",b.AllMyApps);t.oNavMenuPopover.close();}},visible:{path:"/ShellAppTitleState",formatter:function(e){return e===b.ShellNavMenu;}}});var p=new B("shellpopoverFooter",{contentMiddle:[o]});this.addCustomData(o,"role","button");this.addCustomData(o,"aria-label",r.i18n.getText("allMyApps_launchingButtonTitle"));return p;};S.prototype._isNavMenuEnabled=function(){var n=sap.ui.getCore().byId(this.getNavigationMenu());return n?n.getItems()&&n.getItems().length>0:false;};S.prototype.addCustomData=function(i,k,v){i.addCustomData(new A({key:k,value:v,writeToDom:true}));};S.prototype.close=function(){if(this.oNavMenuPopover&&this.oNavMenuPopover.isOpen()){this.oNavMenuPopover.close();}if(this.oAllMyAppsPopover&&this.oAllMyAppsPopover.isOpen()){this.oAllMyAppsPopover.close();}};S.prototype.setTooltip=function(t){this.setAggregation("tooltip",t);this.oIcon.setTooltip(t);};S.prototype.getAllMyAppsController=function(){var o=sap.ui.getCore().byId(this.getAllMyApps());return o.getController();};S.prototype.onsapspace=S.prototype.onclick;S.prototype.onsapenter=S.prototype.onclick;S.prototype.exit=function(){var n=sap.ui.getCore().byId(this.getNavigationMenu()),o=sap.ui.getCore().byId(this.getAllMyApps());if(n){n.destroy();}if(o){o.destroy();}if(this.oAllMyAppsPopover){this.oAllMyAppsPopover.destroy();}if(this.oNavMenuPopover){this.oNavMenuPopover.destroy();}if(this.oIcon){this.oIcon.destroy();}};return S;},true);
