// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/base/Log","sap/ushell/utils","sap/ushell/URLTemplateProcessor","sap/ushell/_ApplicationType/utils","sap/ushell/_ApplicationType/systemAlias","sap/ushell/_ApplicationType/wdaResolution","sap/ushell/_ApplicationType/guiResolution","sap/ushell/services/_ClientSideTargetResolution/ParameterMapping","sap/ushell/Config"],function(U,L,u,a,A,s,w,g,p,C){"use strict";function b(B,D,E){var I=B.inbound;var R=I&&I.resolutionResult;if(!(!I||!R||!(R["sap.wda"]))){return w.constructFullWDAResolutionResult(B,D,E);}if(!(!I||!R)){return w.constructWDAResolutionResult(B,D,E);}return undefined;}function c(B,D,E){var F=new U(D),I=B.inbound,G=I&&I.resolutionResult,H=jQuery.extend(true,{},B.mappedIntentParamsPlusSimpleDefaults),S,J;if(H["sap-system"]){S=H["sap-system"][0];delete H["sap-system"];}if(H["sap-system-src"]){J=H["sap-system-src"][0];delete H["sap-system-src"];}return new Promise(function(R,K){s.spliceSapSystemIntoURI(F,G.systemAlias,S,J,"WCF",G.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,E).done(function(N){var P=A.getURLParsing().paramsToString(H),O=A.appendParametersToUrl(P,N.toString());var Q={url:O,text:G.text||"",additionalInformation:G.additionalInformation||"",applicationType:"WCF",fullWidth:true};R(Q);}).fail(function(N){K(N);});});}function d(B,D,E){var I=B.inbound,F,S,G,H,R={};["applicationType","additionalInformation","applicationDependencies"].forEach(function(P){if(I.resolutionResult.hasOwnProperty(P)){R[P]=I.resolutionResult[P];}});R.url=D;if(R.applicationDependencies&&typeof R.url==="undefined"){R.url="";}if(typeof R.url==="undefined"){return Promise.reject("Cannot resolve intent: url was not specified in matched inbound");}H=jQuery.extend(true,{},B.mappedIntentParamsPlusSimpleDefaults);R.reservedParameters={};var J={"sap-ui-fl-max-layer":true,"sap-ui-fl-control-variant-id":true,"sap-ui-fl-version":true};Object.keys(J).forEach(function(N){var V=H[N];if(V){delete H[N];R.reservedParameters[N]=V;}});B.mappedDefaultedParamNames=B.mappedDefaultedParamNames.filter(function(K){return!J[K];});if(B.mappedDefaultedParamNames.length>0){H["sap-ushell-defaultedParameterNames"]=[JSON.stringify(B.mappedDefaultedParamNames)];}S=H["sap-system"]&&H["sap-system"][0];G=H["sap-system-src"]&&H["sap-system-src"][0];R["sap-system"]=S;if(typeof G==="string"){R["sap-system-src"]=G;}B.effectiveParameters=H;F=A.getURLParsing().paramsToString(H);if(F){R.url=R.url+((R.url.indexOf("?")<0)?"?":"&")+F;}if(typeof I.resolutionResult.ui5ComponentName!=="undefined"){R.ui5ComponentName=I.resolutionResult.ui5ComponentName;}R.text=I.title;return Promise.resolve(R);}function e(){var H=new U().fragment();var B=H.lastIndexOf("&/");if(B>0){return H.substr(B+1);}return undefined;}function f(B){var D=B.targetNavigationMode;if(D===undefined||D===""){D="inplace";}return D;}function h(){var H=window.hasher&&window.hasher.getHash(),K="",P;if(H&&H.length>0&&H.indexOf("sap-iapp-state=")>0){P=/(?:sap-iapp-state=)([^&/\\]+)/.exec(H);if(P&&P.length===2){K=P[1];}}return K;}function i(){var S=sap.ushell.Container.getService("PluginManager");if(S){return S._getNamesOfPluginsWithAgents();}return"";}function j(){var B=sap.ushell.Container.getService("UserInfo");var D=B.getUser();var E=sap.ui.getCore().getConfiguration();var F=u.getUi5Version();var G=D.getContentDensity();var T=D.getTheme();if(T.indexOf("sap_")!==0){var H=sap.ushell.User.prototype.constants.themeFormat.THEME_NAME_PLUS_URL;T=D.getTheme(H);}var I;var J;if(E){J=E.getLanguage&&E.getLanguage();I=E.getSAPLogonLanguage&&E.getSAPLogonLanguage();}var K=window.location.protocol+"//"+window.location.host+"/comsapuitheming.runtime/themeroot/v1";var N=0;if(C.last("/core/shell/sessionTimeoutIntervalInMinutes")>0){N=C.last("/core/shell/sessionTimeoutIntervalInMinutes");}return{language:J,logonLanguage:I,theme:T,themeServiceRoot:K,isDebugMode:!!window["sap-ui-debug"],ui5Version:F,contentDensity:G,sapPlugins:i(),innerAppState:h(),sessionTimeout:N};}function k(B){var I;switch(B){case"inplace":I="embedded";break;case"explace":I="newWindow";break;default:I=B||"newWindow";}return I;}function l(T,S){var B=k(T);var D=u.getMember(S,"sap|integration.navMode");switch(D){case"inplace":return"embedded";case"explace":if(B==="embedded"){return"newWindowThenEmbedded";}if(["newWindowThenEmbedded","newWindow"].indexOf(B)>=0){return B;}L.error("App-defined navigation mode was ignored","Application requests to be opened in a new window but no expected navigation mode was defined on the template","sap.ushell.ApplicationType");default:return B;}}function m(T,S,I){var B=u.clone(T);B.navigationMode=l(T.navigationMode,S);B.appId=I(T.appId||"");B.technicalAppComponentId=I(T.technicalAppComponentId||"");B.appSupportInfo=S["sap.app"]&&S["sap.app"].ach;B.appFrameworkId=T.appFrameworkId;return B;}function n(S,B,D){var I={appParams:{},system:undefined},E;if(D.mappedIntentParamsPlusSimpleDefaults){I.appParams=JSON.parse(JSON.stringify(D.mappedIntentParamsPlusSimpleDefaults));}E=u.getMember(B,"sap|app.destination");if(typeof E==="string"&&E.length>0){I.system=S.systemAliases[E]&&JSON.parse(JSON.stringify(S.systemAliases[E]));if(typeof I.system==="object"){I.system.alias=E;}}return I;}function o(B){return new Promise(function(R,D){var E=new U(B);var P=E.query(true);sap.ushell.Container.getService("ShellNavigation").compactParams(P,["sap-language","sap-theme","sap-shell","sap-ui-app-id","transaction","sap-iframe-hint"],undefined,true).done(function(F){if(!F.hasOwnProperty("sap-intent-param")){R(B);return;}E.query(F);var G=E.toString();R(G);}).fail(function(F){D(F);});});}function q(R){if(R.appCapabilities.appFrameworkId){var H=R.url.indexOf("#"),B=R.url,D="";if(H>0){B=R.url.slice(0,H);D=R.url.slice(H);}R.url=B+(B.indexOf("?")>=0?"&":"?")+"sap-iframe-hint="+R.appCapabilities.appFrameworkId+D;}}function r(B,D,E){var I=B.inbound;var T=I.templateContext;var R={innerAppRoute:e()||B.parsedIntent.appSpecificRoute,targetNavMode:f(B),defaultParameterNames:B.mappedDefaultedParamNames,startupParameter:B.mappedIntentParamsPlusSimpleDefaults,env:j()};var F=a.expand(T.payload,T.site,R,T.siteAppSection,"startupParameter");var G=function(J){var P=u.clone(T.payload);P.urlTemplate=J;return a.expand(P,T.site,R,T.siteAppSection,"startupParameter");};var H={applicationType:"URL",text:I.title,appCapabilities:m(T.payload.capabilities||{},T.siteAppSection,G),url:F,extendedInfo:n(T.site,T.siteAppSection,B),contentProviderId:I.contentProviderId||"",systemAlias:(T.siteAppSection["sap.app"]&&T.siteAppSection["sap.app"].destination)||T.siteAppSection.destination||""};q(H);return o(H.url).then(function(J){H.url=J;return H;},function(){return H;});}function t(B,D,E){var I=B.inbound,F=I&&I.resolutionResult,R={};var G=new U(D);var H=jQuery.extend(true,{},B.mappedIntentParamsPlusSimpleDefaults);if(B.inbound&&B.inbound.action==="launchURL"&&B.inbound.semanticObject==="Shell"){delete H["sap-external-url"];}var S=H["sap-system"]&&H["sap-system"][0];var J=H["sap-system-src"]&&H["sap-system-src"][0];R["sap-system"]=S;delete H["sap-system"];if(typeof J==="string"){R["sap-system-src"]=J;delete H["sap-system-src"];}return(new Promise(function(K,N){if(A.absoluteUrlDefinedByUser(G,F.systemAlias,F.systemAliasSemantics)){K(D);}else{s.spliceSapSystemIntoURI(G,F.systemAlias,S,J,"URL",F.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,E).fail(N).done(function(O){var P=O.toString();K(P);});}})).then(function(K){var P=A.getURLParsing().paramsToString(H);var N=C.last("/core/navigation/flpURLDetectionPattern");var O=new RegExp(N);return O.test(K)?A.appendParametersToIntentURL(H,K):A.appendParametersToUrl(P,K);},Promise.reject.bind(Promise)).then(function(K){["additionalInformation","applicationDependencies","systemAlias"].forEach(function(P){if(I.resolutionResult.hasOwnProperty(P)){R[P]=I.resolutionResult[P];}});R.url=K;R.text=I.title;R.applicationType="URL";return Promise.resolve(R);},Promise.reject.bind(Promise));}var v={URL:{type:"URL",defaultFullWidthSetting:true,generateResolutionResult:function(B){var D=B.inbound.hasOwnProperty("templateContext");return D?r.apply(null,arguments):t.apply(null,arguments);},easyAccessMenu:{intent:"Shell-startURL",resolver:null,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:false,systemSelectionPriority:1}},WDA:{type:"WDA",defaultFullWidthSetting:true,generateResolutionResult:b,easyAccessMenu:{intent:"Shell-startWDA",resolver:w.resolveEasyAccessMenuIntentWDA,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:2}},TR:{type:"TR",defaultFullWidthSetting:true,generateResolutionResult:g.generateTRResolutionResult,easyAccessMenu:{intent:"Shell-startGUI",resolver:g.resolveEasyAccessMenuIntentWebgui,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:3}},NWBC:{type:"NWBC",defaultFullWidthSetting:true},WCF:{type:"WCF",generateResolutionResult:c,defaultFullWidthSetting:true},SAPUI5:{type:"SAPUI5",generateResolutionResult:d,defaultFullWidthSetting:false}};function x(){return Object.keys(v).map(function(B){return v[B];}).filter(function(B){return typeof B.easyAccessMenu==="object";});}function y(){var E={};x().forEach(function(B){E[B.easyAccessMenu.intent]=B.easyAccessMenu.resolver;});return function(B,R){if(E[B]&&(!R||R!=="SAPUI5")){return E[B];}return null;};}function z(B){if(!v[B]){return false;}return v[B].defaultFullWidthSetting;}Object.defineProperty(v,"enum",{value:Object.keys(v).reduce(function(B,D){if(v[D].type){B[D]=v[D].type;}return B;},{})});var M={getEasyAccessMenuResolver:y(),getEasyAccessMenuDefinitions:x,getDefaultFullWidthSetting:z};Object.keys(M).forEach(function(B){Object.defineProperty(v,B,{value:M[B]});});return v;},true);
