// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/ushell/utils"],function(U,u){"use strict";var H=function(b,d){this._oOngoingRequests={};this._oCSRFTokens={};this._oDefaultOptions={headers:d&&d.headers||{}};if(typeof b==="string"){this._oBasePath=new U(b);}else{this._oDefaultOptions={headers:b&&b.headers||{}};}};H.prototype.get=function(r,o){return this._executeRequest("GET",r,o);};H.prototype.put=function(r,o){return this._executeRequest("PUT",r,o);};H.prototype.post=function(r,o){return this._executeRequest("POST",r,o);};H.prototype.patch=function(r,o){return this._executeRequest("PATCH",r,o);};H.prototype.delete=function(r,o){return this._executeRequest("DELETE",r,o);};H.prototype.options=function(r,o){return this._executeRequest("OPTIONS",r,o);};H.prototype.abortAll=function(){Object.keys(this._oOngoingRequests).forEach(function(k){this._oOngoingRequests[k].abort();}.bind(this));};H.prototype._executeRequest=function(r,R,d){var i=new Error("The provided resource path is not a valid URL.");try{var c;var o=new U(R);if(!o.is("url")){return Promise.reject(i);}if(this._oBasePath){c=o.absoluteTo(this._oBasePath);}else{c=o;}var x=new XMLHttpRequest();x._sapUshellHttpClientId=u.generateUniqueId(Object.keys(this._oOngoingRequests));this._oOngoingRequests[x._sapUshellHttpClientId]=x;var h=Object.assign({},this._oDefaultOptions.headers,d&&d.headers);return this._getCSRFTokenHeader(r,c).then(function(C){Object.assign(h,C);return new Promise(function(a,b){var s=c.href();x.onload=this._onLoad.bind(this,a,b,{xhr:x,method:r,url:s,data:d});x.onerror=b.bind(this,this._getFormattedResponse(x));x.onabort=b.bind(this,this._getFormattedResponse(x));x.onloadend=function(){delete this._oOngoingRequests[x._sapUshellHttpClientId];}.bind(this);x.open(r,s);Object.keys(h).forEach(function(k){x.setRequestHeader(k,h[k]);});var B=d&&d.data||"";if(typeof B!=="string"){B=JSON.stringify(B);}x.send(B);}.bind(this));}.bind(this));}catch(e){return Promise.reject(i);}};H.prototype._getCSRFTokenHeader=function(r,a){switch(r){case"HEAD":case"GET":case"OPTIONS":return Promise.resolve({"x-csrf-token":"fetch"});case"POST":case"PATCH":case"PUT":case"DELETE":var k=this._getCSRFTokenKey(a);if(this._oCSRFTokens[k]){return Promise.resolve({"x-csrf-token":this._oCSRFTokens[k]});}var R=a.href();if(this._oBasePath){R=this._oBasePath.origin()+this._oBasePath.directory();}return this._executeRequest("OPTIONS",R).then(function(o){var c=this._getCSRFTokenFromHeader(o.responseHeaders);if(!c){throw new Error("CSRF Token couldn't be fetched.");}return{"x-csrf-token":c};}.bind(this));default:return Promise.resolve({});}};H.prototype._onLoad=function(r,R,o){var f=this._getFormattedResponse(o.xhr);var c=this._getCSRFTokenFromHeader(f.responseHeaders);if(c){var k=this._getCSRFTokenKey(new U(o.url));if(c.toLowerCase()==="required"&&f.status===403){delete this._oCSRFTokens[k];return this._executeRequest(o.method,o.url,o.data).then(r).catch(R);}this._oCSRFTokens[k]=c;}if(f.status>=200&&f.status<300){return r(f);}return R(f);};H.prototype._getCSRFTokenKey=function(c){if(this._oBasePath){return this._oBasePath.origin()+this._oBasePath.directory();}return c.origin()+c.directory();};H.prototype._getCSRFTokenFromHeader=function(r){var c=r.filter(function(h){return h.name==="x-csrf-token";})[0];return c&&c.value;};H.prototype._getFormattedResponse=function(x){return{status:x.status,statusText:x.statusText,responseText:x.responseText,responseHeaders:x.getAllResponseHeaders().split(/\r\n/g).filter(function(i){return i.length>0;}).map(function(h){var p=h.split(":");return{name:p[0].trim(),value:p[1].trim()};})};};return H;},true);
