/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","../utils/Constants","./ContextDataController","./PushClient","../ui/ShellBarButton","../ui/PopOverVisual","../ui/IFrameVisual","./WebAppFeedbackLoader","sap/ui/thirdparty/jquery"],function(O,C,a,P,S,b,I,W,$){"use strict";return O.extend("sap.feedback.ui.flpplugin.controller.PluginController",{_oConfig:null,_oContextDataController:null,_oPushClient:null,_oShellButton:null,_oDisplayFormat:null,_oWebAppFeedbackLoader:null,_fnRendererPromise:null,_oResourceBundle:null,constructor:function(c,r,R,s){this._oConfig=c;this._fnRendererPromise=r;this._oResourceBundle=R;this._oShellUIService=s;},init:function(){return new Promise(function(r,c){if(this._oConfig){this._initContextData();this._initPushChannel();this._initUI();this._initWebAppFeedback();this._updateInitialContextData().then(function(){r();});}else{c();}}.bind(this));},_initContextData:function(){this._oContextDataController=new a(this._oConfig,this._oShellUIService);return this._oContextDataController.init();},_initPushChannel:function(){if(this._oConfig.getIsPushEnabled()){this._oPushClient=new P(this._oConfig);this._oPushClient.init(this._onPushCallback.bind(this));}},_initUI:function(){var d=this._oConfig.getDisplayFormat();if(d){if(d===C.E_DISPLAY_FORMAT.popover){this._oVisual=new b();}else if(d===C.E_DISPLAY_FORMAT.iframe){this._oVisual=new I(this._oConfig,this._oResourceBundle);}if(this._oVisual){this._oShellButton=new S(this._fnRendererPromise,this._onSurveyShow.bind(this),this._oResourceBundle);this._oShellButton.init();}}},_initWebAppFeedback:function(){this._oWebAppFeedbackLoader=new W(this._oConfig);this._oWebAppFeedbackLoader.init(this._onAPILoadedCallback.bind(this));this._oWebAppFeedbackLoader.loadAPI();},_updateInitialContextData:function(){return this._oContextDataController.updateContextData(C.E_INTERCEPT_ID.ux);},_onAPILoadedCallback:function(){return this._oContextDataController.updateContextData(C.E_INTERCEPT_ID.ux).then(function(){this._getAppLifeCycleService().attachAppLoaded({},this._onAppLoaded,this);QSI.API.load().then(QSI.API.run());}.bind(this));},_getAppLifeCycleService:function(){return sap.ushell.Container.getService("AppLifeCycle");},_onPushCallback:function(e){return new Promise(function(r){if(this._oWebAppFeedbackLoader.getIsAPILoaded()){this._oContextDataController.updateContextData(C.E_INTERCEPT_ID.push,e).then(function(){this._openSurvey();r();}.bind(this));}else{r();}}.bind(this));},_openSurvey:function(){var h=$("#surveyTriggerButton");h.click();},_onSurveyShow:function(){return new Promise(function(r){if(this._oWebAppFeedbackLoader.getIsAPILoaded()){this._oContextDataController.updateContextData(C.E_INTERCEPT_ID.ux,null).then(function(){var d=this._oConfig.getDisplayFormat();if(d===C.E_DISPLAY_FORMAT.iframe){var u=this._oContextDataController.getContextDataAsUrlParameter();this._oVisual.show(u);r();}else{this._oVisual.show();r();}}.bind(this));}}.bind(this));},_onAppLoaded:function(){return this._oContextDataController.updateContextData(C.E_INTERCEPT_ID.ux).then(function(){if(this._oShellButton.updateButtonState()===C.E_SHELLBAR_BUTTON_STATE.restart){this._oWebAppFeedbackLoader.reloadIntercepts();}}.bind(this));}});});
