/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/Component","sap/ui/thirdparty/jquery","sap/base/Log","./utils/Constants","./data/Config","./utils/InitDetection","./controller/PluginController"],function(C,$,L,a,b,I,P){"use strict";return C.extend("sap.feedback.ui.flpplugin.Component",{metadata:{manifest:"json"},_oPluginController:null,_oShellUIService:null,_oConfig:null,init:function(){this._getShellUIService().then(function(s){this._oShellUIService=s;return this._setup();}.bind(this));},_setup:function(){return new Promise(function(r){this._oConfig=this._loadPluginConfig();if(this._oConfig){var q=this._oConfig.getQualtricsUri();if(q&&q.length>0){var t=this._oConfig.getTenantId();if(t&&t.length>0){this._validateIfInitializable(q).then(function(i){if(i){this._oConfig.setIsLibraryLoadable(i);this._startPluginController(this._oConfig).then(function(){r();},function(){L.error("Plugin Controller could not be initialized.",this._oConfig,a.S_PLUGIN_COMPONENT_NAME);r();}.bind(this));}}.bind(this),function(i){if(!i){this._oConfig.setIsLibraryLoadable(i);L.error("Unable to request feedback library.",this._oConfig,a.S_PLUGIN_COMPONENT_NAME);}r();}.bind(this));}else{L.error("Feedback config insufficient - tenant id missing.",this._oConfig,a.S_PLUGIN_COMPONENT_NAME);r();}}else{L.error("Feedback config insufficient - url missing.",this._oConfig,a.S_PLUGIN_COMPONENT_NAME);r();}}else{L.error("Feedback config could not be read.",this._oConfig,a.S_PLUGIN_COMPONENT_NAME);r();}}.bind(this));},_validateIfInitializable:function(q){var i=new I(q);return i.isUrlLoadable();},_loadPluginConfig:function(){if(this.getComponentData()){var p=this.getComponentData().config;var c=new b(p.qualtricsInternalUri,p.tenantId,a.E_DATA_FORMAT.version1);c.setTenantRole(p.tenantRole);if(p.isPushEnabled){c.setDataFormat(a.E_DATA_FORMAT.version2);c.setIsPushEnabled(p.isPushEnabled);if(c.getIsPushEnabled()&&p.pushChannelPath&&p.pushChannelPath.length>0){c.setPushChannelPath(p.pushChannelPath);}}if(p.productName){c.setProductName(p.productName);}if(p.platformType){c.setPlatformType(p.platformType);}return c;}return null;},_startPluginController:function(c){return new Promise(function(r,d){if(this._isDeviceDisplayFormatCombinationValid(c.getDisplayFormat())){var R=this.getModel("i18n").getResourceBundle();this._oPluginController=new P(c,this._getRenderer(),R,this._oShellUIService);this._oPluginController.init().then(function(){r();},function(e){L.error("Feedback plugin startup failed.",e,a.S_PLUGIN_COMPONENT_NAME);d();});}else{L.error("Device not supported.",this._oConfig,a.S_PLUGIN_COMPONENT_NAME);d();}}.bind(this));},_isDeviceDisplayFormatCombinationValid:function(d){if(sap.ui.Device.system.phone&&d===a.E_DISPLAY_FORMAT.popover){return false;}return true;},_getShellUIService:function(){return this.getService("ShellUIService").then(function(s){return s;},function(e){L.error("Cannot get ShellUIService",e,a.S_PLUGIN_COMPONENT_NAME);});},_getRenderer:function(){var d=new $.Deferred(),r;this._oShellContainer=$.sap.getObject("sap.ushell.Container");if(!this._oShellContainer){d.reject("Illegal state: shell container not available; this component must be executed in a unified shell runtime context.");}else{r=this._oShellContainer.getRenderer();if(r){d.resolve(r);}else{this._onRendererCreated=function(e){r=e.getParameter("renderer");if(r){d.resolve(r);}else{d.reject("Illegal state: shell renderer not available after recieving 'rendererLoaded' event.");}};this._oShellContainer.attachRendererCreatedEvent(this._onRendererCreated);}}return d.promise();}});});
