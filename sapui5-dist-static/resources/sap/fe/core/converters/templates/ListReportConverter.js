sap.ui.define(["../ManifestSettings","sap/fe/core/templating/DataModelPathHelper","./BaseConverter","../controls/Common/DataVisualization","../helpers/ID","sap/fe/core/converters/controls/Common/Table","sap/fe/core/converters/controls/Common/Action","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/converters/helpers/Key","sap/fe/core/helpers/BindingExpression","sap/fe/core/converters/helpers/IssueManager"],function(M,D,B,a,I,T,A,C,K,b,c){"use strict";var _={};var d=c.IssueCategory;var e=c.IssueSeverity;var f=c.IssueType;var g=b.compileBinding;var h=b.annotationExpression;var j=K.KeyHelper;var P=C.Placement;var k=C.insertCustomElements;var l=A.getActionsFromManifest;var m=T.getSelectionVariantConfiguration;var n=I.TableID;var F=I.FilterVariantManagementID;var o=I.FilterBarID;var p=a.isSelectionPresentationCompliant;var q=a.getSelectionVariant;var r=a.isPresentationCompliant;var s=a.getSelectionPresentationVariant;var t=a.getDefaultPresentationVariant;var u=a.getDefaultLineItem;var v=a.getDefaultChart;var w=a.getDataVisualizationConfiguration;var x=B.TemplateType;var y=D.getTargetObjectPath;var V=M.VisualizationType;var z=M.AvailabilityType;function E(i,f1){var g1=Object.keys(i);if(Object.getOwnPropertySymbols){var h1=Object.getOwnPropertySymbols(i);if(f1)h1=h1.filter(function(i1){return Object.getOwnPropertyDescriptor(i,i1).enumerable;});g1.push.apply(g1,h1);}return g1;}function G(f1){for(var i=1;i<arguments.length;i++){var g1=arguments[i]!=null?arguments[i]:{};if(i%2){E(Object(g1),true).forEach(function(h1){H(f1,h1,g1[h1]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(f1,Object.getOwnPropertyDescriptors(g1));}else{E(Object(g1)).forEach(function(h1){Object.defineProperty(f1,h1,Object.getOwnPropertyDescriptor(g1,h1));});}}return f1;}function H(i,f1,g1){if(f1 in i){Object.defineProperty(i,f1,{value:g1,enumerable:true,configurable:true,writable:true});}else{i[f1]=g1;}return i;}var J=function(i,f1){var g1=f1.split("/");var h1;var i1="";while(g1.length){var j1=g1.shift();h1=h1?h1+"/"+j1:j1;var k1=i.resolvePath(h1);if(k1._type==="NavigationProperty"&&k1.isCollection){j1+="*";}i1=i1?i1+"/"+j1:j1;}return i1;};var L=function(i,f1,g1,h1,i1){var j1,k1,l1;if(f1!==undefined&&f1.targetType===undefined&&(h1||((j1=f1.annotations)===null||j1===void 0?void 0:(k1=j1.UI)===null||k1===void 0?void 0:(l1=k1.Hidden)===null||l1===void 0?void 0:l1.valueOf())!==true)){var m1,n1,o1,p1,q1,r1,s1,t1;var u1=i1.getAnnotationEntityType(f1);return{key:j.getSelectionFieldKeyFromPath(g1),annotationPath:i1.getAbsoluteAnnotationPath(g1),conditionPath:J(i,g1),availability:((m1=f1.annotations)===null||m1===void 0?void 0:(n1=m1.UI)===null||n1===void 0?void 0:(o1=n1.HiddenFilter)===null||o1===void 0?void 0:o1.valueOf())===true?z.Hidden:z.Adaptation,label:g(h(((p1=f1.annotations.Common)===null||p1===void 0?void 0:(q1=p1.Label)===null||q1===void 0?void 0:q1.valueOf())||f1.name)),group:u1.name,groupLabel:g(h((u1===null||u1===void 0?void 0:(r1=u1.annotations)===null||r1===void 0?void 0:(s1=r1.Common)===null||s1===void 0?void 0:(t1=s1.Label)===null||t1===void 0?void 0:t1.valueOf())||u1.name))};}return undefined;};var N=function(i,f1,g1,h1,i1){var j1={};if(g1){g1.forEach(function(k1){var l1=k1.name;var m1=(f1?f1+"/":"")+l1;var n1=L(i,k1,m1,h1,i1);if(n1){j1[m1]=n1;}});}return j1;};var O=function(i,f1,g1,h1){var i1={};if(f1){f1.forEach(function(j1){var k1;var l1=i.resolvePath(j1);if(l1===undefined){return;}if(l1._type==="NavigationProperty"){k1=N(i,j1,l1.targetType.entityProperties,g1,h1);}else if(l1.targetType!==undefined){k1=N(i,j1,l1.targetType.properties,g1,h1);}else{var m1=j1.includes("/")?j1.split("/").splice(0,1).join("/"):"";k1=N(i,m1,[l1],g1,h1);}i1=G({},i1,{},k1);});}return i1;};function Q(i){var f1={};i.Data.forEach(function(g1){if(g1.$Type==="com.sap.vocabularies.UI.v1.DataField"){var h1,i1;f1[g1.Value.path]={group:i.fullyQualifiedName,groupLabel:g(h(i.Label||((h1=i.annotations)===null||h1===void 0?void 0:(i1=h1.Common)===null||i1===void 0?void 0:i1.Label)||i.qualifier))||i.qualifier};}});return f1;}function R(i){var f1=[];i.forEach(function(g1){g1.presentation.visualizations.forEach(function(h1){if(h1.type===V.Table){f1.push(h1);}});});return f1;}function S(i,f1){if(f1.getTemplateType()===x.AnalyticalListPage){return true;}return U(i,f1.getEntitySet().name);}function U(i,f1){if(i.length>0){return i.every(function(g1){return g1.enableAnalytics&&"/"+f1===g1.annotation.collection;});}return false;}var W=function(f1){var g1,h1,i1,j1;var k1=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var l1=[];var m1=k1.map(function(z1){var A1=z1.control.filters;var B1=[];for(var C1 in A1){if(Array.isArray(A1[C1].paths)){var D1=A1[C1].paths;D1.forEach(function(E1){if(E1&&E1.annotationPath&&l1.indexOf(E1.annotationPath)===-1){l1.push(E1.annotationPath);var F1=m(E1.annotationPath,f1);if(F1){B1.push(F1);}}});}}return B1;}).reduce(function(z1,t1){return z1.concat(t1);},[]);var n1=m1.reduce(function(z1,t1){t1.propertyNames.forEach(function(A1){z1[A1]=true;});return z1;},{});var o1=f1.getEntityType();var p1=(g1=f1.getAnnotationEntityType().annotations.UI)===null||g1===void 0?void 0:g1.FilterFacets;var q1={};var r1=f1.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.FieldGroup")||[];if(p1===undefined||p1.length<0){for(var i in r1){q1=G({},q1,{},Q(r1[i]));}}else{q1=p1.reduce(function(z1,A1){for(var _i=0;_i<A1.Target.$target.Data.length;_i++){var C1,D1;z1[A1.Target.$target.Data[_i].Value.path]={group:A1===null||A1===void 0?void 0:(C1=A1.ID)===null||C1===void 0?void 0:C1.toString(),groupLabel:A1===null||A1===void 0?void 0:(D1=A1.Label)===null||D1===void 0?void 0:D1.toString()};}return z1;},{});}var s1=[];var t1=q(o1,f1);if(t1){s1=t1.SelectOptions;}var u1=G({},N(o1,"",o1.entityProperties,false,f1),{},O(o1,f1.getManifestWrapper().getFilterConfiguration().navigationProperties,false,f1));var v1=X(u1,s1,o1,f1,n1);var w1=(((h1=o1.annotations)===null||h1===void 0?void 0:(i1=h1.UI)===null||i1===void 0?void 0:(j1=i1.SelectionFields)===null||j1===void 0?void 0:j1.reduce(function(z1,A1){var B1=A1.value;if(!(B1 in n1)){var C1=Y(u1,B1,f1,o1);if(C1){C1.group="";C1.groupLabel="";z1.push(C1);}}return z1;},[]))||[]).concat(v1||[]).concat(Object.keys(u1).filter(function(z1){return!(z1 in n1);}).map(function(z1){return Object.assign(u1[z1],q1[z1]);}));if(U(k1,f1.getEntitySet().name)){var x1=k1[0].aggregates;if(x1){var y1=Object.keys(x1).map(function(z1){return x1[z1].relativePath;});w1=w1.filter(function(z1){return y1.indexOf(z1.key)===-1;});}}return w1;};_.getSelectionFields=W;var X=function(i,f1,g1,h1,i1){var j1,k1,l1;var m1=[];var n1={};var o1=g1.entityProperties;(j1=g1.annotations)===null||j1===void 0?void 0:(k1=j1.UI)===null||k1===void 0?void 0:(l1=k1.SelectionFields)===null||l1===void 0?void 0:l1.forEach(function(p1){n1[p1.value]=true;});if(f1&&f1.length>0){f1===null||f1===void 0?void 0:f1.forEach(function(p1){var q1,r1,s1;var t1=p1.PropertyName;var u1=t1.value;var n1={};(q1=g1.annotations)===null||q1===void 0?void 0:(r1=q1.UI)===null||r1===void 0?void 0:(s1=r1.SelectionFields)===null||s1===void 0?void 0:s1.forEach(function(w1){n1[w1.value]=true;});if(!(u1 in i1)){if(!(u1 in n1)){var v1=Y(i,u1,h1,g1);if(v1){m1.push(v1);}}}});}else if(o1){o1.forEach(function(p1){var q1,r1;var s1=(q1=p1.annotations)===null||q1===void 0?void 0:(r1=q1.Common)===null||r1===void 0?void 0:r1.FilterDefaultValue;var t1=p1.name;if(!(t1 in i1)){if(s1&&!(t1 in n1)){var u1=Y(i,t1,h1,g1);if(u1){m1.push(u1);}}}});}return m1;};var Y=function(i,f1,g1,h1){var i1=i[f1];if(i1){delete i[f1];}else{i1=L(h1,h1.resolvePath(f1),f1,true,g1);}if(!i1){g1.getDiagnostics().addIssue(d.Annotation,e.High,f.MISSING_SELECTIONFIELD);}if(i1){i1.availability=z.Default;}return i1;};var Z=function(i,f1){var g1=f1.getManifestWrapper().getFilterConfiguration();var h1=(g1===null||g1===void 0?void 0:g1.filterFields)||{};var i1=O(i,Object.keys(h1).map(function(o1){return j.getPathFromSelectionFieldKey(o1);}),true,f1);var j1={};for(var k1 in h1){var l1=h1[k1];var m1=j.getPathFromSelectionFieldKey(k1);var n1=i1[m1];j1[k1]={key:k1,annotationPath:n1===null||n1===void 0?void 0:n1.annotationPath,conditionPath:(n1===null||n1===void 0?void 0:n1.conditionPath)||m1,template:l1.template,label:l1.label,position:l1.position||{placement:P.After},availability:l1.availability||z.Default,settings:l1.settings};}return j1;};function $(i,f1,g1){var h1=f1.getManifestWrapper().getDefaultTemplateAnnotationPath();var i1=s(i,h1,f1);if(h1&&i1){var j1=i1.PresentationVariant;if(!j1){throw new Error("Presentation Variant is not configured in the SPV mentioned in the manifest");}var k1=r(i1.PresentationVariant);if(!k1){return undefined;}if(p(i1,g1)){return i1;}}if(i1){if(p(i1,g1)){return i1;}}var l1=t(i);if(l1){if(r(l1,g1)){return l1;}}if(!g1){var m1=u(i);if(m1){return m1;}}return undefined;}var a1=function(i){var f1=i;var g1=f1.converterContext;var h1=w(f1.annotation?g1.getRelativeAnnotationPath(f1.annotation.fullyQualifiedName,g1.getEntityType()):"",true,g1);var i1="";var j1="";var k1="";var l1="";var m1=function(f1){return f1.key!==undefined;};if(m1(f1)){var n1=g1.getEntityTypeAnnotation(f1.annotationPath);var o1=n1.annotation;g1=n1.converterContext;k1=g(h(o1.Text));h1.visualizations.forEach(function(p1,q1){switch(p1.type){case V.Table:var r1=h1.visualizations[q1];var s1=r1.control.filters||{};s1.hiddenFilters=s1.hiddenFilters||{paths:[]};if(!f1.keepPreviousPresonalization){r1.annotation.id=n(f1.key,"LineItem");}if(f1&&f1.annotation&&f1.annotation.term==="com.sap.vocabularies.UI.v1.SelectionPresentationVariant"){l1=f1.annotation.SelectionVariant.fullyQualifiedName.split("@")[1];}else{l1=f1.annotationPath;}s1.hiddenFilters.paths.push({annotationPath:l1});r1.control.filters=s1;break;case V.Chart:break;default:break;}});}h1.visualizations.forEach(function(p1){if(p1.type===V.Table){i1=p1.annotation.id;}else if(p1.type===V.Chart){j1=p1.id;}});return{presentation:h1,tableControlId:i1,chartControlId:j1,entitySet:"/"+i.entitySet.name,title:k1,selectionVariantPath:l1};};var b1=function(i,f1,g1){var h1=[];if(g1){g1.paths.forEach(function(j1){var k1=f1.findEntitySet(j1.entitySet);var l1=f1.getManifestWrapper().getDefaultTemplateAnnotationPath();var m1;if(k1){var n1=f1.getConverterContextFor(k1);var o1=n1.getEntityTypeAnnotation(j1.annotationPath);var p1=o1.annotation;f1=o1.converterContext;if(p1){if(p1.term==="com.sap.vocabularies.UI.v1.SelectionVariant"){if(l1){m1=s(k1.entityType,l1,f1);}else{m1=u(k1.entityType);}}else{m1=p1;}h1.push({converterContext:n1,entitySet:k1,annotation:m1,annotationPath:j1.annotationPath,keepPreviousPresonalization:j1.keepPreviousPresonalization,key:j1.key});}}else{}});}else{var i1=f1.getEntityType();if(f1.getTemplateType()===x.AnalyticalListPage){h1=c1(i,f1,h1);}else{h1.push({annotation:$(i1,f1,false),entitySet:i,converterContext:f1});}}return h1.map(function(j1){return a1(j1);});};function c1(i,f1,g1){var h1=$(i.entityType,f1,true);var i1,j1;if(h1){g1.push({entitySet:i,annotation:h1,converterContext:f1});}else{i1=v(i.entityType);j1=u(i.entityType);if(i1){g1.push({entitySet:i,annotation:i1,converterContext:f1});}if(j1){g1.push({entitySet:i,annotation:j1,converterContext:f1});}}return g1;}var d1=function(i){var f1=i.getTemplateType();var g1=i.getEntitySet();var h1=i.getDataModelObjectPath();var i1=i.getEntityType();var j1=y(h1);if(!g1){throw new Error("An EntitySet is required to be able to display a ListReport, please adjust your `entitySet` property to point to one.");}var k1=i.getManifestWrapper();var l1=k1.getViewConfiguration();var m1=k1.hasMultipleEntitySets();var n1=b1(g1,i,l1);var o1=l1?(l1===null||l1===void 0?void 0:l1.showCounts)||m1:undefined;var p1=R(n1);var q1="";var r1="";var s1=o(g1.name);var t1=F(s1);var u1=[s1].concat(p1.map(function(E1){return E1.annotation.id;}));var v1=k1.getFilterConfiguration();var w1=v1.useSemanticDateRange!==undefined?v1.useSemanticDateRange:true;var x1=e1(f1,n1);if(x1){r1=x1.chartId;q1=x1.tableId;}var y1=W(i,p1);var z1=k(y1,Z(i1,i),{"availability":"overwrite",label:"overwrite",position:"overwrite",template:"overwrite",settings:"overwrite"});var A1=S(p1,i);var B1=q(i1,i);var C1=k([],l(k1.getHeaderActions(),i));var D1=i.getTemplateType()===x.AnalyticalListPage;return{mainEntitySet:"/"+g1.name,mainEntityType:j1+"/",singleTableId:q1,singleChartId:r1,showTabCounts:o1,headerActions:C1,filterBar:{selectionFields:z1,hideBasicSearch:A1},views:n1,filterBarId:s1,filterConditions:{selectionVariant:B1},variantManagement:{id:t1,targetControlIds:u1.join(",")},isMultiEntitySets:m1,isAlp:D1,useSemanticDateRange:w1};};_.convertPage=d1;function e1(i,f1){var g1="",h1="";if(f1.length===1){g1=f1[0].tableControlId;h1=f1[0].chartControlId;}else if(i===x.AnalyticalListPage&&f1.length===2){f1.map(function(i1){if(i1.chartControlId){h1=i1.chartControlId;}else if(i1.tableControlId){g1=i1.tableControlId;}});}if(g1||h1){return{chartId:h1,tableId:g1};}return undefined;}return _;},false);
