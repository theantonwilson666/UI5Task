/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log"],function(L){"use strict";var s={};s.getSideEffectsForAction=function(A,c){var m=c&&c.getModel().getMetaModel(),M=m&&m.getMetaContext(c.getPath()),o=M&&m.getObject(A+"@",M),S=s.getSideEffects(o),b,t=[],T=[],d=[],e,f=[];if(S.length===0){return{};}S.forEach(function(g){T=T.concat(g.TargetProperties);t=t.concat(g.TargetEntities);if(g.TriggerAction){d=d.concat(g.TriggerAction);}});b=m.getObject(A+"/@$ui5.overload/0/$Parameter/0/$Name",M);T=s.removeBindingPaths(T,"$PropertyPath",b,A);t=s.removeBindingPaths(t,"$NavigationPropertyPath",b,A);f=f.concat(T).concat(t);e=m.getMetaPath(c.getPath());f=s.addTextProperties(f,m,e);return{pathExpressions:f,triggerActions:d};};s.addTextProperties=function(p,m,b){var B=b,t=[],e=[],T,E,r;if(B.charAt(0)!=="/"){B="/"+B;}if(B.charAt(B.length-1)!=="/"){B=B+"/";}p.forEach(function(P){var c=P["$PropertyPath"];if(c&&c.endsWith("*")){e.push(c.slice(0,-1));r=true;}else if(c){T=_(m,B,"",c);if(T){t.push(T);}}});if(r){e.forEach(function(n){E=m.getObject(B+n);Object.keys(E).forEach(function(k){if(E[k].$kind&&E[k].$kind==="Property"){T=_(m,B,n,k);if(T){t.push(T);}}});});}return p.concat(t);};function _(m,p,n,k){var t=m.getObject(p+n+k+"@com.sap.vocabularies.Common.v1.Text"),P=t&&n+t["$Path"],r=!!n,T=t&&t["$Path"]&&t["$Path"].indexOf("/")===-1;if(r&&T){return undefined;}if(P){if(k.indexOf("/")>0){P=k.substr(0,k.lastIndexOf("/"))+"/"+P;}return a(P);}return undefined;}function a(p){var n=p.lastIndexOf("/");if(n>-1){return{"$NavigationPropertyPath":p.substr(0,n)};}else{return{"$PropertyPath":p};}}s.determinePathOrNavigationPath=function(p){return a(p);};s.logRequest=function(r){var p=Array.isArray(r.pathExpressions)&&r.pathExpressions.reduce(function(P,o){return P+"\n\t\t"+(o["$PropertyPath"]||o["$NavigationPropertyPath"]||"");},"");L.info("SideEffects request:\n\tContext path : "+r.context.getPath()+"\n\tProperty paths :"+p);};s.removeBindingPaths=function(t,T,b,A){t.forEach(function(p){var n=p[T].indexOf(b);if(n===0){p[T]=p[T].substr(b.length+1);}else if(n===-1){L.info('Side Effects for Action "'+A+'" with property "'+p[T]+'" do not include binding parameter '+'"'+b+'".');}});return t;};s.convertSideEffect=function(S){function b(C,t){if(typeof t==="string"){C.TargetProperties.push({$PropertyPath:t});}else if(t.$PropertyPath){C.TargetProperties.push(t);}else if(t.$Path){throw new Error("<Path> is not supported for TargetProperties of SideEffects. Annotate <String>"+t.$Path+"</String> instead.");}else{throw new Error("Unsupported TargetProperties type");}return C;}if(S){var c=Object.assign({},S);c.TargetProperties=[];c.TargetEntities||(c.TargetEntities=[]);S.TargetProperties&&S.TargetProperties.reduce(b,c);return c;}};s.getSideEffects=function(A){return A?Object.keys(A).filter(function(b){return b.indexOf("@com.sap.vocabularies.Common.v1.SideEffects")>-1;}).map(function(S){return s.convertSideEffect(A[S]);}):[];};s.requestSideEffects=function(n,b){var m=b.oModel.getMetaModel(),B="/"+m.getObject(m.getMetaPath(b.getPath()))["$Type"],A=m.getObject(B+"@"),S=this.getSideEffects(A),c=[],p,t=[],P=[],e=[];S.forEach(function(o){if(o.SourceEntities){o.SourceEntities.forEach(function(d){if(d["$NavigationPropertyPath"]===n){c.push(o);}});}if(o.SourceProperties&&c.indexOf(o)===-1){o.SourceProperties.forEach(function(d){if(d["$PropertyPath"].indexOf(n+"/")===0){c.push(o);}});}});c.forEach(function(o){var T=o.TargetProperties,d=o.TargetEntities;if(o.TriggerAction){t.push(o.TriggerAction);}T=T.map(function(f){return f["$PropertyPath"];}).filter(function(f){return P.indexOf(f)<0;});d=d.map(function(f){return f["$NavigationPropertyPath"];}).filter(function(f){return e.indexOf(f)<0;});P=P.concat(T);e=e.concat(d);});p=P.map(function(d){return{"$PropertyPath":d};}).concat(e.map(function(d){return{"$NavigationPropertyPath":d};}));if(t.length){t.forEach(function(T){var o=b.getModel().bindContext(T+"(...)",b);o.execute(b.getBinding().getUpdateGroupId());});}if(p.length){p=this.addTextProperties(p,m,B);this.logRequest({context:b,pathExpressions:p});b.requestSideEffects(p);}};return s;});
