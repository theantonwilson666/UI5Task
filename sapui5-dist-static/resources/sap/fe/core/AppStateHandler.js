/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/p13n/StateUtil","sap/ui/base/Object","sap/fe/core/library","sap/fe/navigation/library","sap/fe/core/CommonUtils","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/base/Log","sap/base/util/merge","sap/base/util/deepEqual","sap/fe/core/BusyLocker"],function(S,B,C,N,a,b,L,m,d,c){"use strict";var e=N.NavType;function _(t){return Promise.resolve(t.then(function(){return Array.prototype.slice.call(arguments);}).catch(function(){return Array.prototype.slice.call(arguments);}));}var A=B.extend("sap.fe.core.AppStateHandler",{constructor:function(o){this.oAppComponent=o;this.sId=o.getId()+"/AppStateHandler";this.bNoRouteChange=false;L.info("APPSTATE : Appstate handler initialized");return B.apply(this,arguments);},getId:function(){return this.sId;},createAppState:function(){if(c.isLocked(this)){return Promise.resolve();}var n=this.oAppComponent.getNavigationService(),r=this.oAppComponent.getRouterProxy(),h=r.getHash(),o=this.oAppComponent.getRootControl().getController(),t=this;if(!o.viewState){return Promise.reject("viewState controller extension not available for controller: "+o.getMetadata().getName());}return o.viewState.retrieveViewState().then(function(i){var s={appState:i};if(i&&!d(t._mCurrentAppState,i)){t._mCurrentAppState=i;var f=n.storeInnerAppStateWithImmediateReturn(s,true);L.info("APPSTATE: Appstate stored");var g=f.appStateKey;var j=n.replaceInnerAppStateKey(h,g);if(j!==h){r.navToHash(j);t.bNoRouteChange=true;}L.info("APPSTATE: navToHash");}return s;});},_createNavigationParameters:function(o,n){return Object.assign({},o,{selectionVariantDefaults:o.oDefaultedSelectionVariant,selectionVariant:o.oSelectionVariant,requiresStandardVariant:!o.bNavSelVarHasDefaultsOnly,navigationType:n});},applyAppState:function(){if(c.isLocked(this)){return Promise.resolve();}c.lock(this);var t=this,n=this.oAppComponent.getNavigationService();return _(n.parseNavigation()).catch(function(E){if(!E){E=[];}L.warning("APPSTATE: Parse Navigation failed",E[0]);return[{},E[1],E[2]];}).then(function(r){L.info("APPSTATE: Parse Navigation done");var o=r[0]||{},s=r[2]||e.initial,R=t.oAppComponent.getRootControl().getController();t._mCurrentAppState=s===e.iAppState?o&&o.appState:undefined;if(!R.viewState){throw new Error("viewState extension required for controller "+R.getMetadata().getName());}return R.viewState.applyViewState(t._mCurrentAppState,t._createNavigationParameters(o,s)).catch(function(E){L.error("appState could not be applied",E);throw E;});}).finally(function(){c.unlock(t);});},checkIfRouteChangedByIApp:function(){return this.bNoRouteChange;},resetRouteChangedByIApp:function(){if(this.bNoRouteChange){this.bNoRouteChange=false;}},_isListBasedComponent:function(o){return o.isA("sap.fe.templates.ListComponent");}});return A;},true);
