sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/fe/core/controllerextensions/ControllerExtensionMetadata","sap/ui/core/Component","sap/fe/core/CommonUtils","sap/ui/base/EventProvider","sap/base/Log","../helpers/ClassSupport"],function(C,O,a,b,c,E,L,d){"use strict";var _,f,g,h,j,k,l,m,n;var P=d.Private;var q=d.Extensible;var F=d.Final;var r=d.Public;var s=d.Override;var U=d.UI5Class;function t(i,e){if(!(i instanceof e)){throw new TypeError("Cannot call a class as a function");}}function u(e,p){for(var i=0;i<p.length;i++){var o=p[i];o.enumerable=o.enumerable||false;o.configurable=true;if("value"in o)o.writable=true;Object.defineProperty(e,o.key,o);}}function v(e,p,i){if(p)u(e.prototype,p);if(i)u(e,i);return e;}function w(e,i){if(typeof i!=="function"&&i!==null){throw new TypeError("Super expression must either be null or a function");}e.prototype=Object.create(i&&i.prototype,{constructor:{value:e,writable:true,configurable:true}});if(i)x(e,i);}function x(o,p){x=Object.setPrototypeOf||function x(o,p){o.__proto__=p;return o;};return x(o,p);}function y(e){return function(){var S=D(e),i;if(B()){var N=D(this).constructor;i=Reflect.construct(S,arguments,N);}else{i=S.apply(this,arguments);}return z(this,i);};}function z(e,i){if(i&&(typeof i==="object"||typeof i==="function")){return i;}return A(e);}function A(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return e;}function B(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}function D(o){D=Object.setPrototypeOf?Object.getPrototypeOf:function D(o){return o.__proto__||Object.getPrototypeOf(o);};return D(o);}function G(e,p,i,o,I){var J={};Object.keys(o).forEach(function(K){J[K]=o[K];});J.enumerable=!!J.enumerable;J.configurable=!!J.configurable;if('value'in J||J.initializer){J.writable=true;}J=i.slice().reverse().reduce(function(J,K){return K(e,p,J)||J;},J);if(I&&J.initializer!==void 0){J.value=J.initializer?J.initializer.call(I):void 0;J.initializer=undefined;}if(J.initializer===void 0){Object.defineProperty(e,p,J);J=null;}return J;}var H=(_=U("sap.fe.core.controllerextensions.PageReady",a),f=s(),g=s(),h=s("_routing"),j=s("_routing"),k=s("_routing"),l=q(O.Instead),_(m=(n=function(e){w(H,e);var i=y(H);function H(){t(this,H);return i.apply(this,arguments);}v(H,[{key:"onInit",value:function p(){var o=this;this._oEventProvider=new E();this._oView=this.base.getView();this._oAppComponent=c.getAppComponent(this._oView);this._oPageComponent=b.getOwnerComponentFor(this._oView);if(this._oPageComponent&&this._oPageComponent.attachContainerDefined){this._oPageComponent.attachContainerDefined(function(I){return o.registerContainer(I.getParameter("container"));});}else{this.registerContainer(this._oView);}}},{key:"onExit",value:function o(){delete this._oAppComponent;this._oContainer.removeEventDelegate(this._fnContainerDelegate);}},{key:"onRouteMatched",value:function o(){this._bIsPageReady=false;}},{key:"onRouteMatchedFinished",value:function o(){this.checkPageReadyDebounced();}},{key:"onAfterBinding",value:function V(o){var p=this;if(!this._bAfterBindingAlreadyApplied){this._bAfterBindingAlreadyApplied=true;var I=[];var N=[];var R=0;var J=0;var K=function(W){W.getSource().detachDataRequested(K);R++;p.bDataReceived=false;};var M=function(W){switch(W.getSource().sGroupId){case"$auto.Workers":p._oEventProvider.fireEvent("workersBatchReceived");break;case"$auto.Heroes":p._oEventProvider.fireEvent("heroesBatchReceived");break;default:}W.getSource().detachDataReceived(M);J++;if(J===R&&R!==0){R=0;J=0;p.bDataReceived=true;p.checkPageReadyDebounced();}};var S=function(W){var X=N.filter(function(Y){if(W.getSource().sId===Y.getFilter()){return true;}return false;});X.forEach(function(Y){var Z=Y.getRowBinding();var $=function(){Z.attachDataRequested(K);Z.attachDataReceived(M);I.push(Z);};if(Z){$();}else{setTimeout(function(){Z=Y.getRowBinding();if(Z){$();}else{L.error("Cannot attach events to unbound table",null);}},0);}});};if(this.isContextExpected()&&o===undefined){this.bHasContext=false;return;}else{this.bHasContext=true;}this.attachEventOnce("pageReady",null,function(){I.forEach(function(W){W.detachEvent("dataRequested",K);W.detachEvent("dataReceived",M);W.detachEvent("search",S);});p._bAfterBindingAlreadyApplied=false;I=[];},null);if(o){var Q=o.getBinding();Q.attachDataRequested(K);Q.attachDataReceived(M);I.push(Q);}var T=[];this._oView.findAggregatedObjects(true,function(W){var X=W.getObjectBinding();if(X){X.attachDataRequested(K);X.attachDataReceived(M);I.push(X);}else{var Y=Object.keys(W.mBindingInfos);if(Y.length>0){Y.forEach(function(Z){var $=W.mBindingInfos[Z].binding;if($&&$.isA("sap.ui.model.odata.v4.ODataListBinding")){$.attachDataRequested(K);$.attachDataReceived(M);I.push($);}});}}if(W.isA("sap.ui.mdc.Table")){p.bTablesLoaded=false;T.push(W.initialized().then(function(){var Z=W.getRowBinding();if(Z){Z.attachDataRequested(K);Z.attachDataReceived(M);I.push(Z);}else{N.push(W);}}).catch(function(Z){L.error("Cannot find a bound table",Z);}));}else if(W.isA("sap.ui.mdc.FilterBar")){W.attachEvent("search",S);I.push(W);}});if(T.length>0){Promise.all(T).then(function(){p.bTablesLoaded=true;p.checkPageReadyDebounced();}).catch(function(W){L.info("There was an error with one or multiple table",W);p.bTablesLoaded=true;p.checkPageReadyDebounced();});}}}},{key:"isPageReady",value:function o(){return this._bIsPageReady;}},{key:"attachEventOnce",value:function K(o,p,I,J){return this._oEventProvider.attachEventOnce(o,p,I,J);}},{key:"attachEvent",value:function K(o,p,I,J){return this._oEventProvider.attachEvent(o,p,I,J);}},{key:"detachEvent",value:function I(o,p){return this._oEventProvider.detachEvent(o,p);}},{key:"registerContainer",value:function I(o){var p=this;this._oContainer=o;this._fnContainerDelegate={onBeforeShow:function(){p.bShown=false;p._bIsPageReady=false;},onBeforeHide:function(){p.bShown=false;p._bIsPageReady=false;},onAfterShow:function(){p.bShown=true;p._checkPageReady(true);}};this._oContainer.addEventDelegate(this._fnContainerDelegate);}},{key:"isContextExpected",value:function o(){return false;}},{key:"checkPageReadyDebounced",value:function p(){var o=this;if(this.pageReadyTimer){clearTimeout(this.pageReadyTimer);}this.pageReadyTimer=setTimeout(function(){o._checkPageReady();},200);}},{key:"_checkPageReady",value:function K(){var o=this;var p=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var I=function(){if(!sap.ui.getCore().getUIDirty()){sap.ui.getCore().detachEvent("UIUpdated",I);o._bWaitingForRefresh=false;setTimeout(function(){o._checkPageReady();},20);}};var J=function(){if(sap.ui.getCore().getUIDirty()){setTimeout(J,500);}else if(o._bWaitingForRefresh){o._bWaitingForRefresh=false;sap.ui.getCore().detachEvent("UIUpdated",I);o._checkPageReady();}};if(this.bShown&&this.bDataReceived!==false&&this.bTablesLoaded!==false&&(!this.isContextExpected()||this.bHasContext)){if(this.bDataReceived===true&&!p&&!this._bWaitingForRefresh&&sap.ui.getCore().getUIDirty()){this.bDataReceived=undefined;this._bWaitingForRefresh=true;sap.ui.getCore().attachEvent("UIUpdated",I);setTimeout(J,500);}else if(!this._bWaitingForRefresh&&sap.ui.getCore().getUIDirty()){this._bWaitingForRefresh=true;sap.ui.getCore().attachEvent("UIUpdated",I);setTimeout(J,500);}else if(!this._bWaitingForRefresh){this._bIsPageReady=true;this._oEventProvider.fireEvent("pageReady");}}}}]);return H;}(C),(G(n.prototype,"onInit",[f],Object.getOwnPropertyDescriptor(n.prototype,"onInit"),n.prototype),G(n.prototype,"onExit",[g],Object.getOwnPropertyDescriptor(n.prototype,"onExit"),n.prototype),G(n.prototype,"onRouteMatched",[h],Object.getOwnPropertyDescriptor(n.prototype,"onRouteMatched"),n.prototype),G(n.prototype,"onRouteMatchedFinished",[j],Object.getOwnPropertyDescriptor(n.prototype,"onRouteMatchedFinished"),n.prototype),G(n.prototype,"onAfterBinding",[k],Object.getOwnPropertyDescriptor(n.prototype,"onAfterBinding"),n.prototype),G(n.prototype,"isPageReady",[r,F],Object.getOwnPropertyDescriptor(n.prototype,"isPageReady"),n.prototype),G(n.prototype,"attachEventOnce",[r,F],Object.getOwnPropertyDescriptor(n.prototype,"attachEventOnce"),n.prototype),G(n.prototype,"attachEvent",[r,F],Object.getOwnPropertyDescriptor(n.prototype,"attachEvent"),n.prototype),G(n.prototype,"detachEvent",[r,F],Object.getOwnPropertyDescriptor(n.prototype,"detachEvent"),n.prototype),G(n.prototype,"isContextExpected",[P,l],Object.getOwnPropertyDescriptor(n.prototype,"isContextExpected"),n.prototype)),n))||m);return H;},false);
