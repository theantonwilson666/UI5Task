sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/fe/core/controllerextensions/ControllerExtensionMetadata","sap/ui/core/mvc/OverrideExecution","sap/ui/core/Component","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker","sap/fe/core/helpers/SemanticKeyHelper","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/Log","sap/fe/core/actions/messageHandling","sap/m/MessageBox","sap/fe/core/helpers/EditState"],function(C,a,O,b,c,B,S,F,d,L,m,M,E){"use strict";function e(s,h){var k=s.substring(s.indexOf("(")+1,s.length-1).split(","),i;if(h.length!=k.length){return null;}if(h.length===1){var K=k[0];if(K.indexOf("'")===0&&K.lastIndexOf("'")===K.length-1){K=decodeURIComponent(K.substring(1,K.length-1));}i=[new F(h[0].$PropertyPath,d.EQ,K)];}else{var j={};k.forEach(function(n){var p=n.split("="),K=p[1];if(K.indexOf("'")===0&&K.lastIndexOf("'")===K.length-1){K=decodeURIComponent(K.substring(1,K.length-1));}j[p[0]]=K;});var l=false;i=h.map(function(n){var p=n.$PropertyPath,v=j[p];if(v!==undefined){return new F(p,d.EQ,v);}else{l=true;return"XX";}});if(l){return null;}}var D=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});i.push(D);var o=new F(i,true);return o;}function g(s,o,h){var i=o.getMetaModel(),j=i.getMetaContext(s).getPath();if(!h||h.length===0){return Promise.resolve(null);}var k=e(s,h);if(k===null){return Promise.resolve(null);}var l=o.bindList("/"+j,undefined,undefined,k,{"$$groupId":"$auto.Heroes"});return l.requestContexts(0,2).then(function(n){if(n&&n.length){return n[0].getPath();}else{return null;}});}function f(p,o){var h=/^[\/]?(\w+)\([^\/]+\)$/.exec(p);if(!h){return false;}var s="/"+h[1];var D=o.getObject(s+"@com.sap.vocabularies.Common.v1.DraftRoot");var i=o.getObject(s+"@com.sap.vocabularies.Common.v1.DraftNode");return D||i?true:false;}return C.extend("sap.fe.core.controllerextensions.InternalRouting",{metadata:{methods:{"navigateToTarget":{"public":true,"final":false},"byId":{"public":false},"getView":{"public":false},"onRouteMatched":{"public":true,"final":false,overrideExecution:O.After},"onRouteMatchedFinished":{"public":true,"final":false,overrideExecution:O.After},"onBeforeBinding":{"public":true,"final":false,overrideExecution:O.After},"onAfterBinding":{"public":true,"final":false,overrideExecution:O.After},"navigateToContext":{"public":true,"final":true},"navigateBackFromContext":{"public":true,"final":true},"navigateForwardToContext":{"public":true,"final":true},"navigateBackFromTransientState":{"public":true,"final":true},"navigateToMessagePage":{"public":true,"final":true},"handleFCLFullScreen":{"public":true,"final":false,overrideExecution:sap.ui.core.mvc.OverrideExecution.Before},"handleFCLExitFullScreen":{"public":true,"final":false,overrideExecution:sap.ui.core.mvc.OverrideExecution.Before},"handleFCLClose":{"public":true,"final":false,overrideExecution:sap.ui.core.mvc.OverrideExecution.Before},"isCurrentStateImpactedBy":{"public":true,"final":true}}},onRouteMatched:function(){},onRouteMatchedFinished:function(){},onBeforeBinding:function(o,p){},onAfterBinding:function(o,p){this._oAppComponent.getRootViewController().onContextBoundToView(o);},navigateToTarget:function(o,n){var N=this._oPageComponent&&this._oPageComponent.getNavigationConfiguration&&this._oPageComponent.getNavigationConfiguration(n);if(N){var D=N.detail;var r=D.route;var p=D.parameters;this._oRoutingService.navigateTo(o,r,p,true);}else{this._oRoutingService.navigateTo(o,null,null,true);}this._oView.getViewData();},navigateToContext:function(o,p){var t=this;var h={};p=p||{};if(o.isA("sap.ui.model.odata.v4.ODataListBinding")){if(p.asyncContext){this._oRouterProxy.activateRouteMatchSynchronization();p.asyncContext.then(function(o){t.navigateToContext(o,{checkNoHashChange:p.checkNoHashChange,editable:p.editable,bPersistOPScroll:p.bPersistOPScroll,updateFCLLevel:p.updateFCLLevel});}).catch(function(i){L.error("Error with the async context",i);});}else if(!p.bDeferredContext){throw"navigation to a list binding is not yet supported";}}else if(o.getBinding()&&o.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){if(c.hasTransientContext(o.getBinding())){return this.oView.getModel("sap.fe.i18n").getResourceBundle().then(function(r){var T=c.getTranslatedText("C_ROUTING_NAVIGATION_DISABLED_TITLE",r,null,o.getBinding().getPath().substr(1));L.warning(T);M.show(T,{icon:M.Icon.WARNING,title:T,actions:[M.Action.CLOSE],details:r.getText("C_TRANSACTION_HELPER_TRANSIENT_CONTEXT_DESCRIPTION"),contentWidth:"100px"});});}}if(p.callExtension){h.sourceBindingContext=o.getObject();if(p.oEvent){h.oEvent=p.oEvent;}if(this.base.getView().getController().routing.onBeforeNavigation(h)){return Promise.resolve();}}p.FCLLevel=this._getFCLLevel();return this._oRoutingService.navigateToContext(o,p,this._oView.getViewData(),this._oTargetInformation);},navigateBackFromContext:function(o,p){p=p||{};p.updateFCLLevel=-1;return this.navigateToContext(o,p);},navigateForwardToContext:function(o,p){if(this._oView.getBindingContext("internal").getProperty("messageFooterContainsErrors")===true){return Promise.resolve();}p=p||{};p.updateFCLLevel=1;return this.navigateToContext(o,p,true);},navigateBackFromTransientState:function(){var h=this._oRouterProxy.getHash();if(h.indexOf("(...)")!==-1){this._oRouterProxy.navBack();}},navigateToMessagePage:function(s,p){p=p||{};if(this._oRouterProxy.getHash().indexOf("i-action=create")>-1){this._oRouterProxy.navToHash(this._oRoutingService.getDefaultCreateHash());}p.FCLLevel=this._getFCLLevel();this._oAppComponent.getRootViewController().displayMessagePage(s,p);},isCurrentStateImpactedBy:function(o){return this._oRoutingService.isCurrentStateImpactedBy(o);},_onRouteMatched:function(o){var t=o.getParameter("routeInformation")&&o.getParameter("routeInformation").targets;if(!t||t.indexOf(this._oTargetInformation.targetName)===-1){return;}var T;if(this._oPageComponent&&this._oPageComponent.getBindingContextPattern){T=this._oPageComponent.getBindingContextPattern();}T=T||this._oTargetInformation.contextPattern;if(T===null||T===undefined){T=o.getParameter("routePattern");}T=T.replace(":?query:","");var A=o.getParameters().arguments,D=false,n=o.getParameter("navigationInfo");for(var k in A){var v=A[k];if(v==="..."&&T.indexOf("{"+k+"}")>=0){D=true;n.bTargetEditable=true;}T=T.replace("{"+k+"}",v);}if(T&&T[0]!=="/"){T="/"+T;}this.onRouteMatched();var h;if(D){h=this._bindDeferred(T,n);}else{h=this._bindPage(T,n);}var i=this;h.finally(function(){i.onRouteMatchedFinished();});this._oAppComponent.getRootViewController().updateUIStateForView(this._oView,this._getFCLLevel());},_bindDeferred:function(t,n){this.onBeforeBinding(null,{editable:n.bTargetEditable});if(n.bDeferredContext||!n.oAsyncContext){if(this._oPageComponent&&this._oPageComponent.createDeferredContext){this._oPageComponent.createDeferredContext(t);}}if(this._getBindingContext()&&this._getBindingContext().hasPendingChanges()){this._getBindingContext().getBinding().resetChanges();}this._setBindingContext(null);this.onAfterBinding(null);return Promise.resolve();},_bindPage:function(t,n){var h=this;if(t===""){return Promise.resolve(this._bindPageToContext(null,n));}else{return this._resolveSemanticPath(t).then(function(T){h._bindPageToPath(T,n);}).catch(function(o){var r=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");h.navigateToMessagePage(r.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:r.getText("C_COMMON_SAPFE_ERROR"),description:o.message});});}},_resolveSemanticPath:function(p){var o=this._oView.getModel(),h=o.getMetaModel(),l=this._oRoutingService.getLastSemanticMapping(),s=this._oRouter.getHashChanger().getHash().split("?")[0],t=this;if(s&&s.lastIndexOf("/")===s.length-1){s=s.substring(0,s.length-1);}var r=s&&s.substr(0,s.indexOf("("));if(r.indexOf("/")===0){r=r.substring(1);}var A=f(s,h),i=A&&S.getSemanticKeys(h,r);if(!i){return Promise.resolve(p);}else if(l&&l.semanticPath===p){return Promise.resolve(l.technicalPath);}else{return g(s,o,i).then(function(T){if(T&&T!==p){t._oRoutingService.setLastSemanticMapping({technicalPath:T,semanticPath:p});return T;}else{return p;}});}},_bindPageToPath:function(t,n){var o=this._getBindingContext(),s=o&&o.getPath(),u=n.useContext;if(s!==t||(u&&u.getPath()===t)){var T;if(u&&u.getPath()===t){T=u;}else{T=this._createBindingContext(t);}this._bindPageToContext(T,n);}else if(!n.bReasonIsIappState&&E.isEditStateDirty()){this._refreshBindingContext(o);}},_bindPageToContext:function(o,n){var t=this;if(!o){this.onBeforeBinding(null);this.onAfterBinding(null);}else{var p=o.getBinding();if(!o.getBinding()||o.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){o=this._createBindingContext(o.getPath());if(E.isEditStateDirty()){setTimeout(function(){t._refreshBindingContext(o);},0);}}this.onBeforeBinding(o,{editable:n.bTargetEditable,listBinding:p,bPersistOPScroll:n.bPersistOPScroll});this._setBindingContext(o);this.onAfterBinding(o);}},_createBindingContext:function(p){var s=this._oPageComponent&&this._oPageComponent.getEntitySet&&this._oPageComponent.getEntitySet(),o=this._oView.getModel(),h=o.getMetaModel(),t=this,P={$$patchWithoutSideEffects:true,$$groupId:"$auto.Heroes",$$updateGroupId:"$auto"};if(s){var i=h.getProperty("/"+s+"/@com.sap.vocabularies.Common.v1.Messages/$Path");if(i){P.$select=i;}}var D=h.getObject("/"+s+"@com.sap.vocabularies.Common.v1.DraftRoot");var j=h.getObject("/"+s+"@com.sap.vocabularies.Common.v1.DraftNode");if(D||j){if(P.$select===undefined){P.$select="HasActiveEntity,HasDraftEntity,IsActiveEntity";}else{P.$select+=",HasActiveEntity,HasDraftEntity,IsActiveEntity";}}var H=o.bindContext(p,undefined,P);H.attachEventOnce("dataRequested",function(){B.lock(t._oView);});H.attachEventOnce("dataReceived",function(k){var l=k&&k.getParameter("error");B.unlock(t._oView);if(l){sap.ui.getCore().getLibraryResourceBundle("sap.fe.core",true).then(function(r){m.removeUnboundTransitionMessages();t.navigateToMessagePage(r.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:r.getText("SAPFE_ERROR"),description:l});}).catch(function(n){L.error("Error while getting the core resource bundle",n);});}});return H.getBoundContext();},_refreshBindingContext:function(o){var s=this._oPageComponent&&this._oPageComponent.getEntitySet&&this._oPageComponent.getEntitySet(),h=this._oView.getModel().getMetaModel(),j,n=[],p=[],k=[];function l(q){var D,P=q.getPath();if(q.isA("sap.ui.model.odata.v4.ODataContextBinding")){D=q.getDependentBindings();if(D){for(var i=0;i<D.length;i++){l(D[i]);}}else if(n.indexOf(P)===-1){n.push(P);}}else if(q.isA("sap.ui.model.odata.v4.ODataListBinding")){if(n.indexOf(P)===-1){n.push(P);}}else if(q.isA("sap.ui.model.odata.v4.ODataPropertyBinding")){if(p.indexOf(P)===-1){p.push(P);}}}if(s){j=h.getProperty("/"+s+"/@com.sap.vocabularies.Common.v1.Messages/$Path");}l(o.getBinding());var i;for(i=0;i<n.length;i++){k.push({$NavigationPropertyPath:n[i]});}for(i=0;i<p.length;i++){k.push({$PropertyPath:p[i]});}if(j){k.push({$PropertyPath:j});}o.requestSideEffects(k);},_getBindingContext:function(){if(this._oPageComponent){return this._oPageComponent.getBindingContext();}else{return this._oView.getBindingContext();}},_setBindingContext:function(o){if(this._oPageComponent){this._oPageComponent.setBindingContext(o);}else{this._oView.setBindingContext(o);}},_getFCLLevel:function(){return this._oTargetInformation.FCLLevel;},enterFullScreen:function(){var s=this.base.getView();var o=s.getBindingContext(),n=s.getModel("fclhelper").getProperty("/actionButtonsInfo/fullScreen");this.base._routing.navigateToContext(o,{sLayout:n});},exitFullScreen:function(){var s=this.base.getView();var o=s.getBindingContext(),n=s.getModel("fclhelper").getProperty("/actionButtonsInfo/exitFullScreen");this.base._routing.navigateToContext(o,{sLayout:n});},closeColumn:function(){var s=this.base.getView();var o=s.getBindingContext();this.base._routing.navigateBackFromContext(o,{noPreservationCache:true});},override:{onExit:function(){this._oRoutingService.detachRouteMatched(this._fnRouteMatchedBound);},onInit:function(){var t=this;this._oView=this.base.getView();this._oAppComponent=c.getAppComponent(this._oView);this._oPageComponent=b.getOwnerComponentFor(this._oView);this._oRouter=this._oAppComponent.getRouter();this._oRouterProxy=this._oAppComponent.getRouterProxy();if(!this._oAppComponent||!this._oPageComponent){throw new Error("Failed to initialize controler extension 'sap.fe.core.controllerextesions.InternalRouting");}if(this._oAppComponent===this._oPageComponent){this._oPageComponent=null;}this._oAppComponent.getService("routingService").then(function(r){t._oRoutingService=r;t._fnRouteMatchedBound=t._onRouteMatched.bind(t);t._oRoutingService.attachRouteMatched(t._fnRouteMatchedBound);t._oTargetInformation=r.getTargetInformationFor(t._oPageComponent||t._oView);}).catch(function(){throw new Error("This controller extension cannot work without a 'routingService' on the main AppComponent");});}}},a);});
