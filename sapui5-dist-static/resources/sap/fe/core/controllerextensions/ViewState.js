sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/base/Log","sap/base/util/merge","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/p13n/StateUtil","sap/fe/navigation/library"],function(C,O,L,m,a,S,N){"use strict";var A="#additionalStates",b=N.NavType;var _={"sap.ui.fl.variants.VariantManagement":{retrieve:function(v){return{"variantId":v.getModified()?v.getId():v.getCurrentVariantKey()};},apply:function(v,c){if(c&&c.variantId!==undefined&&c.variantId!==v.getCurrentVariantKey()){return a.activateVariant({element:v,variantReference:c.variantId});}}},"sap.m.IconTabBar":{retrieve:function(t){return{selectedKey:t.getSelectedKey()};},apply:function(t,c){if(c&&c.selectedKey){var s=t.getItems().find(function(i){return i.getKey()===c.selectedKey;});if(s){t.setSelectedItem(s);}}}},"sap.ui.mdc.FilterBar":{retrieve:function(f){return S.retrieveExternalState(f).then(function(F){var p=f.getPropertyInfoSet(),c=F.filter||{};p.filter(function(P){return(c[P.path]&&(P.removeFromAppState||c[P.path].length===0));}).forEach(function(P){delete c[P.path];});return F;});},apply:function(f,c){if(c){return S.applyExternalState(f,c);}}},"sap.ui.mdc.Table":{retrieve:function(t){return S.retrieveExternalState(t);},apply:function(t,c){if(c){return S.applyExternalState(t,c);}}},"sap.uxap.ObjectPageLayout":{retrieve:function(o){return{selectedSection:o.getSelectedSection()};},apply:function(o,c){c&&o.setSelectedSection(c.selectedSection);}},"sap.m.SegmentedButton":{retrieve:function(s){return{selectedKey:s.getSelectedKey()};},apply:function(s,c){c&&s.setSelectedKey(c.selectedKey);}},"sap.m.Select":{retrieve:function(s){return{selectedKey:s.getSelectedKey()};},apply:function(s,c){c&&s.setSelectedKey(c.selectedKey);}},"sap.f.DynamicPage":{retrieve:function(d){return{headerExpanded:d.getHeaderExpanded()};},apply:function(d,c){c&&d.setHeaderExpanded(c.headerExpanded);}},"sap.ui.core.mvc.View":{retrieve:function(v){var c=v.getController();if(c&&c.viewState){return c.viewState.retrieveViewState();}return{};},apply:function(v,c,n){var o=v.getController();if(o&&o.viewState){return o.viewState.applyViewState(c,n);}}},"sap.ui.core.ComponentContainer":{retrieve:function(c){var o=c.getComponentInstance();if(o){return this.retrieveControlState(o.getRootControl());}return{};},apply:function(c,o,n){var d=c.getComponentInstance();if(d){return this.applyControlState(d.getRootControl(),o,n);}}}};var V=C.extend("sap.fe.core.controllerextensions.ViewState",{metadata:{methods:{collectResults:{"public":false,"final":true},adaptControlStateHandler:{"public":false,"final":false,overrideExecution:O.After},getControlStateHandler:{"public":false,"final":true},adaptStateControls:{"public":false,"final":false,overrideExecution:O.After},retrieveAdditionalStates:{"public":false,"final":false,overrideExecution:O.After},retrieveViewState:{"public":true,"final":true},retrieveControlState:{"public":false,"final":true},applyInitialStateOnly:{"public":false,"final":false,overrideExecution:O.Instead},applyViewState:{"public":true,"final":true},applyControlState:{"public":false,"final":true},applyAdditionalStates:{"public":false,"final":false,overrideExecution:O.After},applyNavigationParameters:{"public":false,"final":false,overrideExecution:O.After},onBeforeStateApplied:{"public":false,"final":false,overrideExecution:O.After},onAfterStateApplied:{"public":false,"final":false,overrideExecution:O.After}}},constructor:function(){C.apply(this);var t=this;t._iRetrievingStateCounter=0;this._pInitialStateApplied=new Promise(function(r){t._pInitialStateAppliedResolve=r;});},destroy:function(){delete this._pInitialStateApplied;delete this._pInitialStateAppliedResolve;delete this._iRetrievingStateCounter;C.prototype.destroy.apply(this);},collectResults:function(c){var r=[],d=Array.prototype.slice.call(arguments,1);d.push(r);c.apply(this,d);return Promise.all(r);},adaptControlStateHandler:function(c,d){},getControlStateHandler:function(c){var i=[],d=[];if(c){for(var t in _){if(c.isA(t)){i.push(Object.assign({},_[t]));break;}}}this.adaptControlStateHandler(c,d);return i.concat(d);},adaptStateControls:function(c){},getStateKey:function(c){return this.getView().getLocalId(c.getId())||c.getId();},retrieveViewState:function(){var t=this;++t._iRetrievingStateCounter;return t._pInitialStateApplied.then(function(){return t.collectResults(t.adaptStateControls);}).then(function(c){return Promise.all(c.filter(function(o){return o&&o.isA&&o.isA("sap.ui.base.ManagedObject");}).map(function(o){return t.retrieveControlState(o).then(function(r){return{key:t.getStateKey(o),value:r};});}));}).then(function(r){return r.reduce(function(s,c){var o={};o[c.key]=c.value;return m(s,o);},{});}).then(function(v){return Promise.resolve(t._retrieveAdditionalStates()).then(function(c){if(c&&Object.keys(c).length){v[A]=c;}return v;});}).finally(function(){--t._iRetrievingStateCounter;}).then(function(v){return t._iRetrievingStateCounter===0?v:undefined;});},retrieveAdditionalStates:function(c){},_retrieveAdditionalStates:function(){var c={};this.retrieveAdditionalStates(c);return c;},retrieveControlState:function(c){var d=this.getControlStateHandler(c);return Promise.all(d.map(function(e){if(typeof e.retrieve!=="function"){throw new Error("controlStateHandler.retrieve is not a function for control: "+c.getMetadata().getName());}return e.retrieve.call(this,c);})).then(function(s){return s.reduce(function(f,o){return m(f,o);},{});});},applyInitialStateOnly:function(){return false;},applyViewState:function(v,n){var t=this;if(this.applyInitialStateOnly()&&this._getInitialStateApplied()){return Promise.resolve();}return this.collectResults(this.onBeforeStateApplied).then(function(){return t.collectResults(t.adaptStateControls);}).then(function(c){var p=Promise.resolve();c.filter(function(o){return o&&o.isA&&o.isA("sap.ui.base.ManagedObject");}).forEach(function(o){var k=t.getStateKey(o);p=p.then(t.applyControlState.bind(t,o,v?v[k]:undefined,n));});return p;}).then(function(){if(n.navigationType===b.iAppState){return t.collectResults(t.applyAdditionalStates,v?v[A]:undefined);}else{return t.collectResults(t.applyNavigationParameters,n);}}).finally(function(){return t.collectResults(t.onAfterStateApplied).then(t._setInitialStateApplied.bind(t));});},_setInitialStateApplied:function(){if(this._pInitialStateAppliedResolve){var p=this._pInitialStateAppliedResolve;delete this._pInitialStateAppliedResolve;p();}},_getInitialStateApplied:function(){return!this._pInitialStateAppliedResolve;},onBeforeStateApplied:function(p){},onAfterStateApplied:function(p){},applyAdditionalStates:function(v,p){},applyNavigationParameters:function(n,p){},applyControlState:function(c,o,n){var d=this.getControlStateHandler(c),p=Promise.resolve(),t=this;d.forEach(function(e){if(typeof e.apply!=="function"){throw new Error("controlStateHandler.apply is not a function for control: "+c.getMetadata().getName());}p=p.then(e.apply.bind(t,c,o,n));});return p;}});return V;});
