sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/fe/navigation/SelectionVariant","sap/fe/core/helpers/ModelHelper","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/base/Log"],function(C,O,S,M,X,a,F,J,L){"use strict";return C.extend("sap.fe.core.controllerextensions.InternalInternalBasedNavigation",{metadata:{methods:{navigate:{"final":true,"public":true},getEntitySet:{"final":false,"public":false},navigateOutbound:{"final":true,"public":true},navigateWithConfirmationDialog:{"final":true,"public":true},getNavigationMode:{"final":false,"public":true,overrideExecution:O.Instead}}},navigate:function(s,A,n){var N=n&&n.navigationContexts,b=N&&!Array.isArray(N)?[N]:N,v=n&&n.semanticObjectMapping,t={semanticObject:s,action:A};if(s&&A){var c,o=new S(),d=this;if(b&&b.length){c=b.map(function(i){if(i.isA&&i.isA("sap.ui.model.odata.v4.Context")){var j=i.getObject(),k=d._oMetaModel.getMetaPath(i.getPath());return d._removeSensitiveData(j,k);}else if(typeof i==="object"){return d._removeSensitiveData(i.data,i.metaPath);}});}if(c&&c.length){o=this._oNavigationService.mixAttributesAndSelectionVariant(c,o.toJSONString());}var m=this._oView.getModel(),e=this.getEntitySet(),f=e?this._oNavigationService.constructContextUrl(e,m):undefined;if(f){o.setFilterContextUrl(f);}this.base.getView().getController().intentBasedNavigation.adaptNavigationContext(o,t);if(v){this._applySemanticObjectMappings(o,v);}this._removeTechnicalParameters(o);var g=this.base.getView().getController()._intentBasedNavigation.getNavigationMode();var h=function(){sap.ui.require(["sap/m/MessageBox"],function(i){var r=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");i.show(r.getText("C_COMMON_HELPER_NAVIGATION_ERROR_MESSAGE"),{title:r.getText("C_COMMON_NAVIGATION_ERROR_TITLE")});});};this._oNavigationService.navigate(s,A,o.toJSONString(),null,h,null,g);}else{throw new Error("Semantic Object/action is not provided");}},getNavigationMode:function(){return"inplace";},navigateWithConfirmationDialog:function(s,A,n){var t=this;if(n.notApplicableContexts&&n.notApplicableContexts.length>=1){var o;var c={onClose:function(){o.close();},onContinue:function(){n.navigationContexts=n.applicableContexts;o.close();t.navigate(s,A,n);}};var f=function(){var D,h=n.notApplicableContexts.length,N=[];for(var i=0;i<n.notApplicableContexts.length;i++){D=n.notApplicableContexts[i].getObject();N.push(D);}var j=new J(N);var T=new J({total:h,label:n.label});o.setModel(j,"notApplicable");o.setModel(T,"totals");o.open();};var b="sap.fe.core.controls.ActionPartial";var d=a.loadTemplate(b,"fragment");var m=this._oView.getModel();var e=m.getMetaModel();var g=n.notApplicableContexts[0].getCanonicalPath();var E=g.substr(0,g.indexOf("("))+"/";Promise.resolve(X.process(d,{name:b},{bindingContexts:{entityType:e.createBindingContext(E)},models:{entityType:e,metaModel:e}})).then(function(h){return F.load({definition:h,controller:c});}).then(function(p){o=p;t.getView().addDependent(p);f();}).catch(function(){L.error("Error");});}else{t.navigate(s,A,n);}},_removeTechnicalParameters:function(s){s.removeSelectOption("@odata.context");s.removeSelectOption("@odata.metadataEtag");s.removeSelectOption("SAP__Messages");},getEntitySet:function(){return this._oView.getViewData().entitySet;},_removeSensitiveData:function(A,m){var p=Object.keys(A);if(p.length){delete A["@odata.context"];delete A["@odata.metadataEtag"];delete A["SAP__Messages"];for(var j=0;j<p.length;j++){var P=p[j],b=this._oMetaModel.getObject(m+"/"+P+"@");if(b){if(b["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||b["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||b["@com.sap.vocabularies.Analytics.v1.Measure"]){delete A[P];}else if(b["@com.sap.vocabularies.Common.v1.FieldControl"]){var f=b["@com.sap.vocabularies.Common.v1.FieldControl"];if(f["$EnumMember"]&&f["$EnumMember"].split("/")[1]==="Inapplicable"){delete A[P];}else if(f["$Path"]&&this._isFieldControlPathInapplicable(f["$Path"],A)){delete A[P];}}}}}return A;},_isFieldControlPathInapplicable:function(f,A){var i=false,p=f.split("/");if(p.length>1){i=A[p[0]]&&A[p[0]].hasOwnProperty(p[1])&&A[p[0]][p[1]]===0;}else{i=A[f]===0;}return i;},_applySemanticObjectMappings:function(s,m){var o=typeof m==="string"?JSON.parse(m):m;for(var i=0;i<o.length;i++){var l=(o[i]["LocalProperty"]&&o[i]["LocalProperty"]["$PropertyPath"])||(o[i]["@com.sap.vocabularies.Common.v1.LocalProperty"]&&o[i]["@com.sap.vocabularies.Common.v1.LocalProperty"]["$Path"]);var b=o[i]["SemanticObjectProperty"]||o[i]["@com.sap.vocabularies.Common.v1.SemanticObjectProperty"];if(s.getSelectOption(l)){var c=s.getSelectOption(l);s.removeSelectOption(l);s.massAddSelectOption(b,c);}}return s;},navigateOutbound:function(o,n){var m=this.base.getAppComponent().getManifestEntry("sap.app"),b=m.crossNavigation&&m.crossNavigation.outbounds[o];if(!b){L.error("Outbound is not defined in manifest!!");return;}var s=b.semanticObject,A=b.action,c=b.parameters&&this._getOutboundParams(b.parameters);if(n||c){n={navigationContexts:{data:n||c}};}this.base._intentBasedNavigation.navigate(s,A,n);},_getOutboundParams:function(o){var p={};if(o){var P=Object.keys(o)||[];if(P.length>0){P.forEach(function(k){var m=o[k];if(m.value&&m.value.value&&m.value.format==="plain"){if(!p[k]){p[k]=m.value.value;}}});}}return p;},override:{onInit:function(){this._oAppComponent=this.base.getAppComponent();this._oMetaModel=this._oAppComponent.getModel().getMetaModel();this._oNavigationService=this._oAppComponent.getNavigationService();this._oView=this.base.getView();}}});});
