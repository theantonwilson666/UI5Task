sap.ui.define(["sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/model/base/ManagedObjectModel","sap/ui/model/resource/ResourceModel","sap/ui/core/mvc/View","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/base/Log","sap/fe/core/TemplateModel","sap/fe/core/helpers/DynamicAnnotationPathHelper","sap/ui/core/cache/CacheManager","sap/base/strings/hash","sap/ui/VersionInfo","sap/ui/Device"],function(S,a,b,M,R,V,C,J,L,T,D,c,h,d,e){"use strict";var f=S.extend("sap.fe.core.services.TemplatedViewService",{initPromise:null,init:function(){var t=this;var s=[];var o=this.getContext();var g=o.scopeObject;var A=C.getOwnerComponentFor(g);var m=A.getMetaModel();var j=A.getMetadata().getComponentName()+"::"+A.getLocalId(g.getId());var E=g.getEnhanceI18n()||[];var k;if(E){k=A.getMetadata().getComponentName();for(var i=0;i<E.length;i++){var r=A.getModel(E[i]);if(r&&r.isA("sap.ui.model.resource.ResourceModel")){E[i]=r;}else{E[i]=k+"."+E[i].replace(".properties","");}}}var l=A.getMetadata().getName()+"_"+j+"_"+sap.ui.getCore().getConfiguration().getLanguageTag();s.push(b.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:g,settings:{bundles:["sap.fe.core.messagebundle","sap.fe.templates.messagebundle"],enhanceI18n:E,modelName:"sap.fe.i18n"}}).then(function(n){t.oResourceModelService=n;return n.getResourceModel();}));s.push(b.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:m}}).then(function(n){t.oCacheHandlerService=n;return n.validateCacheKey(l);}));s.push(d.load().then(function(I){var n="";if(!I.libraries){n=sap.ui.buildinfo.buildtime;}else{I.libraries.forEach(function(q){n+=q.buildTimestamp;});}return n;}).catch(function(){return"<NOVALUE>";}));var p="";this.initPromise=Promise.all(s).then(function(n){var q=n[1];var v=n[2];var u=A.getManifest();var w=A.getShellServices();var x=h(JSON.stringify({sapApp:u["sap.app"],viewData:g.getViewData()}));p=q+"-"+x+"-"+v+"-"+j+"-"+w.instanceType+"-pageModel";return Promise.all(n.concat([t._getCachedModel(p)]));}).then(function(n){var r=n[0];var q=n[1];var P=n[3];return new Promise(function(u){sap.ui.require(["sap/fe/core/converters/TemplateConverter"],function(v){u(t.createView(r,j,q,p,P,v));});});}).then(function(n){var q=b.get("sap.fe.core.services.CacheHandlerService").getInstance(m);q.invalidateIfNeeded(n,l);});},_getCachedModel:function(s){if(sap.ui.getCore().getConfiguration().getViewCache()){return c.get(s);}return undefined;},_setCachedModel:function(s,o){if(sap.ui.getCore().getConfiguration().getViewCache()){c.set(s,o);}return undefined;},refreshView:function(o){var t=this;var r=o.getRootControl();if(r){r.destroy();}else if(t.oView){t.oView.destroy();}return t.createView(t.resourceModel,t.stableId,"","",undefined,t.TemplateConverter).then(function(){o.oContainer.invalidate();}).catch(function(E){o.oContainer.invalidate();L.error(E);});},createView:function(r,s,g,p,P,i){var t=this;t.resourceModel=r;t.stableId=s;t.TemplateConverter=i;var o=this.getContext(),m=o.settings,j=m.converterType,k=o.scopeObject,A=C.getOwnerComponentFor(k),F=A.getRoutingService().getTargetInformationFor(k).options.settings.fullContextPath,l=A.getMetaModel(),n=A.getManifest(),q=new J(sap.ui.Device).setDefaultBindingMode("OneWay"),u=new J(n),E=false,v,w,x,y;this.oFactory=o.factory;function z(){var G=F.split("/");var H=G.reduce(function(I,N){if(N===""){return I;}if(I===""){I="/"+N;}else{var K=l.getObject(I+"/$NavigationPropertyBinding/"+N);if(K&&Object.keys(K).length>0){I+="/$NavigationPropertyBinding";}I+="/"+N;}return I;},"");var x={type:"XML",preprocessors:{xml:{bindingContexts:{entitySet:H?l.createBindingContext(H):null,fullContextPath:F?l.createBindingContext(F):null,contextPath:F?l.createBindingContext(F):null,converterContext:v.createBindingContext("/",null,{noResolve:true}),viewData:y?w.createBindingContext("/"):null},models:{entitySet:l,fullContextPath:l,contextPath:l,"sap.fe.i18n":r,metaModel:l,"sap.fe.deviceModel":q,manifest:u,converterContext:v,viewData:w},appComponent:A}},id:s,viewName:m.viewName||k.getViewName(),viewData:y,cache:{keys:[g]},models:{"sap.fe.i18n":r},height:"100%"};return x;}function B(G){L.error(G.message,G);x.viewName=m.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage";x.preprocessors.xml.models["error"]=new J(G);return k.runAsOwner(function(){return V.create(x).then(function(H){t.oView=H;t.oView.setModel(new M(t.oView),"$view");k.setAggregation("rootControl",t.oView);return g;});});}return A.getService("routingService").then(function(G){var H=G.getTargetInformationFor(k);var O=n["sap.app"]&&n["sap.app"].crossNavigation&&n["sap.app"].crossNavigation.outbounds;var N=k.getNavigation()||{};Object.keys(N).forEach(function(K){var Q=N[K];var U;if(Q.detail&&Q.detail.outbound&&O[Q.detail.outbound]){U=O[Q.detail.outbound];Q.detail.outboundDetail={semanticObject:U.semanticObject,action:U.action,parameters:U.parameters};}if(Q.create&&Q.create.outbound&&O[Q.create.outbound]){U=O[Q.create.outbound];Q.create.outboundDetail={semanticObject:U.semanticObject,action:U.action,parameters:U.parameters};}});y={navigation:N,viewLevel:H.viewLevel,stableId:s,contentDensities:n["sap.ui5"].contentDensities,resourceBundle:r.__bundle,fullContextPath:F,isDesktop:e.system.desktop};if(k.getViewData){Object.assign(y,k.getViewData());}y.converterType=j;w=new J(y);if(y&&y.controlConfiguration){Object.keys(y.controlConfiguration).forEach(function(K){if(K.indexOf("[")!==-1){var Q=D.resolveDynamicExpression(K,l);y.controlConfiguration[Q]=y.controlConfiguration[K];}});}var I=A.getShellServices();v=new T(function(){try{if(!!P){return P;}else{var K=A.getDiagnostics();var Q=K.getIssues().length;var U=i.convertPage(j,l,y,I,K,F,A.getEnvironmentCapabilities().getCapabilities());var W=K.getIssues();var X=W.slice(Q);if(X.length>0){L.warning("Some issues have been detected in your project, please check the UI5 support assistant rule for sap.fe.core");}t._setCachedModel(p,U);return U;}}catch(Y){L.error(Y,Y);return{};}},l);if(!E){x=z();k.setModel(v,"_pageModel");return k.runAsOwner(function(){return V.create(x).catch(B).then(function(K){t.oView=K;t.oView.setModel(new M(t.oView),"$view");t.oView.setModel(w,"viewData");k.setAggregation("rootControl",t.oView);return g;}).catch(L.error);});}}).catch(function(G){L.error(G.message,G);throw new Error("Error while creating view : "+G);});},getView:function(){return this.oView;},exit:function(){this.oResourceModelService&&this.oResourceModelService.destroy();this.oCacheHandlerService&&this.oCacheHandlerService.destroy();this.oFactory.removeGlobalInstance();}});return a.extend("sap.fe.core.services.TemplatedViewServiceFactory",{_oInstanceRegistry:{},createInstance:function(s){var t=new f(Object.assign({factory:this},s));return t.initPromise.then(function(){return t;});},removeGlobalInstance:function(){this._oInstanceRegistry={};}});},true);
