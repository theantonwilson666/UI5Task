/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/Dialog","sap/m/Button","sap/m/Text","sap/m/MessageBox","sap/fe/core/actions/messageHandling","sap/fe/core/CommonUtils","sap/fe/core/helpers/SideEffectsUtil","sap/base/Log"],function(D,B,T,M,m,C,S,L){"use strict";var d={EDIT:"EditAction",ACTIVATION:"ActivationAction",DISCARD:"DiscardAction",PREPARE:"PreparationAction"};function g(o,O){var p=o.getModel(),q=p.getMetaModel(),E=q.getMetaPath(o.getPath());return q.getObject(E+"@com.sap.vocabularies.Common.v1.DraftRoot/"+O);}function c(o,O,p){var s=g(o,O);return o.getModel().bindContext(s+"(...)",o,p);}function h(o){return!!g(o,d.PREPARE);}function e(o,p){if(o.getProperty("IsActiveEntity")){var O={$$inheritExpandSelect:true};var q=c(o,d.EDIT,O);q.setParameter("PreserveChanges",p);var E=q.execute("direct").then(function(s){return s;});q.getModel().submitBatch("direct");return E;}else{throw new Error("The edit action cannot be executed on a draft document");}}function a(o,G){if(!o.getProperty("IsActiveEntity")){var O=c(o,d.ACTIVATION,{$$inheritExpandSelect:true});return O.execute(G).then(function(A){return A;}).catch(function(){if(h(o)){var A=g(o,d.PREPARE),p=S.getSideEffectsForAction(A,o),t=p&&p.pathExpressions;if(t){o.requestSideEffects(t).catch(function(E){L.error("Error while requesting side effects",E);});}else{r(o).catch(function(E){L.error("Error while requesting messages",E);});}}return Promise.reject();});}else{throw new Error("The activation action cannot be executed on an active document");}}function b(o,G,p){if(!o.getProperty("IsActiveEntity")){var O=c(o,d.PREPARE);O.setParameter("SideEffectsQualifier","");G=G||O.getGroupId();var P=O.execute(G).then(function(){return O;}).catch(function(E){L.error("Error while executing the operation",E);});if(p){var A=g(o,d.PREPARE),q=S.getSideEffectsForAction(A,o),t=q&&q.pathExpressions;if(t){o.requestSideEffects(t,G).catch(function(E){L.error("Error while requesting side effects",E);});}else{r(o);}}return P;}else{throw new Error("The preparation action cannot be executed on an active document");}}function f(o){var p=o.getModel(),q=p.getMetaModel(),E=q.getMetaPath(o.getPath());return q.getObject(E+"/@com.sap.vocabularies.Common.v1.Messages/$Path");}function r(o){var s=f(o);if(s){return o.requestSideEffects([{$PropertyPath:s}]);}}function i(o){if(!o.getProperty("IsActiveEntity")){var p=c(o,d.DISCARD);var q=p.execute("direct");o.getModel().submitBatch("direct");return q;}else{throw new Error("The discard action cannot be executed on an active document");}}function j(o,p){var P=p||{},q=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core"),R=typeof P.bPreserveChanges==="undefined"||(typeof P.bPreserveChanges==="boolean"&&P.bPreserveChanges);function s(O){if(O){var u=o.getModel(),v,w=u.bindContext(o.getPath()+"/DraftAdministrativeData").getBoundContext();return p.oView.getModel("sap.fe.i18n").getResourceBundle().then(function(_){v=_;return w.requestObject();}).then(function(x){if(x){m.removeUnboundTransitionMessages();var I=x.InProcessByUserDescription||x.InProcessByUser;var E=p.oView.getViewData().entitySet;if(I){var y=C.getTranslatedText("C_DRAFT_OBJECT_PAGE_DRAFT_LOCKED_BY_USER",v,I,E);M.error(y);throw new Error(y);}else{I=x.CreatedByUserDescription||x.CreatedByUser;var U=C.getTranslatedText("C_DRAFT_OBJECT_PAGE_DRAFT_UNSAVED_CHANGES",v,I,E);return t(U).then(function(){return e(o,false);});}}});}return Promise.reject(new Error("Draft creation aborted for document: "+o.getPath()));}function t(u){return new Promise(function(v,w){var x=new D({title:q.getText("C_DRAFT_OBJECT_PAGE_WARNING"),state:"Warning",content:new T({text:u}),beginButton:new B({text:q.getText("C_COMMON_OBJECT_PAGE_EDIT"),type:"Emphasized",press:function(){x.close();v(true);}}),endButton:new B({text:q.getText("C_COMMON_OBJECT_PAGE_CANCEL"),press:function(){x.close();w("Draft creation aborted for document: "+o.getPath());}}),afterClose:function(){x.destroy();}});x.addStyleClass("sapUiContentPadding");x.open();});}if(!o){return Promise.reject(new Error("Binding context to active document is required"));}return Promise.resolve(P.fnBeforeCreateDraftFromActiveDocument?P.fnBeforeCreateDraftFromActiveDocument(o,R):true).then(function(E){if(!E){throw new Error("Draft creation was aborted by extension for document: "+o.getPath());}return e(o,R).catch(function(u){if(R&&u.status===409){return Promise.resolve(P.fnWhenDecisionToOverwriteDocumentIsRequired?P.fnWhenDecisionToOverwriteDocumentIsRequired():true).then(s);}else{throw new Error(u);}});}).then(function(u){return Promise.resolve(P.fnAfterCreateDraftFromActiveDocument?P.fnAfterCreateDraftFromActiveDocument(o,u):u);}).then(function(u){if(P.bPrepareOnEdit&&h(u)){return b(u,undefined,true).then(function(){return u;});}return u;}).catch(function(u){return Promise.reject(u);});}function k(o,p){var P=p||{};if(!o){return Promise.reject(new Error("Binding context to draft document is required"));}return Promise.resolve(P.fnBeforeActivateDocument?P.fnBeforeActivateDocument(o):true).then(function(E){if(!E){return Promise.reject(new Error("Activation of the document was aborted by extension for document: "+o.getPath()));}if(!h(o)){return a(o);}var s="draft";var q=b(o,s,false);o.getModel().submitBatch(s);var A=a(o,s);return Promise.all([q,A]).then(function(v){return v[1];}).catch(function(t){return Promise.reject(t);});}).then(function(A){return Promise.resolve(P.fnAfterActivateDocument?P.fnAfterActivateDocument(o,A):A);}).catch(function(q){return Promise.reject(q);});}function l(o){var s=g(o,d.DISCARD),I=o.getObject().IsActiveEntity;if(I||(!I&&!s)){return o.delete();}else{return i(o);}}var n={createDraftFromActiveDocument:j,activateDocument:k,deleteDraft:l};return n;});
