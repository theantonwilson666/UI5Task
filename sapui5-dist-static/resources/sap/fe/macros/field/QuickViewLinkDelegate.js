/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/link/Panel","sap/ui/mdc/link/PanelItem","sap/ui/mdc/LinkDelegate","sap/ui/mdc/link/LinkItem","sap/ui/mdc/link/Factory","sap/ui/mdc/link/Log","sap/base/Log","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/core/Fragment","sap/fe/macros/field/FieldHelper","sap/base/util/isPlainObject","sap/ui/mdc/link/SemanticObjectMapping","sap/ui/mdc/link/SemanticObjectMappingItem","sap/ui/mdc/link/SemanticObjectUnavailableAction","sap/base/util/merge","sap/fe/navigation/SelectionVariant","sap/fe/core/CommonUtils","sap/ui/model/json/JSONModel","sap/ui/fl/Utils","sap/ui/util/openWindow"],function(P,a,L,b,F,c,S,X,d,e,f,g,h,k,l,m,o,C,J,U,p){"use strict";var q=Object.assign({},L);q._getEntityType=function(i,M){if(M){return M.createBindingContext(i.entityType);}};q._getSemanticsModel=function(i,M){if(M){var s=new J(i);return s;}};q._getDataField=function(i,M){return M.createBindingContext(i.dataField);};q._getContact=function(i,M){return M.createBindingContext(i.contact);};q.fnTemplateFragment=function(s){var t=this;var i=d.loadTemplate(s,"fragment");var j=this._getSemanticsModel(this.payLoad,this.oMetaModel);var n={};if(this.payLoad.entityType&&this._getEntityType(this.payLoad,this.oMetaModel)){n.bindingContexts={"entityType":this._getEntityType(this.payLoad,this.oMetaModel),"semantic":j.createBindingContext("/")};n.models={"entityType":this.oMetaModel,"semantic":j};}else if(this.payLoad.dataField&&this._getDataField(this.payLoad,this.oMetaModel)){n.bindingContexts={"dataField":this._getDataField(this.payLoad,this.oMetaModel),"semantic":j.createBindingContext("/")};n.models={"dataField":this.oMetaModel,"semantic":j};}else if(this.payLoad.contact&&this._getContact(this.payLoad,this.oMetaModel)){n.bindingContexts={"contact":this._getContact(this.payLoad,this.oMetaModel)};n.models={"contact":this.oMetaModel};}n.models.entitySet=this.oMetaModel;n.models.metaModel=this.oMetaModel;if(this.oControl&&this.oControl.getModel("viewData")){n.models.viewData=this.oControl.getModel("viewData");n.bindingContexts.viewData=this.oControl.getModel("viewData").createBindingContext("/");}return Promise.resolve(X.process(i,{name:s},n)).then(function(i){return e.load({definition:i,controller:t});});};q.onPressTitleLink=function(E){if(E.getParameter("target")!=="_blank"){var H=E.getSource().getHref();var u=F.getService("URLParsing");var t=E.getSource();var H=t.getHref();var T=H&&u.parseShellHash(H);var I=T&&T.semanticObject&&T.action&&T.semanticObject+"-"+T.action;var j=E.getSource().getCustomData()[0].getValue();for(var i=0;i<j.length;i++){if(j[i].key===I){t.setHref(j[i].href);break;}}H=t.getHref();var v=sap.ui.fl.Utils.getViewForControl(t);var A=C.getAppComponent(v);var n=v.getController();var r=n&&n.getView(),B=r&&r.getBindingContext();if(!B){B=t.getBindingContext();}E.preventDefault();this.beforeNavigationCallback(E).then(function(N){if(N){var s=u.parseShellHash(H);var w=A.getShellServices();var x={target:{semanticObject:s.semanticObject,action:s.action},params:s.params};if(C.isStickyEditMode(r)!==true){w.toExternal(x,A);}else{var y=w.hrefForExternal(x,A,false);p(y);}}}).catch(function(s){S.error("Error while resolving field value",s);});}};q.fetchAdditionalContent=function(i,B,j){this.oControl=j||B;this.payLoad=i;if(B&&(B.isA("sap.ui.model.odata.v4.Context")||B.isA("sap.ui.mdc.Link"))){this.oMetaModel=B.getModel().getMetaModel();return this.fnTemplateFragment("sap.fe.macros.field.QuickViewLinkDelegate").then(function(n){return[n];});}return Promise.resolve([]);};q.fetchLinkItems=function(i,B,I){if(B&&q._getSemanticObjects(i)){var j=B.getObject();var n=[];if(I){I.initialize(q._getSemanticObjects(i));n.forEach(function(r){I.addIntent(c.IntentType.API,{text:r.getText(),intent:r.getHref()});});}var s=q._calculateSemanticAttributes(j,i,I);return q._retrieveNavigationTargets("",s,i,I,this._link).then(function(r,O){return r.length===0?null:r;});}else{return Promise.resolve(null);}};q.fetchLinkType=function(i,j){var t=this;return new Promise(function(r){if(i){if(i.semanticObjects){t._link=j;var n=j.retrieveLinkItems();return Promise.all([n]).then(function(v){var s=v[0];var u;var w=2;if(s&&s.length===1){u=new b({text:s[0].getText(),href:s[0].getHref()});}if(u){w=1;}else if(s.length===0){w=0;}else{w=2;}r({initialType:{type:w,directLink:u?u:undefined},runtimeType:undefined});});}else if(i.contact&&i.contact.length>0){r({initialType:{type:2,directLink:undefined},runtimeType:undefined});}else if(i.entityType&&i.navigationPath){r({initialType:{type:2,directLink:undefined},runtimeType:undefined});}}else{throw new Error("no payload or semanticObjects found");}}).catch(function(E){S.error("Error in SimpleLinkDelegate.fetchLinkType",E);});};q.modifyLinkItems=function(i,B,j){if(j.length!==0){var n=j[0].getParent();var v=sap.ui.fl.Utils.getViewForControl(n);var M=v.getModel().getMetaModel();var A=C.getAppComponent(v);var r=n.getBindingContext();var s;var t;var T={semanticObject:i.mainSemanticObject,action:""};return new Promise(function(u){var N=A.getNavigationService();var w=v.getController();t=A.getShellServices();if(!t.hasUShell()){S.error("QuickViewLinkDelegate: Service 'URLParsing' could not be obtained");return Promise.reject();}if(v.getAggregation("content")[0]&&v.getAggregation("content")[0].getBindingContext()){var x=v.getAggregation("content")[0].getBindingContext();var E=M.getMetaPath(x.getPath()).replace(/^\/*/,"");var y=x.getObject();var z=r.getObject();var D=[{contextData:y,entitySet:E}];D=C.removeSensitiveData(D,M);var G=[{contextData:z,entitySet:E}];G=C.removeSensitiveData(G,M);var H=m({},D[0],G[0]);s=N.mixAttributesAndSelectionVariant(H,new o());}else{var I=w.filterBarConditions;s=q._getMergedContext(r,I,N);}v.getController().intentBasedNavigation.adaptNavigationContext(s,T);q._removeTechnicalParameters(s);if(v.getViewData().entitySet&&s){var K=N.constructContextUrl(v.getViewData().entitySet,v.getModel());s.setFilterContextUrl(K);}return N.getAppStateKeyAndUrlParameters(s.toJSONString()).then(function(O,Q){var R=Q;i.aSemanticLinks=[];var V,W;u(Promise.all(j.map(function(Y){return t.expandCompactHash(Y.getHref()).then(function(Z){V=t.parseShellHash(Z);var _=x===undefined?r:x;var $=[{contextData:V.params,entitySet:M.getMetaPath(_.getPath()).replace(/^\/*/,"")}];$=C.removeSensitiveData($,M);W={target:{semanticObject:V.semanticObject,action:V.action},params:Object.assign(O,$[0]),appStateKey:R};delete W.params["sap-xapp-state"];Y.setHref(t.crossAppNavService.hrefForExternal(W));i.aSemanticLinks.push(Y.getHref());return Y;});})));});}).catch(function(E){S.error("Error while getting the navigation service",E);});}else{return Promise.resolve(j);}};q.beforeNavigationCallback=function(i,E){return Promise.resolve(true);};q._removeTechnicalParameters=function(s){s.removeSelectOption("@odata.context");s.removeSelectOption("@odata.metadataEtag");s.removeSelectOption("SAP__Messages");};q._getMergedContext=function(i,j,n){var r,s;var M=i.getModel().getMetaModel();r=C.addExternalStateFiltersToSelectionVariant(new o(),j);var A=[{contextData:i.getObject(),entitySet:M.getMetaPath(i.getPath()).replace(/^\/*/,"")}];A=C.removeSensitiveData(A,M);s=n.mixAttributesAndSelectionVariant(A[0],r.toJSONString());return s;};q._calculateSemanticAttributes=function(i,j,I){var s=q._getSemanticObjects(j);var n=q._convertSemanticObjectMapping(q._getSemanticObjectMappings(j));if(!s.length){s.push("");}var r={};s.forEach(function(t){if(I){I.addContextObject(t,i);}r[t]={};for(var A in i){var u=null,T=null;if(I){u=I.getSemanticObjectAttribute(t,A);if(!u){u=I.createAttributeStructure();I.addSemanticObjectAttribute(t,A,u);}}if(i[A]===undefined||i[A]===null){if(u){u.transformations.push({value:undefined,description:"\u2139 Undefined and null values have been removed in SimpleLinkDelegate."});}continue;}if(g(i[A])){if(u){u.transformations.push({value:undefined,description:"\u2139 Plain objects has been removed in SimpleLinkDelegate."});}continue;}var v=n&&n[t]&&n[t][A]?n[t][A]:A;if(u&&A!==v){T={value:undefined,description:"\u2139 The attribute "+A+" has been renamed to "+v+" in SimpleLinkDelegate.",reason:"\ud83d\udd34 A com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation is defined for semantic object "+t+" with source attribute "+A+" and target attribute "+v+". You can modify the annotation if the mapping result is not what you expected."};}if(r[t][v]){S.error("SimpleLinkDelegate: The attribute "+A+" can not be renamed to the attribute "+v+" due to a clash situation. This can lead to wrong navigation later on.");}r[t][v]=i[A];if(u){if(T){u.transformations.push(T);var w=I.createAttributeStructure();w.transformations.push({value:i[A],description:"\u2139 The attribute "+v+" with the value "+i[A]+" has been added due to a mapping rule regarding the attribute "+A+" in SimpleLinkDelegate."});I.addSemanticObjectAttribute(t,v,w);}}}});return r;};q._retrieveNavigationTargets=function(A,s,r,I,t){if(!r.semanticObjects){return new Promise(function(i){i([]);});}var T=this;var u=r.semanticObjects;var N={ownNavigation:undefined,availableActions:[]};return sap.ui.getCore().loadLibrary("sap.ui.fl",{async:true}).then(function(){return new Promise(function(v){sap.ui.require(["sap/ui/fl/Utils"],function(U){var w=U.getAppComponentForControl(t===undefined?T.oControl:t);var x=w?w.getShellServices():null;if(!x){return v(N.availableActions,N.ownNavigation);}if(!x.hasUShell()){S.error("SimpleLinkDelegate: Service 'CrossApplicationNavigation' or 'URLParsing' could not be obtained");return v(N.availableActions,N.ownNavigation);}var y=u.map(function(i){return[{semanticObject:i,params:s?s[i]:undefined,appStateKey:A,ui5Component:w,sortResultsBy:"text"}];});return new Promise(function(){return x.getLinks(y).then(function(z){var H=false;for(var i=0;i<z.length;i++){for(var j=0;j<z[i].length;j++){if(z[i][j].length>0){H=true;break;}if(H){break;}}}if(!z||!z.length||!H){return v(N.availableActions,N.ownNavigation);}var B=q._getSemanticObjectUnavailableActions(r);var D=q._convertSemanticObjectUnavailableAction(B);var E=x.hrefForExternal();if(E&&E.indexOf("?")!==-1){E=E.split("?")[0];}if(E){E+="?";}var G=function(M,O){return(!!D&&!!D[M]&&D[M].indexOf(O)>-1);};var K=function(t){var M=x.parseShellHash(t.intent);if(G(M.semanticObject,M.action)){return;}var O=x.hrefForExternal({target:{shellHash:t.intent}},w);if(t.intent&&t.intent.indexOf(E)===0){N.ownNavigation=new b({href:O,text:t.text});return;}var Q=new b({key:M.semanticObject&&M.action?M.semanticObject+"-"+M.action:undefined,text:t.text,description:undefined,href:O,icon:undefined,initiallyVisible:t.tags&&t.tags.indexOf("superiorAction")>-1});N.availableActions.push(Q);if(I){I.addSemanticObjectIntent(M.semanticObject,{intent:Q.getHref(),text:Q.getText()});}};for(var n=0;n<u.length;n++){z[n][0].forEach(K);}return v(N.availableActions,N.ownNavigation);},function(){S.error("SimpleLinkDelegate: '_retrieveNavigationTargets' failed executing getLinks method");return v(N.availableActions,N.ownNavigation);});}).catch();});});});};q._getSemanticObjects=function(i){return i.semanticObjects?i.semanticObjects:[];};q._getSemanticObjectUnavailableActions=function(i){var s=[];if(i.semanticObjectUnavailableActions){i.semanticObjectUnavailableActions.forEach(function(j){s.push(new l({semanticObject:j.semanticObject,actions:j.actions}));});}return s;};q._getSemanticObjectMappings=function(i){var s=[];var j=[];if(i.semanticObjectMappings){i.semanticObjectMappings.forEach(function(n){j=[];if(n.items){n.items.forEach(function(r){j.push(new k({key:r.key,value:r.value}));});}s.push(new h({semanticObject:n.semanticObject,items:j}));});}return s;};q._convertSemanticObjectMapping=function(s){if(!s.length){return undefined;}var i={};s.forEach(function(j){if(!j.getSemanticObject()){throw Error("SimpleLinkDelegate: 'semanticObject' property with value '"+j.getSemanticObject()+"' is not valid");}i[j.getSemanticObject()]=j.getItems().reduce(function(M,I){M[I.getKey()]=I.getValue();return M;},{});});return i;};q._convertSemanticObjectUnavailableAction=function(s){if(!s.length){return undefined;}var i={};s.forEach(function(j){if(!j.getSemanticObject()){throw Error("SimpleLinkDelegate: 'semanticObject' property with value '"+j.getSemanticObject()+"' is not valid");}i[j.getSemanticObject()]=j.getActions();});return i;};return q;},true);
