/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/util/FilterUtil","sap/ui/fl/Utils","sap/ui/core/Core","sap/fe/macros/CommonHelper","sap/fe/core/CommonUtils","sap/fe/core/helpers/ModelHelper","sap/ui/model/Filter","sap/fe/macros/DelegateUtil","sap/fe/core/converters/templates/ListReportConverter","sap/fe/core/converters/ConverterContext","sap/fe/core/converters/templates/BaseConverter","sap/fe/core/converters/MetaModelConverter","sap/base/util/merge","sap/ui/model/json/JSONModel","sap/ui/mdc/field/ConditionsType","sap/ui/mdc/p13n/StateUtil"],function(F,a,C,b,c,M,d,D,L,e,B,f,m,J,g,S){"use strict";var o={getFilter:function(i){var h=o.getFilterInfo(i).filters;return h.length?new d(o.getFilterInfo(i).filters,false):undefined;},getConvertedFilterFields:function(h,E){var s=D.getCustomData(h,"entityType"),i=M.getEntitySetPath(s),j=E&&M.getEntitySetPath(E),t=j||i,T=t?t.slice(1):t,k="selectionFields"+(!t||i===t?"":"For"+T),l=D.getCustomData(h,k);if(!l&&(!t||!(h.data instanceof Function))){return[];}else if(!l){var v=a.getViewForControl(h);var n=h.getModel().getMetaModel();var A=c.getAppComponent(v);var V=f.getInvolvedDataModelObjects(n.createBindingContext("/"+T));var p=e.createConverterContextForMacro(V.startingEntitySet.name,n,B.TemplateType.ListReport,A&&A.getShellServices(),A&&A.getDiagnostics(),m,V.contextLocation,undefined);l=L.getSelectionFields(p);D.setCustomData(h,k,l);}return b.parseCustomData(l);},getFilterInfo:function(I,p){var h=I,s,j=[],k=(p&&p.ignoredProperties)||[],P=p&&p.propertiesMetadata,t=p&&p.targetControl,T=t?t.data("targetCollectionName"):undefined;if(typeof I==="string"){h=C.byId(I);}if(h){s=h.getSearch&&k.indexOf("search")===-1?h.getSearch():null;var l=h.getConditions(),n=h.getPropertyInfoSet?h.getPropertyInfoSet():null;if(l){var q=T+"/";if(T&&h.data("entityType")!==q){var r=h.getModel().getMetaModel();var u=h.getControlDelegate().fetchPropertiesForEntity(q,r,h);P=u;var E={};for(var i=0;i<u.length;i++){var v=u[i];E[v.name]=true;}n.forEach(function(x){var y=x.name;if(!E[y]){k.push(y);}});}else if(!P){P=n;}var w=F.getFilterInfo(h,l,P,k).filters;j=w?[w]:[];}}return{filters:j,search:s||undefined};},getNotApplicableFiltersForTable:function(h,t){var T=t.data("targetCollectionName"),n=[],i=h.getConditions(),j=h.getModel().getMetaModel(),s=T+"/",I=s===h.data("entityType"),k=D.getCustomData(t,"enableAnalytics")==="true";if(i&&(!I||k)){var l=I?[]:h.getControlDelegate().fetchPropertiesForEntity(s,j,h),p=l.reduce(function(u,v){u[v.name]=v;return u;},{}),q=b.parseCustomData(D.getCustomData(t,"aggregates")||{}),A={};Object.keys(q).forEach(function(u){var v=q[u];A[v.relativePath]=v;});for(var P in i){var r=i[P];if(Array.isArray(r)&&r.length>0&&((!p[P]&&!I)||A[P])){n.push(P);}}}if(k&&h.getSearch()){n.push("$search");}return n;},attachConditionHandling:function(h){var i=new J(),E={filterControl:h,filterModel:i},t=this;h.setModel(i,"filterValues");return h.initialized().then(function(){var j=h._getConditionModel();j.attachPropertyChange(E,t._handleConditionModelChange,t);i.attachPropertyChange(E,t._handleFilterModelChange,t);});},detachConditionHandling:function(h){var i=h.getModel("filterValues"),j=h._getConditionModel();j.detachPropertyChange(this._handleConditionModelChange,this);i.detachPropertyChange(this._handleFilterModelChange,this);i.destroy();},setFilterValues:function(h,s,O,v){var i={};if(v===undefined){v=O;}else{i.operators=[O];}if(typeof v==="object"&&v.operator){i.operators=[v.operator];v=v.values;}var j=new g(i),k={},l={};v=Array.isArray(v)?v:[v];k[s]=[];if(O){l[s]=v.filter(function(V){return V!==undefined&&V!==null;}).reduce(function(A,V){return A.concat(j.parseValue(V.toString(),"any"));},[]);}return S.applyExternalState(h,{filter:k}).then(S.applyExternalState.bind(S,h,{filter:l}));},conditionToModelPath:function(s){return s.replace(/\//g,"\\");},modelToConditionPath:function(s){return s.replace(/\\/g,"/");},_handleConditionModelChange:function(E,h){var s=this.modelToConditionPath(E.getParameter("path").substring(12)),i=new g({maxConditions:-1}),j=h.filterModel,v=E.getParameter("value"),V=i.formatValue(v,"any");j.setProperty("/"+this.conditionToModelPath(s),V);},_handleFilterModelChange:function(E,h){var p=E.getParameter("context").getPath().substring(1).replace(/\\/g,"/"),v=E.getParameter("value");this.setFilterValues(h.filterControl,p,v);}};return o;});
