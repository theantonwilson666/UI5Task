/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/core/format/NumberFormat","sap/fe/core/CommonUtils","sap/fe/macros/CommonHelper","sap/fe/macros/filter/FilterUtils","sap/base/Log","sap/fe/macros/DelegateUtil"],function(F,N,C,a,b,L,D){"use strict";function g(T,s){var E=T.data("targetCollectionName"),M=C.getAppComponent(T).getMetaModel(),S=M.getObject(E+"/@"+s),r=[],P=[],v="";if(S){v=S.Text;for(var i in S.SelectOptions){var x=S.SelectOptions[i];if(x&&x.PropertyName){var y=x.PropertyName.$PropertyPath;var R=[];for(var j in x.Ranges){var z=x.Ranges[j];R.push(new F(y,z.Option.$EnumMember.split("/").pop(),z.Low,z.High));}if(R.length>0){if(!P.includes(y)){P.push(y);}r.push(new F({filters:R,and:false}));}}}}return{properties:P,filters:r,text:v};}function c(T){var i=[],j=T.data("hiddenFilters");if(j&&Array.isArray(j.paths)){j.paths.forEach(function(P){var s=g(T,P.annotationPath);i=i.concat(s.filters);});}return i;}function d(T){var i=[],Q=D.getCustomData(T,"quickFilterKey");if(Q){i=i.concat(g(T,Q).filters);}return i;}function e(T){return d(T).concat(c(T));}function f(T,E,H){var B=T.data("rowsBindingInfo");if(B){if(!B.events){B.events={};}if(!B.events[E]){B.events[E]=H;}else{var O=B.events[E];B.events[E]=function(){H.apply(this,arguments);O.apply(this,arguments);};}}}function h(T,P,i){var B=T.data("rowsBindingInfo"),j=T.getModel(),r,s,v=i.batchGroupId||"",x=l(T),y=Array.isArray(i.additionalFilters)?i.additionalFilters:[];y=y.concat(x.filters).concat(m(T));s=new F({filters:y,and:true});r=j.bindList((P?P.getPath()+"/":"")+B.path,T.getBindingContext(),null,s,{$count:true,$$groupId:v||"$auto",$search:x.search});return r.requestContexts(0,1).then(function(z){var A=z&&z.length?z[0].getBinding().getLength():0;r.destroy();return A;});}function k(i){var j=N.getIntegerInstance({groupingEnabled:true});return j.format(i);}function l(T){var i=D.getCustomData(T,"enableAnalytics"),I=[];function j(T){var A=a.parseCustomData(D.getCustomData(T,"aggregates")||{});return Object.keys(A).map(function(s){return A[s].relativePath;});}if(i==="true"||i===true){I=I.concat(["search"]).concat(j(T));}var r=b.getFilterInfo(T.getFilter(),{ignoredProperties:I,targetControl:T});return r;}function m(T){var P=T.getP13nMode();if(P&&P.indexOf("Filter")>-1){var i=(D.getCustomData(T,"sap_fe_TableDelegate_propertyInfoMap")||[]).filter(function(r){return r&&!(r.filterable===false);}),j=b.getFilterInfo(T,{propertiesMetadata:i});if(j&&j.filters){return j.filters;}}return[];}function n(T){var i=l(T);return{filters:i.filters.concat(e(T),m(T)),search:i.search};}function w(T){return _(T).promise;}function o(T){var B=_(T);if(B.resolve){B.resolve(T);T.data("boundPromiseResolve",null);}}function _(T){if(!T.data("boundPromise")){var r;T.data("boundPromise",new Promise(function(i){r=i;}));if(T.isBound()){r(T);}else{T.data("boundPromiseResolve",r);}}return{promise:T.data("boundPromise"),resolve:T.data("boundPromiseResolve")};}function u(B,i,j){B.filters=j;if(i.search){B.parameters.$search=i.search;}else{delete B.parameters.$search;}}function p(E,T){var M=C.getAppComponent(T).getMetaModel(),s=T.data("targetCollectionName");if(E.mParameters.userExportSettings.splitCells){E.mParameters.exportSettings.workbook.columns.forEach(function(i){if(i.property.indexOf("@com.sap.vocabularies.UI.v1.DataPoint")>-1){var A=i.property,P=M.getObject(s+"/"+A);if(P&&P.Visualization&&P.Visualization.$EnumMember&&(P.Visualization.$EnumMember==="com.sap.vocabularies.UI.v1.VisualizationType/Rating"||P.Visualization.$EnumMember==="com.sap.vocabularies.UI.v1.VisualizationType/Progress")){var j=P.TargetValue.toString();i.template=j;i.property=[P.Value.$Path];}}});}E.mParameters.exportSettings.workbook.columns.forEach(function(i){var P=M.getObject(s+"/"+i.property);if(P&&P.$Type&&P.$Type==="com.sap.vocabularies.Communication.v1.ContactType"&&P.fn&&P.fn.$Path){i.property=i.property.substring(0,i.property.indexOf("/")+1)+P.fn.$Path;}});}function G(j,T){var v=j.getView();var I=v.getBindingContext("internal");if(I){var E=D.getCustomData(T,"targetCollectionName");if(E){var r=j.getOwnerComponent();var A=sap.ui.core.Component.getOwnerComponentFor(r);var M=A.getMetaModel();var s=C.getShellServices(A);var x=s.hrefForExternal();var y=D.getCustomData(T,"columns");var S=[];var z=[];var B=[];var P,H,J;var K;if(x&&x.indexOf("?")!==-1){x=x.split("?")[0];}for(var i=0;i<y.customData.length;i++){H=y.customData[i].annotationPath;if(H){J=M.getObject(H);if(J&&J.$kind==="Property"){P=y.customData[i].annotationPath;}else if(J&&J.$Type==="com.sap.vocabularies.UI.v1.DataField"){P=E+"/"+M.getObject(H+"/Value/$Path");}}if(P){K=C.getSemanticObjectsFromPath(M,P);if(K.semanticObject){S.push(K.semanticObjectForGetLinks);z.push({semanticObject:K.semanticObject.semanticObject,unavailableActions:K.unavailableActions,path:P?P:H});}}P=undefined;}s.getLinksWithCache(S).then(function(O){if(O&&O.length>0&&O[0]!==undefined){var Q={};var R={};var U;var V=function(W){if(!(x===W.intent)){if(z[i].unavailableActions&&z[i].unavailableActions.find(function(X){if(X===W.intent.split("-")[1]){return true;}})){return false;}else{B[i].push(W);}}};for(var i=0;i<O.length;i++){B.push([]);O[i][0].forEach(V);R={semanticObject:z[i].semanticObject,path:z[i].path,HasTargets:B[i].length>0?true:false,HasTargetsNotFiltered:O[i].length>0?true:false};if(Q[z[i].semanticObject]===undefined){Q[z[i].semanticObject]={};}U=z[i].path.replace(/\//g,"_");if(Q[z[i].semanticObject][U]===undefined){Q[z[i].semanticObject][U]={};}Q[z[i].semanticObject][U]=Object.assign(Q[z[i].semanticObject][U],R);}I.setProperty("semanticsTargets",Q);}}).catch(function(O){L.error("fnGetSemanticTargets: Cannot read links",O);});}}}function q(T){T.clearSelection();var i=T.getBindingContext("internal");if(i){i.setProperty("deleteEnabled",false);i.setProperty("numberOfSelectedContexts",0);i.setProperty("selectedContexts",[]);i.setProperty("deletableContexts",[]);}}var t={addEventToBindingInfo:f,getCountFormatted:k,getHiddenFilters:c,getFiltersInfoforSV:g,getTableFilters:e,getListBindingForCount:h,getFilterInfo:l,getP13nFilters:m,getAllFilterInfo:n,whenBound:w,onTableBound:o,getSemanticTargetsFromTable:G,updateBindingInfo:u,clearSelection:q,onBeforeExport:p};return t;});
