/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/fe/macros/CommonHelper","sap/fe/macros/table/Utils","sap/fe/core/CommonUtils","sap/fe/macros/DelegateUtil","sap/ui/model/Filter","sap/base/Log","sap/ui/mdc/odata/v4/TypeUtil","sap/fe/macros/FilterBarDelegate","sap/fe/core/helpers/ExcelFormatHelper","sap/fe/macros/table/TableHelper","sap/fe/macros/ResourceModel"],function(J,C,T,a,D,F,L,b,c,E,d,R){"use strict";var e="sap_fe_TableDelegate_propertyInfoMap";var f=D.FilterRestrictions;function _(t){return C.parseCustomData(D.getCustomData(t,"columns"));}function g(t){return C.parseCustomData(D.getCustomData(t,"aggregates")||{});}function h(p){return p&&p.metadataPath.includes("@com.sap.vocabularies.UI.v1.LineItem");}function i(t,l){if(t instanceof window.Element){return;}D.setCustomData(t,e,l);}function j(t){if(t instanceof window.Element){return null;}return D.getCustomData(t,e);}var k={_fetchPropertyInfo:function(B,o,t,A){var s=o.annotationPath,m=B.getModel(),l=m.getObject(o.annotationPath),n=m.createBindingContext(s),v=a.getPropertyDataType(n),p=!!o.propertyInfos&&o.propertyInfos.length>1,q=this._getExportDataType(v,p),r=v&&v==="Edm.Date"?E.getExcelDatefromJSDate():undefined,u=v&&v==="Edm.DateTimeOffset"?E.getExcelDateTimefromJSDateTime():undefined,w=v&&v==="Edm.TimeOfDay"?E.getExcelTimefromJSTime():undefined,x=r?"YYYY-MM-DD":undefined,y=null,z=C.isPropertyFilterable(o.relativePath,{context:n},l),G=v&&v.indexOf("Edm.")!==0,H=D.isTypeFilterable(v)?b.getTypeConfig(v):undefined,I=D.getLocalizedText(o.label,A||t),K=D.getCustomData(t,"enableAnalytics")==="true",M=K?g(t):{},N=sap.ui.getCore().getConfiguration().getRTL(),O={label:this._getExportLabel(o,I,t,A,N),type:q,inputFormat:x,format:r||u||w,scale:n.getProperty("$Scale")||n.getProperty("Value/$Path/$Scale"),delimiter:v&&v==="Edm.Int64"?true:false,trueValue:v&&v==="Edm.Boolean"?"Yes":undefined,falseValue:v&&v==="Edm.Boolean"?"No":undefined};if(o.exportSettings&&o.exportSettings.template){O.template=o.exportSettings.template;}var P={name:o.name,metadataPath:s,groupLabel:o.groupLabel,group:o.group,label:I,description:y||I,maxLength:n.$MaxLength,precision:n.$Precision,scale:n.$Scale,type:v,typeConfig:H,visible:o.availability!=="Hidden"&&!G,exportSettings:O,unit:o.unit};if(o.propertyInfos&&o.propertyInfos.length){P.propertyInfos=o.propertyInfos;}else{P.path=o.relativePath;P.sortable=o.sortable&&!o.relativePath.includes("/");P.filterable=z&&!o.relativePath.includes("/")&&(!K||!M[P.name]);P.key=o.isKey;P.groupable=o.isGroupable;}return P;},_getExportDataType:function(s,l){var m;if(l){m="String";}else if(s){switch(s){case"Edm.Decimal":case"Edm.Int32":case"Edm.Int64":case"Edm.Double":case"Edm.Byte":m="Number";break;case"Edm.DateOfTime":case"Edm.Date":m="Date";break;case"Edm.DateTimeOffset":m="DateTime";break;case"Edm.TimeOfDay":m="Time";break;case"Edm.Boolean":m="Boolean";break;default:m="String";}}return m;},_getExportLabel:function(o,p,t,A,r){var s,l=[];if(o.exportSettings&&o.exportSettings.labels){l=o.exportSettings.labels.map(function(m){if(m==="DataPoint.TargetValue"){return R.getText("TargetValue");}return D.getLocalizedText(m,A||t);});}if(l.length>1&&r){l.reverse();}s=l.length>0?l.join(" - "):p;return s;},_fetchCustomPropertyInfo:function(o,t,A){var l=D.getLocalizedText(o.header,A||t);var p={name:o.name,groupLabel:null,group:null,label:l,description:l,maxLength:undefined,precision:undefined,scale:undefined,type:"Edm.String",visible:o.availability!=="Hidden",exportSettings:undefined};if(o.propertyInfos&&o.propertyInfos.length){p.propertyInfos=o.propertyInfos;}else{p.path=o.name;p.sortable=false;p.filterable=false;}return p;},_fetchPropertiesForEntity:function(t,B,m,A){var o=m.createBindingContext(B),l=[],n=m.getObject(B+"@"),p=n&&n["@Org.OData.Capabilities.V1.FilterRestrictions"],N=D.getFilterRestrictions(p,f.NON_FILTERABLE_PROPERTIES)||[],q=D.getFilterRestrictions(p,f.ALLOWED_EXPRESSIONS)||{},r=this;return Promise.resolve(_(t)).then(function(s){if(!s){return Promise.resolve([]);}var P;s.forEach(function(u){switch(u.type){case"Annotation":P=r._fetchPropertyInfo(o,u,t,A);if(P&&N.indexOf(P.name)===-1){if(q[P.name]){P.filterExpression=q[P.name];}else{P.filterExpression="auto";}P.maxConditions=D.isMultiValue(P)?-1:1;}break;case"Default":P=r._fetchCustomPropertyInfo(u,t,A);break;default:throw new Error("unhandled switch case "+u.type);}l.push(P);});l.forEach(function(P){var u=P.path&&P.exportSettings?P.exportSettings.unitProperty:undefined;if(u){var U=l.find(function(v){return v.path===u;});if(U){P.unit=U.name;}}});return l;});},_getCachedOrFetchPropertiesForEntity:function(t,s,m,A){var l=j(t);if(l){return Promise.resolve(l);}return this._fetchPropertiesForEntity(t,s,m,A).then(function(l){i(t,l);return l;});},_setTableNoDataText:function(t,B){var n="",o=T.getAllFilterInfo(t),s=B.path.substr(1);var l=function(){if(t.data("hiddenFilters")||t.data("quickFilterKey")){return"M_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER_MULTI_VIEW";}else{return"T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}};if(t.getFilter()){if(o.search||(o.filters&&o.filters.length)){n=l();}else{n="M_OP_TABLE_AND_CHART_NO_FILTERS_NO_DATA_TEXT";}}else{if(o.search||(o.filters&&o.filters.length)){n=l();}else{n="M_OP_TABLE_AND_CHART_OP_NO_FILTERS_NO_DATA_TEXT";}}if(n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER"){return t.getModel("sap.fe.i18n").getResourceBundle().then(function(r){t.setNoDataText(a.getTranslatedText(n,r,null,s));}).catch(function(m){L.error(m);});}else{if(R){t.setNoDataText(R.getText(n));}}},handleTableDataReceived:function(t,I){var B=t&&t.getRowBinding(),l=I.getProperty("dataReceivedAttached");if(!l){B.attachDataReceived(function(){d.handleTableDeleteEnablementForSideEffects(t,I);});I.setProperty("dataReceivedAttached",true);}},_getDelegateParentClass:function(){return undefined;},rebindTable:function(t,B){if(!t.data("tableHidden")){T.clearSelection(t);this._getDelegateParentClass().rebindTable(t,B);T.onTableBound(t);this._setTableNoDataText(t,B);T.whenBound(t).then(this.handleTableDataReceived(t,t.getBindingContext("internal"))).catch(function(o){L.error("Error while waiting for the table to be bound",o);});}},fetchProperties:function(t){var l=this;return D.fetchModel(t).then(function(m){if(!m){return[];}return l._getCachedOrFetchPropertiesForEntity(t,D.getCustomData(t,"targetCollectionName"),m.getMetaModel());});},updateBindingInfo:function(t,m,B){Object.assign(B,D.getCustomData(t,"rowsBindingInfo"));if(t.getRowBinding()){B.suspended=false;}var o;var l=T.getAllFilterInfo(t);if(l.filters.length>0){o=new F({filters:l.filters,and:true});}T.updateBindingInfo(B,l,o);},_templateCustomColumnFragment:function(o,v,m){var l=new J(o),p={bindingContexts:{"column":l.createBindingContext("/")},models:{"column":l}};return D.templateControlFragment("sap.fe.macros.table.CustomColumn",p,{view:v},m).then(function(I){l.destroy();return I;});},_getVHRelevantFields:function(m,M,B){var l=[];var o=m.getObject(M);if(o.$kind&&o.$kind==="Property"){o=m.getObject(M+"@com.sap.vocabularies.UI.v1.DataFieldDefault");M=M+"@com.sap.vocabularies.UI.v1.DataFieldDefault";}switch(o.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":if(m.getObject(M+"/Target/$AnnotationPath").includes("com.sap.vocabularies.UI.v1.FieldGroup")){m.getObject(M+"/Target/$AnnotationPath/Data").forEach(function(v,I){l=l.concat(k._getVHRelevantFields(m,M+"/Target/$AnnotationPath/Data/"+I));});}break;case"com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataField":l.push(m.getObject(M+"/Value/$Path"));break;case"com.sap.vocabularies.UI.v1.DataFieldForAction":case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":break;default:if(M.indexOf(B)===0){l.push(M.substring(B.length+1));break;}l.push(C.getNavigationPath(M,true));break;}return l;},addItem:function(p,t,P){var m=P.appComponent&&P.appComponent.getModel().getMetaModel(),M=P.modifier,s=M.getId(t),l,G,n,o,q,r,u,v,V,w=_(t);q=w.find(function(x){return x.name===p;});if(!q){L.error(p+" not found while adding column");return Promise.resolve(null);}if(q.type==="Default"){return this._templateCustomColumnFragment(q,P.view,M);}if(!m){return Promise.resolve(null);}l=D.getCustomData(t,"metaPath",M);G=D.getCustomData(t,"requestGroupId",M)||undefined;o=m.createBindingContext(l);return this._getCachedOrFetchPropertiesForEntity(t,l,m,P.appComponent).then(function(x){u=x.find(function(I){return I.name===p;});r=m.createBindingContext(u.metadataPath);V=k._getVHRelevantFields(m,u.metadataPath,l);v={sBindingPath:l,sValueHelpType:"TableValueHelp",oControl:t,oMetaModel:m,oModifier:M,oPropertyInfo:u};n=Promise.all(V.map(function(A){var B=Object.assign({},v,{sPropertyName:A});return Promise.all([D.isValueHelpRequired(B),D.doesValueHelpExist(B)]).then(function(H){var I=H[0],K=H[1];if(I&&!K){return y("sap.fe.macros.table.ValueHelp");}return Promise.resolve();});}));function y(A){var B=new J({id:s,requestGroupId:G}),H={bindingContexts:{"this":B.createBindingContext("/"),"dataField":r},models:{"this":B,"dataField":m,metaModel:m}};return D.templateControlFragment(A,H,{},M).then(function(I){if(I){M.insertAggregation(t,"dependents",I,0);}}).catch(function(I){L.error("ValueHelp not loaded : "+I.message);return Promise.resolve(null);}).finally(function(){B.destroy();});}function z(u,A){var B=h(u)?"sap.fe.macros.table.Column":"sap.fe.macros.table.ColumnProperty",H=D.getCustomData(t,"displayModePropertyBinding",M);H=typeof H==="boolean"?H:H==="true";var I=new J({displayMode:H,tableType:D.getCustomData(t,"tableType",M),onChange:D.getCustomData(t,"onChange",M),id:s,navigationPropertyPath:p,columnInfo:q,collection:{sPath:l,oModel:m},creationMode:D.getCustomData(t,"creationMode",M)}),K={bindingContexts:{"entitySet":o,"collection":o,"dataField":r,"this":I.createBindingContext("/"),"column":I.createBindingContext("/columnInfo")},models:{"this":I,"entitySet":m,"collection":m,"dataField":m,metaModel:m,"column":I}};return D.templateControlFragment(B,K,{view:A},M).finally(function(){I.destroy();});}return n.then(z.bind(this,u,P.view));});},getFilterDelegate:function(){return Object.assign({},c,{addItem:function(p,P){if(p.indexOf("Property::")===0){p=p.replace("Property::","");}return c.addItem(p,P);}});},getTypeUtil:function(p){return b;}};return k;},false);
