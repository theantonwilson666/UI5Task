/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Control","sap/ui/core/Item","sap/m/SegmentedButtonItem","sap/m/Select","sap/m/SegmentedButton","sap/fe/core/helpers/StableIdHelper","sap/fe/core/CommonUtils","sap/fe/macros/DelegateUtil","sap/fe/macros/chart/ChartUtils","sap/fe/macros/table/Utils"],function(L,C,I,S,a,b,c,d,D,e,T){"use strict";var P="quickFilterKey";var Q=C.extend("sap.fe.macros.table.QuickFilterContainer",{metadata:{properties:{enabled:{type:"boolean"},entitySet:{type:"string"},parentEntityType:{type:"string"},showCounts:{type:"boolean"},batchGroupId:{type:"string",defaultValue:"$auto"}},events:{},defaultAggregation:"selector",aggregations:{selector:{type:"sap.ui.core.Control",multiple:false}},publicMethods:[]},renderer:{render:function(r,o){r.renderControl(o.getSelector());}},init:function(){C.prototype.init.apply(this,arguments);this._oTable=undefined;this._attachedToView=false;this.attachEvent("modelContextChange",this._initControl);var o={onBeforeRendering:function(){this._createAppSideEffects();this._attachedToView=true;this.removeEventDelegate(o);}};this.addEventDelegate(o,this);},_initControl:function(E){if(this.getModel()){this.detachEvent(E.getId(),this._initControl);this._manageTable();this._createContent();}},_manageTable:function(){var o=this.getParent(),m=this._getFilterModel(),f=m.getObject("/paths"),s=Array.isArray(f)&&f.length>0?f[0].annotationPath:undefined;while(o&&!o.isA("sap.ui.mdc.Table")){o=o.getParent();}this._oTable=o;if(this.getShowCounts()){T.addEventToBindingInfo(o,"dataRequested",this._updateCounts.bind(this));}D.setCustomData(o,P,s);},getDomRef:function(){var s=this.getSelector();if(s){return s.getDomRef();}return null;},_getFilterModel:function(){var m=this.getModel("filters");if(!m){var f=D.getCustomData(this,"filters");m=new sap.ui.model.json.JSONModel();m.setData(f);this.setModel(m,"filters");}return m;},_createContent:function(){var t=this,m=this._getFilterModel(),f=m.getObject("/paths"),i=f.length>3,s={id:c.generate([t._oTable.getId(),"QuickFilter"]),enabled:t.getBindingInfo("enabled"),autoAdjustWidth:i?true:undefined,items:{path:"filters>/paths",factory:function(g,B){var A=B.getObject().annotationPath,h={key:A,text:t._getSelectorItemText(A)};return i?new I(h):new S(h);}}};s[i?"change":"selectionChange"]=this.onSelectionChange.bind(this);this.setSelector(i?new a(s):new b(s));},_createAppSideEffects:function(){var t=this,s=this.getSelector(),o=s.getItems(),f=D.getCustomData(this._oTable,"navigationPath");if(f){for(var k in o){var i=o[k].getKey(),F=T.getFiltersInfoforSV(this._oTable,i);F.properties.forEach(function(p){t._getSideEffectController().addControlSideEffects({entityType:t.getParentEntityType(),property:f+"/"+p,TargetEntities:[{"$NavigationPropertyPath":f}]},t);});}}},_getSelectorItemText:function(A){var m=this.getModel().getMetaModel(),q=m.getObject(this.getEntitySet()+"/@"+A);return q.Text+(this.getShowCounts()?" (0)":"");},_getSideEffectController:function(){var o=this._getViewController();return o?o.sideEffects:undefined;},_getViewController:function(){var v=d.getTargetView(this);return v.getController();},_updateCounts:function(){var t=this,o=this._oTable,f=this._getViewController(),s=this.getSelector(),g=s.getItems(),B=[],i=[],A=[],h=[],j=D.getCustomData(o,P);if(f&&f.getChartControl){var l=f.getChartControl();if(l){var m=e.getAllFilterInfo(l);if(m&&m.filters.length){h=m.filters;}}}A=A.concat(T.getHiddenFilters(o)).concat(h);for(var k in g){var n=g[k].getKey(),F=T.getFiltersInfoforSV(o,n);i.push(F.text);g[k].setText(i[k]+" (...)");B.push(T.getListBindingForCount(o,o.getBindingContext(),{batchGroupId:n===j?t.getBatchGroupId():"$auto",additionalFilters:A.concat(F.filters)}));}Promise.all(B).then(function(p){for(var k in p){g[k].setText(i[k]+" ("+T.getCountFormatted(p[k])+")");}}).catch(function(E){L.error("Error while retrieving the binding promises",E);});},onSelectionChange:function(E){var o=E.getSource();D.setCustomData(this._oTable,P,o.getSelectedKey());this._oTable.rebindTable();var f=this._getViewController();if(f&&f.getExtensionAPI&&f.getExtensionAPI().updateAppState){f.getExtensionAPI().updateAppState();}},destroy:function(){if(this._attachedToView){var s=this._getSideEffectController();if(s){s.removeControlSideEffects(this);}}delete this._attachedToView;delete this._oTable;C.prototype.destroy.apply(this,arguments);}});return Q;},true);
