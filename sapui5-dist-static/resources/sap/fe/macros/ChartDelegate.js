/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/library","sap/ui/mdc/ChartDelegate","sap/fe/macros/ODataMetaModelUtil","sap/base/util/merge","sap/fe/macros/chart/ChartUtils","sap/ui/base/SyncPromise","sap/base/Log","sap/fe/core/CommonUtils","sap/fe/macros/CommonHelper"],function(M,B,a,m,C,S,L,b,c){"use strict";var A="@Org.OData.Aggregation.V1";function f(H){this.name=H[0];this.label=H[1]||this.name;this.textProperty=H[2];this.type=a.getType(H[3]);if(H[4]||H[5]){var e=H[4],F=H[5];if(F){switch(F){case"year":this.timeUnit="fiscalyear";break;case"yearPeriod":this.timeUnit="fiscalyearperiod";break;default:this.timeUnit=undefined;break;}}if(e&&!this.timeUnit){switch(e){case"yearMonth":this.timeUnit="yearmonth";break;case"date":this.timeUnit="yearmonthday";break;case"yearQuarter":this.timeUnit="yearquarter";break;case"yearWeek":this.timeUnit="yearweek";break;default:this.timeUnit=undefined;break;}}}this.criticality=H[6];return this;}function h(k,R){var g=R[0],e=R[1];var H={},p={},i;p.inChart=g||e||false;if(p.inChart){p.chartItems=[];if(g){H.kind=M.ChartItemType.Dimension;H.role=M.ChartItemRoleType.category;i=Object.assign({},H);p.chartItems.push(i);}if(e){H.kind=M.ChartItemType.Measure;H.role=M.ChartItemRoleType.axis1;H.contextDefiningProperties=R[3]||[];p.name=R[2]||"";if(Object.keys(k).indexOf(p.name)>-1){for(var j in k[p.name]){i=Object.assign({},H);i.aggregationMethod=j;i.default=undefined;p.chartItems.push(i);}}}}var o=this.getModel();return Promise.all([o.requestObject("@sapui.name",this),o.requestObject("@com.sap.vocabularies.Common.v1.Label",this),o.requestObject("@com.sap.vocabularies.Common.v1.Text/$Path",this),o.requestObject("$Type",this),a.fetchCalendarTag(o,this),a.fetchFiscalTag(o,this),a.fetchCriticality(o,this)]).then(f.bind(p));}function r(e,p,o,g,j){var k,P,l=[],I=[],n,q=[],t=[],D=[],u=[],v,w,K={};var x=a.getAllCustomAggregates(g);if(Object.keys(x).length>=1){u=j.getItems();for(var y in u){if(u[y].isA("sap.ui.mdc.chart.DimensionItem")){D.push(u[y].getKey());}else if(u[y].isA("sap.ui.mdc.chart.MeasureItem")){t.push(u[y].getKey());}}if(t.filter(function(i){return D.indexOf(i)!=-1;}).length>=1){L.error("Dimension and Measure has the sameProperty Configured");}}for(var z in x){I.push(m({},x[z],{propertyPath:z,kind:M.ChartItemType.Measure,role:M.ChartItemRoleType.axis1,sortable:x[z].sortable,filterable:x[z].filterable}));}var T=a.getAllAggregatableProperties(g);for(var E in T){k=T[E].propertyPath;K[k]=K[k]||{};K[k][T[E].aggregationMethod]={name:T[E].name,label:T[E].label};}var F=a.getSortRestrictionsInfo(g["@Org.OData.Capabilities.V1.SortRestrictions"]);var G=a.getFilterRestrictionsInfo(g["@Org.OData.Capabilities.V1.FilterRestrictions"]);function H(P){var N=P.name||"",J=P.textProperty||"";var O=false;if(P.inChart&&N.indexOf("/")>-1){L.error("$expand is not yet supported. Property: "+N+" from an association cannot be used");return;}if(P.inChart&&J.indexOf("/")>-1){L.error("$expand is not yet supported. Text Property: "+J+" from an association cannot be used");O=true;}q.push(P);a.addSortInfoForProperty(P,F);a.addFilterInfoForProperty(P,G);if(P.inChart){for(var i=0;i<P.chartItems.length;i++){var Q=P.chartItems[i];Q.propertyPath=P.name;Q.type=P.type;Q.timeUnit=P.timeUnit;Q.criticality=P.criticality;if(Q.kind==M.ChartItemType.Measure){if(K[Q.propertyPath]&&K[Q.propertyPath][Q.aggregationMethod]){Q.name=K[Q.propertyPath][Q.aggregationMethod].name;Q.label=K[Q.propertyPath][Q.aggregationMethod].label;}else{Q.name=Q.aggregationMethod+Q.propertyPath;Q.label=P.label+" ("+Q.aggregationMethod+")";}Q.customAggregate=false;Q.sortable=true;Q.sortDirection="both";Q.filterable=true;}else{Q.name=P.name;Q.textProperty=!O?P.textProperty:undefined;Q.label=P.label;Q.sortable=P.sortable;Q.sortDirection=P.sortDirection;Q.filterable=P.filterable;Q.allowedExpressions=P.allowedExpressions;}I.push(Q);}}}for(k in e){if(k[0]!=="$"){P=e[k];if(P&&P.$kind){if(P.$kind=="Property"){n=p+k+A;l.push(Promise.all([o.requestObject(n+".Groupable"),o.requestObject(n+".Aggregatable"),o.requestObject("@sapui.name",o.getMetaContext(p+k)),o.requestObject(n+".ContextDefiningProperties")]).then(h.bind(o.getMetaContext(p+k),K)).then(H));}}}}return Promise.all(l).then(function(){return[w,v,q,I];});}var d=Object.assign({},B);d.retrieveAggregationItem=function(e,o){var g;var i={className:"",settings:{key:o.name,label:o.label||o.name,type:o.type}};switch(o.kind){case M.ChartItemType.Dimension:i.className="sap.ui.mdc.chart.DimensionItem";g={textProperty:o.textProperty,timeUnit:o.timeUnit,displayText:true,criticality:o.criticality};break;case M.ChartItemType.Measure:i.className="sap.ui.mdc.chart.MeasureItem";if(o.custom){g={};}else{g={propertyPath:o.propertyPath,aggregationMethod:o.aggregationMethod};}break;}i.settings=Object.assign(i.settings,g);return i;};d.fetchProperties=function(o){return d.retrieveAllMetadata(o).then(function(e){return e.properties;});};d.retrieveAllMetadata=function(o){var e=d.getModel(o);function g(i){var D=o.getDelegate(),p="/"+D.payload.collectionName,j=i&&i.getMetaModel();if(p.endsWith("/")){throw new Error("The leading path for metadata calculation is the entity set not the path");}var k=p,t=p+"/";function l(R){var q={sortable:R[0],filterable:R[1],attributes:R[2],properties:R[3]};return q;}var n=[j.requestObject(t),j.requestObject(k)];return Promise.all(n).then(function(T){var E=T[0];var q=[a.fetchAllAnnotations(j,t),a.fetchAllAnnotations(j,k)];return Promise.all(q).then(function(u){var v=Object.assign(u[0],u[1]);return r(E,t,j,v,o);});}).then(l);}return e.then(g);};d.getModel=function(o){var v=o.getDelegate().model,e=o.getModel(v);if(e){return S.resolve(e);}return new S(function(g,i){function j(){var e=o.getModel(v);if(e){o.detachModelContextChange(j,o);return g(e);}}o.attachModelContextChange(j,o);});};function s(o,e){var n="",g=C.getAllFilterInfo(o),i=e.path.substr(1);if(o.getFilter()){if(g.search||(g.filters&&g.filters.length)){n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}else{n="T_OP_TABLE_AND_CHART_NO_FILTERS_NO_DATA_TEXT";}}else{if(g.search||(g.filters&&g.filters.length)){n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}else{n="T_OP_TABLE_AND_CHART_OP_NO_FILTERS_NO_DATA_TEXT";}}return o.getModel("sap.fe.i18n").getResourceBundle().then(function(R){o.setNoDataText(b.getTranslatedText(n,R,null,i));}).catch(function(j){L.error(j);});}d.updateBindingInfo=function(o,e,g){s(o,e);g=g||o.getBindingInfo("data");var i=o.getAggregation("_chart");if(i){var F;if(C.getChartSelectionsExist(o)){F=C.getAllFilterInfo(o);}}F=F?F:C.getFilterBarFilterInfo(o);g.filters=F.filters;};return d;},false);
