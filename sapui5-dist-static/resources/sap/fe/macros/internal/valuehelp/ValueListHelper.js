/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/fe/core/converters/templates/BaseConverter","sap/ui/mdc/field/InParameter","sap/ui/mdc/field/OutParameter","sap/base/Log","sap/ui/dom/units/Rem","sap/fe/core/BusyLocker","sap/fe/core/actions/messageHandling"],function(q,X,J,a,F,B,I,O,L,R,b,m){"use strict";var w={};var c=[];function _(v){return v.Parameters.some(function(p){return(p["@com.sap.vocabularies.UI.v1.Importance"]&&p["@com.sap.vocabularies.UI.v1.Importance"].$EnumMember==="com.sap.vocabularies.UI.v1.ImportanceType/High");});}function d(v){var C=v.valueListInfo.$model.getMetaModel().getObject("/"+v.valueListInfo.CollectionPath+"@")||{},s=C["@Org.OData.Capabilities.V1.SearchRestrictions"]&&C["@Org.OData.Capabilities.V1.SearchRestrictions"].Searchable;return s===undefined?true:s;}function e(v){return c.find(function(o){return o.sVHId===v;});}function f(v,o,i){var M=v.$model.getMetaModel(),p,D,g,r,s;var h=M.getObject("/"+v.CollectionPath+"/"+o.ValueListProperty+"@com.sap.vocabularies.UI.v1.Hidden")===true?false:true;var C=h&&!i&&_(v)&&o["@com.sap.vocabularies.UI.v1.Importance"]&&o["@com.sap.vocabularies.UI.v1.Importance"].$EnumMember==="com.sap.vocabularies.UI.v1.ImportanceType/High"?true:false;if(h){r=v.Parameters.filter(function(P){if(P.ValueListProperty!==o.ValueListProperty&&o.$Type!=="com.sap.vocabularies.Common.v1.ValueListParameterInOut"){p=M.getObject("/"+v.CollectionPath+"/"+P.ValueListProperty+"@");D=p&&p["@com.sap.vocabularies.Common.v1.Text"]&&p["@com.sap.vocabularies.Common.v1.Text"].$Path;}return D&&D===o.ValueListProperty;});r.forEach(function(P){if(P.ValueListProperty!==o.ValueListProperty){p=M.getObject("/"+v.CollectionPath+"/"+P.ValueListProperty+"@");if(i){if(p["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"]&&p["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"].$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextSeparate"){s=undefined;}else{s=M.getObject("/"+v.CollectionPath+"/"+P.ValueListProperty+"@com.sap.vocabularies.UI.v1.Hidden")!==true&&"{_VHUI>/hideColumn}";}}else{g=p["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"]&&p["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"].$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly";if(g){s=M.getObject("/"+v.CollectionPath+"/"+P.ValueListProperty+"@com.sap.vocabularies.UI.v1.Hidden")!==true&&"{_VHUI>/hideColumn}";}if(!P["@com.sap.vocabularies.UI.v1.Importance"]){if(!g){s=undefined;}else{s=C?"{_VHUI>/showColumnInTypeAhead}":"{_VHUI>/hideColumn}";}}}}});return s;}}var V={getColumnVisibility:function(v,o,s){var i=s&&!!s.valueHelpWithFixedValues,r=f(v,o,i);if(!!r){return r;}if(i||!_(v)){return undefined;}else if(o&&o["@com.sap.vocabularies.UI.v1.Importance"]&&o["@com.sap.vocabularies.UI.v1.Importance"].$EnumMember==="com.sap.vocabularies.UI.v1.ImportanceType/High"){return undefined;}else{return"{_VHUI>/showAllColumns}";}},hasImportance:function(v){return _(v.getObject())?"Importance/High":"None";},getMinScreenWidth:function(v){return _(v)?"{= ${_VHUI>/minScreenWidth}}":"416px";},getTableItemsParameters:function(v,r,s){var S,p="",g=v.$model.getMetaModel();v.Parameters.find(function(E){if(g.getObject("/"+v.CollectionPath+"/"+E.ValueListProperty+"@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement/$EnumMember")==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){S=g.getObject("/"+v.CollectionPath+"/"+E.ValueListProperty+"@com.sap.vocabularies.Common.v1.Text/$Path");}else{S=E.ValueListProperty;}return!(g.getObject("/"+v.CollectionPath+"/"+E.ValueListProperty+"@com.sap.vocabularies.UI.v1.Hidden")===true);});var h=v.Parameters.some(function(P){return s||P.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterIn";});if(r){p=", parameters: { $$groupId: '"+r+"' }";}return("{path: '/"+v.CollectionPath+"'"+p+", suspended : "+h+", sorter: {path: '"+S+"', ascending: true}}");},getPropertyPath:function(p){return!p.UnboundAction?"/"+p.EntitySet+"/"+p.Action+"/"+p.Property:"/"+p.Action.substring(p.Action.lastIndexOf(".")+1)+"/"+p.Property;},getWaitForPromise:function(){return w;},getValueListCollectionEntitySet:function(v){var g=v.getObject();return g.$model.getMetaModel().createBindingContext("/"+g.CollectionPath);},getValueListProperty:function(p){var v=p.getModel();var g=v.getObject("/");return g.$model.getMetaModel().createBindingContext("/"+g.CollectionPath+"/"+p.getObject());},getValueListInfo:function(o,M,p,C,P){var k,D,s="",g=M.getObject(p+"@sapui.name"),h,i=[],j=[],l="";return M.requestValueListInfo(p,true,o.getBindingContext()).then(function(v){var n=o.getInParameters().length+o.getOutParameters().length===0,r=o.getModel("_VHUI"),t=r.getProperty("/qualifierForValidation"),S=r.getProperty("/isSuggestion"),u=r.getProperty("/hasValueListRelevantQualifiers"),x=o.getAggregation("collectiveSearchItems"),y=Object.keys(v).sort(),z=y[0],A;if(z===undefined){return o.getModel("_VHUI").setProperty("/noValidValueHelp",true);}if(u||y.length>1||x.length>1){if(S&&y.indexOf(t)>-1){A=t===""?o.getId()+"::non-qualifier":o.getId()+"::qualifier::"+t;r.setProperty("/valueHelpId",A);r.setProperty("/collectiveSearchKey",t);v=v[t];o.setProperty("validateInput",true);}else{x.forEach(function(E){if(!y.includes(E.getKey())){o.removeAggregation("collectiveSearchItems",E);}});if(y.length===1){o.removeAllAggregation("collectiveSearchItems");P.collectiveSearchKey=undefined;}else{y.forEach(function(E){if(x.filter(function(G){return G.getKey()===E;}).length===0){o.addAggregation("collectiveSearchItems",new sap.ui.core.Item({key:E,text:v[E].Label,enabled:true}));}});}if(P&&P.collectiveSearchKey!==undefined){z=P.collectiveSearchKey;}else if(P&&P.collectiveSearchKey===undefined){z=y[0];P.collectiveSearchKey=y[0];}A=z===""?o.getId()+"::non-qualifier":o.getId()+"::qualifier::"+z;o.getModel("_VHUI").setProperty("/valueHelpId",A);o.getModel("_VHUI").setProperty("/collectiveSearchKey",z);v=v[z];if(!o.getParent().isA("sap.ui.mdc.FilterBar")&&S&&t!==z){o.setProperty("validateInput",false);}}}else{v=v[z];}v.Parameters.forEach(function(E){h="/"+v.CollectionPath+"/"+E.ValueListProperty;var G=v.$model.getMetaModel().getObject(h),H=v.$model.getMetaModel().getObject(h+"@")||{};if(G){if(!k&&E.$Type.indexOf("Out")>48&&E.LocalDataProperty.$PropertyPath===g){l=h;k=E.ValueListProperty;D=H["@com.sap.vocabularies.Common.v1.Text"]&&H["@com.sap.vocabularies.Common.v1.Text"].$Path;}if(!s&&G.$Type==="Edm.String"&&!H["@com.sap.vocabularies.UI.v1.HiddenFilter"]&&!H["@com.sap.vocabularies.UI.v1.Hidden"]){s=s.length>0?s+","+E.ValueListProperty:E.ValueListProperty;}if(n&&E.$Type!=="com.sap.vocabularies.Common.v1.ValueListParameterDisplayOnly"&&E.$Type!=="com.sap.vocabularies.Common.v1.ValueListParameterConstant"&&E.LocalDataProperty&&E.LocalDataProperty.$PropertyPath!==g){var K="";if(C&&C.length>0){if(o.getParent().isA("sap.ui.mdc.Table")&&o.getBindingContext()&&E.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterIn"){var N=E.LocalDataProperty.$PropertyPath.split("/");if(N.length>1){var Q=N[0];var T=o.getModel().getMetaModel().getMetaContext(o.getBindingContext().getPath());var U=o.getParent().getRowBinding().getPath();if(T.getObject(U+"/$Partner")===Q){K="{"+E.LocalDataProperty.$PropertyPath.replace(Q+"/","")+"}";}}}if(!K){K="{"+C+">/conditions/"+E.LocalDataProperty.$PropertyPath+"}";}}else{K="{"+E.LocalDataProperty.$PropertyPath+"}";}if(E.$Type.indexOf("Out")>48){j.push(new O({value:K,helpPath:E.ValueListProperty}));}if(E.$Type.indexOf("In")>48){i.push(new I({value:K,helpPath:E.ValueListProperty,initialValueFilterEmpty:E.InitialValueIsSignificant}));}}if(E.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterConstant"){i.push(new I({value:E.Constant,helpPath:E.ValueListProperty}));}}});return{keyValue:k,descriptionValue:D,fieldPropertyPath:l,filters:s,inParameters:i,outParameters:j,valueListInfo:v};}).catch(function(n){var r=n.status&&n.status===404?"Metadata not found ("+n.status+") for value help of property "+p:n.message;L.error(r);o.destroyContent();});},createValueHelpDialog:function(p,o,t,g,v,s){var h=o.getMetadata().getName(),W=o.getContent&&o.getContent(),i=W&&W.getId(),j=v&&v.filters,k=v&&v.inParameters,l=v&&v.outParameters,n=o.getModel("_VHUI").getProperty("/valueHelpId"),r=this;if((!t||n!==undefined)&&h.indexOf("FieldValueHelp")>-1){o.setTitle(v.valueListInfo.Label);o.setKeyPath(v.keyValue);o.setDescriptionPath(v.descriptionValue);o.setFilterFields(d(v)?"$search":"");}function u(x){var y=X.loadTemplate(x,"fragment"),z=v.valueListInfo,A=new J(z),C=z.$model.getMetaModel(),n=o.getModel("_VHUI").getProperty("/valueHelpId"),S=new J({id:n||o.getId(),groupId:o.data("requestGroupId")||undefined,bSuggestion:s,valueHelpWithFixedValues:o.getModel().getMetaModel().getObject(p+"@")["@com.sap.vocabularies.Common.v1.ValueListWithFixedValues"]});return Promise.resolve(a.process(y,{name:x},{bindingContexts:{valueList:A.createBindingContext("/"),entityType:C.createBindingContext("/"+z.CollectionPath+"/"),source:S.createBindingContext("/")},models:{valueList:A,entityType:C,source:S,metaModel:C,viewData:new J({converterType:B.TemplateType.ListReport})}})).then(function(y){var D={path:p,fragmentName:x,fragment:y};if(L.getLevel()===L.Level.DEBUG){V.ALLFRAGMENTS=V.ALLFRAGMENTS||[];V.ALLFRAGMENTS.push(D);}if(V.logFragment){setTimeout(function(){V.logFragment(D);},0);}return F.load({definition:y});});}t=t||u("sap.fe.macros.internal.valuehelp.ValueListTable");if(j.length){g=g||(!s&&u("sap.fe.macros.internal.valuehelp.ValueListFilterBar"));}else{g=Promise.resolve();}return Promise.all([t,g]).then(function(C){var n=o.getModel("_VHUI").getProperty("/valueHelpId"),T,t=C[0],g=C[1],x=g?g.getFilterItems():[];if(t){t.setModel(v.valueListInfo.$model);var y=t.getBinding("items");y.attachEventOnce("dataRequested",function(){b.lock(t);});y.attachEvent("dataReceived",function(E){if(b.isLocked(t)){b.unlock(t);}if(E.getParameter("error")){setTimeout(m.showUnboundMessages,0);}});L.info("Value List XML content created ["+p+"]",t.getMetadata().getName(),"MDC Templating");}if(g&&x.length){g.setModel(v.valueListInfo.$model);L.info("Value List XML content created ["+p+"]",g.getMetadata().getName(),"MDC Templating");}if(t!==W.getTable()||n!==undefined){W.setTable(t);delete w[i];}T=r.getTableWidth(t,r._getWidthInRem(o._getField()));o.getModel("_VHUI").setProperty("/tableWidth",T);t.setWidth(s?T:"100%");if((g&&g!==o.getFilterBar()&&x.length)||(g&&n!==undefined)){o.setFilterBar(g);}else{o.addDependent(g);}l.forEach(function(z){o.addOutParameter(z);});k.forEach(function(z){o.addInParameter(z);});o.attachEventOnce("afterClose",function(E){var o=E.oSource;var z=o&&o.getConditions();if(z&&z[0]&&z[0].inParameters){delete z[0].inParameters;o.fireSelect({conditions:z,add:false,close:true});}});if(n!==undefined){var S=e(n);if(!S){c.push({sVHId:n,oVHTable:t,oVHFilterBar:g});}else if(S&&S.oVHFilterBar===false){c[c.indexOf(S)].oVHFilterBar=g;}}});},_getWidthInRem:function(C){var $=C.$().width(),W=$?parseFloat(R.fromPx($)):0;return isNaN(W)?0:W;},getTableWidth:function(t,M){var W,C=t.getColumns(),v=(C&&C.filter(function(o){return o&&o.getVisible();}))||[],s=v.reduce(function(S,o){W=o.getWidth();if(W&&W.endsWith("px")){W=R.fromPx(W);}var g=parseFloat(W);return S+(isNaN(g)?9:g);},v.length);return Math.max(s,M)+"em";},showValueListInfo:function(p,o,s,C,P){var M=o.getModel(),g=M.getMetaModel(),W=o.getContent&&o.getContent(),h=W&&W.getId(),t=W&&W.getTable&&W.getTable(),i=o&&o.getFilterBar&&o.getFilterBar(),E=t&&i,v,Q,j;v=o.getModel("_VHUI");if(!v){v=new J({});o.setModel(v,"_VHUI");v.setProperty("/hasValueListRelevantQualifiers",!!g.getObject(p+"@")["@com.sap.vocabularies.Common.v1.ValueListRelevantQualifiers"]);if(o.getProperty("validateInput")){Q=g.getObject(p+"@")["@com.sap.vocabularies.Common.v1.ValueListForValidation"];Q=Q&&Q.replace(/\s/g,"");v.setProperty("/qualifierForValidation",Q);}}v.setProperty("/isSuggestion",s);v.setProperty("/showAllColumns",!s);v.setProperty("/hideColumn",false);v.setProperty("/showColumnInTypeAhead",s);v.setProperty("/minScreenWidth",!s?"418px":undefined);j=o.getModel("_VHUI").getProperty("/valueHelpId");if(t){t.setWidth(s?v.getProperty("/tableWidth"):"100%");}if((j!==undefined&&o.getBindingContext())||(o.getModel("_VHUI").getProperty("/collectiveSearchKey")!==undefined&&o.getModel("_VHUI").getProperty("/collectiveSearchKey")!==P.collectiveSearchKey)){t=undefined;i=undefined;E=undefined;delete w[h];}if(!i&&o.getDependents().length>0){var k=o.getDependents()[0];if(k.isA("sap.ui.mdc.filterbar.vh.FilterBar")){i=k;}}if(w[h]||E){return w["promise"+h];}else{if(!t){w[h]=true;}var l=V.getValueListInfo(o,g,p,C,P).then(function(n){var j=o.getModel("_VHUI").getProperty("/valueHelpId");var S=e(j);if(o.getModel("_VHUI").getProperty("/noValidValueHelp")){L.error("Context dependent value help not found");return o.close();}if(S){t=S.oVHTable;i=S.oVHFilterBar;}return(n&&V.createValueHelpDialog(p,o,t,i,n,s));}).catch(function(n){var r=n.status&&n.status===404?"Metadata not found ("+n.status+") for value help of property "+p:n.message;L.error(r);o.destroyContent();});w["promise"+h]=l;return l;}},setValueListFilterFields:function(p,o,s,C){var M=o.getModel(),g=M.getMetaModel();if(o.getBindingContext()&&o.getModel().getMetaModel().getObject(p+"@")["@com.sap.vocabularies.Common.v1.ValueListRelevantQualifiers"]){return;}return V.getValueListInfo(o,g,p,C).then(function(v){v&&o.setFilterFields(d(v)?"$search":"");});},getColumnWidth:function(D,v){if(v&&v.Parameters&&v.Parameters.length===1){return"auto";}switch(D){case"Edm.Stream":return"7em";case"Edm.Boolean":return"8em";case"Edm.Date":case"Edm.TimeOfDay":return"9em";case"Edm.DateTimeOffset":return"12em";default:return"auto";}}};return V;},true);
