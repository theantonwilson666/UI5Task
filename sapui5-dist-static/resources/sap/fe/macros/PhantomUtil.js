/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/base/ManagedObject","sap/fe/macros/ResourceModel","sap/ui/core/util/XMLPreprocessor","sap/ui/base/SyncPromise","./TraceInfo","sap/base/util/ObjectPath"],function(J,L,M,R,X,S,T,O){"use strict";var p="sap.fe.macros.PhantomUtil",I=R.getModel();I.bindContext=I.bindContext||function(){return{initialize:function(){},attachChange:function(){},detachChange:function(){},attachEvents:function(){},detachEvents:function(){},updateRequired:function(){},destroy:function(){},getContext:function(){}};};function v(n,C,o,k){var a,b;if(!C[k]){if(o.required){throw new Error(n+": "+"Required metadataContext '"+k+"' is missing");}}else{a=C[k];b=a.getObject();if(b){var i=Object.assign({},o);delete i.required;delete i.computed;delete i.isPublic;delete i.type;if(b.hasOwnProperty("$kind")){delete i.$Type;}else{delete i.$kind;}Object.keys(i).forEach(function(P){var j=Array.isArray(i[P])?i[P]:[i[P]],V;if(typeof b==="object"){V=b[P];if(!V){if(b.hasOwnProperty("$Path")){V=a.getObject("$Path/"+P);}}}else if(typeof b==="string"){V=a.getObject(P);if(!V){V=j[0];}}else{V=null;}if(j.indexOf(V)===-1){throw new Error(n+": '"+k+"' must be '"+P+"' '"+j+"' but is '"+V+"': "+a.getPath());}});}}}function c(n,m,C,N){var a=(m.metadataContexts&&Object.keys(m.metadataContexts))||[],P=(m.properties&&Object.keys(m.properties))||[],A={};Object.keys(N.attributes).forEach(function(k){var K=N.attributes[k].name;if(K!=="metadataContexts"){A[K]=true;}});Object.keys(C).forEach(function(k){if(k!=="this"&&k!=="this.i18n"){A[k]=true;}});a.forEach(function(k){var o=m.metadataContexts[k];v(n,C,o,k);delete A[k];});P.forEach(function(k){var o=m.properties[k];if(!N.hasAttribute(k)){if(o.required&&!o.hasOwnProperty("defaultValue")){throw new Error(n+": "+"Required property '"+k+"' is missing");}}else{delete A[k];}});Object.keys(A).forEach(function(k){if(k.charAt(0)!=="_"&&k.indexOf(":")<0){L.warning("Unchecked parameter: "+n+": "+k,null,p);}});}function d(m,i){if(m){var P={};var a={"dependents":{type:"sap.ui.core.Element"},"customData":{type:"sap.ui.core.Element"}};var o=m.metadataContexts||{};Object.keys(m.properties).forEach(function(s){if(m.properties[s].type!=="sap.ui.model.Context"){P[s]=m.properties[s];}else{o[s]=m.properties[s];}});if(m.events){Object.keys(m.events).forEach(function(E){P[E]=m.events[E];});}if(m.aggregations){Object.keys(m.aggregations).forEach(function(s){a[s]=m.aggregations[s];});}return{properties:P,aggregations:a,metadataContexts:o};}else{return{metadataContexts:{},aggregations:{"dependents":{type:"sap.ui.core.Element"},"customData":{type:"sap.ui.core.Element"}},properties:{},events:{}};}}function w(k){return function(V){var o={};o[k]=V;return o;};}function g(n,k,D){return function(){var V=n.getAttribute(k);if(!V&&D.defaultValue){V=D.defaultValue;}return w(k)(V);};}function _(s,n,a,V,D){var m;if(!D&&n.hasAttribute(a)){var A=n.getAttribute(a),b;V.getResult(A,n);m=M.bindingParser(A);if(!m){if(a==="metaPath"&&s.bindingContexts.contextPath){if(A.startsWith("/")){b=A;}else{var C=s.bindingContexts.contextPath.getPath();if(!C.endsWith("/")){C+="/";}b=C+A;}m={model:"contextPath",path:b};}else{m={model:"metaModel",path:s.bindingContexts.entitySet?s.bindingContexts.entitySet.getPath(A):A};}}}else if(s.bindingContexts.hasOwnProperty(a)){m={model:a,path:""};}return m;}function e(m,n,V){return r(m,n,V,true);}function r(m,n,V,k){var F=m.fragment||m.namespace+"."+m.name,N="this",s=N+".i18n",C={},A=new J(n),l=n.getAttribute("metadataContexts"),o={},q=V.getSettings(),j;var t=d(m.metadata,k);A._getObject=function(a,b){if((a===undefined||a==="")&&this.oProps){return this.oProps;}var i=O.get(a.replace(/\//g,"."),this.oProps);if(i!==undefined){return i;}if(this.oProps&&this.oProps.hasOwnProperty(a)){return this.oProps[a];}if(a.indexOf(":")===-1&&a.indexOf("/")===-1){L.error("Missing property "+a+" on macro metadata "+m.name);}return n.getAttribute(a);};A.getContextName=function(){return N;};A.$$valueAsPromise=true;C[s]=I.getContext("/");if(!q[F]){q[F]={};}var u=null;var x=true;var y={};if(m.hasValidation){var D=t.properties;var z=t.metadataContexts;var B=Object.keys(D);var E=Object.keys(z);var G=[];for(j=0;j<B.length;j++){var K=B[j];if(k&&!D[K].isPublic&&n.hasAttribute(K)){L.error("Property "+K+" was ignored as it is not intended for public usage");var H={};H[K]=D[K].defaultValue;G.push(Promise.resolve(H));}else if(n.hasAttribute(K)){G.push(V.visitAttribute(n,n.attributes[K]).then(g(n,K,D[K])));}else{var H={};H[K]=D[K].defaultValue;G.push(Promise.resolve(H));}}x=false;E=E.sort(function(a,b){return a>b?1:-1;});for(j=0;j<E.length;j++){var P=E[j];var Q=k&&!z[P].isPublic&&n.hasAttribute(P);var U=_(q,n,P,V,Q);if(U){U.name=P;f(C,V,U,o);if((P==="entitySet"&&!q.bindingContexts.hasOwnProperty(P))||P==="contextPath"){q.bindingContexts[P]=C[P];}G.push(Promise.resolve(w(P)(C[P])));}else{y[P]=true;x=true;}}if(n.firstElementChild!==null){G.push(V.visitChildNodes(n));}u=S.all(G);}else{u=V.visitAttributes(n);}var W={};return u.then(function(a){if(a!=null){var b=a.reduce(function(c1,d1){return Object.assign(c1,d1);},{});Object.keys(t.properties).forEach(function(Z){if(t.properties[Z].type==="object"&&(!b.hasOwnProperty(Z)||b[Z]===undefined)){b[Z]={};}});var Y=n.firstElementChild;while(Y!==null){var Z=Y.localName;if(Object.keys(t.aggregations).indexOf(Z)!==-1){W[Y.localName]=Y;}else if(Object.keys(t.properties).indexOf(Z)!==-1){b[Z]={};for(var i=0;i<Object.keys(Y.attributes).length;i++){var $=Object.keys(Y.attributes)[i];b[Z][Y.attributes[$].localName]=Y.attributes[$].value;}}Y=Y.nextElementSibling;}var a1=m.prepareMacroParameters||m.create;if(a1){var b1={};if(q.models.viewData){b1=q.models.viewData.getProperty("/controlConfiguration");}b=a1.call(m,b,b1,q);Object.keys(t.metadataContexts).forEach(function(c1){if(t.metadataContexts[c1].computed){C[c1]=b[c1];}});Object.keys(y).forEach(function(c1){if(b.hasOwnProperty(c1)){C[c1]=b[c1];}});}A.oProps=b;}if(x&&l){o=l?M.bindingParser(l):{parts:[]};if(!o.parts){o={parts:[o]};}for(j=0;j<o.parts.length;j++){f(C,V,o.parts[j],o);V=V["with"](C,false);}}}).then(function(){var a;C[N]=A.getContext("/");if(T.isTraceInfoActive()){var b=T.traceMacroCalls(F,t,C,n,V);if(b){a=q["_macroInfo"];q["_macroInfo"]=b.macroInfo;}}c(F,t,C,n);var i=V["with"](C,true);var Y=n.parentNode;return i.insertFragment(F,n).then(function(){if(Object.keys(W).length>0){var Z=Y.firstElementChild;Object.keys(W).forEach(function($){var a1=W[$];if(Z!==null){var b1=document.createElementNS(Z.namespaceURI,$);var c1=a1.firstElementChild;while(c1){var d1=c1.nextElementSibling;b1.appendChild(c1);c1=d1;}Z.appendChild(b1);}});}if(a){q["_macroInfo"]=a;}else{delete q["_macroInfo"];}});});}function f(C,V,o,m){var k=o.name||o.model||undefined;if(m[k]){return;}try{var s=o.path;if(o.model!=null){s=o.model+">"+s;}C[k]=V.getContext(s);var a=V.getSettings();if(a&&a.bindingContexts&&a.bindingContexts.entitySet){C[k].$$configModelContext=V.getSettings().bindingContexts.entitySet.$$configModelContext;}m[k]=C[k];}catch(b){}}function h(m){X.plugIn(r.bind(this,m),m.namespace,m.name);if(m.publicName){X.plugIn(e.bind(this,m),m.publicNamespace,m.publicName);}}h._validateMacroSignature=c;return{register:h};});
