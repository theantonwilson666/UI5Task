/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/Button","sap/m/Dialog","sap/m/library","sap/fe/templates/controls/messages/MessagePopover","sap/ui/core/MessageType","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/FilterOperator","sap/uxap/ObjectPageLayout"],function(B,D,l,M,a,F,S,b,O){"use strict";var c=l.ButtonType;var d=B.extend("sap.fe.templates.controls.messages.MessageButton",{metadata:{properties:{},events:{messageChange:{}},aggregations:{customFilters:{type:"sap.fe.templates.controls.messages.MessageFilter",multiple:true,singularName:"customFilter"}}},renderer:{}});function _(C,i){return C===i.getId();}function e(){var I,s=c.Default,j=this.oMessagePopover.getItems(),k=j.length,p={Error:0,Warning:0,Success:0,Information:0};q(sap.ui.getCore().getMessageManager().getMessageModel().getObject("/"));if(k>0){for(var i=0;i<k;i++){if(!j[i].getType()||j[i].getType()==""){++p["Information"];}else{++p[j[i].getType()];}}if(p[a.Error]>0){s=c.Negative;}else if(p[a.Critical]>0||p[a.Warning]>0){s=c.Critical;}else if(p[a.Success]>0){s=c.Success;}else if(p[a.Information]>0){s=c.Neutral;}if(p.Error>0){this.setText(p.Error);}else{this.setText("");}this.setIcon(I);this.setType(s);this.setVisible(true);this._applyGrouping();}else{this.setVisible(false);}this.fireMessageChange({iMessageLength:k});this.oMessagePopover.navigateBack();function q(r){var t,u=[];for(var i=r.length-1;i>=0;i--){t=r[i].getMessage()+r[i].type+r[i].sectionName+r[i].subSectionName+r[i].target;if(!u.includes(t)){u.push(t);}else if(r[i].sectionName!=null&&r[i].subSectionName!=null){r.splice(i,1);}}return;}}function f(){var C,v,V,i,j,p,s,k,u=[],q=null;function r(){var T=function(w){if(!w.length){return false;}var x=sap.ui.getCore().byId(w[0]);while(x){if(x.getId()===s){return true;}if(x instanceof D){return false;}x=x.getParent();}return false;};return new F({path:"controlIds",test:T,caseSensitive:true});}if(!this.sViewId){this.sViewId=this._getViewId(this.getId());}s=this.sViewId;C=this.getAggregation("customFilters");if(C){C.forEach(function(w){u.push(new F({path:w.getProperty("path"),operator:w.getProperty("operator"),value1:w.getProperty("value1"),value2:w.getProperty("value2")}));});}j=this.getBindingContext();if(!j){this.setVisible(false);return;}else{p=j.getPath();v=new F({filters:[new F({path:"validation",operator:b.EQ,value1:true}),r()],and:true});V=new F({filters:[v,new F({path:"target",operator:b.StartsWith,value1:p})],and:false});}i=new F({filters:u.length>0?[u,V]:[V],and:true});this.oItemBinding.filter(i);var t=this;k=new S("",null,null,function(w,x){var y,z;t.oObjectPageLayout=o(t,t.oObjectPageLayout);if(!q){q=t.oObjectPageLayout&&t.oObjectPageLayout.getSections();}y=g(w,q);z=g(x,q);if(y<z){return-1;}if(y>z){return 1;}return 0;});this.oItemBinding.sort(k);}function g(i,s){if(s){var p,q,r,j,k,E,A,t;for(j=s.length-1;j>=0;--j){p=s[j];q=p.getSubSections();for(k=q.length-1;k>=0;--k){r=q[k];A=r.findElements(true);E=A.filter(_.bind(this,i.getControlId()));t=j+1;if(E.length>0){i.sectionName=p.getTitle();i.subSectionName=r.getTitle();return t*10+(k+1);}}}return 999;}return 999;}function h(E){var i=E.getParameter("item"),j=i.getBindingContext("message").getObject(),C=sap.ui.getCore().byId(j.getControlId());if(C&&C.getDomRef()){C.focus();}else{var s=i.getGroupName().split(", ")[0];n(this.oObjectPageLayout,s);C.focus();}}function m(j,s){if(s){var k=j.getSections();var p;for(var i=0;i<k.length;i++){if(k[i].getVisible()&&k[i].getTitle()===s){p=k[i];break;}}return p;}}function n(i,s){var u=i.getUseIconTabBar();if(u){var j=m(i,s);var k=i.getSelectedSection();if(j&&k!==j.getId()){i.setSelectedSection(j.getId());}}}function o(E,i){if(i){return i;}i=E;while(i&&!(i instanceof O)){i=i.getParent();}return i;}d.prototype.init=function(){B.prototype.init.apply(this,arguments);this.attachPress(this.handleMessagePopoverPress,this);this.oMessagePopover=new M();this.oItemBinding=this.oMessagePopover.getBinding("items");this.oItemBinding.attachChange(e.bind(this));this.attachModelContextChange(f.bind(this));this.oMessagePopover.attachActiveTitlePress(h.bind(this));};d.prototype.handleMessagePopoverPress=function(E){this.oMessagePopover.toggle(E.getSource());};d.prototype._applyGrouping=function(){var i,s;this.oObjectPageLayout=o(this,this.oObjectPageLayout);if(!this.oObjectPageLayout){return;}i=this.oMessagePopover.getItems();s=this.oObjectPageLayout.getSections();var E=this._checkControlIdInSections(i,false);if(E){this._fnEnableBindings(s);}};d.prototype._checkControlIdInSections=function(p,E){var s,q,r,t,u,A,v,i,j,k;this.sGeneralGroupText=this.sGeneralGroupText?this.sGeneralGroupText:sap.ui.getCore().getLibraryResourceBundle("sap.fe.core").getText("T_MESSAGE_BUTTON_SAPFE_MESSAGE_GROUP_GENERAL");u=this.oObjectPageLayout.getSections();if(u){for(i=p.length-1;i>=0;--i){v=p[i];if((E&&(v.getGroupName()===this.sGeneralGroupText||v.getGroupName()===""))||!E){for(j=u.length-1;j>=0;--j){s=u[j];q=s.getSubSections();for(k=q.length-1;k>=0;--k){r=q[k];A=r.findElements(true);t=A.filter(_.bind(this,v.getBindingContext("message").getObject().getControlId()));if(t.length>0){v.setGroupName(s.getTitle()+(r.getTitle()&&q.length>1?", "+r.getTitle():""));j=k=-1;}else{v.setGroupName(this.sGeneralGroupText);}}}if(!E&&v.getGroupName()===this.sGeneralGroupText&&this._findTargetForMessage(v)){return true;}}}}};d.prototype._findTargetForMessage=function(i){var j=i.getBindingContext("message")&&i.getBindingContext("message").getObject();if(j&&j.target){var k=this.oObjectPageLayout&&this.oObjectPageLayout.getModel()&&this.oObjectPageLayout.getModel().getMetaModel(),p=k&&k.getMetaPath(j.target),C=k&&k.getObject(p);if(C&&C.$kind=="Property"){return true;}}};d.prototype._fnEnableBindings=function(s){for(var i=0;i<s.length;i++){var j=s[i];var k=j.getSubSections();for(var p=0;p<k.length;p++){var q=k[p];q.setBindingContext(undefined);if(q.getBindingContext()){q.getBindingContext().getBinding().attachDataReceived(this._findMessageGroupAfterRebinding());}}}};d.prototype._findMessageGroupAfterRebinding=function(){var i=this.oMessagePopover.getItems();this._checkControlIdInSections(i,true);};d.prototype._getViewId=function(C){var v,i=sap.ui.getCore().byId(C);while(i){if(i instanceof sap.ui.core.mvc.View){v=i.getId();break;}i=i.getParent();}return v;};return d;},true);
