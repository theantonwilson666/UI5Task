/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/core/PageController","sap/ui/model/json/JSONModel","sap/fe/core/controllerextensions/InternalRouting","./overrides/Routing","./overrides/InternalRouting","sap/ui/Device","sap/fe/core/controllerextensions/SideEffects","sap/fe/core/controllerextensions/EditFlow","sap/fe/core/controllerextensions/PageReady","sap/fe/core/controllerextensions/InternalIntentBasedNavigation","sap/fe/core/controllerextensions/IntentBasedNavigation","./overrides/IntentBasedNavigation","sap/fe/macros/field/FieldRuntime","sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/navigation/SelectionVariant","sap/fe/macros/table/Utils","sap/m/MessageBox","sap/fe/core/BusyLocker","sap/fe/core/actions/messageHandling","sap/fe/macros/ResourceModel","sap/m/Link","sap/fe/macros/chart/ChartRuntime","sap/fe/templates/controls/Share/ShareUtils","sap/fe/templates/ObjectPage/ExtensionAPI","sap/fe/core/helpers/PasteHelper","sap/fe/core/library","sap/ui/core/mvc/OverrideExecution","sap/fe/core/controllerextensions/ViewState","./overrides/ViewState","sap/fe/templates/RootContainer/overrides/EditFlow","sap/fe/core/helpers/ModelHelper","sap/fe/core/controllerextensions/Routing","sap/m/InstanceManager"],function(P,J,I,R,a,D,S,E,b,c,d,e,F,L,m,C,f,T,M,B,g,h,j,k,l,n,o,p,O,V,q,r,s,t,u){"use strict";var v;return P.extend("sap.fe.templates.ObjectPage.ObjectPageController",{metadata:{methods:{getExtensionAPI:{"public":true,"final":true},onPageReady:{"public":true,"final":false,overrideExecution:O.After}}},sideEffects:S,editFlow:E.override(r),_routing:I.override(a),intentBasedNavigation:d.override(e),_intentBasedNavigation:c.override({getNavigationMode:function(){var i=this._oView.getController().getStickyEditMode&&this._oView.getController().getStickyEditMode();return i?"explace":"inplace";}}),routing:t.override(R),viewState:V.override(q),pageReady:b.override({isContextExpected:function(){return true;}}),getExtensionAPI:function(i){if(i){this.mCustomSectionExtensionAPIs=this.mCustomSectionExtensionAPIs||{};if(!this.mCustomSectionExtensionAPIs[i]){this.mCustomSectionExtensionAPIs[i]=new n(this,i);}return this.mCustomSectionExtensionAPIs[i];}else{if(!this.extensionAPI){this.extensionAPI=new n(this);}return this.extensionAPI;}},onInit:function(){P.prototype.onInit.apply(this);var i=this.byId("fe::ObjectPage");var w=this.getView().getBindingContext("internal");w.setProperty("externalNavigationContext",{"page":true});w.setProperty("relatedApps",{visibility:false,items:null});w.setProperty("batchGroups",this._getBatchGroupsForView());if(i.getEnableLazyLoading()){i.attachEvent("subSectionEnteredViewPort",this._handleSubSectionEnteredViewPort.bind(this));}},onExit:function(){var i=this;if(this.mCustomSectionExtensionAPIs){Object.keys(this.mCustomSectionExtensionAPIs).forEach(function(w){i.mCustomSectionExtensionAPIs[w]&&i.mCustomSectionExtensionAPIs[w].destroy();});delete this.mCustomSectionExtensionAPIs;}this.extensionAPI&&this.extensionAPI.destroy();delete this.extensionAPI;},_getTableBinding:function(i){return i&&i.getRowBinding();},onAfterRendering:function(i){var w=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(x){w.oResourceBundle=x;}).catch(function(x){L.error("Error while retrieving the resource bundle",x);});},_onBeforeBinding:function(w,x){var y=this,z=this._findTables(),A,G=this.byId("fe::ObjectPage"),H=x.listBinding,K=y.getView().getBindingContext("internal"),N=K.getProperty("batchGroups");N.push("$auto");if(G.getBindingContext()&&G.getBindingContext().hasPendingChanges()&&!N.some(G.getBindingContext().getModel().hasPendingChanges.bind(G.getBindingContext().getModel()))){G.getBindingContext().getBinding().resetChanges();}for(var i=0;i<z.length;i++){A=z[i].getCreationRow();if(A){A.setBindingContext(null);}}var Q=function(d1){if(!G.isFirstRendering()&&!x.bPersistOPScroll){G.setSelectedSection(null);}};G.attachEventOnce("modelContextChange",Q);var U={onAfterRendering:Q};G.addEventDelegate(U,y);this.pageReady.attachEventOnce("pageReady",function(d1){G.removeEventDelegate(U);});if(H&&H.isA("sap.ui.model.odata.v4.ODataListBinding")){var W=y.byId("fe::Paginator");if(W){W.setListBinding(H);}}if(G.getEnableLazyLoading()){var X=G.getSections(),Y=G.getUseIconTabBar(),Z=2;for(var $=0;$<X.length;$++){var _=X[$];var a1=_.getSubSections();for(var b1=0;b1<a1.length;b1++,Z--){if(Z<1||(Y&&$>0)){var c1=a1[b1];c1.setBindingContext(null);}}}}},_handleSubSectionEnteredViewPort:function(i){var w=i.getParameter("subSection");w.setBindingContext(undefined);},_onAfterBinding:function(i,w){var x=this.byId("fe::ObjectPage"),y=this,z=this._findTables();i=x.getBindingContext();var A=[];x.getSections().forEach(function(Y){Y.getSubSections().forEach(function(Z){A=C.getIBNActions(Z,A);});});z.forEach(function(Y){var Z=Y.getBindingContext("internal");Z.setProperty("creationRowFieldValidity",{});A=C.getIBNActions(Y,A);var $=Y.getRowBinding();if($){if(s.isStickySessionSupported($.getModel().getMetaModel())){$.removeCachesAndMessages("");}}T.getSemanticTargetsFromTable(y,Y);});C.getSemanticTargetsFromPageModel(y,"_pageModel");var G=x.getHeaderTitle();var H=[];H=C.getIBNActions(G,H);A=A.concat(H);C.updateDataFieldForIBNButtonsVisibility(A,this.getView());var K,N;function Q(Y,Z){var $=Y.getCreationRow(),_,a1;if($){N.then(function(){if($.getModel("ui").getProperty("/isEditable")){_=K.bindList(Z.getPath(),Z.getContext(),[],[],{$$updateGroupId:"doNotSubmit",$$groupId:"doNotSubmit"});_.refreshInternal=function(){};a1=_.create();$.setBindingContext(a1);a1.created().catch(function(){L.trace("transient fast creation context deleted");});}}).catch(function(b1){L.error("Error while computing the final UI state",b1);});}}function U(Y){var X=y._getTableBinding(Y),Z=function(){Q(Y,X);};if(!X){L.error("Expected binding missing for table: "+Y.getId());return;}if(X.oContext){Z();}else{var $=function(){if(X.oContext){Z();X.detachChange($);}};X.attachChange($);}}if(i){K=i.getModel();N=this.editFlow.computeEditMode(i);if(i.getBinding().oCache){y._updateRelatedApps();}else{var W=function(){y._updateRelatedApps();i.getBinding().detachDataReceived(W);};i.getBinding().attachDataReceived(W);}var X=(i.getBinding&&i.getBinding())||i;X.attachEvent("patchSent",this.handlers.handlePatchSent,this);X.attachEvent("patchCompleted",this.handlers.handlePatchCompleted,this);z.forEach(function(Y){T.whenBound(Y).then(U).catch(function(Z){L.error("Error while waiting for the table to be bound",Z);});});x._triggerVisibleSubSectionsEvents();this.getAppComponent().getAppStateHandler().applyAppState();}},onPageReady:function(i){var w=i.lastFocusedControl;if(w&&w.controlId&&w.focusInfo){var x=this.getView();var y=x.byId(w.controlId);if(y){y.applyFocusInfo(w.focusInfo);return;}}var z=this.byId("fe::ObjectPage");var A=z.getModel("ui").getProperty("/editMode")==="Display";var G;if(A){var H=z.getHeaderTitle()&&z.getHeaderTitle().getActions();if(H&&H.length){G=H.find(function(N){return N.mProperties["visible"];});if(G){G.focus();}}}else{var K=z._getFirstEditableInput();if(K){K.focus();}}this._checkDataPointTitleForExternalNavigation();},getStickyEditMode:function(){var i=this.oView.getBindingContext&&this.oView.getBindingContext(),w=false;if(i){var x=s.isStickySessionSupported(i.getModel().getMetaModel());if(x){w=this.oView.getModel("ui").getProperty("/isEditable");}}return w;},_getPageTitleInformation:function(){var i=this.byId("fe::ObjectPage");var w=i.getCustomData().find(function(y){return y.getKey()==="ObjectPageSubtitle";});var x={title:i.data("ObjectPageTitle")||"",subtitle:w&&w.getValue(),intent:"",icon:""};return Promise.resolve(x);},_executeHeaderShortcut:function(i){var w=this.getView().getId()+"--"+i,x=this.byId("fe::ObjectPage").getHeaderTitle().getActions().find(function(y){return y.getId()===w;});C.fireButtonPress(x);},_executeFooterShortcut:function(i){var w=this.getView().getId()+"--"+i,x=this.byId("fe::ObjectPage").getFooter().getContent().find(function(y){return y.getMetadata().getName()==="sap.m.Button"&&y.getId()===w;});C.fireButtonPress(x);},_executeTabShortCut:function(i){var w=this.byId("fe::ObjectPage"),x=w.indexOfSection(this.byId(w.getSelectedSection())),y=w.getSections(),z=y.length-1,A=i.oSource.getCommand(),G;if(x!==-1&&z>0){if(A==="NextTab"){if(x<=z-1){G=y[++x];}}else{if(x!==0){G=y[--x];}}if(G){w.setSelectedSection(G);G.focus();}}},_getFooterVisibility:function(i){var w=this.getView().getBindingContext("internal");var x=this.getView().getId();v=i.getParameter("iMessageLength");v>0&&!w.getProperty("bIsCreateDialogOpen")?w.setProperty("showMessageFooter",true):w.setProperty("showMessageFooter",false);w.setProperty("messageFooterContainsErrors",false);sap.ui.getCore().getMessageManager().getMessageModel().getData().forEach(function(y){if(y.validation&&y.type==="Error"&&y.target.indexOf(x)>-1){w.setProperty("messageFooterContainsErrors",true);}});},_showMessagePopover:function(i){var w=i.oMessagePopover,x=w.getBinding("items");if(x.getLength()>0){setTimeout(function(){w.openBy(i);},0);}},_editDocument:function(i){var w=this.getView().getModel("ui");B.lock(w);return this.editFlow.editDocument.apply(this.editFlow,[i,this.getView().getViewData().prepareOnEdit]).finally(function(){B.unlock(w);});},_saveDocument:function(i){var w=this,x=this.getView().getModel("ui"),W=[];var y=false;B.lock(x);this._findTables().forEach(function(z){var A=w._getTableBinding(z);var G={creationMode:z.data("creationMode"),creationRow:z.getCreationRow(),createAtEnd:z.data("createAtEnd")==="true"};var H=G.creationRow&&G.creationRow.getBindingContext()&&Object.keys(G.creationRow.getBindingContext().getObject()).length>1;if(H){G.bSkipSideEffects=true;y=true;W.push(w.editFlow.createDocument(A,G).then(function(){return A;}));}});return Promise.all(W).then(function(z){return w.editFlow.saveDocument(i,y,z).then(function(){var A=w.getView().byId("fe::FooterBar::MessageButton");var G={onAfterRendering:function(H){w._showMessagePopover(A);A.removeEventDelegate(w._oDelegateOnAfter);delete w._oDelegateOnAfter;}};w._oDelegateOnAfter=G;A.addEventDelegate(G,w);}).catch(function(A){var G=w.getView().byId("fe::FooterBar::MessageButton");if(G){w._showMessagePopover(G);}}).finally(function(){B.unlock(x);});});},_cancelDocument:function(i,w){w.cancelButton=this.getView().byId(w.cancelButton);return this.editFlow.cancelDocument(i,w);},_applyDocument:function(i){var w=this;return this.editFlow.applyDocument(i).catch(function(x){L.error(x);var y=w.getView().byId("fe::FooterBar::MessageButton");if(y){w._showMessagePopover(y);}});},_updateRelatedApps:function(){var i=this.byId("fe::ObjectPage");if(C.resolveStringtoBoolean(i.data("showRelatedApps"))){C.updateRelatedAppsDetails(i);}},_findTableInSubSection:function(i,w,x){var y=[];for(var z=0;z<i.length;z++){var A=i[z].getContent instanceof Function&&i[z].getContent();if(A&&A.isA&&A.isA("sap.ui.layout.DynamicSideContent")){A=A.getMainContent instanceof Function&&A.getMainContent();if(A&&A.length>0){A=A[0];}}if(A&&A.isA&&A.isA("sap.fe.macros.TableAPI")){A=A.getContent instanceof Function&&A.getContent();if(A&&A.length>0){A=A[0];}}if(A&&A.isA&&A.isA("sap.ui.mdc.Table")){x.push(A);y.push({"table":A,"gridTable":A.getType().isA("sap.ui.mdc.table.GridTableType")});}}if(y.length===1&&i.length===1&&y[0].gridTable&&!w.hasStyleClass("sapUxAPObjectPageSubSectionFitContainer")){w.addStyleClass("sapUxAPObjectPageSubSectionFitContainer");}else{if(y&&!w.hasStyleClass("sapUxAPObjectPageSubSectionFitContainer")){y.forEach(function(G){if(G.gridTable){G.table.getType().setRowCount(null);}});}}},_findTables:function(){var i=this.byId("fe::ObjectPage"),w=[];var x=i.getSections();for(var y=0;y<x.length;y++){var z=x[y].getSubSections();for(var A=0;A<z.length;A++){this._findTableInSubSection(z[A].getBlocks(),z[A],w);this._findTableInSubSection(z[A].getMoreBlocks(),z[A],w);}}return w;},_getChartContextData:function(i,w){var x=i.getObject(),y=[x];if(i&&w){if(x[w]){y=x[w];delete x[w];y.push(x);}}return y;},_getTableRow:function(i,w){if(i.filter(function(y){return y!==undefined;}).length>0){var x=i.find(function(y){return y.getPath().indexOf(w)!==-1;});return x;}else{return undefined;}},_scrollTableToRow:function(i,w){var x=i.getRowBinding();var y=this;var z=new Promise(function(A,G){if(x){var H;switch(i.data().tableType){case"GridTable":H=x.getContexts(0);break;case"ResponsiveTable":H=x.getCurrentContexts();break;default:}if(H.filter(function(K){return K===undefined;}).length>0||H.length===0){x.attachChange(function N(K){var H=y._getTableRow(K.getSource().getCurrentContexts(),w);if(H){x.detachChange(N);A(H);}});}else{A(y._getTableRow(H,w));}}else{G();}});z.then(function(A){if(A){var G=A.iIndex;i.scrollToIndex(G);}}).catch(function(){L.warning("Could not find any matched row");});},_scrollTablesToRow:function(w){if(this._findTables&&this._findTables().length>0){var x=this._findTables();for(var i=0;i<x.length;i++){this._scrollTableToRow(x[i],w);}}},_mergeMultipleContexts:function(i,w,x){var y=this;var A=[],z=[],G,H,K,N,Q,U,W;W=i.getPath();G=i&&i.getModel()&&i.getModel().getMetaModel();N=G&&G.getMetaPath(W).replace(/^\/*/,"");if(w&&w.length){H=w[0];Q=H.getPath();K=G&&G.getMetaPath(Q).replace(/^\/*/,"");w.map(function(X){if(x){var Y=y._getChartContextData(X,x);if(Y){A=Y.map(function(Y){return{contextData:Y,entitySet:N+"/"+x};});}}else{A.push({contextData:X.getObject(),entitySet:K});}});}z.push({contextData:i.getObject(),entitySet:N});z=C.removeSensitiveData(z,G);U=C.addPageContextToSelectionVariant(new f(),z,y.getView());A=C.removeSensitiveData(A,G);return{selectionVariant:U,attributes:A};},_getBatchGroupsForView:function(){var i=this,w=i.getView().getViewData(),x=w.controlConfiguration,y=x&&Object.keys(x),z=["$auto.Heroes","$auto.Decoration","$auto.Workers"];if(y&&y.length>0){y.forEach(function(K){var A=x[K];if(A.requestGroupId==="LongRunners"){z.push("$auto.LongRunners");}});}return z;},_setBreadcrumbLinks:function(w){var x=w.getBindingContext();var A=this.getAppComponent();if(x){var N=x.getPath(),y=N.split("/"),z="";y.shift();y.splice(-1,1);y.forEach(function(G,i){z+="/"+G;var H=A.getRootViewController();var K=H.getTitleHierarchyCache();var Q;if(!K[z]){Q=H.addNewEntryInCacheTitle(z,A);}else{Q=Promise.resolve(K[z]);}Q.then(function(U){var W=w.getLinks()[i]?w.getLinks()[i]:new j();W.setText(U.subtitle||U.title);W.setHref(U.intent);if(!w.getLinks()[i]){w.addLink(W);}}).catch(function(U){L.error("Error while computing the title hierarchy",U);});});}},_checkDataPointTitleForExternalNavigation:function(){var i=this.getView();var w=i.getBindingContext("internal");var x=C.getHeaderFacetItemConfigForExternalNavigation(i.getViewData(),this.getAppComponent().getRoutingService().getOutbounds());var y=this.getAppComponent().getShellServices();var z=i&&i.getBindingContext();w.setProperty("isHeaderDPLinkVisible",{});if(z){z.requestObject().then(function(K){H(x,K);}).catch(function(K){L.error("Cannot retrieve the links from the shell service",K);});}function A(K){L.error(K);}function G(K){var N=this.id;if(K&&K.length===1&&K[0].supported){w.setProperty("isHeaderDPLinkVisible/"+N,true);}}function H(x,K){for(var N in x){var Q=x[N];var U={};var W=i.byId(N);if(!W){continue;}var X=W.getBindingContext();var Y=X&&X.getObject();var Z=m({},K,Y);if(Q.semanticObjectMapping){var $=Q.semanticObjectMapping;for(var _ in $){var a1=$[_];var b1=a1["LocalProperty"]["$PropertyPath"];var c1=a1["SemanticObjectProperty"];if(b1!==c1){if(Z.hasOwnProperty(b1)){var d1={};d1[c1]=Z[b1];Z=m({},Z,d1);delete Z[b1];}}}}if(Z){for(var e1 in Z){if(e1.indexOf("_")!==0&&e1.indexOf("odata.context")===-1){U[e1]=Z[e1];}}}y.isNavigationSupported([{target:{semanticObject:Q.semanticObject,action:Q.action},params:U}]).then(G.bind({id:N})).catch(A);}}},_onBeforeExport:function(i){var w=i.getSource();T.onBeforeExport(i,w);},handlers:{onTableContextChange:function(w){var x=this;var y=w.getSource();var z;this._findTables().some(function(_){if(_.getRowBinding()===y){z=_;return true;}return false;});var A=this.editFlow.getCurrentActionPromise();if(A){var G;if(z.getType().getMetadata().isA("sap.ui.mdc.table.GridTableType")){G=y.getContexts(0);}else{G=y.getCurrentContexts();}if(!G[0]){return;}A.then(function(H){if(!H||H.controlId!==z.sId){return;}var K=H.oData;var N=H.keys;var Q=-1;G.find(function(X,i){var Y=X.getObject();var Z=N.every(function($){return Y[$]===K[$];});if(Z){Q=i;}return Z;});if(Q!==-1){var U=u.getOpenDialogs();var W=U.length>0?U[0]:null;if(W){W.attachEventOnce("afterClose",function(){z.focusRow(Q,true);});}else{z.focusRow(Q,true);}x.editFlow.deleteCurrentActionPromise();}}).catch(function(i){L.error("An error occurs while scrolling to the newly created Item: "+i);});}},onShareObjectPageActionButtonPress:function(i,w){var x=w.getView().byId("fe::Share");w._getPageTitleInformation().then(function(y){if(x&&(x.getVisible()||(x.getEnabled&&x.getEnabled()))){l.onShareActionButtonPressImpl(x,w,y);}}).catch(function(y){L.error("Error while retrieving the page title information",y);});},onCallActionFromFooter:function(i,A,w){var x=i.getController();var y=x;return x.editFlow.invokeAction(A,w).then(function(){var z=y.getView().byId("fe::FooterBar::MessageButton");if(z.isActive()){y._showMessagePopover(z);}else if(v){y._oDelegateOnAfter={onAfterRendering:function(G){y._showMessagePopover(z);z.removeEventDelegate(y._oDelegateOnAfter);delete y._oDelegateOnAfter;}};z.addEventDelegate(y._oDelegateOnAfter,y);}}).catch(function(z){var G=y.getView().byId("fe::FooterBar::MessageButton");if(G){y._showMessagePopover(G);}});},onDataPointTitlePressed:function(i,w,x,y,z){x=typeof x==="string"?JSON.parse(x):x;var A=x[y],G=C.getSemanticObjectMapping(A),H=w.getBindingContext(),K=H.getModel().getMetaModel().getMetaPath(H.getPath()),N=i._getChartContextData(H,z);N=N.map(function(Q){return{data:Q,metaPath:K+(z?"/"+z:"")};});if(A&&A.semanticObject&&A.action){i._intentBasedNavigation.navigate(A.semanticObject,A.action,{navigationContexts:N,semanticObjectMapping:G});}},onChevronPressNavigateOutBound:function(i,w,x){var y=i.getAppComponent().getRoutingService().getOutbounds(),z=y[w];if(z&&z.semanticObject&&z.action){x=x&&x.isA&&x.isA("sap.ui.model.odata.v4.Context")?[x]:x;i._intentBasedNavigation.navigate(z.semanticObject,z.action,{navigationContexts:x});return Promise.resolve();}else{throw new Error("outbound target "+w+" not found in cross navigation definition of manifest");}},onNavigateChange:function(i){this.getExtensionAPI().updateAppState();this.bSectionNavigated=true;},onVariantSelected:function(i){this.getExtensionAPI().updateAppState();},onVariantSaved:function(i){var w=this;setTimeout(function(){w.getExtensionAPI().updateAppState();},500);},navigateToSubSection:function(i,w){var x=typeof w==="string"?JSON.parse(w):w,y=i.getView().byId("fe::ObjectPage"),z,A;if(x.sectionId){z=i.getView().byId(x.sectionId);A=x.subSectionId?i.getView().byId(x.subSectionId):z&&z.getSubSections()&&z.getSubSections()[0];}else if(x.subSectionId){A=i.getView().byId(x.subSectionId);z=A&&A.getParent();}if(!z||!A||!z.getVisible()||!A.getVisible()){i.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(G){var H=C.getTranslatedText("C_ROUTING_NAVIGATION_DISABLED_TITLE",G,null,i.getView().getViewData().entitySet);L.error(H);M.error(H);}).catch(function(G){L.error(G);});}else{y.scrollToSection(A.getId());y.fireNavigate({section:z,subSection:A});}},onChartSelectionChanged:function(i){k.fnUpdateChart(i);},handlePatchSent:function(i){var w=this;var x=new Promise(function(y,z){w.resolvePatchPromise=y;w.rejectPatchPromise=z;});this.editFlow.updateDocument(x,i.getSource());},handlePatchCompleted:function(i){var w=i.getParameter("success");if(w){this.resolvePatchPromise();}else{this.rejectPatchPromise();}},handleErrorOfTable:function(i){if(i.getParameter("error")){setTimeout(g.showUnboundMessages,0);}}}});});
