sap.ui.define(["sap/fe/core/library","sap/fe/navigation/library","sap/fe/core/CommonUtils","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/p13n/StateUtil","sap/ui/Device","sap/ui/mdc/enum/ConditionValidated"],function(C,N,a,b,S,D,c){"use strict";var d=N.NavType,V=C.VariantManagement,T=C.TemplateContentView,I=C.InitialLoadMode;return{applyInitialStateOnly:function(){return true;},onBeforeStateApplied:function(p){var v=this.getView(),o=v.getController(),f=o._getFilterBarControl(),t=o._getTables();f.setSuspendSelection(true);t.forEach(function(e){p.push(e.initialized());});p.push(f.initialized());delete this._bSearchTriggered;},onAfterStateApplied:function(){var v=this.getView(),o=v.getController();o._getFilterBarControl().setSuspendSelection(false);},adaptStateControls:function(s){var v=this.getView(),o=v.getController(),e=v.getViewData(),f=e.variantManagement===V.Control;if(o._isMultiMode()){s.push(o._getMultiModeControl());}var F=this._getFilterBarVM(v);if(F){s.push(F);}o._getTables().forEach(function(t){if(t.getQuickFilter()){s.push(t.getQuickFilter().getSelector());}if(f){s.push(t.getVariant());}});if(o._isAlp()){s.push(o._getSegmentedButton(T.Chart));s.push(o._getSegmentedButton(T.Table));}s.push(o._getFilterBarControl());s.push(v.byId("fe::ListReport"));},retrieveAdditionalStates:function(A){var v=this.getView(),o=v.getController(),p=v.getBindingContext("internal").getProperty("hasPendingFilters");A.dataLoaded=!p||!!this._bSearchTriggered;if(o._isAlp()){var s=v.getBindingContext("internal").getProperty("alpContentView");A.alpContentView=s;}delete this._bSearchTriggered;},applyAdditionalStates:function(A){var v=this.getView(),o=v.getController(),f=o._getFilterBarControl();if(A){if(A.dataLoaded===false){f._bSearchTriggered=false;}else if(A.dataLoaded===true){o._getFilterBarControl().triggerSearch();this._bSearchTriggered=true;}if(o._isAlp()){var i=v.getBindingContext("internal");if(!D.system.desktop&&A.alpContentView==T.Hybrid){A.alpContentView=T.Chart;}i.getModel().setProperty(i.getPath()+"/alpContentView",A.alpContentView);}}},applyNavigationParameters:function(n){var v=this.getView(),t=this;return this._applySelectionVariant(v,n).then(function(){var o=v.getController();var e=v.byId("fe::ListReport");var h=false;var f=t._getFilterBarVM(v);var F=o._getFilterBarControl();if(n.navigationType!==d.initial||(!f&&v.getViewData().initialLoad===I.Enabled)||o._shouldAutoTriggerSearch(f)){F.triggerSearch();}else{h=t._isHeaderExpanded(f);}t._bSearchTriggered=!h;e.setHeaderExpanded(h);});},_getFilterBarVM:function(v){var o=v.getViewData();switch(o.variantManagement){case V.Page:return v.byId("fe::PageVariantManagement");case V.Control:return v.byId(v.getContent()[0].data("filterBarVariantId"));case V.None:return null;default:throw new Error("unhandled variant setting: "+o.variantManagement);}},_isHeaderExpanded:function(v){if(!v){return true;}var e=v.getVariants();var o=e.find(function(i){return i.key===v.getCurrentVariantKey();});return!o.executeOnSelect;},_applySelectionVariant:function(v,n){var s=n.selectionVariant,o=n.selectionVariantDefaults;if(!s){return Promise.resolve();}var e={},m=v.getModel().getMetaModel(),f=v.getViewData(),E=f.entitySet,F=v.byId(v.getContent()[0].data("filterBarId")),M=a.getMandatoryFilterFields(m,E),g,r=n.requiresStandardVariant;a.addDefaultDisplayCurrency(M,s,o);a.addSelectionVariantToConditions(s,e,m,E);switch(f.variantManagement){case V.Page:g=v.byId("fe::PageVariantManagement");break;case V.Control:g=v.byId(v.getContent()[0].data("filterBarVariantId"));break;case V.None:default:break;}return this._activateSelectionVariant(F,e,g,r);},_activateSelectionVariant:function(f,o,v,r){var t=this,p;if(v){var e=r?v.getStandardVariantKey():v.getDefaultVariantKey();if(e===null){e=v.getId();}p=b.activateVariant({element:v,variantReference:e}).then(function(){return r||v.getDefaultVariantKey()===v.getStandardVariantKey();});}else{p=Promise.resolve(true);}return p.then(function(g){if(g){return t._fnClearFilterAndReplaceWithAppState(f,o);}});},_fnApplyConditions:function(f,o){var F={},i=[],A=function(e){e.validated=c.Validated;if(e.operator==="Empty"){e.operator="EQ";e.values=[""];}else if(e.operator==="NotEmpty"){e.operator="NE";e.values=[""];}delete e.isEmpty;};return f.initialized().then(function(){f.getPropertyInfoSet().filter(function(p){return p.path!=="$editState"&&p.path!=="$search";}).forEach(function(p){if(p.path in o){F[p.path]=o[p.path];if(!p.hiddenFilter){i.push({name:p.path});}if(p.hasValueHelp){F[p.path].forEach(A);}}else{F[p.path]=[];}});return S.applyExternalState(f,{filter:F,items:i});});},_fnClearFilterAndReplaceWithAppState:function(f,o){return this._fnApplyConditions(f,{}).then(this._fnApplyConditions.bind(this,f,o));}};});
