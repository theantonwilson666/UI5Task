/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/core/PageController","sap/fe/core/controllerextensions/SideEffects","sap/fe/core/controllerextensions/EditFlow","sap/fe/macros/field/FieldRuntime","sap/fe/core/actions/messageHandling","sap/base/Log","sap/base/util/ObjectPath","sap/fe/navigation/SelectionVariant","sap/fe/core/CommonUtils","sap/ui/mdc/p13n/StateUtil","sap/fe/macros/table/Utils","sap/fe/macros/ResourceModel","sap/fe/core/controllerextensions/InternalRouting","sap/ui/Device","sap/fe/core/controllerextensions/IntentBasedNavigation","./overrides/IntentBasedNavigation","sap/fe/core/controllerextensions/InternalIntentBasedNavigation","sap/fe/macros/chart/ChartRuntime","sap/fe/templates/controls/Share/ShareUtils","sap/base/util/merge","sap/fe/templates/ListReport/ExtensionAPI","sap/fe/macros/filter/FilterUtils","sap/fe/macros/chart/ChartUtils","sap/ui/core/mvc/OverrideExecution","sap/fe/core/controllerextensions/ViewState","./overrides/ViewState","sap/fe/templates/RootContainer/overrides/EditFlow","sap/fe/core/helpers/EditState","sap/ui/model/json/JSONModel","sap/fe/core/library","sap/fe/core/helpers/SemanticDateOperators"],function(P,S,E,F,m,L,O,a,C,b,T,R,I,D,c,d,e,f,g,h,j,l,n,o,V,p,q,r,J,s,t){"use strict";var u=s.TemplateContentView,v=s.InitialLoadMode;return P.extend("sap.fe.templates.ListReport.ListReportController",{metadata:{methods:{getExtensionAPI:{"public":true,"final":true},onPageReady:{"public":false,"final":false,overrideExecution:o.After}}},_routing:I.override({onAfterBinding:function(i,k){this.getView().getController()._onAfterBinding(i,k);}}),_intentBasedNavigation:e.override({getEntitySet:function(){return this.base.getCurrentEntitySet();}}),sideEffects:S,intentBasedNavigation:c.override(d),editFlow:E.override(q),viewState:V.override(p),getExtensionAPI:function(){if(!this.extensionAPI){this.extensionAPI=new j(this);}return this.extensionAPI;},messageHandling:m,onInit:function(){P.prototype.onInit.apply(this);var i=this;var k=this._getTables();var w=this.getView().getBindingContext("internal");if(i._isMultiMode()){var M=i._getMultiModeControl();w.setProperty("tabs",{selected:M.getSelectedKey()||M.getItems()[0].getKey()});k.forEach(function(y){var U=function(){i._updateCounts();};T.addEventToBindingInfo(y,"dataRequested",U);});}w.setProperty("hasPendingFilters",true);w.setProperty("appliedFilters","");if(this._isAlp()){var x=u.Hybrid;if(!D.system.desktop){x=u.Chart;}w.setProperty("alpContentView",x);}this.filterBarConditions={};this.getAppComponent().getRouterProxy().waitForRouteMatchBeforeNavigation();this._updateMultiTableHiddenStatus();l.attachConditionHandling(this._getFilterBarControl());},onExit:function(){l.detachConditionHandling(this._getFilterBarControl());delete this._sEntitySet;delete this.filterBarConditions;delete this._oListReportControl;delete this._bMultiMode;this.extensionAPI&&this.extensionAPI.destroy();delete this.extensionAPI;},_onBeforeExport:function(i){var k=i.getSource();T.onBeforeExport(i,k);},_onAfterBinding:function(){var i=this._getTables();var k=this;if(r.isEditStateDirty()){var w=this._getTableBinding();if(!this.sUpdateTimer){this.sUpdateTimer=setTimeout(function(){if(w){w.refresh();}delete k.sUpdateTimer;},0);}r.setEditStateProcessed();}var x=[];i.forEach(function(y){x=C.getIBNActions(y,x);T.getSemanticTargetsFromTable(k,y);});C.updateDataFieldForIBNButtonsVisibility(x,this.getView());this.getAppComponent().getAppStateHandler().applyAppState();},onAfterRendering:function(i){var k=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(w){k.oResourceBundle=w;}).catch(function(w){L.error("Error while retrieving the resource bundle",w);});},onPageReady:function(i){var k=i.lastFocusedControl;var w=this.getView();if(k&&k.controlId&&k.focusInfo){var x=w.byId(k.controlId);if(x){x.applyFocusInfo(k.focusInfo);}}},getCurrentEntitySet:function(){if(!this._sEntitySet){var i=this._getCurrentTable();this._sEntitySet=i.data("targetCollectionName").slice(1);}return this._sEntitySet;},_scrollTablesToRow:function(k){var w,x,y,z;if(this._getTables&&this._getTables().length>0){w=this._getTables();for(var i=0;i<w.length;i++){x=w[i];z=x.getRowBinding();if(z){var A;switch(x.data().tableType){case"GridTable":A=z.getContexts(0);break;case"ResponsiveTable":A=z.getCurrentContexts();break;default:}y=A.find(function(G){return G&&G.getPath().indexOf(k)!==-1;});}if(y){var B=y.iIndex;x.scrollToIndex(B);}}}},_getPageTitleInformation:function(){var i=this;return new Promise(function(k,w){var x={title:"",subtitle:"",intent:"",icon:""};x.title=i.getView().getContent()[0].data().ListReportTitle;x.subtitle=i.getView().getContent()[0].data().ListReportSubtitle;k(x);});},_getFilterBarControl:function(){return this.getView().byId(this._getFilterBarControlId());},_getSegmentedButton:function(i){return this.getView().byId(this._getSegmentedButtonId(i));},_getSegmentedButtonId:function(i){if(i==="Chart"){return this.getChartControl().data("segmentedButtonId");}else{return this._getCurrentTable().data("segmentedButtonId");}},_getFilterBarControlId:function(){return this.getView().getContent()[0].data("filterBarId");},_getChartControlId:function(){return this.getView().getContent()[0].data("singleChartId");},getChartControl:function(){return this.getView().byId(this._getChartControlId());},_getMultiModeControl:function(){return this.getView().byId("fe::TabMultipleMode");},_getTableControlId:function(){return this.getView().getContent()[0].data("singleTableId");},_getCurrentTable:function(){if(!this._oListReportControl){var M=this._getMultiModeControl();if(M){this._oListReportControl=this.getView().byId(M.getSelectedKey()||M.getItems()[0].getKey());}else{this._oListReportControl=this.getView().byId(this._getTableControlId());}}return this._oListReportControl;},_getTableBinding:function(i){var k=i?this.getView().byId(i):this._getCurrentTable(),B=k&&k._getRowBinding();return B;},_getTables:function(){var i=this;if(this._isMultiMode()){var k=[];var w=this._getMultiModeControl();w.getItems().forEach(function(x){var y=i.getView().byId(x.getKey());if(y){k.push(y);}});return k;}return[this._getCurrentTable()];},_getMergedContext:function(i,k){var w,A;w=C.addExternalStateFiltersToSelectionVariant(new a(),k);if(i&&i.length){var M=this.getView().getModel().getMetaModel();A=i.map(function(x){return{contextData:x.getObject(),entitySet:M.getMetaPath(x.getPath()).replace(/^\/*/,"")};});A=C.removeSensitiveData(A,M);}return{selectionVariant:w,attributes:A};},_isMultiMode:function(){if(!this._oListReportControl){this._bMultiMode=!!this._getMultiModeControl();}return this._bMultiMode;},_isMultiEntitySets:function(){return(this.getView().getContent()[0].data("isMultiEntitySets")==="true");},_isAlp:function(){return(this.getView().getContent()[0].data("isAlp")==="true");},_setShareModel:function(){var G=O.get("sap.ushell.Container.getUser");var i={bookmarkTitle:document.title,bookmarkCustomUrl:function(){var H=window.hasher.getHash();return H?"#"+H:window.location.href;},isShareInJamActive:!!G&&G().isJamActive()};var k=this.getOwnerComponent().getModel("_templPriv");k.setProperty("/listReport/share",i);},_updateMultiTableHiddenStatus:function(){var i=this._getCurrentTable();if(this._isMultiMode()&&i){var k=i.getId();var w=this._getTables();w.forEach(function(x){var y=x.getId();x.data("tableHidden",y!==k);});}},_updateMultiNotApplicableFields:function(i,k){var w={};var x={},y=this._getTables();y.forEach(function(z){var A=z.data("targetCollectionName"),B=A.slice(1),G=z.getParent().getParent().getKey(),H=B+(z.data("enableAnalytics")==="true"?"Analytical":"Regular");if(!w[H]){w[H]=l.getNotApplicableFiltersForTable(k,z);}x[G]=w[H];});i.setProperty("tabs/ignoredFields",x);},_updateTableControl:function(){this._sEntitySet=undefined;this._oListReportControl=undefined;this._getCurrentTable();},_updateCounts:function(){this._updateMutliModeCounts();},_updateMutliModeCounts:function(){var i=this;var B=[];var M=this._getMultiModeControl();if(M&&M.data("showCounts")==="true"){var w=this._getCurrentTable();var x=w.getId();var y=[];var z=M.getItems();z.forEach(function(k){var A=i.getView().byId(k.getKey());if(A&&(k.data("outdatedCounts")||A.getId()===x)){y.push({table:A,item:k});}});B=y.map(function(k){k.item.setCount("...");var A=k.table;var G=T.getFiltersInfoforSV(A,k.item.data("selectionVariant"));return T.getListBindingForCount(A,i.getView().getBindingContext(),{batchGroupId:A.getId()===x?A.data("batchGroupId"):"$auto",additionalFilters:G.filters});});Promise.all(B).then(function(A){for(var k in A){var G=y[k].item;G.setCount(T.getCountFormatted(A[k]));G.data("outdatedCounts",false);}}).catch(function(k){L.error("Error while retrieving the values for the icon tab bar",k);});}},_shouldAutoTriggerSearch:function(i){if(this.getView().getViewData().initialLoad===v.Auto&&(!i||i.getStandardVariantKey()===i.getCurrentVariantKey())){var k=this._getFilterBarControl(),w=k.getConditions();for(var K in w){if(!K.startsWith("$")&&Array.isArray(w[K])&&w[K].length){return true;}}}return false;},_updateTable:function(i){if(!i.isTableBound()||this.hasPendingChartChanges){i.rebindTable();this.hasPendingChartChanges=false;}},_updateChart:function(i){if(!i.isInnerChartBound()||this.hasPendingTableChanges){i.getControlDelegate().rebindChart(i,i.getBindingInfo("data"));this.hasPendingTableChanges=false;}},handlers:{handleErrorOfTable:function(i){if(i.getParameter("error")){setTimeout(m.showUnboundMessages,0);}},onShareListReportActionButtonPress:function(i,k,U){var w=k.getView().byId("fe::Share");var x=k.getView().byId(k.getView().getContent()[0].data("filterBarId"));var y=x.getFilterConditions();var z=U&&t.hasSemanticDateOperations(y);if(w&&(w.getVisible()||(w.getEnabled&&w.getEnabled()))){g.onShareActionButtonPressImpl(w,k,null,z);}},onTabMultiModeChange:function(i){this._updateTableControl();this._updateMultiTableHiddenStatus();var k=this._getFilterBarControl();var w=this.getView().getBindingContext("internal");var x=this._getCurrentTable();w.setProperty("tabs/selected",this._getMultiModeControl().getSelectedKey());if(k&&w.getProperty("hasPendingFilters")!==true&&(!x.getRowBinding()||x.data("outdatedRows")===true)){x.rebindTable();x.data("outdatedRows",false);}this.getExtensionAPI().updateAppState();},onFiltersChanged:function(i){var k=i.getSource(),w=this.getView().getBindingContext("internal");w.setProperty("appliedFilters",k.getAssignedFiltersText().filtersText);w.setProperty("hasPendingFilters",true);if(i.getParameter("conditionsBased")){this.getExtensionAPI().updateAppState();}},onVariantSelected:function(i){var k=this,w=i.getSource();setTimeout(function(){if(k._shouldAutoTriggerSearch(w)){return k._getFilterBarControl().triggerSearch();}else{k.getExtensionAPI().updateAppState();}},0);},onVariantSaved:function(i){var k=this;setTimeout(function(){k.getExtensionAPI().updateAppState();},1000);},onSearch:function(i){var k=this;var w=this._getCurrentTable().getId();var x=i.getSource();var y=this.getView().getBindingContext("internal");var M=this.getChartControl();y.setProperty("hasPendingFilters",false);if(this._isMultiMode()){var z=this._getTables();var A=this._getMultiModeControl();if(A&&A.data("showCounts")==="true"){var B=A.getItems();B.forEach(function(K){K.data("outdatedCounts",true);});}this._updateMultiNotApplicableFields(y,x);z.forEach(function(K){K.data("outdatedRows",K.getId()!==w);});}if(M){M.getBindingContext("internal").setProperty("",{});var G=M.getBindingContext("pageInternal");var H=G.getProperty(G.getPath()+"/alpContentView");if(H===u.Chart){this.hasPendingChartChanges=true;}if(H===u.Table){this.hasPendingTableChanges=true;}}b.retrieveExternalState(x).then(function(K){k.filterBarConditions=K.filter;}).catch(function(K){L.error("Error while retrieving the external state",K);});if(this.getView().getViewData().liveMode===false){this.getExtensionAPI().updateAppState();}},onChevronPressNavigateOutBound:function(i,k,w){var x=i.getAppComponent().getRoutingService().getOutbounds(),y=x[k];if(y&&y.semanticObject&&y.action){w=w&&w.isA&&w.isA("sap.ui.model.odata.v4.Context")?[w]:w;i._intentBasedNavigation.navigate(y.semanticObject,y.action,{navigationContexts:w});return Promise.resolve();}else{throw new Error("outbound target "+k+" not found in cross navigation definition of manifest");}},onChartSelectionChanged:function(i){var M=i.getSource(),k=this._getCurrentTable(),w=i.getParameter("dataContext"),x=this.getView().getBindingContext("internal");if(w&&w.data){f.fnUpdateChart(i);n.setChartFilters(M);}var y=x.getProperty(x.getPath()+"/alpContentView");if(y===u.Chart){this.hasPendingChartChanges=true;}else{k&&k.rebindTable();this.hasPendingChartChanges=false;}},onSegmentedButtonPressed:function(i){var k=i.mParameters.key?i.mParameters.key:null;var w=this.getView().getBindingContext("internal");w.setProperty("alpContentView",k);var x=this.getChartControl();var y=this._getCurrentTable();switch(k){case u.Table:this._updateTable(y);break;case u.Chart:this._updateChart(x);break;case u.Hybrid:this._updateTable(y);this._updateChart(x);break;default:break;}this.getExtensionAPI().updateAppState();}},formatters:{setTabMessageStrip:function(i,k){var w="";if(Array.isArray(i)&&i.length>0&&k){var x=this._getFilterBarControl(),y=x.data("entityType"),M=this.getView().getModel().getMetaModel(),z=sap.ui.getCore().getLibraryResourceBundle("sap.fe.templates"),A=i.map(function(G){if(G==="$search"){var H=sap.ui.getCore().getLibraryResourceBundle("sap.fe.macros");return H?H.getText("M_FILTERBAR_SEARCH"):"";}return M.getObject(y+G+"@com.sap.vocabularies.Common.v1.Label");});if(z){var B="C_LR_MULTITABLES_"+(A.length===1?"SINGLE":"MULTI")+"_IGNORED_FILTER_"+(D.system.desktop?"LARGE":"SMALL");w=z.getText(B,[A.join(", "),k]);}}return w;}}});});
