/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/gantt/library","sap/ui/core/Core","sap/ui/core/Element","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/format/DateFormat","sap/base/util/ObjectPath","../misc/Utility","../misc/Format","../misc/RelativeTimeFormatter","../config/TimeHorizon","../misc/AxisTime"],function(L,l,C,E,a,b,D,O,U,F,R,T,A){"use strict";var c=E.extend("sap.gantt.axistime.AxisTimeStrategyBase",{metadata:{library:"sap.gantt","abstract":true,properties:{timeLineOptions:{type:"object"},timeLineOption:{type:"object"},coarsestTimeLineOption:{type:"object"},finestTimeLineOption:{type:"object"},zoomLevels:{type:"int",defaultValue:10},zoomLevel:{type:"int",defaultValue:0},calendarType:{type:"string",defaultValue:sap.ui.core.CalendarType.Gregorian},locale:{type:"object"},firstDayOfWeek:{type:"int"},mouseWheelZoomType:{type:"sap.gantt.MouseWheelZoomType",defaultValue:l.MouseWheelZoomType.FineGranular}},aggregations:{totalHorizon:{type:"sap.gantt.config.TimeHorizon",multiple:false},visibleHorizon:{type:"sap.gantt.config.TimeHorizon",multiple:false},_axisTime:{type:"sap.gantt.misc.AxisTime",multiple:false,visibility:"hidden"}}}});c.prototype.applySettings=function(s){s=s||{};if(!s.visibleHorizon){s.visibleHorizon=l.config.DEFAULT_INIT_HORIZON.clone();}if(!s.totalHorizon){s.totalHorizon=l.config.DEFAULT_PLAN_HORIZON.clone();}this.checkFirstDayOfWeek(s);E.prototype.applySettings.call(this,s);this.calZoomBase();return this;};c.prototype.clone=function(){var o=E.prototype.clone.apply(this,arguments);if(o.hasListeners("_redrawRequest")){o.mEventRegistry._redrawRequest.forEach(function(r){o.detachEvent("_redrawRequest",r.fFunction,r.oListener);});}return o;};c.prototype.exit=function(){C.detachLocalizationChanged(this._onLocalizationChanged,this);};c.prototype.isTimePeriodZoomEnabled=function(){return true;};c.prototype._setVisibleHorizon=function(v){var h=this._completeTimeHorizon(v);var o=this.getAggregation("visibleHorizon");if(o){o.setStartTime(h.getStartTime(),true);o.setEndTime(h.getEndTime(),true);}else{this.setAggregation("visibleHorizon",h,true);}return this;};c.prototype.setVisibleHorizonWithReason=function(v,r,o){this._setVisibleHorizon(v);return this;};c.prototype._completeTimeHorizon=function(v){var o=this.getVisibleHorizon(),d=this.getTotalHorizon();if(o===null||d===null){return v;}var r=new T({startTime:o.getStartTime(),endTime:o.getEndTime()});if(v){var s=v.getStartTime(),e=v.getEndTime(),f,t=F.abapTimestampToDate(d.getStartTime()),g=F.abapTimestampToDate(d.getEndTime());if(!s&&!e){return r;}var i;if(this._oZoom&&this._oZoom.base&&this._oZoom.base.scale!==undefined&&this._nGanttVisibleWidth!==undefined&&this.getAxisTime()){var n=this.getAxisTime().getZoomRate();var h=this._oZoom.base.scale/n;i=this._nGanttVisibleWidth*h;}else{i=F.abapTimestampToDate(r.getEndTime()).getTime()-F.abapTimestampToDate(r.getStartTime()).getTime();}if(!s){f=F.abapTimestampToDate(e);f.setTime(f.getTime()-i);if(f<t){f=t;e=F.dateToAbapTimestamp(new Date(t+i));}s=F.dateToAbapTimestamp(f);}else if(!e){f=F.abapTimestampToDate(s);f.setTime(f.getTime()+i);if(f>g){f=g;s=F.dateToAbapTimestamp(new Date(g-i));}e=F.dateToAbapTimestamp(f);}else{f=F.abapTimestampToDate(s);if(f<t){s=this.getTotalHorizon().getStartTime();}f=F.abapTimestampToDate(e);if(f>g){e=this.getTotalHorizon().getEndTime();}}r.setStartTime(s);r.setEndTime(e);}return r;};c.prototype.createAxisTime=function(o){var t=this.getTimeLineOption(),v=this.getVisibleHorizon(),d=this.getTotalHorizon();if(!U.judgeTimeHorizonValidity(v,d)){if(this.getVisibleHorizon()){this.getVisibleHorizon().setStartTime(d.getStartTime(),true);this.getVisibleHorizon().setEndTime(d.getEndTime(),true);}else{this.setAggregation("visibleHorizon",d.clone(),true);}L.warning("Visible horizon is not in total horizon, so convert visible horizon to total horizon",null,"sap.gantt.axistime.AxisTimeStrategyBase.createAxisTime()");}var h=F.getTimeStampFormatter().parse(d.getStartTime());var H=F.getTimeStampFormatter().parse(d.getEndTime());var n=H.valueOf()-h.valueOf();var u=F.getTimeStampFormatter().parse("20000101000000");var e=O.get(t.innerInterval.unit).offset(u,t.innerInterval.span).valueOf()-u.valueOf();var f=new A([h,H],[0,Math.ceil(n*t.innerInterval.range/e)],1,null,null,o,this);this.setAggregation("_axisTime",f,true);};c.prototype.syncContext=function(n){var r={zoomLevel:undefined,axisTimeChanged:false};return r;};c.prototype.updateStopInfo=function(s){return null;};c.prototype._setTotalHorizon=function(t,s){if(typeof s==="undefined"){s=true;}if(t){var o=this.getAggregation("totalHorizon");if(o){o.setStartTime(t.getStartTime(),true);o.setEndTime(t.getEndTime(),true);}else{this.setAggregation("totalHorizon",t,s);}}return this;};c.prototype.getUpperRowFormatter=function(){var t=this.getTimeLineOption();var o=t.largeInterval;var f;if(o.relativeTime){var d=F.abapTimestampToDate(this.getTotalHorizon().getStartTime());f=new R(d,o.unit,o.relativeTimePrefix);}else{var e=this.getCalendarType(),g=this.getLocale()?this.getLocale():new a(C.getConfiguration().getLanguage().toLowerCase());f=D.getDateTimeInstance({format:o.format,pattern:o.pattern,style:o.style,calendarType:t.calendarType||e},o.locale?new a(o.locale):g);}return f;};c.prototype.getLowerRowFormatter=function(){var t=this.getTimeLineOption();var s=t.smallInterval;var f;if(s.relativeTime){var o=F.abapTimestampToDate(this.getTotalHorizon().getStartTime());f=new R(o,s.unit,s.relativeTimePrefix);}else{var d=this.getCalendarType(),e=this.getLocale()?this.getLocale():new a(C.getConfiguration().getLanguage().toLowerCase());f=D.getDateTimeInstance({format:s.format,pattern:s.pattern,style:s.style,calendarType:d},s.locale?new a(s.locale):e);}return f;};c.prototype.isLowerRowTickHourSensitive=function(){var t=this.getTimeLineOption();var u=t.innerInterval.unit;var s=t.innerInterval.span;var S=F.getTimeStampFormatter().parse("20000101000000");var e=O.get(u).offset(S,s);return(e.getTime()-S.getTime())<=60*60*1000;};c.prototype.getAxisTime=function(){return this.getAggregation("_axisTime");};c.prototype.fireRedrawRequest=function(f,r,v,o){this.fireEvent("_redrawRequest",{forceUpdate:f,reasonCode:r,valueBeforeChange:v,originEvent:o});};c.prototype.updateGanttVisibleWidth=function(n){this._nGanttVisibleWidth=n;};c.prototype.getGanttVisibleWidth=function(){return this._nGanttVisibleWidth;};c.prototype.calZoomScale=function(u,s,r){var S=F.getTimeStampFormatter().parse("20000101000000");var e=O.get(u).offset(S,s);return this.calZoomScaleByDate(S,e,r);};c.prototype.calZoomScaleByDate=function(s,e,r){return(e.valueOf()-s.valueOf())/r;};c.prototype.calZoomBase=function(){var B=this.getTimeLineOption()||this.getFinestTimeLineOption();if(B){var s=this.calZoomScale(B.innerInterval.unit,B.innerInterval.span,B.innerInterval.range);this._oZoom={base:{timeLineOption:B,rate:1,scale:s}};return true;}return false;};c.prototype.checkFirstDayOfWeek=function(s){if(typeof s.firstDayOfWeek==="undefined"){s.firstDayOfWeek=b.getInstance(C.getConfiguration().getLocale()).getFirstDayOfWeek();C.attachLocalizationChanged(this._onLocalizationChanged,this);}};c.prototype.updateVisibleHorizonOnMouseWheelZoom=function(t,s,o,S){var z=s<0;var Z=Math.round(Math.abs(s)/100);var m=this.getMouseWheelZoomType();if(m===l.MouseWheelZoomType.FineGranular){this.updateVisibleHorizonOnFineGranularMouseWheelZoom(t,z,Z,o,S);}else if(m===l.MouseWheelZoomType.Stepwise){this.updateVisibleHorizonOnStepWiseMouseWheelZoom(t,z,Z,o,S);}};c.prototype.updateVisibleHorizonOnFineGranularMouseWheelZoom=function(t,z,Z,o,s){var v=this.getVisibleHorizon();var V=F.abapTimestampToDate(v.getStartTime());var d=this.getTimeLineOption();var n=O.get(d.innerInterval.unit).offset(V,Z*d.innerInterval.span).getTime()-V.getTime();var i=z?-1:1;var N=this.calVisibleHorizonByDelta(i*n,t);var r=s?"syncVisibleHorizon":"mouseWheelZoom";this.setVisibleHorizonWithReason(N,r,o);};c.prototype.updateVisibleHorizonOnStepWiseMouseWheelZoom=function(t,z,Z,o,s){var i=z?-1:1;var d=this.getZoomLevel()-i*Z;if(d>-1&&d<this.getZoomLevels()){if(this._aZoomRate[d]&&!U.floatEqual(this._aZoomRate[d],this._oZoom.rate)){this.setZoomLevel(d);}}};c.prototype.calVisibleHorizonByRate=function(n,o){var d=0;if(this._oZoom&&this._oZoom.base&&this._oZoom.base.scale!==undefined&&this._nGanttVisibleWidth!==undefined){var v=F.abapTimestampToDate(this.getVisibleHorizon().getStartTime());var V=F.abapTimestampToDate(this.getVisibleHorizon().getEndTime());var e=V.getTime()-v.getTime();var f=this._oZoom.base.scale/n;var g=this._nGanttVisibleWidth*f;d=g-e;}return this.calVisibleHorizonByDelta(d,o);};c.prototype.calVisibleHorizonByDelta=function(n,o){var v=this.getVisibleHorizon();n=Math.round(n)||0;if(n!==0){var d=F.abapTimestampToDate(v.getStartTime()).getTime();var e=F.abapTimestampToDate(v.getEndTime()).getTime();var f=e-d;var g=0;var h;var i=F.abapTimestampToDate(this.getTotalHorizon().getStartTime()).getTime();var j=F.abapTimestampToDate(this.getTotalHorizon().getEndTime()).getTime();if(n>0&&d<=i){h=0;g=i;}else if(n>0&&e>=j){h=1;g=j;}else{if(!o){g=d+f/2;}else{g=o.getTime();}h=(g-d)/f;}var k=f+n;var m=Math.floor(g-h*k);if(m<=i){m=i;}var p=m+k;if(p>=j){m=m-(j-p);p=j;if(m<=i){m=i;}}return new T({startTime:new Date(m),endTime:new Date(p)});}return v;};c.prototype.calMiddleDate=function(s,e){return new Date(s.getTime()+(e.getTime()-s.getTime())/2);};c.prototype._onLocalizationChanged=function(){this.setFirstDayOfWeek(b.getInstance(C.getConfiguration().getLocale()).getFirstDayOfWeek());};c.prototype._updateZoomControlType=function(z){return null;};return c;},true);
