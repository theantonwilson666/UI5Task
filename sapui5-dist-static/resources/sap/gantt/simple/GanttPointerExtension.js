/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","./GanttExtension","../drawer/CursorLine","./CoordinateUtils","./GanttUtils","sap/ui/core/format/DateFormat","sap/m/Text"],function(q,C,G,a,b,c,D,T){"use strict";var n=".sapGanttPointer";var d="contextmenu"+n;var m=["mouseenter","mouseleave","click","dblclick","mouseup","mousedown"],M=m.map(function(E){return E+n;});var s="mousemove",e=s+n,f=e+" mouseup"+n;var B=m.reduce(function(i,o){i[o]=o;return i;},{});B[s]=s;var g={Forward:"forward",Backward:"backward",Bottom:"bottom",Top:"top"};var h=200;var j=null;var k={addEventListeners:function(o){var E=o._getPointerExtension(),$=q(E.getDomRefs().ganttSvg),i=q(E.getDomRefs().headerSvg);k.removeEventListeners(o);if(j===null){j=c.adhocLinesPresentAndEnabled(o);}M.forEach(function(p){$.on(p,E.onGanttChartMouseEvent.bind(E));if(j){i.on(p,E.onGanttChartMouseEvent.bind(E));}else{i.off(p,E.onGanttChartMouseEvent.bind(E));}});$.on(f,E.onCrossSvgMouseEvent.bind(E));i.on(f,E.onCrossSvgMouseEvent.bind(E));$.on(e,E.updateGanttCursorLine.bind(E));this.bindBackgroundRowEvent($,E);if(j){this.bindBackgroundRowEventHeader(i,E);}else{this.unbindBackgroundRowEventHeader(i);}i.on(B.mousedown+n,function(p){var r=o._getDragDropExtension();if(!r.isEventTargetAdhocLine(p)&&!r.isEventTargetDeltaLine(p)){p.preventDefault();p.stopPropagation();p.stopImmediatePropagation();return false;}});q(document.getElementById(o.getId())).on(e,b.updateCursorPosition);},removeEventListeners:function(o){var E=o._getPointerExtension(),$=q(E.getDomRefs().ganttSvg),i=q(E.getDomRefs().headerSvg);$.off(n);if(j===null){j=c.adhocLinesPresentAndEnabled(o);}if(j){i.on(B.mousedown+n);}else{i.off(B.mousedown+n);}this.unbindBackgroundRowEvent($);},doGanttAutoScroll:function(o,i,E,L){var p=o._getPointerExtension();if(p.iTableAutoScrollTimerId){window.clearTimeout(p.iTableAutoScrollTimerId);p.iTableAutoScrollTimerId=null;}if(p._bAutoScroll){if(!p.allowAutoScroll()){return;}p._toggleCursorLine(false);var r=o._getResizeExtension();if(r.isResizing()){r.onResizing(E);}var t=o._getConnectExtension();if(t.isShapeConnecting()){t.onShapeConnecting(E);}var P=o._getPopoverExtension();P._updatePopoverWhenAutoScroll(E);var z=o._getZoomExtension();z._handleAutoScroll(E);var R=C.getConfiguration().getRTL();var S=30;if(g.Backward===i||g.Top===i){S=(-1)*S;}if(g.Backward===i||g.Forward===i){p._iStep=S;}else{p._iStep=0;}var $=this.getScrollArea(o,i);var u,H=false;if(i===g.Forward||i===g.Backward){u=R?"scrollLeftRTL":"scrollLeft";H=true;}else{u="scrollTop";H=false;}t.storeScrollDistance(S,H);var v=$[u]()+S;$[u](v);var w=$[u]();if(w!==v){t.storeScrollDistance(w-v,H);}if(!(L!==undefined&&L===w)){p.iTableAutoScrollTimerId=window.setTimeout(k.doGanttAutoScroll.bind(k),h,o,i,E,w);}}},getScrollArea:function(o,i){var S;var t=o.getTable();var p=q(t.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar));if(i===g.Forward||i===g.Backward){S=q(document.getElementById(o.getId()+"-hsb"));}else{S=p;}return S;},bindBackgroundRowEvent:function($,E){function o(r){q(r).on(B.mouseenter+n+" "+B.mouseleave+n,function(t){var I=E._getRowIndexFromEvent(t);E.onMouseHover(I,t.type===B.mouseenter);});q(r).on(B.click+n+" "+B.dblclick+n,function(t){E.dispatchGanttClick(t);});q(r).on(d,function(t){E.onGanttChartContextMenu(t);});}var p=$.find("rect.sapGanttBackgroundSVGRow");var L=p.length;for(var i=0;i<L;i++){o(p[i]);}},bindBackgroundRowEventHeader:function($,E){q($[0]).on(B.click+n+" "+B.dblclick+n,function(o){E.dispatchGanttClickHeader(o);});},unbindBackgroundRowEvent:function($){var o=$.find("rect.sapGanttBackgroundSVGRow");var L=o.length;for(var i=0;i<L;i++){q(o[i]).off(n);}},unbindBackgroundRowEventHeader:function($){q($[0]).off(n);}};var l=G.extend("sap.gantt.simple.GanttPointerExtension",{_init:function(o,S){this._oCursorLineDrawer=new a();this.bPreventSingleClick=false;this.iTableAutoScrollTimerId=null;this._iStep=0;return"PointerExtension";},_attachEvents:function(){var o=this.getGantt();k.addEventListeners(o);},_detachEvents:function(){var o=this.getGantt();k.removeEventListeners(o);},destroy:function(){if(this._oCursorLineDrawer){this._oCursorLineDrawer.destroy();}delete this.bPreventSingleClick;}});l.prototype.onGanttChartContextMenu=function(E){E.preventDefault();if(E.target===E.currentTarget){var o=this.getGantt();var i=this._getRowIndexFromEvent(E);var r=o.getTable().getRows()[i];o.fireShapeContextMenu({row:r,pageX:E.pageX,pageY:E.pageY});}};l.prototype.onGanttChartMouseEvent=function(E){this.updateGanttCursorLine(E);if(E.type===B.mousedown){this.oMousedownTargetElement=E.target;}this.onMouseEnterLeaveEvent(E);};l.prototype.onCrossSvgMouseEvent=function(E){var o=this.getGantt();if(E.type===B.mousemove){if(this.needAutoscrollInContainerIfNecessary()){this.updateCursorStyle("move");this.tableAutoScroll(E);}else{var i=o._getDragDropExtension();var p=o._getConnectExtension();var r=o._getResizeExtension();var z=o._getZoomExtension();if((i.isDeltaLineDragging()||i.isAdhocLineDragging()||i.isDragging()||r.isResizing()||p.isShapeConnecting()||z.isTimeZooming())){this.tableAutoScroll(E);}}}if(E.type===B.mouseup){this.oMouseupTargetElement=E.target;this._bAutoScroll=false;}};l.prototype.needAutoscrollInContainerIfNecessary=function(){var o=this.getGantt().getParent();if(o&&o.getGanttCharts){var i=o.getGanttCharts();var p=this.getGantt();return i.some(function(r){return r!==p&&r._getDragDropExtension().isDragging();});}return false;};l.prototype.updateCursorStyle=function(S){document.body.style.cursor=S;this.getDomRefs().ganttSvg.style.cursor=S;};l.prototype.isPointerInGanttChart=function(E){return this._bMouseOnSvg;};l.prototype.onMouseEnterLeaveEvent=function(E){this.updateCursorStyle("default");if(E.type===B.mouseenter){this._bMouseOnSvg=true;}else if(E.type===B.mouseleave){this._bMouseOnSvg=false;}};l.prototype.dispatchGanttClick=function(E){if(this.isEventTargetOnGanttRow(E)===false){return;}if(E.type===B.click){if(this.oMousedownTargetElement===this.oMouseupTargetElement){this.onGanttSingleClick(E);delete this.oMouseupTargetElement;delete this.oMousedownTargetElement;}}else if(E.type===B.dblclick){this.onGanttDoubleClick(E);}};l.prototype.dispatchGanttClickHeader=function(E){if(E.type===B.click){this.onGanttSingleClick(E);delete this.oMouseupTargetElement;delete this.oMousedownTargetElement;}};l.prototype.isEventTargetOnGanttRow=function(E){return q(E.target).hasClass("sapGanttBackgroundSVGRow");};l.prototype._getRowIndexFromEvent=function(E){return parseInt(E.target.getAttribute("data-sap-ui-index"),10);};l.prototype._getRowIndexFromElement=function(E){return parseInt(E.getAttribute("data-sap-ui-index"),10);};l.prototype.onGanttSingleClick=function(E){this.getGantt().getSelection().updateShape(null,{selected:false,ctrl:E.ctrlKey||E.metaKey});var o=this.getGantt();c.resetStrokeDasharray(o);var i=this._getRowIndexFromEvent(E);var r=o.getTable().getRows()[i];if(!r){return;}var p=function(){if(this.bPreventSingleClick===false){this._selectTableRow(o,i);o.fireShapePress({shape:null,row:r});}this.bPreventSingleClick=false;}.bind(this);if(o.getDisableShapeDoubleClickEvent()){this.bPreventSingleClick=false;p();return;}this.iSingleClickTimer=window.setTimeout(p.bind(this),300);};l.prototype.onGanttDoubleClick=function(E){var o=this.getGantt(),i=o.getDisableShapeDoubleClickEvent(),I,r;if(!i){window.clearTimeout(this.iSingleClickTimer);this.bPreventSingleClick=true;}I=this._getRowIndexFromEvent(E);r=o.getTable().getRows()[I];this._selectTableRow(o,I);if(!i){o.fireShapeDoubleClick({shape:null,row:r});}};l.prototype._selectTableRow=function(o,i){var t=this.getGantt().getTable().getSelectionBehavior();var S=sap.ui.table.SelectionBehavior;if(S.Row===t||S.RowOnly===t){o.getSyncedControl().syncRowSelection(i);}};l.prototype.onMouseHover=function(i,H){this.getGantt().getSyncedControl().syncRowHover(i,H);};l.prototype._getAutoScrollStep=function(){if(this._bAutoScroll){return this._iStep;}return 0;};l.prototype.updateGanttCursorLine=function(E){if(this.getGantt().getEnableCursorLine()===false){return;}if(E.type===B.mousemove){var S=b.getEventSVGPoint(this.getDomRefs().ganttSvg,E);this._toggleCursorLine(true,S);}else if(E.type===B.mouseleave){this._toggleCursorLine(false);}};l.prototype._toggleCursorLine=function(S,p){var i=this._getCursorLineDOMs();var o=this.getGantt().getParent();var r=o.isA("sap.gantt.simple.GanttChartContainer")&&o.getEnableStatusBar();if(S){this._oCursorLineDrawer.drawSvg(i.allGanttSvg,i.allHeaderSvg,this.getGantt().getLocale(),p);if(r){this.customBar(o,true,this.getGantt().getAxisTime().viewToTime(p.x));}}else{this._oCursorLineDrawer.destroySvg(i.allGanttSvg,i.allHeaderSvg);if(r){this.customBar(o,false);}}};l.prototype.customBar=function(o,v,t){var _=new T({text:""});var i=D.getInstance({pattern:o.getStatusBarDatePattern()});var p=D.getTimeInstance({pattern:o.getStatusBarTimePattern()});o.msgText.setWidth(v?"70%":"100%");o.dateTimeText.setWidth(v?"30%":"0%");o.dateTimeText.setText(v?i.format(t)+" "+p.format(t):_.getText());};l.prototype._getCursorLineDOMs=function(){return{allHeaderSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartHeaderSvg"),allGanttSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartSvg")};};l.prototype.tableAutoScroll=function(E){this._bAutoScroll=false;if(this.ifAutoScrollToRight()){window.setTimeout(function(){k.doGanttAutoScroll(this.getGantt(),g.Forward,E);}.bind(this),h);}else if(this.ifAutoScrollToLeft()){window.setTimeout(function(){k.doGanttAutoScroll(this.getGantt(),g.Backward,E);}.bind(this),h);}else if(this.ifAutoScrollToDown()){window.setTimeout(function(){k.doGanttAutoScroll(this.getGantt(),g.Bottom,E);}.bind(this),h);}else if(this.ifAutoScrollToUp()){window.setTimeout(function(){k.doGanttAutoScroll(this.getGantt(),g.Top,E);}.bind(this),h);}else{this._bAutoScroll=false;}};l.prototype.ifAutoScrollToRight=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationX>A.oScrollAreaRect.left+A.iScrollAreaWidth-A.iScrollTriggerAreaWidth&&A.iLocationX<A.oScrollAreaRect.left+A.iScrollAreaWidth&&A.iScrollAreaScrollLeft+A.iScrollAreaWidth<A.oScrollArea.scrollWidth;return this._bAutoScroll;};l.prototype.ifAutoScrollToLeft=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationX<A.oScrollAreaRect.left+A.iScrollTriggerAreaWidth&&A.iLocationX>A.oScrollAreaRect.left&&A.iScrollAreaScrollLeft>0;return this._bAutoScroll;};l.prototype.ifAutoScrollToDown=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationY>A.oVisibleScrollAreaRect.top+A.iVisibleScrollAreaHeight-A.iScrollTriggerAreaHeight&&A.iLocationY<A.oVisibleScrollAreaRect.top+A.iVisibleScrollAreaHeight&&A.iScrollAreaScrollTop+A.iScrollAreaHeight-A.iBaseRowHeight<=A.iScrollHeight;return this._bAutoScroll;};l.prototype.ifAutoScrollToUp=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationY<A.oVisibleScrollAreaRect.top+A.iScrollTriggerAreaHeight&&A.iLocationY>A.oVisibleScrollAreaRect.top;return this._bAutoScroll;};l.prototype.getAutoScrollPosition=function(){var r=C.getConfiguration().getRTL();var t=this.getGantt().getTable();var i=10,o=10,p=document.getElementById(this.getGantt().getId()+"-gantt"),S=q(p),u=p.getBoundingClientRect(),v=S.outerWidth(),w=S.outerHeight(),x=u,y=w,z=this.getGantt()._oExpandModel.getBaseRowHeight(),A=r?S.scrollLeftRTL():S.scrollLeft();var $=q(t.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar)),E=$.scrollTop(),F=$.get(0).scrollHeight;var H=b.getLatestCursorPosition().pageX,I=b.getLatestCursorPosition().pageY;return{iLocationX:H,iLocationY:I,oScrollAreaRect:u,oScrollArea:p,iScrollAreaWidth:v,iScrollTriggerAreaWidth:i,iScrollTriggerAreaHeight:o,iScrollAreaScrollLeft:A,oVisibleScrollAreaRect:x,iVisibleScrollAreaHeight:y,iScrollAreaScrollTop:E,iBaseRowHeight:z,iScrollHeight:F,iScrollAreaHeight:w};};l.prototype.allowAutoScroll=function(){return this.ifAutoScrollToRight()||this.ifAutoScrollToLeft()||this.ifAutoScrollToDown()||this.ifAutoScrollToUp();};return l;});
