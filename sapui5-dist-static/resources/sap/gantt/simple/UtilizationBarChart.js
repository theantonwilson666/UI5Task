/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./UtilizationChart","./BaseRectangle"],function(q,U,B){"use strict";var a=U.extend("sap.gantt.simple.UtilizationBarChart",{metadata:{library:"sap.gantt",properties:{consumptionColor:{type:"sap.gantt.ValueSVGPaintServer",defaultValue:"lightgray"}},defaultAggregation:"periods",aggregations:{periods:{type:"sap.gantt.simple.UtilizationPeriod",group:"Data"}}},renderer:{apiVersion:2}});a.prototype.applySettings=function(s,S){s=s||{};s.remainCapacityColor=s.remainCapacityColor||"#fff";U.prototype.applySettings.call(this,s,S);this._createDefaultDefs();};a.prototype.renderElement=function(r,e){r.openStart("g",this);r.class("sapGanttUtilizationBar");r.openEnd();var x=this.getX(),h=this.getHeight(),y=this.getRowYCenter()-(h/2),w=this.getWidth();var p={x:x,y:y,width:w,height:h};this.renderBackgroundDefs(r);this.renderUBCBackground(r,p);var f=this.filterPeriods();if(f.length>0){this._iMaxAllowedSupply=this._getMaxAllowedSupply(f);this.renderOverConsumptionPolygon(r,p,f);this.renderRemainConsumptionPolygon(r,p,f);this.renderConsumptionPolygon(r,p,f);this.renderConsumptionPath(r,p,f);this.renderTooltips(r,p,f);}r.close("g");};a.prototype.filterPeriods=function(){var A=this.getPeriods();var g=this.getGanttChartBase(),t=g.getRenderedTimeRange(),m=t[0],M=t[1];return A.filter(function(i,I,b){var f=I===0||I===b.length-1;if(f){return true;}else{return i.getFrom()>=m&&i.getFrom()<=M;}});};a.prototype.renderUBCBackground=function(r,p){var f=this.getFill();if(!f){f="url(#"+this.getId()+"-defaultBgPattern)";}var A=q.extend({id:this.getId()+"-ubcBg",fill:f},p);this.renderRectangleWithAttributes(r,A);};a.prototype.renderOverConsumptionPolygon=function(r,p,f){r.openStart("polygon",this.getId()+"-ubcOCP");r.attr("points",this.getPolygonPoints(p,function(i,m){var R=p.height,M=p.y+R;return M-((i.getDemand()/m)*R);},f));r.attr("fill",this.getOverConsumptionColor());r.openEnd();r.close("polygon");};a.prototype.renderConsumptionPath=function(r,p,f){r.openStart("path",this.getId()+"-ubcPath");r.attr("d",this.getDemandPathD(p,f));r.attr("fill","none");r.attr("stroke",this.getStroke()||"#000");r.attr("stroke-width",this.getStrokeWidth()||2);r.openEnd();r.close("path");};a.prototype.renderRemainConsumptionPolygon=function(r,p,f){r.openStart("polygon",this.getId()+"-ubcRCP");r.attr("points",this.getPolygonPoints(p,function(i,m){var R=p.height,M=p.y+R;return M-((i.getSupply()/m)*R);},f));r.attr("fill",this.getRemainCapacityColor());r.openEnd();r.close("polygon");};a.prototype.renderConsumptionPolygon=function(r,p,f){r.openStart("polygon",this.getId()+"-ubcCP");r.attr("points",this.getPolygonPoints(p,function(i,m){var R=p.height,M=p.y+R;var v=Math.min(i.getDemand(),i.getSupply());return M-((v/m)*R);},f));r.attr("fill",this.getConsumptionColor());r.openEnd();r.close("polygon");};a.prototype.renderTooltips=function(r,p,f){var t=[];r.openStart("g");r.class("ubc-tooltips").openEnd();for(var i=0;i<f.length;i++){var I=f[i];var n=f[i+1];if(n){var x=this.toX(I.getFrom()),X=this.toX(n.getFrom());t.push(new B({x:parseFloat(x),y:p.y,height:p.height,width:Math.abs(X-x),fill:"transparent",tooltip:I.getTooltip()}).setProperty("childElement",true));}}t.forEach(function(R){R.renderElement(r,R);});r.close("g");};a.prototype._getMaxAllowedSupply=function(f){var m=Math.max.apply(null,f.map(function(i){return i.getSupply();}));var M=m*this.getOverConsumptionMargin()/100;return m+M;};a.prototype.getPolygonPoints=function(p,c,f){var m=p.y+p.height;var P=function(x,y){return[x,y].join(",")+" ";};var r="";for(var i=0;i<f.length;i++){var I=f[i],F=i===0,l=i===f.length-1,n=f[l?f.length-1:i+1];var s=this.toX(I.getFrom()),e=this.toX(n.getFrom());if(F){r+=P(s,m);}var C=c(I,this._iMaxAllowedSupply);C=C.toFixed(1);r+=P(s,C);r+=P(e,C);if(l){r+=P(s,C);r+=P(s,m);}}return r;};a.prototype.getDemandPathD=function(p,f){var r="";for(var i=0;i<f.length;i++){var I=f[i],l=i===f.length-1,n=f[l?f.length-1:i+1];var x=this.toX(I.getFrom()),b=this.toX(n.getFrom());var y=this.toY(I.getDemand(),p),c=this.toY(n.getDemand(),p);r+=" M "+x+" "+y+" L "+b+" "+y;r+=" M "+b+" "+y+" L "+b+" "+c;}return r;};a.prototype.toY=function(d,p){var s=p.y,r=p.height,m=s+r;var y=m-((d/this._iMaxAllowedSupply)*r);y=y<s?s:y;return parseFloat(y.toFixed(1));};a.prototype._createDefaultDefs=function(){if(this.getFill()){return;}this.mDefaultDefs=new sap.gantt.def.SvgDefs({defs:[new sap.gantt.def.pattern.BackSlashPattern({id:this.getId()+"-defaultBgPattern",tileWidth:5,tileHeight:9,backgroundColor:"#fff",stroke:"#ececec",strokeWidth:1})]});};a.prototype.renderBackgroundDefs=function(r){if(this.getFill()==null&&this.mDefaultDefs){r.unsafeHtml(this.mDefaultDefs.getDefString());}};return a;},true);
