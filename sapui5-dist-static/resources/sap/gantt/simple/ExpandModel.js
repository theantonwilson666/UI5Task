/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/assert","sap/ui/base/ManagedObject","./AggregationUtils","./GanttUtils"],function(q,a,M,A,G){"use strict";var E=M.extend("sap.gantt.simple.ExpandModel",{metadata:{properties:{baseRowHeight:{type:"int",group:"Appearance",defaultValue:null}}},constructor:function(){M.apply(this,arguments);this.mExpanded={};}});E.prototype.isTableRowHeightNeedChange=function(e,t,s,p,o){var b=false;var f=t.getFirstVisibleRow();var S=o.getKey();for(var i=0;i<s.length;i++){var c=s[i];var d=f>c;if(d){break;}var r=G.getSelectedTableRowSettings(t,c);if(r==null){break;}var g=r.getAllExpandableShapes();var l=[];var C=[];var h=[];var j=[];g.forEach(function(k){if(k.mBindingInfos.hasOwnProperty("subTasks")){k._isSubTasks=true;C=A.getLazyElementsByScheme(k,S);h=h.concat(C);}else{k._isSubTasks=false;C=A.getLazyElementsByScheme(k,S);j=G.calculateLevelForShapes(C,"time","endTime");l.push(j.maxLevel);}});if(h.length!==0){j=G.calculateLevelForShapes(h,"time","endTime");l.push(j.maxLevel);}j=G.calculateLevelForShapes(h,"time","endTime");l.push(j.maxLevel);var m=Math.max.apply(null,l);if(m>0){this.toggle(e,r,p,o,m);b=true;}}return b;};E.prototype.refreshRowYAxis=function(t){if(this.hasExpandedRows()===false){return;}var g=t.getParent();var r=t.getRows();var R=t.getParent().getTableRowHeights();var f=0;for(var i=0;i<r.length;i++){var o=r[i],b=o.getAggregation("_settings"),s=b.getRowUid();f+=(R[i-1]||0);if(!this.isRowExpanded(s)){continue;}var c=this.getBaseRowHeight();if(g.getExpandedRowHeight()){c=g.getExpandedRowHeight();}this.calcExpandRowYAxis({uid:b.getRowUid(),rowIndex:i,rowY:f,baseRowHeight:c,allRowHeights:R});}return this.getBaseRowHeight();};E.prototype.toggle=function(e,r,m,o,i){if(e){this.expand(r,m,o,i);}else{this.collapse(r,o);}};E.prototype.expand=function(r,m,e,i){a(typeof i==="number","iMaxNumberOfDetails must be a number");var u=r.getRowUid(),s=m.getKey(),b=m.getRowSpan();var c=e.getKey(),d=e.getRowSpan();var I=this.mExpanded[u];if(!I||I.length===0){this.mExpanded[u]=[{scheme:s,metadata:{rowSpan:b,main:true}}];}if(!this.hasExpandScheme(u,c)){this.mExpanded[u].push({scheme:c,metadata:{numberOfRows:i,rowSpan:d}});}this.updateVisibleRowSpan(u);};E.prototype.collapse=function(r,e){var u=r.getRowUid();if(u&&this.mExpanded[u]==null){return;}var s=e.getKey();var i=this.mExpanded[u];for(var I=0;I<i.length;I++){var o=i[I];if(o.scheme===s){i.splice(I,1);}if(this.hasNoExpandRows(u)){delete this.mExpanded[u];break;}else{this.updateVisibleRowSpan(u);}}};E.prototype.hasExpandScheme=function(u,s){return this.mExpanded[u].filter(function(i){return i.scheme===s;}).length>0;};E.prototype.hasExpandedRows=function(){return!q.isEmptyObject(this.mExpanded);};E.prototype.isRowExpanded=function(u){return!this.hasNoExpandRows(u);};E.prototype.hasNoExpandRows=function(u){var i=this.mExpanded[u]||[];return i.every(function(I){return I.metadata.main;});};E.prototype.updateVisibleRowSpan=function(u){var i=this.mExpanded[u]||[];var m,o,n=0;for(var I=0;I<i.length;I++){var b=i[I];var k=b.scheme;var v=b.metadata;if(v.main){m=k;o=v;}else{n=v.rowSpan*(v.numberOfRows||1);}}o.numberOfSubRows=n;this.mExpanded[u][0]={scheme:m,metadata:o};};E.prototype.getMainRowScheme=function(u){var i=this.mExpanded[u]||[];return i.filter(function(I){return I.metadata.main;}).map(function(m){return{key:m.scheme,value:m.metadata};})[0];};E.prototype.getExpandSchemeKeys=function(u){var i=this.mExpanded[u]||[];return i.filter(function(I){return!I.metadata.main;}).map(function(I){return I.scheme;});};E.prototype.getCalculatedRowHeight=function(r,b,t){var R=b;var g=t.getParent(),e=g.getExpandedRowHeight(),s=g.getShowParentRowOnExpand();if(this.hasExpandedRows()){var u=r.getRowUid();if(!u){return R;}var i=this.mExpanded[u];if(i){var m=this.getMainRowScheme(u);if(!e){R=s?(b*(m.value.rowSpan+m.value.numberOfSubRows)):(b*(m.value.numberOfSubRows));}else{if(!s){if(e<b&&m.value.numberOfSubRows===1){R=m.value.numberOfSubRows*b;}else{R=m.value.numberOfSubRows*e;}}else{R=(b*m.value.rowSpan)+(m.value.numberOfSubRows*e);}}}}return R;};E.prototype.getRowHeightByIndex=function(t,i,T){if(t==null){return T;}var r=t.getRows(),R=r[i].getAggregation("_settings");return this.getCalculatedRowHeight(R,T,t);};E.prototype.calcExpandRowYAxis=function(p){var u=p.uid,b=p.baseRowHeight;var f=p.rowY;var o,s,e=[];var c=[];var I=this.mExpanded[u];if(q.isEmptyObject(I)){return;}for(var d=0;d<I.length;d++){var g=I[d],k=g.scheme,v=g.metadata;if(v.main){o=v;s=k;}else{c.push(v);e.push(k);}}var h=o?o.rowSpan:1;var l={};l[s]=[h];var r=[l];for(var i=0;i<c.length;i++){var t=c[i],R=t.rowSpan,w=t.numberOfRows;var S=[];for(var j=0;j<w;j++){S.push(R);}l={};l[e[i]]=S;r.push(l);}var x=f;for(var m=0;m<r.length;m++){var y=r[m],z=Object.keys(y)[0],B=y[z];if(m===0){this._updateRowYAxis(u,z,{rowYAxis:[x].slice()});}else{var C=[];if(B.length===1){C.push(x+this.getBaseRowHeight());x+=(B[0]*b);}else{for(var n=0;n<B.length;n++){if(n===0){if(this.getBaseRowHeight()!==b){x=x+(B[n]*this.getBaseRowHeight());}else{x=x+(B[n]*b);}}else{x=x+(B[n]*b);}C.push(x);}}this._updateRowYAxis(u,z,{rowYAxis:C.slice()});}}};E.prototype._updateRowYAxis=function(u,s,v){var r=v.rowYAxis;var i=this.mExpanded[u]||[];for(var I=0;I<i.length;I++){var o=i[I];if(o.scheme===s){o.metadata.yAxis=r;break;}}};E.prototype.getRowYCenterByUid=function(u,m,s,e,g){var r=this.isRowExpanded(u);if(r===false){return m;}var I=this.mExpanded[u],S=s||this.getMainRowScheme(u).key;for(var b=0;b<I.length;b++){var o=I[b];if(o.scheme===S){var y=o.metadata.yAxis,c=g.getShowParentRowOnExpand(),d=g.getExpandedRowHeight(),B=this.getBaseRowHeight();if(d&&!o.metadata.main){if(y.length===1&&d<B&&!c){B=this.getBaseRowHeight();}else{B=d;}}var f=B*o.metadata.rowSpan;var R=y.map(function(v){return v+(f/2);});var i=e===undefined?0:e;return R[i];}}};E.prototype.getExpandShapeHeightByUid=function(u,s,f){var i=this.mExpanded[u];var F=i.filter(function(I){return I.scheme===s;})[0];return F?F.metadata.rowSpan*this.getBaseRowHeight():f;};E.prototype.intersectRows=function(l,r){return q.grep(l,function(L){return q.inArray(L,r)>-1;});};E.prototype.collectExpandedBgData=function(r,e,s){var I=this.intersectRows(r,Object.keys(this.mExpanded));if(q.isEmptyObject(this.mExpanded)||q.isEmptyObject(r)||q.isEmptyObject(I)){return[];}var R=this.getBaseRowHeight();var b=[];for(var c=0;c<I.length;c++){var u=I[c],d=this.mExpanded[u]||[];for(var i=0;i<d.length;i++){var o=d[i],y=o.metadata.yAxis||[],m=o.metadata.main;if(!m){var S=[];if(e){if(y.length===1&&!s&&(e<this.getBaseRowHeight())){R=this.getBaseRowHeight();}else{R=e;}}y.forEach(function(Y){S.push({x:0,y:Y,rowUid:u,rowHeight:R*o.metadata.rowSpan});});b.push(S);}}}return b;};return E;},true);
