/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/ui/Device","sap/ui/core/Core","sap/gantt/library","sap/ui/core/Element","sap/ui/core/CustomStyleClassSupport","sap/ui/base/ManagedObjectMetadata","./GanttUtils","./CoordinateUtils","./AggregationUtils","../misc/Format"],function(L,D,C,l,E,a,M,G,b,A,F){"use strict";var v=l.simple.verticalTextAlignment;var h=l.simple.horizontalTextAlignment;var B=E.extend("sap.gantt.simple.BaseShape",{metadata:{library:"sap.gantt","abstract":true,properties:{shapeId:{type:"string"},time:{type:"object"},endTime:{type:"object"},scheme:{type:"string",defaultValue:null},xBias:{type:"float",defaultValue:0},yBias:{type:"float",defaultValue:0},fill:{type:"sap.gantt.ValueSVGPaintServer"},strokeOpacity:{type:"float",defaultValue:1.0},fillOpacity:{type:"float",defaultValue:1.0},opacity:{type:"float",defaultValue:1.0},stroke:{type:"sap.gantt.ValueSVGPaintServer"},strokeWidth:{type:"float",defaultValue:0},strokeDasharray:{type:"string"},transform:{type:"string"},filter:{type:"string"},expandable:{type:"boolean",defaultValue:false},selectable:{type:"boolean",defaultValue:false},selected:{type:"boolean",defaultValue:false},draggable:{type:"boolean",defaultValue:false},resizable:{type:"boolean",defaultValue:false},hoverable:{type:"boolean",defaultValue:false},connectable:{type:"boolean",defaultValue:false},rowYCenter:{type:"float"},countInBirdEye:{type:"boolean",defaultValue:false},childElement:{type:"boolean",defaultValue:false,visibility:"hidden"},shapeUid:{type:"string",visibility:"hidden"},visible:{type:"boolean",defaultValue:true},title:{type:"string",group:"Appearance",defaultValue:null},showTitle:{type:"boolean",group:"Appearance",defaultValue:true},enableChainSelection:{type:"boolean",defaultValue:false},selectableInChainSelection:{type:"boolean",defaultValue:true},verticalTextAlignment:{type:"sap.gantt.simple.verticalTextAlignment",defaultValue:v.Center},horizontalTextAlignment:{type:"sap.gantt.simple.horizontalTextAlignment",defaultValue:h.Start},animationSettings:{type:"object",defaultValue:null},showAnimation:{type:"boolean",defaultValue:false}}},renderer:{apiVersion:2}});var d={values:null,duration:"1s",repeatCount:"indefinite"};a.apply(B.prototype);B.prototype.init=function(){this.bPreventSingleClick=false;this._level=null;};var V={};C.attachThemeChanged(function(){V={};});var R=/translate\((-?\d{1,}),?\s?(-?\d{1,})?\)/gi;B.prototype.setShapeUid=function(u){L.error("The control manages the shapeUid generation. The method \"setShapeUid\" cannot be used programmatically!",this);};B.prototype.getTransform=function(){var t=this.getProperty("transform");if(t){return t;}return this._buildTransformByXYBias();};B.prototype.setTransform=function(s){this.setProperty("transform",s);this._updateBiasFromTransform(s);return this;};B.prototype._buildTransformByXYBias=function(){var n=this.getXBias(),c=this.getYBias();if(n||c){n=n?n:0;n=C.getConfiguration().getRTL()?-n:n;c=c?c:0;return"translate("+n+" "+c+")";}return null;};B.prototype._updateBiasFromTransform=function(t){if(t!=null){var c=this._parseBias(t);if(c.length>0){var n=c[0]||0,N=c[1]||0;this.setProperty("xBias",n,true);this.setProperty("yBias",N,true);}}};B.prototype._parseBias=function(t){var m=R.exec(t);var c=[];if(m&&m.length>0){m.forEach(function(e,i){if(i!==0&&e){c.push(parseFloat(e));}});}return c;};B.prototype.getStyle=function(){var s={"stroke":this.determineValueColor(this.getStroke()),"stroke-width":this.getStrokeWidth()};var i=this.getSelectable()||this.getHoverable();if(this.getProperty("childElement")===false&&i===false){s["pointer-events"]="none";}return this.getInlineStyle(s);};B.prototype.getXByTime=function(t){var o=this.getAxisTime();var n=o.timeToView(F.abapTimestampToDate(t));if(!jQuery.isNumeric(n)){L.warning("Cannot convert time:"+t+" to an valid coordinate. Invalid coordinate might not get rendered at all, check the property value!");return 0;}return n;};B.prototype.getAxisTime=function(){if(this.mAxisTime){return this.mAxisTime;}else{var g=this.getGanttChartBase();return g?g.getAxisTime():null;}};B.prototype.getGanttChartBase=function(){var r=this.getParentRowSettings();return r?r.getParentGantt():null;};B.prototype.getParentRowSettings=function(){return A.getParentControlOf("sap.gantt.simple.GanttRowSettings",this);};B.prototype.getInlineStyle=function(s){return Object.keys(s).reduce(function(i,c){if(s[c]!==undefined&&s[c]!==null&&s[c]!==""){i+=(c+":"+s[c]+"; ");}return i;},"");};B.prototype.determineValueColor=function(p){var f=V[p];if(!f&&p){f=l.ValueSVGPaintServer.normalize(p);V[p]=f;}return f;};B.prototype.destroy=function(){return E.prototype.destroy.apply(this,["KeepDom"]);};B.prototype.isVisible=function(){return false;};B.prototype.renderElement=function(r,e){};B.prototype.writeElementData=function(r,e,c){if(this.getProperty("childElement")){var g=M.isGeneratedId(this.getId());if(!g){r.openStart(e,this.getId());}else{r.openStart(e);}if(c){r.class("baseShapeSelection");}return;}if(this._shallWriteElementData(this)){r.openStart(e,this);if(this.getShapeId()){r.attr(G.SHAPE_ID_DATASET_KEY,this.getShapeId());}if(this.getConnectable()){r.attr(G.CONNECTABLE_DATASET_KEY,this.getConnectable());}}else{r.openStart(e);}if(c){r.class("baseShapeSelection");}};B.prototype._shallWriteElementData=function(s){var S=s.getParent()===null;if(S===false){S=A.isParentRowSetting(s);}if(S===false){S=A.isAdhocLine(s);}if(S===false){S=A.isDeltaLine(s);}if(S===false){S=A.isLazyAggregation(s);}return S;};B.prototype.ensureGanttChart=function(){if(!this.mChartInstance){this.mChartInstance=this.getGanttChartBase();}};B.prototype.setSelected=function(s,S){var p=this.getSelected();this.setProperty("selected",s,S);var g=this.getGanttChartBase(),c=this.getShapeUid();if(p!==s&&g&&c){g.getSelection().updateShape(c,{selected:s,ctrl:false,draggable:this.getDraggable(),time:this.getTime(),endTime:this.getEndTime()});}return this;};B.prototype.onclick=function(e){var c=function(){var g;if(this.bPreventSingleClick===false){g=this.getGanttChartBase();G.resetStrokeDasharray(g);if(!g.fireShapePress({popoverOffsetX:this._getPopoverOffsetX(e),rowSettings:this.getParentRowSettings(),shape:this,ctrlOrMeta:e.ctrlKey||e.metaKey})){return;}if(!g.hasListeners('shapePress')){g.handleShapePress({shape:this,ctrlOrMeta:e.ctrlKey||e.metaKey});}e.setMarked();}this.bPreventSingleClick=false;}.bind(this);if(!this.getSelectable()){return;}if(this._isDoubleClickEventDisabled()){c();return;}this.iSingleClickTimer=window.setTimeout(c.bind(this),300);};B.prototype.ondblclick=function(e){if(this._isDoubleClickEventDisabled()){return;}window.clearTimeout(this.iSingleClickTimer);this.bPreventSingleClick=true;this.getGanttChartBase().fireShapeDoubleClick({popoverOffsetX:this._getPopoverOffsetX(e),rowSettings:this.getParentRowSettings(),shape:this});e.stopImmediatePropagation();};B.prototype.oncontextmenu=function(e){e.preventDefault();e.stopImmediatePropagation();var c=b.getLatestCursorPosition();this.getGanttChartBase().fireShapeContextMenu({pageX:c.pageX,pageY:c.pageY,popoverOffsetX:this._getPopoverOffsetX(e),rowSettings:this.getParentRowSettings(),shape:this});};B.prototype.onmouseout=function(e){if(this.getHoverable()===false){return;}var g=this.getGanttChartBase();this.iMouseOutTimer=window.setTimeout(function(){if(this.bShapeMouseEnterFired){this.getGanttChartBase().fireShapeMouseLeave({shape:this});g.handleShapeMouseLeave({shape:this});this.bShapeMouseEnterFired=false;}window.clearTimeout(this.iMouseOutTimer);}.bind(this),500);};B.prototype.onmouseover=function(e){if(this.getHoverable()===false){return;}var g=this.getGanttChartBase();this.iMouseOverTimer=window.setTimeout(function(){var c=b.getCursorElement();if(c===this){var m=b.getLatestCursorPosition();this.getGanttChartBase().fireShapeMouseEnter({shape:this,pageX:m.pageX,pageY:m.pageY});this.bShapeMouseEnterFired=true;g.handleShapeMouseEnter({shape:this});}window.clearTimeout(this.iMouseOverTimer);}.bind(this),500);};B.prototype.getShapeUid=function(){return this.getProperty("shapeUid");};B.prototype._getPopoverOffsetX=function(e){if(this.getTime()){var s=this.getDomRef().getBoundingClientRect().width;var S=typeof this.getX==="function"?this.getX():G.getValueX(this);var i=this.getEndTime()?this.getEndTime().getTime():this.getAxisTime().viewToTime(S+s).getTime();var m=new Date((this.getTime().getTime()+i)/2);var c=D.browser.mozilla?e.originalEvent.layerX:e.offsetX;var r=Math.round(c-this.getAxisTime().timeToView(m));return Math.abs(r)>s?0:r;}};B.prototype._isDoubleClickEventDisabled=function(){var g=this.getGanttChartBase();return g&&g.getDisableShapeDoubleClickEvent();};B.prototype.getAnimationProperties=function(c){if(!this.mAnimationProperties){if(jQuery.isEmptyObject(c)||!c.values){return false;}var m=jQuery.extend(true,{},d);for(var s in m){if(c[s]){m[s]=c[s];}}this.mAnimationProperties=m;}return this.mAnimationProperties;};return B;},true);
