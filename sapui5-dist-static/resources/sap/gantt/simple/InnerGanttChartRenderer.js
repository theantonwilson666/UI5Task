/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/Device","sap/ui/core/Core","sap/gantt/simple/BaseLine","sap/gantt/simple/RenderUtils","sap/gantt/simple/GanttExtension","sap/gantt/simple/Relationship","sap/gantt/misc/Format","sap/gantt/misc/Utility","sap/gantt/library","sap/m/Toolbar",'./GanttUtils',"./AdhocLineRenderer","sap/gantt/simple/DeltaLineRenderer"],function(D,C,B,R,G,a,F,U,l,T,b,A,c){"use strict";var I={apiVersion:2};var o=l.AdhocLineLayer;var e=l.DeltaLineLayer;I.render=function(r,d){var g=d.getParent();this.renderGanttChart(r,g);g.getSyncedControl().scrollContentIfNecessary();};I.renderGanttChart=function(r,g){r.openStart("div",g.getId()+"-cnt");r.class("sapGanttChartCnt");r.style("height","100%");r.style("width","100%");r.openEnd();this.rerenderAllShapes(r,g);r.close("div");};I.renderImmediately=function(g){var r=C.createRenderManager();this.renderGanttChart(r,g);var d=window.document.getElementById(g.getId()+"-cnt");r.flush(d,true,false);this.renderRelationships(r,g);g._updateShapeSelections(g.getSelectedShapeUid(),[]);G.attachEvents(g);r.destroy();};I.rerenderAllShapes=function(r,g){var d=g.getSyncedControl().getRowStates();if(d.length===0){return;}g.getAggregation("_header").renderElement();if(g._getScrollExtension&&g._getScrollExtension.mOffsetWidth){g._getScrollExtension().scrollGanttChartToVisibleHorizon();}var s=g.getSimpleAdhocLines().filter(function(n){return n.MarkerType!=sap.gantt.simple.MarkerType.None;});var f=g.getDeltaLines();if(s.length>0||f.length>0){var t=g.getAggregation("table");b.addToolbarToTable(this,t,false);}var i=d.reduce(function(n,p){return n+p.height;},0);r.openStart("svg",g.getId()+"-svg");r.class("sapGanttChartSvg");r.attr("height",i+"px");var h=R.getGanttRenderWidth(g);r.attr("width",h+"px");r.openEnd();this.renderHelperDefs(r,g.getId());this.renderGanttBackgrounds(r,g,d);var j=R.createOrderedListOfRenderFunctionsFromTemplate(this.createTemplateForChartAreaOfDeltaLines(g));j.forEach(function(n){n.apply(I,[r,g]);});this.renderGanttRowBorders(r,g,d);var k=R.createOrderedListOfRenderFunctionsFromTemplate(this.createTemplateForRenderAdhocAndDeltaLines(g));k.forEach(function(n){n.apply(I,[r,g]);});this.renderCalendarPattern(r,g);this.renderCalendarShapes(r,g);this.renderExpandedRowBackground(r,g);this.renderVerticalLines(r,g);this.renderNowLineBody(r,g);var m=R.createOrderedListOfRenderFunctionsFromTemplate(this.createTemplateForOrderedListOfRenderFunctions(g));m.forEach(function(n){n.apply(I,[r,g]);});r.close("svg");if(!g._bPreventInitialRender){g._bPreventInitialRender=true;}};I.createTemplateForRenderAdhocAndDeltaLines=function(g){var t=[];if(g.getEnableAdhocLine()){t.push({fnCallback:this.renderAdhocLines,bUnshift:g.getAdhocLineLayer()===o.Bottom});}if(g.getEnableDeltaLine()){t.push({fnCallback:this.renderDeltaLines,bUnshift:g.getDeltaLineLayer()===e.Bottom});}return t;};I.createTemplateForChartAreaOfDeltaLines=function(g){var t=[];if(g.getEnableDeltaLine()){t.push({fnCallback:this.renderChartAreaOfDeltaLines,bUnshift:g.getDeltaLineLayer()===e.Bottom});}return t;};I.createTemplateForOrderedListOfRenderFunctions=function(g){var t=[{fnCallback:this.renderAllShapesInRows},{fnCallback:this.renderRlsContainer,bUnshift:g.getShapeOverRelationship()},{fnCallback:this.renderAssistedContainer}];return t;};I.renderHelperDefs=function(r,i){r.openStart("defs").openEnd();var L=i+"-helperDef-linePattern";r.openStart("pattern",L);r.attr("width",2);r.attr("height",2);r.attr("x",0);r.attr("y",0);r.attr("patternUnits","userSpaceOnUse");r.openEnd();r.openStart("line");r.attr("x1",1);r.attr("x2",1);r.attr("y1",0);r.attr("y2",2);r.attr("stroke-width",1);r.attr("stroke","white");r.attr("shape-rendering","crispEdges");r.openEnd();r.close("line");r.close("pattern");r.close("defs");};I.renderGanttRowBorders=function(r,g,d){r.openStart("g",g.getId()+"-bg");r.openEnd();this.renderRowBorders(r,g,d);r.close("g");};I.renderGanttBackgrounds=function(r,g,d){r.openStart("g",g.getId()+"-bg");r.openEnd();this.renderRowBackgrounds(r,g,d);r.close("g");};I.renderRowBackgrounds=function(r,g,d){var n=0;r.openStart("g",g.getId()+"-rowBackgrounds");r.class("rowBackgrounds");r.openEnd();d.forEach(function(f,i){r.openStart("rect",g.getId()+"-bgRow-"+i);r.attr("y",n);r.attr("width","100%");r.attr("height",f.height);r.attr("data-sap-ui-index",i);r.class("sapGanttBackgroundSVGRow");if(f.selected){r.class("sapGanttBackgroundSVGRowSelected");}if(f.hovered){r.class("sapGanttBackgroundSVGRowHovered");}r.openEnd().close("rect");n+=f.height;});r.close("g");};I.renderRowBorders=function(r,g,d){r.openStart("g",g.getId()+"-rowBorders");r.class("rowBorders");r.openEnd();var n=0;d.forEach(function(f,i){var h=(n+f.height)-0.5;r.openStart("line",g.getId()+"-bgRowBorder-"+i);r.attr("x1",0);r.attr("x2","100%");r.attr("y1",h);r.attr("y2",h);r.style("pointer-events","none");r.class("sapGanttBackgroundSVGRowBorder");r.openEnd().close("line");n+=f.height;});r.close("g");};I.renderAdhocLines=function(r,g){var d=g.getSimpleAdhocLines();var t=g.getRenderedTimeRange(),m=t[0],M=t[1];d=d.filter(function(v){var i=F.abapTimestampToDate(v.getTimeStamp());return i>=m&&i<=M&&v.getProperty("visible");});var f=g.getAdhocLines();f=f.filter(function(v){var i=sap.gantt.misc.Format.abapTimestampToDate(v.getTimeStamp());return i>=m&&i<=M;});if(f.length===0&&d.length===0){return;}var h=g.getAxisTime();r.openStart("g");r.class("sapGanttChartAdhocLine");r.openEnd();d.forEach(function(i){A.renderLine(r,i,g);});f.map(function(i){var x=h.timeToView(F.abapTimestampToDate(i.getTimeStamp()));return new B({x1:x,y1:0,x2:x,y2:"100%",stroke:i.getStroke(),strokeWidth:i.getStrokeWidth(),strokeDasharray:i.getStrokeDasharray(),strokeOpacity:i.getStrokeOpacity(),tooltip:i.getDescription()}).setProperty("childElement",true);}).forEach(function(L){L.renderElement(r,L);});r.close("g");};I.renderDeltaLines=function(r,g){var d=g.getDeltaLines();d=d.filter(function(v){return v.getVisible();});if(d.length===0){return;}r.openStart("g");r.class("sapGanttChartDeltaLine");r.openEnd();d.forEach(function(f){c.renderDeltaLines(r,f,g);});r.close("g");};I.renderChartAreaOfDeltaLines=function(r,g){var d=g.getDeltaLines();d=d.filter(function(v){return v.getVisible();});if(d.length===0){return;}r.openStart("g");r.class("sapGanttChartDeltaLine");r.openEnd();d.forEach(function(f){c.renderChartAreaOfDeltaLines(r,f,g);});r.close("g");};I.renderVerticalLines=function(r,g){if(g.getEnableVerticalLine()){var d=R.getGanttRenderWidth(g),f=jQuery(document.getElementById(g.getId())).height(),h=g.getAxisTime();var z=h.getZoomStrategy();var t=h.getTickTimeIntervalLabel(z.getTimeLineOption(),null,[0,d]);var j=t[1];var p="";for(var i=0;i<j.length;i++){p+=" M"+" "+(j[i].value-1/2)+" 0"+" v "+f;}if(p){r.openStart("path");r.class("sapGanttChartVerticalLine");r.attr("d",p);r.openEnd().close("path");}}};I.renderAssistedContainer=function(r,g){r.openStart("g");r.class("sapGanttChartSelection");r.openEnd().close("g");r.openStart("g");r.class("sapGanttChartShapeConnect");r.openEnd().close("g");r.openStart("g");r.class("sapGanttChartLasso");r.openEnd().close("g");};I.renderNowLineBody=function(r,g){var n=g.getAxisTime().getNowLabel(g.getNowLineInUTC())[0].value;if(g.getEnableNowLine()===false||isNaN(n)){return;}r.openStart("g");r.class("sapGanttNowLineBodySvgLine");r.openEnd();var s=new B({x1:n,y1:0,x2:n,y2:"100%",strokeWidth:1}).setProperty("childElement",true);s.renderElement(r,s);r.close("g");};I.renderRlsContainer=function(r,g){r.openStart("g");r.class("sapGanttChartRls");r.openEnd().close("g");};I.renderAllShapesInRows=function(r,g){if(!jQuery(document.getElementById(g.getId()+"-gantt"))){return;}r.openStart("g",g.getId()+"-shapes");r.class("sapGanttChartShapes");r.openEnd();this._eachVisibleRowSettings(g,function(d){d.renderElement(r,g);});r.close("g");};I._eachVisibleRowSettings=function(g,f){var d=g.getTable().getRows();var h=g.getTable().getBindingInfo("rows"),m=h&&h.model;for(var i=0;i<d.length;i++){var r=d[i];var j=r.getBindingContext(m);if(j&&r.getIndex()!==-1){var k=r.getAggregation("_settings");if(f){f(k);}}}};I.renderRelationships=function(r,g){var d=window.document.getElementById(g.getId()+"-svg");var f=jQuery(d).children("g.sapGanttChartRls").get(0);if(d==null||f==null){return;}var s=Object.create(null);if(D.browser.msie){var t=jQuery("<div>").attr("id",g.getId()+"-rls").get(0);var h=window.document.getElementById("sap-ui-preserve").appendChild(t);r.openStart("svg").openEnd();this._eachVisibleRowSettings(g,this._renderVisibleRowRelationships.bind(this,r,g,s));this._renderNonVisibleRowRelationships(r,g,s);r.close("svg");r.flush(h,true,false);jQuery(f).append(jQuery(h).children());jQuery(h).remove();}else{this._eachVisibleRowSettings(g,this._renderVisibleRowRelationships.bind(this,r,g,s));this._renderNonVisibleRowRelationships(r,g,s);r.flush(f,true,false);}};I._renderVisibleRowRelationships=function(r,g,s,d){d.getRelationships().forEach(function(f){var S=f.getShapeId();var h=d.getShapeUid(f);if(!s[S]){s[S]=true;f.setProperty("shapeUid",h,true);f.renderElement(r,f,g.getId());}});};I._renderNonVisibleRowRelationships=function(r,g,s){var d=U.safeCall(g,["getTable","getRowSettingsTemplate","getBindingInfo"],null,["relationships"]);if(!d){return;}var S=d.template.getBindingInfo("shapeId");if(!S){return;}var f=S.parts[0].path,m=g.getTable().getModel(d.model);var h=function(i,k){if(!s[i]){s[i]=true;var n=d.factory();n.setModel(m,d.model);n.bindObject({path:k,model:d.model});n.renderElement(r,n,g.getId());n.destroy();}};if(m.isA("sap.ui.model.json.JSONModel")){var j=m.getProperty(d.path);if(j){j.forEach(function(k,i){h(k[f],d.path+"/"+i);});}}else{var E=m.getProperty("/");Object.keys(E).forEach(function(i){if(i.startsWith(d.path)){h(E[i][f],i[0]==="/"?i:"/"+i);}});}};I.renderSvgDefs=function(r,g){var s=g.getSvgDefs();if(s){r.openStart("svg",g.getId()+"-svg-psdef");r.attr("aria-hidden","true");r.style("float","left");r.style("width","0px");r.style("height","0px");r.openEnd();r.unsafeHtml(s.getDefString());r.close("svg");}};I.renderCalendarPattern=function(r,g){var p=g.getCalendarDef(),s=g.getId(),i=g.iGanttRenderedWidth;if(g.getEnableNonWorkingTime()===false){return;}if(p&&p.getDefNode()&&p.getDefNode().defNodes&&i>0){var d=p.getDefNode();var f=s+"-calendardefs";r.openStart("defs",f);r.openEnd();for(var h=0;h<d.defNodes.length;h++){var n=d.defNodes[h];r.openStart("pattern",n.id);r.class("calendarPattern");r.attr("patternUnits","userSpaceOnUse");r.attr("x",0);r.attr("y",0);r.attr("width",i);r.attr("height",32);r.openEnd();for(var j=0;j<n.timeIntervals.length;j++){var t=n.timeIntervals[j];r.openStart("rect");r.attr("x",t.x);r.attr("y",t.y);r.attr("width",t.width);r.attr("height",32);r.attr("fill",t.fill);r.openEnd().close("rect");}r.close("pattern");}r.close("defs");}};I.renderCalendarShapes=function(r,g){r.openStart("g");r.class("sapGanttChartCalendar");r.openEnd();var d=g.getSyncedControl().getRowStates();this._eachVisibleRowSettings(g,function(f){var p=R.calcRowDomPosition(f,d);f.getCalendars().forEach(function(h){h.setProperty("rowYCenter",p.rowYCenter,true);h._iBaseRowHeight=p.rowHeight;if(h.getVisible()){h.renderElement(r,h);}});});r.close("g");};I.renderExpandedRowBackground=function(r,g){var f=g.getExpandedBackgroundData();if(jQuery.isEmptyObject(f)){return;}var i=g._oExpandModel.refreshRowYAxis(g.getTable());var E=Array.prototype.concat.apply([],f);var w=g.iGanttRenderedWidth;r.openStart("g");r.class("sapGanttChartRowBackground");r.openEnd();for(var h=0;h<E.length;h++){var d=E[h];var s;var j;if(g.getEnableExpandedRowBackground()===true){s="sapGanttExpandChartCntBG";}else{s="sapGanttExpandedRowBackground";}if(g.getEnableExpandedRowBorders()===true){j=d.rowHeight-1;}else{j=d.rowHeight;}r.openStart("g");r.class("expandedRow");r.openEnd();var y;if(g.getShowParentRowOnExpand()){y=d.y;}else{y=d.y-(i);}r.openStart("rect");r.attr("x",d.x);r.attr("y",y);r.attr("height",j);r.attr("width","100%");r.class(s);r.openEnd();r.close("rect");r.openStart("path");if(g.getEnableExpandedRowBorders()===true){r.class("sapGanttExpandChartLine");}r.attr("d","M0 "+(y-1)+" H"+(w-1));r.openEnd().close("path");r.close("g");}r.close("g");};return I;},true);
