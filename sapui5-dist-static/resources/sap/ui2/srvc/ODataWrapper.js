// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ui2.srvc.ODataWrapper");var r=function(){jQuery.sap.require.apply(this,arguments);};function n(){}sap.ui2.srvc.testPublishAt=sap.ui2.srvc.testPublishAt||function(){};if(typeof OData!=="object"){r("sap.ui.thirdparty.datajs");}function a(d,R){if(sap.ui2.srvc.isArray(d)){d.forEach(function(D){D.reject(R);});}else{d.reject(R);}}sap.ui2.srvc.ODataWrapper=function(s,o){var S="saplb",B,C,d,t=this,e,f;function g(A){var s={};s.baseUrl=A[0];if(typeof A[2]==='boolean'){s.supportsChangeSets=A[2];}return s;}sap.ui2.srvc.testPublishAt(t);function k(){return B;}sap.ui2.srvc.testPublishAt(t);function l(K,H){K=K.toLowerCase();for(var i in H){if(Object.prototype.hasOwnProperty.call(H,i)&&i.toLowerCase()===K){return H[i];}}return undefined;}function m(H){var i=s["sap-language"]||sap.ui2.srvc.ODataWrapper["sap-language"],j=s["sap-statistics"]||sap.ui2.srvc.ODataWrapper["sap-statistics"],A=s["sap-client"]||sap.ui2.srvc.ODataWrapper["sap-client"];H=H||{};if(i){H["sap-language"]=i;}if(j||(j==="false")){H["sap-statistics"]=""+j;}if(A){H["sap-client"]=A;}return H;}function p(H){H=H||{};var i=sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[e];if(typeof i==="undefined"){return H;}if(i&&i.enabled&&typeof i.value!=="undefined"){H[S]=i.value;}return H;}sap.ui2.srvc.testPublishAt(t);function q(R){var H,i=sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[e];if(!i||!i.enabled){return;}H=l(S,R);if(typeof H==="undefined"){return;}if(i.value!==H){i.value=H;}}sap.ui2.srvc.testPublishAt(t);function u(H){return l("x-csrf-token",H)||"";}sap.ui2.srvc.testPublishAt(t);function v(R,M,P,i,F,H,I){var j;i=i||n;F=F||o.getDefaultErrorHandler();t.check(i,F);j={'Accept':"application/json",'Accept-Language':(sap.ui&&sap.ui.getCore().getConfiguration().getLanguage())||"",'X-CSRF-Token':o.getCsrfToken()};m(j);p(j);OData.request({requestUri:R,method:M,data:P,headers:j},function(D,A){q((A||{}).headers);jQuery.sap.log.debug("Received OData response for "+M+' "'+R+'"',null,"sap.ui2.srvc.ODataWrapper");sap.ui2.srvc.call(i.bind(null,D),F);},function(E){function A(){F.apply(null,arguments);}function D(){i.apply(null,arguments);}if(!I&&E.response.statusCode===403&&u(E.response.headers).toLowerCase()==="required"){jQuery.sap.log.debug("CSRF token required for "+M+' "'+R+'", refreshing it',JSON.stringify(E.response),"sap.ui2.srvc.ODataWrapper");o.refreshCsrfToken(v.bind(t,R,M,P,D,A,H,true),A);}else{t.onError(M,R,F,null,E);}},H);jQuery.sap.log.debug("Sent OData request for "+M+' "'+R+'"',null,"sap.ui2.srvc.ODataWrapper");}sap.ui2.srvc.testPublishAt(t);function w(R){var i=R.indexOf(e);if(i<0){throw new sap.ui2.srvc.Error('Not relative to base URL "'+e+'": '+R,"sap.ui2.srvc.ODataWrapper");}return R.slice(i+e.length);}sap.ui2.srvc.testPublishAt(t);function x(R){if(/^\//.test(R)){throw new sap.ui2.srvc.Error("Not a relative URL: "+R,"sap.ui2.srvc.ODataWrapper");}return e+R;}sap.ui2.srvc.testPublishAt(t);function y(R,i,j){var D,A=x(R),H=p(m());if(B){jQuery.sap.log.debug('Queued OData request for GET "'+R+'"',null,"sap.ui2.srvc.ODataWrapper");B.push({method:"GET",requestUri:R,headers:H});D=(new jQuery.Deferred()).done(i).fail(j);d.push(D);C=false;return;}H["Accept"]="application/json";H["Accept-Language"]=(sap.ui&&sap.ui.getCore().getConfiguration().getLanguage())||"";H["X-CSRF-Token"]="Fetch";OData.read({requestUri:A,headers:H},i,j);jQuery.sap.log.debug('Sent OData request for GET "'+A+'"',null,"sap.ui2.srvc.ODataWrapper");}sap.ui2.srvc.testPublishAt(t);function z(R,M,P,i,F){var D,j={data:P,method:M,requestUri:R,headers:p(m())},A=x(R);if(B){i=i||n;F=F||o.getDefaultErrorHandler();t.check(i,F);jQuery.sap.log.debug("Queued OData request for "+M+' "'+R+'"',null,"sap.ui2.srvc.ODataWrapper");if(!C){B.push({__changeRequests:[]});d.push([]);C=f;}B[B.length-1].__changeRequests.push(j);D=(new jQuery.Deferred()).done(function(E,G){jQuery.sap.log.debug("Received OData response for "+M+' "'+A+'"',null,"sap.ui2.srvc.ODataWrapper");sap.ui2.srvc.call(i.bind(null,E),F);}).fail(t.onError.bind(t,M,A,F,null));d[d.length-1].push(D);return;}v(A,M,P,i,F);}this.isStickySessionEnabled=function(){return(sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[e]||{}).enabled||false;};this.enableStickySession=function(){sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[e].enabled=true;};this.check=function(i,F){if(!i){throw new sap.ui2.srvc.Error("Missing success callback","sap.ui2.srvc.ODataWrapper");}if(typeof i!=="function"){throw new sap.ui2.srvc.Error("Success callback is not a function","sap.ui2.srvc.ODataWrapper");}if(!F){throw new sap.ui2.srvc.Error("Missing error callback","sap.ui2.srvc.ODataWrapper");}if(typeof F!=="function"){throw new sap.ui2.srvc.Error("Error callback is not a function","sap.ui2.srvc.ODataWrapper");}};this.create=function(R,P,i,F){z(R,"POST",P,i,F);};this.del=function(E,i,F){var R=E;if(typeof R!=="string"){R=w(E.__metadata.uri);}z(R,"DELETE",null,function(D){if(i){i();}},F);};this.getBaseUrl=function(){return e;};this.getODataService=function(){return o;};this.onError=function(M,R,F,D,E){var P,i="Error ";if(E.response&&E.response.statusCode){i+="("+E.response.statusCode+", "+E.response.statusText+") ";}i+="in OData response for "+M+' "'+R+'": '+E.message;if(E.response&&E.response.body){try{P=JSON.parse(E.response.body).error;if(P){if(P.hasOwnProperty("message")&&P.message.hasOwnProperty("value")){i+="\nDetails: "+P.message.value;}if(E.response.statusCode&&!P.httpStatus){P.httpStatus=E.response.statusCode;}}}catch(j){}}jQuery.sap.log.error(i,JSON.stringify(E.response),"sap.ui2.srvc.ODataWrapper");if(D){D.reject(i,P);}F(i,P);};this.openBatchQueue=function(){if(B){throw new sap.ui2.srvc.Error("Batch queue already open","sap.ui2.srvc.ODataWrapper");}B=[];d=[];C=false;};this.isBatchQueueOpen=function(){return!!B;};this.read=function(R,i,F,j){var D,A=x(R),E;function G(H,I){q(I.headers);o.setCsrfToken(u(I.headers)||o.getCsrfToken());jQuery.sap.log.debug('Received OData response for GET "'+A+'"',null,"sap.ui2.srvc.ODataWrapper");E=l("sap-message",I.headers);if(E){jQuery.sap.log.warning("SAP message for GET "+A,E,"sap.ui2.srvc.ODataWrapper");}if(D){D.resolve(JSON.parse(JSON.stringify(H)),o.getCsrfToken());}sap.ui2.srvc.call(i.bind(null,H),F);}F=F||o.getDefaultErrorHandler();this.check(i,F);if(j){OData.read.$cache=OData.read.$cache||new sap.ui2.srvc.Map();D=OData.read.$cache.get(A);if(D){jQuery.sap.log.debug('Using cached response for GET "'+A+'"',null,"sap.ui2.srvc.ODataWrapper");D.done(function(H,I){o.setCsrfToken(o.getCsrfToken()||I);sap.ui2.srvc.call(i.bind(null,JSON.parse(JSON.stringify(H))),F);}).fail(F);return;}D=new jQuery.Deferred();OData.read.$cache.put(A,D.promise());}y(R,G,this.onError.bind(this,"GET",A,F,D));};this.batch=function(P,i,F){var R=x("$batch");v(R,"POST",P,i,F,OData.batchHandler);};this.submitBatchQueue=function(A,D){var M=d;function E(F){var G=F.__batchResponses.length,H=M.length;if(H!==G){t.onError("POST",x("$batch"),D,null,{message:"Protocol error! Expected "+H+" responses, but received "+G});return;}F.__batchResponses.forEach(function(R,i){var I=M[i];if(R.response){a(I,R);}else if(R.__changeResponses){R.__changeResponses.forEach(function(J,j){I[j].resolve(J.data,J);});}else{I.resolve(R.data,R);}});if(A){sap.ui2.srvc.call(A,o.getDefaultErrorHandler());}}if(!B){throw new sap.ui2.srvc.Error("No open batch queue to submit","sap.ui2.srvc.ODataWrapper");}if(B.length>0){this.batch({__batchRequests:B},E,D);}else if(A){sap.ui2.srvc.call(A,o.getDefaultErrorHandler(),true);}B=undefined;d=undefined;};this.toString=function(V){var R=['sap.ui2.srvc.ODataWrapper({sBaseUrl:"',e,'"'];R.push('})');return R.join('');};this.put=function(R,P,i,F){z(R,"PUT",P,function(D){if(i){i();}},F);};this.update=function(E,i,F){var P={"__metadata":{type:E.__metadata&&E.__metadata.type}},j,R=w(E.__metadata.uri);for(j in E){if(Object.prototype.hasOwnProperty.call(E,j)&&j.indexOf('$')!==0&&typeof E[j]!=="object"){P[j]=E[j];}}this.put(R,P,i,F);};if(!sap.ui2.srvc.Map){r("sap.ui2.srvc.utils");}if(typeof s==='string'){s=g(arguments);}else if(typeof s==='object'){s=c(s);}if(!s||!s.baseUrl||typeof s.baseUrl!=="string"){throw new sap.ui2.srvc.Error("Missing base URL","sap.ui2.srvc.ODataWrapper");}if(!o||typeof o!=="object"){throw new sap.ui2.srvc.Error("Missing OData service facade","sap.ui2.srvc.ODataWrapper");}s.baseUrl=s.baseUrl.replace(/\/$/,"")+"/";e=s.baseUrl;f=s.supportsChangeSets;if(typeof sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration==="undefined"){jQuery.sap.log.error("sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration is not defined!","the sap.ui2.srvc.ODataWrapper constructor was called before the static property was defined","sap.ui2.srvc.ODataWrapper");}else if(typeof sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[e]==="undefined"){sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration[e]={enabled:false,value:undefined};}};function h(A){var s={};var t={};s.baseUrl=A[0];if(typeof A[1]==='boolean'){s.supportsChangeSets=A[1];}if(typeof A[2]==='function'){t.defaultFailure=A[2];}t.settings=s;return t;}function c(i){if(i===undefined){return undefined;}try{return JSON.parse(JSON.stringify(i));}catch(e){return undefined;}}if(typeof sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration==="undefined"){sap.ui2.srvc.ODataWrapper.oStickySessionConfiguration={};}sap.ui2.srvc.testPublishAt(sap.ui2.srvc.ODataWrapper);function b(w){try{sap.ui2.srvc.ODataWrapper["sap-statistics"]=sap.ui.getCore().getConfiguration().getStatistics();}catch(e){sap.ui2.srvc.ODataWrapper["sap-statistics"]=/sap-statistics=(true|x|X)/.test(w);}}b(window.location.search);sap.ui2.srvc.createODataWrapper=function(s,d){if(typeof arguments[0]==='string'){var t=h(arguments);s=t.settings;if(t.defaultFailure){d=t.defaultFailure;}}else if(typeof arguments[0]==='object'){s=c(s);}function S(){var w=new sap.ui2.srvc.ODataWrapper(s,this);r("sap.ui2.srvc.ODataService");sap.ui2.srvc.ODataService.call(this,w,d);return w;}return new S();};}());
