/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ovp/cards/CommonUtils","sap/ovp/cards/SettingsUtils","sap/ui/dt/plugin/ElementMover","sap/ui/dt/OverlayRegistry",'sap/ui/dt/OverlayUtil','sap/ui/rta/plugin/Plugin','sap/ui/rta/util/BindingsExtractor','sap/ui/dt/MetadataPropagationUtil','sap/ui/rta/Utils',"sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/ovp/cards/ovpLogger"],function(q,C,S,E,O,a,P,B,M,U,b,c,o){"use strict";var A=C.getApp();var i=false;var l=new o("OVP.ui.ComponentContainerDesigntimeMetadata");var _=function(){var u="https://"+window.location.host+"/sap/opu/odata/SSB/SMART_BUSINESS_DESIGNTIME_SRV/KPIs";q.ajax({type:"GET",url:u,dataType:"json",async:false,headers:"",success:function(p,t,r){var D={'d':{'results':[]}};D.d.results=p.d.results.filter(function(K){return!!K.ModelURI;});i=(D.d.results.length>0);if(i){var s=new sap.ui.model.json.JSONModel();s.setData(D);A.getView().setModel(s,"JSONModelForSSB");}},error:function(p){l.error(p);}});};_();var e=new E(),d=function(p){p.setTargetZone(false);},f=function(p){p.setTargetZone(true);},g=function(t){var p=t.getAggregationOverlays();var r=p.filter(function(s){return s.isTargetZone();});if(r.length>0){return r[0];}else{return null;}},h=function(t){var p=e.getMovedOverlay();if(!p){return false;}var r=false;if(!(t.getElement()===p.getElement())){var T=g(t);if(T){r=true;}else if(a.isInTargetZoneAggregation(t)){r=true;}}if(r){p.setSelected(true);setTimeout(function(){p.focus();},0);}return r;},j=function(p,s){var r=p.getAggregationOverlays();r.forEach(function(t){s(t);});},k=function(s,p){var r=O.getOverlay(s),t=r.getParentElementOverlay(),u=a.findAllSiblingOverlaysInContainer(r,t);u.forEach(function(v){j(v,p);});};var m=E.prototype.checkTargetZone;E.prototype.checkTargetZone=function(p,r,s){var t=r?r:this.getMovedOverlay();var T=m.apply(this,arguments);if(!T){return Promise.resolve(false);}var u=t.getElement();var v=p.getParent();var w=t.getRelevantContainer();var x=v.getElement();var y=p.getDesignTimeMetadata();var z=M.getRelevantContainerForPropagation(y.getData(),u);z=z?z:x;if(!w||!z||!P.prototype.hasStableId(v)||w!==z){return Promise.resolve(false);}if(t.getParent().getElement()!==x){var D=B.getBindings(u,u.getModel());if(Object.keys(D).length>0&&u.getBindingContext()&&x.getBindingContext()){var F=U.getEntityTypeByPath(u.getModel(),u.getBindingContext().getPath());var G=U.getEntityTypeByPath(x.getModel(),x.getBindingContext().getPath());if(!(F===G)){return Promise.resolve(false);}}}return Promise.resolve(true);};E.prototype.deactivateAllTargetZones=function(s){k(s,d);};E.prototype.activateAllValidTargetZones=function(s){k(s,f);};var n={name:{singular:b.getText("Card"),plural:b.getText("Cards")},actions:{remove:{name:b.getText("OVP_KEYUSER_MENU_HIDE_CARD"),changeType:"hideCardContainer",changeOnRelevantContainer:true},reveal:{changeType:"unhideCardContainer",changeOnRelevantContainer:true,getLabel:function(p){var s=this._getCardId(p.getId()),r=this._getCardFromManifest(s);if(r){var t=r.settings;if(t.title){return t.title;}else if(t.category){return(t.category);}else if(t.subTitle){return t.subTitle;}return r.cardId;}else{l.error("Card id "+s+" is not present in the manifest");return"";}}.bind(A)}}};var L=C._getLayer();n.actions["settings"]=function(p){if(!p.getComponentInstance()){return{};}var r=p.getComponentInstance().getComponentData(),s=r.mainComponent,t=s._getCardFromManifest(r.cardId);if(!t||!C.checkIfCardTypeSupported(t.template)){return{};}var u={"EditCard":{icon:"sap-icon://edit",name:b.getText("OVP_KEYUSER_MENU_EDIT_CARD"),isEnabled:function(v){return true;},changeOnRelevantContainer:true,handler:S.fnEditCardHandler},"CloneCard":{icon:"sap-icon://value-help",name:b.getText("OVP_KEYUSER_MENU_CLONE_CARD"),isEnabled:function(v){return true;},handler:S.fnCloneCardHandler}};if(!L||L===c.Layers.customer){u["Cut"]={icon:"sap-icon://scissors",name:b.getText("OVP_KEYUSER_MENU_CUT_CARD"),isEnabled:function(v){return true;},changeOnRelevantContainer:true,handler:function(v,G){var w=O.getOverlay(v),x=e.getMovedOverlay();if(x){x.removeStyleClass("sapUiDtOverlayCutted");e.setMovedOverlay(null);e.deactivateAllTargetZones(v);}e.setMovedOverlay(w);w.addStyleClass("sapUiDtOverlayCutted");e.activateAllValidTargetZones(v);return Promise.resolve([]).then(function(){return[];});}};u["Paste"]={icon:"sap-icon://paste",name:b.getText("OVP_KEYUSER_MENU_PASTE_CARD"),isEnabled:function(v){var w=O.getOverlay(v),T=g(w);return!!((T)||(a.isInTargetZoneAggregation(w)));},changeOnRelevantContainer:true,handler:function(v,G){var w=O.getOverlay(v),x=e.getMovedOverlay();if(x){var y=x.getElement(),T=w.getElement(),z=a.getParentInformation(x),D=a.getParentInformation(w),F=v.getComponentInstance().getComponentData().mainComponent,H=F.getLayout(),I=F.getUIModel(),J={},K={},N=[];if(I.getProperty('/containerLayout')==='resizable'){var Q=H.getDashboardLayoutModel(),R=F._getCardId(y.getId()),V=F._getCardId(v.getId()),W=Q.getCardById(R),X=Q.getCardById(V),Y=Q.getColCount(),Z='C'+Y,$=[];J.cardId=R;J.dashboardLayout={};J.dashboardLayout[Z]={row:X.dashboardLayout.row,oldRow:W.dashboardLayout.row,column:X.dashboardLayout.column,oldColumn:W.dashboardLayout.column};if(X.dashboardLayout.column+W.dashboardLayout.colSpan>Y+1){J.dashboardLayout[Z].colSpan=X.dashboardLayout.colSpan;J.dashboardLayout[Z].oldColSpan=W.dashboardLayout.colSpan;J.dashboardLayout[Z].rowSpan=W.dashboardLayout.rowSpan;J.dashboardLayout[Z].oldRowSpan=W.dashboardLayout.rowSpan;}N.push({selectorControl:v.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"dragOrResize",content:J}});N.push({selectorControl:v.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"dragAndDropUI",content:J}});Q._arrangeCards(W,{row:X.dashboardLayout.row,column:X.dashboardLayout.column},'drag',$);Q._removeSpaceBeforeCard($);$.forEach(function(b1){var c1={};c1.dashboardLayout={};c1.cardId=b1.content.cardId;c1.dashboardLayout[Z]=b1.content.dashboardLayout;N.push({selectorControl:v.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"dragOrResize",content:c1}});});}else{var a1=D.parent.getContent().filter(function(t){return t.getVisible();});J={cardId:F._getCardId(y.getId()),position:a1.indexOf(T),oldPosition:a1.indexOf(y)};N.push({selectorControl:v.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"position",content:J}});K={cardId:F._getCardId(y.getId()),position:D.index,oldPosition:z.index};N.push({selectorControl:v.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"dragAndDropUI",content:K}});}}h(w);if(x){x.removeStyleClass("sapUiDtOverlayCutted");e.setMovedOverlay(null);e.deactivateAllTargetZones(v);return Promise.resolve(N).then(function(b1){return b1;});}}};u["AddStaticLinkListCard"]={icon:"sap-icon://form",name:b.getText("OVP_KEYUSER_MENU_CREATE_LINK_LIST_CARD"),isEnabled:function(v){return true;},handler:S.fnAddStaticLinkListCardHandler};if(i){u["AddKPICard"]={icon:"sap-icon://kpi-corporate-performance",name:b.getText("OVP_KEYUSER_MENU_ADD_KPI_CARD"),isEnabled:function(v){return true;},handler:S.fnAddKPICardHandler};}}else if(L&&(L===c.Layers.vendor||L===c.Layers.customer_base)){u["AddCard"]={icon:"sap-icon://add-activity",name:b.getText("OVP_KEYUSER_MENU_AddCard"),isEnabled:function(v){return true;},handler:S.fnAddNewCardHandler};}u["RemoveCard"]={icon:"sap-icon://delete",name:b.getText("OVP_KEYUSER_MENU_REMOVE_CARD"),isEnabled:function(v){var u=v.getComponentInstance().getComponentData().settings;return v.getId().indexOf(C._getLayerNamespace()+".")!==-1&&!u.cloneCard&&!u.newCard;},handler:S.fnRemoveCardHandler};return u;};return n;},true);
