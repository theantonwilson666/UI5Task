/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/core/Control","sap/ui/core/Icon","sap/m/Dialog","sap/ovp/app/resources","sap/ui/events/KeyCodes","sap/base/util/uid"],function(q,D,C,I,a,O,K,u){"use strict";var _=null;var b=function(d){this.init(d);};b.prototype.init=function(d){this.objectStream=d;this.keyCodes=K;this.jqElement=d.$();this.jqElement.on('keydown.keyboardNavigation',this.keydownHandler.bind(this));this.jqElement.on("focus.keyboardNavigation",".sapOvpObjectStreamItem",this.ObjectStreamFocusAccessabilityHandler.bind(this));};b.prototype.destroy=function(){if(this.jqElement){this.jqElement.off(".keyboardNavigation");}delete this.jqElement;delete this.objectStream;};b.prototype._swapItemsFocus=function(e,j,d){e.preventDefault();j.attr("tabindex","-1");d.attr("tabindex","0").focus();};b.prototype.ObjectStreamFocusAccessabilityHandler=function(){var f=document.activeElement;f=q(f);if(f){var l=f.find("[aria-label]");var i,d="";for(i=0;i<l.length;i++){if(l[i].getAttribute("role")=="heading"){d+=l[i].id+" ";}}if(d.length){f.attr("aria-labelledby",d);}if(f.hasClass('sapOvpCardHeader')){f.closest('.sapOvpObjectStreamItem').removeAttr("aria-labelledby");}}};b.prototype.tabButtonHandler=function(e){var j=q(document.activeElement);if(j.hasClass("sapOvpObjectStreamItem")){return;}if(j.hasClass("sapOvpObjectStreamClose")){e.preventDefault();this.jqElement.find(".sapOvpObjectStreamItem:sapTabbable").focus();return;}var d=j.closest(".sapOvpObjectStreamItem");if(!d.length){return;}var f=d.find(":sapTabbable");if(f.eq(f.length-1).is(j)){e.preventDefault();this.jqElement.find("a.sapOvpObjectStreamHeader").focus();}};b.prototype.shiftTabButtonHandler=function(e){var j=q(document.activeElement);if(j.hasClass("sapOvpObjectStreamItem")){e.preventDefault();this.jqElement.find(".sapOvpObjectStreamClose").focus();}if(j.hasClass("sapOvpObjectStreamClose")){e.preventDefault();this.jqElement.find('a.sapOvpObjectStreamHeader').focus();}if(j.hasClass("sapOvpObjectStreamHeader")){e.preventDefault();this.jqElement.find(".sapOvpObjectStreamItem:sapTabbable *:sapTabbable").last().focus();return;}};b.prototype.enterHandler=function(e){var j=q(document.activeElement);if(j.hasClass("sapOvpObjectStreamClose")){e.preventDefault();this.objectStream.getParent().close();if(_){_.focus();}return;}if(j.hasClass("sapOvpObjectStreamItem")&&!j.next().length){j.children().click();return;}};b.prototype.f6Handler=function(e){var j=q(document.activeElement);if(j.hasClass("sapOvpObjectStreamClose")){this.jqElement.find('.sapOvpObjectStreamItem').attr("tabindex","-1").first().attr("tabindex","0").focus();}else{this.jqElement.find('.sapOvpObjectStreamClose').focus();}};b.prototype.f7Handler=function(e){var j=q(document.activeElement);if(j.hasClass("sapOvpObjectStreamItem")){j.find(':sapTabbable').first().focus();}else{j.closest('.sapOvpObjectStreamItem').focus();}e.preventDefault();};b.prototype.leftRightHandler=function(e,i){var n=i?"next":"prev";var j=q(document.activeElement);if(!j.hasClass("sapOvpObjectStreamItem")){return false;}var d=j[n]();if(!d.length){return;}this._swapItemsFocus(e,j,d);};b.prototype.homeEndHandler=function(e,i){var n=i?"first":"last";var j=q(document.activeElement);if(!j.hasClass("sapOvpObjectStreamItem")){return false;}e.preventDefault();var d=this.jqElement.find(".sapOvpObjectStreamItem")[n]();this._swapItemsFocus(e,j,d);};b.prototype.pageUpDownHandler=function(e,i){var n=i?"prev":"next";var j=q(document.activeElement);if(!j.hasClass("sapOvpObjectStreamItem")){return;}if(!j[n]().length){return;}var d=false;var f=j;var w=window.innerWidth;while(!d){var g=f[n]();if(!g.length){d=f;break;}if(!i&&g.offset().left>w){d=g;break;}if(i&&(g.offset().left+g.outerHeight())<=0){d=g;break;}f=g;}this._swapItemsFocus(e,j,d);};b.prototype.keydownHandler=function(e){switch(e.keyCode){case this.keyCodes.TAB:(e.shiftKey)?this.shiftTabButtonHandler(e):this.tabButtonHandler(e);break;case this.keyCodes.ENTER:case this.keyCodes.SPACE:this.enterHandler(e);break;case this.keyCodes.F6:this.f6Handler(e);break;case this.keyCodes.F7:this.f7Handler(e);break;case this.keyCodes.ARROW_UP:case this.keyCodes.ARROW_LEFT:this.leftRightHandler(e,false);break;case this.keyCodes.ARROW_DOWN:case this.keyCodes.ARROW_RIGHT:this.leftRightHandler(e,true);break;case this.keyCodes.HOME:this.homeEndHandler(e,true);break;case this.keyCodes.END:this.homeEndHandler(e,false);break;case this.keyCodes.PAGE_UP:this.pageUpDownHandler(e,true);break;case this.keyCodes.PAGE_DOWN:this.pageUpDownHandler(e,false);break;default:break;}};var c=C.extend("sap.ovp.ui.ObjectStream",{metadata:{library:"sap.ovp",aggregations:{content:{type:"sap.ui.core.Control",multiple:true},placeHolder:{type:"sap.ui.core.Control",multiple:false},title:{type:"sap.ui.core.Control",multiple:false}}}});c.prototype.init=function(){var t=this;this._closeIcon=new I({src:"sap-icon://decline",tooltip:O.getText("close")});this._closeIcon.addEventDelegate({onclick:function(){t.getParent().close();}});};c.prototype._startScroll=function(d){this._direction=d;var e=this.wrapper.scrollWidth-this.wrapper.offsetWidth-Math.abs(this.wrapper.scrollLeft);var l;if(d=="left"){l=(this.rtl&&!this.scrollReverse)?e:this.wrapper.scrollLeft;if(l<=0){return;}this.jqRightEdge.css("opacity",1);}else{l=(this.rtl&&!this.scrollReverse)?Math.abs(this.wrapper.scrollLeft):e;if(l<=0){return;}this.jqLeftEdge.css("opacity",1);}var f=l*3;var t=(d=="left")?l:~l+1;q(this.container).one("transitionend",function(){this._mouseLeave({data:this});}.bind(this));this.container.style.transition='transform '+f+'ms linear';this.container.style.transform='translate('+t+'px, 0px) scale(1) translateZ(0px) ';};c.prototype._mouseLeave=function(e){var d=window.getComputedStyle(e.data.container).transform;e.data.container.style.transform=d;e.data.container.style.transition='';this.rtl=sap.ui.getCore().getConfiguration().getRTL();var t;var f=d.split(",");if(d.substr(0,8)=="matrix3d"){t=parseInt(f[12],10);}else if(d.substr(0,6)=="matrix"){t=parseInt(f[4],10);}if(isNaN(t)){return;}e.data.container.style.transform="none";if(D.browser.msie){t=this.rtl?~t:t;}e.data.wrapper.scrollLeft+=~t+(e.data._direction=="left"?-5:5);e.data._checkEdgesVisibility();};var s;c.prototype.debounceScrollHandler=function(){window.clearTimeout(s);s=window.setTimeout(this._checkEdgesVisibility.bind(this),150);};c.prototype._initScrollVariables=function(){var j=this.$();this.container=j.find(".sapOvpObjectStreamScroll").get(0);this.rtl=sap.ui.getCore().getConfiguration().getRTL();this.wrapper=j.find(".sapOvpObjectStreamCont").get(0);this.scrollReverse=this.scrollReverse||this.wrapper.scrollLeft>0;this.shouldShowScrollButton=(!D.system.phone&&!D.system.tablet)||D.system.combi;this.jqRightEdge=j.find(".sapOvpOSEdgeRight");this.jqLeftEdge=j.find(".sapOvpOSEdgeLeft");if(this.shouldShowScrollButton){this.jqRightEdge.add(this.jqLeftEdge).on("mouseenter.objectStream",this,this._mouseEnter).on("mouseleave.objectStream",this,this._mouseLeave);q(this.wrapper).on("scroll.objectStream",this.debounceScrollHandler.bind(this));}else{this.jqLeftEdge.css("display","none");this.jqRightEdge.css("display","none");}this._checkEdgesVisibility();};c.prototype._afterOpen=function(){if(D.os.ios&&this.$().length){this.$().on("touchmove.scrollFix",function(e){e.stopPropagation();});}var d=this.$().find('a.sapOvpObjectStreamHeader');d.removeAttr('aria-describedby');d.removeAttr('href');var l=d.attr('id');d.parent('div').attr('aria-labelledby',l);d.focus();if(this.keyboardNavigation){this.keyboardNavigation.destroy();}this.keyboardNavigation=new b(this);this._initScrollVariables();this.jqBackground=q("<div id='objectStreamBackgroundId' class='objectStreamNoBackground'></div>");q("#sap-ui-static").prepend(this.jqBackground);this.jqBackground.on('click.closePopup',function(){this._oPopup.close();}.bind(this));q(".sapUshellEasyScanLayout").addClass("bluredLayout");var f=this.$().find('.sapOvpObjectStreamItem');for(var i=0;i<f.length;i++){var F=q(f[i]).find('.sapOvpActionFooter');if(F.find('button').length==0){F.attr('tabindex','-1');}}};c.prototype._beforeClose=function(){if(D.os.ios&&this.$().length){this.$().off(".scrollFix");}this.keyboardNavigation.destroy();this.jqBackground.remove();this.jqLeftEdge.add(this.jqRightEdge).add(this.wrapper).off(".objectStream");q(".sapUshellEasyScanLayout").removeClass("bluredLayout");this._oPopup=undefined;};c.prototype._mouseEnter=function(e){var d='right';if((e.target==e.data.jqRightEdge.get(0))||(e.currentTarget==e.data.jqRightEdge.get(0))){d=sap.ui.getCore().getConfiguration().getRTL()?'left':'right';}if((e.target==e.data.jqLeftEdge.get(0))||(e.currentTarget==e.data.jqLeftEdge.get(0))){d=sap.ui.getCore().getConfiguration().getRTL()?'right':'left';}e.data._startScroll(d);};c.prototype._checkEdgesVisibility=function(){var d=this.wrapper.scrollLeft;var l=this.wrapper.scrollWidth-this.wrapper.offsetWidth-this.wrapper.scrollLeft;var e=(d==0)?0:1;var r=(l==0)?0:1;if(sap.ui.getCore().getConfiguration().getRTL()&&this.scrollReverse){this.jqLeftEdge.css("opacity",r);this.jqRightEdge.css("opacity",e);this.jqRightEdge.css("z-index",(e===0)?0:1);}else{this.jqLeftEdge.css("opacity",e);this.jqRightEdge.css("opacity",r);this.jqRightEdge.css("z-index",(r===0)?0:1);}};c.prototype._createPopup=function(){this._oPopup=new a({showHeader:false,afterOpen:this._afterOpen.bind(this),beforeClose:this._beforeClose.bind(this),content:[this],stretch:D.system.phone}).removeStyleClass("sapUiPopupWithPadding").addStyleClass("sapOvpStackedCardPopup");this._oPopup.oPopup.setModal(false);};c.prototype.open=function(d,e){if(!this._oPopup){this._createPopup();}this._cardWidth=d;_=e;this.setCardsSize(this._cardWidth);this._oPopup.open();};c.prototype.onBeforeRendering=function(){var d=this.getBinding("content");var p=this.getPlaceHolder();if(d&&d.getLength()<=20){this.setPlaceHolder(null);if(p){p.destroy();}}};c.prototype.onAfterRendering=function(){if(!this._oPopup||!this._oPopup.isOpen()||!this.getContent().length){return;}setTimeout(function(){this._initScrollVariables();}.bind(this));};c.prototype.exit=function(){if(this._oPopup){this._oPopup.destroy();}this._closeIcon.destroy();if(this._oScroller){this._oScroller.destroy();this._oScroller=null;}};c.prototype.setCardsSize=function(d){var r=parseInt(window.getComputedStyle(document.documentElement).fontSize,10);var e=D.system.phone?document.body.clientHeight/r-4.5:28.75;var f=this.getContent();f.map(function(g){g.setWidth(d+"px");g.setHeight(e+"rem");});var p=this.getPlaceHolder();if(p){p.setWidth(d+"px");p.setHeight(e+"rem");}};var o=false;c.prototype.getNewContentAvailable=function(){return o;};c.prototype.setNewContentAvailable=function(v){o=v;};c.prototype.updateContent=function(r){var B=this.mBindingInfos["content"],d=B.binding,e=d.getContexts(B.startIndex,B.length);if(r==="change"){var f=B.factory,i=0,g=this.getContent(),h=function(k){var l=this.getId()+"-"+u(),m=f(l,k);m.setBindingContext(k,B.model);this.addContent(m);};var j=h.bind(this);if(g.length<e.length){for(i=0;i<g.length;++i){g[i].destroy();}g.length=0;this.setNewContentAvailable(true);for(i=0;i<e.length;i++){j(e[i]);}}if(!this.getNewContentAvailable()){for(i=0;i<e.length;++i){g[i].setBindingContext(e[i],B.model);}}if(g.length>e.length){i=e.length;for(;i<g.length;++i){g[i].destroy();}g.length=e.length;}}};return c;});
