sap.ui.define(["sap/ovp/cards/generic/Card.controller","sap/m/library","sap/ui/thirdparty/jquery","sap/ovp/ui/ObjectStream","sap/ovp/cards/AnnotationHelper","sap/ui/Device","sap/ui/base/BindingParser","sap/ui/core/ComponentContainer","sap/m/Link","sap/ovp/ui/CustomData","sap/ui/core/Icon","sap/m/FlexItemData","sap/m/Text","sap/m/VBox","sap/ovp/app/resources","sap/base/util/merge","sap/ovp/cards/ovpLogger","sap/ovp/cards/jUtils"],function(C,S,q,O,A,D,B,a,L,b,I,F,T,V,c,m,o,u){"use strict";var l=new o("OVP.stack.Stack");return C.extend("sap.ovp.cards.stack.Stack",{onInit:function(){C.prototype.onInit.apply(this,arguments);var v=this._oCard=this.getView().byId("stackContent");v.addEventDelegate({onclick:this.openStack.bind(this),onkeydown:function(e){if(!e.shiftKey&&(e.keyCode==13||e.keyCode==32)){e.preventDefault();this.openStack();}}.bind(this)});if(D.system.phone){this.bAfterColumnUpdateAttached=false;this.bDeviceOrientationAttached=false;}this.quickViewCardContextArray=[];this.bQuickViewCardRendered=false;this.quickViewCardCount=0;this._createObjectStream();},onExit:function(){if(this.oObjectStream){this.oObjectStream.destroy();}},addPlaceHolder:function(n){var v=this.getView();var d=v.getModel("ovpCardProperties");var s=d.getProperty("/objectStreamCardsNavigationProperty");var e=s?true:false;if(!e){var N=this.getEntityNavigationEntries();if(N.length>0){var f=N[0].label;if(this.sPlaceHolderText==undefined){this.sPlaceHolderText=c.getText("PlaceHolder_default");}var p=this._createPlaceHolder(n,this.sPlaceHolderText,f);var t=this;p.addEventDelegate({onclick:function(){t.doNavigation(null);}});this.oObjectStream.setPlaceHolder(p);}}},onAfterRendering:function(){C.prototype.onAfterRendering.apply(this,arguments);this.ovpLayout=sap.ui.getCore().byId("mainView--ovpLayout");if(D.system.phone){this._cardWidth=this.getView().$().width();if(!this.bAfterColumnUpdateAttached){var d=this.getOwnerComponent().getComponentData();if(d&&d.mainComponent&&d.appComponent.oOvpConfig&&d.appComponent.oOvpConfig.containerLayout!=="resizable"){var M=d.mainComponent,e=M.byId("ovpLayout");e.attachAfterColumnUpdate(function(E){this._setObjectStreamCardsSize(false);}.bind(this));this.bAfterColumnUpdateAttached=true;}}if(!this.bDeviceOrientationAttached){D.orientation.attachHandler(function(E){this._setObjectStreamCardsSize(true);}.bind(this));}}if(this.bSetErrorState&&this.bSetErrorState===true){this.setErrorState();return;}var v=this.getView();if(this.oObjectStream){var f=this.oObjectStream.getBinding("content");f.attachDataRequested(function(){if(this.getView().byId('stackSize')!==undefined&&this.getView().byId('stackTotalSize')!==undefined){q(this.getView().byId('stackSize').getDomRef()).css('visibility','hidden');q(this.getView().byId('stackTotalSize').getDomRef()).css('visibility','hidden');}},this);f.attachDataReceived(function(){var g=this.getView().getModel("ovpCardProperties").getObject("/category"),n=f.getCurrentContexts().length,h=f.getLength();v.byId("stackSize").setText(n);v.byId("stackTotalSize").setText(c.getText("Total_Size_Stack_Card",[h]));var s=this.getView().byId("stackContent").getDomRef();q(s).attr("aria-label",c.getText("stackCardContent",[n,h,g]));var i=this.getView().byId("stackSize").getDomRef();q(i).attr("aria-label",c.getText("stackCard",[n]));this.addPlaceHolder(h);if(this.getView().byId('stackSize')!==undefined&&this.getView().byId('stackTotalSize')!==undefined){q(this.getView().byId('stackSize').getDomRef()).css('visibility','visible');q(this.getView().byId('stackTotalSize').getDomRef()).css('visibility','visible');}var j=this.getView().getDomRef();var k=q(j).find('.sapOvpCardContentContainer');if(h!==0){if(k.length!==0){k.addClass('sapOvpCardNavigable');}}else{if(k.length!==0){var p=k.find("[role='button']");if(p.length!==0){p.removeAttr("role");}}}},this);this.addPlaceHolder("");if(f.bPendingRequest===false){f.fireDataReceived();}if(this.checkNavigation()){this.oObjectStream.getTitle().addStyleClass('sapOvpCardNavigable');}}},getCardItemsBinding:function(){return this.oObjectStream.getBinding("content");},_setObjectStreamCardsSize:function(i){var d=this.getView().$().width();if(this._cardWidth!=d||i){this.oObjectStream.setCardsSize(d);this._cardWidth=d;}},_createObjectStream:function(){if(this.oObjectStream instanceof O){return;}var d=this.getOwnerComponent();var e=d.getComponentData&&d.getComponentData();var p;var P;if(e.i18n){this.oi18n=e.i18n;}if(e&&e.mainComponent){p=e.mainComponent._getOvplibResourceBundle();}else{p=d.getOvplibResourceBundle();}P=d.getPreprocessors(p);this.oModel=e.model;this.oCardPropsModel=P.xml.ovpCardProperties;var E=this.oCardPropsModel.getProperty("/entitySet");var f=this.oCardPropsModel.getProperty("/objectStreamCardsSettings");this.oObjectStreamCardsSettings=f;var M=this.oModel.getMetaModel();var g=M.getODataEntitySet(E);var h=M.getODataEntityType(g.entityType);var s=this.oCardPropsModel.getProperty("/annotationPath");var i=(s)?s.split(","):[];if(e){this.oAppComponent=e.appComponent;this.oOwner=e.mainComponent;}if(this.oOwner){this.oGlobalFilter=this.oOwner.getView().byId("ovpGlobalFilter");}function j(K){if(K==="ovpCardProperties"){return this.oCardPropsModel;}else if(K==="dataModel"){return this.oModel;}else if(K==="_ovpCache"){return{};}}var k=[{getSetting:j.bind(this),bDummyContext:true},g].concat(i);var n=A.formatItems.apply(this,k);var r=B.complexParser(n);var t=this.oCardPropsModel.getProperty("/objectStreamCardsNavigationProperty");this.bStackFlavorAssociation=t?true:false;this.oStackFilterMapping;var v=this.oCardPropsModel.getProperty("/objectStreamCardsTemplate");if(this.bStackFlavorAssociation){if(v==="sap.ovp.cards.quickview"){l.error("objectStreamCardsTemplate cannot be 'sap.ovp.cards.quickview' when objectStreamCardsNavigationProperty is provided");this.bSetErrorState=true;return;}this.oStackFilterMapping=this._determineFilterPropertyId(this.oModel,g,h,t);f.entitySet=this.oModel.getMetaModel().getODataAssociationSetEnd(h,t).entitySet;}else{if(v!=="sap.ovp.cards.quickview"){l.error("objectStreamCardsTemplate must be 'sap.ovp.cards.quickview' when objectStreamCardsNavigationProperty is not provided");this.bSetErrorState=true;return;}var w=null;var x=this.oCardPropsModel.getProperty("/identificationAnnotationPath");var y=(x)?x.split(","):[];if(y&&y.length>1){w=y[1];}if(w){f.identificationAnnotationPath=w;}if(h["com.sap.vocabularies.UI.v1.HeaderInfo"]&&h["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName&&h["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName.String){f.title=h["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName.String;}else{f.title=h.name;}f.entitySet=E;}f.isObjectStream=true;r.factory=function(H,J){var K=new a();this.quickViewCardContextArray.push({sId:H,oContext:J,oComponentContainer:K});return K;}.bind(this);var z=this.oCardPropsModel.getObject("/title");this.sPlaceHolderText=this.oCardPropsModel.getObject("/itemText");var G=new L({text:z,subtle:true,press:this.handleObjectStreamTitlePressed.bind(this)}).addStyleClass("sapOvpObjectStreamHeader");G.addCustomData(new b({key:"tabindex",value:"0",writeToDom:true}));G.addCustomData(new b({key:"aria-label",value:z,writeToDom:true}));this.oObjectStream=new O(this.getView().getId()+"_ObjectStream",{title:G,content:r});this.oObjectStream.setModel(this.oModel);},_renderQuickViewCards:function(i,d,e){return new Promise(function(r,f){var s=this.oCardPropsModel.getProperty("/objectStreamCardsSettings"),g;if(this.bStackFlavorAssociation){g={filters:[{path:this.oStackFilterMapping.foreignKey,operator:"EQ",value1:d.getProperty(this.oStackFilterMapping.key)}]};s=m({},g,this.oObjectStreamCardsSettings);}var h={name:this.oCardPropsModel.getProperty("/objectStreamCardsTemplate"),async:true,componentData:{cardId:i,model:this.oModel,settings:s,appComponent:this.oAppComponent,mainComponent:this.oOwner}};if(this.oGlobalFilter){h.componentData.globalFilter={getUiState:this.oGlobalFilter.getUiState.bind(this.oGlobalFilter)};}var j=this.oi18n;sap.ui.component(h).then(function(k){k.setBindingContext(d);if(j){k.setModel(j,"@i18n");}e.setComponent(k);r();e.setBindingContext=function(d){k.setBindingContext(d);};});}.bind(this));},_determineFilterPropertyId:function(M,e,E,n){var N,d=E.namespace,r,f;for(var i=0;i<E.navigationProperty.length;i++){if(E.navigationProperty[i].name===n){N=E.navigationProperty[i];break;}}r=N.relationship;f=A.getAssociationObject(M,r,d);var R=f.referentialConstraint,g={};if(R){g.foreignKey=R.dependent.propertyRef[0].name;g.key=R.principal.propertyRef[0].name;return g;}},_createPlaceHolder:function(n,p,s){var i=new I({src:"sap-icon://display-more",useIconTooltip:false,layoutData:new F({alignSelf:S.FlexAlignSelf.Center,styleClass:"sapOvpStackPlaceHolderIconContainer"})});i.addStyleClass("sapOvpStackPlaceHolderIcon");var d=n+" "+p;var e=c.getText("SeeMoreContentAppName",[d,s]);var t=new T({text:e,textAlign:"Center",layoutData:new F({alignSelf:S.FlexAlignSelf.Center,maxWidth:"14rem"})});t.addCustomData(new b({key:"role",value:"heading",writeToDom:true}));t.addCustomData(new b({key:"aria-label",value:e,writeToDom:true}));t.addStyleClass("sapOvpStackPlaceHolderTextLine");var f=new V({items:[t]});f.addStyleClass("sapOvpStackPlaceHolderLabelsContainer");f.addCustomData(new b({key:"tabindex",value:"0",writeToDom:true}));f.addCustomData(new b({key:"role",value:"button",writeToDom:true}));var v=new V({items:[i,f]});v.addStyleClass("sapOvpStackPlaceHolder");v.addEventDelegate({onkeydown:function(E){if(!E.shiftKey&&(E.keyCode==13||E.keyCode==32)){E.preventDefault();E.srcControl.$().click();}}});return v;},_openStack:function(){if(this.oObjectStream){var d=this.oObjectStream.getBinding("content");if(d.getCurrentContexts().length>0){var e=this.getView().$().width();this.getView().addDependent(this.oObjectStream);this.oObjectStream.setModel(this.getView().getModel("@i18n"),"@i18n");this.oObjectStream.open(e,this._oCard);}}this.ovpLayout.setActive(true);},openStack:function(){this.ovpLayout.setActive(false);if(this.oObjectStream.getNewContentAvailable()){var d=[];for(var i=this.quickViewCardCount;i<this.quickViewCardContextArray.length;i++){d.push(this._renderQuickViewCards(this.quickViewCardContextArray[i].sId,this.quickViewCardContextArray[i].oContext,this.quickViewCardContextArray[i].oComponentContainer));}this.oObjectStream.setNewContentAvailable(false);this.quickViewCardCount=this.quickViewCardContextArray.length;Promise.all(d).then(function(){this.bQuickViewCardRendered=true;this._openStack();}.bind(this));}else{this._openStack();}},handleObjectStreamTitlePressed:function(e){this.doNavigation(null);}});});
