sap.ui.define(['sap/ovp/cards/CommonUtils','sap/ui/fl/write/api/ControlPersonalizationWriteAPI','sap/ovp/cards/ovpLogger'],function(C,a,o){"use strict";var l=new o("OVP.cards.PersonanlizationUtils");function b(i,j){j.every(function(k){if(k.id===i.cardId){k.selectedKey=i.selectedKey;return false;}return true;});return j;}function c(i,j){j.every(function(k){if(k.id===i.cardId){k.visibility=i.visibility;return false;}return true;});return j;}function d(i,j,v){var M=C.getApp(),k=M._getCardId(i.id);j.every(function(n){if(n.id===k){n.visibility=v;return false;}return true;});return j;}function e(i,j){var I=[];var v,t;v=j.filter(function(k){return k.visibility;});j.forEach(function(k,n){if(!k.visibility){I.push({card:k,index:n});}});if(!v[i.oldPosition]||!v[i.position]){return j;}t=v[i.oldPosition];v[i.oldPosition]=v[i.position];v[i.position]=t;I.forEach(function(k){v.splice(k.index,0,k.card);});j=v;return j;}function f(i,j){j.every(function(k){if(k.id===i.cardId){Object.keys(i.dashboardLayout).forEach(function(K){if(!k.dashboardLayout[K]){k.dashboardLayout[K]={};}if(i.dashboardLayout[K].rowSpan){k.dashboardLayout[K].rowSpan=i.dashboardLayout[K].rowSpan;}if(i.dashboardLayout[K].colSpan){k.dashboardLayout[K].colSpan=i.dashboardLayout[K].colSpan;}if(i.dashboardLayout[K].maxColSpan){k.dashboardLayout[K].maxColSpan=i.dashboardLayout[K].maxColSpan;}if(i.dashboardLayout[K].noOfItems){k.dashboardLayout[K].noOfItems=i.dashboardLayout[K].noOfItems;}if(i.dashboardLayout[K].hasOwnProperty('autoSpan')){k.dashboardLayout[K].autoSpan=i.dashboardLayout[K].autoSpan;}if(i.dashboardLayout[K].row){k.dashboardLayout[K].row=i.dashboardLayout[K].row;}if(i.dashboardLayout[K].column){k.dashboardLayout[K].col=i.dashboardLayout[K].column;}if(i.dashboardLayout[K].hasOwnProperty('showOnlyHeader')){k.dashboardLayout[K].showOnlyHeader=i.dashboardLayout[K].showOnlyHeader;}});return false;}return true;});return j;}function m(i,D){if(!Array.isArray(D)||!i){return i;}var M=[];i.forEach(function(q){var t={};Object.keys(q).forEach(function(K){t[K]=q[K];});M.push(t);});var j={VENDOR:[],CUSTOMER_BASE:[],CUSTOMER:[],USER:[]};var k=D.reduce(function(j,q){j[q.getLayer()].push(q);return j;},j);var n=[].concat(k["VENDOR"],k["CUSTOMER_BASE"],k["CUSTOMER"],k["USER"]);n.forEach(function(q){switch(q.getChangeType()){case"viewSwitch":M=b(q.getContent(),M);break;case"visibility":M=c(q.getContent(),M);break;case"hideCardContainer":M=d(q.getContent(),M,false);break;case"unhideCardContainer":M=d(q.getContent(),M,true);break;case"position":M=e(q.getContent(),M);break;case"dragOrResize":M=f(q.getContent(),M);break;default:break;}});return M;}function g(M,D){var i=M.filter(function(j){var H=false;D.forEach(function(k){if(j.id===k.id){H=true;return;}});return!H;});return D.concat(i);}function s(i,v){var L=v?v.byId("ovpLayout"):null;var j=[],k=[],n=[];if(!Array.isArray(i)){i=[i];}i.forEach(function(O){var q=O.content.cardId;O.jsOnly=true;j.push({selectorElement:v.byId(q),changeSpecificData:O});k.push(v.byId(q));n.push(O.changeType);});a.isCondensingEnabled().then(function(q){if(q){return h(j,L);}else{return r(k,n).finally(function(){return h(j,L);});}}).then(function(){l.info("Personalization changes have been saved in lrep backend");}).catch(function(E){l.error("Personalization changes were not saved",E);});}function r(i,j){return a.reset({selectors:i,changeTypes:j});}function h(i,L){return a.add({changes:i},true).then(function(i){return a.save({changes:i,selector:L});});}var p={mergeChanges:m,addMissingCardsFromManifest:g,savePersonalization:s};return p;},true);
