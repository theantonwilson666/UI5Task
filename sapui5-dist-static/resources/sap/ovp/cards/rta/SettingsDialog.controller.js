sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/cards/SettingsUtils","sap/ovp/cards/PayLoadUtils","sap/ovp/cards/rta/SettingsDialogConstants","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/ChangeReason","sap/ovp/cards/linklist/AnnotationHelper","sap/ovp/cards/v4/V4AnnotationHelper","sap/ovp/cards/AnnotationHelper","sap/ui/core/IconPool","sap/ui/core/mvc/ViewType","sap/m/Dialog","sap/m/Button","sap/ovp/cards/CommonUtils","sap/ui/Device","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/base/util/deepEqual","sap/base/util/merge","sap/ovp/cards/ovpLogger"],function(C,J,O,s,P,S,M,F,a,b,L,V,c,I,d,D,B,e,f,g,h,k,m,o){"use strict";var l=new o("OVP.rta.SettingDialog");return C.extend("sap.ovp.cards.rta.SettingsDialog",{_oCardManifestSettings:{},_aRefreshNotRequired:S._aRefreshNotRequired,_aRefreshRequired:S._aRefreshRequired,_updateManifestProperties:S._updateManifestProperties,aVariantNames:S.aVariantNames,oOvpResourceBundle:g,oMandatoryPropertiesKey:S.oMandatoryPropertiesKey,onInit:function(){s.oSaveButton.attachPress(this.onSaveButtonPress,this);s.oResetButton.attachPress(this.onResetButton,this);s.oMessagePopOverButton.attachPress(this.handleMessagePopoverPress,this);},onAfterRendering:function(){s.dialogBox.addStyleClass("sapOvpSettingsDialogBox");this.setEnablePropertyForResetAndSaveButton(false);this._oCardManifestSettings=this.getView().getModel().getData();this._oOriginalCardManifestSettings=m({},this._oCardManifestSettings);var v=this.getView(),i=v.getModel();if(!this._oCardManifestSettings.addNewCard){var j=v.byId("dialogCard");if(!j.getVisible()){j=v.byId("dialogCardNoPreview");}j.getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+"px";v.byId("dialogCardOverlay").getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+"px";s.settingFormWidth(v,"calc(100% - "+(this._oCardManifestSettings.dialogBoxWidth+1)+"rem)");setTimeout(function(){var j=this.getView().byId("dialogCard");if(j.getVisible()){j.setBusy(false);}}.bind(this),2000);}if(this._oCardManifestSettings.staticContent){this.handleErrorHandling(i,"title","/staticContent");this.handleErrorHandling(i,"targetUri","/staticContent");}if(s.bNewKPICardFlag){var n=v.getModel();var p=v.byId("sapOvpKPITable").getBinding("items").getLength();n.setProperty("/NoOfKPIItem",p);n.setProperty("/NoKPI",p);}},validateInputField:function(E){var i=E.getSource();var j=i.getValue().trim().length;if(!j){i.setValue(i.getValue().trim());}if(!this._oCardManifestSettings.addNewCard){this.updateCard(E);}else{this.setEnablePropertyForResetAndSaveButton(true);}},addView:function(E){this._oCardManifestSettings.showViewSwitchButton=true;this.setEnablePropertyForResetAndSaveButton(true);var i,j=this._oCardManifestSettings,n=this.getView().getModel();if(!j.addNewCard){if(j.dataPointAnnotationPath&&j.dataPoint&&j.dataPoint.length){i=j.dataPoint[0].value;}}if(j.tabs&&j.tabs.length){j.newViewCounter++;if(!j.addNewCard){if(j.template==="sap.ovp.cards.charts.analytical"||j.template==="sap.ovp.cards.charts.smart.chart"){j.tabs.push({chartAnnotationPath:j.chart[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter)});}else{j.tabs.push({annotationPath:j.lineItem[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter)});}}else{j.tabs.push({entitySet:"",value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter)});}var p=j.tabs.length;j.aViews.push({text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter),key:p,isLaterAddedView:true,isViewResetEnabled:false});if(!j.addNewCard){var q=j.defaultViewSelected;if(j.tabs[q-1].entitySet){j.tabs[p-1].entitySet=j.allEntitySet[0].value;}}this.selectViewSwitch(E,p);}else{j.tabs=[{}];S.tabFields.forEach(function(t){if(!j.addNewCard){if(t!=='entitySet'){j.tabs[0][t]=j[t];}}else{j.tabs[0][t]=j[t];}});j.tabs[0].value=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 1");if(!j.addNewCard){if(j.template==="sap.ovp.cards.charts.analytical"||j.template==="sap.ovp.cards.charts.smart.chart"){j.tabs.push({chartAnnotationPath:j.chart[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}else{j.tabs.push({annotationPath:j.lineItem[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}}else{j.tabs.push({entitySet:"",value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}j.selectedKey=1;j.defaultViewSelected=1;j.aViews=[{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_MAIN_VIEW"),key:0,isLaterAddedView:false,isViewResetEnabled:false},{text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 1 ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")"),key:1,initialSelectedKey:1,isLaterAddedView:false,isViewResetEnabled:false},{text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2"),key:2,isLaterAddedView:true,isViewResetEnabled:false}];j.newViewCounter=2;this.selectViewSwitch(E,1);}this.handleErrorHandling(n,"value","/tabs");},deleteView:function(E){this.setEnablePropertyForResetAndSaveButton(true);var i=this._oCardManifestSettings,j=parseInt(i.selectedKey,10),n=this.getView().getModel();i.tabs.splice(j-1,1);i.aViews.splice(j,1);if(j===i.defaultViewSelected){i.defaultViewSelected=1;i.aViews[j].text=i.aViews[j].text+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}i.aViews.forEach(function(v,p){if(p>=j){v.key--;}});this.handleErrorHandling(n,"value","/tabs");if(i.tabs.length==1){S.tabFields.forEach(function(t){var v=i.tabs[0][t];if(t!=='entitySet'||(t==='entitySet'&&v)){i[t]=v;}});delete i.selectedKey;delete i.defaultViewSelected;delete i.tabs;delete i.aViews;i.aViews=[{text:this.oOvpResourceBundle.getText("OVP_KEYUSER_SHOWS_DIFFERENT_VIEWS"),key:0,initialSelectedKey:0,isLaterAddedView:false,isViewResetEnabled:false}];s.addManifestSettings(i);s.setVisibilityForFormElements(i);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!i.addNewCard){this._fCardWithRefresh();}}else{i.selectedKey=1;this.selectViewSwitch(E,i.selectedKey);}},resetView:function(){var i=this._oCardManifestSettings,j=this.getView().getModel(),n=parseInt(i.selectedKey,10),p=i.aViews[n],q=i.defaultViewSelected;if(!p.isLaterAddedView){var r=i.dataPointAnnotationPath?true:false,t=this._oOriginalCardManifestSettings.dataPointAnnotationPath?true:false;if(n){var u=i.aViews[n].initialSelectedKey;S.tabFields.forEach(function(w){if(w!=="dataPointAnnotationPath"||r){if(this._oOriginalCardManifestSettings.tabs&&this._oOriginalCardManifestSettings.tabs.length){var x=this._oOriginalCardManifestSettings.tabs[u-1][w];if(w!=='entitySet'||(w==='entitySet'&&x)){i[w]=x;i.tabs[n-1][w]=i[w];}}else{if(w!=='entitySet'){i[w]=this._oOriginalCardManifestSettings[w];i.tabs[n-1][w]=i[w];}}}}.bind(this));if(!this._oOriginalCardManifestSettings.tabs||!this._oOriginalCardManifestSettings.tabs.length){i.newViewCounter++;i.tabs[n-1].value=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter);}if(n===i.defaultViewSelected){i.aViews[n].text=i.tabs[n-1].value+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}else{i.aViews[n].text=i.tabs[n-1].value;}}else{S.mainFields.forEach(function(w){i[w]=this._oOriginalCardManifestSettings[w];}.bind(this));if(r!==t){if(t){i.tabs.forEach(function(w){if(w.prevDataPointAnnotationPath){w.dataPointAnnotationPath=w.prevDataPointAnnotationPath;}else{w.dataPointAnnotationPath=i.dataPoint[0].value;}});i.dataPointAnnotationPath=i.tabs[q].dataPointAnnotationPath;}else{i.tabs.forEach(function(w){w.prevDataPointAnnotationPath=w.dataPointAnnotationPath;w.dataPointAnnotationPath=undefined;});}}}}else{var v;if(i.dataPointAnnotationPath){v=i.dataPoint[0].value;}i.newViewCounter++;if(i.template==="sap.ovp.cards.charts.analytical"||i.template==="sap.ovp.cards.charts.smart.chart"){i.tabs[n-1]={chartAnnotationPath:i.chart[0].value,dataPointAnnotationPath:v,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter)};}else{i.tabs[n-1]={annotationPath:i.lineItem[0].value,dataPointAnnotationPath:v,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter)};}if(n===i.defaultViewSelected){i.aViews[n].text=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")");}else{i.aViews[n].text=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter);}S.tabFields.forEach(function(w){var x=i.tabs[n-1][w];if(w!=='entitySet'||(w==='entitySet'&&x)){i[w]=x;}});}this.handleErrorHandling(j,"value","/tabs");i.isViewResetEnabled=false;i.aViews[n].isViewResetEnabled=false;s.addManifestSettings(i);s.setVisibilityForFormElements(i);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!i.addNewCard){this._fCardWithRefresh();}},selectViewSwitch:function(E,i){var j=this._oCardManifestSettings,n=this.getView().getModel();if(!i){i=E.getSource().getSelectedIndex();}if(this.defaultViewSwitch){this.defaultViewSwitch.setEnabled(true);}this.setEnablePropertyForResetAndSaveButton(true);var p=j.metaModel,q,r=j.defaultViewSelected;if(!i){j.selectedKey=i;j.mainViewSelected=true;j.isViewResetEnabled=j.aViews[i].isViewResetEnabled;S.tabFields.forEach(function(v){var w=j.tabs[r-1][v];if(v!=='entitySet'||(v==='entitySet'&&w)){j[v]=w;}});this.handleErrorHandling(n,"value","/tabs");if(j.tabs[r-1].entitySet){q=p.getODataEntitySet(j.tabs[r-1].entitySet);j.entityType=p.getODataEntityType(q.entityType);this.resetSupportingObjectsOnEntitySetChange(j,r);}s.addManifestSettings(j);s.setVisibilityForFormElements(j);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!j.addNewCard){this._fCardWithRefresh();}}else{j.mainViewSelected=false;j.isViewResetEnabled=j.aViews[i].isViewResetEnabled;if(!j.addNewCard){var t=this.getView().byId("dialogCard");if(t.getVisible()){var R=t.getComponentInstance().getRootControl();var u=R.getController();u.changeSelection(i,true,j);this.handleErrorHandling(n,"value","/tabs");if(j.tabs[i-1].entitySet){q=p.getODataEntitySet(j.tabs[i-1].entitySet);j.entityType=p.getODataEntityType(q.entityType);this.resetSupportingObjectsOnEntitySetChange(j,r);}s.addManifestSettings(j);s.setVisibilityForFormElements(j);S.tabFields.forEach(function(v){var w=j.tabs[i-1][v];if(v!=='entitySet'||(v==='entitySet'&&w)){j[v]=w;}});if(!!j.kpiAnnotationPath){this.setAnnotationPathInModel(j,"sapOvpSettingsKPIAnnotation",j.kpiAnnotationPath);}if(!!j.selectionPresentationAnnotationPath){this.setAnnotationPathInModel(j,"sapOvpSettingsFilterAndPresentedBy",j.selectionPresentationAnnotationPath);}this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();}}else{if(!!j.tabs[i-1].entitySet){q=p.getODataEntitySet(j.tabs[i-1].entitySet);j.entityType=p.getODataEntityType(q.entityType);s.addManifestSettings(j);}this.aVariantNames.forEach(function(v){if(this._oCardManifestSettings[v.sPath]){this._oCardManifestSettings[v.sPath]=[];}}.bind(this));this.resetSupportingObjectsOnEntitySetChange(j,r);j.selectedKey=i;S.tabFields.forEach(function(v){var w=j.tabs[i-1][v];j[v]=w;});s.setVisibilityForFormElements(j);this.getView().byId("sapOVPEntitySetList").setValue(j.tabs[i-1].entitySet);this.getView().getModel().refresh();this.getView().getModel("visibility").refresh();}}},resetSupportingObjectsOnEntitySetChange:function(i,j){i=s.addSupportingObjects(i);var n=i.defaultViewSelected;if(n){i.aViews[n].text=i.tabs[n-1].value;}i.aViews[j].text+=" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";i.defaultViewSelected=j;},setAnnotationPathInModel:function(i,j,n){if(i.entityType[n]){this.setVariant(i,n);}if(j==="sapOvpSettingsKPIAnnotation"){s.addKPINavApplicationName(i);}},setCurrentActivePageForCarouselCard:function(i){var j=this.getView().byId("dialogCard");if(j.getVisible()){var n=j.getComponentInstance(),r=n.getRootControl(),p=r.byId("pictureCarousel");if(p){var q=p.getPages(),t=q[i];p.setActivePage(t);}}},onSelectionChange:function(E){var j=E.getSource(),n=j.getModel(),p=n.getData().staticContent,q=j.getSelectedItem(),r=q.getBindingContext().getObject(),v=j.getModel("visibility");for(var i=0;i<p.length;i++){if(p[i].id===r.id){v.setProperty("/moveToTheTop",!(p.length===1||i===0));v.setProperty("/moveUp",!(p.length===1||i===0));v.setProperty("/moveDown",!(p.length===1||i===(p.length-1)));v.setProperty("/moveToTheBottom",!(p.length===1||i===(p.length-1)));v.setProperty("/delete",true);n.setProperty("/selectedItemIndex",i);v.refresh(true);if(E.getParameter("listItem")){this.setCurrentActivePageForCarouselCard(i);}break;}}},handleErrorForProperty:function(i,p,j){i.firePropertyChange({context:i.getContext(j?j:"/"),path:p,value:i.getProperty(j?(j+"/"+p):p),reason:b.Change});},handleErrorHandling:function(j,p,n){var q=j.getProperty(n);j.firePropertyChange({context:j.getContext(n),path:n+","+p,value:j.getProperty(n),reason:b.Change});for(var i=0;i<q.length;i++){var r=n+"/"+i;j.firePropertyChange({context:j.getContext(r),path:p,value:j.getProperty(r+"/"+p),reason:b.Change});}},setEnablePropertyForResetAndSaveButton:function(E){s.enableResetButton(E);s.enableSaveButton(E);},getValueInRemString:function(v){return v+"rem";},_getSelectedItemIndex:function(i){return i.getProperty("/selectedItemIndex");},_getLastItemIndex:function(i){return this._getStaticContentArray(i).length-1;},_getStaticContentArray:function(i){return i.getProperty("/staticContent");},_setStaticContentArray:function(i,j){i.setProperty("/staticContent",j);},_setSelectedItemAndScrollToElement:function(i,H){var v=this.getView(),j=v.byId("sapOvpStaticLinkListLineItem"),n=v.byId("scrollContainer"),p=v.getModel();this.handleErrorHandling(p,"title","/staticContent");this.handleErrorHandling(p,"targetUri","/staticContent");var q=j.getItems()[i];if(H){this._oList=j;this._oItem=q;this._oScrollContainer=n;var r={onAfterRendering:function(E){this._oList.removeEventDelegate(this._oDelegateOnAfter);this._oScrollContainer.scrollToElement(this._oItem);delete this._oDelegateOnAfter;delete this._oList;delete this._oScrollContainer;delete this._oItem;}};this._oDelegateOnAfter=r;j.addEventDelegate(r,this);}else{n.scrollToElement(q);}j.setSelectedItem(q);j.fireSelectionChange();},_arrangeStaticContent:function(i,j,t){var n=this._getStaticContentArray(i);n.splice(t,0,n.splice(j,1)[0]);this._setStaticContentArray(i,n);this._setSelectedItemAndScrollToElement(t);},getIndexFromIdForStaticLinkList:function(i){var j=i.split("-");return j[j.length-1];},_getImageData:function(){var i=[];i.push({"Name":"AW.png","Image":L.formUrl(this.getView().getModel().getProperty("/baseUrl"),"img/AW.png")});return i;},_getIconData:function(j){var n=I.getIconNames(),p=[];if(j){var N=j.split("://")[1],q=n.indexOf(N);n.splice(q,1);p.push({"Name":N,"Icon":I.getIconURI(N)});}for(var i=0;i<n.length;i++){p.push({"Name":n[i],"Icon":I.getIconURI(n[i])});}return p;},_getLinkListItemId:function(i,j){return i.getProperty("/staticContent/"+j+"/index");},_makeLinkListItemId:function(i){return"linkListItem--"+i;},_makeLinkListItemIndex:function(i){return"Index--"+i;},getIconAndImageDataModel:function(i){var j=this._getIconData(i),n=this._getImageData();return new J({"Icons":j,"Images":n,"NoOfIcons":j.length,"NoOfImages":n.length});},destroyTemplatesAndObjects:function(){var v=this.getView();var t=v.byId("tableFilterImage");if(t){t.destroy();}var T=v.byId("tableFilter");if(T){T.destroy();}var i=v.byId("tableFilterLinks");if(i){i.destroy();}delete this._oEvent;delete this._iCurrentRow;delete this._oModel;delete this._oVisibilityModel;delete this._oIconsDialogContentView;delete this._oLinksDialogContentView;delete this._oLineItemDialogContentView;delete this._oKPIItemDialogContentView;},onExternalUrlChange:function(E){this.setEnablePropertyForResetAndSaveButton(true);},onLinkSourceChange:function(E){var i=E.getSource(),j=i.getModel(),v=i.getModel("visibility"),n=this.getIndexFromIdForStaticLinkList(i.getId()),p=E.getParameter("selectedIndex"),q=v.getProperty("/staticLink"),r=v.getProperty("/links"),t=this._getLinkListItemId(j,parseInt(n,10));if(p===0){q[t]=false;r[t]=true;j.setProperty("/staticContent/"+n+"/targetUri",undefined);}else{q[t]=true;r[t]=false;j.setProperty("/staticContent/"+n+"/semanticObject",undefined);j.setProperty("/staticContent/"+n+"/action",undefined);j.setProperty("/staticContent/"+n+"/targetUri","");}v.setProperty("/staticLink",q);v.setProperty("/links",r);v.refresh(true);j.refresh(true);this.handleErrorForProperty(j,"targetUri","/staticContent/"+n);this.setEnablePropertyForResetAndSaveButton(true);},onRemoveVisualPress:function(E){var i=E.getSource(),j=i.getModel(),v=i.getModel("visibility"),n=this.getIndexFromIdForStaticLinkList(i.getId()),p=this._getLinkListItemId(j,parseInt(n,10)),r=v.getProperty("/removeVisual");r[p]=false;v.setProperty("/removeVisual",r);v.refresh(true);j.setProperty("/staticContent/"+n+"/imageUri",undefined);j.refresh(true);this.updateCard(E,"sapOvpSettingsStaticLinkListRemoveVisual");},createValueHelpDialogForInternalUrl:function(E){var i=E.getSource(),j=i.getModel(),n=i.getModel("staticCardProperties"),v=i.getModel("visibility"),p=this.getIndexFromIdForStaticLinkList(i.getId());this.attachBrowserHeightChangeHandler();this._oEvent=Object.assign({},E);this._iCurrentRow=p;this._oModel=j;this._oVisibilityModel=v;var q=new B("linksCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.linksDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_SELECT_APPLICATION_DIALOG"),buttons:[q]}).addStyleClass("sapOvpSettingsDialogBox");n.setProperty("/densityStyle",this.getDensityStyle());n.setProperty("/NoOfLinks",n.getProperty("/links").length);var r=new sap.ui.core.mvc.XMLView("linksDialogContent",{viewName:"sap.ovp.cards.rta.SelectLinks",type:d.XML,preprocessors:{xml:{bindingContexts:{tableRows:n.createBindingContext("/")},models:{tableRows:n}}}});r.setModel(n);r.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.linksDialog.addContent(r);r.loaded().then(function(t){this._oLinksDialogContentView=t;t.getController().updateLinkPath=function(u){var w=u.slice(1).split("-"),x=w[0],A=w[1];this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/semanticObject",x);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/action",A);this._oModel.refresh(true);this.setEnablePropertyForResetAndSaveButton(true);this.cleanAndCloseDialog(q);}.bind(this);q.attachPress(function(){this.cleanAndCloseDialog(q);}.bind(this));this.linksDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},onChangeVisualPress:function(E){var i=E.getSource(),j=i.getModel(),v=i.getModel("visibility"),n=this.getIndexFromIdForStaticLinkList(i.getId()),p=j.getProperty("/staticContent/"+n+"/imageUri"),N=L.isImageUrlStaticData(p);this.attachBrowserHeightChangeHandler();this._oEvent=Object.assign({},E);this._iCurrentRow=n;this._oModel=j;this._oVisibilityModel=v;var q=new B("iconsCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.iconsDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_SELECT_VISUAL_DIALOG"),buttons:[q]}).addStyleClass("sapOvpSettingsDialogBox");var r=(N)?this.getIconAndImageDataModel():this.getIconAndImageDataModel(p);r.setProperty("/densityStyle",this.getDensityStyle());var t=new sap.ui.core.mvc.XMLView("iconsDialogContent",{viewName:"sap.ovp.cards.rta.SelectIcons",type:d.XML,preprocessors:{xml:{bindingContexts:{tableRows:r.createBindingContext("/")},models:{tableRows:r}}}});r.setProperty("/tableName","IconTable");t.setModel(r);t.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.iconsDialog.addContent(t);t.loaded().then(function(u){this._oIconsDialogContentView=u;u.getController().updateIconPath=function(U){var w=this._getLinkListItemId(this._oModel,parseInt(this._iCurrentRow,10)),R=this._oVisibilityModel.getProperty("/removeVisual");R[w]=true;this._oVisibilityModel.setProperty("/removeVisual",R);this._oVisibilityModel.refresh(true);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/imageUri",U);this._oModel.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListChangeVisual");this.cleanAndCloseDialog(q);}.bind(this);q.attachPress(function(){this.cleanAndCloseDialog(q);}.bind(this));this.iconsDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},getDensityStyle:function(){if(!f.support.touch){return"compact";}else{return"cozy";}},cleanAndCloseDialog:function(i){if(this._oIconsDialogContentView){this._oIconsDialogContentView.destroy();}if(this._oLinksDialogContentView){this._oLinksDialogContentView.destroy();}if(this._oLineItemDialogContentView){this._oLineItemDialogContentView.destroy();}if(this._oKPIItemDialogContentView){this._oKPIItemDialogContentView.destroy();}this.destroyTemplatesAndObjects();if(this.iconsDialog){this.iconsDialog.close();}if(this.linksDialog){this.linksDialog.close();}if(this.lineItemDialog){this.lineItemDialog.close();}if(this.KPIItemDialog){this.KPIItemDialog.close();}i.destroy();this.detachBrowserHeightChangeHandler();},attachBrowserHeightChangeHandler:function(){f.resize.attachHandler(this.browserHeightChange,this);},detachBrowserHeightChangeHandler:function(){f.resize.detachHandler(this.browserHeightChange,this);},browserHeightChange:function(i){var j,n,p;if(this.iconsDialog&&this._oIconsDialogContentView){j=this.iconsDialog;n=this._oIconsDialogContentView;p="iconsScrollContainer";}else if(this.linksDialog&&this._oLinksDialogContentView){j=this.linksDialog;n=this._oLinksDialogContentView;p="linksScrollContainer";}else if(this.lineItemDialog&&this._oLineItemDialogContentView){j=this.lineItemDialog;n=this._oLineItemDialogContentView;p="lineItemScrollContainer";}else if(this.KPIItemDialog&&this._oKPIItemDialogContentView){j=this.KPIItemDialog;n=this._oKPIItemDialogContentView;p="KPIItemScrollContainer";}if(j&&n&&p){var q=j.getDomRef(),r=(i?(i.height*93)/100:s.dialogBox.getDomRef().getBoundingClientRect().height),t=q.getBoundingClientRect().height,H=Math.max(r,t)-(e.getPixelPerRem()*9),u=n.byId(p);u.setHeight(H+"px");}},handleMessagePopoverPress:function(E){s.oMessagePopOver.openBy(E.getSource());},onShowMorePress:function(E){var i=E.getSource(),j=i.getModel(),v=i.getModel("visibility"),n=this.getIndexFromIdForStaticLinkList(i.getId()),p=this._getLinkListItemId(j,parseInt(n,10)),q=v.getProperty("/showMore/"+p);if(q){v.setProperty("/showMore/"+p,false);}else{v.setProperty("/showMore/"+p,true);}v.refresh(true);},onPressDelete:function(E){this._oEvent=Object.assign({},E);M.confirm(this.oOvpResourceBundle.getText("OVP_KEYUSER_MESSAGE_BOX_INFORMATION_MESSAGE_INFO"),{actions:[M.Action.OK,M.Action.CANCEL],icon:M.Icon.INFORMATION,title:this.oOvpResourceBundle.getText("OVP_KEYUSER_MESSAGE_BOX_TITLE_INFO"),initialFocus:M.Action.CANCEL,onClose:function(A){if(A==="OK"){var i=this._oEvent.getSource(),v=i.getModel("visibility"),j=i.getModel(),n=this._getStaticContentArray(j),p=this._getSelectedItemIndex(j),q=this._getLinkListItemId(j,p),r=v.getProperty("/staticLink"),t=v.getProperty("/links"),R=v.getProperty("/removeVisual"),u=v.getProperty("/showMore");delete r[q];delete t[q];delete R[q];delete u[q];v.setProperty("/staticLink",r);v.setProperty("/links",t);v.setProperty("/removeVisual",R);v.setProperty("/showMore",u);n.splice(p,1);this._setStaticContentArray(j,n);j.refresh(true);if(n.length>0){this._setSelectedItemAndScrollToElement(Math.min(parseInt(p,10),n.length-1),true);}if(n.length<=1){v.setProperty("/delete",false);}v.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListDelete");}delete this._oEvent;}.bind(this)});},onPressAdd:function(E){var i=E.getSource(),v=i.getModel("visibility"),j=i.getModel(),n=this._getStaticContentArray(j),p=j.getProperty("/lineItemIdCounter"),q=this._makeLinkListItemId(p+1),r=this._makeLinkListItemIndex(p+1),t=v.getProperty("/staticLink"),u=v.getProperty("/links"),R=v.getProperty("/removeVisual"),w=v.getProperty("/showMore");j.setProperty("/lineItemIdCounter",p+1);n.unshift({"id":q,"index":r,"title":"Default Title","subTitle":"Default SubTitle","imageUri":"","imageAltText":"","targetUri":"","openInNewWindow":""});t[r]=true;u[r]=false;R[r]=false;w[r]=false;v.setProperty("/staticLink",t);v.setProperty("/links",u);v.setProperty("/removeVisual",R);v.setProperty("/showMore",w);v.refresh(true);this._setStaticContentArray(j,n);j.refresh(true);this._setSelectedItemAndScrollToElement(0);this.updateCard(E,"sapOvpSettingsStaticLinkListAdd");},onPressMoveToTheTop:function(E){var i=E.getSource().getModel();this._arrangeStaticContent(i,this._getSelectedItemIndex(i),0);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveUp:function(E){var i=E.getSource().getModel(),j=this._getSelectedItemIndex(i);this._arrangeStaticContent(i,j,j-1);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveDown:function(E){var i=E.getSource().getModel(),j=this._getSelectedItemIndex(i);this._arrangeStaticContent(i,j,j+1);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveToTheBottom:function(E){var i=E.getSource().getModel(),j=this._getSelectedItemIndex(i),n=this._getLastItemIndex(i);this._arrangeStaticContent(i,j,n);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onResetButton:function(){this._oCardManifestSettings=m({},this._oOriginalCardManifestSettings);var i=this.getView().getModel();i.setProperty("/",this._oCardManifestSettings);s.setVisibilityForFormElements(this._oCardManifestSettings);this.getView().getModel("visibility").refresh();if(this._oCardManifestSettings.layoutDetail==="resizable"){if(this._oCardManifestSettings.stopResizing){this.getView().byId("sapOvpSettingsStopResize").setState(false);}else if(!this._oCardManifestSettings.stopResizing){this.getView().byId("sapOvpSettingsStopResize").setState(true);}}s.resetErrorHandling();this.setEnablePropertyForResetAndSaveButton(false);if(!this._oCardManifestSettings.addNewCard){this._fCardWithRefresh();}},handleValueStateofComboBox:function(E,p,j,n){var q=s.oMessagePopOver.getModel(),r=q.getProperty("/Messages"),t=q.getProperty("/Counter/All"),u=q.getProperty("/Counter/Error");this.bError=true;var v=true;if(n){for(var i=0;i<r.length;i++){if(r[i].fieldName===p){v=false;}}if(v){r.push({"type":"Error","title":E,"fieldName":p,"counter":u+1});t++;u++;this.getView().byId(j).setValueState("Error");}}else{this.bError=false;for(var i=0;i<r.length;i++){if(r[i].fieldName===p){r.splice(i,1);t--;u--;i--;}}this.getView().byId(j).setValueState("None");}if(!r.length){this.setEnablePropertyForResetAndSaveButton(true);}q.setProperty("/Messages",r);q.setProperty("/Counter/All",t);q.setProperty("/Counter/Error",u);q.refresh(true);},validateComboBox:function(i,p,K){var E;if((p==="KPICheckBox"&&K&&i.entitySet)||(p==="entitySet"&&i.addKPIHeaderCheckBox)){if(i.title===""){E=g.getText("OVP_KEYUSER_INPUT_ERROR");this.handleValueStateofComboBox(E,h.Annotations.title,"sapOvpCardTitle",true);}else{this.handleValueStateofComboBox("",h.Annotations.title,"sapOvpCardTitle",false);}if(i.subTitle===""){E=g.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SUBTITLE");this.handleValueStateofComboBox(E,h.Annotations.subTitle,"sapOvpCardSubTitle",true);}else{this.handleValueStateofComboBox("",h.Annotations.subTitle,"sapOvpCardSubTitle",false);}if(i.valueSelectionInfo===""){E=g.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SELECTIONVALUEINFO");this.handleValueStateofComboBox(E,h.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",true);}else{this.handleValueStateofComboBox("",h.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",false);}if(i.dataPointAnnotationPath===""){E=g.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_DATAPOINT");this.handleValueStateofComboBox(E,h.Annotations.dataPoint,"sapOvpDataPoint",true);}else{this.handleValueStateofComboBox("",h.Annotations.dataPoint,"sapOvpDataPoint",false);}}else if(p==="entitySet"){E=g.getText("OVP_KEYUSER_INPUT_ERROR");this.handleValueStateofComboBox(E,h.Annotations.title,"sapOvpCardTitle",true);if(i.template==="sap.ovp.cards.linklist"){E=g.getText("OVP_KEYUSER_LISTFLAVOR_ERROR");this.handleValueStateofComboBox(E,h.Annotations.listFlavor,"sapOVPLinkListFlavor",true);}}else if(p==="KPICheckBox"&&!K&&i.entitySet){this.handleValueStateofComboBox("",h.Annotations.subTitle,"sapOvpCardSubTitle",false);this.handleValueStateofComboBox("",h.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",false);this.handleValueStateofComboBox("",h.Annotations.dataPoint,"sapOvpDataPoint",false);}else{if(p==="title"){this.onComboBoxSelection(i,p,"OVP_KEYUSER_INPUT_ERROR",h.Annotations.title,"sapOvpCardTitle");}if(p==="subTitle"){this.onComboBoxSelection(i,p,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SUBTITLE",h.Annotations.subTitle,"sapOvpCardSubTitle");}if(p==="valueSelectionInfo"){this.onComboBoxSelection(i,p,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SELECTIONVALUEINFO",h.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo");}if(p==="dataPointAnnotationPath"){this.onComboBoxSelection(i,p,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_DATAPOINT",h.Annotations.dataPoint,"sapOvpDataPoint");}if(p==="listFlavor"){this.onComboBoxSelection(i,p,"OVP_KEYUSER_LISTFLAVOR_ERROR",h.Annotations.listFlavor,"sapOVPLinkListFlavor");}}},onComboBoxSelection:function(i,p,t,j,n){var E;if(i[p]===""){E=g.getText(t);this.handleValueStateofComboBox(E,j,n,true);}else{this.handleValueStateofComboBox(E,j,n,false);}},onSaveButtonPress:function(){if(!this._oCardManifestSettings.addNewCard){if(s.bError||this.bError){s.oMessagePopOverButton.firePress();}else{this.createAndSubmitChange.bind(this)();}}else{this.createAndSubmitChange.bind(this)();}},onResizingChange:function(E){var i=E.getParameter("state");this._oCardManifestSettings.stopResizing=!i;this.updateCard(E);},onNumberOfRowsChanged:function(E){var r=+this._oCardManifestSettings.defaultSpan.rows;this._oCardManifestSettings.defaultSpan.rows=r;this._oCardManifestSettings.defaultSpan.showOnlyHeader=(r===0);this._oCardManifestSettings.cardLayout.showOnlyHeader=(r===0);var i=["sap.ovp.cards.list","sap.ovp.cards.table"];if(i.indexOf(this._oCardManifestSettings.template)!==-1){this._oCardManifestSettings.cardLayout.noOfItems=r;}else{this._oCardManifestSettings.cardLayout.rowSpan=r;}this.updateCard(E);},onNumberOfColumnsChanged:function(E){this._oCardManifestSettings.defaultSpan.cols=+this._oCardManifestSettings.defaultSpan.cols;this.updateCard(E);},setBusy:function(i){if(i){this.getView().addStyleClass("dialogContainerOverlay");var j=this.getView().byId("dialogCard");if(j.getVisible()&&j.getComponentInstance()){j.getComponentInstance().getRootControl().setBusy(i);}}else{this.getView().removeStyleClass("dialogContainerOverlay");setTimeout(function(){var j=this.getView().byId("dialogCard");if(j.getVisible()&&j.getComponentInstance()){j.getComponentInstance().getRootControl().setBusy(i);}}.bind(this),2000);}},_fCardWithoutRefresh:function(E,u){var v=this.getView(),i=this._oCardManifestSettings,j=v.byId("dialogCard").getComponentInstance(),r=j.getRootControl(),n=r.getController(),p=n.getCardPropertiesModel(),q,t,w=false,x;if(i.tabs&&i.tabs.length){w=true;x=parseInt(i.selectedKey,10);}if(u.formElementId==="sapOvpSettingsLineItemTitle"||u.formElementId==="sapOvpSettingsLineItemSubTitle"){q=r.byId(u.cardElementId+"--"+v.getModel().getProperty("/lineItemId"));}else{q=r.byId(u.cardElementId);if(!q){this._fCardWithRefresh(E,u.cardElementId);}}switch(u.formElementId){case"sapOvpSettingsLineItemTitle":case"sapOvpSettingsLineItemSubTitle":case"sapOvpSettingsTitle":case"sapOvpSettingsValueSelectionInfo":if(q){q.setText(E.getSource().getValue());}break;case"sapOvpSettingsSubTitle":p.setProperty("/subTitle",E.getSource().getValue());n._setSubTitleWithUnitOfMeasure();break;case"sapOvpSettingsViewName":var y=i.viewName;t=v.getModel();q.getItems()[x-1].setText(y);i.tabs[x-1].value=y;if(i.defaultViewSelected===x){y=y+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}i.aViews[x].text=y;t.refresh();break;case"sapOvpDefaultViewSwitch":if(E.getSource().getState()){var z=i.defaultViewSelected;t=v.getModel();i.defaultViewSelected=x;i.aViews[z].text=i.tabs[z-1].value;i.aViews[x].text+=" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";t.refresh();this.defaultViewSwitch=E.getSource();this.defaultViewSwitch.setEnabled(false);}break;case"sapOvpSettingsIdentification":if(w){i.tabs[x-1][u.updateProperty]=i[u.updateProperty];}break;case"sapOvpSettingsKPIHeaderSwitch":var A=v.getModel("visibility"),G=A.getData();G.dataPoint=false;G.valueSelectionInfo=false;if(w){i.tabs.forEach(function(K){K.prevDataPointAnnotationPath=K.dataPointAnnotationPath;K.dataPointAnnotationPath=undefined;});}else{var H=i.dataPointAnnotationPath;if(H){i.prevDataPointAnnotationPath=H;}i.dataPointAnnotationPath=undefined;}A.refresh(true);q.destroy();break;default:break;}},_fCardWithRefresh:function(E,u){var p,i,v,j,n,q=this._oCardManifestSettings,r=this.getView(),t=r.byId("dialogCard"),w=(!t.getComponentInstance())?undefined:t.getComponentInstance().getComponentData(),x=(!w)?"Dialog":w.cardId,y=(!w)?undefined:w.manifest.cards[x].model,z={cards:{}},A=false,G;if(q.tabs&&q.tabs.length){A=true;G=parseInt(q.selectedKey,10);}switch(u){case"subTitleSwitch":v=this.getView();j=v.getModel("visibility");if(E.getSource().getState()){if(A){i=q.defaultViewSelected;q.tabs.forEach(function(W){p=W.prevDynamicSubtitleAnnotationPath;if(p){W.dynamicSubtitleAnnotationPath=p;}else{W.dynamicSubtitleAnnotationPath=q.dynamicSubTitle[0].value;}});q.dynamicSubtitleAnnotationPath=q.tabs[i-1].dynamicSubtitleAnnotationPath;}else{p=q.prevDynamicSubtitleAnnotationPath;if(p){q.dynamicSubtitleAnnotationPath=p;}else{q.dynamicSubtitleAnnotationPath=q.dynamicSubTitle[0].value;}}if(w.template!=='sap.ovp.cards.linklist'){r.byId("sapOvpSettingsDynamicSubTitle").setSelectedKey(q.dynamicSubtitleAnnotationPath);}}else{if(A){q.tabs.forEach(function(W){W.prevDynamicSubtitleAnnotationPath=W.dynamicSubtitleAnnotationPath;W.dynamicSubtitleAnnotationPath=undefined;});q.dynamicSubtitleAnnotationPath=undefined;}else{var H=q.dynamicSubtitleAnnotationPath;if(H){q.prevDynamicSubtitleAnnotationPath=H;}q.dynamicSubtitleAnnotationPath=undefined;}}j.setProperty("/subTitle",s.getVisibilityOfElement(q,"subTitle",A));j.setProperty("/dynamicSubTitle",s.getVisibilityOfElement(q,"dynamicSubTitle",A)&&!!q["dynamicSubTitle"]&&!!q["dynamicSubTitle"].length);j.refresh(true);break;case"kpiHeader":v=this.getView();j=v.getModel("visibility");n=j.getData();n.valueSelectionInfo=true;n.dataPoint=true;if(q.tabs&&q.tabs.length){n.dataPoint=s.getVisibilityOfElement(q,"dataPoint",true);}if(!q.valueSelectionInfo){q.valueSelectionInfo=" ";}if(A){i=q.defaultViewSelected;q.tabs.forEach(function(W){p=W.prevDataPointAnnotationPath;if(p){W.dataPointAnnotationPath=p;}else{W.dataPointAnnotationPath=q.dataPoint[0].value;}});q.dataPointAnnotationPath=q.tabs[i-1].dataPointAnnotationPath;}else{p=q.prevDataPointAnnotationPath;if(p){q.dataPointAnnotationPath=p;}else{q.dataPointAnnotationPath=q.dataPoint[0].value;}}j.refresh(true);break;case"listType":q[u]=(E.getSource().getState())?"extended":"condensed";break;case"listFlavor":q[u]=(E.getSource().getState())?"bar":"";break;case"entitySet":if(A){q.tabs[G-1][u]=q[u];S.resetTabFields.forEach(function(W){delete q.tabs[G-1][W];delete q[W];});var K=q.metaModel,N=K.getODataEntitySet(q.tabs[G-1].entitySet),Q=q.defaultViewSelected;q.entityType=K.getODataEntityType(N.entityType);this.resetSupportingObjectsOnEntitySetChange(q,Q);}break;case"kpiAnnotationPath":if(A){q.tabs[G-1][u]=q[u];}var R=r.byId("sapOvpSettingsKPIAnnotation").getSelectedKey();if(q.entityType[R]){this.setVariant(q,R);}s.addKPINavApplicationName(q);this.getView().getModel().refresh(true);break;case"selectionPresentationAnnotationPath":if(A){q.tabs[G-1][u]=q[u];}var R=r.byId("sapOvpSettingsFilterAndPresentedBy").getSelectedKey();if(q.entityType[R]){this.setVariant(q,R);}this.getView().getModel().refresh(true);break;case"listFlavorForLinkList":case"annotationPath":case"chartAnnotationPath":case"presentationAnnotationPath":case"selectionAnnotationPath":case"dynamicSubtitleAnnotationPath":case"dataPointAnnotationPath":if(A){q.tabs[G-1][u]=q[u];}break;case"noOfRows":case"ovpHeaderTitle":case"add":case"removeVisual":case"changeVisual":case"sort":case"delete":break;default:break;}z.cards[x]={settings:q};if(s.bNewKPICardFlag){z.cards[x].template=q.template;}else{z.cards[x].template=w.template;}if(s.bNewKPICardFlag){if(y&&r.getModel(y)){r.getModel(y).destroy();r.setModel(null,y);}var T=this._oCardManifestSettings.selectedKPI,U=new sap.ui.model.odata.v2.ODataModel(T.ODataURI,{'annotationURI':T.ModelURI,'defaultCountMode':sap.ui.model.odata.CountMode.None});y=e._getLayerNamespace()+".kpi_card_model_"+s.getTrimmedDataURIName(T.ODataURI);r.setModel(U,y);}if(!!y){z.cards[x].model=y;}if(s.bNewKPICardFlag){U.getMetaModel().loaded().then(function(){var W=O.createCardComponent(r,z,"dialogCard");W.then(function(){r.setBusy(false);this.setBusy(false);}.bind(this)).catch(function(){s.setErrorMessage(z.cards[x].settings,"OVP_KEYUSER_ANNOTATION_FAILURE");s.createErrorCard(r,z,x);});}.bind(this),function(W){l.error(W);this.setBusy(false);r.setBusy(false);}.bind(this));U.attachMetadataFailed(function(){s.setErrorMessage(z.cards[x].settings,"OVP_KEYUSER_METADATA_FAILURE");s.createErrorCard(r,z,x);});}else{this.createCard(r,z);}},setVariant:function(i,j){var n=i.entityType[j];var p=n.SelectionVariant&&n.SelectionVariant.Path;if(/^@/.test(p)){p=p.slice(1);}i.selectionAnnotationPath=p;var q;if(j.indexOf(".KPI")!==-1){q=n.Detail&&n.Detail.DefaultPresentationVariant&&n.Detail.DefaultPresentationVariant.Path;}else if(j.indexOf(".SelectionPresentationVariant")!==-1){q=n.PresentationVariant&&n.PresentationVariant.Path;}if(/^@/.test(q)){q=q.slice(1);}i.presentationAnnotationPath=q;var v=i.entityType[i.presentationAnnotationPath]&&i.entityType[i.presentationAnnotationPath].Visualizations;for(var r=0;r<v.length;r++){var t=v[r].AnnotationPath;if(t){if(/^@/.test(t)){t=t.slice(1);}if(/.Chart/.test(t)){i.chartAnnotationPath=t;break;}}}},createCard:function(i,j){this.setBusy(true);var p=O.createCardComponent(i,j,"dialogCard");p.then(function(){this.setBusy(false);var n=this.getView().byId("sapOvpStaticLinkListLineItem");if(n){var q=n.getSelectedItem();if(q){var r=q.getId(),t=this.getIndexFromIdForStaticLinkList(r);this.setCurrentActivePageForCarouselCard(t);}}}.bind(this));p.catch(function(){this.setBusy(false);}.bind(this));},updateCard:function(E,n){var p=this._oCardManifestSettings,q=this.getView().byId("dialogCard");this.setEnablePropertyForResetAndSaveButton(true);if(q.getVisible()){if(p.tabs&&p.tabs.length){var r=parseInt(p.selectedKey,10);p.isViewResetEnabled=true;p.aViews[r].isViewResetEnabled=true;}var t=E.getSource(),u=(n)?n:t.getId(),v=false;if(u.indexOf("sapOvpStaticLinkListLineItem")!==-1){var w=t.getModel(),x=w.getData().staticContent,y=this.getIndexFromIdForStaticLinkList(u);this.setCurrentActivePageForCarouselCard(y);w.setProperty("/lineItemId",x[y].id);if(u.indexOf("sapOvpSettingsLineItemTitle")!==-1){u="sapOvpSettingsLineItemTitle";}else if(u.indexOf("sapOvpSettingsLineItemSubTitle")!==-1){u="sapOvpSettingsLineItemSubTitle";}}for(var i=0;i<this._aRefreshNotRequired.length;i++){if(u.indexOf(this._aRefreshNotRequired[i].formElementId)>-1){if(this._aRefreshNotRequired[i].isKpiSwitch&&E.getSource().getState()){break;}this._fCardWithoutRefresh(E,this._aRefreshNotRequired[i]);v=true;break;}}if(!v){for(var j=0;j<this._aRefreshRequired.length;j++){if(u.indexOf(this._aRefreshRequired[j].formElementId)>-1){this.setBusy(true);this._fCardWithRefresh(E,this._aRefreshRequired[j].updateProperty);break;}}}var z=e._getLayer();if(z===h.Layers.vendor){for(var A in this.oMandatoryPropertiesKey){if(u.indexOf(this.oMandatoryPropertiesKey[A])>-1){var R=false,T=A+"Key",G=A+"Property";p[A]=E.getParameter("value");p[G]=E.getParameter("value");for(var A in p.ai18nProperties){if(p.ai18nProperties[A].value===E.getParameter("value")){p[T]=p.ai18nProperties[A].key;R=true;break;}}if(!R){p[T]="";}break;}}}}},onExit:function(){s.oSaveButton.detachPress(this.onSaveButtonPress,this);s.oResetButton.detachPress(this.onResetButton,this);s.oMessagePopOverButton.detachPress(this.handleMessagePopoverPress,this);},getListItems:function(){var i=[],j=this._oCardManifestSettings,n=this.getView(),p=n.byId("dialogCard"),q=p.getComponentInstance().getComponentData();var r=q.model.getMetaModel();var t=e.isODataV4(q.model);var u=t?"/"+j.entityType.$Type+"/@"+j.annotationPath:j.entityType.$path+"/"+j.annotationPath;var v=r.getContext(r.resolve(u,this.oView.getBindingContext()));var w=2,x=1,y=0;if(j.listFlavor==="bar"){w=1;x=2;}if(j.listType&&j.listType.toLowerCase()==="extended"){w=6;x=3;y=3;if(j.listFlavor==="bar"){w=5;}}else if(j.contentFragment==="sap.ovp.cards.table.Table"||j.contentFragment==="sap.ovp.cards.table.v4.Table"){w=3;x=1;y=1;}j.lineItem.forEach(function(z){var A=t?V.getSortedDataPoints(v,z.fields):c.getSortedDataPoints(v,z.fields);var E=t?V.getSortedDataFields(v,z.fields):c.getSortedDataFields(v,z.fields);var G=[],H=[],K=s.getQualifier(z.value);A.forEach(function(T){if(T.Title){var U=t?T.Title:T.Title.String;H.push(s.checkForEmptyString(U,""));}else{H.push(g.getText("OVP_KEYUSER_LABEL_DEFAULT_LABEL_WITH_QUALIFIER",[K]));}});E.forEach(function(T){if(T.Label){var U=t?T.Label:T.Label.String;G.push(U);}else{G.push(g.getText("OVP_KEYUSER_LABEL_DEFAULT_LABEL_WITH_QUALIFIER",[K]));}});var N=Math.min(H.length,x),Q=Math.min(y,N),R=G.slice(0,w-Q).concat(H.slice(0,N));R.map(function(T){return T.charAt(0).toUpperCase()+T.substr(1);});i.push({Value:z.value,Label:z.name,VisibleFields:R.toString()});});return i;},onSearch:function(E){var v=this.getView(),i=v.getModel(),j;this._filterTable(E,["GroupTitle","KPITitle","GroupID","KPIID","KPIQualifier"],"sapOvpKPITable");j=v.byId("sapOvpKPITable").getBinding("items").getLength();i.setProperty("/NoOfKPIItem",j);i.refresh(true);},_filterTable:function(E,j,n){var q=E.getParameter("query"),G=null,p=[];for(var i=0;i<j.length;i++){p.push(new F(j[i],a.Contains,q));}if(q){G=new F(p,false);}this.getView().byId(n).getBinding("items").filter(G,"Application");},onItemPress:function(E){this.getView().setBusy(true);this.getView().setBusyIndicatorDelay(0);var i=E.getSource(),j=i.getBindingContext(),K=j.getObject();this.getView().byId("sapOvpSettingsTitle").setValue(K.GroupTitle);this.getView().byId("sapOvpSettingsSubTitle").setValue(K.KPITitle);this.onKPIUpdate(K);this.updateCard(E,"sapOvpSettingsNewKPICard");},onKPIUpdate:function(K){this._oCardManifestSettings.entitySet=K.ODataEntityset;this._oCardManifestSettings.kpiAnnotationPath="com.sap.vocabularies.UI.v1.KPI#"+K.KPIQualifier;this._oCardManifestSettings.title=K.GroupTitle;this._oCardManifestSettings.subTitle=K.KPITitle;this._oCardManifestSettings.template="sap.ovp.cards.charts.analytical";this._oCardManifestSettings.selectedKPI=K;},onSeePress:function(){this.attachBrowserHeightChangeHandler();var i=new B("KPIItemCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.KPIItemDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_KPI_DIALOG_TITLE"),buttons:[i]}).addStyleClass("sapOvpSettingsDialogBox");var r=new J({"KPIItem":this._oCardManifestSettings.KPIData});r.setProperty("/densityStyle",this.getDensityStyle());r.setProperty("/NoOfKPIItem",r.getProperty("/KPIItem").length);var K=new sap.ui.core.mvc.XMLView("KPIItemDialogContent",{viewName:"sap.ovp.cards.rta.SelectKPI",type:d.XML,preprocessors:{xml:{bindingContexts:{tableRows:r.createBindingContext("/")},models:{tableRows:r}}}});K.setModel(r);K.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.KPIItemDialog.addContent(K);K.loaded().then(function(v){this._oKPIItemDialogContentView=v;v.getController().updateKPIItemPath=function(j,E){this.getView().setBusy(true);this.getView().setBusyIndicatorDelay(0);this.getView().byId("sapOvpSettingsTitle").setValue(j.GroupTitle);this.getView().byId("sapOvpSettingsSubTitle").setValue(j.KPITitle);this.onKPIUpdate(j);this.updateCard(E,"sapOvpSettingsNewKPICard");this.cleanAndCloseDialog(i);}.bind(this);i.attachPress(function(){this.cleanAndCloseDialog(i);}.bind(this));this.KPIItemDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},openLineItemValueHelpDialog:function(E){this.attachBrowserHeightChangeHandler();this._oEvent=Object.assign({},E);var i=new B("lineItemCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.lineItemDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LINEITEM_ANNO"),buttons:[i]}).addStyleClass("sapOvpSettingsDialogBox");var r=new J({"lineItem":this.getListItems()});r.setProperty("/densityStyle",this.getDensityStyle());r.setProperty("/NoOfLineItem",r.getProperty("/lineItem").length);var j=new sap.ui.core.mvc.XMLView("lineItemDialogContent",{viewName:"sap.ovp.cards.rta.SelectLineItem",type:d.XML,preprocessors:{xml:{bindingContexts:{tableRows:r.createBindingContext("/")},models:{tableRows:r}}}});j.setModel(r);j.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.lineItemDialog.addContent(j);j.loaded().then(function(v){this._oLineItemDialogContentView=v;v.getController().updateLineItemPath=function(n){var p=n.Value,q=this._oCardManifestSettings,t;if(q.tabs&&q.tabs.length){t=parseInt(q.selectedKey,10);}q.lineItemQualifier=s.getQualifier(p);q.annotationPath=p;if(q.tabs&&q.tabs.length){q.tabs[t-1].annotationPath=q.annotationPath;}this.getView().byId("sapOvpSettingsLineItem").setValue(n.Label);this._fCardWithRefresh(this._oEvent,"annotationPath");this.setEnablePropertyForResetAndSaveButton(true);if(q.tabs&&q.tabs.length){q.isViewResetEnabled=true;q.aViews[t].isViewResetEnabled=true;}this.cleanAndCloseDialog(i);}.bind(this);i.attachPress(function(){this.cleanAndCloseDialog(i);}.bind(this));this.lineItemDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},createAndSubmitChange:function(){var p;if(s.bNewStaticLinkListCardFlag){p=P.getPayLoadForNewStaticLinkListCard.bind(this)(s);}else if(s.bNewKPICardFlag){p=P.getPayLoadForNewKPICard.bind(this)(s);}else if(s.bAddNewCardFlag){p=P.getPayLoadForNewCard.bind(this)(s);}else{p=P.getPayLoadForEditCard.bind(this)(s);}this.settingsResolve(p);s.dialogBox.close();},setMandatoryFieldState:function(v,i){i.setProperty("/dataPoint",v);i.setProperty("/valueSelectionInfo",v);i.setProperty("/requiredSubTitle",v);var j=i.getData(),n=false;for(var p=0;p<s.aVisiblePropertiesForAnnotation.length;p++){if(j[s.aVisiblePropertiesForAnnotation[p].sProperty]){n=true;break;}}i.setProperty("/setAnnotationCardProperties",n);},EnableKPIHeaderFields:function(i){var v=this.getView().getModel("visibility");if(!i){this.setMandatoryFieldState(false,v);}else{this.setMandatoryFieldState(true,v);}},onCardTypeSelected:function(E){var i=E.getParameters().id;this._oCardManifestSettings.template=E.getSource().getSelectedKey();this.getView().byId("sapOVPAddKpiCheckBoxID").setSelected(false);this.getView().byId("sapOVPAddODataSelect").setSelected(false);this._oCardManifestSettings.addKPIHeaderCheckBox=false;this.EnableKPIHeaderFields(this._oCardManifestSettings.addKPIHeaderCheckBox);this.resetPropertiesVisibility(i,this._oCardManifestSettings);},onDatasourceComboboxChanged:function(E){var j=E.getParameters().id;this._oCardManifestSettings.model=E.getParameters().value;this._oCardManifestSettings.allEntitySet="";if(!s.newDataSource){var n=this._oCardManifestSettings.datasources;for(var i=0;i<n.length;i++){if(n[i].Title===this._oCardManifestSettings.model){this._oCardManifestSettings.metaModel=n[i].oMetaModel;}}s.addSupportingObjects(this._oCardManifestSettings);if(this._oCardManifestSettings.allEntitySet.length===0){this._oCardManifestSettings.model="";this.resetPropertiesVisibility(j,this._oCardManifestSettings);var p=g.getText("OVP_KEYUSER_NO_RELEVANT_ANNOTATION");this.handleValueStateofComboBox(p,"datasSourceExisting","sapOVPDataSourceExistingComboBox",true);}else{this.handleValueStateofComboBox("","datasSourceExisting","sapOVPDataSourceExistingComboBox",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);}}else{var q=this._oCardManifestSettings.datasources.filter(function(r){return r.Title===this._oCardManifestSettings.model;}.bind(this));getMetaModelForNewDataSource(q,s.sApplicationId).then(function(r){if(r){s.newDataSourceModel=r.modelInformation;r.getODataEntityContainer=function(){return r.oEntityContainers;};r.getObject=function(t){return r.oSchema;};r.getODataEntityType=function(t){var u=r.oSchema[0].entityType.filter(function(v){var w=t.substr((r.oEntityContainers.namespace+".").length);return v.name===w;});return u[0];};this._oCardManifestSettings.metaModel=r;s.addSupportingObjects(this._oCardManifestSettings);if(this._oCardManifestSettings.allEntitySet.length===0){this._oCardManifestSettings.model="";this.resetPropertiesVisibility(j,this._oCardManifestSettings);var p=g.getText("OVP_KEYUSER_NO_RELEVANT_ANNOTATION");this.handleValueStateofComboBox(p,"datasSourceNew","sapOVPDataSourceNewInput",true);}else{this.handleValueStateofComboBox("","datasSourceNew","sapOVPDataSourceNewInput",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);}}else{this._oCardManifestSettings.model="";this.resetPropertiesVisibility(j,this._oCardManifestSettings);var p=g.getText("OVP_KEYUSER_UNAVAILABLE_DATASOURCE");this.handleValueStateofComboBox(p,"datasSourceNew","sapOVPDataSourceNewInput",true);}}.bind(this));}},onEntitySetChanged:function(E,j){var n=this._oCardManifestSettings.metaModel.getObject('/dataServices/schema')[0].entityType;this.aVariantNames.forEach(function(v){if(this._oCardManifestSettings[v.sPath]){this._oCardManifestSettings[v.sPath]=[];}}.bind(this));for(var i in n){if(n[i].name===E){this._oCardManifestSettings.entityType=n[i];break;}}s.addSupportingObjects(this._oCardManifestSettings);this.getView().byId("sapOVPAddODataSelect").setSelected(false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);},addStaticParameterRow:function(){var i=this.getView().getModel();var j=i.getProperty("/aAllStaticParameters");if(j&&j.length){j.push({key:"",value:""});}else{j=[];j.push({key:"",value:""});}i.setProperty("/aAllStaticParameters",j);},addActionRow:function(){var i=this.getView().getModel();var j=i.getProperty("/objectStreamCardsSettings/customActions");if(j&&j.length){j.push({text:"",press:"",position:""});}else{j=[];j.push({text:"",press:"",position:""});}i.setProperty("/objectStreamCardsSettings/customActions",j);},onParameterDelete:function(E){var i=this.getView().getModel();var j=i.getProperty("/aAllStaticParameters");var n=E.getSource().getBindingContext().getObject()&&E.getSource().getBindingContext().getObject()["key"];j=j.filter(function(p){return p["key"]!=n;});i.setProperty("/aAllStaticParameters",j);if(!k(this._oCardManifestSettings.staticParameters,this._oOriginalCardManifestSettings.staticParameters)){this.setEnablePropertyForResetAndSaveButton(true);}this.getView().getModel().refresh();},onActionDelete:function(E){var i=this.getView().getModel();var j=i.getProperty("/objectStreamCardsSettings/customActions");var n=E.getSource().getBindingContext().getObject()&&E.getSource().getBindingContext().getObject()["text"];j=j.filter(function(p){return p["text"]!=n;});i.setProperty("/objectStreamCardsSettings/customActions",j);if(!k(this._oCardManifestSettings.objectStreamCardsSettings,this._oOriginalCardManifestSettings.objectStreamCardsSettings)){this.setEnablePropertyForResetAndSaveButton(true);}},updateProperty:function(E){var j=E.getSource().getId();var n=false,p;if(this._oCardManifestSettings.tabs&&this._oCardManifestSettings.tabs.length){n=true;p=parseInt(this._oCardManifestSettings.selectedKey,10);this._oCardManifestSettings.isViewResetEnabled=true;this._oCardManifestSettings.aViews[p].isViewResetEnabled=true;}for(var i=0;i<this._updateManifestProperties.length;i++){if(j.indexOf(this._updateManifestProperties[i].formElementId)>-1){var q=this._updateManifestProperties[i].formElement;switch(q){case"entitySet":var r=E.getSource().getSelectedKey();if(!n){this._oCardManifestSettings["entitySet"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[p-1]["entitySet"]=E.getParameter("value");}this.onEntitySetChanged(r,j);if(this._oCardManifestSettings["entitySet"].length!==0){this.validateComboBox(this._oCardManifestSettings,"entitySet");}break;case"identificationAnnotationPath":if(!n){this._oCardManifestSettings["identificationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[p-1]["identificationAnnotationPath"]=E.getParameter("value");}break;case"selectionPresentationAnnotationPath":if(!n){this._oCardManifestSettings["selectionPresentationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[p-1]["selectionPresentationAnnotationPath"]=E.getParameter("value");}break;case"selectionAnnotationPath":if(!n){this._oCardManifestSettings["selectionAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[p-1]["selectionAnnotationPath"]=E.getParameter("value");}break;case"presentationAnnotationPath":if(!n){this._oCardManifestSettings["presentationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[p-1]["presentationAnnotationPath"]=E.getParameter("value");}break;case"annotationPath":if(!n){this._oCardManifestSettings["annotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[p-1]["annotationPath"]=E.getParameter("value");}break;case"listType":this._oCardManifestSettings.listType=E.getSource().getSelectedKey();break;case"listFlavor":this._oCardManifestSettings.listFlavor=E.getSource().getSelectedKey();if(j.indexOf("sapOVPLinkListFlavor")!==-1){this.validateComboBox(this._oCardManifestSettings,"listFlavor");}break;case"KPICheckBox":this._oCardManifestSettings.addKPIHeaderCheckBox=E.getParameter("selected");this.EnableKPIHeaderFields(this._oCardManifestSettings.addKPIHeaderCheckBox);this.validateComboBox(this._oCardManifestSettings,"KPICheckBox",this._oCardManifestSettings.addKPIHeaderCheckBox);break;case"dataPointAnnotationPath":if(!n){this._oCardManifestSettings["dataPointAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[p-1]["dataPointAnnotationPath"]=E.getParameter("value");}this.validateComboBox(this._oCardManifestSettings,"dataPointAnnotationPath");break;case"addODataSelectCheckBox":this._oCardManifestSettings.addODataSelectCheckBox=E.getParameter("selected");break;case"requireAppAuthorization":this._oCardManifestSettings.requireAppAuthorization=E.getParameter("value");break;case"kpiAnnotationPath":if(!n){this._oCardManifestSettings["kpiAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[p-1]["kpiAnnotationPath"]=E.getParameter("value");}this._oCardManifestSettings.kpiAnnotationPath=E.getParameter("value");break;case"navigationPath":this._oCardManifestSettings.navigationPath=E.getParameter("value");break;case"title":case"subTitle":case"valueSelectionInfo":var R=false;var t=q+"Key";var u=q+"Property";this._oCardManifestSettings[q]=E.getParameter("value");this._oCardManifestSettings[u]=E.getParameter("value");for(var v in this._oCardManifestSettings.ai18nProperties){if(this._oCardManifestSettings.ai18nProperties[v].value===E.getParameter("value")){this._oCardManifestSettings[t]=this._oCardManifestSettings.ai18nProperties[v].key;R=true;break;}}if(!R){this._oCardManifestSettings[t]="";}this.validateComboBox(this._oCardManifestSettings,q);break;case"existingDatasSource":if(E.mParameters.selected){s.newDataSource=false;this._oCardManifestSettings.newDataSource=false;this.handleValueStateofComboBox("","datasSourceExisting","sapOVPDataSourceExistingComboBox",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);var w=this.getView().getModel();w.setProperty("/datasources",this._oCardManifestSettings.datasourcesFromManifest);}break;case"newDatasSource":if(E.mParameters.selected){s.newDataSource=true;this._oCardManifestSettings.newDataSource=true;this.handleValueStateofComboBox("","datasSourceNew","sapOVPDataSourceNewInput",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);this.getView().setBusy(true);getNewDataSources(s.sApplicationId).then(function(x){this.getView().setBusy(false);var y=x.results;var w=this.getView().getModel();w.setSizeLimit(y.length);w.setProperty("/datasources",y);}.bind(this));}break;default:break;}}}},resetPropertiesVisibility:function(E,i){if(E.indexOf("sapOVPExistingDataSource")!==-1||E.indexOf("sapOVPNewDataSource")!==-1){this._updateManifestProperties.forEach(function(p){if(!p.formElementId.includes("sapOVPExistingDataSource")&&!p.formElementId.includes("sapOVPNewDataSource")){if(p.formElementId.includes("sapOVPAddODataSelect")){i[p.formElement]=false;}else{i[p.formElement]="";}}});i.model="";}else if(E.indexOf("sapOVPDataSource")!==-1){this._updateManifestProperties.forEach(function(p){if(!p.formElementId.includes("sapOVPExistingDataSource")&&!p.formElementId.includes("sapOVPNewDataSource")&&!E.includes(p.formElementId)){if(p.formElementId.includes("sapOVPAddODataSelect")){i[p.formElement]=false;}else{i[p.formElement]="";}}});}else if(E.indexOf("sapOVPCardType")!==-1){this._updateManifestProperties.forEach(function(p){if(!(p.formElementId.includes("sapOVPDataSource")||p.formElementId.includes("sapOVPCardType"))){if(p.formElementId.includes("sapOVPAddODataSelect")){i[p.formElement]=false;}else{i[p.formElement]="";}}});}else if(E.indexOf("sapOVPEntitySetList")!==-1){var j=this.getView().getModel("visibility").getData().showViewSwitch;this._updateManifestProperties.forEach(function(p){if(!(p.formElementId.includes("sapOVPDataSource")||p.formElementId.includes("sapOVPCardType")||p.formElementId.includes("sapOVPEntitySetList"))){if(p.formElementId.includes("sapOVPAddODataSelect")){i[p.formElement]=false;}else{if(!j){i[p.formElement]="";}else{S.tabFields.forEach(function(n){if(n!=='entitySet'&&n!=='value'){i[n]="";}});}}}});}s.resetErrorHandling();this.setEnablePropertyForResetAndSaveButton(false);s.setVisibilityForFormElements(i);this.getView().getModel().refresh();this.getView().getModel("visibility").refresh();}});});
