sap.ui.define(["sap/ovp/cards/v4/generic/Card.controller","sap/ui/thirdparty/jquery","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/cards/CommonUtils","sap/m/List","sap/ui/core/ResizeHandler","sap/m/MessageToast","sap/m/Image","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/ovp/cards/ovpLogger","sap/ovp/cards/Filterhelper","sap/ui/util/openWindow"],function(C,q,O,a,L,R,M,I,b,c,o,F,d){"use strict";var f=27,g=8,h=8,l=8,m="ovpLinkList",P="pictureCarousel",n="ovpCardHeader",A="sapMCrslActive";var D={onBeforeRendering:function(e){this.itemOnBeforeRendering(e);}};var p={onAfterRendering:function(e){this.itemOnAfterRendering(e);}};var r=new o("OVP.v4.linklist.LinkList");return C.extend("sap.ovp.cards.v4.linklist.LinkList",{onInit:function(){C.prototype.onInit.apply(this,arguments);this._bInitialLoad=true;this._bListenerAttached=false;this._bListeningPopOver=false;var t=this;this.eventhandler=function(i,j,k){if(t.getView().getModel().getMetaModel().getData){var s=t.getView().getModel().getMetaModel().getData();var u=t.getView().getModel('ovpCardProperties').getData().entityType.$Type;var v=F._getEntityRelevantFilters(s[u],k);v=F.mergeFilters(v,t.selectionVaraintFilter);try{t.getCardItemsBinding().filter(v);if(t.getKPIBinding()){t.getKPIBinding().filter(v);}}catch(e){}}};this.GloabalEventBus=sap.ui.getCore().getEventBus();if(this.oCardComponentData&&this.oCardComponentData.mainComponent){this.GloabalEventBus.subscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",t.eventhandler);}},onBeforeRendering:function(e){var i=this.getCardPropertiesModel();if(i.getProperty("/listFlavor")==="standard"&&!i.getProperty("/staticContent")){var j=this.byId("ovpCLI");if(j){j.addEventDelegate(D,this);}}},onAfterRendering:function(e){C.prototype.onAfterRendering.apply(this,arguments);this.attachingListenerToTheEventRefresh();var i=this.getCardPropertiesModel();var j=i.getProperty("/cardLayout/rowSpan");var k=i.getProperty("/cardLayout/colSpan");switch(i.getProperty("/listFlavor")){case"standard":if(i.getProperty("/staticContent")){if(k&&j){if(!this._bInitialLoad&&this._aLinkListIds){this._mergeAllTheDataInOneList();}if(j===1){this._aLinkListIds=[m];this._setListColumnWidthInStandardCard(1);}else{this._itemOnEventBuildStandard(i,k,j,true);}}else{this._aLinkListIds=[m];this._setListColumnWidthInStandardCard(1);}}break;case"carousel":var s=this.byId(P);if(s.getId().indexOf('.')!==-1){var $=s.$();$.off('beforeSlide');$.on('beforeSlide',this.onBeforeSlide);$.trigger('beforeSlide',[1,1]);}if(i.getProperty("/staticContent")){if(j&&!(!i.getProperty("/defaultSpan")&&i.getProperty("/cardLayout/autoSpan"))){this._setListHeightInCarouselCard(j);}else{this._setListHeightInCarouselCard(-1);}this._setCarouselImageProperties();}else{s.addEventDelegate(p,this);}break;default:break;}if(!O.checkIfAPIIsUsed(this)&&i.getProperty('/layoutDetail')==='resizable'){var t=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var u=this.oDashboardLayoutUtil.getCardDomId(this.cardId);var v=document.getElementById(u);t.dashboardLayout.showOnlyHeader?v.classList.add("sapOvpMinHeightContainer"):v.classList.remove("sapOvpMinHeightContainer");}if(!O.checkIfAPIIsUsed(this)){var i=this.getCardPropertiesModel();var w=this.getOwnerComponent().getModel("ui").getData().cards;var x=[];if(this.getMetaModel().getData){var y=this.getMetaModel().getData()[this.getEntitySet().$Type];this.selectionVaraintFilter=F.getSelectionVariantFilters(w,i,this.getEntityType());}if(this.oCardComponentData.mainComponent.getGlobalFilter()){x=F._getEntityRelevantFilters(y,this.oCardComponentData.mainComponent.oGlobalFilter.getFilters());}x=F.mergeFilters(x,this.selectionVaraintFilter);if(this.getCardItemsBinding()){this.getCardItemsBinding().filter(x);}if(this.getKPIBinding()){this.getKPIBinding().filter(x);}}},onBeforeSlide:function(e,i,j){if(e.target!=this){return;}var s=this.id+'-pageIndicator',k=document.getElementById(s);var E=k.querySelector('[data-slide=\''+i+'\']');E.classList.remove(A);E=k.querySelector('[data-slide=\''+j+'\']');E.classList.add(A);},getCardItemsBinding:function(){var e=this.getView().byId("ovpLinkList");var i=this.getView().byId("pictureCarousel");if(e){return e.getBinding("items");}else if(i){return i.getBinding("pages");}else{return null;}},attachingListenerToTheEventRefresh:function(){var e=this.getCardItemsBinding();var j=this.getCardPropertiesModel();if(e){if(!this._bListenerAttached){e.attachRefresh(function(){if(this._aLinkListIds){for(var i=1;i<this._aLinkListIds.length;i++){var k=this.byId(this._aLinkListIds[i]);var s=k.getItems().length;k.getItems().splice(0,s);k.destroy();}this._aLinkListIds.splice(0,this._aLinkListIds.length);}if(this._oListRest){this._oListRest.destroy();}}.bind(this));e.attachChange(function(){this.settingHeightAndWidthOfLinkListCardsOnManageCardAndFilter();if(j.getProperty("/listFlavor")==="carousel"){var i=this.byId(P);i.addEventDelegate(p,this);}if(j.getProperty("/listFlavor")==="standard"){var t=e.getLength();if(t===0){var k=this.byId(m).$().parent();k.width("100%");}}}.bind(this));}else if(this._aLinkListIds){this.settingHeightAndWidthOfLinkListCardsOnManageCardAndFilter();}this._bListenerAttached=true;}},settingHeightAndWidthOfLinkListCardsOnManageCardAndFilter:function(){if(this._aLinkListIds){var e=this.getCardPropertiesModel();var i=e.getProperty("/cardLayout/rowSpan");var j=e.getProperty("/cardLayout/colSpan");if(i){this._setListHeightInStandardCard(i);}if(j){this._setListColumnWidthInStandardCard(this._iVisibleColums);}else{this._setListColumnWidthInStandardCard(1);}}},itemOnBeforeRendering:function(e){var i,k=this.getCardPropertiesModel();switch(k.getProperty("/listFlavor")){case"standard":if(!k.getProperty("/defaultSpan")&&!k.getProperty("/staticContent")&&k.getProperty("/cardLayout/autoSpan")){i=k.getProperty("/cardLayout/noOfItems");}else{i=k.getProperty("/cardLayout/rowSpan");}var s=k.getProperty("/cardLayout/colSpan");var t=this.byId(m);var u=t.getItems();for(var j=0;j<u.length;j++){u[j].removeEventDelegate(D);}if(this._bInitialLoad){this._itemOnEventBuildStandard(k,s,i,true);}else{this._itemOnEventBuildStandard(k,s,i,false);}break;case"carousel":r.info("FYI: currently nothing special to handle here");break;default:break;}},getSpansWhenNoDefaultSpanMentioned:function(){var e=this.getCardPropertiesModel();var s=e.getProperty('/staticContent');var N=((s&&s.length)||(this.getCardItemsBinding()&&this.getCardItemsBinding().getLength()))||0;var i=s?this.getItemHeight(this,m,true):e.getProperty('/cardLayout/itemHeight');var H=0;var j=this.byId(n);if(j){H=j.$().outerHeight();}var k=e.getProperty("/cardLayout/iRowHeightPx");return Math.ceil((i*Math.min(N,6)+(H+h+l))/k);},itemOnAfterRendering:function(E){var i=this.getCardPropertiesModel();var j=i.getProperty("/cardLayout/rowSpan");var k=i.getProperty("/cardLayout/colSpan");switch(i.getProperty("/listFlavor")){case"standard":try{var s=this.byId(m);var t=s.getItems(this._aLinkListIds[this._aLinkListIds.length-1]);t[t.length-1].removeEventDelegate(p);}catch(e){r.info("FYI: Unable to remove the delagted event at the last item of the last list");}if(!i.getProperty("/defaultSpan")&&i.getProperty("/cardLayout/autoSpan")){j=this.getSpansWhenNoDefaultSpanMentioned();}if(j){this._setListHeightInStandardCard(j);}if(k){this._setListColumnWidthInStandardCard(this._iVisibleColums);}else{this._setListColumnWidthInStandardCard(1);}break;case"carousel":try{var u=this.byId(P);u.removeEventDelegate(p);}catch(e){r.info("FYI: Unable to remove the delagted event on the carousel");}if(j&&!(!i.getProperty("/defaultSpan")&&i.getProperty("/cardLayout/autoSpan"))){this._setListHeightInCarouselCard(j);}else{this._setListHeightInCarouselCard(-1);}this._setCarouselImageProperties();break;default:break;}this._bInitialLoad=false;},_itemOnEventBuildStandard:function(e,k,s,t){var u;var v=this.byId(m);var w=this.getView().byId(this.getView().getId()+"--RestOfData");if(w){w.destroy();}if(t&&this._oListRest===undefined){this._oListRest=new L(this.getView().getId()+"--RestOfData",{});}this._aLinkListIds=[m];this._iAvailableItems=v.getItems().length;var x=e.getProperty("/cardLayout/items");if(x!==undefined){this._iNoOfItemsPerColumn=x;u=x;this._iVisibleColums=1;}else{var y=e.getProperty('/staticContent')?this.getItemHeight(this,m,true):e.getProperty('/cardLayout/itemHeight');var z=this._getListHeightInStandardCard(s);this._iNoOfItemsPerColumn=Math.floor(z/y);var N=Math.ceil(this._iAvailableItems/this._iNoOfItemsPerColumn);this._iVisibleColums=Math.min(N,k);u=this._iVisibleColums*this._iNoOfItemsPerColumn;}if(u>this._iAvailableItems){u=this._iAvailableItems;}else{for(var i=u;i<this._iAvailableItems;i++){v.getItems()[i].setVisible(false);}}if(this._iVisibleColums>1){var B=this.byId("ovpListRow");var E=this._iNoOfItemsPerColumn;var G=0;for(var j=this._iNoOfItemsPerColumn;j<u;j++){if(E>=this._iNoOfItemsPerColumn){E=0;G++;var H=m+G;var J=new L(this.getView().getId()+"--"+H,{showSeparators:v.getProperty("showSeparators")});this._aLinkListIds.push(H);if(v.hasStyleClass("_iNoOfItemsPerColumnPaddingCozy")){J.addStyleClass("sapOvpLinkListStandardPaddingCozy");}else{J.addStyleClass("sapOvpLinkListStandardPaddingCompact");}B.addItem(J);}J.addItem(v.getItems()[this._iNoOfItemsPerColumn]);E++;}if(J){var K=J.getItems();K[K.length-1].addEventDelegate(p,this);}}else{if(t){this.itemOnAfterRendering(null);}else{var Q=v.getItems();Q[Q.length-1].addEventDelegate(p,this);}}},resizeCard:function(e){var i=this.getCardPropertiesModel();i.setProperty("/cardLayout/rowSpan",e.rowSpan);i.setProperty("/cardLayout/colSpan",e.colSpan);switch(i.getProperty("/listFlavor")){case"standard":this._resizeStandard(e,i);break;case"carousel":this._resizeCarousel(e);break;default:break;}if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);this.resizeHandlerId=null;}var j=this.getView().byId('ovpCardContentContainer').getDomRef();if(j){if(e.showOnlyHeader){j.classList.add('sapOvpContentHidden');}else{j.classList.remove('sapOvpContentHidden');}}},_mergeAllTheDataInOneList:function(){var e=this._aLinkListIds.length;var k=this.getView().byId("ovpLinkList");var s=-1;for(var t=0;t<k.getItems().length;t++){if(!k.getItems()[t].getVisible()){s=t;break;}}for(var i=1;i<e;i++){var u=this.getView().byId(this._aLinkListIds[i]);var v=u.getItems().length;for(var j=0;j<v;j++){if(s===-1){k.addItem(u.getItems()[0]);}else{k.insertItem(u.getItems()[0],s);s++;}}u.destroy();}},_resizeStandard:function(i,j){if(this._aLinkListIds){this._mergeAllTheDataInOneList();var t=this.getView().byId("ovpLinkList");this._aLinkListIds.splice(0,this._aLinkListIds.length);var u=this._oListRest.getItems().length;try{for(var k=0;k<u;k++){t.addItem(this._oListRest.getItems()[0]);}}catch(e){r.info("Error: "+e);}for(var s=0;s<t.getItems().length;s++){t.getItems()[s].setVisible(true);}if(!t){var v=this.byId(m).$().parent();v.width("100%");var w=j.getProperty("/cardLayout/rowSpan");if(w){this._setListHeightInStandardCard(w);}}var B=t.getBindingInfo("items");var x=j.getProperty('/staticContent')?this.getItemHeight(this,m,true):j.getProperty('/cardLayout/itemHeight');var N=this._getListHeightInStandardCard(i.rowSpan);var y=Math.floor(N/x)*i.colSpan;this._bInitialLoad=false;q(this.getView().$()).find(".sapOvpWrapper").css({height:N+"px"});if(B){if(y>this._iAvailableItems&&B.length<=this._iAvailableItems){B.length=y;t.bindItems(B);this._bListenerAttached=false;this.attachingListenerToTheEventRefresh();}else{this._itemOnEventBuildStandard(j,i.colSpan,i.rowSpan,false);}}else{this._itemOnEventBuildStandard(j,i.colSpan,i.rowSpan,false);}}},_resizeCarousel:function(e){this._setListHeightInCarouselCard(e.rowSpan);this._setCarouselImageProperties();},_setListHeightInCarouselCard:function(i){var e=0,j=this.byId(P);if(i!==-1){var H=0;var k=this.byId(n);if(k){H=k.$().outerHeight();}var s=this.getCardPropertiesModel();var t=s.getProperty("/cardLayout/iRowHeightPx");e=(i*t)-(H+f+g);j.$().height(e+16);}else{var u=j.$().width(),v=null,w=j.getPages(),x=0;for(var y=0;y<w.length;y++){v=w[y];if(v&&v.getItems().length>1){x=Math.max(x,v.getItems()[0].$().outerHeight());}}var N=j.$().find(".sapMCrslControlsBottom.sapMCrslControls").outerHeight();e=u+(x+N);j.$().height(e);}},_setCarouselImageProperties:function(){var e=this.byId(P),i=e.getPages(),j=e.$().height(),N=i.length>1?e.$().find(".sapMCrslControlsBottom.sapMCrslControls").outerHeight():0,k=null,s=null,t=0,E,u;for(var v=0;v<i.length;v++){k=i[v];if(k){E=k.getAggregation('items')&&k.getItems()[0];if(E){t=E.hasStyleClass('sapOvpCarouselContentHeader')?E.$().outerHeight():0;u=k.getItems()[k.getItems().length-1];s=u.getAggregation('items')&&u.getItems()[0];if(s instanceof I){this._setCarouselImageHeight(s,j-t-N);}}}}},_setCarouselImageHeight:function(i,e){var j=i.getDomRef().naturalHeight;if(j!==0){j<e?i.setHeight(j+'px'):i.setHeight(e+'px');}},_setListHeightInStandardCard:function(e){var j=0;var k;var s;k=this.byId(m);if(k){j=this._getListHeightInStandardCard(e);s=k.$().parent();s.height(j);}if(this._aLinkListIds){for(var i=1;i<this._aLinkListIds.length;i++){k=this.byId(this._aLinkListIds[i]);j=this._getListHeightInStandardCard(e);s=k.$().parent();s.height(j);}}},_getListHeightInStandardCard:function(i){var e=0;var j=this.getCardPropertiesModel();if(i){var H=0;var k=this.byId(n);if(k){H=k.$().outerHeight();}var s=j.getProperty("/cardLayout/iRowHeightPx");e=(i*s)-(H+h+l);}return e;},_setListColumnWidthInStandardCard:function(i){var e;var k;var s="100%";if(this._aLinkListIds){if(this._aLinkListIds.length>1){for(var j=0;j<this._aLinkListIds.length;j++){e=this.byId(this._aLinkListIds[j]);k=e.$().parent();s=(100/i)+"%";k.width(s);}}else{e=this.byId(this._aLinkListIds[0]);if(e){k=e.$().parent();k.width(s);}}}},onLinkListItemPressLocalData:function(e){if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onContentClicked(e);}}else{var t=e.getSource().data("targetUri");var i=e.getSource().data("openInNewWindow");var B=this.getView().getModel("ovpCardProperties").getProperty("/baseUrl");if(t){t=this.buildUrl(B,t);if(i==="true"){d(t,"newWindow");}else{window.location.href=t;}}}},onLinkListActionPressLocalData:function(e){if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onContentClicked(e);}}else{var s=e.getSource().data("dataAction");this.getView().getModel().callFunction(s,{method:"POST",urlParameters:{FunctionImport:s},success:(this.onFuImpSuccess.bind(this)),error:(this.onFuImpFailed.bind(this))});}},onFuImpSuccess:function(e){M.show(b.getText("Toast_Action_Success"),{duration:3000});},onFuImpFailed:function(e){M.show(b.getText("Toast_Action_Error"),{duration:3000});},onLinkListItemPress:function(e){var N=c.bCRTLPressed?c.constants.explace:c.constants.inplace;c.bCRTLPressed=false;if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onContentClicked(e);}}else{var i=this.getEntityNavigationEntries(e.getSource().getBindingContext(),this.getCardPropertiesModel().getProperty("/annotationPath"));this.doNavigation(e.getSource().getBindingContext(),i[0],N);}},onLinkPopover:function(e){if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onContentClicked(e);}}else{var i;switch(this.getCardPropertiesModel().getProperty("/listFlavor")){case"standard":i=e.getSource().getParent().getAggregation("items")[0];break;case"carousel":i=e.getSource().getParent().getAggregation("items")[0];break;default:break;}var j=this.getCardPropertiesModel();if(j.getProperty("/listFlavor")==="carousel"){var k=this.byId(P);k.addEventDelegate(p,this);}i.bindElement(e.getSource().getBindingContext().getPath());i.openBy(e.getSource());if(!this._bListeningPopOver){i.attachAfterOpen(function(){this.settingHeightAndWidthOfLinkListCardsOnManageCardAndFilter();}.bind(this));}this._bListeningPopOver=true;}},onLinkListLineItemUrl:function(e){if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onContentClicked(e);}}else{var t,s="com.sap.vocabularies.UI.v1.LineItem",N=this.entityType[s][0].Url;if(N.hasOwnProperty("String")){t=N.String;}else{var i=this.getEntityNavigationEntries(e.getSource().getBindingContext(),s)[0];t=i.url;}if(t){window.location.href=t;}else{r.info("LinkList Standard Card: No Navigation on line item");}}},onLinkNavigationSingleTarget:function(e){var N=c.bCRTLPressed?c.constants.explace:c.constants.inplace;c.bCRTLPressed=false;if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onContentClicked(e);}}else{var i=this.getEntityNavigationEntries(e.getSource().getBindingContext(),undefined);this.doNavigation(e.getSource().getBindingContext(),i[0],N);}},onLinkNavigation:function(e){if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onContentClicked(e);}}else{if(sap.ushell.Container.getService("CrossApplicationNavigation")){var B=e.getSource().getBindingContext();if(B.getProperty("SemanticObject")){var N={target:{semanticObject:B.getProperty("SemanticObject"),action:B.getProperty("SemanticAction")}};sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(N);}}}},buildUrl:function(B,s){if(s.lastIndexOf(B,0)===0||s.indexOf("://")>0){return s;}else if(s.lastIndexOf("/",0)===0){return B+s;}else{return B+"/"+s;}},onLinkListActionPress:function(e){if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onContentClicked(e);}}else{var s=e.getSource().data("dataAction");this.getView().getModel().callFunction(s,{method:"POST",urlParameters:{FunctionImport:s},success:(this.onFuImpSuccess.bind(this)),error:(this.onFuImpFailed.bind(this))});}},onLinkListSemanticObjectPressLocalData:function(e){var N=c.bCRTLPressed?c.constants.explace:c.constants.inplace;c.bCRTLPressed=false;if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onContentClicked(e);}}else{var i=parseInt(e.getSource().data("contentRowIndex"),10);this._oStaticContent=this.getCardPropertiesModel().getProperty("/staticContent");if(this._oStaticContent[i].semanticObject&&this._oStaticContent[i].action){var j={semanticObject:this._oStaticContent[i].semanticObject,action:this._oStaticContent[i].action,iStaticLinkListIndex:i};this.doIntentBasedNavigation(null,j,false,N);}else{M.show(b.getText("Toast_Action_Error"),{duration:3000});}}},onExit:function(){C.prototype.onExit.apply(this,arguments);}});});
