sap.ui.define(["sap/ovp/cards/v4/generic/Card.controller","sap/ui/thirdparty/jquery","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/cards/CommonUtils","sap/ovp/app/OVPUtils","sap/ovp/cards/ovpLogger","sap/ovp/cards/Filterhelper"],function(C,q,O,a,b,o,F){"use strict";var l=new o("OVP.table.Table");return C.extend("sap.ovp.cards.v4.table.Table",{onInit:function(){C.prototype.onInit.apply(this,arguments);var t=this;this.eventhandler=function(c,d,f){if(t.getView().getModel().getMetaModel().getData){var m=t.getView().getModel().getMetaModel().getData();var g=t.getView().getModel('ovpCardProperties').getData().entityType.$Type;var r=F._getEntityRelevantFilters(m[g],f);r=F.mergeFilters(r,t.selectionVaraintFilter);try{t.getCardItemsBinding().filter(r);if(t.getKPIBinding()){t.getKPIBinding().filter(r);}}catch(e){}}};this.GloabalEventBus=sap.ui.getCore().getEventBus();if(this.oCardComponentData&&this.oCardComponentData.mainComponent){this.GloabalEventBus.subscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",t.eventhandler);}},onColumnListItemPress:function(e){var n=b.bCRTLPressed?b.constants.explace:b.constants.inplace;b.bCRTLPressed=false;if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onContentClicked(e);}}else{var N=this.getEntityNavigationEntries(e.getSource().getBindingContext(),this.getCardPropertiesModel().getProperty("/annotationPath"));this.doNavigation(e.getSource().getBindingContext(),N[0],n);}},onContactDetailsLinkPress:function(e){if(this.oPopover){this.oPopover.setVisible(false);}var s,B;s=e.getSource();this.oPopover=s.getParent().getAggregation("items")[0];B=s.getBindingContext();if(!B){return;}this.oPopover.bindElement(B.getPath());this.oPopover.setVisible(true);this.oPopover.openBy(s);},getCardItemsBinding:function(){var t=this.getView().byId("ovpTable");return t.getBinding("items");},onAfterRendering:function(){C.prototype.onAfterRendering.apply(this,arguments);var c=this.getOwnerComponent().getComponentData();var d=this.getCardPropertiesModel();if(!O.checkIfAPIIsUsed(this)&&d.getProperty("/layoutDetail")==="resizable"){var e=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(c.cardId);var h=this.getHeaderHeight();var s=this.oDashboardLayoutUtil.getCardDomId(c.cardId);var f=document.getElementById(s);if(!e.dashboardLayout.autoSpan){f.getElementsByClassName('sapOvpWrapper')[0].style.height=((e.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX)+1-(h+2*this.oDashboardLayoutUtil.CARD_BORDER_PX))+"px";}if(e.dashboardLayout.showOnlyHeader){f.classList.add("sapOvpMinHeightContainer");}this.addColumnInTable(q(f),{colSpan:e.dashboardLayout.colSpan});}else{var t=this.getView().byId("ovpTable");var A=t.getAggregation("columns");for(var i=0;i<3;i++){if(A[i]){A[i].setStyleClass("sapTableColumnShow").setVisible(true);}}}if(!O.checkIfAPIIsUsed(this)){var d=this.getCardPropertiesModel();var g=this.getOwnerComponent().getModel("ui").getData().cards;var r=[];if(this.getMetaModel().getData){var j=this.getMetaModel().getData()[this.getEntitySet().$Type];this.selectionVaraintFilter=F.getSelectionVariantFilters(g,d,this.getEntityType());}if(this.oCardComponentData.mainComponent.getGlobalFilter()){r=F._getEntityRelevantFilters(j,this.oCardComponentData.mainComponent.oGlobalFilter.getFilters());}r=F.mergeFilters(r,this.selectionVaraintFilter);if(this.getCardItemsBinding()){this.getCardItemsBinding().filter(r);}if(this.getKPIBinding()){this.getKPIBinding().filter(r);}}},getCardItemBindingInfo:function(){var L=this.getView().byId("ovpTable");return L.getBindingInfo("items");},addColumnInTable:function($,c){if(c.colSpan>=1){if(q($).find("tr").length!=0){var t=sap.ui.getCore().byId(q($).find(".sapMList").attr("id"));var d=t.getAggregation("columns");var e=c.colSpan;var I=e+1;for(var i=0;i<6;i++){if(d[i]){if(i<=I){d[i].setStyleClass("sapTableColumnShow").setVisible(true);}else{d[i].setStyleClass("sapTableColumnHide").setVisible(false);}}}}}},resizeCard:function(n,c){var N,A,h,A;try{var $=document.getElementById(this.oDashboardLayoutUtil.getCardDomId(this.cardId)),B=this.getCardItemBindingInfo(),H=this.getHeaderHeight(),d=this.getView().byId('ovpCardContentContainer').getDomRef();if(n.showOnlyHeader){d.classList.add('sapOvpContentHidden');N=0;}else{d.classList.remove('sapOvpContentHidden');h=H+c.dropDownHeight;A=(n.rowSpan*n.iRowHeightPx)-h-c.itemHeight;N=Math.abs(Math.floor(A/c.itemHeight));$.style.height=n.rowSpan*n.iRowHeightPx+'px';}d.style.height=(n.rowSpan*n.iRowHeightPx)-(H+2*n.iCardBorderPx)+"px";this.addColumnInTable(this.getView().getDomRef(),n);if(N!==B.length){B.length=N;n.noOfItems=B.length;this.getCardItemsBinding().refresh();}else{this._handleCountHeader();}}catch(e){l.warning("OVP resize: "+this.cardId+" catch "+e.toString());}},onExit:function(){C.prototype.onExit.apply(this,arguments);}});});
