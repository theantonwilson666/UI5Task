sap.ui.define(["sap/ui/core/mvc/Controller","sap/ovp/cards/ActionUtils","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/generic/app/navigation/service/PresentationVariant","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/ResizeHandler","sap/ui/core/format/NumberFormat","sap/ovp/cards/AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/m/MessageBox","sap/ui/generic/app/navigation/service/NavError","sap/ui/core/CustomData","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/core/TextDirection","sap/ui/generic/app/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/ui/events/KeyCodes","sap/base/util/isPlainObject","sap/base/util/merge","sap/ovp/cards/ovpLogger","sap/ovp/cards/jUtils","sap/base/util/isEmptyObject","sap/ui/util/openWindow"],function(C,A,S,P,a,O,R,N,b,c,M,d,e,F,J,D,B,f,T,G,q,g,h,K,k,m,o,u,l,n){"use strict";var L=new o("OVP.generic.Card");return C.extend("sap.ovp.cards.generic.Card",{initKeyboardNavigation:function(){var j=function(i){this.init(i);};j.prototype.layoutItemFocusHandler=function(){var p=q(document.activeElement);if(p){var r=p.find("[aria-label]");var i,s="";if(p.find('.valueStateText').length==1){var t=p.find('.valueStateText').find('.sapMObjectNumberText').text();var v=p.find('.valueStateText').find('.sapUiInvisibleText').text();p.find('.valueStateText').attr('aria-label',t+" "+v);p.find('.valueStateText').attr('aria-labelledby',"");}p.find("[role='listitem']").attr('aria-label',"");if(p.hasClass('sapOvpCardHeader')&&!p.hasClass('sapOvpStackCardContent')){var w="";var x=p.find('.cardHeaderType');if(x.length===0){var y=g.getText("CardHeaderType");w="cardHeaderType_"+new Date().getTime();var z='<div id="'+w+'" class="cardHeaderType" aria-label="'+y+'" hidden></div>';p.append(z);}else{w=x[0].id;}s+=w+" ";}for(i=0;i<r.length;i++){if(r[i].getAttribute("role")==="heading"){s+=r[i].id+" ";}}if(p.hasClass('sapOvpCardHeader')){var E=p.find('.cardHeaderText');if(E.length!==0){for(var i=0;i<E.length;i++){if(s.indexOf(E[i].id)===-1){s+=E[i].id+" ";}}}}if(s.length){p.attr("aria-labelledby",s);}if(p.prop('nodeName')==="LI"&&p.find('.linkListHasPopover').length!==0){if(p.find('#hasDetails').length===0){p.append("<div id='hasDetails' hidden>"+g.getText("HAS_DETAILS")+"</div>");p.attr('aria-describedby',"hasDetails");}}var H=p.attr("id");if((H&&H.indexOf("ovpTable")!=-1)&&p.find("[role='Link']")&&!p.hasClass('sapUiCompSmartLink')){var I=p.closest("td").attr("data-sap-ui-column"),Q=p.closest("tbody").siblings().children().filter("tr").children();for(var i=0;i<Q.length;i++){if(Q[i].getAttribute("data-sap-ui")==I&&Q[i].hasChildNodes("span")){var U=Q[i].firstElementChild.getAttribute("id");p.attr("aria-labelledby",U);}}}}};j.prototype.init=function(i){this.cardLayout=i;this.keyCodes=K;this.jqElement=q(i.getView().$());this.jqElement=this.jqElement.parent().parent().parent();this.jqElement.on("focus.keyboardNavigation",this.layoutItemFocusHandler.bind(this));};this.keyboardNavigation=new j(this);},onInit:function(){this.oCardComponent=this.getOwnerComponent();this.oCardComponentData=this.oCardComponent&&this.oCardComponent.getComponentData();this.oMainComponent=this.oCardComponentData&&this.oCardComponentData.mainComponent;this.sCardId=this.oCardComponentData.cardId;var s=this.getView().mPreprocessors.xml[0].ovpCardProperties.oData.state;if(s!=="Error"){var H=this.getView().byId("ovpCardHeader");if(!!H){H.attachBrowserEvent("click",this.onHeaderClick.bind(this));H.addEventDelegate({onkeydown:function(E){if(!E.shiftKey&&E.keyCode==13){E.preventDefault();this.onHeaderClick(E);}else if(!E.shiftKey&&E.keyCode==32){E.preventDefault();}}.bind(this)});H.addEventDelegate({onkeyup:function(E){if(!E.shiftKey&&E.keyCode==32){E.preventDefault();this.onHeaderClick(E);}}.bind(this)});}}var i=this.getView().byId("kpiNumberValue");if(i){i.addEventDelegate({onAfterRendering:function(){var $=i.$();var j=$.find(".sapMNCValueScr");var p=$.find(".sapMNCScale");j.attr("aria-label",j.text());p.attr("aria-label",p.text());var r=this.getView().byId("ovpCardHeader").getDomRef();var t=this.getOwnerComponent().getComponentData();if(!!t&&!!t.appComponent){var v=t.appComponent;if(!!v.getModel("ui")){var U=v.getModel("ui");if(!!U.getProperty("/containerLayout")&&U.getProperty("/containerLayout")==="resizable"){var w=t.appComponent.getDashboardLayoutUtil();if(!!w){w.setKpiNumericContentWidth(r);}}}}}.bind(this)});}},exit:function(){if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);}},onAfterRendering:function(){var i=this.getCardPropertiesModel();this.enableClick=true;var s=i.getProperty("/contentFragment");var j=this.getOwnerComponent().getComponentData();this._handleCountHeader();this._handleKPIHeader();var p=i.getProperty("/selectedKey");if(p&&i.getProperty("/state")!=='Loading'){var r=this.getView().byId("ovp_card_dropdown");if(r){r.setSelectedKey(p);}}try{var j=this.getOwnerComponent().getComponentData();if(j&&j.appComponent){var t=j.appComponent;if(t.getModel('ui')){var U=t.getModel('ui');if(U.getProperty('/containerLayout')==='resizable'){var v=t.getDashboardLayoutUtil();if(v){this.oDashboardLayoutUtil=v;this.cardId=j.cardId;if(v.isCardAutoSpan(j.cardId)){this.resizeHandlerId=R.register(this.getView(),function(b1){L.info('DashboardLayout autoSize:'+b1.target.id+' -> '+b1.size.height);v.setAutoCardSpanHeight(b1);});}}}}}}catch(w){L.error("DashboardLayout autoSpan check failed.");}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var $=q("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>$.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height());}}var I=0;if(j&&j.mainComponent){var x=j.mainComponent;if(x.bGlobalFilterLoaded){I=this.checkNavigation();}}else if(O.checkIfAPIIsUsed(this)){I=this.checkAPINavigation();}var y=this.getCardPropertiesModel();var z=y.getProperty("/state");if(z!=="Loading"&&z!=="Error"){var E=y.getProperty("/template");if(E==="sap.ovp.cards.stack"){if(!I){var H=this.getView().byId('ViewAll');if(H){H=H.getDomRef();H.parentNode.removeChild(H);}}}}if(s==="sap.ovp.cards.stack.Stack"){var Q=this.getView().getDomRef();var V=Q&&Q.querySelector('.sapOvpCardContentContainer');if(V){V.style.borderTop="none";}}if(I){if(s?s!=="sap.ovp.cards.quickview.Quickview":true){if(s==="sap.ovp.cards.stack.Stack"){var Q=this.getView().getDomRef();var W=Q.querySelectorAll('.sapOvpCardContentRightHeader');if(W.length!==0){u.addClassToAllElements(W,'sapOvpCardNavigable');}}else{this.getView().addStyleClass("sapOvpCardNavigable");}}if(s&&s==="sap.ovp.cards.quickview.Quickview"){var X=this.byId("ovpCardHeader");if(X){X.addStyleClass("sapOvpCardNavigable");}}}else{if(s){this.getView().addStyleClass("ovpNonNavigableItem");var X=this.byId("ovpCardHeader");if(X){X.$().removeAttr('role');X.addStyleClass('ovpNonNavigableItem');}var Y=this.checkLineItemNavigation();if(!Y){switch(s){case"sap.ovp.cards.list.List":var Z=this.getView().byId("listItem");if(Z){Z.setType("Inactive");}break;case"sap.ovp.cards.table.Table":var Z=this.getView().byId("tableItem");if(Z){Z.setType("Inactive");}break;case"sap.ovp.cards.linklist.LinkList":if(!this.checkNavigationForLinkedList()){var Z=this.getView().byId("ovpCLI");if(Z){Z.setType("Inactive");}}break;}}}}var _=this.getView().byId("ovp_card_dropdown");var a1=this.getView().byId("ovp_card_dropdown_label");if(_){_.addAriaLabelledBy(a1.getId());}if(O.checkIfAPIIsUsed(this)){this.initKeyboardNavigation();}},checkNavigation:function(){var i=this.getCardPropertiesModel();if(this.checkHeaderNavForChart()){return 0;}var E=this.getEntityType();if(E){if(i){var I=i.getProperty("/identificationAnnotationPath");var s=I;var j=i.getProperty("/contentFragment");if(j&&(j==="sap.ovp.cards.stack.Stack"||j==="sap.ovp.cards.quickview.Quickview")){var p=(I)?I.split(","):[];if(p&&p.length>1){if(j==="sap.ovp.cards.stack.Stack"){s=p[0];}else{s=p[1];}}}var r=E[s];if(this.isNavigationInAnnotation(r)){return 1;}if(i&&i.getProperty("/template")==="sap.ovp.cards.charts.analytical"){var t=i.getProperty("/kpiAnnotationPath");if(E&&t){var v=E[t];if(v&&v.Detail){var w=v.Detail.SemanticObject&&v.Detail.SemanticObject.String;var x=v.Detail.Action&&v.Detail.Action.String;if(w&&x){return 1;}}}}}}else if(i&&i.getProperty("/template")==="sap.ovp.cards.linklist"&&i.getProperty("/staticContent")&&i.getProperty("/targetUri")){return 1;}return 0;},checkNavigationForLinkedList:function(){if(this.getEntityType()){var E=this.getEntityType();var i=E['com.sap.vocabularies.UI.v1.LineItem'];if(i&&(i[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||i[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl")){return true;}}return false;},checkLineItemNavigation:function(){if(this.getEntityType()){var E=this.getEntityType();var i=this.getCardPropertiesModel();if(i){var s=i.getProperty("/annotationPath");var r=E[s];return this.isNavigationInAnnotation(r);}}},isNavigationInAnnotation:function(r){if(r&&r.length){for(var i=0;i<r.length;i++){var I=r[i];if(I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return 1;}}}return 0;},checkAPINavigation:function(){var i=this.getOwnerComponent().getComponentData(),j=i.fnCheckNavigation&&typeof i.fnCheckNavigation==="function",p=j?i.fnCheckNavigation:null;if(p){if(p()){return true;}}else{if(this.checkNavigation()){return true;}}return false;},onHeaderClick:function(E){var s=E.ctrlKey||E.metaKey?h.constants.explace:h.constants.inplace;if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onHeaderClicked();}}else{var i=this.getCardPropertiesModel();var t=i.getProperty("/template");var j=i.getProperty("/targetUri");if(t=="sap.ovp.cards.linklist"&&i.getProperty("/staticContent")!==undefined&&j){window.location.href=j;}else if(i.getProperty("/staticContent")!==undefined&&j===""){return;}else if(this.checkHeaderNavForChart()){return;}else{this.doNavigation(this.getView().getBindingContext(),null,s);}}},checkHeaderNavForChart:function(){var i=this.getCardPropertiesModel();var t=i.getProperty("/template");var j=i.getProperty("/navigation");if(j=="noHeaderNav"&&(t=="sap.ovp.cards.charts.analytical"||"sap.ovp.cards.charts.smart.chart")){return true;}else{return false;}},resizeCard:function(i){L.info(i);if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);this.resizeHandlerId=null;}},_handleCountHeader:function(){var i=this.getView().byId("ovpCountHeader");if(i){var I=this.getCardItemsBinding();if(I){if(I.getLength()>0){this.setHeaderCounter(I,i);}I.attachDataReceived(function(){this.setHeaderCounter(I,i);}.bind(this));I.attachChange(function(){this.setHeaderCounter(I,i);}.bind(this));}}},setHeaderCounter:function(i,j){var t=i.getLength();var p=i.getCurrentContexts().length;var r,s="";var v=N.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});p=parseFloat(p,10);var w=this.getOwnerComponent().getComponentData();if(w&&w.appComponent){var x=w.appComponent;if(x.getModel('ui')){var U=x.getModel('ui');if(U.getProperty('/containerLayout')!=='resizable'){if(t!==0){t=v.format(Number(t));}if(p!==0){p=v.format(Number(p));}}else{r=x.getDashboardLayoutUtil().dashboardLayoutModel.getCardById(w.cardId);}}}if(p===0){s="";}else if(r&&r.dashboardLayout.showOnlyHeader){s=g.getText("Count_Header_Total",[t]);}else if(t!=p){s=g.getText("Count_Header",[p,t]);}j.setText(s);j.addCustomData(new e({key:"aria-label",value:s,writeToDom:true}));},_handleKPIHeader:function(){var i,s;if(this.getView()&&this.getView().getDomRef()){i=this.getView().getDomRef().getElementsByClassName("numericContentHbox");s=this.getView().getDomRef().getElementsByClassName("noDataSubtitle");}else{return;}if(i||s){var j=this.getKPIBinding();if(j){j.attachDataReceived(function(E){var U=E.getParameter("data")&&E.getParameter("data").results&&E.getParameter("data").results[0];var t=j.getLength();if(i[0]){i[0].style.visibility=null;if(t===0){i[0].style.visibility='hidden';}else{this._setSubTitleWithUnitOfMeasure(U);i[0].style.visibility='visible';}}if(s.length!==0){s[0].style.display="none";if(t===0){s[0].style.display="flex";}}}.bind(this));}}},getKPIBinding:function(){var i=this.byId("kpiHBoxNumeric"),j=i&&i.getBindingInfo("items")&&i.getBindingInfo("items").binding;return j;},_setSubTitleWithUnitOfMeasure:function(U){var i=this.getCardPropertiesModel();if(!!i){var j=i.getData();var s=this.getView().byId("SubTitle-Text");if(!!s){s.setText(j.subTitle);if(!!j&&!!j.entityType&&!!j.dataPointAnnotationPath){var E=i.getData().entityType;var p=j.dataPointAnnotationPath.split("/");var r=p.length===1?E[j.dataPointAnnotationPath]:E[p[0]][p[1]];var t;if(r&&r.Value&&r.Value.Path){t=r.Value.Path;}else if(r&&r.Description&&r.Description.Value&&r.Description.Value.Path){t=r.Description.Value.Path;}if(!!t){var v=a.getUnitColumn(t,E);var w;if(!!v&&!!U){w=U[v];}else{w=a.getUnitColumn(t,E,true);}var x=g.getText("SubTitle_IN");if(!!j.subTitle&&!!x&&!!w){s.setText(j.subTitle+" "+x+" "+w);var y=s.getAggregation("customData");if(y){var z;for(z in y){var H=y[z];if(H.getKey()==="aria-label"){H.setValue(j.subTitle+" "+x+" "+w);break;}}}}}}}}},getCardItemsBinding:function(){},onActionPress:function(E){var s=E.getSource(),i=this._getActionObject(s),j=s.getBindingContext();if(i.type.indexOf("DataFieldForAction")!==-1){this.doAction(j,i);}else{this.doNavigation(j,i);}},_getActionObject:function(s){var j=s.getCustomData();var p={};for(var i=0;i<j.length;i++){p[j[i].getKey()]=j[i].getValue();}return p;},doNavigation:function(i,j,s){if(!s){s=h.constants.inplace;}if(!this.enableClick){return;}this.enableClick=false;setTimeout(function(){this.enableClick=true;}.bind(this),1000);if(!this.oMainComponent){return;}if(!j){j=this.getEntityNavigationEntries(i)[0];}var p=m({},i);var r=m({},j);var t=this.oMainComponent.doCustomNavigation&&this.oMainComponent.doCustomNavigation(this.sCardId,p,r);var E=this.oMainComponent.templateBaseExtension&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation(this.sCardId,p,r);var v;if(t){v=t;}if(E){v=E;}if(v){var w=v.type;if(w&&typeof w==="string"&&w.length>0){w=w.split(".").pop().split("/").pop().toLowerCase();switch(w){case"datafieldwithurl":v.type="com.sap.vocabularies.UI.v1.DataFieldWithUrl";break;case"datafieldforintentbasednavigation":v.type="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";break;}j=v;}}function x(s){if(!s){s=h.constants.inplace;}if(j){switch(j.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(i,j,s);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(i,j,false,s);break;case"com.sap.vocabularies.UI.v1.KPIDetailType":this.doIntentBasedNavigation(i,j,false,s);break;}}}if(!this.oMainComponent.oAppStatePromise){x.call(this,s);}else{this.oMainComponent.oAppStatePromise.then(x.bind(this,s));}},doNavigationWithUrl:function(i,j,s){if(!s){s=h.constants.inplace;}if(!sap.ushell.Container){return;}var p=sap.ushell.Container.getService("URLParsing");if(!(p.isIntentUrl(j.url))){n(j.url,"newWindow");}else{var r=p.parseShellHash(j.url);var w=r.appSpecificRoute?true:false;this.doIntentBasedNavigation(i,r,w,s);}},fnHandleError:function(E){if(E instanceof d){if(E.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){M.show(g.getText("OVP_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}else{M.show(E.getErrorCode(),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}}},doCrossApplicationNavigation:function(I,p){var s="#"+I.semanticObject+'-'+I.action;if(I.params){var r=this.oCardComponent&&this.oCardComponent.getComponentData();var t=r&&r.appComponent;if(t){var v=t._formParamString(I.params);s=s+v;}}var w=this;if(!sap.ushell.Container){return;}sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported([s]).done(function(x){if(x[s].supported===true){if(!!p.params){if(typeof p.params=='string'){try{p.params=JSON.parse(p.params);}catch(y){L.error("Could not parse the Navigation parameters");return;}}}var r=w.getOwnerComponent().getComponentData();var z=r?r.globalFilter:undefined;var U=z&&z.getUiState({allFilters:false});var E=U?JSON.stringify(U.getSelectionVariant()):"{}";z=JSON.parse(E);var H=w._getFilterPreference();z=w._removeFilterFromGlobalFilters(H,z);if(!p.params){p.params={};}if(!!z&&!!z.SelectOptions){for(var i=0;i<z.SelectOptions.length;i++){var Q=z.SelectOptions[i].Ranges;if(!!Q){var V=[];for(var j=0;j<Q.length;j++){if(Q[j].Sign==="I"&&Q[j].Option==="EQ"){V.push(Q[j].Low);}}p.params[z.SelectOptions[i].PropertyName]=V;}}}sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(p);}else{var W=new d("NavigationHandler.isIntentSupported.notSupported");w.fnHandleError(W);}}).then(function(){L.error("Could not get authorization from isIntentSupported");});},doIntentBasedNavigation:function(i,I,U,s){if(!s){s=h.constants.inplace;}if(sap.ushell&&!sap.ushell.Container){return;}var p,j,r,E=i?i.getObject():null;var t=this.getCardPropertiesModel(),v=t.getProperty("/customParams");if(i&&typeof i.getAllData==="function"&&v){r=i.getAllData();}else if(t.getProperty("/staticContent")){r={iStaticLinkListIndex:I.iStaticLinkListIndex,bStaticLinkListIndex:true};}if(E&&E.__metadata){delete E.__metadata;}var w=a.getNavigationHandler();if(w){if(I){p=this._getEntityNavigationParameters(E,r,i);j={target:{semanticObject:I.semanticObject,action:I.action},appSpecificRoute:I.appSpecificRoute,params:p.sNavSelectionVariant};var x={};if(p.sNavPresentationVariant){x.presentationVariant=p.sNavPresentationVariant;}if(U){if(I&&I.semanticObject&&I.action){var y=this.getCardPropertiesModel().getProperty("/staticParameters");j.params=(!!y)?y:{};this.doCrossApplicationNavigation(I,j);}}else{w.navigate(j.target.semanticObject,j.target.action,j.params,null,this.fnHandleError,x,s);}}}},doAction:function(i,j){this.actionData=A.getActionInfo(i,j,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm();}else{this._callFunction();}},getEntityNavigationEntries:function(j,s){var p=[];var E=this.getEntityType();var r=this.getCardPropertiesModel();var t=r.getProperty("/template");if(!E){return p;}if(!s&&!j){if(!this.oCardComponentData.settings.identificationAnnotationPath){var v=r.getProperty("/kpiAnnotationPath");if(v&&t==="sap.ovp.cards.charts.analytical"){s=v;var w=E[s];var x=w&&w.Detail;var y=x.SemanticObject&&x.SemanticObject.String;var z=x.Action&&x.Action.String;if(x.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){if(y&&z){p.push({type:x.RecordType,semanticObject:y,action:z,label:""});}else{L.error("Invalid Semantic object and action configured for annotation "+x.RecordType);}}}}}if(!s){var I=r.getProperty("/identificationAnnotationPath");var H=(I)?I.split(","):[];if(H&&H.length>1){s=H[0];}else{s=I;}}var Q=E[s];if(Array.isArray(Q)){Q=b.sortCollectionByImportance(Q);for(var i=0;i<Q.length;i++){if(Q[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){p.push({type:Q[i].RecordType,semanticObject:Q[i].SemanticObject.String,action:Q[i].Action.String,label:Q[i].Label?Q[i].Label.String:null});}if(Q[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!Q[i].Url.UrlRef){var U=this.getView().getModel();var V=U.oMetaModel;var W=V.createBindingContext(E.$path);var X=c.format(W,Q[i].Url);var Y=new e({key:"url",value:X});if(j&&t==="sap.ovp.cards.charts.analytical"){U=j.getModel();}Y.setModel(U);Y.setBindingContext(j);var Z=Y.getValue();p.push({type:Q[i].RecordType,url:Z,value:Q[i].Value.String,label:Q[i].Label?Q[i].Label.String:null});}}}return p;},getModel:function(){return this.getView().getModel();},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel();}},getCardPropertiesModel:function(){if(!this.oCardPropertiesModel||l(this.oCardPropertiesModel)){this.oCardPropertiesModel=this.getView().getModel("ovpCardProperties");}return this.oCardPropertiesModel;},getEntitySet:function(){if(!this.entitySet){var E=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel().getODataEntitySet(E);}return this.entitySet;},getEntityType:function(){if(!this.entityType){if(this.getMetaModel()&&this.getEntitySet()){this.entityType=this.getMetaModel().getODataEntityType(this.getEntitySet().entityType);}}return this.entityType;},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer");}return this.cardContentContainer;},_processCustomParameters:function(j,s,p){var r=this.getCardPropertiesModel();if(!this.oMainComponent||!r){return;}var t;if(j&&j.bStaticLinkListIndex){var v=r.getProperty("/staticContent");t=v[j.iStaticLinkListIndex]["customParams"];j=null;}else{t=r.getProperty("/customParams");}if(!t||!this.oMainComponent.templateBaseExtension.provideCustomParameter||!this.oMainComponent.onCustomParams){return;}var w=this.oMainComponent.templateBaseExtension.provideCustomParameter(t)?this.oMainComponent.templateBaseExtension.provideCustomParameter(t):this.oMainComponent.onCustomParams(t);if(!w||!u.checkIfFunction(w)){return;}var x=m({},j);var y=m({},s);var z=w(x,y);if(!z||(!Array.isArray(z)&&!k(z))){return;}var I=k(z);if(I&&l(z)){return;}var E=I&&(z.bIgnoreEmptyString||z.ignoreEmptyString);var H=I?(z.aSelectionVariant||z.selectionVariant):z;if(!Array.isArray(H)){return;}var i,Q,U,V,W,X;Q=H.length;for(i=0;i<Q;i++){U=H[i];if(!U){continue;}V=U.path;W=U.value1;X=U.value2;if(!V||typeof V!=="string"||V===""){L.error("Custom Variant property path '"+V+"' should be valid string");continue;}if(!(W||W===0||(W===""&&E))){continue;}W=W.toString();X=X&&X.toString();if(W===""&&E){s.removeSelectOption(V);}if(j){delete j[V];}if(p){delete p[V];}s.addSelectOption(V,U.sign,U.operator,W,X);}if(E){this._removeEmptyStringsFromSelectionVariant(s);}return E;},_getEntityNavigationParameters:function(E,j,p){var r={};var s,t,v;var w=this.getOwnerComponent().getComponentData();var x=w?w.globalFilter:undefined;var y=this.getCardPropertiesModel();var z=y&&y.getProperty("/staticContent");if(!z){var H=b.getCardSelections(this.getCardPropertiesModel());var I=H.filters;var Q=H.parameters;var U=this.getEntityType();I&&I.forEach(function(j1){j1.path=j1.path.replace("/",".");switch(j1.operator){case F.NE:j1.operator=F.EQ;j1.sign="E";break;case F.Contains:j1.operator="CP";var k1=j1.value1;j1.value1="*"+k1+"*";break;case F.EndsWith:j1.operator="CP";var k1=j1.value1;j1.value1="*"+k1;break;case F.StartsWith:j1.operator="CP";var k1=j1.value1;j1.value1=k1+"*";}});H.filters=I;if(p&&E&&E.hasOwnProperty("$isOthers")){var V=p.getOtherNavigationDimensions();for(var W in V){var X=V[W];for(var i=0;i<X.length;i++){H.filters.push({path:W,operator:"EQ",value1:X[i],sign:"E"});}}}Q&&Q.forEach(function(j1){j1.path=j1.path.replace("/",".");});H.parameters=Q;var Y=b.getCardSorters(this.getCardPropertiesModel());if(E){var W;for(var i=0;U.property&&i<U.property.length;i++){W=U.property[i].name;var Z=E[W];if(E.hasOwnProperty(W)){if(Array.isArray(E[W])&&E[W].length===1){r[W]=E[W][0];}else if(q.type(Z)!=="object"){r[W]=Z;}}}}var $=y&&y.getProperty("/kpiAnnotationPath");var _=y&&y.getProperty("/template");if($&&_==="sap.ovp.cards.charts.analytical"){var a1=U[$];var b1=a1&&a1.Detail;if(b1&&b1.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){r["kpiID"]=a1.ID.String;}}t=Y&&new P(Y);s=this._buildSelectionVariant(x,H);v=y&&y.getProperty("/staticParameters");}else{var c1=x&&x.getUiState({allFilters:false});var d1=c1?JSON.stringify(c1.getSelectionVariant()):"{}";s=new S(d1);var e1=this._getFilterPreference();s=this._removeFilterFromGlobalFilters(e1,s);if(z[j.iStaticLinkListIndex].params){v=z[j.iStaticLinkListIndex].params;}else if(z[j.iStaticLinkListIndex].staticParameters){v=z[j.iStaticLinkListIndex].staticParameters;}}var f1;if(j&&!j.bStaticLinkListIndex){f1=this._processCustomParameters(j,s,r);}else if(j&&j.bStaticLinkListIndex){f1=this._processCustomParameters(j,s);}else{f1=this._processCustomParameters(r,s);}var g1=f1?G.navigation.service.SuppressionBehavior.ignoreEmptyString:undefined;if(v){for(var W in v){if(!r.hasOwnProperty(W)){r[W]=v[W];}}}var h1=a.getNavigationHandler();var i1=h1&&h1.mixAttributesAndSelectionVariant(r,s.toJSONString(),g1);if(!z){this._removeSensitiveAttributesFromNavSelectionVariant(U,i1);}return{sNavSelectionVariant:i1?i1.toJSONString():null,sNavPresentationVariant:t?t.toJSONString():null};},_removeSensitiveAttributesFromNavSelectionVariant:function(E,j){for(var i=0;i<E.property.length;i++){if(E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]&&E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"].Bool){delete j._mSelectOptions[E.property[i].name];}}},_removeEmptyStringsFromSelectionVariant:function(s){var p=s.getParameterNames();for(var i=0;i<p.length;i++){if(s.getParameter(p[i])===""){s.removeParameter(p[i]);}}var r=s.getSelectOptionsPropertyNames();for(i=0;i<r.length;i++){var t=s.getSelectOption(r[i]);for(var j=0;j<t.length;j++){if(t[j].Low===""&&!t[j].High){t.splice(j,1);j--;}}if(t.length===0){s.removeSelectOption(r[i]);}}return s;},_checkIfCardFiltersAreValid:function(i,p){var j=true;if(i&&i.filterAll==="global"){j=false;}else if(i&&i.globalFilter){if(i.globalFilter.indexOf(p)>=0){j=false;}}return j;},_getFilterPreference:function(){var i=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;var j;if(i&&i.mainComponent){j=i.mainComponent._getFilterPreference(i.cardId);}return j;},_removeFilterFromGlobalFilters:function(i,s){var j=[];if(i&&i.filterAll==="card"){j=s.getSelectOptionsPropertyNames();}else if(i&&i.cardFilter){j=i.cardFilter;}j.forEach(function(p){if(p!=="$.basicSearch"){s.removeSelectOption(p);}});return s;},_buildSelectionVariant:function(p,r){var U=p&&p.getUiState({allFilters:false});var s=U?JSON.stringify(U.getSelectionVariant()):"{}";var t=new S(s);var v,V,w,x;var y=this._getFilterPreference();t=this._removeFilterFromGlobalFilters(y,t);var z=r.filters;var E=r.parameters;for(var i=0;i<z.length;i++){v=z[i];if(v.path&&v.operator&&typeof v.value1!=="undefined"){V=v.value1.toString();w=(typeof v.value2!=="undefined")?v.value2.toString():undefined;if(this._checkIfCardFiltersAreValid(y,v.path)){t.addSelectOption(v.path,v.sign,v.operator,V,w);}}}var H,I,Q;for(var j=0;j<E.length;j++){x=E[j];if(!x.path||!x.value){continue;}H=x.path.split("/").pop();H=H.split(".").pop();if(H.indexOf("P_")===0){I=H;Q=H.substr(2);}else{I="P_"+H;Q=H;}if(t.getParameter(I)){continue;}if(t.getParameter(Q)){continue;}t.addParameter(H,x.value);}return t;},_loadParametersForm:function(){var p=new J();p.setData(this.actionData.parameterData);var t=this;var i=new D('ovpCardActionDialog',{title:this.actionData.sFunctionLabel,afterClose:function(){i.destroy();}}).addStyleClass("sapUiNoContentPadding");var j=new B({text:this.actionData.sFunctionLabel,press:function(E){var w=A.getParameters(E.getSource().getModel(),t.actionData.oFunctionImport);i.close();t._callFunction(w,t.actionData.sFunctionLabel);}});var r=new B({text:"Cancel",press:function(){i.close();}});i.setBeginButton(j);i.setEndButton(r);var s=function(E){var w=A.mandatoryParamsMissing(E.getSource().getModel(),t.actionData.oFunctionImport);j.setEnabled(!w);};var v=A.buildParametersForm(this.actionData,s);i.addContent(v);i.setModel(p);i.open();},_callFunction:function(U,i){var p={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:U,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var t=this;var j=new Promise(function(r,s){var v=t.actionData.oContext.getModel();var w;w="/"+p.functionImport.name;v.callFunction(w,{method:p.functionImport.httpMethod,urlParameters:p.urlParameters,batchGroupId:p.batchGroupId,changeSetId:p.changeSetId,headers:p.headers,success:function(x,y){r(y);},error:function(x){x.actionText=i;s(x);}});});j.then(function(r){return f.show(g.getText("Toast_Action_Success"),{duration:1000});},function(E){var r=a.showODataErrorMessages(E);if(r===""&&E.actionText){r=g.getText("Toast_Action_Error")+' "'+E.actionText+'"'+".";}return M.error(r,{title:g.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:T.Inherit});});},setErrorState:function(){var i=this.getOwnerComponent();if(!i||!i.oContainer){return;}var j=i.oContainer;var p=this.getCardPropertiesModel();var r={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:p.getProperty("/category"),title:p.getProperty("/title"),description:p.getProperty("/description"),entitySet:p.getProperty("/entitySet"),state:h.loadingState.ERROR,template:p.getProperty("/template")}}};var s=sap.ui.component(r);j.setComponent(s);setTimeout(function(){i.destroy();},0);},changeSelection:function(s,i,j){if(!i){var p=this.getView().byId("ovp_card_dropdown");s=parseInt(p.getSelectedKey(),10);}var t={};if(!i){t=this.getCardPropertiesModel().getProperty("/tabs")[s-1];}else{t=j.tabs[s-1];}var U={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:s};for(var r in t){U[r]=t[r];}if(O.checkIfAPIIsUsed(this)){O.recreateCard(U,this.getOwnerComponent().getComponentData());}else{this.getOwnerComponent().getComponentData().mainComponent.recreateCard(U);this.getOwnerComponent().getComponentData().mainComponent.setOrderedCardsSelectedKey(this.getOwnerComponent().getComponentData().cardId,s);}},getItemHeight:function(i,s,j){if(!!i){var p=i.getView().byId(s);var H=0;if(!!p){if(j){if(p.getItems()[0]&&p.getItems()[0].getDomRef()){H=u.getOuterHeight(p.getItems()[0].getDomRef());}}else{if(p.getDomRef()){H=u.getOuterHeight(p.getDomRef());}}}return H;}},getHeaderHeight:function(){var H=this.getItemHeight(this,'ovpCardHeader'),i=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;if(i&&i.appComponent){var j=i.appComponent.getDashboardLayoutUtil(),p=j.getDashboardLayoutModel().getCardById(i.cardId);if(H!==0){p.dashboardLayout.headerHeight=H;}}return H;}});});
