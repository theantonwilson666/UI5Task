sap.ui.define(["sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/ovp/cards/CommonUtils","sap/ui/Device","sap/ui/model/resource/ResourceModel","sap/ui/core/mvc/ViewType","sap/base/util/merge","sap/ovp/app/OVPUtils","sap/ovp/cards/ovpLogger"],function(U,J,C,D,R,V,m,O,o){"use strict";var l=new o("OVP.generic.Component");return U.extend("sap.ovp.cards.generic.Component",{metadata:{properties:{"contentFragment":{"type":"string"},"controllerName":{"type":"string","defaultValue":"sap.ovp.cards.generic.Card"},"headerExtensionFragment":{"type":"string"},"contentPosition":{"type":"string","defaultValue":"Middle"},"headerFragment":{"type":"string","defaultValue":"sap.ovp.cards.generic.Header"},"footerFragment":{"type":"string"},"identificationAnnotationPath":{"type":"string","defaultValue":"com.sap.vocabularies.UI.v1.Identification"},"selectionAnnotationPath":{"type":"string"},"filters":{"type":"object"},"parameters":{"type":"object"},"addODataSelect":{"type":"boolean","defaultValue":false}},version:"1.88.0",library:"sap.ovp",includes:[],dependencies:{libs:[],components:[]},config:{}},setSelectionVariant:function(s,S){if(/^@/.test(s)){s=s.slice(1);}S.selectionAnnotationPath=s;},setPresentationVariant:function(p,s,e){if(/^@/.test(p)){p=p.slice(1);}s.presentationAnnotationPath=p;var a=p.split("/");var v=a.length===1?e[p].Visualizations:e[a[0]][a[1]][a[2]].Visualizations;var i;for(i=0;i<v.length;i++){var b=v[i].AnnotationPath;if(b){if(/^@/.test(b)){b=b.slice(1);}if(/.LineItem/.test(b)){s.annotationPath=b;break;}}}for(i=0;i<v.length;i++){var b=v[i].AnnotationPath;if(b){if(/^@/.test(b)){b=b.slice(1);}if(/.Chart/.test(b)){s.chartAnnotationPath=b;break;}}}},setDataPointAnnotationPath:function(d,s){if(/^@/.test(d)){d=d.slice(1);}s.dataPointAnnotationPath=d;},getCustomPreprocessor:function(){},getPreprocessors:function(p){var c=this.getComponentData(),s=c.settings,M=c.model,a,e,E,b;if(s.description&&!s.subTitle){s.subTitle=s.description;}a=M&&M.getMetaModel();if(M&&C.isODataV4(M)){var d="/"+s.entitySet;var e=a.getObject(d);b=a.createBindingContext(d);E=a.createBindingContext("/"+e.$Type);}else{if(s.entitySet){var f=a.getODataEntitySet(s.entitySet);var g=a.getODataEntitySet(s.entitySet,true);e=a.getODataEntityType(f.entityType);b=a.createBindingContext(g);E=a.createBindingContext(e.$path);}}var h=this._getCardPropertyDefaults();var j=this._completeLayoutDefaults(h,s);var k,n;if(c.appComponent&&c.appComponent.getModel("ui")&&c.appComponent.getModel("ui").oData){var q=c.appComponent.getModel("ui").oData;k=q.showDateInRelativeFormat;n=q.disableTableCardFlexibility;}else{if(c.showDateInRelativeFormat){k=c.showDateInRelativeFormat;}if(c.disableTableCardFlexibility){n=c.disableTableCardFlexibility;}}var A={metaModel:a,entityType:e,webkitSupport:D.browser.webkit,layoutDetail:j&&j.cardLayout?j.cardLayout.containerLayout:'fixed',showDateInRelativeFormat:k,disableTableCardFlexibility:n,cardId:c.cardId};if(!!c&&!!c.cardId){var r=c.mainComponent;var t=null;if(!!r){t=r._getCardFromManifest(c.cardId)?r._getCardFromManifest(c.cardId).template:null;}else{t=c.template;}if(!!t){A.template=t;}}h.densityStyle=C._setCardpropertyDensityAttribute();if(c.errorReason){var u=c.errorReason;var P=u.getParameters?u.getParameters():u.mParameters;var v="sap-icon://message-error";if(P&&P.response){h.errorStatusCode=P.response.statusCode;h.errorStatusText=P.response.statusText;h.responseText=P.response.responseText;h.sMessageIcon=P.response.sIcon?P.response.sIcon:v;}}if(j){A.cardLayout=j.cardLayout;}if(h.state!=="Error"){if(s&&s.kpiAnnotationPath){var K=e[s.kpiAnnotationPath];var w=h.contentFragment;if(K&&(w==="sap.ovp.cards.charts.analytical.analyticalChart"||w==="sap.ovp.cards.charts.smart.analyticalChart")){var S=K.SelectionVariant&&K.SelectionVariant.Path?K.SelectionVariant.Path:s.kpiAnnotationPath+"/SelectionVariant";if(S){this.setSelectionVariant(S,s);}var x=K.Detail&&K.Detail.DefaultPresentationVariant&&K.Detail.DefaultPresentationVariant.Path?K.Detail.DefaultPresentationVariant.Path:s.kpiAnnotationPath+"/Detail/DefaultPresentationVariant";if(x){this.setPresentationVariant(x,s,e);}var y=K.DataPoint&&K.DataPoint.Path?K.DataPoint.Path:s.kpiAnnotationPath+"/DataPoint";if(y){this.setDataPointAnnotationPath(y,s);}}}else if(s&&s.selectionPresentationAnnotationPath){var z=e[s.selectionPresentationAnnotationPath];if(z){var S=z.SelectionVariant&&z.SelectionVariant.Path;if(S){this.setSelectionVariant(S,s);}var x=z.PresentationVariant&&z.PresentationVariant.Path;if(x){this.setPresentationVariant(x,s,e);}}}}if(c.ovpCardsAsApi&&s.ignoreSelectionVariant){s.selectionAnnotationPath="";var I=[];for(var B=0;!!s.filters&&B<s.filters.length;B++){I.push({id:"headerFilterText--"+(B+1),index:B});}s.idForExternalFilters=I;}if(!!A.entityType&&!!s.selectionAnnotationPath&&!!A.entityType[s.selectionAnnotationPath]){var F=A.entityType[s.selectionAnnotationPath].SelectOptions;for(var G=0;!!F&&G<F.length;G++){F[G].id="headerFilterText--"+(G+1);}A.entityType[s.selectionAnnotationPath].SelectOptions=F;}if(A.template==="sap.ovp.cards.linklist"&&!!s.staticContent){for(var i=0;i<s.staticContent.length;i++){s.staticContent[i].id="linkListItem--"+(i+1);}}else if(A.template==='sap.ovp.cards.charts.analytical'){s.dataStep=s.dataStep?s.dataStep:10;}h=O.merge(true,{},A,h,s);var H=new J(h);var L={xml:{bindingContexts:{entityType:E,entitySet:b},models:{device:C.deviceModel,entityType:a,entitySet:a,ovpMeta:a,ovpCardProperties:H,ovplibResourceBundle:p,ovpConstants:C.ovpConstantModel},ovpCardProperties:H,dataModel:M,_ovpCache:{}}};return m({},this.getCustomPreprocessor(),L);},_completeLayoutDefaults:function(c,s){var a={},b=this.getComponentData(),d=null,e=null;if(b.appComponent){d=b.appComponent.getOvpConfig();}if(!d){return null;}if(d.containerLayout==="resizable"&&b.cardId&&c.contentFragment!=="sap.ovp.cards.quickview.Quickview"){e=b.appComponent.getDashboardLayoutUtil();var f=b.cardId;var g=e.aCards.filter(function(i){return i.id===f;});a.cardLayout=g[0].dashboardLayout;a.cardLayout.containerLayout=d.containerLayout;a.cardLayout.iRowHeightPx=e.ROW_HEIGHT_PX;a.cardLayout.iCardBorderPx=e.CARD_BORDER_PX;a.cardLayout.headerHeight=g[0].dashboardLayout.headerHeight;}return a;},_getCardPropertyDefaults:function(){var c={};var p=this.getMetadata().getAllProperties();var P;for(var a in p){P=p[a];if(P.defaultValue!==undefined){c[P.name]=P.defaultValue;}}return c;},getOvplibResourceBundle:function(){if(!this.ovplibResourceBundle){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");this.ovplibResourceBundle=r?new R({bundleUrl:r.oUrlInfo.url}):null;}return this.ovplibResourceBundle;},_getCacheKeys:function(){var c=this.getComponentData&&this.getComponentData();if(c.ovpCardsAsApi){return;}if(c.appComponent&&!(c.appComponent instanceof sap.ui.base.ManagedObject)){return;}var I=c&&c.settings&&c.settings.isObjectStream;if(I){return;}var M=c&&c.model;if(M){var a=[];var p=M.metadataLoaded().then(function(P){var s;if(P&&P.lastModified){s=new Date(P.lastModified).getTime()+"";}else{l.error("No valid cache key segment last modification date provided by the OData Model");s=new Date().getTime()+"";}return s;});a.push(p);var b=M.annotationsLoaded().then(function(P){var d=0;if(P){for(var i=0;i<P.length;i++){if(P[i].lastModified){var L=new Date(P[i].lastModified).getTime();if(L>d){d=L;}}}}if(d===0){l.error("No valid cache key segment last modification date provided by OData annotations");d=new Date().getTime();}return d+"";});a.push(b);return a;}},createContent:function(){var c=this.getComponentData&&this.getComponentData();var M=c.model;var p;var P;var a=c&&c.mainComponent;var b=a&&a.oModelViewMap;var s=c&&c.modelName;var f=function(){if(M&&s){M.bIncludeInCurrentBatch=false;if(b&&s&&b[s]&&b[s][c.cardId]){delete b[s][c.cardId];if(Object.keys(b[s]).length>0){M.bIncludeInCurrentBatch=true;}}}};if(c&&c.mainComponent){p=c.mainComponent._getOvplibResourceBundle();}else{p=this.getOvplibResourceBundle();}P=this.getPreprocessors(p);var v={preprocessors:P,type:V.XML,viewName:"sap.ovp.cards.generic.Card"};var d=this._getCacheKeys();if(d&&d.length&&d.length>0){v.async=true;v.cache={keys:d};}var L=this._getCardPropertyDefaults().state;var i=c.cardId+(L?L:"Original");if(!L){i=i+(c.settings.selectedKey?"_Tab"+c.settings.selectedKey:"");}if(M&&M.bUseBatch&&!v.async){f();}var e=new sap.ui.core.mvc.XMLView(c.containerId==="dialogCard"?undefined:i,v);if(v.async){var g=e.onControllerConnected;e.onControllerConnected=function(){if(M&&M.bUseBatch){f();}g.apply(e,arguments);};}e.setModel(M);if(c.i18n){e.setModel(c.i18n,"@i18n");}e.setModel(P.xml.ovpCardProperties,"ovpCardProperties");e.setModel(p,"ovplibResourceBundle");return e;}});});
