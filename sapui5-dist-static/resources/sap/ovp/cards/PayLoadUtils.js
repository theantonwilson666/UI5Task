/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(['sap/ui/thirdparty/jquery',"sap/ovp/cards/CommonUtils",'sap/ovp/cards/rta/SettingsDialogConstants',"sap/ovp/app/OVPUtils","sap/base/util/merge"],function(q,C,S,O,m){"use strict";function g(i,j,k,M){return i+"_sap.ovp.cards."+j+"."+k+"."+M;}function c(V){return{"type":"XTIT","maxLength":40,"value":{"":V}};}function a(){return{"i18n":"../i18n/i18n.properties"};}function b(i,j,k){var M=i+"["+j+"]";if(k){M+="/"+k;}return M;}function s(j,M){var k=M._getCardsModel();for(var i=0;i<k.length;i++){if(k[i].id===j){return true;}}return false;}function d(i,j,k){var M={"propertyPath":i,"operation":j};if(k){M["propertyValue"]=k;}return M;}function f(j){delete j.id;delete j.dashboardLayout;delete j.settings.baseUrl;delete j.settings.cloneCard;delete j.settings.newCard;delete j["customer.settings"];delete j["customer_base.settings"];delete j["vendor.settings"];if(j.settings["staticContent"]){for(var i=0;i<j.settings["staticContent"].length;i++){delete j.settings["staticContent"][i].id;}}}function e(N,i,j,k){if(j){if(N===C._getLayerNamespace()+".settings"){j[k]={operation:"DELETE"};}}else{if(N===C._getLayerNamespace()+".settings"){P.aEntityPropertyChange.push(d(i,"UPSERT",{operation:"DELETE"}));}else{P.aEntityPropertyChange.push(d(i,"DELETE"));}}}function h(i){P.aEntityPropertyChange.push(d(C._getLayerNamespace()+".settings","UPSERT",i[C._getLayerNamespace()+".settings"]));}function l(i,j,k,V,M,N){var Q;var R=C._getLayer();if(!P.oText){P.oText={};}if(!R||R===O.Layers.customer){Q=g(P.sApplicationId,P.sCardId,i,k);P.oText[Q]=c(V);}else{var T=false;for(var U in M.ai18nProperties){if(M.ai18nProperties[U].value===V){Q=M.ai18nProperties[U].key;T=true;break;}}if(!T){Q=g(P.sApplicationId,P.sCardId,i,k);}P.oText[Q]=c(V);}if(N){N[k]="{{"+Q+"}}";}else{var W=j+"/"+k;P.aEntityPropertyChange.push(d(W,"UPSERT","{{"+Q+"}}"));}}function n(N,j,T,k){var M=this._oCardManifestSettings,Q=this._oOriginalCardManifestSettings;for(var i=0;i<T.length;i++){if((!Q[T[i]]&&M[T[i]])||(Q[T[i]]&&M[T[i]]&&(Q[T[i]]!=M[T[i]]))){if(k){l(N,N,T[i],M[T[i]],M,j[N]);}else{l(N,N,T[i],M[T[i]],M);}var R=C._getLayer();if(!R||R===O.Layers.customer){j.settings[T[i]]=M[T[i]];}else{var U=S.oI18nValueProperty;if(U[T[i]]){j.settings[T[i]]=this._oCardManifestSettings[U[T[i]]];}else{j.settings[T[i]]=M[T[i]];}}}else if(!M[T[i]]&&Q[T[i]]){if(k){e(N,N+"/"+T[i],j[N],T[i]);}else{e(N,N+"/"+T[i]);}delete j.settings[T[i]];}}}function o(i,j,V,k){var M=i+"/"+j;if(k){k[j]=V;}else{P.aEntityPropertyChange.push(d(M,"UPSERT",V));}}function p(N,j,k,M){var Q=this._oCardManifestSettings,R=this._oOriginalCardManifestSettings;for(var i=0;i<k.length;i++){if((!R[k[i]]&&Q[k[i]])||(R[k[i]]&&Q[k[i]]&&(R[k[i]]!=Q[k[i]]))){if(M){o(N,k[i],Q[k[i]],j[N]);}else{o(N,k[i],Q[k[i]]);}j.settings[k[i]]=Q[k[i]];}else if(!Q[k[i]]&&R[k[i]]){if(M){e(N,N+"/"+k[i],j[N],k[i]);}else{e(N,N+"/"+k[i]);}delete j.settings[k[i]];}}}function r(N,i){var j=S.cardSettings["settings"],T=S.cardSettings["text"];if(N===C._getLayerNamespace()+".settings"){if(i[C._getLayerNamespace()+".settings"]){n.bind(this)(N,i,T,false);p.bind(this)(N,i,j,false);}else{i[C._getLayerNamespace()+".settings"]={};n.bind(this)(N,i,T,true);p.bind(this)(N,i,j,true);h(i);}}else{n.bind(this)(N,i,T,false);p.bind(this)(N,i,j,false);}}function t(N,k,M,T,Q,R){var U=this._oCardManifestSettings;var V=U[Q];for(var i=0;i<V.length;i++){for(var j=0;j<T.length;j++){if(V[i][T[j]]){var W=b(N+"/"+Q,i),X=N+"."+Q+"."+i;if(R){l(X,W,T[j],V[i][T[j]],U,k[N][Q][i]);}else{l(X,W,T[j],V[i][T[j]],U,M[i]);}}}}if(!R){o(N,Q,M);}}function u(j,T){var k=S.cardSettingsArrayLevel[T]["onlyTabLevelProps"],M=false;for(var i=0;k&&i<k.length;i++){if(k[i]===j){M=true;break;}}return M;}function v(N,j,T,k,M,Q){var R=this._oCardManifestSettings,i;for(i=0;i<T.length;i++){if(R[T[i]]&&!u(T[i],M)){if(Q){l(N,N,T[i],R[T[i]],R,j[N]);}else{l(N,N,T[i],R[T[i]],R);}j.settings[T[i]]=R[T[i]];}}for(i=0;i<k.length;i++){if(R[k[i]]&&!u(k[i],M)){if(Q){o(N,k[i],R[k[i]],j[N]);}else{o(N,k[i],R[k[i]]);}j.settings[k[i]]=R[k[i]];}}if(Q){e(N,N+"/"+M,j[N],M);}else{e(N,N+"/"+M);}delete j.settings[M];}function w(N,j,k,T,M,Q,R){var i;for(i=0;i<T.length;i++){if(j[N][T[i]]){if(R){e(N,N+"/"+T[i],j[N],T[i]);}else{e(N,N+"/"+T[i]);}delete j.settings[T[i]];}}for(i=0;i<M.length;i++){if(j[N][M[i]]){if(R){e(N,N+"/"+M[i],j[N],M[i]);}else{e(N,N+"/"+M[i]);}delete j.settings[M[i]];}}t.bind(this)(N,j,k,T,Q,R);}function x(j,T){return q.map(m({},j),function(k){var M=S.cardSettingsArrayLevel[T]["text"],i,N=S.cardSettingsArrayLevel[T]["settings"],Q={};for(i=0;i<M.length;i++){if(k[M[i]]){Q[M[i]]=k[M[i]];}}for(i=0;i<N.length;i++){if(k[N[i]]||k[N[i]]===""){Q[N[i]]=k[N[i]];}}return Q;});}function y(j,k,T,M){var N=S.cardSettingsArrayLevel[T]["checkForRemoval"],i,Q;for(i=0;i<N.length;i++){if(!k[0][N[i]]){Q=j.indexOf(N[i]);if(M==="remove"){if(Q>-1){j.splice(Q,1);}}else if(M==="add"){if(Q===-1){j.push(N[i]);}}}}return j;}function z(N,i,j,k,T,M){var Q=S.cardSettingsArrayLevel[T]["text"],R=S.cardSettingsArrayLevel[T]["settings"],U=x(j,T);if(j&&k){i.settings[T]=x(j,T);if(N===C._getLayerNamespace()+".settings"){i[N][T]=x(j,T);}t.bind(this)(N,i,U,Q,T,M);}else if(!j&&k){v.bind(this)(N,i,Q,R,T,M);}else if(j&&!k){i.settings[T]=x(j,T);if(N===C._getLayerNamespace()+".settings"){i[N][T]=x(j,T);}R=y(R,U,T,"remove");w.bind(this)(N,i,U,Q,R,T,M);R=y(R,U,T,"add");}}function A(N,i,j){var k=this._oCardManifestSettings["staticContent"],M=this._oOriginalCardManifestSettings["staticContent"],T=this._oCardManifestSettings["tabs"],Q=this._oOriginalCardManifestSettings["tabs"];if(k||M){z.bind(this)(N,i,k,M,"staticContent",j);}else if(T||Q){z.bind(this)(N,i,T,Q,"tabs",j);}}function B(N,i){var j=S.cardSettingsForComplex["settings"],T=S.cardSettingsForComplex["text"];if(N===C._getLayerNamespace()+".settings"){if(i[C._getLayerNamespace()+".settings"]){n.bind(this)(N,i,T,false);p.bind(this)(N,i,j,false);A.bind(this)(N,i,false);}else{i[C._getLayerNamespace()+".settings"]={};n.bind(this)(N,i,T,true);p.bind(this)(N,i,j,true);A.bind(this)(N,i,true);h(i);}}else{n.bind(this)(N,i,T,false);p.bind(this)(N,i,j,false);A.bind(this)(N,i,false);}}function D(N,i){var j=this._oCardManifestSettings["staticContent"],k=this._oOriginalCardManifestSettings["staticContent"],T=this._oCardManifestSettings["tabs"],M=this._oOriginalCardManifestSettings["tabs"];if(j||k||T||M){B.bind(this)(N,i);}else{r.bind(this)(N,i);}}function E(i){var k=S.AllCardSettingsForKPICard,j,M=this._oCardManifestSettings,N={"model":C._getLayerNamespace()+".kpi_card_model_"+i.getTrimmedDataURIName(M.selectedKPI.ODataURI),"template":"sap.ovp.cards.charts.analytical","settings":{}};for(j=0;j<k.length;j++){if(M[k[j]]){N.settings[k[j]]=M[k[j]];}}return N;}function F(){var k=this._oCardManifestSettings["staticContent"],T=S.cardSettingsArrayLevel["staticContent"]["text"],i,j,M=S.cardSettingsArrayLevel["staticContent"]["settings"],N=this._oCardManifestSettings,Q=S.cardSettingsForStaticLinkListCard,R={"template":"sap.ovp.cards.linklist","settings":{"staticContent":[]}};for(j=0;j<Q.length;j++){if(N[Q[j]]){R.settings[Q[j]]=N[Q[j]];}}for(j=0;j<k.length;j++){R.settings["staticContent"].push({});for(i=0;i<T.length;i++){if(k[j][T[i]]){R.settings["staticContent"][j][T[i]]=k[j][T[i]];}}for(i=0;i<M.length;i++){if(k[j][M[i]]){R.settings["staticContent"][j][M[i]]=k[j][M[i]];}}}return R;}function G(i){var k=S.NewCardSettings,M;var N=this._oCardManifestSettings;k.forEach(function(Y){if(Y.template===this._oCardManifestSettings.template){M=Y;}}.bind(this));var Q={"model":this._oCardManifestSettings.model,"template":M.template,"settings":{}};if(!this._oCardManifestSettings["tabs"]){var R=M.cardSettings;var T=S.oI18nValueProperty;for(var j=0;j<R.length;j++){if(!i.bAddNewCardFlag){if(N[R[j]]){Q.settings[R[j]]=N[R[j]];}}else{if(N[R[j]]){if(T[R[j]]){Q.settings[R[j]]=this._oCardManifestSettings[T[R[j]]];}else{Q.settings[R[j]]=N[R[j]];}}}}}else{var U=M.text;for(var j=0;j<U.length;j++){if(N[U[j]]){Q.settings[U[j]]=N[U[j]];}}var V=this._oCardManifestSettings["tabs"],W=x(V,"tabs"),X=this._oCardManifestSettings.defaultViewSelected;Q.settings["tabs"]=W;Q.settings.selectedKey=X;}return Q;}function H(i,T){var j=[];if(T){for(var k in T){var M=T[k];j.push({"key":k,"value":M.value[""],"textType":M.type});}if(j.length){writeToI18n("/"+i+"/webapp/i18n",j);}}}function I(M,N,Q,R){var T,i,j,k,U,V=Q.settings["staticContent"],W=Q.settings["tabs"];var X=S.cardSettingsWithText;var Y=S.oI18nKeyValueProperty;for(i=0;i<X.length;i++){var Z;if(typeof X[i]=="string"){if(Q.settings[X[i]]){if(!T){T={};}if(R){if(!R.bAddNewCardFlag){Z=g(M,N,"settings",X[i]);}else{for(var $ in Y){if(X[i]===$){Z=this._oCardManifestSettings[Y[$]]?this._oCardManifestSettings[Y[$]]:g(M,N,"settings",X[i]);break;}}}}else{Z=g(M,N,"settings",X[i]);}T[Z]=c(Q.settings[X[i]]);Q.settings[X[i]]="{{"+Z+"}}";}}else if(typeof X[i]=="object"){if(X[i].hasOwnProperty("staticContent")){if(V){for(j=0;j<V.length;j++){for(k=0;k<X[i]["staticContent"].length;k++){U=X[i]["staticContent"][k];if(V[j][U]){if(!T){T={};}Z=g(M,N,"settings.staticContent."+j,U);T[Z]=c(V[j][U]);Q.settings["staticContent"][j][U]="{{"+Z+"}}";}}}}}else if(X[i].hasOwnProperty("tabs")){if(W){for(j=0;j<W.length;j++){for(k=0;k<X[i]["tabs"].length;k++){U=X[i]["tabs"][k];if(W[j][U]){if(!T){T={};}Z=g(M,N,"settings.tabs."+j,U);T[Z]=c(W[j][U]);Q.settings["tabs"][j][U]="{{"+Z+"}}";}}}}}}}return T;}function J(M,j,k){var N=false;for(var i=0;i<k.length;i++){if(k[i].id!==j&&k[i].model===M){N=true;break;}}return N;}function K(i,T,j,k,V){var M={};M['appDescriptorChange']={'parameters':i};if(T){M['appDescriptorChange']['texts']=T;}if(k){M['flexibilityChange']={"newAppDescriptor":j,"oldAppDescriptor":k};}else{M['flexibilityChange']=j;}if(V){M['viewSwitchChange']=V;}return M;}function L(j,k){var M={card:{}},N={},Q=j.oMainComponent,R=Q._getApplicationId(),T,U={},V=C._getLayer();if(j.bAddNewCardFlag){T=G.bind(this)(j);}else if(j.bNewStaticLinkListCardFlag){T=F.bind(this)(j);}else if(j.bNewKPICardFlag){T=E.bind(this)(j);}var W=C._getLayerNamespace()+k,i=1;while(s(W+"_N"+i,Q)){i++;}W=W+"_N"+i;f(T);N=m({},T);N.id=W;if(this._oCardManifestSettings.selectedKPI){N.settings.selectedKPI=m({},this._oCardManifestSettings.selectedKPI);}U.oFlexCardManifest=N;U.oText=I.bind(this)(R,W,T,j);if(V===O.Layers.vendor){H(R,m({},U.oText));U.oText=a();}M.card[W]=T;U.oParameters=M;return U;}var P={sApplicationId:"",sCardId:"",aEntityPropertyChange:[],oText:undefined,getPayLoadForEditCard:function(i){var j=i.oAppDescriptor.id,k={"cardId":j},T,M,N=m({},i.oAppDescriptor),Q=m({},i.oAppDescriptor),R,V,U=C._getLayer();R=(j.lastIndexOf(C._getLayerNamespace()+".",0)===0)?"settings":C._getLayerNamespace()+".settings";P.sApplicationId=i.sApplicationId;P.sCardId=j;P.aEntityPropertyChange=[];P.oText=undefined;D.bind(this)(R,N);T=m({},P.oText);if(U===O.Layers.vendor){H(P.sApplicationId,P.oText);T=a();}M=P.aEntityPropertyChange;if(M.length===1){k["entityPropertyChange"]=M[0];}else{k["entityPropertyChange"]=M;}if(this._oCardManifestSettings["tabs"]){var W=this._oCardManifestSettings.defaultViewSelected,X=this._oOriginalCardManifestSettings.selectedKey;X=(X&&X>0)?X:1;if(W&&W>0&&W!==X){V={cardId:j,selectedKey:W,oldKey:X};}N.settings.selectedKey=W;}return K(k,T,N,Q,V);},getPayLoadForCloneCard:function(j){return new Promise(function(k,M){var N={card:{}},T,Q={},R=j.getComponentInstance().getComponentData(),U=R.mainComponent,V=U._getApplicationId(),W=m({},U._getCardFromManifest(R.cardId)),X=C._getLayer();var Y=C._getLayerNamespace()+"."+W.id,i=1;while(s(Y+"_C"+i,U)){i++;}Y=Y+"_C"+i;f(W);Q=m({},W);Q.id=Y;Q.settings.title=Q.settings.title+" "+i;W.settings.title=W.settings.title+" "+i;if(W.settings.defaultSpan&&W.settings.defaultSpan.showOnlyHeader){W.settings.defaultSpan.rows=12;}T=I(V,Y,W);if(X===O.Layers.vendor){H(V,m({},T));T=a();}N.card[Y]=W;k(K(N,T,Q));});},getPayLoadForNewStaticLinkListCard:function(i){var j=L.bind(this)(i,".newStaticLinkListCard");return K(j.oParameters,j.oText,j.oFlexCardManifest);},getPayLoadForNewKPICard:function(i){var j=L.bind(this)(i,".newKPICard"),k=i.oAppComponent,M=j.oFlexCardManifest,N=j.oParameters,Q=M.model+"_ANNO",R=i.getDataSources(Q),T=true,U=0;if(R[Q]){if(R[Q].uri!==this._oCardManifestSettings.selectedKPI.ModelURI){while(R[Q+"_"+U]){U++;}Q=Q+"_"+U;}else{T=false;}}var V=k.getModel(M.model);if(!V){N["model"]={};N["model"][M.model]={dataSource:M.model,settings:{"defaultCountMode":sap.ui.model.odata.CountMode.None}};N["dataSource"]={};N["dataSource"][M.model]={uri:this._oCardManifestSettings.selectedKPI.ODataURI,type:"OData",settings:{annotations:[Q],localUri:""}};if(T){N["dataSource"][Q]={uri:this._oCardManifestSettings.selectedKPI.ModelURI,type:"ODataAnnotation",settings:{localUri:""}};M.settings["sAnnoKey"]=Q;}}var W=K(N,j.oText,j.oFlexCardManifest);if(T&&V){W["addODataAnnotation"]={'parameters':{"dataSourceId":M.model,"annotations":[Q],"dataSource":{}}};W["addODataAnnotation"].parameters.dataSource[Q]={uri:this._oCardManifestSettings.selectedKPI.ModelURI,type:"ODataAnnotation",settings:{localUri:""}};W['flexibilityChange'].settings["sAnnoKey"]=Q;}return W;},getPayLoadForNewCard:function(i){var j=L.bind(this)(i,".newCard"),k=j.oParameters;if(i.newDataSource){var M=i.oAppComponent,N=j.oFlexCardManifest,Q=i.newDataSourceModel.serviceAnnotation,R=i.getDataSources(Q),T=true,U=0;if(R[Q]){if(R[Q].uri!==i.newDataSourceModel.serviceAnnotationURI){while(R[Q+"_"+U]){U++;}Q=Q+"_"+U;}else{T=false;}}var V=M.getModel(N.model);if(!V){k["model"]={};k["model"][N.model]={dataSource:N.model,settings:{"defaultCountMode":sap.ui.model.odata.CountMode.None}};k["dataSource"]={};k["dataSource"][N.model]={uri:i.newDataSourceModel.serviceURI,type:"OData",settings:{annotations:[Q],localUri:""}};if(T){k["dataSource"][Q]={uri:i.newDataSourceModel.serviceAnnotationURI,type:"ODataAnnotation",settings:{localUri:""}};}}}return K(j.oParameters,j.oText,j.oFlexCardManifest);},getPayLoadForRemoveCard:function(i){var j={},k={},M=i.getComponentInstance().getComponentData(),N=M.cardId;j["cardId"]=N;k.id=i.getId();var Q=K(j,null,k),R=M.mainComponent.getUIModel().getProperty("/cards");if(!J(M.modelName,N,R)&&!!M.modelName){Q["removeDataSourceChange"]=[];var T=M.appComponent.getMetadata(),U=T.getManifestEntry("sap.ui5").models[M.modelName].dataSource,V=T.getManifestEntry("sap.app").dataSources[U].settings.annotations;V.forEach(function(W){Q["removeDataSourceChange"].push({'parameters':{"dataSourceId":W}});});}return Q;}};return P;},true);
