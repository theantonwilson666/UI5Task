sap.ui.define(["sap/ui/core/UIComponent","sap/ovp/cards/rta/SettingsDialogConstants","sap/ui/core/routing/Router","sap/base/util/ObjectPath","sap/ui/model/json/JSONModel","sap/ovp/ui/DashboardLayoutUtil","sap/ui/core/mvc/ViewType","sap/ui/model/resource/ResourceModel","sap/ovp/app/resources","sap/ui/core/CustomData","sap/ushell/Config","sap/base/util/merge","sap/base/util/isEmptyObject","sap/ovp/cards/ovpLogger","sap/ui/rta/RuntimeAuthoring"],function(U,S,R,O,J,D,V,a,b,C,c,m,d,o){"use strict";var l=new o("OVP.app.Component");return U.extend("sap.ovp.app.Component",{metadata:{routing:{config:{routerClass:R},targets:{},routes:[]},properties:{"cardContainerFragment":{"type":"string","defaultValue":"sap.ovp.app.CardContainer"},"dashboardLayoutUtil":{"type":"sap.ovp.ui.DashboardLayoutUtil"},"designtimePath":{"type":"string","defaultValue":"sap/ovp/ui/OVPWrapper.designtime"}},version:"1.88.0",library:"sap.ovp.app",dependencies:{libs:["sap.ovp"],components:[]},config:{fullWidth:true,hideLightBackground:true}},_getOvpCardOriginalConfig:function(s){var e=this.getOvpConfig();return e.cards[s];},restore:function(){sap.ovp.cards.charts.VizAnnotationManager.formatChartAxes();},getOvpConfig:function(){var e;var E=[];var M=this.getMetadata();while(M&&M.getComponentName()!=="sap.ovp.app"){e=M.getManifestEntry("sap.ovp");if(e){E.unshift(e);}M=M.getParent();}E.unshift({});E.unshift(true);e=m.apply(m,E);return e;},_removeExtraArrayElements:function(s,e){var f=s["staticContent"],g=e["staticContent"],h=s["tabs"],i=e["tabs"];if(f&&g){if(f.length>g.length){s["staticContent"].splice(g.length,f.length-g.length);}}if(h&&i){if(h.length>i.length){s["tabs"].splice(i.length,h.length-i.length);}}},_emptyAllArrayElements:function(s,e){var f=s["staticContent"],g=e["staticContent"],h=s["tabs"],j=e["tabs"];if(f&&g){for(var i=0;i<f.length;i++){s["staticContent"][i]={};}}if(h&&j){for(var i=0;i<h.length;i++){s["tabs"][i]={};}}},_mergeObjects:function(e,f){for(var p in f){if(f.hasOwnProperty(p)){var v=f[p];if(typeof v=="object"&&e[p]){if(v.operation==="DELETE"){delete e[p];}else{this._mergeObjects(e[p],v);}}else{if(typeof v=="object"&&!e[p]&&v.operation==="DELETE"){continue;}e[p]=v;}}}return e;},_mergeLayerObject:function(e,L){if(!e[L+".settings"]){return e;}var s=m({},e["settings"]),f=m({},e[L+".settings"]);this._removeExtraArrayElements(s,f);this._emptyAllArrayElements(s,f);e["settings"]=this._mergeObjects(s,f);return e;},_mergeKeyUserChanges:function(e){if(!e.hasOwnProperty("customer.settings")&&!e.hasOwnProperty("customer_base.settings")&&!e.hasOwnProperty("vendor.settings")){return e;}e=this._mergeLayerObject(e,"vendor");e=this._mergeLayerObject(e,"customer_base");e=this._mergeLayerObject(e,"customer");return e;},_getFullyQualifiedNameForEntity:function(e,f){var n,r;if(!e){return"";}if(e.indexOf(".")>-1){return e;}var g=f&&f.getODataEntityContainer();n=g&&g.namespace;if(n&&!(e.indexOf(n)>-1)){r=n+"."+e;}else{r=e;}return r;},isDate:function(p){if(((p["type"]==="Edm.DateTime"&&p["sap:display-format"]==="Date")||(p["type"]==="Edm.String"&&p["com.sap.vocabularies.Common.v1.IsCalendarDate"]&&p["com.sap.vocabularies.Common.v1.IsCalendarDate"].Bool==="true"))&&p["sap:filter-restriction"]==="interval"){return true;}return false;},_getDatePropertiesFromEntitySet:function(f){var p=f.property,e=[];for(var k in p){var g={};if(this.isDate(p[k])){g.PropertyPath=p[k].name;}if(!d(g)){e.push(g);}}return e;},_getAllControlConfiguration:function(e,s,f){for(var i=0;i<e.length;i++){if(f[e[i].PropertyPath]){var I=false;for(var j=0;j<s.length;j++){if(s[j].PropertyPath===e[i].PropertyPath){I=true;}}if(!I){e[i].bNotPartOfSelectionField=true;s.push(e[i]);}}}return s;},_getSettingsForDateProperties:function(e,f){var g={};for(var k in e){if(f.fields&&f.fields[e[k].PropertyPath]){g[e[k].PropertyPath]=this.getConditionTypeForDateSetting(f.fields[e[k].PropertyPath]);}else{if(f.customDateRangeImplementation||f.filter||f.selectedValues){g[e[k].PropertyPath]=this.getConditionTypeForDateSetting(f);}}}return g;},getConditionTypeForDateSetting:function(e){if(e.customDateRangeImplementation){return{customDateRangeImplementation:e.customDateRangeImplementation};}else if(e.filter){return{filter:e.filter};}else if(e.selectedValues){return{selectedValues:e.selectedValues,exclude:(e.exclude!==undefined)?e.exclude:true};}return undefined;},createXMLView:function(e){if(this.getRouter()){this.getRouter().initialize();}var f=this.getMetadata().getManifestEntry("sap.app");var u=this.getMetadata().getManifestEntry("sap.ui");var i=O.get("icons.icon",u);var s=this.getMetadata().getComponentName();var g=s.replace(/\./g,"/");e.baseUrl=sap.ui.require.toUrl(g);if(e.smartVariantRequired===undefined||e.smartVariantRequired===null){e.smartVariantRequired=true;}if(e.enableLiveFilter===undefined||e.enableLiveFilter===null){e.enableLiveFilter=true;}if(e.showDateInRelativeFormat===undefined||e.showDateInRelativeFormat===null){e.showDateInRelativeFormat=true;}if((e.filterSettings&&e.filterSettings.dateSettings&&(e.filterSettings.dateSettings.useDateRange!==undefined))&&e.useDateRangeType!==undefined){throw new Error("Defining both useDateRange and useDateRangeType in the manifest is not allowed");}e.useDateRangeType=(e.filterSettings&&e.filterSettings.dateSettings&&(e.filterSettings.dateSettings.useDateRange!==undefined))?e.filterSettings.dateSettings.useDateRange:e.useDateRangeType;if(e.useDateRangeType===undefined||e.useDateRangeType===null){e.useDateRangeType=false;}if(e.bHeaderExpanded===undefined||e.bHeaderExpanded===null){e.bHeaderExpanded=false;}if(e.chartSettings===undefined||e.chartSettings===null){e.chartSettings={};}if(e.chartSettings.showDataLabel===undefined||e.chartSettings.showDataLabel===null){e.chartSettings.showDataLabel=false;}var F=this.getModel(e.globalFilterModel);var h=F&&F.getMetaModel();this.setModel(F);if(e.globalFilterEntitySet&&e.globalFilterEntitySet!==" "){var E=h&&h.getODataEntitySet(e.globalFilterEntitySet);e.globalFilterEntityType=E&&E.entityType;}if(e.globalFilterEntityType&&e.globalFilterEntityType!==" "&&e.globalFilterEntityType.length>0){e.globalFilterEntityType=this._getFullyQualifiedNameForEntity(e.globalFilterEntityType,h);e.globalFilterEntityTypeNQ=e.globalFilterEntityType.split(".").pop();}var j=new J(e);j.setProperty("/applicationId",O.get("id",f));j.setProperty("/title",O.get("title",f));j.setProperty("/description",O.get("description",f));if(e.globalFilterEntityType){var k=h.getODataEntityType(e.globalFilterEntityType),A=m([],k["com.sap.vocabularies.UI.v1.SelectionFields"]);if(e.filterSettings&&e.filterSettings.dateSettings){var n=this._getDatePropertiesFromEntitySet(k);var p=this._getSettingsForDateProperties(n,e.filterSettings.dateSettings);if(j.getProperty("/useDateRangeType")&&!d(p)){throw new Error("Setting 'useDateRange' property as True and maintaining property level configuration for date ranges in Date Settings are mutually exclusive, resulting in error. Change one of these settings in manifest.json as per your requirement.");}A=this._getAllControlConfiguration(n,A,p);j.setProperty("/datePropertiesSettings",p);}j.setProperty("/allControlConfiguration",A);}if(i){if(i.indexOf("sap-icon")<0&&i.charAt(0)!=='/'){i=e.baseUrl+"/"+i;}j.setProperty("/icon",i);}var q=e.cards;var r=[];var t;for(var v in q){if(q.hasOwnProperty(v)&&q[v]){t=this._mergeKeyUserChanges(q[v]);t.id=v;r.push(t);}}r.sort(function(z,B){if(z.id<B.id){return-1;}else if(z.id>B.id){return 1;}else{return 0;}});j.setProperty("/cards",r);if(this.inResizableTestMode()===true){e.containerLayout="resizable";}if(e.containerLayout&&e.containerLayout==="resizable"){j.setProperty("/cardContainerFragment","sap.ovp.app.DashboardCardContainer");j.setProperty("/dashboardLayout",e.resizableLayout);var w=new D(j);this.setDashboardLayoutUtil(w);}else{j.setProperty("/cardContainerFragment",this.getCardContainerFragment());}this.setModel(j,"ui");var x=this._getOvpLibResourceBundle();this.setModel(x,"ovplibResourceBundle");var k=h&&h.getODataEntityType(e.globalFilterEntityType,true);var y=new sap.ui.core.mvc.XMLView("mainView",{height:"100%",preprocessors:{xml:{bindingContexts:{ui:j.createBindingContext("/"),meta:h.createBindingContext(k)},models:{ui:j,meta:h}}},type:V.XML,viewName:"sap.ovp.app.Main",async:true,customData:[new C({key:"sap-ui-custom-settings",value:{"sap.ui.dt":{"designtime":"sap/ovp/ui/OVPWrapper.designtime"}}})]});return y;},_showErrorPage:function(){var v=new sap.ui.core.mvc.XMLView({height:"100%",type:V.XML,viewName:"sap.ovp.app.Error"});var e=this._getOvpLibResourceBundle();v.setModel(e,"ovplibResourceBundle");this.setAggregation("rootControl",v);this.oContainer.invalidate();},_formParamString:function(p){var k=Object.keys(p);var i;var P="?";for(i=0;i<k.length;i++){P=P+k[i]+"="+p[k[i]]+"&";}return P.slice(0,-1);},_checkForAuthorizationForLineItems:function(){return new Promise(function(r,e){var A=[],f=[];var g=this.getOvpConfig();var h=g["cards"];for(var s in h){if(h.hasOwnProperty(s)&&h[s]){var k=h[s];var n=k.settings;if((k.template==="sap.ovp.cards.linklist"||k.template==="sap.ovp.cards.v4.linklist")&&n.listFlavor==="standard"&&n.staticContent){var p=n.staticContent;for(var i=0;i<p.length;i++){if(p[i].semanticObject||p[i].action){var I="#"+p[i].semanticObject+"-"+p[i].action;if(p[i].params){var P=this._formParamString(p[i].params);I=I+P;}if(f.indexOf(s)===-1){f.push(s);}if(A.indexOf(I)===-1){A.push(I);}}}}}}this._oCardsWithStaticContent=f;if(sap.ushell&&sap.ushell.Container){sap.ushell.Container.getService('CrossApplicationNavigation').isIntentSupported(A).done(function(q){var g=this.getOvpConfig();for(var t in q){if(q.hasOwnProperty(t)&&q[t].supported===false){for(var i=0;i<this._oCardsWithStaticContent.length;i++){var p=g["cards"][this._oCardsWithStaticContent[i]].settings.staticContent;for(var j=p.length-1;j>=0;j--){var I="#"+p[j].semanticObject+"-"+p[j].action;if(p[j].params){var P=this._formParamString(p[j].params);I=I+P;}if(t===I){p.splice(j,1);}}g["cards"][this._oCardsWithStaticContent[i]].settings.staticContent=p;}}}delete this._oCardsWithStaticContent;r(g);}.bind(this)).fail(function(E){l.error(E);e(E);});}else{r(g);}}.bind(this));},setContainer:function(){var e=this.getOvpConfig();var f=this.getModel(e.globalFilterModel);U.prototype.setContainer.apply(this,arguments);if(f&&!this.getAggregation("rootControl")){Promise.all([f.getMetaModel().loaded(),this._checkForAuthorizationForLineItems(e),b.pResourcePromise]).then(function(r){this.oOvpConfig=r[1];this.runAsOwner(function(){var v=this.createXMLView(this.oOvpConfig);v.loaded().then(function(){this.setAggregation("rootControl",v);this.oContainer.invalidate();}.bind(this));}.bind(this));}.bind(this));f.attachMetadataFailed(function(){this._showErrorPage();}.bind(this));}},_getOvpLibResourceBundle:function(){if(!this.ovplibResourceBundle){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");this.ovplibResourceBundle=r?new a({bundleUrl:r.oUrlInfo.url,bundle:r}):null;}return this.ovplibResourceBundle;},createMapForEntityContainer:function(e){var E={};var f=e.entitySet;for(var i=0;i<f.length;i++){E[f[i].name]=f[i].entityType;}return E;},inResizableTestMode:function(){return this._getQueryParamUpToTop('resizableTest')=='true';},_getQueryParamUpToTop:function(n){var w=window;var v=this.getQueryParam(w.location.search,n);if(v!=null){return v;}if(w==w.parent){return null;}w=w.parent;return null;},getQueryParam:function(q,n){var v=null;if(!q){return v;}if(q.indexOf('?')!=-1){q=q.substring(q.indexOf('?'));}if(q.length>1&&q.indexOf(n)!=-1){q=q.substring(1);var p=q.split('&');for(var i=0;i<p.length;i++){var e=p[i].split('=');if(e[0]==n){v=e[1];break;}}}return v;}});});
